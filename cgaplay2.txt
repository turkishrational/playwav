     1                                  ; ****************************************************************************
     2                                  ; cgaplay2.s - TRDOS 386 (TRDOS v2.0.9) WAV PLAYER - Video Mode 13h
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; CGAPLAY2.PRG ! Sound Blaster 16 .WAV PLAYER program by Erdogan TAN
     5                                  ;
     6                                  ; 06/01/2025				- play music from multiple wav files -
     7                                  ;
     8                                  ; [ Last Modification: 08/01/2025 ]
     9                                  ;
    10                                  ; Modified from CGAPLAY.PRG .wav player program by Erdogan Tan, 01/01/2025
    11                                  ;	        SB16PLAY.PRG, 20/12/2024
    12                                  ;
    13                                  ; ****************************************************************************
    14                                  ; nasm cgaplay2.s -l cgaplay2.txt -o CGAPLAY2.PRG -Z error.txt
    15                                  
    16                                  ; 02/01/2025
    17                                  ; cgaplay2.asm - CGAPLAY2.COM - Sound Blaster 16
    18                                  ; 01/01/2025
    19                                  ; cgaplay.s - CGAPLAY.PRG - AC97 - Video Mode 13h (320*200, 256 colors)
    20                                  ; 26/12/2024
    21                                  ; vgaplay.s - VGAPLAY.PRG - AC97 - VESA Mode 101h (640*480, 256 colors)
    22                                  ; 20/12/2024
    23                                  ; sb16play.s : Video Mode 03h (Text Mode)
    24                                  
    25                                  ; 07/12/2024 - playwav9.s - interrupt (srb) + tuneloop version
    26                                  ; ------------------------------------------------------------
    27                                  ; INTERRUPT (SRB) + TUNELOOP version ; 24/11/2024 (PLAYWAV9.ASM)
    28                                  ;	(running in DOSBOX, VIRTUALBOX, QEMU is ok)
    29                                  ; Signal Response Byte = message/signal to user about an event/interrupt
    30                                  ;	    as requested (TuneLoop procedure continuously checks this SRB)
    31                                  ; (TRDOS 386 v2 feature is used here as very simple interrupt handler output)
    32                                  
    33                                  ; ------------------------------------------------------------
    34                                  
    35                                  ; 30/11/2024
    36                                  ; 20/08/2024 ; TRDOS 386 v2.0.9
    37                                  ; 29/04/2016
    38                                  _ver 	equ 0
    39                                  _exit 	equ 1
    40                                  _fork 	equ 2
    41                                  _read 	equ 3
    42                                  _write	equ 4
    43                                  _open	equ 5
    44                                  _close 	equ 6
    45                                  _wait 	equ 7
    46                                  _creat 	equ 8
    47                                  _link 	equ 9
    48                                  _unlink	equ 10
    49                                  _exec	equ 11
    50                                  _chdir	equ 12
    51                                  _time 	equ 13
    52                                  _mkdir 	equ 14
    53                                  _chmod	equ 15
    54                                  _chown	equ 16
    55                                  _break	equ 17
    56                                  _stat	equ 18
    57                                  _seek	equ 19
    58                                  _tell 	equ 20
    59                                  _mount	equ 21
    60                                  _umount	equ 22
    61                                  _setuid	equ 23
    62                                  _getuid	equ 24
    63                                  _stime	equ 25
    64                                  _quit	equ 26
    65                                  _intr	equ 27
    66                                  _fstat	equ 28
    67                                  _emt 	equ 29
    68                                  _mdate 	equ 30
    69                                  _video 	equ 31
    70                                  _audio	equ 32
    71                                  _timer	equ 33
    72                                  _sleep	equ 34
    73                                  _msg    equ 35
    74                                  _geterr	equ 36
    75                                  _fpsave	equ 37
    76                                  _pri	equ 38
    77                                  _rele	equ 39
    78                                  _fff	equ 40
    79                                  _fnf	equ 41
    80                                  _alloc	equ 42
    81                                  _dalloc equ 43
    82                                  _calbac equ 44
    83                                  _dma	equ 45
    84                                  _stdio  equ 46
    85                                  
    86                                  ; ------------------------------------------------------------
    87                                  
    88                                  %macro sys 1-4
    89                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)
    90                                      ; 03/09/2015
    91                                      ; 13/04/2015
    92                                      ; Retro UNIX 386 v1 system call.
    93                                      %if %0 >= 2
    94                                          mov ebx, %2
    95                                          %if %0 >= 3
    96                                              mov ecx, %3
    97                                              %if %0 = 4
    98                                                 mov edx, %4
    99                                              %endif
   100                                          %endif
   101                                      %endif
   102                                      mov eax, %1
   103                                      ;int 30h
   104                                      int 40h ; TRDOS 386 (TRDOS v2.0)
   105                                  %endmacro
   106                                  
   107                                  ; Retro UNIX 386 v1 system call format:
   108                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
   109                                  
   110                                  ; ------------------------------------------------------------
   111                                  
   112                                  ; player internal variables and other equates.
   113                                  BUFFERSIZE equ 32768	; audio (half) buffer size 
   114                                  ENDOFFILE  equ 1	; flag for knowing end of file
   115                                  ; 06/01/2025
   116                                  DMABUFFERSIZE equ BUFFERSIZE*2
   117                                  
   118                                  ; ------------------------------------------------------------
   119                                  
   120                                  [BITS 32] ; 32-bit intructions
   121                                  
   122                                  [ORG 0]
   123                                  
   124                                  START_CODE:
   125                                  	; Prints the Credits Text.
   126                                  	sys	_msg, Credits, 255, 0Bh
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000000 BB[DF0C0000]        <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 00000005 B9FF000000          <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98 0000000A BA0B000000          <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 0000000F B823000000          <1>  mov eax, %1
   103                              <1> 
   104 00000014 CD40                <1>  int 40h
   127                                  
   128                                  	; clear bss
   129 00000016 BF[6C120000]            	mov	edi, bss_start
   130 0000001B B965230000              	mov	ecx, (bss_end - bss_start)/4
   131 00000020 31C0                    	xor	eax, eax
   132 00000022 F3AB                    	rep	stosd
   133                                  
   134                                  ; -------------------------------------------------------------
   135                                  
   136                                  	; 02/01/2025
   137                                  	; 24/11/2024
   138                                  	; Detect (& Reset) Sound Blaster 16 Audio Device
   139 00000024 E8C1040000              	call	DetectSB16
   140                                  	;jnc	short GetFileName
   141                                  	; 06/01/2025
   142 00000029 731B                    	jnc	short get_audio_info
   143                                  
   144                                  	; 30/11/2024
   145                                  	; 30/05/2024
   146                                  _dev_not_ready:
   147                                  	; couldn't find the audio device!
   148                                  	sys	_msg, noDevMsg, 255, 0Fh
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 0000002B BB[7E0D0000]        <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 00000030 B9FF000000          <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98 00000035 BA0F000000          <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 0000003A B823000000          <1>  mov eax, %1
   103                              <1> 
   104 0000003F CD40                <1>  int 40h
   149 00000041 E984020000                      jmp     Exit
   150                                  
   151                                  ; -------------------------------------------------------------
   152                                  
   153                                  	; 06/01/2025 (cgaplay2.s)
   154                                  get_audio_info:
   155                                  	; 20/12/2024 (playwavx.s, sb16play.s)
   156                                  	; 07/12/2024 (playwav9.s)
   157                                  	; 06/06/2017
   158                                  	sys	_audio, 0E00h ; get audio controller info
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000046 BB000E0000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 0000004B B820000000          <1>  mov eax, %1
   103                              <1> 
   104 00000050 CD40                <1>  int 40h
   159 00000052 0F82BA020000            	jc	error_exit ; 25/11/2023
   160                                  	; 20/12/2024
   161 00000058 8915[6C170000]          	mov	[audio_io_base], edx
   162 0000005E A2[70170000]            	mov	[audio_intr], al
   163                                  
   164                                  ; -------------------------------------------------------------
   165                                  
   166                                  	; 06/01/2025
   167                                  	; 30/12/2024
   168                                  	;;;
   169                                  	; DIRECT VGA MEMORY ACCESS
   170                                  	; bl = 0, bh = 5
   171                                  	; Direct access/map to VGA memory (0A0000h)
   172                                  
   173                                  	sys	_video, 0500h
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000063 BB00050000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 00000068 B81F000000          <1>  mov eax, %1
   103                              <1> 
   104 0000006D CD40                <1>  int 40h
   174 0000006F 3D00000A00              	cmp	eax, 0A0000h
   175 00000074 7405                    	je	short set_video_mode_13h
   176                                  
   177                                  	; 30/12/2024
   178 00000076 E99C020000              	jmp	trdos386_error
   179                                  
   180                                  set_video_mode_13h:
   181                                  	;; Set Video Mode to 13h
   182                                  	;sys	_video, 0813h
   183                                  	;cmp	eax, 14h 
   184                                  	;je	short mode_13h_set_ok
   185                                  
   186                                  	; set VGA mode by using int 31h
   187 0000007B 66B81300                	mov	ax, 13h	; mode 13h ; 
   188 0000007F CD31                    	int	31h	; real mode: int 10h
   189                                  
   190                                  ; -------------------------------------------------------------
   191                                  
   192                                  mode_13h_set_ok:
   193                                  	; 30/12/2024
   194                                  	; 24/12/2024 (setting for wave lighting points)
   195                                  	;mov	eax, 0A0000h
   196                                  	;;add	eax, 12*8*320
   197                                  	;add	eax, (13*8*320)+(2*320)
   198                                  			; wave graphics start (top) line/row
   199                                  			; 64 volume levels
   200                                  	;mov	[graphstart], eax
   201                                  	;; 30/12/2024
   202                                  	;;mov	dword [graphstart], 0A0000h+(13*8*320)+(4*320)
   203                                  	; 06/01/2025
   204                                  	; 01/01/2025
   205                                  	;mov	dword [graphstart], 0A0000h+(11*8*320)+(4*320)
   206                                  
   207                                  ; -------------------------------------------------------------
   208                                  
   209                                  	; 25/12/2024
   210                                  	; 28/11/2024
   211                                  Player_InitalizePSP:
   212                                  	; 30/11/2024
   213                                  	; (TRDOS 386 -Retro UNIX 386- argument transfer method)
   214                                  	; (stack: argc,argv0addr,argv1addr,argv2addr ..
   215                                  	;			.. argv0text, argv1text ..) 
   216                                  	; ---- argc, argv[] ----
   217 00000081 89E6                    	mov	esi, esp
   218 00000083 AD                      	lodsd
   219 00000084 83F802                  	cmp	eax, 2 ; two arguments 
   220                                  		; (program file name & mod file name)
   221 00000087 0F824B020000            	jb	pmsg_usage ; nothing to do
   222                                  	;mov	[argc], al
   223 0000008D C1E002                  	shl	eax, 2 ; *4
   224 00000090 01E0                    	add	eax, esp
   225                                  	; eax = last argument's address pointer
   226 00000092 A3[B0170000]            	mov	[argvl], eax ; last wav file (argument)
   227 00000097 8935[A8170000]          	mov	[argv], esi ; current argument (PRG file name)
   228 0000009D AD                      	lodsd	; skip program (PRG) file name
   229 0000009E 8935[AC170000]          	mov	[argvf], esi ; 1st wav file (argument)
   230                                  
   231                                  	; 30/12/2024
   232                                  Player_ParseParameters:
   233 000000A4 EB2A                    	jmp	short Player_ParseNextParameter
   234                                  	; 25/12/2024
   235                                  check_p_command:
   236                                  	; 07/12/2024
   237 000000A6 8B35[A8170000]          	mov	esi, [argv]
   238                                  	;
   239 000000AC 803D[74170000]50          	cmp	byte [command], 'P'
   240 000000B3 7410                    	je	short Player_ParsePreviousParameter
   241                                      
   242                                  	; 07/12/2024
   243                                  	; 30/11/2024
   244                                  	;mov	esi, [argv] ; current argument (wav file) ptr
   245 000000B5 83C604                  	add	esi, 4
   246 000000B8 3B35[B0170000]          	cmp	esi, [argvl] ; last argument (wav file) ptr
   247 000000BE 7610                    	jna	short Player_ParseNextParameter
   248                                  jmp_Player_Quit:
   249 000000C0 E9D6020000              	jmp	Player_Quit
   250                                  
   251                                  Player_ParsePreviousParameter:
   252                                  	; 29/11/2024
   253                                  	;mov	byte [command], 0
   254                                  	; 30/11/2024
   255                                  	;mov	esi, [argv] ; 07/12/2024	
   256 000000C5 3B35[AC170000]          	cmp	esi, [argvf] ; first argument (wav file) ptr
   257 000000CB 7603                    	jna	short Player_ParseNextParameter
   258 000000CD 83EE04                  	sub	esi, 4
   259                                  Player_ParseNextParameter:
   260                                  	; 30/11/2024
   261 000000D0 8935[A8170000]          	mov	[argv], esi  ; set as current argument
   262                                  
   263                                  	; 01/12/2024
   264 000000D6 8B36                    	mov	esi, [esi]
   265                                  
   266                                  	; 30/12/2024
   267                                  	; 29/11/2024
   268 000000D8 E83C000000              	call	GetFileName
   269                                  	;jcxz	jmp_Player_Quit
   270 000000DD E3E1                    	jecxz	jmp_Player_Quit ; 30/11/2024
   271                                  
   272                                  	; 30/12/2024
   273                                          ; open existing file
   274                                  	; 28/11/2024
   275 000000DF BA[B4170000]            	mov	edx, wav_file_name
   276 000000E4 E84A040000                      call	openFile ; no error? ok.
   277 000000E9 7376                            jnc	getwavparms	; 14/11/2024
   278                                  
   279                                  	; 29/11/2024
   280 000000EB 803D[75170000]00        	cmp	byte [filecount], 0
   281 000000F2 77B2                    	ja	short check_p_command
   282                                  
   283                                  	; 25/12/2024
   284                                  	; 21/12/2024
   285 000000F4 E89A020000              	call	set_text_mode
   286                                  	; file not found!
   287                                  	; 30/11/2024
   288                                  	sys	_msg, noFileErrMsg, 255, 0Ch
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 000000F9 BB[B50D0000]        <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 000000FE B9FF000000          <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98 00000103 BA0C000000          <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 00000108 B823000000          <1>  mov eax, %1
   103                              <1> 
   104 0000010D CD40                <1>  int 40h
   289 0000010F E9B6010000              	jmp	Exit
   290                                  
   291                                  _exit_:
   292 00000114 E976010000              	jmp	terminate
   293                                  
   294                                  ; -------------------------------------------------------------
   295                                  
   296                                  	; 26/12/2024
   297                                  	; 25/12/2024
   298                                  	; 30/11/2024 (32bit)
   299                                  	; 29/11/2024
   300                                  	; 30/05/2024
   301                                  GetFileName:
   302 00000119 BF[B4170000]            	mov	edi, wav_file_name 
   303                                  	; 30/11/2024
   304                                  	;mov	esi, [argv]
   305 0000011E 31C9                    	xor	ecx, ecx ; 0
   306                                  ScanName:
   307 00000120 AC                      	lodsb
   308                                  	;test	al, al
   309                                  	;jz	short a_4
   310                                  	; 29/11/2024
   311 00000121 3C0D                    	cmp	al, 0Dh
   312 00000123 7638                    	jna	short a_4
   313 00000125 3C20                    	cmp	al, 20h
   314 00000127 74F7                    	je	short ScanName	; scan start of name.
   315 00000129 AA                      	stosb
   316 0000012A B4FF                    	mov	ah, 0FFh
   317                                  	;;;
   318                                  	; 14/11/2024
   319                                  	; (max. path length = 64 bytes for MSDOS ?) (*)
   320                                  	;xor	ecx, ecx ; 0
   321                                  	;;;
   322                                  a_0:	
   323 0000012C FEC4                    	inc	ah
   324                                  a_1:
   325                                  	;;;
   326                                  	; 14/11/2024
   327 0000012E 41                      	inc	ecx
   328                                  	;;;
   329 0000012F AC                      	lodsb
   330 00000130 AA                      	stosb
   331 00000131 3C2E                    	cmp	al, '.'
   332 00000133 74F7                    	je	short a_0
   333                                  	; 29/11/2024
   334 00000135 3C20                    	cmp	al, 20h
   335                                  	;and	al, al
   336                                  	;jnz	short a_1
   337                                  	;;;
   338                                  	; 14/11/2024
   339 00000137 7613                    	jna	short a_3
   340 00000139 20E4                    	and	ah, ah
   341 0000013B 7406                    	jz	short a_2
   342 0000013D 3C2F                    	cmp	al, '/'	; 14/12/2024
   343 0000013F 7502                    	jne	short a_2
   344 00000141 B400                    	mov	ah, 0
   345                                  a_2:
   346 00000143 80F94B                  	cmp	cl, 75	; 64+8+'.'+3 -> offset 75 is the last chr
   347 00000146 72E6                    	jb	short a_1
   348                                  	; 29/11/2024
   349 00000148 29C9                    	sub	ecx, ecx
   350 0000014A EB11                    	jmp	short a_4
   351                                  a_3:
   352                                  	; 29/11/2024
   353 0000014C 4F                      	dec	edi
   354                                  	;;;
   355 0000014D 08E4                    	or	ah, ah		; if period NOT found,
   356 0000014F 750C                    	jnz	short a_4 	; then add a .WAV extension.
   357                                  SetExt:
   358                                  	; 29/11/2024
   359                                  	;dec	edi
   360 00000151 C7072E574156            	mov	dword [edi], '.WAV'
   361                                  				; ! 64+12 is DOS limit
   362                                  				; but writing +4 must not
   363                                  				; destroy the following data	 
   364                                  	;mov	byte [edi+4], 0	; so, 80 bytes path + 0 is possible here
   365                                  	; 29/11/2024
   366 00000157 83C104                  	add	ecx, 4
   367 0000015A 83C704                  	add	edi, 4
   368                                  a_4:	
   369 0000015D C60700                  	mov	byte [edi], 0
   370                                  	; 30/11/2024
   371 00000160 C3                      	retn
   372                                  
   373                                  ; -------------------------------------------------------------
   374                                  
   375                                  getwavparms:
   376                                  	; 14/11/2024
   377 00000161 E8FF030000                     	call    getWAVParameters
   378 00000166 72AC                    	jc	short _exit_		; nothing to do
   379                                  
   380                                  	; 07/01/2025
   381 00000168 803D[20180000]00        	cmp	byte [allocated], 0
   382 0000016F 7744                    	ja	short StartPlay
   383                                  
   384                                  ; -------------------------------------------------------------
   385                                  
   386                                  	; 06/01/2025 (cgaplay2.s)
   387                                  	
   388                                  	; 16/12/2024 (sb16play.s)
   389                                  	; 07/12/2024 (playwav9.s) -ac97-
   390                                  	; Allocate Audio Buffer (for user)
   391                                  	sys	_audio, 0200h, BUFFERSIZE, audio_buffer
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000171 BB00020000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 00000176 B900800000          <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98 0000017B BA[00200000]        <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 00000180 B820000000          <1>  mov eax, %1
   103                              <1> 
   104 00000185 CD40                <1>  int 40h
   392 00000187 0F8285010000            	jc	error_exit
   393                                  
   394                                  	; 17/12/2024
   395 0000018D FE05[20180000]          	inc	byte [allocated]
   396                                  
   397                                  	; 17/12/2024
   398                                  	; Initialize Audio Device (bh = 3)
   399                                  	sys	_audio, 301h, 0, audio_int_handler
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000193 BB01030000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 00000198 B900000000          <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98 0000019D BA[9B050000]        <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000001A2 B820000000          <1>  mov eax, %1
   103                              <1> 
   104 000001A7 CD40                <1>  int 40h
   400 000001A9 0F8263010000            	jc	error_exit
   401                                  
   402                                  	; 17/12/2024
   403 000001AF FE05[21180000]          	inc	byte [interrupt]
   404                                  
   405                                  	; 08/01/2025
   406                                  	;; 17/12/2024
   407                                  	;; 16/12/2024
   408                                  	;; Map DMA Buffer to User (for wave graphics)
   409                                  	;sys	_audio, 0D00h, BUFFERSIZE*2, dma_buffer
   410                                  	;jc	error_exit
   411                                  
   412                                  ; -------------------------------------------------------------
   413                                  
   414                                  StartPlay:
   415                                  	; 30/12/2024
   416 000001B5 C605[73170000]01        	mov	byte [wpoints], 1
   417                                  
   418                                  ; 08/01/2025
   419                                  %if 0
   420                                  	;;;
   421                                  	; 06/01/2025
   422                                  	movzx	eax, word [WAVE_SampleRate]
   423                                  	;mov	ax, [WAVE_SampleRate]
   424                                  	mov	ecx, 10
   425                                  	mul	ecx
   426                                  	mov	cl, 182
   427                                  	div	ecx
   428                                  	; ax = samples per 1/18.2 second
   429                                  	mov	cl, byte [WAVE_BlockAlign]
   430                                  	mul	ecx
   431                                  	mov	[wpoints_dif], eax ; buffer read differential (distance)
   432                                  				; for wave volume leds update
   433                                  				; (byte stream per 1/18.2 second)
   434                                  %else
   435                                  	; 08/01/2025
   436 000001BC 31C9                    	xor	ecx, ecx
   437 000001BE 8A0D[98170000]          	mov	cl, byte [WAVE_BlockAlign]
   438                                  %endif
   439                                  	; 08/01/2025
   440 000001C4 B840010000              	mov	eax, 320
   441 000001C9 F7E1                    	mul	ecx
   442 000001CB A3[5C120000]            	mov	[sd_count], eax
   443                                  	;;;
   444                                  
   445                                  ; -------------------------------------------------------------
   446                                  
   447                                  	; 06/01/2025 (cgaplay2.s)
   448                                  	; 02/01/2025 (cgaplay2.asm)
   449                                  	;;;
   450                                  	; 23/11/2024 (sb16play.asm, [turn_on_leds])
   451 000001D0 803D[8E170000]01        	cmp	byte [WAVE_NumChannels], 1
   452 000001D7 771F                    	ja	short stolp_s
   453                                  stolp_m:
   454 000001D9 803D[9A170000]08        	cmp	byte [WAVE_BitsPerSample], 8
   455 000001E0 770B                    	ja	short stolp_m16
   456                                  stolp_m8:
   457 000001E2 66C705[1C180000]-       	mov	word [UpdateWavePoints], UpdateWavePoints_8m
   457 000001E9 [2B09]             
   458 000001EB EB2A                    	jmp	short stolp_ok
   459                                  stolp_m16:
   460 000001ED 66C705[1C180000]-       	mov	word [UpdateWavePoints], UpdateWavePoints_16m
   460 000001F4 [9008]             
   461 000001F6 EB1F                    	jmp	short stolp_ok
   462                                  stolp_s:
   463 000001F8 803D[9A170000]08        	cmp	byte [WAVE_BitsPerSample], 8
   464 000001FF 770B                    	ja	short stolp_s16
   465                                  stolp_s8:
   466 00000201 66C705[1C180000]-       	mov	word [UpdateWavePoints], UpdateWavePoints_8s
   466 00000208 [DB08]             
   467 0000020A EB0B                    	jmp	short stolp_ok
   468                                  stolp_s16:
   469 0000020C 66C705[1C180000]-       	mov	word [UpdateWavePoints], UpdateWavePoints_16s
   469 00000213 [3C08]             
   470 00000215 EB00                    	jmp	short stolp_ok
   471                                  stolp_ok:
   472                                  	;;;
   473                                  
   474                                  ; -------------------------------------------------------------
   475                                  
   476                                  	; 25/12/2024
   477 00000217 FE05[75170000]          	inc	byte [filecount]
   478 0000021D C605[74170000]00        	mov	byte [command], 0
   479                                  	; 30/12/2024
   480 00000224 C605[69120000]FF        	mov	byte [pbprev], -1
   481                                  
   482                                  	; 06/01/2025
   483                                  
   484                                  ; -------------------------------------------------------------
   485                                  
   486                                  	; 30/12/2024
   487                                  Player_Template:
   488                                  	; 21/12/2024
   489 0000022B E810010000              	call	clearscreen
   490 00000230 E81A010000              	call	drawplayingscreen
   491                                  
   492                                  	; 14/11/2024
   493 00000235 E8D2070000              	call	SetTotalTime
   494 0000023A E89F080000              	call	UpdateFileInfo
   495                                  
   496                                  ; -------------------------------------------------------------
   497                                  
   498                                  	; 06/01/2025 (cgaplay2.s) -SB16-
   499                                  	; 02/01/2025 (cgaplay2.asm) -SB16-
   500                                  	; 01/01/2025 (cgaplay.asm) -AC97-
   501                                  	; 30/12/2024 (cgaplay.s) -AC97-
   502                                  	; 29/12/2024 (vgaplay3.s) -AC97-
   503                                  	; 20/12/2024 (sb16play.asm) 
   504                                  	; 18/12/2024 (ac97play.s)
   505                                  PlayNow:
   506                                  	; 01/12/2024 (32bit)
   507                                  	; 14/11/2024
   508                                  	;;mov	al, 3	; 0 = max, 31 = min
   509                                  	; 24/11/2024
   510                                  	;mov	al, 5	; 15 = max, 0 = min
   511                                  	; 27/11/2024
   512                                  	;mov	[volume], al
   513                                  	; 14/12/2024
   514 0000023F A0[EF090000]            	mov	al, [volume]
   515                                  	;call	SetPCMOutVolume@
   516                                  	; 02/01/2025
   517 00000244 E88C020000              	call	SetMasterVolume@
   518                                  	; 15/11/2024
   519                                  	;call	SetMasterVolume
   520                                  	;;call	SetPCMOutVolume
   521                                  
   522                                  	;;;
   523                                  	; 14/11/2024
   524 00000249 E896090000              	call	UpdateProgressBar
   525                                  	;;;
   526                                  
   527                                   	; 30/05/2024
   528                                  	; playwav4.asm
   529                                  _2:	
   530 0000024E E839070000              	call	check4keyboardstop	; flush keyboard buffer
   531 00000253 72F9                    	jc	short _2		; 07/11/2023
   532                                  
   533                                  ; play the .wav file. Most of the good stuff is in here.
   534                                  
   535 00000255 E846010000              	call    PlayWav
   536                                  
   537                                  	; 30/12/2024
   538                                  	; 29/12/2024 (vgaplay3.s)
   539                                  	; 27/12/2024 (vgaplay.s)
   540                                  _3:
   541                                  
   542                                  ; close the .wav file and exit.
   543                                  
   544                                  	; 25/12/2024
   545 0000025A E8EF020000              	call	closeFile
   546                                  
   547                                  	; 25/12/2024
   548                                  	;;;
   549                                  	; reset file loading and EOF parameters
   550                                  	; 18/12/2024
   551 0000025F C705[10180000]0000-     	mov	dword [count], 0
   551 00000267 0000               
   552 00000269 C705[14180000]0000-     	mov	dword [LoadedDataBytes], 0
   552 00000271 0000               
   553 00000273 C605[06180000]00        	mov	byte [flags], 0
   554 0000027A C605[71170000]00        	mov	byte [stopped], 0
   555                                  	; 08/01/2025
   556                                  	; 29/12/2024
   557                                  	;mov	dword [pbuf_s], 0
   558                                  	;;;
   559                                  
   560 00000281 803D[74170000]51        	cmp	byte [command], 'Q'
   561 00000288 7405                    	je	short terminate
   562 0000028A E917FEFFFF              	jmp	check_p_command
   563                                  
   564                                  terminate:
   565 0000028F E8FF000000              	call	set_text_mode
   566                                  	; 06/01/2025
   567                                  Exit@:
   568                                  	; 17/12/2024
   569 00000294 803D[21180000]00        	cmp	byte [interrupt], 0
   570 0000029B 760C                    	jna	short skip_cb_cancel
   571                                  
   572                                  	; Cancel callback service (for user)
   573                                  	sys	_audio, 0900h
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 0000029D BB00090000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000002A2 B820000000          <1>  mov eax, %1
   103                              <1> 
   104 000002A7 CD40                <1>  int 40h
   574                                  
   575                                  skip_cb_cancel:
   576                                  	; 17/12/2024
   577 000002A9 803D[20180000]00        	cmp	byte [allocated], 0
   578 000002B0 760C                    	jna	short skip_ab_dalloc
   579                                  
   580                                  	; Deallocate Audio Buffer (for user)
   581                                  	sys	_audio, 0A00h
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 000002B2 BB000A0000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000002B7 B820000000          <1>  mov eax, %1
   103                              <1> 
   104 000002BC CD40                <1>  int 40h
   582                                  
   583                                  skip_ab_dalloc:
   584                                  	; Disable Audio Device
   585                                  	sys	_audio, 0C00h
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 000002BE BB000C0000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000002C3 B820000000          <1>  mov eax, %1
   103                              <1> 
   104 000002C8 CD40                <1>  int 40h
   586                                  	;;;
   587                                  Exit:
   588                                  	;mov	ax, 4C00h	; bye !
   589                                  	;int	21h
   590                                  	; 01/12/2024
   591                                  	sys	_exit, 0
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 000002CA BB00000000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000002CF B801000000          <1>  mov eax, %1
   103                              <1> 
   104 000002D4 CD40                <1>  int 40h
   592                                  halt:
   593 000002D6 EBFE                    	jmp	short halt
   594                                  
   595                                  ; -------------------------------------------------------------
   596                                  
   597                                  	; 30/05/2024
   598                                  pmsg_usage:
   599                                  	; 21/12/2024
   600 000002D8 E8B6000000              	call	set_text_mode
   601                                  	; 01/12/2024
   602                                  	sys	_msg, msg_usage, 255, 0Fh
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 000002DD BB[4E0D0000]        <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 000002E2 B9FF000000          <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98 000002E7 BA0F000000          <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000002EC B823000000          <1>  mov eax, %1
   103                              <1> 
   104 000002F1 CD40                <1>  int 40h
   603 000002F3 EBD5                    	jmp	short Exit
   604                                  
   605                                  ; -------------------------------------------------------------
   606                                  
   607                                  	; 30/05/2024
   608                                  init_err:
   609                                  	; 21/12/2024
   610 000002F5 E899000000              	call	set_text_mode
   611                                  	; 01/12/2024
   612                                  	sys	_msg, msg_init_err, 255, 0Fh
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 000002FA BB[EE0D0000]        <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 000002FF B9FF000000          <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98 00000304 BA0F000000          <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 00000309 B823000000          <1>  mov eax, %1
   103                              <1> 
   104 0000030E CD40                <1>  int 40h
   613 00000310 EBB8                    	jmp	short Exit
   614                                  
   615                                  ; -------------------------------------------------------------
   616                                  
   617                                  	; 07/12/2024
   618                                  error_exit:
   619                                  	; 21/12/2024
   620 00000312 E87C000000              	call	set_text_mode
   621                                  trdos386_error:
   622                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000317 BB[CE0D0000]        <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 0000031C B9FF000000          <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98 00000321 BA0E000000          <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 00000326 B823000000          <1>  mov eax, %1
   103                              <1> 
   104 0000032B CD40                <1>  int 40h
   623 0000032D EB9B                    	jmp	short Exit
   624                                  
   625                                  ; -------------------------------------------------------------
   626                                  
   627                                  	; 21/12/2024
   628                                  print_msg:
   629 0000032F B40E                    	mov	ah, 0Eh
   630 00000331 BB07000000              	mov	ebx, 7
   631                                  	;mov	bl, 7 ; char attribute & color
   632                                  p_next_chr:
   633 00000336 AC                      	lodsb
   634 00000337 08C0                    	or	al, al
   635 00000339 7404                    	jz	short p_retn ; retn
   636 0000033B CD31                    	int	31h
   637 0000033D EBF7                    	jmp	short p_next_chr
   638                                  p_retn:
   639 0000033F C3                      	retn
   640                                  
   641                                  ; -------------------------------------------------------------
   642                                  
   643                                  	; 30/12/2024
   644                                  clearscreen:
   645                                  	; fast clear
   646                                  	; 320*200, 256 colors
   647 00000340 BF00000A00              	mov	edi, 0A0000h
   648 00000345 B9803E0000              	mov	ecx, (320*200*1)/4
   649 0000034A 31C0                    	xor	eax, eax
   650 0000034C F3AB                    	rep	stosd
   651 0000034E C3                      	retn
   652                                  
   653                                  ; -------------------------------------------------------------
   654                                  
   655                                  	; 30/12/2024 (VGA Mode 13h, 320*200 pixels, 256 colors)
   656                                  	; 26/12/2024
   657                                  	; 21/12/2024
   658                                  drawplayingscreen:
   659 0000034F BD[880E0000]            	mov	ebp, PlayingScreen
   660                                  	;mov	esi, 0 ; row 0, column 0
   661 00000354 BE00000200              	mov	esi, 00020000h ; row 2, column 0 ; top margin = 2
   662                                  p_d_x:
   663 00000359 C605[68120000]28        	mov	byte [columns], 40
   664 00000360 B601                    	mov	dh, 01h ; 8x8 system font
   665                                  p_d_x_n:
   666 00000362 8A5500                  	mov	dl, [ebp]
   667 00000365 20D2                    	and	dl, dl
   668 00000367 7429                    	jz	short p_d_x_ok
   669                                  
   670                                  	; sysvideo system call
   671                                  	; BH = 01h = VGA graphics (0A0000h) data transfers
   672                                  	; BL = 0Fh = write character/font
   673                                  	; DH = 01h = 8*8 system font 
   674                                  	; CL = 0Fh = color (white)
   675                                  	; ESI = cursor/writing position (pixels)
   676                                  	;	HW = row, SI = column
   677                                  
   678                                  	sys	_video, 010Fh, 0Fh
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000369 BB0F010000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 0000036E B90F000000          <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 00000373 B81F000000          <1>  mov eax, %1
   103                              <1> 
   104 00000378 CD40                <1>  int 40h
   679                                  
   680 0000037A 45                      	inc	ebp
   681 0000037B 6683C608                	add	si, 8 ; next char pos
   682 0000037F FE0D[68120000]          	dec	byte [columns]
   683 00000385 75DB                    	jnz	short p_d_x_n	; next column
   684 00000387 6631F6                  	xor	si, si
   685 0000038A 81C600000800            	add	esi, 00080000h	; next row ; 8*8
   686 00000390 EBC7                    	jmp	short p_d_x
   687                                  p_d_x_ok:
   688 00000392 C3                      	retn
   689                                  
   690                                  ; -------------------------------------------------------------
   691                                  
   692                                  	; 21/12/2024
   693                                  set_text_mode:
   694 00000393 30E4                    	xor    ah, ah
   695 00000395 B003                    	mov    al, 3                        
   696                                   	;int   10h ; al = 03h text mode, int 10 video
   697 00000397 CD31                    	int    31h ; TRDOS 386 - Video interrupt
   698 00000399 C3                      	retn
   699                                  
   700                                  ; -------------------------------------------------------------
   701                                  
   702                                  	; 02/12/2024
   703                                  Player_Quit@:
   704 0000039A 58                      	pop	eax ; return addr (call PlayWav@)
   705                                  	
   706                                  	; 29/11/2024
   707                                  Player_Quit:
   708 0000039B E9EFFEFFFF              	jmp	 terminate
   709                                  
   710                                  ; -------------------------------------------------------------
   711                                  
   712                                  	; 06/01/2025 (cgaplay2.s)
   713                                  	; 02/01/2025 (cgaplay2.asm)
   714                                  	; 20/12/2024
   715                                  	; 15/12/2024 (sb16play.s)
   716                                  	; ref: playwav4.s, 18/08/2020
   717                                  	; 24/11/2024 (sb16play.asm)
   718                                  PlayWav:
   719                                  	; load 32768 bytes into audio buffer
   720                                  	;mov	edi, audio_buffer ; 16/12/2024
   721 000003A0 E80A020000              	call	loadFromFile
   722                                  	; 18/12/2024
   723                                  	;jc	error_exit
   724                                  	;mov	byte [half_buff], 1 ; (DMA) Buffer 1
   725                                  
   726 000003A5 A1[10180000]            	mov	eax, [count]
   727 000003AA 0105[14180000]          	add	[LoadedDataBytes], eax
   728                                  
   729 000003B0 F605[06180000]01        	test    byte [flags], ENDOFFILE  ; end of file ?
   730 000003B7 751C                    	jnz	short _pw1 ; yes
   731                                  			   ; bypass filling dma half buffer 2
   732                                  
   733                                  	; bh = 16 : update (current, first) dma half buffer
   734                                  	; bl = 0  : then switch to the next (second) half buffer
   735                                  	sys	_audio, 1000h
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 000003B9 BB00100000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000003BE B820000000          <1>  mov eax, %1
   103                              <1> 
   104 000003C3 CD40                <1>  int 40h
   736                                  
   737                                  	; [audio_flag] = 1 (in TRDOS 386 kernel)
   738                                  
   739                                  	; audio_buffer must be filled again after above system call
   740                                  	; (Because audio interrupt will be generated by sound hardware
   741                                  	; at the end of the first half of dma buffer.. so,
   742                                  	; the second half must be ready. 'sound_play' will use it.)
   743                                  
   744                                  	;mov	edi, audio_buffer ; 16/12/2024
   745 000003C5 E8E5010000              	call	loadFromFile
   746                                  	;jc	short p_return
   747                                  
   748 000003CA A1[10180000]            	mov	eax, [count]
   749 000003CF 0105[14180000]          	add	[LoadedDataBytes], eax
   750                                  
   751                                  	; 06/01/2025
   752                                  _pw1:	
   753                                  	; 07/01/2025
   754                                  	; 20/12/2024
   755                                  	; 25/11/2024
   756 000003D5 E802030000              	call	SB16Init_play	; initialize SB16 card
   757                                  				; set sample rate, start to play
   758 000003DA 0F8215FFFFFF            	jc	init_err
   759                                  
   760                                  	; 08/01/2025
   761                                  	; 20/12/2024
   762 000003E0 F605[06180000]01        	test    byte [flags], ENDOFFILE ; end of file
   763 000003E7 7510                    	jnz	short _pw2	; yes
   764                                  
   765                                  	; 20/12/2024	
   766                                  	;mov     edi, audio_buffer
   767 000003E9 E8C1010000              	call	loadFromFile
   768                                  	;jc	short p_return
   769                                  	;xor	byte [half_buffer], 1
   770                                  
   771 000003EE A1[10180000]            	mov	eax, [count]
   772 000003F3 0105[14180000]          	add	[LoadedDataBytes], eax
   773                                  _pw2:
   774 000003F9 C605[07180000]00        	mov	byte [SRB], 0
   775                                  
   776                                  ; -------------------------------------------
   777                                  
   778                                  	; 07/01/2025
   779                                  	; 06/01/2025 (cgaplay2.s)
   780                                  	; 30/12/2024 (cgaplay.s)
   781                                  	; 29/12/2024 (vgaplay3.s)
   782                                  	; 18/12/2024 (ac97play.s)
   783                                  	; 01/12/2024 (32bit)
   784                                  	; 29/11/2024
   785                                  	; 16/12/2024 (TRDOS 386)
   786                                  	; 29/11/2024
   787                                  	; 27/11/2024
   788                                  	; 24/11/2024
   789                                  TuneLoop: 
   790                                  	; 30/05/2024
   791                                  	; 18/11/2023 (ich_wav4.asm)
   792                                  	; 08/11/2023
   793                                  	; 06/11/2023
   794                                  
   795                                  	; 20/12/2024
   796 00000400 E8DF070000              	call	UpdateProgressBar
   797                                  
   798                                  tLWait:
   799                                  	; 07/12/2024 (playwav9.s)
   800                                  	; 18/11/2024
   801 00000405 803D[71170000]00        	cmp	byte [stopped], 0
   802                                  	; 24/11/2024
   803 0000040C 7639                    	jna	short tL1
   804                                  
   805                                  	;;;
   806                                  	; 09/12/2024 (ac97play.s)
   807 0000040E 803D[71170000]03        	cmp	byte [stopped], 3
   808 00000415 7375                    	jnb	_exitt_
   809                                  	;;;
   810 00000417 E8FE020000              	call	checkUpdateEvents
   811 0000041C 726E                    	jc	_exitt_
   812                                  	;;;
   813                                  	; 29/11/2024
   814 0000041E 803D[74170000]4E        	cmp	byte [command], 'N'
   815 00000425 7465                    	je	_exitt_
   816 00000427 803D[74170000]50        	cmp	byte [command], 'P'
   817 0000042E 745C                    	je	_exitt_
   818                                  	;;;
   819 00000430 803D[72170000]30        	cmp	byte [tLO], '0'
   820 00000437 74CC                    	je	short tLWait
   821 00000439 E858000000              	call	tLZ
   822 0000043E C605[72170000]30        	mov	byte [tLO], '0'
   823 00000445 EBBE                    	jmp	short tLWait
   824                                  
   825                                  tL1:
   826                                  	; 16/12/2024
   827                                  	; 07/12/2024 (playwav9.s)
   828                                  	; 27/11/2024
   829                                  	; Check audio interrupt status
   830 00000447 803D[07180000]00        	cmp	byte [SRB], 0
   831 0000044E 7709                    	ja	short tL3
   832                                  tL2:
   833 00000450 E8C5020000              	call	checkUpdateEvents
   834 00000455 7235                    	jc	_exitt_
   835 00000457 EBAC                    	jmp	short tLWait
   836                                  tL3:
   837                                  	; 07/01/2025
   838 00000459 8035[5A120000]01        	xor	byte [half_buffer], 1
   839                                  	; 07/12/2024
   840 00000460 C605[07180000]00        	mov	byte [SRB], 0
   841                                  
   842                                  	; 16/12/2024
   843                                  	;mov	edi, audio_buffer
   844 00000467 E843010000              	call	loadFromFile
   845 0000046C 721E                    	jc	short _exitt_	; end of file
   846                                  
   847                                  	; 26/11/2024
   848 0000046E A0[5A120000]            	mov	al, [half_buffer]
   849 00000473 0431                    	add	al, '1'
   850                                  	; 19/11/2024
   851 00000475 A2[72170000]            	mov	[tLO], al
   852 0000047A E819000000              	call	tL0
   853                                  	; 16/12/2024 (TRDOS 386)
   854                                  	; 24/11/2024
   855                                  	; 14/11/2024
   856 0000047F A1[10180000]            	mov	eax, [count]
   857 00000484 0105[14180000]          	add	[LoadedDataBytes], eax
   858                                  
   859                                  	; 27/11/2024
   860 0000048A EBC4                    	jmp	short tL2
   861                                  
   862                                  _exitt_:
   863                                  	; 24/11/2024
   864 0000048C E866000000              	call	sb16_stop
   865                                  
   866                                  	;;;
   867                                  	; 14/11/2024
   868 00000491 E84E070000              	call	UpdateProgressBar
   869                                  	;;;
   870                                  
   871                                  
   872                                  	; 18/11/2024
   873                                  tLZ:
   874                                  	; 30/05/2024
   875 00000496 B030                    	mov	al, '0'
   876                                  
   877                                  	;add	al, '0'
   878                                  	;call	tL0
   879                                  	;
   880                                  	;retn
   881                                  	; 06/11/2023
   882                                  	;jmp	short tL0
   883                                  	;retn
   884                                  
   885                                  tL0:
   886                                  	; 30/12/2024 (cgaplay.s)
   887                                  	; 29/05/2024 (TRDOS 386)
   888                                  	; 08/11/2023
   889                                  	; 05/11/2023
   890                                  	; 17/02/2017 - Buffer switch test (temporary)
   891                                  	; 06/11/2023
   892                                  	; al = buffer indicator ('1', '2' or '0' -stop- )
   893                                  
   894                                  	; 30/12/2024 (video mode 13h modification)
   895                                  	; (320*200, 256 colors)
   896                                  	;;;
   897 00000498 88C2                    	mov	dl, al ; character
   898 0000049A BF00000A00              	mov	edi, 0A0000h
   899                                  
   900 0000049F BB08000000              	mov	ebx, 8 ; 8 pixels (8*8 pixels font)
   901                                  
   902 000004A4 B00C                    	mov	al, 0Ch ; red
   903                                  tL0_1:
   904                                  	;mov	ecx, 8 ; 8 pixels (8*8 pixels font)
   905 000004A6 B907000000              	mov	ecx, 7
   906                                  tL0_2:
   907 000004AB AA                      	stosb
   908 000004AC 49                      	dec	ecx
   909 000004AD 75FC                    	jnz	short tL0_2
   910 000004AF 4B                      	dec	ebx
   911 000004B0 7408                    	jz	short tL0_3
   912                                  	;add	edi, 320-8 ; next line
   913 000004B2 81C739010000            	add	edi, 320-7
   914 000004B8 EBEC                    	jmp	short tL0_1
   915                                  tL0_3:
   916                                  	; write system font
   917 000004BA B601                    	mov	dh, 01h
   918                                  	;mov	dl, al ; character
   919 000004BC 31F6                    	xor	esi, esi ; = row 0, column 0
   920                                  	sys	_video, 010Fh, 0Eh ; yellow
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 000004BE BB0F010000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 000004C3 B90E000000          <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000004C8 B81F000000          <1>  mov eax, %1
   103                              <1> 
   104 000004CD CD40                <1>  int 40h
   921                                  	;;;
   922                                  
   923 000004CF C3                      	retn
   924                                  
   925                                  ; -------------------------------------------
   926                                  
   927                                  	; 06/01/2025 (cgaplay2.s) -TRDOS386-
   928                                  	; 02/01/2025 (cgaplay2.asm) -DOS-
   929                                  	; 18/12/2024
   930                                  	; 16/12/2024 (sb16play.s)
   931                                  	; 07/12/2024 (playwav9.s)
   932                                  
   933                                  SetMasterVolume:
   934                                  	;cmp	al, 31
   935                                  	;ja	short setvolume_ok
   936 000004D0 A2[EF090000]            	mov	[volume], al  ; max = 0, min = 31
   937                                  SetMasterVolume@:
   938                                  	; al = [volume]
   939 000004D5 B41F                    	mov	ah, 31
   940 000004D7 28C4                    	sub	ah, al
   941 000004D9 88E0                    	mov	al, ah
   942                                  
   943                                  	; Set Master Volume Level (BL=0 or 80h)
   944                                  	; 	for next playing (BL>=80h)
   945                                  	;sys	_audio, 0B80h, eax
   946                                  	sys	_audio, 0B00h, eax
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 000004DB BB000B0000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 000004E0 89C1                <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000004E2 B820000000          <1>  mov eax, %1
   103                              <1> 
   104 000004E7 CD40                <1>  int 40h
   947                                  
   948                                  setvolume_ok:
   949 000004E9 C3                      	retn
   950                                  
   951                                  ; -------------------------------------------
   952                                  
   953                                  	; 16/12/2024 (sb16play.s)
   954                                  	; Ref: playwav4.s (18/08/2020)
   955                                  	; Detect (BH=1) SB16 (BL=1) Audio Card (or Emulator)
   956                                  DetectSB16:
   957                                          sys	_audio, 101h
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 000004EA BB01010000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000004EF B820000000          <1>  mov eax, %1
   103                              <1> 
   104 000004F4 CD40                <1>  int 40h
   958 000004F6 C3                      	retn
   959                                  
   960                                  ; --------------------------------------------
   961                                  
   962                                  ; 16/12/2024 (sb16play.s)
   963                                  ; 07/12/2024 (playwav9.s)
   964                                  ; Ref: TRDOS 386 v2.0.9, trdosk8.s (18/09/2024)
   965                                  ;		'sysaudio' system call (23/08/2024)
   966                                  ; 18/11/2024
   967                                  ; Ref: TRDOS 386 v2.0.9, audio.s, Erdogan Tan, 06/06/2024
   968                                  
   969                                  sb16_stop:
   970                                  	; 18/11/2024
   971 000004F7 C605[71170000]02        	mov	byte [stopped], 2
   972                                  	; 07/12/2024
   973                                  	sys	_audio, 0700h
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 000004FE BB00070000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 00000503 B820000000          <1>  mov eax, %1
   103                              <1> 
   104 00000508 CD40                <1>  int 40h
   974 0000050A C3                      	retn
   975                                  
   976                                  sb16_pause:
   977                                  	; 18/11/2024
   978 0000050B C605[71170000]01        	mov	byte [stopped], 1 ; paused
   979                                  	; 07/12/2024
   980                                  	sys	_audio, 0500h
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000512 BB00050000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 00000517 B820000000          <1>  mov eax, %1
   103                              <1> 
   104 0000051C CD40                <1>  int 40h
   981 0000051E C3                      	retn
   982                                  
   983                                  sb16_play:
   984                                  sb16_continue:
   985                                  	; continue to play (after pause)
   986                                  	; 18/11/2024
   987 0000051F C605[71170000]00        	mov	byte [stopped], 0
   988                                  	; 07/12/2024
   989                                  	sys	_audio, 0600h
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000526 BB00060000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 0000052B B820000000          <1>  mov eax, %1
   103                              <1> 
   104 00000530 CD40                <1>  int 40h
   990 00000532 C3                      	retn
   991                                  
   992                                  ; ----------------------------------
   993                                  	
   994                                  	; 26/12/2024
   995                                  	; 07/12/2024
   996                                  	; 01/12/2024
   997                                  	; 14/11/2024
   998                                  	; INPUT: ds:dx = file name address
   999                                  	; OUTPUT: [filehandle] = ; -1 = not open
  1000                                  openFile:
  1001                                  	; 26/12/2024
  1002                                  	; 01/12/2024
  1003                                  	sys	_open, edx, 0
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000533 89D3                <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 00000535 B900000000          <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 0000053A B805000000          <1>  mov eax, %1
   103                              <1> 
   104 0000053F CD40                <1>  int 40h
  1004                                  	; 07/12/2024
  1005                                  	;sys	_open, wav_file_name, 0
  1006 00000541 7305                    	jnc	short _of1
  1007                                  
  1008 00000543 B8FFFFFFFF              	mov	eax, -1
  1009                                  	; cf = 1 -> not found or access error
  1010                                  _of1:
  1011 00000548 A3[A4170000]            	mov	[filehandle], eax
  1012 0000054D C3                      	retn
  1013                                  
  1014                                  ; ----------------------------------
  1015                                  
  1016                                  ; close the currently open file
  1017                                  
  1018                                  	; 01/12/2024
  1019                                  	; 14/11/2024
  1020                                  	; INPUT: [filehandle] ; -1 = not open
  1021                                  	; OUTPUT: none
  1022                                  closeFile:
  1023 0000054E 833D[A4170000]FF        	cmp	dword [filehandle], -1
  1024 00000555 740D                    	jz	short _cf1
  1025                                  	; 01/12/2024
  1026                                  	sys	_close, [filehandle]
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000557 8B1D[A4170000]      <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 0000055D B806000000          <1>  mov eax, %1
   103                              <1> 
   104 00000562 CD40                <1>  int 40h
  1027                                  	;mov 	dword [filehandle], -1
  1028                                  _cf1:
  1029 00000564 C3                      	retn
  1030                                  
  1031                                  ; ----------------------------------
  1032                                  
  1033                                  	; 01/12/2024
  1034                                  	; 14/11/2024 - Erdogan Tan
  1035                                  getWAVParameters:
  1036                                  ; reads WAV file header(s) (44 bytes) from the .wav file.
  1037                                  ; entry: none - assumes file is already open
  1038                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
  1039                                  ;	cx = number of channels (mono=1, stereo=2)
  1040                                  ;	dx = bits per sample (8, 16)
  1041                                  ;	bx = number of bytes per sample (1 to 4)
  1042                                  
  1043                                          ;mov	dx, WAVFILEHEADERbuff
  1044                                  	;mov	bx, [filehandle]
  1045                                          ;mov	cx, 44			; 44 bytes
  1046                                  	;mov	ah, 3Fh
  1047                                          ;int	21h
  1048                                  	;jc	short gwavp_retn
  1049                                  	; 01/12/2024 (TRDOS 386)
  1050                                  	sys	_read, [filehandle], WAVFILEHEADERbuff, 44
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000565 8B1D[A4170000]      <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 0000056B B9[78170000]        <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98 00000570 BA2C000000          <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 00000575 B803000000          <1>  mov eax, %1
   103                              <1> 
   104 0000057A CD40                <1>  int 40h
  1051 0000057C 721C                    	jc	short gwavp_retn
  1052                                  
  1053 0000057E 83F82C                  	cmp	eax, 44
  1054 00000581 7217                    	jb	short gwavp_retn
  1055                                  
  1056 00000583 813D[80170000]5741-     	cmp	dword [RIFF_Format], 'WAVE'
  1056 0000058B 5645               
  1057 0000058D 750A                    	jne	short gwavp_stc_retn
  1058                                  
  1059 0000058F 66833D[8C170000]01      	cmp	word [WAVE_AudioFormat], 1 ; Offset 20, must be 1 (= PCM)
  1060                                  	;jne	short gwavp_stc_retn
  1061 00000597 7401                    	je	short gwavp_retn ; 15/11/2024
  1062                                  
  1063                                  	; 15/11/2024
  1064                                  	;mov	cx, [WAVE_NumChannels]	; return num of channels in CX
  1065                                          ;mov    ax, [WAVE_SampleRate]	; return sample rate in AX
  1066                                  	;mov	dx, [WAVE_BitsPerSample] 
  1067                                  					; return bits per sample value in DX
  1068                                  	;mov	bx, [WAVE_BlockAlign]	; return bytes per sample in BX
  1069                                  ;gwavp_retn:
  1070                                          ;retn
  1071                                  
  1072                                  gwavp_stc_retn:
  1073 00000599 F9                      	stc
  1074                                  gwavp_retn:
  1075 0000059A C3                      	retn
  1076                                  
  1077                                  ; /////
  1078                                  
  1079                                  ; 16/12/2024 (sb16play.s)
  1080                                  ; --------------------------------------------------------
  1081                                  ; 07/12/2024 (playwav9.s)
  1082                                  ; --------------------------------------------------------
  1083                                  ; ref: playwav8.s (04/06/2024)
  1084                                  
  1085                                  audio_int_handler:
  1086                                  	; 18/08/2020 (14/10/2020, 'wavplay2.s')
  1087                                  
  1088                                  	; 07/12/2024
  1089                                  	;mov	al, [stopped]
  1090                                  	;cmp	al, 2
  1091                                  	;je	short _callback_retn
  1092                                  
  1093                                  	; 18/08/2020
  1094                                  	;mov	byte [SRB], 1
  1095                                  	; 07/12/2024
  1096 0000059B FE05[07180000]          	inc	byte [SRB]
  1097                                  
  1098                                  ;_callback_retn:
  1099                                  	sys	_rele ; return from callback service 
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94                              <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000005A1 B827000000          <1>  mov eax, %1
   103                              <1> 
   104 000005A6 CD40                <1>  int 40h
  1100                                  	; we must not come here !
  1101                                  	sys	_exit
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94                              <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000005A8 B801000000          <1>  mov eax, %1
   103                              <1> 
   104 000005AD CD40                <1>  int 40h
  1102                                  ; --------------------------------------------------------
  1103                                  ; 07/12/2024
  1104                                  ; --------------------------------------------------------
  1105                                  
  1106                                  ; /////
  1107                                  	; 16/12/2024 (sb16play.s)
  1108                                  	; 14/12/2024 (playwav9.s)
  1109                                  	; 07/12/2024
  1110                                  	; 01/12/2024
  1111                                  	; 24/11/2024 (SB16 version of playwav8.asm -> playwav9.asm)
  1112                                  	; 30/05/2024 (ich_wav4.asm, 19/05/2024)
  1113                                  loadFromFile:
  1114                                  	; 18/12/2024
  1115 000005AF C705[10180000]0000-     	mov	dword [count], 0
  1115 000005B7 0000               
  1116                                  
  1117                                  	; 07/11/2023
  1118 000005B9 F605[06180000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1119                                  					; last of the file?
  1120 000005C0 7402                    	jz	short lff_0		; no
  1121 000005C2 F9                      	stc
  1122 000005C3 C3                      	retn
  1123                                  
  1124                                  lff_0:
  1125                                  	; 16/12/2024
  1126 000005C4 BF[00200000]            	mov	edi, audio_buffer
  1127                                  
  1128                                  	; 14/12/2024 (playwav9.s)
  1129                                  	;sys 	_read, [filehandle], esi, [loadsize]
  1130                                  	; 16/12/2024
  1131                                  	sys	_read, [filehandle], edi, BUFFERSIZE
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 000005C9 8B1D[A4170000]      <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 000005CF 89F9                <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98 000005D1 BA00800000          <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000005D6 B803000000          <1>  mov eax, %1
   103                              <1> 
   104 000005DB CD40                <1>  int 40h
  1132 000005DD 7226                    	jc	short lff_4 ; error !
  1133                                  
  1134                                  	; 20/12/2024
  1135 000005DF A3[10180000]            	mov	[count], eax
  1136                                  
  1137                                  	; 16/12/2024
  1138 000005E4 39D0                    	cmp	eax, edx
  1139 000005E6 741C                    	je	short endLFF
  1140                                  	; edi = buffer address
  1141 000005E8 01C7                    	add	edi, eax
  1142                                  lff_3:
  1143                                  	; 20/12/2024
  1144 000005EA 89D1                    	mov	ecx, edx ; BUFFERSIZE
  1145                                  	;call    padfill		; blank pad the remainder
  1146                                  	;;;
  1147                                  	; 20/12/2024
  1148                                  padfill:
  1149                                  	; 16/12/2024 (sb16play.s)
  1150                                  	;   edi = buffer offset
  1151                                  	;   ecx = buffer size
  1152                                  	;   eax = loaded bytes
  1153                                  	; 24/11/2024 (sb16play.asm)
  1154                                  	;   di = offset (to be filled with ZEROs)
  1155                                  	;   es = ds = cs
  1156                                  	;   ax = di = number of bytes loaded
  1157                                  	;   cx = buffer size (> loaded bytes)
  1158 000005EC 29C1                    	sub	ecx, eax
  1159 000005EE 31C0                    	xor	eax, eax
  1160 000005F0 803D[9A170000]08        	cmp	byte [WAVE_BitsPerSample], 8
  1161 000005F7 7702                    	ja	short padfill@
  1162 000005F9 B080                    	mov	al, 80h
  1163                                  padfill@:
  1164 000005FB F3AA                    	rep	stosb
  1165                                  	;retn
  1166                                  	;;;
  1167                                  
  1168                                          ;clc				; don't exit with CY yet.
  1169 000005FD 800D[06180000]01                or	byte [flags], ENDOFFILE	; end of file flag
  1170                                  endLFF:
  1171 00000604 C3                              retn
  1172                                  lff_4:
  1173                                  	; 08/11/2023
  1174 00000605 B021                    	mov	al, '!'  ; error
  1175 00000607 E88CFEFFFF              	call	tL0
  1176                                  
  1177                                  	; 16/12/2024
  1178 0000060C 29C0                    	sub	eax, eax
  1179                                  	;mov	ecx, edx ; BUFFERSIZE
  1180 0000060E EBDA                    	jmp	short lff_3
  1181                                  
  1182                                  ; /////
  1183                                  
  1184                                  ; --------------------------------------------------------
  1185                                  ; --------------------------------------------------------
  1186                                  	
  1187                                  write_audio_dev_info:
  1188                                  	; 30/05/2024
  1189                                       	;sys_msg msgAudioCardInfo, 0Fh
  1190                                  	; 01/12/2024
  1191                                  	sys 	_msg, msgAudioCardInfo, 255, 0Fh
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000610 BB[290D0000]        <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 00000615 B9FF000000          <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98 0000061A BA0F000000          <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 0000061F B823000000          <1>  mov eax, %1
   103                              <1> 
   104 00000624 CD40                <1>  int 40h
  1192 00000626 C3                      	retn
  1193                                  
  1194                                  ; --------------------------------------------------------
  1195                                  
  1196                                  	; 20/12/2024 (playwavx.s, sb16play.s)
  1197                                  write_sb16_dev_info:
  1198                                  	; 27/11/2024
  1199                                  	; 24/11/2024 (sb16play.asm)
  1200                                  
  1201 00000627 A1[6C170000]            	mov	eax, [audio_io_base]
  1202 0000062C 31DB                    	xor	ebx, ebx
  1203 0000062E 88C3                    	mov	bl, al
  1204 00000630 88DA                    	mov	dl, bl
  1205 00000632 80E30F                  	and	bl, 0Fh
  1206 00000635 8A83[230E0000]          	mov	al, [ebx+hex_chars]
  1207 0000063B A2[6C0E0000]            	mov	[msgBasePort+2], al
  1208 00000640 88D3                    	mov	bl, dl
  1209 00000642 C0EB04                  	shr	bl, 4
  1210 00000645 8A83[230E0000]          	mov	al, [ebx+hex_chars]
  1211 0000064B A2[6B0E0000]            	mov	[msgBasePort+1], al
  1212 00000650 88E3                    	mov	bl, ah
  1213                                  	;and	bl, 0Fh
  1214 00000652 8A83[230E0000]          	mov	al, [ebx+hex_chars]
  1215 00000658 A2[6A0E0000]            	mov	[msgBasePort], al
  1216                                  
  1217                                  	;xor	eax, eax
  1218                                  	; 27/11/2024
  1219 0000065D A0[70170000]            	mov	al, [audio_intr]
  1220                                  	;mov	cl, 10
  1221                                  	;div	cl
  1222                                  	;add	ah, 30h
  1223                                  	;mov	[msgIRQ], ah
  1224                                  	; 25/11/2024
  1225 00000662 0430                    	add	al, 30h
  1226 00000664 A2[810E0000]            	mov	[msgIRQ], al
  1227                                  
  1228 00000669 E85D060000              	call 	clear_window
  1229                                  	;mov	dh, 13
  1230                                  	; 02/01/2025
  1231 0000066E B60C                    	mov	dh, 12
  1232 00000670 B200                    	mov	dl, 0
  1233 00000672 E879030000              	call	setCursorPosition
  1234                                  
  1235                                  	; 07/01/2025
  1236 00000677 BD[340E0000]            	mov	ebp, msgSB16Info ; message
  1237                                  	;mov	cl, 07h ; color 
  1238                                  	;call	sys_gmsg
  1239                                  	;retn
  1240                                  	;;;
  1241                                  
  1242                                  ; --------------------------------------------------------
  1243                                  
  1244                                  	; 30/12/2024 (Video Mode 13h)
  1245                                  	; (write message in VGA/CGA mode)
  1246                                  	; 22/12/2024
  1247                                  	; 21/12/2024
  1248                                  	; (write message in VGA/VESA-VBE mode)
  1249                                  sys_gmsg:
  1250 0000067C 8A4500                  	mov	al, [ebp]
  1251 0000067F 20C0                    	and	al, al
  1252 00000681 7458                    	jz	short sys_gmsg_ok
  1253 00000683 3C20                    	cmp	al, 20h
  1254 00000685 731E                    	jnb	short sys_gmsg_3
  1255 00000687 3C0D                    	cmp	al, 13
  1256 00000689 750C                    	jne	short sys_gmsg_2
  1257                                  	; carriege return, move cursor to column 0
  1258 0000068B 66C705[60120000]00-     	mov	word [screenpos], 0
  1258 00000693 00                 
  1259                                  sys_gmsg_1:
  1260 00000694 45                      	inc	ebp
  1261 00000695 EBE5                    	jmp	short sys_gmsg
  1262                                  sys_gmsg_2:
  1263 00000697 3C0A                    	cmp	al, 10
  1264 00000699 7540                    	jne	short sys_gmsg_ok ; 22/12/2024
  1265                                  	; line feed, move cursor to next row
  1266                                  	;add	word [screenpos+2], 16
  1267                                  	; 30/12/2024
  1268 0000069B 668305[62120000]08      	add	word [screenpos+2], 8
  1269 000006A3 EBEF                    	jmp	short sys_gmsg_1
  1270                                  sys_gmsg_3:
  1271 000006A5 8B35[60120000]          	mov	esi, [screenpos]
  1272                                  		; hw = (cursor) row
  1273                                  		; si = (cursor) column
  1274 000006AB B907000000              	mov	ecx, 07h ; gray (light)
  1275 000006B0 E8F5040000              	call	write_character
  1276 000006B5 83C608                  	add	esi, 8
  1277                                  	;;;
  1278                                  	;cmp	si, 640
  1279                                  	; 30/12/2024 (cgaplay.s)
  1280 000006B8 6681FE4001              	cmp	si, 320
  1281 000006BD 7213                    	jb	short sys_gmsg_5
  1282 000006BF C1EE10                  	shr	esi, 16
  1283                                  	;add	si, 16
  1284                                  	;cmp	si, 480
  1285                                  	; 30/12/2024
  1286 000006C2 6683C608                	add	si, 8
  1287 000006C6 6681FEC800              	cmp	si, 200
  1288 000006CB 7202                    	jb	short sys_gmsg_4
  1289 000006CD 31F6                    	xor	esi, esi
  1290                                  sys_gmsg_4:
  1291 000006CF C1E610                  	shl	esi, 16
  1292                                  	;;;
  1293                                  sys_gmsg_5:
  1294 000006D2 8935[60120000]          	mov	[screenpos], esi
  1295 000006D8 45                      	inc	ebp
  1296 000006D9 EBA1                    	jmp	short sys_gmsg
  1297                                  sys_gmsg_ok:
  1298 000006DB C3                      	retn
  1299                                  	;;;
  1300                                  
  1301                                  ; --------------------------------------------------------
  1302                                  
  1303                                  ; --------------------------------------------------------
  1304                                  ; 16/12/2024 - Sound Blaster 16 initialization & play
  1305                                  ; --------------------------------------------------------
  1306                                  
  1307                                  	; 16/12/2024 - sb16play.s (TRDOS 386)
  1308                                  	; 18/08/2024 - playwav4.s (TRDOS 386)
  1309                                  SB16Init_play:
  1310                                  SB16_play@:
  1311                                  	; 16/12/2024
  1312 000006DC B91F000000              	mov	ecx, 31 ; 1Fh
  1313 000006E1 2A0D[EF090000]          	sub	cl, [volume] ; initial value = 2
  1314                                  			     ; cl = 1Dh (initial)
  1315 000006E7 88CD                    	mov	ch, cl
  1316                                  
  1317                                  	; Set Master Volume Level (BL=0 or 80h)
  1318                                  	; 	for next playing (BL>=80h)
  1319                                  	;;sys	_audio, 0B80h, 1D1Dh
  1320                                  	;sys	_audio, 0B00h, 1D1Dh
  1321                                  	; 16/12/2024
  1322                                  	sys	_audio, 0B00h
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 000006E9 BB000B0000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000006EE B820000000          <1>  mov eax, %1
   103                              <1> 
   104 000006F3 CD40                <1>  int 40h
  1323                                  
  1324                                  	; 16/12/2024
  1325                                  	; Start	to play
  1326 000006F5 A0[9A170000]            	mov	al, [WAVE_BitsPerSample]
  1327 000006FA C0E804                  	shr	al, 4 ; 8 -> 0, 16 -> 1
  1328 000006FD D0E0                    	shl	al, 1 ; 16 -> 2, 8 -> 0
  1329 000006FF 8A1D[8E170000]          	mov	bl, [WAVE_NumChannels]
  1330 00000705 FECB                    	dec	bl
  1331 00000707 08C3                    	or	bl, al
  1332 00000709 668B0D[90170000]         	mov	cx, [WAVE_SampleRate]
  1333 00000710 B704                    	mov	bh, 4 ; start to play
  1334                                  	sys	_audio
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94                              <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 00000712 B820000000          <1>  mov eax, %1
   103                              <1> 
   104 00000717 CD40                <1>  int 40h
  1335                                  
  1336                                  _init_err:
  1337                                  c4ue_ok:
  1338 00000719 C3                      	retn
  1339                                  
  1340                                  ; --------------------------------------------------------
  1341                                  ; 14/11/2024 - Erdogan Tan
  1342                                  ; --------------------------------------------------------
  1343                                  
  1344                                  	; 06/01/2025 (cgaplay2.s)
  1345                                  	; 18/12/2024
  1346                                  	; 16/12/2024 (sb16play.s)
  1347                                  	; 07/12/2024
  1348                                  	; 01/12/2024 (32bit registers)
  1349                                  	; 29/11/2024
  1350                                  checkUpdateEvents:
  1351 0000071A E86D020000              	call	check4keyboardstop
  1352 0000071F 72F8                    	jc	short c4ue_ok
  1353                                  
  1354                                  	; 18/11/2024
  1355 00000721 50                      	push	eax ; *
  1356 00000722 09C0                    	or	eax, eax
  1357 00000724 0F84C6000000            	jz	c4ue_cpt
  1358                                  
  1359                                  	; 18/11/2024
  1360 0000072A 3C20                    	cmp	al, 20h ; SPACE (spacebar) ; pause/play
  1361 0000072C 7540                    	jne	short c4ue_chk_s
  1362 0000072E 803D[71170000]00        	cmp	byte [stopped], 0
  1363 00000735 770A                    	ja	short c4ue_chk_ps
  1364                                  	; 24/11/2024
  1365                                  	; pause
  1366 00000737 E8CFFDFFFF              	call	sb16_pause
  1367 0000073C E9AF000000              	jmp	c4ue_cpt
  1368                                  c4ue_chk_ps:
  1369 00000741 803D[71170000]01        	cmp	byte [stopped], 1
  1370 00000748 770A                    	ja	short c4ue_replay
  1371                                  	; continue to play (after a pause)
  1372 0000074A E8D0FDFFFF              	call	sb16_play	; 24/11/2024
  1373 0000074F E99C000000              	jmp	c4ue_cpt
  1374                                  c4ue_replay:
  1375                                  	; 19/11/2024
  1376 00000754 58                      	pop	eax ; *
  1377 00000755 58                      	pop	eax ; return address
  1378                                  	; 07/02/2024
  1379                                  	;mov	al, [volume]
  1380                                  	;call	SetmasterVolume
  1381 00000756 C605[71170000]00        	mov	byte [stopped], 0
  1382                                  	; 24/11/2024
  1383 0000075D C605[5A120000]01        	mov	byte [half_buffer], 1
  1384 00000764 E833050000              	call	move_to_beginning
  1385 00000769 E932FCFFFF              	jmp	PlayWav
  1386                                  
  1387                                  c4ue_chk_s:
  1388 0000076E 3C53                    	cmp	al, 'S'	; stop
  1389 00000770 7517                    	jne	short c4ue_chk_fb
  1390 00000772 803D[71170000]00        	cmp	byte [stopped], 0
  1391 00000779 7775                    	ja	c4ue_cpt ; Already stopped/paused
  1392 0000077B E877FDFFFF              	call	sb16_stop	; 24/11/2024
  1393                                  	; 19/11/2024
  1394 00000780 C605[72170000]00        	mov	byte [tLO], 0
  1395 00000787 EB67                    	jmp	c4ue_cpt
  1396                                  
  1397                                  c4ue_chk_fb:
  1398                                  	; 17/11/2024
  1399 00000789 3C46                    	cmp	al, 'F'
  1400 0000078B 7507                    	jne	short c4ue_chk_b
  1401 0000078D E8E2040000              	call 	Player_ProcessKey_Forwards
  1402 00000792 EB5C                    	jmp	c4ue_cpt
  1403                                  
  1404                                  c4ue_chk_b:
  1405 00000794 3C42                    	cmp	al, 'B'
  1406                                  	;;jne	short c4ue_cpt
  1407                                  	; 19/11/2024
  1408                                  	;jne	short c4ue_chk_h
  1409                                  	; 25/12/2024
  1410                                  	; 29/11/2024
  1411 00000796 7507                    	jne	short c4ue_chk_n
  1412 00000798 E8D3040000              	call 	Player_ProcessKey_Backwards
  1413 0000079D EB51                    	jmp	short c4ue_cpt
  1414                                  
  1415                                  	;;;
  1416                                  	; 25/12/2024
  1417                                  	; 29/11/2024
  1418                                  c4ue_chk_n:
  1419 0000079F 3C4E                    	cmp	al, 'N'
  1420 000007A1 7404                    	je	short c4ue_nps
  1421                                  c4ue_chk_p:
  1422 000007A3 3C50                    	cmp	al, 'P'
  1423 000007A5 7509                    	jne	short c4ue_chk_h
  1424                                  c4ue_nps:
  1425 000007A7 C605[71170000]03        	mov	byte [stopped], 3
  1426 000007AE EB40                    	jmp	short c4ue_cpt
  1427                                  	;;;
  1428                                  
  1429                                  c4ue_chk_h:
  1430                                  	; 19/11/2024
  1431 000007B0 3C48                    	cmp	al, 'H'
  1432 000007B2 750E                    	jne	short c4ue_chk_cr
  1433 000007B4 C605[73170000]00        	mov	byte [wpoints], 0
  1434                                  	; 20/12/2024
  1435                                  	; 18/12/2024
  1436 000007BB E867FEFFFF              	call 	write_sb16_dev_info
  1437                                  	; 30/12/2024
  1438 000007C0 EB2E                    	jmp	short c4ue_cpt
  1439                                  c4ue_chk_cr:
  1440                                  	;;;
  1441                                  	; 24/12/2024 (wave lighting points option)
  1442                                  	;mov	ah, [wpoints]
  1443                                  	; 30/12/2024
  1444 000007C2 31DB                    	xor	ebx, ebx
  1445 000007C4 8A1D[73170000]          	mov	bl, [wpoints]
  1446 000007CA 3C47                    	cmp	al, 'G'
  1447 000007CC 7406                    	je	short c4ue_g
  1448                                  	; 19/11/2024
  1449 000007CE 3C0D                    	cmp	al, 0Dh ; ENTER/CR key
  1450 000007D0 751E                    	jne	short c4ue_cpt
  1451                                  	; 23/11/2024
  1452                                  	;xor	ebx, ebx
  1453                                  	; 30/12/2024
  1454                                  	;mov	bl, ah ; 24/12/2024
  1455 000007D2 FEC3                    	inc	bl
  1456                                  c4ue_g:	; 30/12/2024
  1457 000007D4 80E307                  	and	bl, 07h
  1458 000007D7 7501                    	jnz	short c4ue_sc
  1459 000007D9 43                      	inc	ebx
  1460                                  c4ue_sc:
  1461 000007DA 881D[73170000]          	mov	[wpoints], bl
  1462                                  	; 30/12/2024
  1463 000007E0 8A83[51120000]          	mov	al, [ebx+colors-1] ; 1 to 7
  1464                                  	; 24/12/2024
  1465 000007E6 A2[59120000]            	mov	[ccolor], al
  1466                                  	; 30/12/2024
  1467 000007EB E8DB040000              	call	clear_window
  1468                                  	;;;
  1469                                  c4ue_cpt:
  1470                                  	; 24/12/2024
  1471                                  	; 18/11/2024
  1472 000007F0 59                      	pop	ecx ; *
  1473                                  	;;;
  1474                                  	; 29/12/2024
  1475                                  	; 24/12/2024 (skip wave lighting if data is not loaded yet)
  1476                                  	;cmp	byte [SRB], 0
  1477                                  	;ja	short c4ue_vb_ok
  1478                                  	;;;
  1479                                  	; 01/12/2024 (TRDOS 386)
  1480                                  	sys	_time, 4 ; get timer ticks (18.2 ticks/second),
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 000007F1 BB04000000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 000007F6 B80D000000          <1>  mov eax, %1
   103                              <1> 
   104 000007FB CD40                <1>  int 40h
  1481                                  	; 24/12/2024
  1482                                  	; 18/11/2024
  1483                                  	;pop	ecx ; *
  1484                                  	; 01/12/2024
  1485 000007FD 3B05[18180000]          	cmp	eax, [timerticks]
  1486                                  	;je	short c4ue_ok
  1487                                  	; 18/11/2024
  1488 00000803 7408                    	je	short c4ue_skip_utt
  1489                                  c4ue_utt:	
  1490                                  	; 01/12/2024
  1491 00000805 A3[18180000]            	mov	[timerticks], eax
  1492 0000080A EB05                    	jmp	short c4ue_cpt_@
  1493                                  
  1494                                  	; 30/12/2024
  1495                                  c4ue_vb_ok:
  1496 0000080C C3                      	retn
  1497                                  
  1498                                  c4ue_skip_utt:
  1499                                  	; 18/11/2024
  1500 0000080D 21C9                    	and	ecx, ecx
  1501 0000080F 74FB                    	jz	short c4ue_vb_ok
  1502                                  c4ue_cpt_@:
  1503                                  	; 18/11/2024
  1504 00000811 803D[71170000]00        	cmp	byte [stopped], 0
  1505 00000818 77F2                    	ja	short c4ue_vb_ok
  1506                                  	
  1507 0000081A E89F020000              	call	CalcProgressTime
  1508                                  
  1509                                  	;cmp	ax, [ProgressTime]
  1510                                  	; 01/12/2024
  1511 0000081F 3B05[0C180000]          	cmp	eax, [ProgressTime]
  1512                                  	;je	short c4ue_vb_ok
  1513                                  			; same second, no need to update
  1514                                  	; 23/11/2024
  1515 00000825 7405                    	je	short c4ue_uvb
  1516                                  
  1517                                  	;call	UpdateProgressTime
  1518                                  	;call	UpdateProgressBar@
  1519 00000827 E8B8030000              	call	UpdateProgressBar
  1520                                  
  1521                                  	; 23/11/2024
  1522                                  c4ue_uvb:
  1523 0000082C 803D[73170000]00        	cmp	byte [wpoints], 0
  1524 00000833 76D7                    	jna	short c4ue_vb_ok
  1525                                  
  1526                                  	; 30/12/2024
  1527                                  	;call	UpdateWavePoints
  1528                                  	;retn
  1529                                  
  1530                                  	; 08/01/2025
  1531 00000835 FF15[1C180000]          	call	dword [UpdateWavePoints]
  1532 0000083B C3                      	retn	
  1533                                  
  1534                                  ; --------------------------------------------------------
  1535                                  ; 27/12/2024 - Erdogan Tan
  1536                                  ; --------------------------------------------------------
  1537                                  
  1538                                  	; 08/01/2025
  1539                                  	; 06/01/2025 (cgaplay2.s) -SB16- (32bit regs)
  1540                                  	; 02/01/2025 (cgaplay2.asm) -SB16-
  1541                                  	; 01/01/2025 (cgaplay.asm, 16bit registers)
  1542                                  	; 30/12/2024 (cgaplay.s) -AC97-
  1543                                  	;  * 320*200 pixels, 256 colors
  1544                                  	;  * 64 volume levels
  1545                                  	; 29/12/2024
  1546                                  	; 27/12/2024 (DMA Buffer Tracking)
  1547                                  	; 26/12/2024
  1548                                  	; 24/12/2024
  1549                                  ;UpdateWavePoints:
  1550                                  	; 06/01/2025
  1551                                  UpdateWavePoints_16s:
  1552                                  	; 08/01/2025
  1553 0000083C E833010000              	call	get_current_sounddata
  1554                                  	;
  1555 00000841 BE[6C120000]            	mov	esi, prev_points
  1556 00000846 833E00                  	cmp	dword [esi], 0
  1557 00000849 740B                    	jz	short lights_off_ok
  1558                                  	;mov	ecx, 640
  1559                                  	; 30/12/2024
  1560 0000084B B940010000              	mov	ecx, 320
  1561                                  light_off:
  1562 00000850 AD                      	lodsd
  1563                                  	; eax = wave point (lighting point) address
  1564 00000851 C60000                  	mov	byte [eax], 0 ; black point (light off)
  1565 00000854 E2FA                    	loop	light_off	
  1566                                  
  1567                                  lights_off_ok:
  1568                                  
  1569                                  ; 08/01/2025
  1570                                  %if 0
  1571                                  	; 29/12/2024
  1572                                  	cmp	byte [tLO],'2'
  1573                                  	jne	short lights_on_buff_1
  1574                                  lights_on_buff_2:
  1575                                  	; 06/01/2025
  1576                                  	mov	edx, wav_buffer2
  1577                                  	jmp	short lights_on
  1578                                  lights_on_buff_1:
  1579                                  	; 06/01/2025
  1580                                  	mov	edx, wav_buffer1
  1581                                  lights_on:
  1582                                  	cmp	[pbuf_s], edx
  1583                                  	jne	short lights_on_2
  1584                                  	mov	ebx, [wpoints_dif]
  1585                                  	mov	esi, [pbuf_o]
  1586                                  	;mov	ecx, [buffersize] ; bytes
  1587                                  	; 06/01/2025
  1588                                  	mov	ecx, BUFFERSIZE
  1589                                  	sub	ecx, ebx ; sub ecx, [wpoints_dif]
  1590                                  	add	esi, ebx
  1591                                  	jc	short lights_on_1
  1592                                  	cmp	esi, ecx
  1593                                  	jna	short lights_on_3
  1594                                  lights_on_1:
  1595                                  	mov	esi, ecx
  1596                                  	jmp	short lights_on_3
  1597                                  
  1598                                  lights_on_2:
  1599                                  	; 29/12/2024
  1600                                  	mov	[pbuf_s], edx
  1601                                  	xor	esi, esi ; 0
  1602                                  lights_on_3:
  1603                                  	mov	[pbuf_o], esi
  1604                                  	; 29/12/2024
  1605                                  	;add	esi, [pbuf_s]
  1606                                  	add	esi, edx
  1607                                  %else
  1608                                  	; 08/01/2025
  1609 00000856 BE[24180000]            	mov	esi, sounddata
  1610                                  %endif
  1611                                  	;mov	ecx, 640
  1612                                  	; 30/12/2024
  1613 0000085B B940010000              	mov	ecx, 320
  1614 00000860 89CD                    	mov	ebp, ecx
  1615                                  	; 26/12/2024
  1616 00000862 BF[6C120000]            	mov	edi, prev_points
  1617                                  	;mov	ebx, [graphstart] ; start (top) line
  1618                                  	; 06/01/2025
  1619 00000867 BB00730A00              	mov	ebx, 0A0000h+(11*8*320)+(4*320)
  1620                                  lights_on_4:
  1621 0000086C 31C0                    	xor	eax, eax ; 0
  1622 0000086E 66AD                    	lodsw	; left
  1623 00000870 80C480                  	add	ah, 80h
  1624 00000873 89C2                    	mov	edx, eax
  1625 00000875 66AD                    	lodsw	; right
  1626                                  	;add	ax, dx
  1627 00000877 80C480                  	add	ah, 80h
  1628                                  	;;shr	eax, 9	; 128 volume levels
  1629                                  	; 01/01/2025
  1630 0000087A 01D0                    	add	eax, edx
  1631                                  	;;shr	eax, 10	; (L+R/2) & 128 volume levels
  1632                                  	;shr	eax, 9	; (L+R/2) & 256 volume levels
  1633                                  	; 30/12/2024
  1634 0000087C C1E80B                  	shr	eax, 11	; (L+R/2) & 64 volume levels
  1635                                  	; * 320 row  ; 30/12/2024
  1636 0000087F F7E5                    	mul	ebp	; * 640 (row) 
  1637 00000881 01D8                    	add	eax, ebx ; + column
  1638 00000883 8A15[59120000]          	mov	dl, [ccolor]
  1639 00000889 8810                    	mov	[eax], dl ; pixel (light on) color
  1640 0000088B AB                      	stosd		; save light on addr in prev_points
  1641 0000088C 43                      	inc	ebx
  1642 0000088D E2DD                    	loop	lights_on_4
  1643 0000088F C3                      	retn
  1644                                  
  1645                                  ; -------------------------
  1646                                  
  1647                                  	; 08/01/2025
  1648                                  	; 06/01/2025 (cgaplay2.s, SB16, TRDOS386)
  1649                                  	; 02/01/2025 (cgaplay2.asm, SB16, RetroDOS)
  1650                                  	; 01/01/2025 (cgaplay.asm, AC97, RetroDOS)
  1651                                  	; 30/12/2024 (cgaplay.s, AC97, TRDOS386)
  1652                                  	;  * 320*200 pixels, 256 colors
  1653                                  	;  * 64 volume levels
  1654                                  UpdateWavePoints_16m:
  1655                                  	; 08/01/2025
  1656 00000890 E8DF000000              	call	get_current_sounddata
  1657                                  	;
  1658 00000895 BE[6C120000]            	mov	esi, prev_points
  1659 0000089A 833E00                  	cmp	dword [esi], 0
  1660 0000089D 740B                    	jz	short lights_off_16m_ok
  1661                                  	;mov	ecx, 640
  1662                                  	; 30/12/2024
  1663 0000089F B940010000              	mov	ecx, 320
  1664                                  light_16m_off:
  1665 000008A4 AD                      	lodsd
  1666                                  	; eax = wave point (lighting point) address
  1667 000008A5 C60000                  	mov	byte [eax], 0 ; black point (light off)
  1668 000008A8 E2FA                    	loop	light_16m_off
  1669                                  
  1670                                  lights_off_16m_ok:
  1671                                  
  1672                                  ; 08/01/2025
  1673                                  %if 0
  1674                                  	; 29/12/2024
  1675                                  	cmp	byte [tLO],'2'
  1676                                  	jne	short lights_16m_on_buff_1
  1677                                  lights_16m_on_buff_2:
  1678                                  	; 06/01/2025
  1679                                  	mov	edx, wav_buffer2
  1680                                  	jmp	short lights_16m_on
  1681                                  lights_16m_on_buff_1:
  1682                                  	; 06/01/2025
  1683                                  	mov	edx, wav_buffer1
  1684                                  lights_16m_on:
  1685                                  	cmp	[pbuf_s], edx
  1686                                  	jne	short lights_16m_on_2
  1687                                  	mov	ebx, [wpoints_dif]
  1688                                  	mov	esi, [pbuf_o]
  1689                                  	; 06/01/2025
  1690                                  	mov	ecx, BUFFERSIZE
  1691                                  	sub	ecx, ebx ; sub ecx, [wpoints_dif]
  1692                                  	add	esi, ebx
  1693                                  	jc	short lights_16m_on_1
  1694                                  	cmp	esi, ecx
  1695                                  	jna	short lights_16m_on_3
  1696                                  lights_16m_on_1:
  1697                                  	mov	esi, ecx
  1698                                  	jmp	short lights_16m_on_3
  1699                                  
  1700                                  lights_16m_on_2:
  1701                                  	; 06/01/2025
  1702                                  	mov	[pbuf_s], edx
  1703                                  	xor	esi, esi ; 0
  1704                                  lights_16m_on_3:
  1705                                  	mov	[pbuf_o], esi
  1706                                  	; 29/12/2024
  1707                                  	;add	esi, [pbuf_s]
  1708                                  	add	esi, edx
  1709                                  %else
  1710                                  	; 08/01/2025
  1711 000008AA BE[24180000]            	mov	esi, sounddata
  1712                                  %endif
  1713                                  	;mov	ecx, 640
  1714                                  	; 30/12/2024
  1715 000008AF B940010000              	mov	ecx, 320
  1716 000008B4 89CD                    	mov	ebp, ecx
  1717                                  	; 26/12/2024
  1718 000008B6 BF[6C120000]            	mov	edi, prev_points
  1719                                  	; 06/01/2025
  1720 000008BB BB00730A00              	mov	ebx, 0A0000h+(11*8*320)+(4*320)
  1721                                  lights_16m_on_4:
  1722                                  	; 06/01/2025
  1723                                  	; 02/01/2025 (16bit mono play modifications)
  1724 000008C0 31C0                    	xor	eax, eax ; 0
  1725 000008C2 66AD                    	lodsw
  1726 000008C4 80C480                  	add	ah, 80h
  1727                                  	; 06/01/2025
  1728 000008C7 C1E80A                  	shr	eax, 10	; 64 volume levels
  1729                                  	; * 320 row  ; 30/12/2024
  1730 000008CA F7E5                    	mul	ebp	; * 640 (row) 
  1731 000008CC 01D8                    	add	eax, ebx ; + column
  1732 000008CE 8A15[59120000]          	mov	dl, [ccolor]
  1733 000008D4 8810                    	mov	[eax], dl ; pixel (light on) color
  1734 000008D6 AB                      	stosd		; save light on addr in prev_points
  1735 000008D7 43                      	inc	ebx
  1736 000008D8 E2E6                    	loop	lights_16m_on_4
  1737 000008DA C3                      	retn
  1738                                  
  1739                                  ; -------------------------
  1740                                  
  1741                                  	; 06/01/2025
  1742                                  	; 02/01/2025
  1743                                  UpdateWavePoints_8s:
  1744                                  	; 08/01/2025
  1745 000008DB E894000000              	call	get_current_sounddata
  1746                                  	;
  1747 000008E0 BE[6C120000]            	mov	esi, prev_points
  1748 000008E5 833E00                  	cmp	dword [esi], 0
  1749 000008E8 740B                    	jz	short lights_off_8s_ok
  1750                                  	;mov	ecx, 640
  1751                                  	; 30/12/2024
  1752 000008EA B940010000              	mov	ecx, 320
  1753                                  light_8s_off:
  1754 000008EF AD                      	lodsd
  1755                                  	; eax = wave point (lighting point) address
  1756 000008F0 C60000                  	mov	byte [eax], 0 ; black point (light off)
  1757 000008F3 E2FA                    	loop	light_8s_off
  1758                                  
  1759                                  lights_off_8s_ok:
  1760                                  
  1761                                  ; 08/01/2025
  1762                                  %if 0
  1763                                  	; 29/12/2024
  1764                                  	cmp	byte [tLO],'2'
  1765                                  	jne	short lights_8s_on_buff_1
  1766                                  lights_8s_on_buff_2:
  1767                                  	; 06/01/2025
  1768                                  	mov	edx, wav_buffer2
  1769                                  	jmp	short lights_8s_on
  1770                                  lights_8s_on_buff_1:
  1771                                  	; 06/01/2025
  1772                                  	mov	edx, wav_buffer1
  1773                                  lights_8s_on:
  1774                                  	cmp	[pbuf_s], edx
  1775                                  	jne	short lights_8s_on_2
  1776                                  	mov	ebx, [wpoints_dif]
  1777                                  	mov	esi, [pbuf_o]
  1778                                  	; 06/01/2025
  1779                                  	mov	ecx, BUFFERSIZE
  1780                                  	sub	ecx, ebx ; sub ecx, [wpoints_dif]
  1781                                  	add	esi, ebx
  1782                                  	jc	short lights_8s_on_1
  1783                                  	cmp	esi, ecx
  1784                                  	jna	short lights_8s_on_3
  1785                                  lights_8s_on_1:
  1786                                  	mov	esi, ecx
  1787                                  	jmp	short lights_8s_on_3
  1788                                  
  1789                                  lights_8s_on_2:
  1790                                  	; 06/01/2025
  1791                                  	mov	[pbuf_s], edx
  1792                                  	xor	esi, esi ; 0
  1793                                  lights_8s_on_3:
  1794                                  	mov	[pbuf_o], esi
  1795                                  	; 29/12/2024
  1796                                  	;add	esi, [pbuf_s]
  1797                                  	add	esi, edx
  1798                                  %else
  1799                                  	; 08/01/2025
  1800 000008F5 BE[24180000]            	mov	esi, sounddata
  1801                                  %endif
  1802                                  	;mov	ecx, 640
  1803                                  	; 30/12/2024
  1804 000008FA B940010000              	mov	ecx, 320
  1805 000008FF 89CD                    	mov	ebp, ecx
  1806                                  	; 26/12/2024
  1807 00000901 BF[6C120000]            	mov	edi, prev_points
  1808                                  	; 06/01/2025
  1809 00000906 BB00730A00              	mov	ebx, 0A0000h+(11*8*320)+(4*320)
  1810                                  lights_8s_on_4:
  1811                                  	; 06/01/2025
  1812                                  	; 02/01/2025 (8bit stereo play modifications)
  1813 0000090B 31C0                    	xor	eax, eax ; 0
  1814 0000090D AC                      	lodsb	; left
  1815 0000090E 89C2                    	mov	edx, eax
  1816 00000910 AC                      	lodsb	; right
  1817 00000911 01D0                    	add	eax, edx
  1818 00000913 D1E8                    	shr	eax, 1 ; (L+R/2)
  1819 00000915 2CFF                    	sub	al, 255	; max. value will be shown on top
  1820 00000917 C1E802                  	shr	eax, 2	; 64 volume levels
  1821                                  	; * 320 row  ; 30/12/2024
  1822 0000091A F7E5                    	mul	ebp	; * 640 (row) 
  1823 0000091C 01D8                    	add	eax, ebx ; + column
  1824 0000091E 8A15[59120000]          	mov	dl, [ccolor]
  1825 00000924 8810                    	mov	[eax], dl ; pixel (light on) color
  1826 00000926 AB                      	stosd		; save light on addr in prev_points
  1827 00000927 43                      	inc	ebx
  1828 00000928 E2E1                    	loop	lights_8s_on_4
  1829 0000092A C3                      	retn
  1830                                  
  1831                                  ; -------------------------
  1832                                  
  1833                                  	; 06/01/2025
  1834                                  	; 02/01/2025
  1835                                  UpdateWavePoints_8m:
  1836                                  	; 08/01/2025
  1837 0000092B E844000000              	call	get_current_sounddata
  1838                                  	;
  1839 00000930 BE[6C120000]            	mov	esi, prev_points
  1840 00000935 833E00                  	cmp	dword [esi], 0
  1841 00000938 740B                    	jz	short lights_off_8m_ok
  1842                                  	;mov	ecx, 640
  1843                                  	; 30/12/2024
  1844 0000093A B940010000              	mov	ecx, 320
  1845                                  light_8m_off:
  1846 0000093F AD                      	lodsd
  1847                                  	; eax = wave point (lighting point) address
  1848 00000940 C60000                  	mov	byte [eax], 0 ; black point (light off)
  1849 00000943 E2FA                    	loop	light_8m_off
  1850                                  
  1851                                  lights_off_8m_ok:
  1852                                  
  1853                                  ; 08/01/2025
  1854                                  %if 0
  1855                                  	; 29/12/2024
  1856                                  	cmp	byte [tLO],'2'
  1857                                  	jne	short lights_8m_on_buff_1
  1858                                  lights_8m_on_buff_2:
  1859                                  	; 06/01/2025
  1860                                  	mov	edx, wav_buffer2
  1861                                  	jmp	short lights_8m_on
  1862                                  lights_8m_on_buff_1:
  1863                                  	; 06/01/2025
  1864                                  	mov	edx, wav_buffer1
  1865                                  lights_8m_on:
  1866                                  	cmp	[pbuf_s], edx
  1867                                  	jne	short lights_8m_on_2
  1868                                  	mov	ebx, [wpoints_dif]
  1869                                  	mov	esi, [pbuf_o]
  1870                                  	; 06/01/2025
  1871                                  	mov	ecx, BUFFERSIZE
  1872                                  	sub	ecx, ebx ; sub ecx, [wpoints_dif]
  1873                                  	add	esi, ebx
  1874                                  	jc	short lights_8m_on_1
  1875                                  	cmp	esi, ecx
  1876                                  	jna	short lights_8m_on_3
  1877                                  lights_8m_on_1:
  1878                                  	mov	esi, ecx
  1879                                  	jmp	short lights_8m_on_3
  1880                                  
  1881                                  lights_8m_on_2:
  1882                                  	; 06/01/2025
  1883                                  	mov	[pbuf_s], edx
  1884                                  	xor	esi, esi ; 0
  1885                                  lights_8m_on_3:
  1886                                  	mov	[pbuf_o], esi
  1887                                  	; 29/12/2024
  1888                                  	;add	esi, [pbuf_s]
  1889                                  	add	esi, edx
  1890                                  %else
  1891                                  	; 08/01/2025
  1892 00000945 BE[24180000]            	mov	esi, sounddata
  1893                                  %endif
  1894                                  	;mov	ecx, 640
  1895                                  	; 30/12/2024
  1896 0000094A B940010000              	mov	ecx, 320
  1897 0000094F 89CD                    	mov	ebp, ecx
  1898                                  	; 26/12/2024
  1899 00000951 BF[6C120000]            	mov	edi, prev_points
  1900                                  	; 06/01/2025
  1901 00000956 BB00730A00              	mov	ebx, 0A0000h+(11*8*320)+(4*320)
  1902                                  lights_8m_on_4:
  1903                                  	; 06/01/2025
  1904                                  	; 02/01/2025 (16bit mono play modifications)
  1905 0000095B 31C0                    	xor	eax, eax ; 0
  1906 0000095D AC                      	lodsb
  1907 0000095E 2CFF                    	sub	al, 255	; max. value will be shown on top
  1908 00000960 C1E802                  	shr	eax, 2	; 64 volume levels
  1909                                  	; * 320 row  ; 30/12/2024
  1910 00000963 F7E5                    	mul	ebp	; * 640 (row) 
  1911 00000965 01D8                    	add	eax, ebx ; + column
  1912 00000967 8A15[59120000]          	mov	dl, [ccolor]
  1913 0000096D 8810                    	mov	[eax], dl ; pixel (light on) color
  1914 0000096F AB                      	stosd		; save light on addr in prev_points
  1915 00000970 43                      	inc	ebx
  1916 00000971 E2E8                    	loop	lights_8m_on_4
  1917 00000973 C3                      	retn
  1918                                  
  1919                                  ; --------------------------------------------------------
  1920                                  ; 08/01/2025 - Get Current Sound Data For Graphics
  1921                                  ; --------------------------------------------------------
  1922                                  
  1923                                  	; 08/01/2025
  1924                                  get_current_sounddata:
  1925                                  	sys	_audio,	0F00h, [sd_count], sounddata
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000974 BB000F0000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 00000979 8B0D[5C120000]      <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98 0000097F BA[24180000]        <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 00000984 B820000000          <1>  mov eax, %1
   103                              <1> 
   104 00000989 CD40                <1>  int 40h
  1926 0000098B C3                      	retn
  1927                                  
  1928                                  ; --------------------------------------------------------
  1929                                  ; 19/05/2024 - (playwav4.asm) ich_wav4.asm
  1930                                  ; --------------------------------------------------------
  1931                                  
  1932                                  	; 06/01/2025
  1933                                  	; 29/12/2024
  1934                                  	; 25/12/2024
  1935                                  	; 07/12/2024
  1936                                  	; 01/12/2024 (TRDOS 386)
  1937                                  	; 29/11/2024
  1938                                  check4keyboardstop:
  1939                                  	; 19/05/2024
  1940                                  	; 08/11/2023
  1941                                  	; 04/11/2023
  1942 0000098C B401                    	mov	ah, 1
  1943                                  	;int	16h
  1944                                  	; 01/12/2024 (TRDOS 386 keyboard interrupt)
  1945 0000098E CD32                    	int	32h
  1946                                  	;clc
  1947 00000990 7433                    	jz	short _cksr
  1948                                  
  1949 00000992 30E4                    	xor	ah, ah
  1950                                  	;int	16h
  1951                                  	; 01/12/2024 (TRDOS 386 keyboard interrupt)
  1952 00000994 CD32                    	int	32h
  1953                                  
  1954                                  	; 25/12/2024
  1955                                  	; 29/11/2024
  1956                                  	;mov	[command], al
  1957                                  
  1958                                  	;;;
  1959                                  	; 19/05/2024 (change PCM out volume)
  1960 00000996 3C2B                    	cmp	al, '+'
  1961 00000998 750D                    	jne	short p_1
  1962                                  	
  1963 0000099A A0[EF090000]            	mov	al, [volume]
  1964 0000099F 3C00                    	cmp	al, 0
  1965 000009A1 7624                    	jna	short p_3
  1966 000009A3 FEC8                    	dec	al
  1967 000009A5 EB0F                    	jmp	short p_2
  1968                                  p_1:
  1969 000009A7 3C2D                    	cmp	al, '-'
  1970 000009A9 751D                    	jne	short p_4
  1971                                  
  1972 000009AB A0[EF090000]            	mov	al, [volume]
  1973 000009B0 3C1F                    	cmp	al, 31
  1974 000009B2 7313                    	jnb	short p_3
  1975 000009B4 FEC0                    	inc	al
  1976                                  p_2:
  1977 000009B6 A2[EF090000]            	mov	[volume], al
  1978                                  	; 14/11/2024
  1979                                  	;call	SetPCMOutVolume
  1980                                  	; 16/12/2024 (TRDOS 386, SB16)
  1981                                  	; 15/11/2024 (QEMU)
  1982                                  	;call	SetMasterVolume
  1983                                  	; 18/12/2024
  1984 000009BB E815FBFFFF              	call	SetMasterVolume@
  1985                                  	;call	UpdateVolume
  1986                                  	;;clc
  1987                                  	;retn
  1988 000009C0 E99A010000              	jmp	UpdateVolume
  1989                                  _cksr:		; 19/05/2024
  1990                                  	; 18/12/2024
  1991 000009C5 31C0                    	xor	eax, eax
  1992                                  	;clc
  1993                                  p_3:
  1994 000009C7 C3                      	retn
  1995                                  p_4:
  1996                                  	; 17/11/2024
  1997 000009C8 80FC01                  	cmp	ah, 01h  ; ESC
  1998 000009CB 7419                        	je	short p_q
  1999                                  	;cmp	ax, 2E03h ; 21/12/2024 
  2000 000009CD 3C03                    	cmp	al, 03h  ; CTRL+C
  2001 000009CF 7415                    	je	short p_q
  2002                                  
  2003                                  	; 18/11/2024
  2004 000009D1 3C20                    	cmp	al, 20h
  2005 000009D3 7419                    	je	short p_r
  2006                                  
  2007                                  	; 19/11/2024
  2008 000009D5 3C0D                    	cmp	al, 0Dh ; CR/ENTER
  2009 000009D7 7415                    	je	short p_r
  2010                                  
  2011 000009D9 24DF                    	and	al, 0DFh
  2012                                  
  2013                                  	; 25/12/2024
  2014                                  	; 29/11/2024
  2015 000009DB A2[74170000]            	mov	[command], al
  2016                                  
  2017                                  	;cmp	al, 'B'
  2018                                  	;je	short p_r
  2019                                  	;cmp	al, 'F'
  2020                                  	;je	short p_r
  2021                                  
  2022                                  	; 29/11/2024
  2023                                  	;cmp	al, 'N'
  2024                                  	;je	short p_r
  2025                                  	;cmp	al, 'P'
  2026                                  	;je	short p_r
  2027                                  
  2028 000009E0 3C51                    	cmp	al, 'Q'
  2029                                  	;je	short p_q
  2030 000009E2 7409                    	je	short p_quit ; 29/11/2024
  2031                                  
  2032 000009E4 F8                      	clc
  2033 000009E5 C3                      	retn
  2034                                  
  2035                                  	;;;
  2036                                  ;_cskr:	
  2037                                  p_q:
  2038                                  	; 27/12/2024
  2039 000009E6 C605[74170000]51        	mov	byte [command], 'Q'
  2040                                  p_quit:
  2041 000009ED F9                      	stc
  2042                                  p_r:
  2043 000009EE C3                      	retn
  2044                                  
  2045                                  ; 29/05/2024
  2046                                  ; 19/05/2024
  2047                                  volume: 
  2048                                  	;db	02h
  2049                                  ; 26/12/2024
  2050 000009EF 03                      	db	03h
  2051                                  
  2052                                  ; --------------------------------------------------------
  2053                                  
  2054                                  	; 30/12/2024
  2055                                  	; simulate cursor position in VGA mode 13h
  2056                                  	; ! for 320*200, 256 colors (1 byte/pixel) !
  2057                                  setCursorPosition:
  2058                                  	; dh = Row
  2059                                  	; dl = Column
  2060                                  	
  2061 000009F0 31C0                    	xor	eax, eax
  2062                                  	; row height is 8 pixels (8*8)
  2063 000009F2 88F0                    	mov	al, dh
  2064 000009F4 C1E003                  	shl	eax, 3
  2065 000009F7 6683C002                	add	ax, 2	; top margin
  2066 000009FB C1E010                  	shl	eax, 16
  2067 000009FE 88D0                    	mov	al, dl	; * 8 ; character width = 8 pixels
  2068 00000A00 66C1E003                	shl	ax, 3
  2069                                  			; hw = row, ax = column
  2070 00000A04 A3[60120000]            	mov	[screenpos], eax
  2071                                  	; 22/12/2024
  2072 00000A09 31C0                    	xor	eax, eax
  2073 00000A0B C3                      	retn
  2074                                  	
  2075                                  ; --------------------------------------------------------
  2076                                  ; 14/11/2024
  2077                                  ; (Ref: player.asm, out_cs.asm, Matan Alfasi, 2017)
  2078                                  
  2079                                  ;; NAME:	SetTotalTime
  2080                                  ;; DESCRIPTION: Calculates the total time in seconds in file
  2081                                  ;; INPUT:	DATA_SubchunkSize, WAVE_SampleRate, WAVE_BlockAlign
  2082                                  ;; OUTPUT:	CurrentTotalTime=Total time in seconds in file,
  2083                                  ;; 		Output on the screen of the total time in seconds
  2084                                  
  2085                                  	; 01/12/2024 (32 bit registers)
  2086                                  SetTotalTime:
  2087                                  	;; Calculate total seconds in file
  2088                                  	;mov	ax, [DATA_SubchunkSize]
  2089                                  	;mov	dx, [DATA_SubchunkSize + 2]
  2090                                  	;mov	bx, [WAVE_SampleRate]
  2091                                  	;div	bx
  2092                                  	;xor	dx, dx
  2093                                  	; 01/12/2024
  2094 00000A0C A1[A0170000]            	mov	eax, [DATA_SubchunkSize]
  2095 00000A11 0FB71D[90170000]        	movzx	ebx, word [WAVE_SampleRate]
  2096 00000A18 31D2                    	xor	edx, edx
  2097 00000A1A F7F3                    	div	ebx
  2098                                  
  2099                                  	;mov	bx, [WAVE_BlockAlign]
  2100                                  	;div	bx
  2101                                  	; 01/12/2024
  2102 00000A1C 668B1D[98170000]        	mov	bx, [WAVE_BlockAlign]
  2103 00000A23 31D2                    	xor	edx, edx
  2104 00000A25 F7F3                    	div	ebx
  2105                                  
  2106                                  	;mov	[TotalTime], ax
  2107 00000A27 A3[08180000]            	mov	[TotalTime], eax
  2108                                  
  2109 00000A2C B33C                    	mov	bl, 60
  2110 00000A2E F6F3                    	div	bl
  2111                                  
  2112                                  	;; al = minutes, ah = seconds
  2113 00000A30 50                      	push	eax ; **
  2114 00000A31 50                      	push	eax ; *
  2115                                  
  2116                                  	;mov	dh, 24
  2117                                  	; 21/12/2024 (640*480)
  2118                                  	;mov	dh, 32
  2119                                  	;mov	dl, 42
  2120                                  	; 30/12/2024 (320*200)
  2121 00000A32 B617                    	mov	dh, 23
  2122 00000A34 B216                    	mov	dl, 22
  2123 00000A36 E8B5FFFFFF              	call	setCursorPosition
  2124                                  
  2125 00000A3B 58                      	pop	eax ; *
  2126 00000A3C 30E4                    	xor	ah, ah
  2127 00000A3E BD02000000              	mov	ebp, 2
  2128 00000A43 E812000000              	call	PrintNumber
  2129                                  	
  2130                                  	;mov	dh, 24
  2131                                  	; 21/12/2024 (640*480)
  2132                                  	;mov	dh, 32
  2133                                  	;mov	dl, 45
  2134                                  	; 30/12/2024 (320*200)
  2135 00000A48 B617                    	mov	dh, 23
  2136 00000A4A B219                    	mov	dl, 25
  2137 00000A4C E89FFFFFFF              	call	setCursorPosition
  2138                                  
  2139 00000A51 58                      	pop	eax ; **
  2140 00000A52 88E0                    	mov	al, ah
  2141 00000A54 30E4                    	xor	ah, ah
  2142                                  	; 21/12/2024
  2143 00000A56 66BD0200                	mov	bp, 2
  2144                                  	;jmp	short PrintNumber
  2145                                  
  2146                                  ; --------------------------------------------------------
  2147                                  
  2148                                  	; 21/12/2024 (write numbers in VESA VBE graphics mode)
  2149                                  	; 01/12/2024 (32bit registers)
  2150                                  PrintNumber:
  2151                                  	; eax = binary number
  2152                                  	; ebp = digits
  2153 00000A5A 8B35[60120000]          	mov	esi, [screenpos]
  2154                                  		; hw = row, si = column
  2155 00000A60 BB0A000000              	mov	ebx, 10
  2156 00000A65 31C9                    	xor	ecx, ecx
  2157                                  printNumber_CutNumber:
  2158 00000A67 41                      	inc	ecx
  2159 00000A68 31D2                    	xor	edx, edx
  2160 00000A6A F7F3                    	div	ebx
  2161 00000A6C 52                      	push	edx
  2162 00000A6D 39E9                    	cmp	ecx, ebp
  2163 00000A6F 7402                    	je	short printNumber_printloop
  2164 00000A71 EBF4                    	jmp	printNumber_CutNumber
  2165                                  
  2166                                  printNumber_printloop:
  2167 00000A73 58                      	pop	eax
  2168                                  	; 21/12/2024
  2169                                  	; ebp = count of digits
  2170                                  	; eax <= 9
  2171                                  
  2172 00000A74 0430                    	add	al, '0'
  2173                                  	
  2174                                  	; esi = pixel position (hw = row, si = column)
  2175                                  	; eax = al = character
  2176                                  	;call	write_character
  2177                                  	; 22/12/2024
  2178 00000A76 E82A010000              	call	write_character_white
  2179                                  
  2180 00000A7B 4D                      	dec	ebp
  2181 00000A7C 7405                     	jz	short printNumber_ok
  2182 00000A7E 83C608                  	add	esi, 8	; next column
  2183 00000A81 EBF0                    	jmp	short printNumber_printloop
  2184                                  printNumber_ok:
  2185 00000A83 C3                      	retn
  2186                                  
  2187                                  ; --------------------------------------------------------
  2188                                  
  2189                                  	; 14/11/2024 - Erdogan Tan
  2190                                  SetProgressTime:
  2191                                  	;; Calculate playing/progress seconds in file
  2192 00000A84 E835000000              	call	CalcProgressTime
  2193                                  
  2194                                  	; 01/12/2024 (32bit registers)
  2195                                  UpdateProgressTime:
  2196                                  	; eax = (new) progress time 
  2197                                  
  2198 00000A89 A3[0C180000]            	mov	[ProgressTime], eax
  2199                                  
  2200 00000A8E B33C                    	mov	bl, 60
  2201 00000A90 F6F3                    	div	bl
  2202                                  
  2203                                  	;; al = minutes, ah = seconds
  2204 00000A92 50                      	push	eax ; **
  2205 00000A93 50                      	push	eax ; *
  2206                                  
  2207                                  	;mov	dh, 24
  2208                                  	; 21/12/2024 (640*480)
  2209                                  	;mov	dh, 32
  2210                                  	;mov	dl, 33
  2211                                  	; 30/12/2024 (320*200)
  2212 00000A94 B617                    	mov	dh, 23
  2213 00000A96 B20D                    	mov	dl, 13
  2214 00000A98 E853FFFFFF              	call	setCursorPosition
  2215                                  
  2216 00000A9D 58                      	pop	eax ; *
  2217 00000A9E 30E4                    	xor	ah, ah
  2218 00000AA0 BD02000000              	mov	ebp, 2
  2219 00000AA5 E8B0FFFFFF              	call	PrintNumber
  2220                                  	
  2221                                  	;mov	dh, 24
  2222                                  	; 21/12/2024 (640*480)
  2223                                  	;mov	dh, 32
  2224                                  	;mov	dl, 36
  2225                                  	; 30/12/2024 (320*200)
  2226 00000AAA B617                    	mov	dh, 23
  2227 00000AAC B210                    	mov	dl, 16
  2228 00000AAE E83DFFFFFF              	call	setCursorPosition
  2229                                  
  2230 00000AB3 58                      	pop	eax ; **
  2231 00000AB4 88E0                    	mov	al, ah
  2232 00000AB6 30E4                    	xor	ah, ah
  2233                                  	; 21/12/2024
  2234 00000AB8 66BD0200                	mov	bp, 2
  2235 00000ABC EB9C                    	jmp	short PrintNumber
  2236                                  
  2237                                  ; --------------------------------------------------------
  2238                                  
  2239                                  	; 01/12/2024 (32bit registers)
  2240                                  	; 17/11/2024
  2241                                  	; 14/11/2024
  2242                                  CalcProgressTime:
  2243                                  	;mov	ax, [LoadedDataBytes]
  2244                                  	;mov	dx, [LoadedDataBytes+2]
  2245                                  	;mov	bx, ax
  2246                                  	;or	bx, dx
  2247                                  	;jz	short cpt_ok
  2248                                  	; 01/12/2024
  2249 00000ABE A1[14180000]            	mov	eax, [LoadedDataBytes]
  2250 00000AC3 09C0                    	or	eax, eax
  2251 00000AC5 7416                    	jz	short cpt_ok
  2252                                  
  2253                                  	;mov	bx, [WAVE_SampleRate]
  2254                                  	;div	bx
  2255                                  	;xor	dx, dx
  2256                                  	;mov	bx, [WAVE_BlockAlign]
  2257                                  	;div	bx
  2258                                  	; 01/12/2024
  2259 00000AC7 0FB71D[90170000]        	movzx	ebx, word [WAVE_SampleRate]
  2260 00000ACE 31D2                    	xor	edx, edx
  2261 00000AD0 F7F3                    	div	ebx
  2262 00000AD2 31D2                    	xor	edx, edx
  2263 00000AD4 668B1D[98170000]        	mov	bx, [WAVE_BlockAlign]
  2264 00000ADB F7F3                    	div	ebx
  2265                                  cpt_ok:
  2266                                  	; eax = (new) progress time
  2267 00000ADD C3                      	retn
  2268                                  
  2269                                  ; --------------------------------------------------------
  2270                                  ; 14/11/2024
  2271                                  ; (Ref: player.asm, out_cs.asm, Matan Alfasi, 2017)
  2272                                  
  2273                                  ;; DESCRIPTION: Update file information on template
  2274                                  ;; PARAMS:	WAVE parameters and other variables
  2275                                  ;; REGS:	AX(RW)
  2276                                  ;; VARS:	CurrentFileName, WAVE_SampleRate, 
  2277                                  ;; RETURNS:	On-screen file info is updated.
  2278                                  
  2279                                  	; 01/12/2024 (32bit registers)
  2280                                  UpdateFileInfo:
  2281                                  	;; Print File Name
  2282                                  	;mov	dh, 9
  2283                                  	; 21/12/2024 (640*480 graphics display)
  2284                                  	;mov	dh, 8
  2285                                  	;mov	dl, 23
  2286                                  	; 30/12/2024 (320*200, video mode 13h)
  2287 00000ADE B607                    	mov	dh, 7
  2288 00000AE0 B208                    	mov	dl, 8
  2289 00000AE2 E809FFFFFF              	call	setCursorPosition
  2290                                  	
  2291 00000AE7 BE[B4170000]            	mov	esi, wav_file_name
  2292                                  	
  2293                                  	;;;
  2294                                  	; 14/11/2024
  2295                                  	; skip directory separators
  2296                                  	; (note: asciiz string, max. 79 bytes except zero tail)
  2297 00000AEC 89F3                    	mov	ebx, esi
  2298                                  chk4_nxt_sep:
  2299 00000AEE AC                      	lodsb
  2300 00000AEF 3C2F                    	cmp	al, '/'	; 14/12/2024
  2301 00000AF1 7406                    	je	short chg_fpos
  2302 00000AF3 20C0                    	and	al, al
  2303 00000AF5 7406                    	jz	short chg_fpos_ok
  2304 00000AF7 EBF5                    	jmp	short chk4_nxt_sep
  2305                                  chg_fpos:
  2306 00000AF9 89F3                    	mov	ebx, esi
  2307 00000AFB EBF1                    	jmp	short chk4_nxt_sep
  2308                                  chg_fpos_ok:
  2309 00000AFD 89DE                    	mov	esi, ebx ; file name (without its path/directory)
  2310                                  	;;;
  2311                                  _fnl_chk:
  2312                                  	; 30/12/2024 (cgaplay.s)
  2313                                  	; ????????.wav
  2314                                  	; 26/12/2024 (file name length limit -display-)
  2315 00000AFF BB0C000000              	mov	ebx, 12
  2316                                  	;mov	ebx, 17 ; ????????.wav?????
  2317 00000B04 56                      	push	esi
  2318                                  _fnl_chk_loop:
  2319 00000B05 AC                      	lodsb
  2320 00000B06 20C0                    	and	al, al
  2321 00000B08 7406                    	jz	short _fnl_ok
  2322 00000B0A 4B                       	dec	ebx
  2323 00000B0B 75F8                    	jnz	short _fnl_chk_loop
  2324 00000B0D C60600                  	mov	byte [esi], 0
  2325                                  _fnl_ok:
  2326 00000B10 5E                      	pop	esi
  2327                                  	;;;
  2328                                  
  2329 00000B11 E870000000              	call	PrintString
  2330                                  	
  2331                                  	;; Print Frequency
  2332                                  	;mov	dh, 10
  2333                                  	; 21/12/2024 (640*480 graphics display)
  2334                                  	;mov	dh, 9
  2335                                  	;mov	dl, 23
  2336                                  	; 30/12/2024 (320*200, video mode 13h)
  2337 00000B16 B608                    	mov	dh, 8
  2338 00000B18 B208                    	mov	dl, 8
  2339 00000B1A E8D1FEFFFF              	call	setCursorPosition
  2340                                  	;movzx	eax, word [WAVE_SampleRate]
  2341                                  	; 22/12/2024
  2342                                  	; eax = 0
  2343 00000B1F 66A1[90170000]          	mov	ax, [WAVE_SampleRate]
  2344 00000B25 BD05000000              	mov	ebp, 5
  2345 00000B2A E82BFFFFFF              	call	PrintNumber
  2346                                  
  2347                                  	;; Print BitRate
  2348                                  	;mov	dh, 9
  2349                                  	; 21/12/2024 (640*480 graphics display)
  2350                                  	;mov	dh, 8
  2351                                  	;mov	dl, 57
  2352                                  	; 30/12/2024 (320*200, video mode 13h)
  2353 00000B2F B607                    	mov	dh, 7
  2354 00000B31 B21F                    	mov	dl, 31
  2355 00000B33 E8B8FEFFFF              	call	setCursorPosition
  2356 00000B38 66A1[9A170000]          	mov	ax, [WAVE_BitsPerSample]
  2357 00000B3E 66BD0200                	mov	bp, 2
  2358 00000B42 E813FFFFFF              	call	PrintNumber
  2359                                  
  2360                                  	;; Print Channel Number
  2361                                  	;mov	dh, 10
  2362                                  	; 21/12/2024 (640*480 graphics display)
  2363                                  	;mov	dh, 9
  2364                                  	;mov	dl, 57
  2365                                  	; 30/12/2024 (320*200, video mode 13h)
  2366 00000B47 B608                    	mov	dh, 8
  2367 00000B49 B21F                    	mov	dl, 31
  2368 00000B4B E8A0FEFFFF              	call	setCursorPosition
  2369 00000B50 66A1[8E170000]          	mov	ax, [WAVE_NumChannels]
  2370 00000B56 66BD0100                	mov	bp, 1
  2371 00000B5A E8FBFEFFFF              	call	PrintNumber
  2372                                  
  2373                                  	;call	UpdateVolume
  2374                                  	;retn
  2375                                  
  2376                                  ; --------------------------------------------------------
  2377                                  
  2378                                  	; 14/11/2024
  2379                                  UpdateVolume:
  2380                                  	;; Print Volume
  2381                                  	;mov	dh, 24
  2382                                  	; 21/12/2024 (640*480)
  2383                                  	;mov	dh, 32
  2384                                  	;mov	dl, 75
  2385                                  	; 30/12/2024 (320*200, video mode 13h)
  2386 00000B5F B617                    	mov	dh, 23
  2387 00000B61 B223                    	mov	dl, 35
  2388 00000B63 E888FEFFFF              	call	setCursorPosition
  2389                                  	; 22/12/2024
  2390                                  	; eax = 0
  2391                                  
  2392 00000B68 A0[EF090000]            	mov	al, [volume]
  2393                                  
  2394 00000B6D B364                    	mov	bl, 100
  2395 00000B6F F6E3                    	mul	bl
  2396                                  
  2397 00000B71 B31F                    	mov	bl, 31
  2398 00000B73 F6F3                    	div	bl
  2399                                  
  2400                                  	;neg	ax
  2401                                  	;add	ax, 100	
  2402                                  	; 01/12/2024
  2403 00000B75 B464                    	mov	ah, 100
  2404 00000B77 28C4                    	sub	ah, al
  2405 00000B79 0FB6C4                  	movzx	eax, ah
  2406                                  	;xor	ah, ah
  2407                                  	;mov	bp, 3
  2408 00000B7C BD03000000              	mov	ebp, 3
  2409                                  	;call	PrintNumber
  2410                                  	;retn
  2411 00000B81 E9D4FEFFFF              	jmp	PrintNumber	
  2412                                  
  2413                                  ; --------------------------------------------------------
  2414                                  
  2415                                  	; 21/12/2024
  2416                                  	; write text in VESA VBE graphics mode
  2417                                  PrintString:
  2418                                  	; esi = string address
  2419                                  printstr_loop:
  2420 00000B86 31C0                    	xor	eax, eax
  2421 00000B88 AC                      	lodsb
  2422 00000B89 08C0                    	or	al, al
  2423 00000B8B 7417                    	jz	short printstr_ok
  2424                                  
  2425 00000B8D 56                      	push	esi
  2426                                  
  2427 00000B8E 8B35[60120000]          	mov	esi, [screenpos]
  2428                                  
  2429                                  	; esi = pixel position (hw = row, si = column)
  2430                                  	; eax = al = character
  2431                                  	;call	write_character
  2432                                  	; 22/12/2024
  2433 00000B94 E80C000000              	call	write_character_white
  2434                                  
  2435 00000B99 668305[60120000]08      	add	word [screenpos], 8 ; update column (only, not row)
  2436                                  
  2437 00000BA1 5E                      	pop	esi
  2438 00000BA2 EBE2                    	jmp	short printstr_loop
  2439                                  
  2440                                  printstr_ok:
  2441 00000BA4 C3                      	retn
  2442                                  
  2443                                  ; --------------------------------------------------------
  2444                                  
  2445                                  	; 30/12/2024
  2446                                  	; write character (at cursor position)
  2447                                  	; in video mode 13h (320*200, 256 colors)
  2448                                  	; 21/12/2024
  2449                                  	; write character (at cursor position)
  2450                                  	; in graphics mode (640*480, 256 colors)
  2451                                  	; 22/12/2024
  2452                                  write_character_white:
  2453 00000BA5 B90F000000              	mov	ecx, 0Fh
  2454                                  	; 26/12/2024
  2455                                  	;movzx	ecx, byte [tcolor]
  2456                                  write_character:
  2457                                  	; esi = pixel position (hw = row, si = column)
  2458                                  	; eax = al = character
  2459                                  	; cl = color
  2460 00000BAA 890D[64120000]          	mov	[wcolor], ecx ; 22/12/2024
  2461                                  
  2462                                  	; 30/12/2024
  2463                                  	; 22/12/2024
  2464 00000BB0 50                      	push	eax
  2465                                  	; clear previous character pixels
  2466 00000BB1 BF[48120000]            	mov	edi, fillblock
  2467                                  	;;sys	_video, 020Fh, 0, 8001h
  2468                                  	; 30/12/2024
  2469                                  	sys	_video, 010Fh, 0, 8000h ; 8*8 userfont
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000BB6 BB0F010000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 00000BBB B900000000          <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98 00000BC0 BA00800000          <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 00000BC5 B81F000000          <1>  mov eax, %1
   103                              <1> 
   104 00000BCA CD40                <1>  int 40h
  2470 00000BCC 58                      	pop	eax
  2471                                  
  2472                                  	; 30/12/2024
  2473                                  	;shl	eax, 4 ; 8*16 pixel user font
  2474                                  	;mov	edi, fontbuff2 ; start of user font data
  2475                                  	;add	edi, eax
  2476                                  
  2477                                  	; 21/12/2024
  2478                                  	; NOTE:
  2479                                  	; TRDOS 386 does not use 8*14 pixel fonts in sysvideo
  2480                                  	; system calls -in graphics mode-
  2481                                  	; because 8*16 pixel operations are faster
  2482                                  	;			than 8*14 pixel operations.
  2483                                  	; ((so, 8*14 fonts can be converted to 8*16 fonts by
  2484                                  	; adding 2 empty lines))
  2485                                  	; (8*14 characters can be written via pixel operations)
  2486                                    	
  2487                                  	; 21/12/2024 (TRDOS 386 v2.0.9, trdosk6.s, 27/09/2024)
  2488                                  	;;;;;;;;;;;;;;;;; ; sysvideo system call
  2489                                  	;sysvideo:
  2490                                  	;   function in BH
  2491                                  	;	02h: Super VGA, LINEAR FRAME BUFFER data transfers
  2492                                  	;   sub function in BL
  2493                                  	;	0Fh: WRITE CHARACTER (FONT)
  2494                                  	;          CL = char's color (8 bit, 256 colors)
  2495                                  	;	If DH bit 7 = 1
  2496                                  	;	   USER FONT (from user buffer)
  2497                                  	;	         DL = 1 -> 8x16 pixel font
  2498                                   	;	   EDI = user's font buffer address
  2499                                  	;		(NOTE: byte order is as row0,row1,row2..)
  2500                                  	;	   ESI = start position (row, column)
  2501                                  	;		(HW = row, SI = column)
  2502                                  	;;;;;;;;;;;;;;;;;
  2503                                  
  2504                                  	;sys	_video, 020Fh, [wcolor], 8001h
  2505                                  
  2506                                  	; 30/12/2024
  2507                                  	; sysvideo system call
  2508                                  	; BH = 01h = VGA graphics (0A0000h) data transfers
  2509                                  	; BL = 0Fh = write character/font
  2510                                  	; DH = 01h = 8*8 system font 
  2511                                  	; CL = [wcolor] = color
  2512                                  	; ESI = cursor/writing position (pixels)
  2513                                  	;	HW = row, SI = column
  2514                                  	; DL = character (ASCII code)
  2515                                  
  2516 00000BCD B401                    	mov	ah, 01h ; 8*8 pixels
  2517                                  
  2518                                  	sys	_video, 010Fh, [wcolor], eax
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000BCF BB0F010000          <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96 00000BD4 8B0D[64120000]      <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98 00000BDA 89C2                <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 00000BDC B81F000000          <1>  mov eax, %1
   103                              <1> 
   104 00000BE1 CD40                <1>  int 40h
  2519                                  
  2520 00000BE3 C3                      	retn
  2521                                  
  2522                                  ; --------------------------------------------------------
  2523                                  
  2524                                  	; 30/12/2024
  2525                                  	; write characters in video mode 13h
  2526                                  	; (320*200 pixels, 256 colors)
  2527                                  	; 22/12/2024
  2528                                  	; 21/12/2024
  2529                                  	; (write chars in VESA VBE graphics mode)
  2530                                  	; 14/11/2024
  2531                                  	; (Ref: player.asm, Matan Alfasi, 2017)
  2532                                  	; (Modification: Erdogan Tan, 14/11/2024)
  2533                                  
  2534                                  	;PROGRESSBAR_ROW equ 23
  2535                                  	; 21/12/2024 (640*480)
  2536                                  	;PROGRESSBAR_ROW equ 31
  2537                                  	; 30/12/2024 (320*200)
  2538                                  	PROGRESSBAR_ROW equ 22
  2539                                  
  2540                                  UpdateProgressBar:
  2541 00000BE4 E89BFEFFFF              	call	SetProgressTime	; 14/11/2024
  2542                                  
  2543                                  	; 01/12/2024 (32bit registers)
  2544 00000BE9 A1[0C180000]            	mov	eax, [ProgressTime]
  2545                                  UpdateProgressBar@:
  2546                                  	;mov	edx, 80
  2547                                  	; 30/12/2024
  2548 00000BEE BA28000000              	mov	edx, 40 ; 320*200 pixels, 40 columns 
  2549 00000BF3 F7E2                    	mul	edx
  2550 00000BF5 8B1D[08180000]          	mov	ebx, [TotalTime]
  2551 00000BFB F7F3                    	div	ebx
  2552                                  
  2553                                  	; 22/12/2024
  2554                                  	; check progress bar indicator position if it is same 
  2555 00000BFD 3A05[69120000]          	cmp	al, [pbprev]
  2556 00000C03 7430                    	je	short UpdateProgressBar_ok
  2557 00000C05 A2[69120000]            	mov	[pbprev], al
  2558                                  
  2559                                  UpdateProgressBar@@:
  2560                                  	;; Push for the 'Clean' part
  2561 00000C0A 50                      	push	eax ; **
  2562 00000C0B 50                      	push	eax ; *
  2563                                  
  2564                                  	;; Set cursor position
  2565 00000C0C B616                    	mov	dh, PROGRESSBAR_ROW
  2566 00000C0E B200                    	mov	dl, 0
  2567 00000C10 E8DBFDFFFF              	call	setCursorPosition
  2568                                  
  2569 00000C15 58                      	pop	eax ; *
  2570 00000C16 09C0                    	or	eax, eax
  2571 00000C18 742D                    	jz	short UpdateProgressBar_Clean
  2572                                  
  2573                                  UpdateProgressBar_DrawProgress:
  2574                                  	; 22/12/2024
  2575                                  	; 21/12/2024
  2576                                  	; (write progress bar chars in graphics mode)
  2577                                  	;;;;
  2578 00000C1A 89C5                    	mov	ebp, eax
  2579 00000C1C 50                      	push	eax ; ***
  2580 00000C1D 8B35[60120000]          	mov	esi, [screenpos]
  2581                                  UpdateProgressBar_DrawProgress_@:
  2582 00000C23 B8DF000000              	mov	eax, 223
  2583                                  	
  2584                                  	; esi = pixel position (hw = row, si = column)
  2585                                  	; eax = al = character
  2586                                  	;call	write_character
  2587                                  	; 22/12/2024
  2588 00000C28 E878FFFFFF              	call	write_character_white
  2589                                  
  2590 00000C2D 4D                      	dec	ebp
  2591 00000C2E 7406                    	jz	short UpdateProgressBar_DrawCursor
  2592                                  
  2593 00000C30 83C608                  	add	esi, 8 ; next column
  2594 00000C33 EBEE                    	jmp	short UpdateProgressBar_DrawProgress_@
  2595                                  	;;;
  2596                                  
  2597                                  UpdateProgressBar_ok:
  2598 00000C35 C3                      	retn
  2599                                  
  2600                                  UpdateProgressBar_DrawCursor:
  2601                                  	; 22/12/2024
  2602 00000C36 5A                      	pop	edx ; ***
  2603 00000C37 B616                    	mov	dh, PROGRESSBAR_ROW
  2604 00000C39 E8B2FDFFFF              	call	setCursorPosition
  2605                                  
  2606                                  	; 21/12/2024
  2607                                  	; (write progress bar character in graphics mode)
  2608                                  	;;;;
  2609                                  	;;;mov	eax, 223
  2610                                  	;;;shl	eax, 4 ; 8*16 pixel user font
  2611                                  	;;mov	eax, 223*16
  2612                                  	;;mov	edi, fontbuff2 ; start of user font data
  2613                                  	;;add	edi, eax
  2614                                  	;mov	edi, fontbuff2+(223*16)
  2615                                  	;
  2616                                  	;sys	_video, 020Fh, 0Ch, 8001h
  2617                                  	; 22/12/2024
  2618                                  	;mov	eax, 223
  2619                                  	; eax = 0
  2620 00000C3E B0DF                    	mov	al, 223
  2621 00000C40 B10C                    	mov	cl, 0Ch ; red
  2622 00000C42 E863FFFFFF              	call	write_character
  2623                                  	;;;;
  2624                                  
  2625                                  UpdateProgressBar_Clean:
  2626                                  	;pop	eax  ; **
  2627                                  	; 22/12/2024
  2628 00000C47 5A                      	pop	edx  ; **
  2629                                  	; 30/12/2024
  2630                                  	; 21/12/2024
  2631                                  	;mov	ebp, 80
  2632                                  	; 30/12/2024
  2633 00000C48 BD28000000              	mov	ebp, 40 ; 40 columns (320*200 pixels)
  2634                                  	;sub	bp, ax
  2635 00000C4D 6629D5                  	sub	bp, dx ; 22/12/2024
  2636 00000C50 74E3                    	jz	short UpdateProgressBar_ok
  2637                                  
  2638 00000C52 B616                    	mov	dh, PROGRESSBAR_ROW
  2639                                  	;mov	dl, al ; 22/12/2024
  2640 00000C54 E897FDFFFF              	call	setCursorPosition
  2641                                  
  2642                                  	; 21/12/2024
  2643                                  	; (write progress bar chars in graphics mode)
  2644                                  	;;;;
  2645 00000C59 8B35[60120000]          	mov	esi, [screenpos]
  2646                                  UpdateProgressBar_Clean_@:
  2647                                  	;;;mov	eax, 223
  2648                                  	;;;shl	eax, 4 ; 8*16 pixel user font
  2649                                  	;;mov	eax, 223*16
  2650                                  	;mov	edi, fontbuff2 ; start of user font data
  2651                                  	;add	edi, eax
  2652                                  	;mov	edi, fontbuff2+(223*16)
  2653                                  	;
  2654                                  	;sys	_video, 020Fh, 08h, 8001h
  2655                                  	; 22/12/2024
  2656                                  	;mov	eax, 223
  2657                                  	; eax = 0
  2658 00000C5F B0DF                    	mov	al, 223
  2659 00000C61 B108                    	mov	cl, 08h ; gray (dark)
  2660 00000C63 E842FFFFFF              	call	write_character
  2661                                  	;;;;
  2662                                  
  2663 00000C68 4D                      	dec	ebp
  2664 00000C69 74CA                    	jz	short UpdateProgressBar_ok
  2665                                  
  2666 00000C6B 83C608                  	add	esi, 8 ; next column
  2667 00000C6E EBEF                    	jmp	short UpdateProgressBar_Clean_@
  2668                                  	;;;;
  2669                                  
  2670                                  ; --------------------------------------------------------
  2671                                  ; 17/11/2024
  2672                                  
  2673                                  Player_ProcessKey_Backwards:
  2674                                  	;; In order to go backwards 5 seconds:
  2675                                  	;; Update file pointer to the beginning, skip headers
  2676 00000C70 B142                    	mov	cl, 'B'
  2677 00000C72 EB02                    	jmp	short Player_ProcessKey_B_or_F
  2678                                  
  2679                                  Player_ProcessKey_Forwards:
  2680                                  	;; In order to fast-forward 5 seconds, set the file pointer
  2681                                  	;; to CUR_SEEK + 5 * Freq
  2682                                  
  2683 00000C74 B146                    	mov	cl, 'F'
  2684                                  	;jmp	short Player_ProcessKey_B_or_F
  2685                                  
  2686                                  	; 01/12/2024 (32bit regsisters)
  2687                                  Player_ProcessKey_B_or_F:
  2688                                  	; 17/11/2024
  2689                                  	; 04/11/2024
  2690                                  	; (Ref: player.asm, Matan Alfasi, 2017)
  2691                                    
  2692                                  	; 04/11/2024
  2693 00000C76 B805000000              	mov	eax, 5
  2694 00000C7B 0FB71D[98170000]        	movzx	ebx, word [WAVE_BlockAlign]
  2695 00000C82 F7E3                    	mul	ebx
  2696 00000C84 668B1D[90170000]        	mov	bx, [WAVE_SampleRate]
  2697 00000C8B F7E3                    	mul	ebx
  2698                                  	; eax = transfer byte count for 5 seconds
  2699                                  	
  2700                                  	; 17/11/2024
  2701 00000C8D 80F942                  	cmp	cl, 'B'
  2702                                  	;mov	bx, [LoadedDataBytes]
  2703                                  	;mov	cx, [LoadedDataBytes+2]
  2704                                  	; 01/12/2024
  2705 00000C90 8B0D[14180000]          	mov	ecx, [LoadedDataBytes]
  2706 00000C96 7508                    	jne	short move_forward ; cl = 'F'
  2707                                  move_backward:
  2708                                  	;sub	bx, ax
  2709                                  	;sbb	cx, dx
  2710 00000C98 29C1                    	sub	ecx, eax
  2711 00000C9A 7316                    	jnc	short move_file_pointer
  2712                                  move_to_beginning:
  2713                                  	;xor	cx, cx ; 0
  2714                                  	;xor	bx, bx ; 0
  2715 00000C9C 31C9                    	xor	ecx, ecx
  2716 00000C9E EB12                    	jmp	short move_file_pointer
  2717                                  move_forward: 
  2718                                  	;add	bx, ax
  2719                                  	;adc	cx, dx
  2720 00000CA0 01C1                    	add	ecx, eax
  2721 00000CA2 7208                    	jc	short move_to_end
  2722                                  	;cmp	cx, [DATA_SubchunkSize+2]
  2723                                  	;ja	short move_to_end
  2724                                  	;jb	short move_file_pointer
  2725                                  	;cmp	bx, [DATA_SubchunkSize]
  2726                                  	;jna	short move_file_pointer
  2727 00000CA4 3B0D[A0170000]          	cmp	ecx, [DATA_SubchunkSize]
  2728 00000CAA 7606                    	jna	short move_file_pointer
  2729                                  move_to_end:
  2730                                  	;mov	bx, [DATA_SubchunkSize]
  2731                                  	;mov	cx, [DATA_SubchunkSize+2]
  2732 00000CAC 8B0D[A0170000]          	mov	ecx, [DATA_SubchunkSize]
  2733                                  move_file_pointer:
  2734                                  	;mov	dx, bx    
  2735                                  	;mov	[LoadedDataBytes], dx
  2736                                  	;mov	[LoadedDataBytes+2], cx
  2737 00000CB2 890D[14180000]          	mov	[LoadedDataBytes], ecx
  2738                                  	;add	dx, 44 ; + header
  2739                                  	;adc	cx, 0
  2740 00000CB8 83C12C                  	add	ecx, 44 
  2741                                  
  2742                                  	; seek
  2743                                  	;mov	bx, [filehandle]
  2744                                  	;mov	ax, 4200h
  2745                                  	;int	21h
  2746                                  	; 01/12/2024
  2747 00000CBB 31D2                    	xor	edx, edx ; offset from beginning of the file
  2748                                  	; ecx = offset	
  2749                                  	; ebx = file handle
  2750                                  	; edx = 0
  2751                                  	sys	_seek, [filehandle]
    89                              <1> 
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1>  %if %0 >= 2
    94 00000CBD 8B1D[A4170000]      <1>  mov ebx, %2
    95                              <1>  %if %0 >= 3
    96                              <1>  mov ecx, %3
    97                              <1>  %if %0 = 4
    98                              <1>  mov edx, %4
    99                              <1>  %endif
   100                              <1>  %endif
   101                              <1>  %endif
   102 00000CC3 B813000000          <1>  mov eax, %1
   103                              <1> 
   104 00000CC8 CD40                <1>  int 40h
  2752 00000CCA C3                      	retn
  2753                                  
  2754                                  ; --------------------------------------------------------
  2755                                  
  2756                                  	; 30/12/2024 (video mode 13h)
  2757                                  	; (320*200, 256 colors)
  2758                                  	; 25/12/2024
  2759                                  	; 22/12/2024 (VESA VBE mode graphics) 
  2760                                  	; (640*480, 256 colors)
  2761                                  clear_window:
  2762                                  	;mov	edi, [LFB_ADDR]
  2763                                  	; 30/12/2024
  2764                                  	;mov	edi, 0A0000h
  2765                                  	;;add	edi, (13*80*8*14)
  2766                                  	; 25/12/2024
  2767                                  	;;add	edi, 164*640
  2768                                  	;add	edi, 12*8*320
  2769                                  	; 30/12/2024
  2770                                  	;mov	edi, [graphstart] ; 12*8*320
  2771 00000CCB BF80700A00              	mov	edi, 0A0000h+(11*8*320)+(2*320) ; *
  2772                                  				; AC97 info start 
  2773 00000CD0 29C0                    	sub	eax, eax
  2774                                  	;;mov	ecx, (16*640*14)/4 ; 16 rows
  2775                                  	;mov	ecx, 64*640 ; 256 volume level points
  2776                                  	; 30/12/2024
  2777                                  	;mov	ecx, (8*8*320)/4 ; 8 rows 
  2778 00000CD2 B900190000              	mov	ecx, (10*8*320)/4 ; *
  2779 00000CD7 F3AB                    	rep	stosd
  2780                                  	; 24/12/2024
  2781 00000CD9 A3[6C120000]            	mov	[prev_points], eax ; 0
  2782                                  	;
  2783 00000CDE C3                      	retn
  2784                                  
  2785                                  ; -------------------------------------------------------------
  2786                                  ; DATA (INFO)
  2787                                  ; -------------------------------------------------------------
  2788                                  
  2789                                  Credits:
  2790 00000CDF 564741205741562050-     	db 'VGA WAV Player for TRDOS 386 by Erdogan Tan. '
  2790 00000CE8 6C6179657220666F72-
  2790 00000CF1 205452444F53203338-
  2790 00000CFA 36206279204572646F-
  2790 00000D03 67616E2054616E2E20 
  2791 00000D0C 4A616E756172792032-     	db 'January 2025.',10,13,0
  2791 00000D15 3032352E0A0D00     
  2792 00000D1C 30382F30312F323032-     	db '08/01/2025', 10,13,0
  2792 00000D25 350A0D00           
  2793                                  
  2794                                  msgAudioCardInfo:
  2795 00000D29 666F7220536F756E64-     	db  'for Sound Blaster 16 audio device.', 10,13,0
  2795 00000D32 20426C617374657220-
  2795 00000D3B 313620617564696F20-
  2795 00000D44 6465766963652E0A0D-
  2795 00000D4D 00                 
  2796                                  
  2797                                  	; 02/01/2025
  2798                                  msg_usage:
  2799 00000D4E 75736167653A204347-     	db 'usage: CGAPLAY2 <FileName1> <FileName2> <...>',10,13,0
  2799 00000D57 41504C415932203C46-
  2799 00000D60 696C654E616D65313E-
  2799 00000D69 203C46696C654E616D-
  2799 00000D72 65323E203C2E2E2E3E-
  2799 00000D7B 0A0D00             
  2800                                  
  2801                                  	; 24/11/2024
  2802                                  noDevMsg:
  2803 00000D7E 4572726F723A20556E-     	db 'Error: Unable to find Sound Blaster 16 audio device!'
  2803 00000D87 61626C6520746F2066-
  2803 00000D90 696E6420536F756E64-
  2803 00000D99 20426C617374657220-
  2803 00000DA2 313620617564696F20-
  2803 00000DAB 64657669636521     
  2804 00000DB2 0A0D00                  	db 10,13,0
  2805                                  
  2806                                  noFileErrMsg:
  2807 00000DB5 4572726F723A206669-     	db 'Error: file not found.',10,13,0
  2807 00000DBE 6C65206E6F7420666F-
  2807 00000DC7 756E642E0A0D00     
  2808                                  
  2809                                  ; 07/12/2024
  2810                                  trdos386_err_msg:
  2811 00000DCE 5452444F5320333836-     	db 'TRDOS 386 System call error !',10,13,0
  2811 00000DD7 2053797374656D2063-
  2811 00000DE0 616C6C206572726F72-
  2811 00000DE9 20210A0D00         
  2812                                  
  2813                                  ; 24/11/2024
  2814                                  msg_init_err:
  2815 00000DEE 0D0A                    	db 0Dh, 0Ah
  2816 00000DF0 536F756E6420426C61-     	db "Sound Blaster 16 hardware initialization error !"
  2816 00000DF9 737465722031362068-
  2816 00000E02 617264776172652069-
  2816 00000E0B 6E697469616C697A61-
  2816 00000E14 74696F6E206572726F-
  2816 00000E1D 722021             
  2817 00000E20 0D0A00                  	db 0Dh, 0Ah, 0
  2818                                  
  2819                                  ; 19/11/2024
  2820                                  ; 03/06/2017
  2821                                  hex_chars:
  2822 00000E23 303132333435363738-     	db '0123456789ABCDEF', 0
  2822 00000E2C 3941424344454600   
  2823                                  ; 24/11/2024
  2824                                  msgSB16Info:
  2825 00000E34 0D0A                    	db 0Dh, 0Ah
  2826 00000E36 20417564696F204861-     	db " Audio Hardware: Sound Blaster 16", 0Dh, 0Ah 
  2826 00000E3F 7264776172653A2053-
  2826 00000E48 6F756E6420426C6173-
  2826 00000E51 7465722031360D0A   
  2827 00000E59 202020202020426173-     	db "      Base Port: "
  2827 00000E62 6520506F72743A20   
  2828                                  msgBasePort:
  2829 00000E6A 303030680D0A            	db "000h", 0Dh, 0Ah 
  2830 00000E70 202020202020202020-     	db "            IRQ: "
  2830 00000E79 2020204952513A20   
  2831                                  msgIRQ:
  2832 00000E81 30                      	db 30h
  2833 00000E82 0D0A00                  	db 0Dh, 0Ah, 0
  2834                                  
  2835 00000E85 90<rep 3h>              align 4
  2836                                  
  2837                                  ; -------------------------------------------------------------
  2838                                  
  2839                                  	; 30/12/2024
  2840                                  PlayingScreen:
  2841 00000E88 DBDBDBDBDBDBDBDBDB-     	db  14 dup(219), " DOS Player ", 14 dup(219)
  2841 00000E91 DBDBDBDBDB20444F53-
  2841 00000E9A 20506C6179657220DB-
  2841 00000EA3 DBDBDBDBDBDBDBDBDB-
  2841 00000EAC DBDBDBDB           
  2842 00000EB0 C9CDCDCDCDCDCDCDCD-     	db  201, 38 dup(205), 187
  2842 00000EB9 CDCDCDCDCDCDCDCDCD-
  2842 00000EC2 CDCDCDCDCDCDCDCDCD-
  2842 00000ECB CDCDCDCDCDCDCDCDCD-
  2842 00000ED4 CDCDCDBB           
  2843 00000ED8 BA203C53706163653E-     	db  186, " <Space> Play/Pause <N>/<P> Next/Prev ", 186
  2843 00000EE1 20506C61792F506175-
  2843 00000EEA 7365203C4E3E2F3C50-
  2843 00000EF3 3E204E6578742F5072-
  2843 00000EFC 657620BA           
  2844 00000F00 BA203C533E20202020-     	db  186, " <S>     Stop       <Enter> Color     ", 186
  2844 00000F09 2053746F7020202020-
  2844 00000F12 2020203C456E746572-
  2844 00000F1B 3E20436F6C6F722020-
  2844 00000F24 202020BA           
  2845 00000F28 BA203C463E20202020-     	db  186, " <F>     Forwards   <+>/<-> Volume    ", 186
  2845 00000F31 20466F727761726473-
  2845 00000F3A 2020203C2B3E2F3C2D-
  2845 00000F43 3E20566F6C756D6520-
  2845 00000F4C 202020BA           
  2846 00000F50 BA203C423E20202020-     	db  186, " <B>     Backwards  <Q>     Quit Prg  ", 186
  2846 00000F59 204261636B77617264-
  2846 00000F62 7320203C513E202020-
  2846 00000F6B 202051756974205072-
  2846 00000F74 672020BA           
  2847 00000F78 CCCDCDCDCDCDCDCDCD-     	db  204, 38 dup(205), 185
  2847 00000F81 CDCDCDCDCDCDCDCDCD-
  2847 00000F8A CDCDCDCDCDCDCDCDCD-
  2847 00000F93 CDCDCDCDCDCDCDCDCD-
  2847 00000F9C CDCDCDB9           
  2848 00000FA0 BA2046696C653A2020-     	db  186, " File:              Bits:     0       ", 186
  2848 00000FA9 202020202020202020-
  2848 00000FB2 202020426974733A20-
  2848 00000FBB 202020203020202020-
  2848 00000FC4 202020BA           
  2849 00000FC8 BA20467265713A2030-     	db  186, " Freq: 0     Hz     Channels: 0       ", 186
  2849 00000FD1 2020202020487A2020-
  2849 00000FDA 2020204368616E6E65-
  2849 00000FE3 6C733A203020202020-
  2849 00000FEC 202020BA           
  2850 00000FF0 C8CDCDCDCDCDCDCDCD-     	db  200, 38 dup(205), 188
  2850 00000FF9 CDCDCDCDCDCDCDCDCD-
  2850 00001002 CDCDCDCDCDCDCDCDCD-
  2850 0000100B CDCDCDCDCDCDCDCDCD-
  2850 00001014 CDCDCDBC           
  2851 00001018 202020202020202020-     	db  40 dup(32)
  2851 00001021 202020202020202020-
  2851 0000102A 202020202020202020-
  2851 00001033 202020202020202020-
  2851 0000103C 20202020           
  2852                                  improper_samplerate_txt:
  2853                                  read_error_txt:
  2854 00001040 202020202020202020-     	db  40 dup(32)
  2854 00001049 202020202020202020-
  2854 00001052 202020202020202020-
  2854 0000105B 202020202020202020-
  2854 00001064 20202020           
  2855 00001068 202020202020202020-     	db  40 dup(32)
  2855 00001071 202020202020202020-
  2855 0000107A 202020202020202020-
  2855 00001083 202020202020202020-
  2855 0000108C 20202020           
  2856 00001090 202020202020202020-     	db  40 dup(32)
  2856 00001099 202020202020202020-
  2856 000010A2 202020202020202020-
  2856 000010AB 202020202020202020-
  2856 000010B4 20202020           
  2857 000010B8 202020202020202020-     	db  40 dup(32)
  2857 000010C1 202020202020202020-
  2857 000010CA 202020202020202020-
  2857 000010D3 202020202020202020-
  2857 000010DC 20202020           
  2858 000010E0 202020202020202020-     	db  40 dup(32)
  2858 000010E9 202020202020202020-
  2858 000010F2 202020202020202020-
  2858 000010FB 202020202020202020-
  2858 00001104 20202020           
  2859 00001108 202020202020202020-     	db  40 dup(32)
  2859 00001111 202020202020202020-
  2859 0000111A 202020202020202020-
  2859 00001123 202020202020202020-
  2859 0000112C 20202020           
  2860 00001130 202020202020202020-     	db  40 dup(32)
  2860 00001139 202020202020202020-
  2860 00001142 202020202020202020-
  2860 0000114B 202020202020202020-
  2860 00001154 20202020           
  2861 00001158 202020202020202020-     	db  40 dup(32)
  2861 00001161 202020202020202020-
  2861 0000116A 202020202020202020-
  2861 00001173 202020202020202020-
  2861 0000117C 20202020           
  2862 00001180 202020202020202020-     	db  40 dup(32)
  2862 00001189 202020202020202020-
  2862 00001192 202020202020202020-
  2862 0000119B 202020202020202020-
  2862 000011A4 20202020           
  2863 000011A8 202020202020202020-     	db  40 dup(32)
  2863 000011B1 202020202020202020-
  2863 000011BA 202020202020202020-
  2863 000011C3 202020202020202020-
  2863 000011CC 20202020           
  2864 000011D0 CDCDCDCDCDCDCDCDCD-     	db  40 dup(205)
  2864 000011D9 CDCDCDCDCDCDCDCDCD-
  2864 000011E2 CDCDCDCDCDCDCDCDCD-
  2864 000011EB CDCDCDCDCDCDCDCDCD-
  2864 000011F4 CDCDCDCD           
  2865 000011F8 202020202020202020-     	db  40 dup(32)
  2865 00001201 202020202020202020-
  2865 0000120A 202020202020202020-
  2865 00001213 202020202020202020-
  2865 0000121C 20202020           
  2866 00001220 202020202020202020-     	db  13 dup(32), "00:00 ", 174, 175, " 00:00", 4 dup(32), "VOL 000%"
  2866 00001229 2020202030303A3030-
  2866 00001232 20AEAF2030303A3030-
  2866 0000123B 20202020564F4C2030-
  2866 00001244 303025             
  2867                                  	;db  40 dup(32) ; not necessary
  2868 00001247 00                      	db 0
  2869                                  
  2870                                  ; -------------------------------------------------------------
  2871                                  
  2872                                  	; 30/12/2024
  2873                                  fillblock:
  2874 00001248 FF<rep 8h>              	times 8 db 0FFh
  2875 00001250 0000                    	dw 0
  2876                                  
  2877                                  ; -------------------------------------------------------------
  2878                                  
  2879                                  ; 30/12/2024
  2880                                  ; 23/11/2024
  2881                                  colors:
  2882 00001252 0F0B0A0C0E090D          	db 0Fh, 0Bh, 0Ah, 0Ch, 0Eh, 09h, 0Dh
  2883                                  	; white, cyan, green, red, yellow, blue, magenta
  2884 00001259 0B                      ccolor:	db 0Bh	; cyan
  2885                                  
  2886                                  ; 06/01/2025
  2887                                  ; 24/11/2024
  2888                                  half_buffer:
  2889 0000125A 01                      	db 1	; dma half buffer 1 or 2 (0 or 1)
  2890                                  		; (initial value = 1 -> after xor in TuneLoop -> 0)
  2891                                  EOF: 
  2892                                  
  2893                                  ; -------------------------------------------------------------
  2894                                  
  2895                                  bss:
  2896                                  
  2897                                  ABSOLUTE bss
  2898                                  
  2899 0000125B ??                      alignb 4
  2900                                  
  2901                                  ; 08/01/2025
  2902                                  sd_count:
  2903                                  	;resd 1	; byte count of sound data (320 points)
  2904                                  
  2905                                  ; 24/12/2024
  2906                                  ;wpoints_dif:	; wave lighting points factor (differential) 
  2907 0000125C ????????                	resd 1	; required bytes for 1/18 second wave lighting
  2908                                  
  2909                                  ; 06/01/2025
  2910                                  ;graphstart:
  2911                                  ;	resd 1	; start (top) line/row for wave lighting points 	 
  2912                                  
  2913                                  ; 30/12/2024
  2914                                  ;LFB_ADDR:
  2915                                  ;	resd 1
  2916                                  
  2917                                  ;nextrow:
  2918                                  	;resd 1
  2919                                  screenpos: ; hw = (cursor) row, lw = (cursor) column
  2920 00001260 ????????                	resd 1
  2921 00001264 ????????                wcolor:	resd 1
  2922                                  ; 26/12/2024
  2923                                  ;tcolor: resb 1 ; text color
  2924                                  columns:
  2925 00001268 ??                      	resb 1
  2926 00001269 ??                      pbprev:	resb 1 ; previous progress bar indicator position
  2927                                  
  2928 0000126A ????                    alignb 4
  2929                                  
  2930                                  bss_start:
  2931                                  
  2932                                  ; 30/12/2024
  2933                                  prev_points:
  2934 0000126C <res 500h>              	resd 320 ; previous wave points (which are lighting)	
  2935                                  
  2936                                  ; 06/01/2025
  2937                                  ; 20/12/2024 (playwavx.s)
  2938                                  audio_io_base:
  2939 0000176C ????????                	resd 1
  2940                                  audio_intr:
  2941 00001770 ??                      	resb 1
  2942                                  
  2943                                  ; 18/11/2024
  2944                                  stopped:
  2945 00001771 ??                      	resb 1
  2946 00001772 ??                      tLO:	resb 1
  2947                                  
  2948                                  ; 21/11/2024
  2949                                  ;tLP:	resb 1
  2950                                  
  2951                                  ; 30/12/2024
  2952                                  wpoints:
  2953 00001773 ??                      	resb 1
  2954                                  
  2955                                  ; 08/01/2025
  2956                                  ;pbuf_o: resd 1
  2957                                  ; 29/12/2024
  2958                                  ;pbuf_s: resd 1
  2959                                  
  2960                                  ; 25/12/2024
  2961                                  ; 29/11/2024
  2962                                  command:
  2963 00001774 ??                      	resb 1
  2964                                  filecount:
  2965 00001775 ??                      	resb 1
  2966                                  
  2967                                  ; 30/11/2024
  2968 00001776 ????                    alignb 4
  2969                                  
  2970                                  ;;;;;;;;;;;;;;
  2971                                  ; 14/11/2024
  2972                                  ; (Ref: player.asm, Matan Alfasi, 2017)  
  2973                                  WAVFILEHEADERbuff:
  2974                                  RIFF_ChunkID:
  2975 00001778 ????????                	resd 1	; Must be equal to "RIFF" - big-endian
  2976                                  		; 0x52494646
  2977                                  RIFF_ChunkSize:
  2978 0000177C ????????                	resd 1	; Represents total file size, not 
  2979                                          	; including the first 2 fields 
  2980                                  		; (Total_File_Size - 8), little-endian
  2981                                  RIFF_Format:
  2982 00001780 ????????                	resd 1	; Must be equal to "WAVE" - big-endian
  2983                                  		; 0x57415645
  2984                                  
  2985                                  ;; WAVE header parameters ("Sub-chunk")
  2986                                  WAVE_SubchunkID:
  2987 00001784 ????????                	resd 1	; Must be equal to "fmt " - big-endian
  2988                                  		; 0x666d7420
  2989                                  WAVE_SubchunkSize:
  2990 00001788 ????????                	resd 1	; Represents total chunk size
  2991                                  WAVE_AudioFormat:
  2992 0000178C ????                    	resw 1	; PCM (Raw) - is 1, other - is a form 
  2993                                  		; of compression, not supported.
  2994                                  WAVE_NumChannels:
  2995 0000178E ????                    	resw 1	; Number of channels, Mono-1, Stereo-2
  2996                                  WAVE_SampleRate:
  2997 00001790 ????????                	resd 1	; Frequency rate, in Hz (8000, 44100 ...)
  2998                                  WAVE_ByteRate:
  2999 00001794 ????????                	resd 1	; SampleRate * NumChannels * BytesPerSample
  3000                                  WAVE_BlockAlign:
  3001 00001798 ????                    	resw 1	; NumChannels * BytesPerSample
  3002                                  		; Number of bytes for one sample.
  3003                                  WAVE_BitsPerSample:
  3004 0000179A ????                    	resw 1	; 8 = 8 bits, 16 = 16 bits, etc.
  3005                                  
  3006                                  ;; DATA header parameters
  3007                                  DATA_SubchunkID:
  3008 0000179C ????????                	resd 1	; Must be equal to "data" - big-endian
  3009                                          	; 0x64617461
  3010                                  DATA_SubchunkSize:
  3011 000017A0 ????????                	resd 1	; NumSamples * NumChannels * BytesPerSample
  3012                                          	; Number of bytes in the data.
  3013                                  ;;;;;;;;;;;;;;
  3014                                  
  3015                                  ; 06/01/2025
  3016                                  
  3017                                  filehandle:
  3018 000017A4 ????????                	resd 1
  3019                                  
  3020                                  ; 25/12/2024
  3021                                  ; 30/11/2024
  3022                                  ;argc:	resb 1	; argument count
  3023 000017A8 ????????                argv:	resd 1	; current argument (wav file) ptr
  3024 000017AC ????????                argvf:	resd 1	; 1st argument (wav file) ptr
  3025 000017B0 ????????                argvl:	resd 1	; last argument (wav file) ptr
  3026                                  
  3027                                  ; 30/05/2024
  3028                                  wav_file_name:
  3029 000017B4 <res 50h>               	resb 80	; wave file, path name (<= 80 bytes)
  3030 00001804 ????                    	resw 1	; 30/11/2024
  3031                                  
  3032 00001806 ??                      flags:	resb 1
  3033                                  
  3034                                  ; 07/12/2024
  3035 00001807 ??                      SRB:	resb 1
  3036                                  
  3037                                  ; 14/11/2024
  3038                                  TotalTime:
  3039 00001808 ????????                	resd 1	; Total (WAV File) Playing Time in seconds
  3040                                  ProgressTime:
  3041 0000180C ????????                	resd 1
  3042 00001810 ????????                count:	resd 1	; byte count of one (wav file) read
  3043                                  LoadedDataBytes:
  3044 00001814 ????????                	resd 1	; total read/load count
  3045                                  
  3046                                  timerticks:
  3047 00001818 ????????                	resd 1	; (to eliminate excessive lookup of events in tuneloop)
  3048                                  		; (in order to get the emulator/qemu to run correctly)
  3049                                  
  3050                                  ; 06/01/2025
  3051                                  UpdateWavePoints:
  3052 0000181C ????????                	resd 1	; wave lighting procedure pointer (8m,16m,8s,16s)
  3053                                  
  3054                                  ; 06/01/2025
  3055                                  ; 17/12/2024
  3056                                  allocated:
  3057 00001820 ??                      	resb 1
  3058                                  interrupt:
  3059 00001821 ??                      	resb 1
  3060                                  
  3061                                  ; 18/12/2024
  3062                                  ; (the audio buffer must be aligned with the memory page, 
  3063                                  ;  otherwise the bss area before the buffer will be truncated)
  3064                                  ; ((ref: TRDOS 386 v2.0.9 Kernel, trdosk8.s, 'sysaudio' function 2))
  3065                                  
  3066                                  ; 08/01/2025
  3067 00001822 ????                    alignb 4
  3068                                  
  3069                                  ; 08/01/2025
  3070                                  sounddata:	; (wave lighting points) graphics data	
  3071 00001824 <res 500h>              	resb 320*4
  3072                                  
  3073 00001D24 <res 2DCh>              alignb 4096	; align to memory page boundary
  3074                                  
  3075                                  ; 06/01/2025 (cgaplay2.s)
  3076                                  ; 16/12/2024 (sb16play.s)
  3077                                  audio_buffer:
  3078 00002000 <res 8000h>             	resb BUFFERSIZE ; 32768
  3079                                  
  3080                                  bss_end:
  3081                                  
  3082                                  ; 08/01/2025
  3083                                  ; 16/12/2024 (sb16play.s)
  3084                                  ;alignb 4096
  3085                                  
  3086                                  ; 08/01/2025
  3087                                  ; 06/01/2025
  3088                                  ; 24/11/2024
  3089                                  ;dma_buffer:	; 65536 bytes
  3090                                  ;wav_buffer1:
  3091                                  ;	resb BUFFERSIZE ; 32768
  3092                                  ;wav_buffer2:
  3093                                  ;	resb BUFFERSIZE ; 32768
