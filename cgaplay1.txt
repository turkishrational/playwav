     1                                  ; ****************************************************************************
     2                                  ; cgaplay1.s - TRDOS 386 (TRDOS v2.0.9) WAV PLAYER - Video Mode 13h
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; CGAPLAY1.PRG ! AC'97 (ICH) .WAV PLAYER program by Erdogan TAN
     5                                  ;
     6                                  ; 27/12/2024				- play music from multiple wav files -
     7                                  ;
     8                                  ; [ Last Modification: 01/01/2025 ]
     9                                  ;
    10                                  ; Modified from VGAPLAY3.PRG .wav player program by Erdogan Tan, 30/12/2024
    11                                  ;
    12                                  ; ****************************************************************************
    13                                  ; nasm cgaplay1.s -l cgaplay1.txt -o CGAPLAY1.PRG -Z error.txt
    14                                  
    15                                  ; 31/12/2024
    16                                  ; cgaplay1.s (int 31h modifications on cgaplay.s)
    17                                  ; 30/12/2024 (cgaplay.s)
    18                                  ; vgaplay3.s
    19                                  ; 27/12/2024
    20                                  ; vgaplay2.s : DMA buffer tracking (instead of user's audio buffer)
    21                                  ; 18/12/2024
    22                                  ; ac97play.s : TUNELOOP version (playing without AC97 interrupt)
    23                                  
    24                                  ; vgaplay.s (26/12/2024) - play music from multiple wav files -
    25                                  ; dplayvga.s (25/12/2024) - play music from single wav file -
    26                                  ; ac97play.s (18/12/2024) - play music from multiple wav files -
    27                                  
    28                                  ; 07/12/2024 - playwav9.s - interrupt (srb) + tuneloop version
    29                                  ; ------------------------------------------------------------
    30                                  ; INTERRUPT (SRB) + TUNELOOP version ; 24/11/2024 (PLAYWAV9.ASM)
    31                                  ;	(running in DOSBOX, VIRTUALBOX, QEMU is ok)
    32                                  ; Signal Response Byte = message/signal to user about an event/interrupt
    33                                  ;	    as requested (TuneLoop procedure continuously checks this SRB)
    34                                  ; (TRDOS 386 v2 feature is used here as very simple interrupt handler output)
    35                                  
    36                                  ; ------------------------------------------------------------
    37                                  
    38                                  ; 30/11/2024
    39                                  ; 20/08/2024 ; TRDOS 386 v2.0.9
    40                                  ; 29/04/2016
    41                                  _ver 	equ 0
    42                                  _exit 	equ 1
    43                                  _fork 	equ 2
    44                                  _read 	equ 3
    45                                  _write	equ 4
    46                                  _open	equ 5
    47                                  _close 	equ 6
    48                                  _wait 	equ 7
    49                                  _creat 	equ 8
    50                                  _link 	equ 9
    51                                  _unlink	equ 10
    52                                  _exec	equ 11
    53                                  _chdir	equ 12
    54                                  _time 	equ 13
    55                                  _mkdir 	equ 14
    56                                  _chmod	equ 15
    57                                  _chown	equ 16
    58                                  _break	equ 17
    59                                  _stat	equ 18
    60                                  _seek	equ 19
    61                                  _tell 	equ 20
    62                                  _mount	equ 21
    63                                  _umount	equ 22
    64                                  _setuid	equ 23
    65                                  _getuid	equ 24
    66                                  _stime	equ 25
    67                                  _quit	equ 26
    68                                  _intr	equ 27
    69                                  _fstat	equ 28
    70                                  _emt 	equ 29
    71                                  _mdate 	equ 30
    72                                  _video 	equ 31
    73                                  _audio	equ 32
    74                                  _timer	equ 33
    75                                  _sleep	equ 34
    76                                  _msg    equ 35
    77                                  _geterr	equ 36
    78                                  _fpsave	equ 37
    79                                  _pri	equ 38
    80                                  _rele	equ 39
    81                                  _fff	equ 40
    82                                  _fnf	equ 41
    83                                  _alloc	equ 42
    84                                  _dalloc equ 43
    85                                  _calbac equ 44
    86                                  _dma	equ 45
    87                                  _stdio  equ 46
    88                                  
    89                                  ; ------------------------------------------------------------
    90                                  
    91                                  %macro sys 1-4
    92                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)
    93                                      ; 03/09/2015
    94                                      ; 13/04/2015
    95                                      ; Retro UNIX 386 v1 system call.
    96                                      %if %0 >= 2
    97                                          mov ebx, %2
    98                                          %if %0 >= 3
    99                                              mov ecx, %3
   100                                              %if %0 = 4
   101                                                 mov edx, %4
   102                                              %endif
   103                                          %endif
   104                                      %endif
   105                                      mov eax, %1
   106                                      ;int 30h
   107                                      int 40h ; TRDOS 386 (TRDOS v2.0)
   108                                  %endmacro
   109                                  
   110                                  ; Retro UNIX 386 v1 system call format:
   111                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
   112                                  
   113                                  ; ------------------------------------------------------------
   114                                  
   115                                  ; player internal variables and other equates.
   116                                  BUFFERSIZE	equ 65536
   117                                  ENDOFFILE	equ 1		; flag for knowing end of file
   118                                  
   119                                  ; ------------------------------------------------------------
   120                                  
   121                                  [BITS 32] ; 32-bit intructions
   122                                  
   123                                  [ORG 0]
   124                                  
   125                                  START_CODE:
   126                                  	; Prints the Credits Text.
   127                                  	sys	_msg, Credits, 255, 0Bh
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00000000 BB[CC2B0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000005 B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 0000000A BA0B000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 0000000F B823000000          <1>  mov eax, %1
   106                              <1> 
   107 00000014 CD40                <1>  int 40h
   128                                  
   129                                  	; clear bss
   130 00000016 BF[04320000]            	mov	edi, bss_start
   131 0000001B B976010000              	mov	ecx, (bss_end - bss_start)/4
   132 00000020 31C0                    	xor	eax, eax
   133 00000022 F3AB                    	rep	stosd
   134                                  
   135                                  ; -------------------------------------------------------------
   136                                  
   137                                  	; 21/12/2024
   138                                  	; Detect (& Enable) AC'97 Audio Device
   139 00000024 E85E070000              	call	DetectAC97
   140 00000029 731B                    	jnc	short ac97_hardware_ready
   141                                  
   142                                  	; 30/11/2024
   143                                  	; 30/05/2024
   144                                  _dev_not_ready:
   145                                  	; couldn't find the audio device!
   146                                  	sys	_msg, noDevMsg, 255, 0Fh
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 0000002B BB[6F2C0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000030 B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00000035 BA0F000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 0000003A B823000000          <1>  mov eax, %1
   106                              <1> 
   107 0000003F CD40                <1>  int 40h
   147 00000041 E973040000                      jmp     Exit
   148                                  
   149                                  ac97_hardware_ready:
   150 00000046 E8730D0000              	call	write_audio_dev_info
   151                                  
   152                                  ; -------------------------------------------------------------
   153                                  
   154                                  	; 30/12/2024
   155                                  	;;;
   156                                  	; DIRECT VGA MEMORY ACCESS
   157                                  	; bl = 0, bh = 5
   158                                  	; Direct access/map to VGA memory (0A0000h)
   159                                  
   160                                  	sys	_video, 0500h
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 0000004B BB00050000          <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99                              <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101                              <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000050 B81F000000          <1>  mov eax, %1
   106                              <1> 
   107 00000055 CD40                <1>  int 40h
   161 00000057 3D00000A00              	cmp	eax, 0A0000h
   162 0000005C 7405                    	je	short _a
   163                                  
   164                                  	; 30/12/2024
   165 0000005E E99E040000              	jmp	trdos386_error
   166                                  
   167                                  _a:
   168                                  	;; Set Video Mode to 13h
   169                                  	;sys	_video, 0813h
   170                                  	;cmp	eax, 14h 
   171                                  	;je	short mode_13h_set_ok
   172                                  
   173                                  	; set VGA mode by using int 31h
   174 00000063 66B81300                	mov	ax, 13h	; mode 13h ; 
   175 00000067 CD31                    	int	31h	; real mode: int 10h
   176                                  
   177                                  ; -------------------------------------------------------------
   178                                  
   179                                  mode_13h_set_ok:
   180                                  	; 30/12/2024
   181                                  	; 24/12/2024 (setting for wave lighting points)
   182                                  	;mov	eax, 0A0000h
   183                                  	;;add	eax, 12*8*320
   184                                  	;add	eax, (13*8*320)+(2*320)
   185                                  			; wave graphics start (top) line/row
   186                                  			; 64 volume levels
   187                                  	;mov	[graphstart], eax
   188                                  	; 30/12/2024
   189                                  	;mov	dword [graphstart], 0A0000h+(13*8*320)+(4*320)
   190                                  	; 01/01/2025
   191 00000069 C705[F8310000]0073-     	mov	dword [graphstart], 0A0000h+(11*8*320)+(4*320)
   191 00000071 0A00               
   192                                  
   193                                  ; -------------------------------------------------------------
   194                                  
   195                                  	; 25/12/2024
   196                                  	; 28/11/2024
   197                                  Player_InitalizePSP:
   198                                  	; 30/11/2024
   199                                  	; (TRDOS 386 -Retro UNIX 386- argument transfer method)
   200                                  	; (stack: argc,argv0addr,argv1addr,argv2addr ..
   201                                  	;			.. argv0text, argv1text ..) 
   202                                  	; ---- argc, argv[] ----
   203 00000073 89E6                    	mov	esi, esp
   204 00000075 AD                      	lodsd
   205 00000076 83F802                  	cmp	eax, 2 ; two arguments 
   206                                  		; (program file name & mod file name)
   207 00000079 0F8243040000            	jb	pmsg_usage ; nothing to do
   208                                  	;mov	[argc], al
   209 0000007F C1E002                  	shl	eax, 2 ; *4
   210 00000082 01E0                    	add	eax, esp
   211                                  	; eax = last argument's address pointer
   212 00000084 A3[54370000]            	mov	[argvl], eax ; last wav file (argument)
   213 00000089 8935[4C370000]          	mov	[argv], esi ; current argument (PRG file name)
   214 0000008F AD                      	lodsd	; skip program (PRG) file name
   215 00000090 8935[50370000]          	mov	[argvf], esi ; 1st wav file (argument)
   216                                  
   217                                  	; 30/12/2024
   218                                  Player_ParseParameters:
   219 00000096 EB2A                    	jmp	short Player_ParseNextParameter
   220                                  	; 25/12/2024
   221                                  check_p_command:
   222                                  	; 07/12/2024
   223 00000098 8B35[4C370000]          	mov	esi, [argv]
   224                                  	;
   225 0000009E 803D[16370000]50          	cmp	byte [command], 'P'
   226 000000A5 7410                    	je	short Player_ParsePreviousParameter
   227                                      
   228                                  	; 07/12/2024
   229                                  	; 30/11/2024
   230                                  	;mov	esi, [argv] ; current argument (wav file) ptr
   231 000000A7 83C604                  	add	esi, 4
   232 000000AA 3B35[54370000]          	cmp	esi, [argvl] ; last argument (wav file) ptr
   233 000000B0 7610                    	jna	short Player_ParseNextParameter
   234                                  jmp_Player_Quit:
   235 000000B2 E9A3040000              	jmp	Player_Quit
   236                                  
   237                                  Player_ParsePreviousParameter:
   238                                  	; 29/11/2024
   239                                  	;mov	byte [command], 0
   240                                  	; 30/11/2024
   241                                  	;mov	esi, [argv] ; 07/12/2024	
   242 000000B7 3B35[50370000]          	cmp	esi, [argvf] ; first argument (wav file) ptr
   243 000000BD 7603                    	jna	short Player_ParseNextParameter
   244 000000BF 83EE04                  	sub	esi, 4
   245                                  Player_ParseNextParameter:
   246                                  	; 30/11/2024
   247 000000C2 8935[4C370000]          	mov	[argv], esi  ; set as current argument
   248                                  
   249                                  	; 01/12/2024
   250 000000C8 8B36                    	mov	esi, [esi]
   251                                  
   252                                  	; 30/12/2024
   253                                  	; 29/11/2024
   254 000000CA E83C000000              	call	GetFileName
   255                                  	;jcxz	jmp_Player_Quit
   256 000000CF E3E1                    	jecxz	jmp_Player_Quit ; 30/11/2024
   257                                  
   258                                  	; 30/12/2024
   259                                          ; open existing file
   260                                  	; 28/11/2024
   261 000000D1 BA[58370000]            	mov	edx, wav_file_name
   262 000000D6 E8FC060000                      call	openFile ; no error? ok.
   263 000000DB 7376                            jnc	getwavparms	; 14/11/2024
   264                                  
   265                                  	; 29/11/2024
   266 000000DD 803D[17370000]00        	cmp	byte [filecount], 0
   267 000000E4 77B2                    	ja	short check_p_command
   268                                  
   269                                  	; 25/12/2024
   270                                  	; 21/12/2024
   271 000000E6 E867040000              	call	set_text_mode
   272                                  	; file not found!
   273                                  	; 30/11/2024
   274                                  	sys	_msg, noFileErrMsg, 255, 0Ch
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000000EB BB[9A2C0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000000F0 B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000000F5 BA0C000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000000FA B823000000          <1>  mov eax, %1
   106                              <1> 
   107 000000FF CD40                <1>  int 40h
   275 00000101 E9B3030000                      jmp     Exit
   276                                  
   277                                  _exit_:
   278 00000106 E9A9030000              	jmp	terminate
   279                                  
   280                                  ; -------------------------------------------------------------
   281                                  
   282                                  	; 26/12/2024
   283                                  	; 25/12/2024
   284                                  	; 30/11/2024 (32bit)
   285                                  	; 29/11/2024
   286                                  	; 30/05/2024
   287                                  GetFileName:
   288 0000010B BF[58370000]            	mov	edi, wav_file_name 
   289                                  	; 30/11/2024
   290                                  	;mov	esi, [argv]
   291 00000110 31C9                    	xor	ecx, ecx ; 0
   292                                  ScanName:
   293 00000112 AC                      	lodsb
   294                                  	;test	al, al
   295                                  	;jz	short a_4
   296                                  	; 29/11/2024
   297 00000113 3C0D                    	cmp	al, 0Dh
   298 00000115 7638                    	jna	short a_4
   299 00000117 3C20                    	cmp	al, 20h
   300 00000119 74F7                    	je	short ScanName	; scan start of name.
   301 0000011B AA                      	stosb
   302 0000011C B4FF                    	mov	ah, 0FFh
   303                                  	;;;
   304                                  	; 14/11/2024
   305                                  	; (max. path length = 64 bytes for MSDOS ?) (*)
   306                                  	;xor	ecx, ecx ; 0
   307                                  	;;;
   308                                  a_0:	
   309 0000011E FEC4                    	inc	ah
   310                                  a_1:
   311                                  	;;;
   312                                  	; 14/11/2024
   313 00000120 41                      	inc	ecx
   314                                  	;;;
   315 00000121 AC                      	lodsb
   316 00000122 AA                      	stosb
   317 00000123 3C2E                    	cmp	al, '.'
   318 00000125 74F7                    	je	short a_0
   319                                  	; 29/11/2024
   320 00000127 3C20                    	cmp	al, 20h
   321                                  	;and	al, al
   322                                  	;jnz	short a_1
   323                                  	;;;
   324                                  	; 14/11/2024
   325 00000129 7613                    	jna	short a_3
   326 0000012B 20E4                    	and	ah, ah
   327 0000012D 7406                    	jz	short a_2
   328 0000012F 3C2F                    	cmp	al, '/'	; 14/12/2024
   329 00000131 7502                    	jne	short a_2
   330 00000133 B400                    	mov	ah, 0
   331                                  a_2:
   332 00000135 80F94B                  	cmp	cl, 75	; 64+8+'.'+3 -> offset 75 is the last chr
   333 00000138 72E6                    	jb	short a_1
   334                                  	; 29/11/2024
   335 0000013A 29C9                    	sub	ecx, ecx
   336 0000013C EB11                    	jmp	short a_4
   337                                  a_3:
   338                                  	; 29/11/2024
   339 0000013E 4F                      	dec	edi
   340                                  	;;;
   341 0000013F 08E4                    	or	ah, ah		; if period NOT found,
   342 00000141 750C                    	jnz	short a_4 	; then add a .WAV extension.
   343                                  SetExt:
   344                                  	; 29/11/2024
   345                                  	;dec	edi
   346 00000143 C7072E574156            	mov	dword [edi], '.WAV'
   347                                  				; ! 64+12 is DOS limit
   348                                  				; but writing +4 must not
   349                                  				; destroy the following data	 
   350                                  	;mov	byte [edi+4], 0	; so, 80 bytes path + 0 is possible here
   351                                  	; 29/11/2024
   352 00000149 83C104                  	add	ecx, 4
   353 0000014C 83C704                  	add	edi, 4
   354                                  a_4:	
   355 0000014F C60700                  	mov	byte [edi], 0
   356                                  	; 30/11/2024
   357 00000152 C3                      	retn
   358                                  
   359                                  ; -------------------------------------------------------------
   360                                  
   361                                  getwavparms:
   362                                  	; 14/11/2024
   363 00000153 E8B1060000                     	call    getWAVParameters
   364 00000158 72AC                    	jc	short _exit_		; nothing to do
   365                                  
   366                                  	; 17/11/2024
   367 0000015A B304                    	mov	bl, 4
   368 0000015C 2A1D[38370000]          	sub	bl, byte [WAVE_BlockAlign]
   369                                  			; = 0 for 16 bit stereo
   370                                  			; = 2 for 8 bit stereo or 16 bit mono
   371                                  			; = 3 for 8 bit mono	
   372                                  
   373 00000162 D0EB                    	shr	bl, 1	;  0 -->  0,  2 -->  1,  3 -->  1
   374                                  	; 15/11/2024
   375 00000164 80D300                  	adc	bl, 0	; 3 --> 1 --> 2
   376 00000167 881D[AA370000]          	mov	byte [fbs_shift], bl	; = 2 mono and 8 bit
   377                                  					; = 0 stereo and 16 bit
   378                                  					; = 1 mono or 8 bit
   379                                  	; 29/12/2024
   380                                  	; 30/05/2024
   381 0000016D E8F8070000              	call	codecConfig		; unmute codec, set rates.
   382 00000172 0F8267030000            	jc	init_err
   383                                  
   384                                  ; -------------------------------------------------------------
   385                                  
   386                                  StartPlay:
   387                                  	; 30/12/2024
   388 00000178 C605[0B370000]01        	mov	byte [wpoints], 1
   389                                  
   390                                  	;;;
   391                                  	; 09/12/2024
   392 0000017F B834290000              	mov	eax, 10548 ; (48000*10/182)*4
   393 00000184 803D[15370000]00        	cmp	byte [VRA], 0
   394 0000018B 7614                    	jna	short _w ; 48kHZ (interpolation)
   395                                  	;
   396 0000018D 66A1[30370000]          	mov	ax, [WAVE_SampleRate]
   397 00000193 B90A000000              	mov	ecx, 10
   398 00000198 F7E1                    	mul	ecx
   399 0000019A B1B6                    	mov	cl, 182
   400 0000019C F7F1                    	div	ecx
   401                                  	; ax = samples per 1/18.2 second
   402                                  	;mov	cl, byte [WAVE_BlockAlign]
   403                                  	; 09/12/2024 
   404                                  	;mov	cl, 4 ; 16 bit, stereo
   405                                  	;mul	ecx
   406 0000019E C1E002                  	shl	eax, 2 ; * 4
   407                                  _w:
   408 000001A1 A3[F4310000]            	mov	[wpoints_dif], eax ; buffer read differential (distance)
   409                                  				; for wave volume leds update
   410                                  				; (byte stream per 1/18.2 second)
   411                                  
   412                                  ; -------------------------------------------------------------
   413                                  
   414                                  	; 25/12/2024
   415 000001A6 FE05[17370000]          	inc	byte [filecount]
   416 000001AC C605[16370000]00        	mov	byte [command], 0
   417                                  	; 30/12/2024
   418 000001B3 C605[01320000]FF        	mov	byte [pbprev], -1
   419                                  
   420                                  ; -------------------------------------------------------------
   421                                  
   422                                  	; 07/12/2024 (playwav9.s)
   423                                  
   424                                  	; 18/11/2023 (ich_wav4.asm)
   425                                  	; 13/11/2023 (ich_wav3.asm)
   426                                  
   427 000001BA 803D[15370000]01        	cmp	byte [VRA], 1
   428 000001C1 7226                    	jb	short chk_sample_rate
   429                                  
   430                                  playwav_48_khz:
   431 000001C3 C705[B8370000]-         	mov	dword [loadfromwavfile], loadFromFile
   431 000001C9 [F00C0000]         
   432                                  	;mov	dword [loadsize], 0 ; 65536
   433                                  	;;;
   434                                  	; 17/11/2024
   435                                  	;mov	word [buffersize], 32768
   436                                  	;mov	ax, BUFFERSIZE/2 ; 32760
   437                                  	; 30/11/2024
   438                                  	;mov	eax, BUFFERSIZE/2 ; 32768
   439                                  	; 07/12/2024
   440 000001CD B800000100              	mov	eax, BUFFERSIZE ; 65536
   441 000001D2 A3[C0370000]            	mov	[buffersize], eax	; 16 bit samples
   442                                  	; 07/12/2024
   443                                  	;shl	eax, 1			; bytes
   444 000001D7 8A0D[AA370000]          	mov	cl, [fbs_shift]
   445 000001DD D3E8                    	shr	eax, cl 
   446                                  	;mov	[loadsize], ax ; 16380 or 32760 or 65520
   447 000001DF A3[BC370000]            	mov	[loadsize], eax ; 16384 or 32768 or 65536
   448                                  	;;;
   449                                  	;jmp	PlayNow ; 30/05/2024
   450                                  	; 07/12/2024
   451 000001E4 E95D020000              	jmp	Player_Template
   452                                  
   453                                  chk_sample_rate:
   454                                  	; set conversion parameters
   455                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   456 000001E9 66A1[30370000]          	mov	ax, [WAVE_SampleRate]
   457 000001EF 663D80BB                	cmp	ax, 48000
   458 000001F3 74CE                    	je	short playwav_48_khz
   459                                  chk_22khz:
   460 000001F5 663D2256                	cmp	ax, 22050
   461 000001F9 7545                    	jne	short chk_11khz
   462 000001FB 803D[3A370000]08        	cmp	byte [WAVE_BitsPerSample], 8
   463 00000202 7615                    	jna	short chk_22khz_1
   464 00000204 BB[851C0000]            	mov	ebx, load_22khz_stereo_16_bit
   465 00000209 803D[2E370000]01        	cmp	byte [WAVE_NumChannels], 1
   466 00000210 751A                    	jne	short chk_22khz_2
   467 00000212 BB[F21B0000]            	mov	ebx, load_22khz_mono_16_bit
   468 00000217 EB13                    	jmp	short chk_22khz_2
   469                                  chk_22khz_1:
   470 00000219 BB[651B0000]            	mov	ebx, load_22khz_stereo_8_bit
   471 0000021E 803D[2E370000]01        	cmp	byte [WAVE_NumChannels], 1
   472 00000225 7505                    	jne	short chk_22khz_2
   473 00000227 BB[D61A0000]            	mov	ebx, load_22khz_mono_8_bit
   474                                  chk_22khz_2:
   475 0000022C B85A1D0000              	mov	eax, 7514  ; (442*17)
   476 00000231 BA25000000              	mov	edx, 37
   477 00000236 B911000000              	mov	ecx, 17
   478 0000023B E9D9010000              	jmp	set_sizes
   479                                  chk_11khz:
   480 00000240 663D112B                	cmp	ax, 11025
   481 00000244 7545                    	jne	short chk_44khz
   482 00000246 803D[3A370000]08        	cmp	byte [WAVE_BitsPerSample], 8
   483 0000024D 7615                    	jna	short chk_11khz_1
   484 0000024F BB[B91E0000]            	mov	ebx, load_11khz_stereo_16_bit
   485 00000254 803D[2E370000]01        	cmp	byte [WAVE_NumChannels], 1
   486 0000025B 751A                    	jne	short chk_11khz_2
   487 0000025D BB[3A1E0000]            	mov	ebx, load_11khz_mono_16_bit
   488 00000262 EB13                    	jmp	short chk_11khz_2
   489                                  chk_11khz_1:
   490 00000264 BB[B51D0000]            	mov	ebx, load_11khz_stereo_8_bit
   491 00000269 803D[2E370000]01        	cmp	byte [WAVE_NumChannels], 1 
   492 00000270 7505                    	jne	short chk_11khz_2
   493 00000272 BB[3C1D0000]            	mov	ebx, load_11khz_mono_8_bit
   494                                  chk_11khz_2:
   495 00000277 B8AD0E0000              	mov	eax, 3757  ; (221*17)
   496 0000027C BA4A000000              	mov	edx, 74
   497 00000281 B911000000              	mov	ecx, 17
   498 00000286 E98E010000              	jmp	set_sizes
   499                                  chk_44khz:
   500 0000028B 663D44AC                	cmp	ax, 44100
   501 0000028F 7545                    	jne	short chk_16khz
   502 00000291 803D[3A370000]08        	cmp	byte [WAVE_BitsPerSample], 8
   503 00000298 7615                    	jna	short chk_44khz_1
   504 0000029A BB[F8200000]            	mov	ebx, load_44khz_stereo_16_bit
   505 0000029F 803D[2E370000]01        	cmp	byte [WAVE_NumChannels], 1
   506 000002A6 751A                    	jne	short chk_44khz_2
   507 000002A8 BB[79200000]            	mov	ebx, load_44khz_mono_16_bit
   508 000002AD EB13                    	jmp	short chk_44khz_2
   509                                  chk_44khz_1:
   510 000002AF BB[F61F0000]            	mov	ebx, load_44khz_stereo_8_bit
   511 000002B4 803D[2E370000]01        	cmp	byte [WAVE_NumChannels], 1
   512 000002BB 7505                    	jne	short chk_44khz_2
   513 000002BD BB[741F0000]            	mov	ebx, load_44khz_mono_8_bit
   514                                  chk_44khz_2:
   515                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   516 000002C2 B8D93A0000              	mov	eax, 15065 ; (655*23)
   517                                  	; 18/11/2023 ((file size + bss + stack) <= 64KB)
   518                                  	;mov	ax, 14076 ; (612*23)
   519                                  	; 17/11/2024
   520                                  	;mov	ax, 12650 ; (550*23)
   521 000002C7 BA19000000              	mov	edx, 25
   522 000002CC B917000000              	mov	ecx, 23
   523 000002D1 E943010000              	jmp	set_sizes
   524                                  chk_16khz:
   525 000002D6 663D803E                	cmp	ax, 16000
   526 000002DA 7545                    	jne	short chk_8khz
   527 000002DC 803D[3A370000]08        	cmp	byte [WAVE_BitsPerSample], 8
   528 000002E3 7615                    	jna	short chk_16khz_1
   529 000002E5 BB[E5150000]            	mov	ebx, load_16khz_stereo_16_bit
   530 000002EA 803D[2E370000]01        	cmp	byte [WAVE_NumChannels], 1 
   531 000002F1 751A                    	jne	short chk_16khz_2
   532 000002F3 BB[5E150000]            	mov	ebx, load_16khz_mono_16_bit
   533 000002F8 EB13                    	jmp	short chk_16khz_2
   534                                  chk_16khz_1:
   535 000002FA BB[9E140000]            	mov	ebx, load_16khz_stereo_8_bit
   536 000002FF 803D[2E370000]01        	cmp	byte [WAVE_NumChannels], 1
   537 00000306 7505                    	jne	short chk_16khz_2
   538 00000308 BB[19140000]            	mov	ebx, load_16khz_mono_8_bit
   539                                  chk_16khz_2:
   540                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   541 0000030D B855150000              	mov	eax, 5461
   542                                  	; 17/11/2024
   543                                  	;mov	ax, 5460
   544 00000312 BA03000000              	mov	edx, 3
   545 00000317 B901000000              	mov	ecx, 1
   546 0000031C E9F8000000              	jmp	set_sizes
   547                                  chk_8khz:
   548 00000321 663D401F                	cmp	ax, 8000
   549 00000325 7545                    	jne	short chk_24khz
   550 00000327 803D[3A370000]08        	cmp	byte [WAVE_BitsPerSample], 8
   551 0000032E 7615                    	jna	short chk_8khz_1
   552 00000330 BB[C8120000]            	mov	ebx, load_8khz_stereo_16_bit
   553 00000335 803D[2E370000]01        	cmp	byte [WAVE_NumChannels], 1
   554 0000033C 751A                    	jne	short chk_8khz_2
   555 0000033E BB[F2110000]            	mov	ebx, load_8khz_mono_16_bit
   556 00000343 EB13                    	jmp	short chk_8khz_2
   557                                  chk_8khz_1:
   558 00000345 BB[BC100000]            	mov	ebx, load_8khz_stereo_8_bit
   559 0000034A 803D[2E370000]01        	cmp	byte [WAVE_NumChannels], 1 
   560 00000351 7505                    	jne	short chk_8khz_2
   561 00000353 BB[CE0F0000]            	mov	ebx, load_8khz_mono_8_bit
   562                                  chk_8khz_2:
   563 00000358 B8AA0A0000              	mov	eax, 2730
   564 0000035D BA06000000              	mov	edx, 6
   565 00000362 B901000000              	mov	ecx, 1
   566 00000367 E9AD000000              	jmp	set_sizes
   567                                  chk_24khz:
   568 0000036C 663DC05D                	cmp	ax, 24000
   569 00000370 7561                    	jne	short chk_32khz
   570 00000372 803D[3A370000]08        	cmp	byte [WAVE_BitsPerSample], 8
   571 00000379 7613                    	jna	short chk_24khz_1
   572 0000037B 66BB[2718]              	mov	bx, load_24khz_stereo_16_bit
   573 0000037F 803D[2E370000]01        	cmp	byte [WAVE_NumChannels], 1 
   574 00000386 7519                    	jne	short chk_24khz_2
   575 00000388 66BB[BE17]              	mov	bx, load_24khz_mono_16_bit
   576 0000038C EB13                    	jmp	short chk_24khz_2
   577                                  chk_24khz_1:
   578 0000038E BB[2E170000]            	mov	ebx, load_24khz_stereo_8_bit
   579 00000393 803D[2E370000]01        	cmp	byte [WAVE_NumChannels], 1 
   580 0000039A 7505                    	jne	short chk_24khz_2
   581 0000039C BB[C1160000]            	mov	ebx, load_24khz_mono_8_bit
   582                                  chk_24khz_2:
   583                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   584 000003A1 B800200000              	mov	eax, 8192
   585                                  	; 17/11/2024
   586                                  	;mov	ax, 8190
   587 000003A6 BA02000000              	mov	edx, 2
   588 000003AB B901000000              	mov	ecx, 1
   589 000003B0 EB67                    	jmp	short set_sizes
   590                                  
   591                                  	; 07/12/2024
   592                                  vra_needed:
   593                                  	; 30/11/2024 (TRDOS 386, ax -> eax)
   594                                  	; 13/11/2023
   595 000003B2 58                      	pop	eax ; discard return address to the caller
   596                                  	; 30/05/2024
   597                                  vra_err:
   598                                  	; 21/12/2024
   599 000003B3 E89A010000              	call	set_text_mode
   600                                  	; 30/11/2024
   601                                  	sys	_msg, msg_no_vra, 255, 0Fh
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000003B8 BB[042D0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000003BD B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000003C2 BA0F000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000003C7 B823000000          <1>  mov eax, %1
   106                              <1> 
   107 000003CC CD40                <1>  int 40h
   602 000003CE E9E6000000              	jmp	Exit
   603                                  
   604                                  chk_32khz:
   605 000003D3 663D007D                	cmp	ax, 32000
   606 000003D7 75D9                    	jne	short vra_needed
   607 000003D9 803D[3A370000]08        	cmp	byte [WAVE_BitsPerSample], 8
   608 000003E0 7615                    	jna	short chk_32khz_1
   609 000003E2 BB[401A0000]            	mov	ebx, load_32khz_stereo_16_bit
   610 000003E7 803D[2E370000]01        	cmp	byte [WAVE_NumChannels], 1
   611 000003EE 751A                    	jne	short chk_32khz_2
   612 000003F0 BB[D0190000]            	mov	ebx, load_32khz_mono_16_bit
   613 000003F5 EB13                    	jmp	short chk_32khz_2
   614                                  chk_32khz_1:
   615 000003F7 BB[2D190000]            	mov	ebx, load_32khz_stereo_8_bit
   616 000003FC 803D[2E370000]01        	cmp	byte [WAVE_NumChannels], 1
   617 00000403 7505                    	jne	short chk_32khz_2
   618 00000405 BB[B4180000]            	mov	ebx, load_32khz_mono_8_bit
   619                                  chk_32khz_2:
   620                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   621 0000040A B8AA2A0000              	mov	eax, 10922
   622                                  	; 17/11/2024
   623                                  	;mov	ax, 10920
   624 0000040F BA03000000              	mov	edx, 3
   625 00000414 B902000000              	mov	ecx, 2
   626                                  	;jmp	short set_sizes
   627                                  set_sizes:
   628                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   629                                  	;;;
   630                                  	; 17/11/2024
   631 00000419 51                      	push	ecx
   632 0000041A B102                    	mov	cl, 2
   633 0000041C 2A0D[AA370000]          	sub	cl, [fbs_shift]
   634                                  		; = 2 for 16 bit stereo
   635                                  		; = 1 for 16 bit mono or 8 bit stereo
   636                                  		; = 0 for 8 bit mono
   637 00000422 D3E0                    	shl	eax, cl
   638 00000424 59                      	pop	ecx	
   639 00000425 A3[BC370000]            	mov	[loadsize], eax	; (one) read count in bytes
   640                                  	;;;
   641 0000042A F7E2                    	mul	edx
   642 0000042C 83F901                  	cmp	ecx, 1
   643 0000042F 7402                    	je	short s_2
   644                                  s_1:
   645 00000431 F7F1                    	div	ecx
   646                                  s_2:
   647                                  	;;;
   648                                  	; eax = byte count of (to be) converted samples 
   649                                  	
   650                                  	; 17/11/2024
   651                                  	;;;
   652 00000433 8A0D[AA370000]          	mov	cl, [fbs_shift]
   653                                  
   654 00000439 D3E0                    	shl	eax, cl
   655                                  		; *1 for 16 bit stereo
   656                                  		; *2 for 16 bit mono or 8 bit stereo
   657                                  		; *4 for for 8 bit mono
   658                                  	;;;
   659                                  
   660                                  	; eax = 16 bit stereo byte count (target buffer size)
   661                                  	
   662                                  	; 07/12/2024
   663                                  	;shr	eax, 1	; buffer size is 16 bit sample count
   664 0000043B A3[C0370000]            	mov	[buffersize], eax ; buffer size in bytes
   665 00000440 891D[B8370000]          	mov	[loadfromwavfile], ebx
   666                                  
   667                                  ; -------------------------------------------------------------
   668                                  
   669                                  	; 30/12/2024
   670                                  Player_Template:
   671                                  	; 21/12/2024
   672 00000446 E8DF000000              	call	clearscreen
   673 0000044B E8E9000000              	call	drawplayingscreen
   674                                  
   675                                  	; 14/11/2024
   676 00000450 E8A0240000              	call	SetTotalTime
   677 00000455 E864250000              	call	UpdateFileInfo
   678                                  
   679                                  ; -------------------------------------------------------------
   680                                  
   681                                  	; 30/12/2024 (cgaplay.s)
   682                                  	; 29/12/2024 (vgaplay3.s)
   683                                  	; 18/12/2024 (ac97play.s)
   684                                  PlayNow:
   685                                  	; 01/12/2024 (32bit)
   686                                  	; 14/11/2024
   687                                  	;mov	al, 3	; 0 = max, 31 = min
   688                                  	; 14/12/2024
   689 0000045A A0[ED280000]            	mov	al, [volume]
   690 0000045F E80F030000              	call	SetPCMOutVolume@
   691                                  	; 15/11/2024
   692                                  	;;call	SetMasterVolume
   693                                  	;call	SetPCMOutVolume
   694                                  
   695                                  	;;;
   696                                  	; 14/11/2024
   697 00000464 E81F260000              	call	UpdateProgressBar
   698                                  	;;;
   699                                  
   700                                   	; 30/05/2024
   701                                  	; playwav4.asm
   702                                  _2:	
   703 00000469 E81C240000              	call	check4keyboardstop	; flush keyboard buffer
   704 0000046E 72F9                    	jc	short _2		; 07/11/2023
   705                                  
   706                                  ; play the .wav file. Most of the good stuff is in here.
   707                                  
   708                                  	; 05/12/2024
   709                                  	; 02/12/2024
   710                                  	;mov	eax, [_bdl_buffer]	; BDL_BUFFER physical address
   711                                  ;_3:
   712 00000470 E8EA000000              	call    PlayWav
   713                                  
   714                                  	; 30/12/2024
   715                                  	; 29/12/2024 (vgaplay3.s)
   716                                  	; 27/12/2024 (vgaplay.s)
   717                                  _3:
   718                                  
   719                                  ; close the .wav file and exit.
   720                                  
   721                                  	; 25/12/2024
   722 00000475 E878030000              	call	closeFile
   723                                  
   724                                  	; 25/12/2024
   725                                  	;;;
   726                                  	; reset file loading and EOF parameters
   727                                  	; 18/12/2024
   728 0000047A C705[CC370000]0000-     	mov	dword [count], 0
   728 00000482 0000               
   729 00000484 C705[D0370000]0000-     	mov	dword [LoadedDataBytes], 0
   729 0000048C 0000               
   730 0000048E C605[46370000]00        	mov	byte [flags], 0
   731 00000495 C605[08370000]00        	mov	byte [stopped], 0
   732                                  	; 29/12/2024
   733 0000049C C705[10370000]0000-     	mov	dword [pbuf_s], 0
   733 000004A4 0000               
   734                                  	;;;
   735                                  
   736 000004A6 803D[16370000]51        	cmp	byte [command], 'Q'
   737 000004AD 7405                    	je	short terminate
   738 000004AF E9E4FBFFFF              	jmp	check_p_command
   739                                  
   740                                  terminate:
   741 000004B4 E899000000              	call	set_text_mode
   742                                  Exit:
   743                                  	sys	_exit
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97                              <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99                              <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101                              <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000004B9 B801000000          <1>  mov eax, %1
   106                              <1> 
   107 000004BE CD40                <1>  int 40h
   744                                  halt:
   745 000004C0 EBFE                    	jmp	short halt
   746                                  
   747                                  ; -------------------------------------------------------------
   748                                  
   749                                  	; 30/05/2024
   750                                  pmsg_usage:
   751                                  	; 21/12/2024
   752 000004C2 E88B000000              	call	set_text_mode
   753                                  	; 01/12/2024
   754                                  	sys	_msg, msg_usage, 255, 0Fh
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000004C7 BB[3F2C0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000004CC B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000004D1 BA0F000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000004D6 B823000000          <1>  mov eax, %1
   106                              <1> 
   107 000004DB CD40                <1>  int 40h
   755 000004DD EBDA                    	jmp	short Exit
   756                                  
   757                                  ; -------------------------------------------------------------
   758                                  
   759                                  	; 30/05/2024
   760                                  init_err:
   761                                  	; 21/12/2024
   762 000004DF E86E000000              	call	set_text_mode
   763                                  	; 01/12/2024
   764                                  	sys	_msg, msg_init_err, 255, 0Fh
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000004E4 BB[D32C0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000004E9 B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000004EE BA0F000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000004F3 B823000000          <1>  mov eax, %1
   106                              <1> 
   107 000004F8 CD40                <1>  int 40h
   765 000004FA EBBD                    	jmp	short Exit
   766                                  
   767                                  ; -------------------------------------------------------------
   768                                  
   769                                  	; 07/12/2024
   770                                  error_exit:
   771                                  	; 21/12/2024
   772 000004FC E851000000              	call	set_text_mode
   773                                  trdos386_error:
   774                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00000501 BB[B32C0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000506 B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 0000050B BA0E000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000510 B823000000          <1>  mov eax, %1
   106                              <1> 
   107 00000515 CD40                <1>  int 40h
   775 00000517 EBA0                    	jmp	short Exit
   776                                  
   777                                  ; -------------------------------------------------------------
   778                                  
   779                                  	; 21/12/2024
   780                                  print_msg:
   781 00000519 B40E                    	mov	ah, 0Eh
   782 0000051B BB07000000              	mov	ebx, 7
   783                                  	;mov	bl, 7 ; char attribute & color
   784                                  p_next_chr:
   785 00000520 AC                      	lodsb
   786 00000521 08C0                    	or	al, al
   787 00000523 7404                    	jz	short p_retn ; retn
   788 00000525 CD31                    	int	31h
   789 00000527 EBF7                    	jmp	short p_next_chr
   790                                  p_retn:
   791 00000529 C3                      	retn
   792                                  
   793                                  ; -------------------------------------------------------------
   794                                  
   795                                  	; 30/12/2024
   796                                  clearscreen:
   797                                  	; fast clear
   798                                  	; 320*200, 256 colors
   799 0000052A BF00000A00              	mov	edi, 0A0000h
   800 0000052F B9803E0000              	mov	ecx, (320*200*1)/4
   801 00000534 31C0                    	xor	eax, eax
   802 00000536 F3AB                    	rep	stosd
   803 00000538 C3                      	retn
   804                                  
   805                                  ; -------------------------------------------------------------
   806                                  
   807                                  	; 31/12/2024 (int 31h)
   808                                  	; 30/12/2024 (VGA Mode 13h, 320*200 pixels, 256 colors)
   809                                  	; 26/12/2024
   810                                  	; 21/12/2024
   811                                  drawplayingscreen:
   812 00000539 BD[2C2E0000]            	mov	ebp, PlayingScreen
   813                                  
   814                                  ; 31/12/2024
   815                                  %if 0
   816                                  	;mov	esi, 0 ; row 0, column 0
   817                                  	mov	esi, 00020000h ; row 2, column 0 ; top margin = 2
   818                                  p_d_x:
   819                                  	mov	byte [columns], 40
   820                                  	mov	dh, 01h ; 8x8 system font
   821                                  p_d_x_n:
   822                                  	mov	dl, [ebp]
   823                                  	and	dl, dl
   824                                  	jz	short p_d_x_ok
   825                                  
   826                                  	; sysvideo system call
   827                                  	; BH = 01h = VGA graphics (0A0000h) data transfers
   828                                  	; BL = 0Fh = write character/font
   829                                  	; DH = 01h = 8*8 system font 
   830                                  	; CL = 0Fh = color (white)
   831                                  	; ESI = cursor/writing position (pixels)
   832                                  	;	HW = row, SI = column
   833                                  
   834                                  	sys	_video, 010Fh, 0Fh
   835                                  
   836                                  	inc	ebp
   837                                  	add	si, 8 ; next char pos
   838                                  	dec	byte [columns]
   839                                  	jnz	short p_d_x_n	; next column
   840                                  	xor	si, si
   841                                  	add	esi, 00080000h	; next row ; 8*8
   842                                  	jmp	short p_d_x
   843                                  p_d_x_ok:
   844                                  	retn
   845                                  %endif
   846                                  	; 31/12/2024
   847 0000053E B800130000              	mov	eax, 1300h ; write character string
   848 00000543 BB0F000000              	mov	ebx, 0Fh
   849 00000548 B9C0030000              	mov	ecx, 24*40
   850 0000054D 31D2                    	xor	edx, edx
   851                                  	;int	10h
   852 0000054F CD31                    	int	31h
   853                                  
   854 00000551 C3                      	retn
   855                                  
   856                                  ; -------------------------------------------------------------
   857                                  
   858                                  	; 21/12/2024
   859                                  set_text_mode:
   860 00000552 30E4                    	xor    ah, ah
   861 00000554 B003                    	mov    al, 3                        
   862                                   	;int   10h ; al = 03h text mode, int 10 video
   863 00000556 CD31                    	int    31h ; TRDOS 386 - Video interrupt
   864 00000558 C3                      	retn
   865                                  
   866                                  ; -------------------------------------------------------------
   867                                  
   868                                  	; 02/12/2024
   869                                  Player_Quit@:
   870 00000559 58                      	pop	eax ; return addr (call PlayWav@)
   871                                  	
   872                                  	; 29/11/2024
   873                                  Player_Quit:
   874 0000055A E955FFFFFF              	jmp	 terminate
   875                                  
   876                                  ; -------------------------------------------------------------
   877                                  
   878                                  	; 30/12/2024 (cgaplay.s)
   879                                  	; 29/12/2024 (vgaplay3.s)
   880                                  	; 02/12/2024 (ac97play.s)
   881                                  PlayWav:
   882                                  	; 30/12/2024
   883 0000055F A1[D8370000]            	mov	eax, [_bdl_buffer] ; BDL_BUFFER physical address
   884 00000564 09C0                    	or	eax, eax
   885 00000566 751D                    	jnz	short PlayWav@
   886                                  
   887                                  	; 29/05/2024
   888                                  	; Allocate memory block (33 pages)
   889                                  	sys	_alloc, BDL_BUFFER, 33*4096, 0	; no upper limit
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00000568 BB[00400000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 0000056D B900100200          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00000572 BA00000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000577 B82A000000          <1>  mov eax, %1
   106                              <1> 
   107 0000057C CD40                <1>  int 40h
   890                                  	;jc	short Player_Quit ; 01/12/2024
   891 0000057E 72D9                    	jc	short Player_Quit@ ; 02/12/2024
   892                                  
   893 00000580 A3[D8370000]            	mov	[_bdl_buffer], eax ; BDL_BUFFER physical address
   894                                  
   895                                  PlayWav@:
   896                                  	; create Buffer Descriptor List
   897                                  
   898                                  	;  Generic Form of Buffer Descriptor
   899                                  	;  ---------------------------------
   900                                  	;  63   62    61-48    47-32   31-0
   901                                  	;  ---  ---  --------  ------- -----
   902                                  	;  IOC  BUP -reserved- Buffer  Buffer
   903                                  	;		      Length   Pointer
   904                                  	;		      [15:0]   [31:0]
   905                                  
   906                                  	; 30/12/2024	
   907                                  
   908 00000585 0500100000              	add	eax, 4096	; WAVBUFFER_1 physical address
   909 0000058A 89C3                    	mov	ebx, eax
   910                                  	;mov	[wav_buffer1], eax
   911                                  	;add	eax, 65536	; WAVBUFFER_2 physical address
   912                                  	;mov	[wav_buffer2], eax
   913                                  
   914 0000058C BF[00400000]            	mov	edi, BDL_BUFFER
   915 00000591 B910000000              	mov	ecx, 16
   916                                  _pw0:
   917                                  	;mov	eax, WAVBUFFER_1
   918 00000596 89D8                    	mov	eax, ebx	; WAVBUFFER_1 physical address
   919 00000598 AB                      	stosd
   920                                  
   921 00000599 A1[C0370000]            	mov	eax, [buffersize]
   922                                  	; 02/12/2024
   923 0000059E D1E8                    	shr	eax, 1 ; buffer size in word
   924 000005A0 0D00000040              	or	eax, BUP	; tuneloop (without interrupt)
   925 000005A5 AB                      	stosd
   926                                  
   927                                  	;mov	eax, WAVBUFFER_2
   928 000005A6 89D8                    	mov	eax, ebx
   929 000005A8 0500000100              	add	eax, 65536	; WAVBUFFER_2 physical address
   930 000005AD AB                      	stosd
   931                                  
   932 000005AE A1[C0370000]            	mov	eax, [buffersize]
   933                                  	; 02/12/2024
   934 000005B3 D1E8                    	shr	eax, 1 ; buffer size in word
   935 000005B5 0D00000040              	or	eax, BUP	; tuneloop (without interrupt)
   936 000005BA AB                      	stosd
   937                                  
   938 000005BB E2D9                    	loop	_pw0
   939                                  
   940                                  	; 14/11/2024
   941                                  	;mov	dword [count], ecx ; 0
   942                                  	;mov	dword [LoadedDataBytes], 0
   943                                  
   944                                  RePlayWav:
   945                                  	; 01/12/2024
   946                                  	; load 64k into buffer 1
   947 000005BD BF[00500000]            	mov	edi, WAVBUFFER_1
   948 000005C2 FF15[B8370000]          	call	dword [loadfromwavfile]
   949                                  	; 01/12/2024
   950                                  	; 14/11/2024
   951 000005C8 A1[CC370000]            	mov	eax, [count]
   952 000005CD 0105[D0370000]          	add	[LoadedDataBytes], eax
   953                                  
   954                                  	; 18/12/2024
   955 000005D3 C705[CC370000]0000-     	mov	dword [count], 0
   955 000005DB 0000               
   956                                  
   957                                  	; and 64k into buffer 2
   958 000005DD BF[00500100]            	mov	edi, WAVBUFFER_2
   959 000005E2 FF15[B8370000]          	call	dword [loadfromwavfile]
   960                                  	; 01/12/2024
   961                                  	; 14/11/2024
   962 000005E8 A1[CC370000]            	mov	eax, [count]
   963 000005ED 0105[D0370000]          	add	[LoadedDataBytes], eax
   964                                  	
   965                                  	; write NABMBAR+10h with offset of buffer descriptor list
   966                                  
   967                                         	;;mov	eax, BDL_BUFFER
   968                                          ;mov	eax, esi	; BDL_BUFFER physical address
   969                                  
   970                                  	;mov	eax, [_bdl_buffer] ; BDL_BUFFER physical address
   971                                  	; 02/12/2024
   972 000005F3 8B1D[D8370000]          	mov	ebx, [_bdl_buffer]
   973                                  
   974 000005F9 668B15[B6370000]        	mov	dx, [NABMBAR]
   975 00000600 6683C210                        add     dx, PO_BDBAR_REG	; set pointer to BDL
   976                                  	;out	dx, eax 		; write to AC97 controller
   977                                  	; 29/05/2024
   978                                  	;mov	ebx, eax ; data, dword
   979                                  	; 02/12/2024
   980                                  	; ebx = [_bdl_buffer] ; data, dword
   981 00000604 B405                    	mov	ah, 5	; write port dword
   982 00000606 CD34                    	int	34h
   983                                  
   984                                  	; 31/05/2024
   985                                  	; 19/05/2024
   986                                  	;call	delay1_4ms
   987                                  
   988 00000608 B01F                            mov	al, 31
   989 0000060A E8D1060000              	call	setLastValidIndex
   990                                  
   991                                  	; 31/05/2024
   992                                  	; 19/05/2024
   993                                  	;call	delay1_4ms
   994                                  
   995                                  	; 17/02/2017
   996 0000060F 668B15[B6370000]                mov	dx, [NABMBAR]
   997 00000616 6683C21B                        add	dx, PO_CR_REG		; PCM out Control Register
   998                                          ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   999                                  	;			; (LVBI interrupt will not be enabled)
  1000                                  	; 06/11/2023 (TUNELOOP version, without interrupt)
  1001 0000061A B001                    	mov	al, RPBM
  1002                                  	;out	dx, al			; Start bus master operation.
  1003                                  	; 29/05/2024
  1004                                  	; al = data, byte
  1005 0000061C B401                    	mov	ah, 1 ; write port, byte
  1006 0000061E CD34                    	int	34h
  1007                                  
  1008                                  	; 30/12/2024
  1009                                  
  1010                                  ; -------------------------------------------
  1011                                  
  1012                                  	; 30/12/2024 (cgaplay.s)
  1013                                  	; 29/12/2024 (vgaplay3.s)
  1014                                  	; 18/12/2024 (ac97play.s)
  1015                                  	; 01/12/2024 (32bit)
  1016                                  	; 29/11/2024
  1017                                  tuneLoop:
  1018                                  	; 30/05/2024
  1019                                  	; 18/11/2023 (ich_wav4.asm)
  1020                                  	; 08/11/2023
  1021                                  	; 06/11/2023
  1022                                  tLWait:
  1023                                  	; 18/11/2024
  1024 00000620 803D[08370000]00        	cmp	byte [stopped], 0
  1025                                  	;jna	short tL@
  1026                                  	; 21/11/2024
  1027 00000627 7718                    	ja	short tLWait@
  1028 00000629 A0[0A370000]            	mov	al, [tLP]
  1029 0000062E 3C31                    	cmp	al, '1'
  1030 00000630 7458                    	je	short tL1@
  1031 00000632 0F87A3000000            	ja	tL2@
  1032 00000638 B031                    	mov	al, '1'
  1033 0000063A A2[0A370000]            	mov	[tLP], al
  1034 0000063F EB49                    	jmp	short tL1@ 
  1035                                  tLWait@:	; 21/11/2024
  1036                                  	;;;
  1037                                  	; 09/12/2024
  1038 00000641 803D[08370000]03        	cmp	byte [stopped], 3
  1039 00000648 0F83DF000000            	jnb	_exitt_
  1040                                  	;;;
  1041 0000064E E879200000              	call	checkUpdateEvents
  1042 00000653 0F82D4000000            	jc	_exitt_
  1043                                  	;;;
  1044                                  	; 29/11/2024
  1045 00000659 803D[16370000]4E        	cmp	byte [command], 'N'
  1046 00000660 0F84C7000000            	je	_exitt_
  1047 00000666 803D[16370000]50        	cmp	byte [command], 'P'
  1048 0000066D 0F84BA000000            	je	_exitt_
  1049                                  	;;;
  1050 00000673 803D[09370000]30        	cmp	byte [tLO], '0'
  1051 0000067A 74A4                    	je	short tLWait
  1052 0000067C E8B6000000              	call	tLZ
  1053 00000681 C605[09370000]30        	mov	byte [tLO], '0'
  1054 00000688 EB96                    	jmp	short tLWait
  1055                                  
  1056                                  ;tLO:	db 0
  1057                                  	
  1058                                  tL1@:
  1059                                  	;mov	al, '1'
  1060                                  	; 19/11/2024
  1061 0000068A A2[09370000]            	mov	[tLO], al
  1062 0000068F E8A5000000              	call	tL0
  1063                                  tL1:
  1064 00000694 E80A060000              	call	updateLVI	; /set LVI != CIV/
  1065 00000699 0F848E000000            	jz	_exitt_		; 08/11/2023
  1066                                  	;;;
  1067                                  	;call	check4keyboardstop
  1068                                  	; 14/11/2024
  1069 0000069F E828200000              	call	checkUpdateEvents
  1070 000006A4 0F8283000000            	jc	_exitt_
  1071                                  	; 18/11/2024
  1072 000006AA 803D[08370000]00        	cmp	byte [stopped], 0
  1073 000006B1 778E                    	ja	short tLWait@	; 21/11/2024
  1074                                  	;;;
  1075 000006B3 E8DB050000              	call	getCurrentIndex
  1076 000006B8 A801                    	test	al, BIT0
  1077 000006BA 74D8                    	jz	short tL1	; loop if buffer 2 is not playing
  1078                                  
  1079                                  	; load buffer 1
  1080                                  	;mov	ax, [WAV_BUFFER1]
  1081                                  	; 01/12/2024
  1082 000006BC BF[00500000]            	mov	edi, WAVBUFFER_1	
  1083                                  
  1084                                  	;call	loadFromFile
  1085                                  	; 18/11/2023
  1086                                  	;call	word [loadfromwavfile]
  1087                                  	; 01/12/2024
  1088 000006C1 FF15[B8370000]          	call	dword [loadfromwavfile]
  1089 000006C7 7264                    	jc	short _exitt_	; end of file
  1090                                  
  1091                                  	; 14/11/2024
  1092                                  	;mov	ax, [count]
  1093                                  	;add	[LoadedDataBytes], ax
  1094                                  	;adc	word [LoadedDataBytes+2], 0
  1095                                  	; 01/12/2024
  1096 000006C9 A1[CC370000]            	mov	eax, [count]
  1097 000006CE 0105[D0370000]          	add	[LoadedDataBytes], eax
  1098                                  
  1099 000006D4 B032                    	mov	al, '2'
  1100                                  	; 21/11/2024
  1101 000006D6 A2[0A370000]            	mov	[tLP], al
  1102                                  tL2@:
  1103                                  	; 19/11/2024
  1104 000006DB A2[09370000]            	mov	[tLO], al
  1105 000006E0 E854000000              	call	tL0
  1106                                  tL2:
  1107 000006E5 E8B9050000              	call    updateLVI
  1108 000006EA 7441                    	jz	short _exitt_	; 08/11/2023
  1109                                  	;;;
  1110                                  	;call	check4keyboardstop
  1111                                  	; 14/11/2024
  1112 000006EC E8DB1F0000              	call	checkUpdateEvents
  1113 000006F1 723A                    	jc	short _exitt_
  1114                                  	; 18/11/2024
  1115 000006F3 803D[08370000]00        	cmp	byte [stopped], 0
  1116 000006FA 0F8741FFFFFF            	ja	tLWait@		; 21/11/2024 
  1117                                  	;;;
  1118 00000700 E88E050000              	call    getCurrentIndex
  1119 00000705 A801                    	test	al, BIT0
  1120 00000707 75DC                    	jnz	short tL2	; loop if buffer 1 is not playing
  1121                                  
  1122                                  	; load buffer 2
  1123                                  	;mov	ax, [WAV_BUFFER2]
  1124                                  	; 01/12/2024
  1125 00000709 BF[00500100]            	mov	edi, WAVBUFFER_2
  1126                                  	;call	loadFromFile
  1127                                  	; 18/11/2023
  1128                                  	;call	word [loadfromwavfile]
  1129                                  	; 01/12/2024
  1130 0000070E FF15[B8370000]          	call	dword [loadfromwavfile]
  1131                                  	;jnc	short tuneLoop
  1132 00000714 7217                    	jc	short _exitt_
  1133                                  
  1134                                  	; 14/11/2024
  1135                                  	;mov	ax, [count]
  1136                                  	;add	[LoadedDataBytes], ax
  1137                                  	;adc	word [LoadedDataBytes+2], 0
  1138                                  	; 01/12/2024
  1139 00000716 A1[CC370000]            	mov	eax, [count]
  1140 0000071B 0105[D0370000]          	add	[LoadedDataBytes], eax	
  1141                                  
  1142                                  	; 21/11/2024
  1143 00000721 C605[0A370000]31        	mov	byte [tLP], '1'
  1144 00000728 E9F3FEFFFF              	jmp	tuneLoop
  1145                                  
  1146                                  	; 29/12/2024 (vgaplay3.s)
  1147                                  _exitt_:
  1148                                  	; 07/12/2024
  1149                                  	; Stop Playing
  1150                                  	;mov	byte [stopped], 2
  1151                                  	;sys	_audio, 0700h
  1152 0000072D E8F3040000              	call	ac97_stop
  1153                                  
  1154                                  	;;;
  1155                                  	; 14/11/2024
  1156 00000732 E851230000              	call	UpdateProgressBar
  1157                                  	;;;
  1158                                  
  1159                                  	; 18/11/2024
  1160                                  tLZ:
  1161                                  	; 30/05/2024
  1162 00000737 B030                    	mov	al, '0'
  1163                                  
  1164                                  	;add	al, '0'
  1165                                  	;call	tL0
  1166                                  	;
  1167                                  	;retn
  1168                                  	; 06/11/2023
  1169                                  	;jmp	short tL0
  1170                                  	;retn
  1171                                  
  1172                                  tL0:
  1173                                  	; 31/12/2024 (int 31h)
  1174                                  	; 30/12/2024 (cgaplay.s)
  1175                                  	; 29/05/2024 (TRDOS 386)
  1176                                  	; 08/11/2023
  1177                                  	; 05/11/2023
  1178                                  	; 17/02/2017 - Buffer switch test (temporary)
  1179                                  	; 06/11/2023
  1180                                  	; al = buffer indicator ('1', '2' or '0' -stop- )
  1181                                  
  1182                                  	; 30/12/2024 (video mode 13h modification)
  1183                                  	; (320*200, 256 colors)
  1184                                  	;;;
  1185 00000739 88C2                    	mov	dl, al ; character
  1186 0000073B BF00000A00              	mov	edi, 0A0000h
  1187                                  
  1188 00000740 BB08000000              	mov	ebx, 8 ; 8 pixels (8*8 pixels font)
  1189                                  
  1190 00000745 B00C                    	mov	al, 0Ch ; red
  1191                                  tL0_1:
  1192                                  	;mov	ecx, 8 ; 8 pixels (8*8 pixels font)
  1193 00000747 B907000000              	mov	ecx, 7
  1194                                  tL0_2:
  1195 0000074C AA                      	stosb
  1196 0000074D 49                      	dec	ecx
  1197 0000074E 75FC                    	jnz	short tL0_2
  1198 00000750 4B                      	dec	ebx
  1199 00000751 7408                    	jz	short tL0_3
  1200                                  	;add	edi, 320-8 ; next line
  1201 00000753 81C739010000            	add	edi, 320-7
  1202 00000759 EBEC                    	jmp	short tL0_1
  1203                                  tL0_3:
  1204                                  
  1205                                  ; 31/12/2024
  1206                                  %if 0
  1207                                  	; write system font
  1208                                  	mov	dh, 01h
  1209                                  	;mov	dl, al ; character
  1210                                  	xor	esi, esi ; = row 0, column 0
  1211                                  	sys	_video, 010Fh, 0Eh ; yellow
  1212                                  	;;;
  1213                                  %endif
  1214                                  	; 31/12/2024
  1215 0000075B 52                      	push	edx
  1216 0000075C 31D2                    	xor	edx, edx ; row 0, column 0
  1217 0000075E E88B210000              	call	setCursorPosition
  1218 00000763 58                      	pop	eax
  1219                                  	;
  1220 00000764 B40E                    	mov	ah, 0Eh
  1221 00000766 BB0E000000              	mov	ebx, 0Eh
  1222                                  	;int	10h
  1223 0000076B CD31                    	int	31h
  1224                                  	
  1225 0000076D C3                      	retn
  1226                                  
  1227                                  ; -------------------------------------------
  1228                                  
  1229                                  	; 29/12/2024 (vgaplay3.s)
  1230                                  	; 18/12/2024 (ac97play.s)
  1231                                  	; 14/11/2024
  1232                                  ;SetMasterVolume:
  1233                                  	; 15/11/2024
  1234                                  SetPCMOutVolume:
  1235                                  	;cmp	al, 31
  1236                                  	;ja	short setvolume_ok
  1237 0000076E A2[ED280000]            	mov	[volume], al  ; max = 0, min = 31
  1238                                  SetPCMOutVolume@:	; 19/11/2024
  1239 00000773 88C4                    	mov	ah, al
  1240 00000775 668B15[B4370000]        	mov	dx, [NAMBAR]
  1241                                  	; 15/11/2024 (QEMU)
  1242                                    	;add	dx, CODEC_MASTER_VOL_REG
  1243 0000077C 6683C218                	add	dx, CODEC_PCM_OUT_REG
  1244                                  	;out	dx, ax
  1245                                  	; 01/12/2024
  1246                                  	; bx = data, word
  1247                                  	; 03/12/2024
  1248 00000780 89C3                    	mov	ebx, eax
  1249 00000782 B403                    	mov	ah, 3  ; write port, word
  1250 00000784 CD34                    	int	34h
  1251                                  ;setvolume_ok:
  1252 00000786 C3                      	retn
  1253                                  
  1254                                  ; -------------------------------------------
  1255                                  
  1256                                  	; 29/12/2024 (vgaplay3.s)
  1257                                  	; 18/12/2024 (ac97play.s)
  1258                                  	; 30/05/2024
  1259                                  DetectAC97:
  1260                                  DetectICH:
  1261                                  	; 22/11/2023
  1262                                  	; 19/11/2023
  1263                                  	; 01/11/2023 - TRDOS 386 Kernel v2.0.7
  1264                                  	;; 10/06/2017
  1265                                  	;; 05/06/2017
  1266                                  	;; 29/05/2017
  1267                                  	;; 28/05/2017
  1268                                  
  1269                                  	; 01/12/2024
  1270                                  	; 19/11/2023
  1271 00000787 BE[742B0000]            	mov	esi, valid_ids	; address of Valid ICH (AC97) Device IDs
  1272 0000078C B915000000              	mov	ecx, valid_id_count
  1273                                  pfd_1:
  1274 00000791 AD                      	lodsd
  1275 00000792 E8A8000000              	call	pciFindDevice
  1276 00000797 7303                    	jnc	short d_ac97_1
  1277 00000799 E2F6                    	loop	pfd_1
  1278                                  
  1279                                  	;stc
  1280 0000079B C3                      	retn
  1281                                  
  1282                                  d_ac97_1:
  1283                                  	; eax = BUS/DEV/FN
  1284                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1285                                  	; edx = DEV/VENDOR
  1286                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1287                                  
  1288                                  	; playwav4.asm - 19/05/2024
  1289                                  
  1290 0000079C A3[AC370000]            	mov	[bus_dev_fn], eax
  1291 000007A1 8915[B0370000]          	mov	[dev_vendor], edx
  1292                                  
  1293                                  	; get ICH base address regs for mixer and bus master
  1294                                  
  1295 000007A7 B010                            mov     al, NAMBAR_REG
  1296 000007A9 E81F010000                      call    pciRegRead16			; read PCI registers 10-11
  1297                                          ;and    dx, IO_ADDR_MASK 		; mask off BIT0
  1298                                  	; 19/05/2024
  1299 000007AE 80E2FE                  	and	dl, 0FEh
  1300                                  
  1301 000007B1 668915[B4370000]                mov     [NAMBAR], dx			; save audio mixer base addr
  1302                                  
  1303 000007B8 B014                    	mov     al, NABMBAR_REG
  1304 000007BA E80E010000                      call    pciRegRead16
  1305                                          ;and    dx, IO_ADDR_MASK
  1306                                  	; 19/05/2024
  1307 000007BF 80E2C0                  	and	dl, 0C0h
  1308                                  
  1309 000007C2 668915[B6370000]                mov     [NABMBAR], dx			; save bus master base addr
  1310                                  
  1311 000007C9 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
  1312 000007CB E8F6000000              	call	pciRegRead8 ; 17/02/2017
  1313                                  	
  1314 000007D0 8815[47370000]          	mov	[ac97_int_ln_reg], dl
  1315                                  
  1316                                  	;clc
  1317                                  
  1318 000007D6 C3                      	retn
  1319                                  
  1320                                  ; ----------------------------------
  1321                                  	
  1322                                  	; 26/12/2024
  1323                                  	; 07/12/2024
  1324                                  	; 01/12/2024
  1325                                  	; 14/11/2024
  1326                                  	; INPUT: ds:dx = file name address
  1327                                  	; OUTPUT: [filehandle] = ; -1 = not open
  1328                                  openFile:
  1329                                  	; 26/12/2024
  1330                                  	; 01/12/2024
  1331                                  	sys	_open, edx, 0
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000007D7 89D3                <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000007D9 B900000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101                              <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000007DE B805000000          <1>  mov eax, %1
   106                              <1> 
   107 000007E3 CD40                <1>  int 40h
  1332                                  	; 07/12/2024
  1333                                  	;sys	_open, wav_file_name, 0
  1334 000007E5 7305                    	jnc	short _of1
  1335                                  
  1336 000007E7 B8FFFFFFFF              	mov	eax, -1
  1337                                  	; cf = 1 -> not found or access error
  1338                                  _of1:
  1339 000007EC A3[48370000]            	mov	[filehandle], eax
  1340 000007F1 C3                      	retn
  1341                                  
  1342                                  ; ----------------------------------
  1343                                  
  1344                                  ; close the currently open file
  1345                                  
  1346                                  	; 01/12/2024
  1347                                  	; 14/11/2024
  1348                                  	; INPUT: [filehandle] ; -1 = not open
  1349                                  	; OUTPUT: none
  1350                                  closeFile:
  1351 000007F2 833D[48370000]FF        	cmp	dword [filehandle], -1
  1352 000007F9 740D                    	jz	short _cf1
  1353                                  	; 01/12/2024
  1354                                  	sys	_close, [filehandle]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000007FB 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99                              <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101                              <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000801 B806000000          <1>  mov eax, %1
   106                              <1> 
   107 00000806 CD40                <1>  int 40h
  1355                                  	;mov 	dword [filehandle], -1
  1356                                  _cf1:
  1357 00000808 C3                      	retn
  1358                                  
  1359                                  ; ----------------------------------
  1360                                  
  1361                                  	; 01/12/2024
  1362                                  	; 14/11/2024 - Erdogan Tan
  1363                                  getWAVParameters:
  1364                                  ; reads WAV file header(s) (44 bytes) from the .wav file.
  1365                                  ; entry: none - assumes file is already open
  1366                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
  1367                                  ;	cx = number of channels (mono=1, stereo=2)
  1368                                  ;	dx = bits per sample (8, 16)
  1369                                  ;	bx = number of bytes per sample (1 to 4)
  1370                                  
  1371                                          ;mov	dx, WAVFILEHEADERbuff
  1372                                  	;mov	bx, [filehandle]
  1373                                          ;mov	cx, 44			; 44 bytes
  1374                                  	;mov	ah, 3Fh
  1375                                          ;int	21h
  1376                                  	;jc	short gwavp_retn
  1377                                  	; 01/12/2024 (TRDOS 386)
  1378                                  	sys	_read, [filehandle], WAVFILEHEADERbuff, 44
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00000809 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 0000080F B9[18370000]        <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00000814 BA2C000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000819 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 0000081E CD40                <1>  int 40h
  1379 00000820 721C                    	jc	short gwavp_retn
  1380                                  
  1381 00000822 83F82C                  	cmp	eax, 44
  1382 00000825 7217                    	jb	short gwavp_retn
  1383                                  
  1384 00000827 813D[20370000]5741-     	cmp	dword [RIFF_Format], 'WAVE'
  1384 0000082F 5645               
  1385 00000831 750A                    	jne	short gwavp_stc_retn
  1386                                  
  1387 00000833 66833D[2C370000]01      	cmp	word [WAVE_AudioFormat], 1 ; Offset 20, must be 1 (= PCM)
  1388                                  	;jne	short gwavp_stc_retn
  1389 0000083B 7401                    	je	short gwavp_retn ; 15/11/2024
  1390                                  
  1391                                  	; 15/11/2024
  1392                                  	;mov	cx, [WAVE_NumChannels]	; return num of channels in CX
  1393                                          ;mov    ax, [WAVE_SampleRate]	; return sample rate in AX
  1394                                  	;mov	dx, [WAVE_BitsPerSample] 
  1395                                  					; return bits per sample value in DX
  1396                                  	;mov	bx, [WAVE_BlockAlign]	; return bytes per sample in BX
  1397                                  ;gwavp_retn:
  1398                                          ;retn
  1399                                  
  1400                                  gwavp_stc_retn:
  1401 0000083D F9                      	stc
  1402                                  gwavp_retn:
  1403 0000083E C3                      	retn
  1404                                  
  1405                                  
  1406                                  ; 29/12/2024 (vgaplay3.s)
  1407                                  ; 18/12/2024 (ac97play.s)
  1408                                  ; --------------------------------------------------------
  1409                                  ; 27/05/2024 - (TRDOS 386 Kernel) audio.s
  1410                                  ; --------------------------------------------------------
  1411                                  
  1412                                  NOT_PCI32_PCI16	EQU 03FFFFFFFh ; NOT BIT31+BIT30 ; 19/03/2017
  1413                                  NOT_BIT31 EQU 7FFFFFFFh
  1414                                  
  1415                                  pciFindDevice:
  1416                                  	; 19/11/2023
  1417                                  	; 03/04/2017 ('pci.asm', 20/03/2017)
  1418                                  	;
  1419                                  	; scan through PCI space looking for a device+vendor ID
  1420                                  	;
  1421                                  	; Entry: EAX=Device+Vendor ID
  1422                                  	;
  1423                                  	; Exit: EAX=PCI address if device found
  1424                                  	;	EDX=Device+Vendor ID
  1425                                  	;       CY clear if found, set if not found. EAX invalid if CY set.
  1426                                  	;
  1427                                  	; Destroys: ebx, edi ; 19/11/2023
  1428                                  
  1429                                          ; 19/11/2023
  1430 0000083F 89C3                    	mov	ebx, eax
  1431 00000841 BF00000080              	mov	edi, 80000000h
  1432                                  nextPCIdevice:
  1433 00000846 89F8                    	mov 	eax, edi		; read PCI registers
  1434 00000848 E88C000000              	call	pciRegRead32
  1435                                  	; 19/11/2023
  1436 0000084D 39DA                    	cmp	edx, ebx
  1437 0000084F 7412                    	je	short PCIScanExit	; found
  1438                                  	; 19/11/2023
  1439 00000851 81FF00F8FF80            	cmp	edi, 80FFF800h
  1440 00000857 7308                    	jnb	short pfd_nf		; not found
  1441 00000859 81C700010000            	add	edi, 100h
  1442 0000085F EBE5                    	jmp	short nextPCIdevice
  1443                                  pfd_nf:
  1444 00000861 F9                      	stc
  1445 00000862 C3                      	retn
  1446                                  PCIScanExit:
  1447                                  	;pushf
  1448 00000863 B8FFFFFF7F              	mov	eax, NOT_BIT31 	; 19/03/2017
  1449 00000868 21F8                    	and	eax, edi	; return only bus/dev/fn #
  1450 0000086A C3                      	retn
  1451                                  
  1452                                  pciRegRead:
  1453                                  	; 01/12/2024
  1454                                  	; 03/04/2017 ('pci.asm', 20/03/2017)
  1455                                  	;
  1456                                  	; 8/16/32bit PCI reader
  1457                                  	;
  1458                                  	; Entry: EAX=PCI Bus/Device/fn/register number
  1459                                  	;           BIT30 set if 32 bit access requested
  1460                                  	;           BIT29 set if 16 bit access requested
  1461                                  	;           otherwise defaults to 8 bit read
  1462                                  	;
  1463                                  	; Exit:  DL,DX,EDX register data depending on requested read size
  1464                                  	;
  1465                                  	; Note1: this routine is meant to be called via pciRegRead8,
  1466                                  	;	 pciRegread16 or pciRegRead32, listed below.
  1467                                  	;
  1468                                  	; Note2: don't attempt to read 32 bits of data from a non dword
  1469                                  	;	 aligned reg number. Likewise, don't do 16 bit reads from
  1470                                  	;	 non word aligned reg #
  1471                                  
  1472 0000086B 53                      	push	ebx
  1473 0000086C 51                      	push	ecx
  1474 0000086D 89C3                            mov     ebx, eax		; save eax, dh
  1475 0000086F 88F1                            mov     cl, dh
  1476                                  
  1477 00000871 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; clear out data size request
  1478 00000876 0D00000080                      or      eax, BIT31		; make a PCI access request
  1479 0000087B 24FC                            and     al, ~3 ; NOT 3 ; 0FCh	; force index to be dword
  1480                                  
  1481 0000087D 66BAF80C                        mov     dx, PCI_INDEX_PORT
  1482                                          ;out	dx, eax			; write PCI selector
  1483                                  	; 29/05/2024
  1484 00000881 53                      	push	ebx
  1485 00000882 89C3                    	mov	ebx, eax ; data, dword
  1486 00000884 B405                    	mov	ah, 5 ; write port, dword
  1487                                  	; dx = port number
  1488 00000886 CD34                    	int	34h
  1489 00000888 5B                      	pop	ebx
  1490                                  	
  1491 00000889 66BAFC0C                        mov     dx, PCI_DATA_PORT
  1492 0000088D 88D8                            mov     al, bl
  1493 0000088F 2403                            and     al, 3			; figure out which port to
  1494 00000891 00C2                            add     dl, al			; read to
  1495                                  
  1496 00000893 F7C3000000C0            	test    ebx, PCI32+PCI16
  1497 00000899 750A                            jnz     short _pregr0
  1498                                  
  1499                                  	;in	al, dx			; return 8 bits of data
  1500                                  	; 29/05/2024
  1501 0000089B B400                    	mov	ah, 0 ; read port, byte
  1502                                  	; dx = port number
  1503 0000089D CD34                    	int	34h
  1504                                          
  1505 0000089F 88C2                    	mov	dl, al
  1506 000008A1 88CE                    	mov     dh, cl			; restore dh for 8 bit read
  1507 000008A3 EB17                    	jmp	short _pregr2
  1508                                  _pregr0:	
  1509 000008A5 F7C300000080            	test    ebx, PCI32
  1510 000008AB 7509                            jnz	short _pregr1
  1511                                  
  1512                                  	;in	ax, dx
  1513                                  	; 29/05/2024
  1514 000008AD B402                    	mov	ah, 2 ; read port, word
  1515                                  	; dx = port number
  1516 000008AF CD34                    	int	34h
  1517                                  
  1518 000008B1 6689C2                  	mov     dx, ax			; return 16 bits of data
  1519 000008B4 EB06                    	jmp	short _pregr2
  1520                                  _pregr1:
  1521                                  	;in	eax, dx			; return 32 bits of data
  1522                                  	; 29/05/2024
  1523 000008B6 B404                    	mov	ah, 4 ; read port, dword
  1524                                  	; dx = port number
  1525 000008B8 CD34                    	int	34h
  1526                                  
  1527 000008BA 89C2                    	mov	edx, eax
  1528                                  _pregr2:
  1529 000008BC 89D8                    	mov     eax, ebx		; restore eax
  1530 000008BE 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; clear out data size request
  1531 000008C3 59                      	pop	ecx
  1532 000008C4 5B                      	pop	ebx
  1533 000008C5 C3                      	retn
  1534                                  
  1535                                  pciRegRead8:
  1536 000008C6 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 8 bit read size
  1537 000008CB EB9E                            jmp     short pciRegRead	; call generic PCI access
  1538                                  
  1539                                  pciRegRead16:
  1540 000008CD 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 16 bit read size
  1541 000008D2 0D00000040                      or      eax, PCI16		; call generic PCI access
  1542 000008D7 EB92                            jmp     short pciRegRead
  1543                                  
  1544                                  pciRegRead32:
  1545 000008D9 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 32 bit read size
  1546 000008DE 0D00000080                      or      eax, PCI32		; call generic PCI access
  1547 000008E3 EB86                            jmp     pciRegRead
  1548                                  
  1549                                  pciRegWrite:
  1550                                  	; 01/12/2024
  1551                                  	; 03/04/2017 ('pci.asm', 29/11/2016)
  1552                                  	;
  1553                                  	; 8/16/32bit PCI writer
  1554                                  	;
  1555                                  	; Entry: EAX=PCI Bus/Device/fn/register number
  1556                                  	;           BIT31 set if 32 bit access requested
  1557                                  	;           BIT30 set if 16 bit access requested
  1558                                  	;           otherwise defaults to 8bit read
  1559                                  	;        DL/DX/EDX data to write depending on size
  1560                                  	;
  1561                                  	; Note1: this routine is meant to be called via pciRegWrite8,
  1562                                  	;	 pciRegWrite16 or pciRegWrite32 as detailed below.
  1563                                  	;
  1564                                  	; Note2: don't attempt to write 32bits of data from a non dword
  1565                                  	;	 aligned reg number. Likewise, don't do 16 bit writes from
  1566                                  	;	 non word aligned reg #
  1567                                  
  1568 000008E5 53                      	push	ebx
  1569 000008E6 51                      	push	ecx
  1570 000008E7 89C3                            mov     ebx, eax		; save eax, edx
  1571 000008E9 89D1                            mov     ecx, edx
  1572 000008EB 25FFFFFF3F              	and     eax, NOT_PCI32_PCI16	; clear out data size request
  1573 000008F0 0D00000080                      or      eax, BIT31		; make a PCI access request
  1574 000008F5 24FC                            and     al, ~3 ; NOT 3 ; 0FCh	; force index to be dword
  1575                                  
  1576 000008F7 66BAF80C                        mov     dx, PCI_INDEX_PORT
  1577                                  	;out	dx, eax			; write PCI selector
  1578                                  	; 29/05/2024
  1579 000008FB 53                      	push	ebx
  1580 000008FC 89C3                    	mov	ebx, eax ; data, dword
  1581 000008FE B405                    	mov	ah, 5 ; write port, dword
  1582                                  	; dx = port number
  1583 00000900 CD34                    	int	34h
  1584 00000902 5B                      	pop	ebx
  1585                                  	
  1586 00000903 66BAFC0C                        mov     dx, PCI_DATA_PORT
  1587 00000907 88D8                            mov     al, bl
  1588 00000909 2403                            and     al, 3			; figure out which port to
  1589 0000090B 00C2                            add     dl, al			; write to
  1590                                  
  1591 0000090D F7C3000000C0            	test    ebx, PCI32+PCI16
  1592 00000913 7508                            jnz     short _pregw0
  1593 00000915 88C8                    	mov	al, cl 			; put data into al
  1594                                  	;out	dx, al
  1595                                  	; 29/05/2024
  1596                                  	; al = data, byte
  1597 00000917 B401                    	mov	ah, 1 ; write port, byte
  1598                                  	; dx = port number
  1599 00000919 CD34                    	int	34h
  1600                                  
  1601 0000091B EB1F                    	jmp	short _pregw2
  1602                                  _pregw0:
  1603 0000091D F7C300000080            	test    ebx, PCI32
  1604 00000923 750D                            jnz     short _pregw1
  1605 00000925 6689C8                  	mov	ax, cx			; put data into ax
  1606                                  	;out	dx, ax
  1607                                  	; 29/05/2024
  1608 00000928 53                      	push	ebx
  1609 00000929 89C3                    	mov	ebx, eax ; data, word
  1610 0000092B B403                    	mov	ah, 3 ; write port, word
  1611                                  	; dx = port number
  1612 0000092D CD34                    	int	34h
  1613 0000092F 5B                      	pop	ebx
  1614                                  
  1615 00000930 EB0A                    	jmp	short _pregw2
  1616                                  _pregw1:
  1617 00000932 89C8                    	mov	eax, ecx		; put data into eax
  1618                                  	;out	dx, eax
  1619                                  	; 29/05/2024
  1620 00000934 53                      	push	ebx
  1621 00000935 89C3                    	mov	ebx, eax ; data, dword
  1622 00000937 B405                    	mov	ah, 5 ; write port, dword
  1623                                  	; dx = port number
  1624 00000939 CD34                    	int	34h
  1625 0000093B 5B                      	pop	ebx
  1626                                  _pregw2:
  1627 0000093C 89D8                            mov     eax, ebx		; restore eax
  1628 0000093E 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; clear out data size request
  1629 00000943 89CA                            mov     edx, ecx		; restore dx
  1630 00000945 59                      	pop	ecx
  1631 00000946 5B                      	pop	ebx
  1632 00000947 C3                      	retn
  1633                                  
  1634                                  pciRegWrite8:
  1635 00000948 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 8 bit write size
  1636 0000094D EB96                            jmp	short pciRegWrite	; call generic PCI access
  1637                                  
  1638                                  pciRegWrite16:
  1639 0000094F 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 16 bit write size
  1640 00000954 0D00000040                      or      eax, PCI16		; call generic PCI access
  1641 00000959 EB8A                            jmp	short pciRegWrite
  1642                                  
  1643                                  pciRegWrite32:
  1644 0000095B 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 32 bit write size
  1645 00000960 0D00000080                      or      eax, PCI32		; call generic PCI access
  1646 00000965 E97BFFFFFF                      jmp	pciRegWrite
  1647                                  
  1648                                  ; --------------------------------------------------------
  1649                                  ; 19/05/2024 - (playwav4.asm) ac97_vra.asm
  1650                                  ; --------------------------------------------------------
  1651                                  
  1652                                  	; 13/11/2023
  1653                                  
  1654                                  ;VRA:	db 1
  1655                                  
  1656                                  codecConfig:
  1657                                  	; 01/12/2024 (ac97play.s)
  1658                                  	; 29/05/2024 (playwav7.s modification)
  1659                                  	; 19/05/2024
  1660                                  	; 19/11/2023
  1661                                  	; 15/11/2023
  1662                                  	; 04/11/2023
  1663                                  	; 17/02/2017 
  1664                                  	; 07/11/2016 (Erdogan Tan)
  1665                                  
  1666                                  	;AC97_EA_VRA equ 1
  1667                                  	AC97_EA_VRA equ BIT0
  1668                                  
  1669                                  	; 04/11/2023
  1670                                  init_ac97_controller:
  1671 0000096A A1[AC370000]            	mov	eax, [bus_dev_fn]
  1672 0000096F B004                    	mov	al, PCI_CMD_REG
  1673 00000971 E857FFFFFF              	call	pciRegRead16		; read PCI command register
  1674 00000976 80CA05                  	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
  1675 00000979 E8D1FFFFFF              	call	pciRegWrite16
  1676                                  
  1677                                  	;call	delay_100ms
  1678                                  
  1679                                  	; 19/05/2024
  1680                                  	; ('PLAYMOD3.ASM', Erdogan Tan, 18/05/2024)
  1681                                  
  1682                                  init_ac97_codec:
  1683                                  	; 18/11/2023
  1684 0000097E BD28000000              	mov	ebp, 40
  1685                                  	; 29/05/2024
  1686                                  	;mov	ebp, 1000
  1687                                  _initc_1:
  1688                                  	; 29/05/2024
  1689 00000983 66BA3000                	mov	dx, GLOB_STS_REG ; 30h
  1690 00000987 660315[B6370000]        	add	dx, [NABMBAR]
  1691                                  	;in	eax, dx
  1692 0000098E B404                    	mov	ah, 4	; read port, dword
  1693 00000990 CD34                    	int	34h
  1694                                  
  1695                                  	; 19/05/2024
  1696                                  	;call	delay1_4ms
  1697                                  
  1698 00000992 83F8FF                  	cmp	eax, 0FFFFFFFFh ; -1
  1699 00000995 750A                    	jne	short _initc_3
  1700                                  _initc_2:
  1701 00000997 4D                      	dec	ebp
  1702 00000998 7425                    	jz	short _ac97_codec_ready
  1703                                  
  1704                                  	; 31/05/2024
  1705 0000099A E8B3020000              	call	delay_100ms
  1706 0000099F EBE2                    	jmp	short _initc_1
  1707                                  _initc_3:
  1708 000009A1 A900030010              	test	eax, CTRL_ST_CREADY
  1709 000009A6 7517                    	jnz	short _ac97_codec_ready
  1710                                  
  1711                                  	; 30/05/2024
  1712 000009A8 803D[152C0000]01        	cmp	byte [reset], 1
  1713 000009AF 73E6                    	jnb	short _initc_2
  1714                                  
  1715 000009B1 E893010000              	call	reset_ac97_codec
  1716                                  	; 30/05/2024
  1717 000009B6 C605[152C0000]01        	mov	byte [reset], 1
  1718                                  	; 19/05/2024
  1719 000009BD EBD8                    	jmp	short _initc_2
  1720                                  
  1721                                  _ac97_codec_ready:
  1722 000009BF 668B15[B4370000]        	mov	dx, [NAMBAR]
  1723                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1724                                  	;out	dx, ax
  1725                                  	; 29/05/2024
  1726 000009C6 53                      	push	ebx
  1727 000009C7 89C3                    	mov	ebx, eax ; bx = data, word
  1728 000009C9 B403                    	mov	ah, 3	; write port, word
  1729 000009CB CD34                    	int	34h
  1730 000009CD 5B                      	pop	ebx
  1731                                  
  1732                                  	; 31/05/2024
  1733                                  	; 29/05/2024
  1734                                  	;call	delay_100ms
  1735                                  
  1736                                  	; 19/11/2023
  1737 000009CE 09ED                    	or	ebp, ebp
  1738 000009D0 7539                    	jnz	short _ac97_codec_init_ok
  1739                                  
  1740 000009D2 31C0                    	xor	eax, eax ; 0
  1741 000009D4 668B15[B4370000]        	mov	dx, [NAMBAR]
  1742 000009DB 6683C226                	add	dx, CODEC_REG_POWERDOWN
  1743                                  	;out	dx, ax
  1744                                  	; 29/05/2024
  1745 000009DF 53                      	push	ebx
  1746 000009E0 89C3                    	mov	ebx, eax
  1747 000009E2 B403                    	mov	ah, 3	; write port, word
  1748 000009E4 CD34                    	int	34h
  1749 000009E6 5B                      	pop	ebx
  1750                                  
  1751                                  	; 19/11/2023
  1752                                  	; wait for 1 second
  1753                                  	; 19/05/2024
  1754 000009E7 B9E8030000              	mov	ecx, 1000 ; 1000*4*0.25ms = 1s
  1755                                  	;;mov	ecx, 10
  1756                                  	; 30/05/2024
  1757                                  	;mov	ecx, 40
  1758                                  _ac97_codec_rloop:
  1759                                  	;call	delay_100ms
  1760                                  	; 31/05/2024
  1761 000009EC E870020000              	call	delay1_4ms
  1762                                  
  1763                                  	;mov	dx, [NAMBAR]
  1764                                  	;add	dx, CODEC_REG_POWERDOWN
  1765                                  	;in	ax, dx
  1766                                  	; 29/05/2024
  1767 000009F1 668B15[B4370000]        	mov	dx, [NAMBAR]
  1768 000009F8 6683C226                	add	dx, CODEC_REG_POWERDOWN
  1769                                  	; 31/05/2024
  1770 000009FC B402                    	mov	ah, 2	; read port, word
  1771 000009FE CD34                    	int	34h
  1772                                  
  1773                                  	; 31/05/2024
  1774                                  	;call	delay1_4ms
  1775                                  	
  1776 00000A00 6683E00F                	and	ax, 0Fh
  1777 00000A04 3C0F                    	cmp	al, 0Fh
  1778 00000A06 7403                    	je	short _ac97_codec_init_ok
  1779 00000A08 E2E2                    	loop	_ac97_codec_rloop 
  1780                                  
  1781                                  init_ac97_codec_err1:
  1782                                  	;stc	; cf = 1 ; 19/05/2024
  1783                                  init_ac97_codec_err2:
  1784 00000A0A C3                      	retn
  1785                                  
  1786                                  _ac97_codec_init_ok:
  1787 00000A0B E8DA000000              	call 	reset_ac97_controller
  1788                                  
  1789                                  	; 31/05/2024
  1790                                  	; 30/05/2024
  1791                                  	; 19/05/2024
  1792                                  	;call	delay_100ms
  1793                                  
  1794                                  	; 30/05/2024
  1795                                  	;call	delay1_4ms
  1796                                  	;call	delay1_4ms
  1797                                  	;call	delay1_4ms
  1798                                  	;call	delay1_4ms
  1799                                  
  1800                                  	; 01/12/2024
  1801                                  setup_ac97_codec:
  1802                                  	; 12/11/2023
  1803 00000A10 66813D[30370000]80-     	cmp	word [WAVE_SampleRate], 48000
  1803 00000A18 BB                 
  1804 00000A19 0F849C000000            	je	skip_rate
  1805                                  	
  1806                                  	; 31/05/2024
  1807                                  	; 30/05/2024
  1808                                  	; 29/05/2024
  1809                                  	;cmp	byte [VRA], 0
  1810                                  	;jna	short skip_rate
  1811                                  
  1812                                  	; 11/11/2023
  1813 00000A1F 668B15[B4370000]        	mov	dx, [NAMBAR]
  1814 00000A26 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1815                                  	;in	ax, dx
  1816                                  	; 29/05/2024
  1817 00000A2A B402                    	mov	ah, 2 ; read port, word
  1818 00000A2C CD34                    	int	34h
  1819                                  
  1820                                  	; 30/05/2024
  1821                                  	; 19/05/2024
  1822 00000A2E E82E020000              	call	delay1_4ms
  1823                                  
  1824                                  	;and	al, ~BIT1 ; Clear DRA
  1825                                  	;;;
  1826                                  	; 30/05/2024
  1827 00000A33 24FC                    	and	al, ~(BIT1+BIT0) ; Clear DRA+VRA
  1828                                  	; 01/12/2024 (FASM)
  1829                                  	;and	al, NOT (BIT1+BIT0) ; 0FCh
  1830                                  	;out	dx, ax
  1831                                  	; 31/05/2024
  1832 00000A35 53                      	push	ebx
  1833 00000A36 89C3                    	mov	ebx, eax
  1834 00000A38 668B15[B4370000]        	mov	dx, [NAMBAR]
  1835 00000A3F 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1836 00000A43 B403                    	mov	ah, 3 ; write port, word
  1837 00000A45 CD34                    	int	34h
  1838 00000A47 5B                      	pop	ebx
  1839                                  
  1840                                  	; 31/05/2024
  1841 00000A48 E8B1010000              	call	check_vra
  1842                                  
  1843                                  	; 31/05/2024 - temporary (interpolated sample rate test)
  1844                                  	;mov	byte [VRA], 0
  1845                                  
  1846                                  	; 31/05/2024
  1847 00000A4D 803D[15370000]00        	cmp	byte [VRA], 0
  1848 00000A54 7665                    	jna	short skip_rate
  1849                                  
  1850 00000A56 668B15[B4370000]        	mov	dx, [NAMBAR]
  1851 00000A5D 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1852                                  	;in	ax, dx
  1853                                  	; 31/05/2024
  1854 00000A61 B402                    	mov	ah, 2 ; read port, word
  1855 00000A63 CD34                    	int	34h
  1856                                  
  1857                                  	;and	al, ~BIT1 ; Clear DRA
  1858                                  	;;;
  1859                                  
  1860 00000A65 0C01                    	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
  1861                                  	;out	dx, ax	; Enable variable rate audio
  1862                                  	; 29/05/2024
  1863 00000A67 53                      	push	ebx
  1864 00000A68 89C3                    	mov	ebx, eax
  1865                                  	;
  1866                                  	; 30/05/2024
  1867 00000A6A 668B15[B4370000]        	mov	dx, [NAMBAR]
  1868 00000A71 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1869                                  	;
  1870 00000A75 B403                    	mov	ah, 3 ; write port, word
  1871 00000A77 CD34                    	int	34h
  1872 00000A79 5B                      	pop	ebx
  1873                                  
  1874                                  	;mov	cx, 10
  1875 00000A7A B90A000000              	mov	ecx, 10 ; 30/05/2024
  1876                                  check_vra_loop:
  1877                                  	; 31/05/2024
  1878                                  	;call	delay_100ms
  1879                                  	; 30/05/2024
  1880 00000A7F E8DD010000              	call	delay1_4ms
  1881                                  
  1882                                  	; 11/11/2023
  1883                                  	;in	ax, dx
  1884                                  	; 29/05/2024
  1885 00000A84 668B15[B4370000]        	mov	dx, [NAMBAR]
  1886 00000A8B 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1887 00000A8F B402                    	mov	ah, 2 ; read port, word
  1888 00000A91 CD34                    	int	34h
  1889                                  
  1890 00000A93 A801                    	test	al, AC97_EA_VRA ; 1
  1891 00000A95 750B                    	jnz	short set_rate
  1892                                  
  1893                                  	; 11/11/2023
  1894 00000A97 E2E6                    	loop	check_vra_loop
  1895                                  
  1896                                  ;vra_not_supported:	; 19/05/2024
  1897 00000A99 C605[15370000]00        	mov	byte [VRA], 0
  1898 00000AA0 EB19                    	jmp	short skip_rate
  1899                                  
  1900                                  set_rate:
  1901                                  	;mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1902                                  	; 01/12/2024
  1903 00000AA2 66A1[30370000]          	mov	ax, [WAVE_SampleRate]
  1904                                  
  1905 00000AA8 668B15[B4370000]        	mov    	dx, [NAMBAR]
  1906 00000AAF 6683C22C                	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch
  1907                                  	;out	dx, ax 	; PCM Front/Center Output Sample Rate
  1908                                  	; 29/05/2024
  1909 00000AB3 53                      	push	ebx
  1910 00000AB4 89C3                    	mov	ebx, eax  ; bx = data, word
  1911 00000AB6 B403                    	mov	ah, 3 ; write port, word
  1912 00000AB8 CD34                    	int	34h
  1913 00000ABA 5B                      	pop	ebx
  1914                                  
  1915                                  	; 29/05/2024
  1916                                  	;call	delay_100ms
  1917                                  	; 30/05/2024
  1918                                  	;call	delay1_4ms
  1919                                  
  1920                                  	; 12/11/2023
  1921                                  skip_rate:
  1922 00000ABB 66B80202                	mov	ax, 0202h
  1923 00000ABF 668B15[B4370000]          	mov	dx, [NAMBAR]
  1924 00000AC6 6683C202                  	add	dx, CODEC_MASTER_VOL_REG ;02h
  1925                                  	;out	dx, ax
  1926                                  	; 29/05/2024
  1927 00000ACA 53                      	push	ebx
  1928 00000ACB 89C3                    	mov	ebx, eax  ; bx = data, word
  1929 00000ACD B403                    	mov	ah, 3 ; write port, word
  1930 00000ACF CD34                    	int	34h
  1931 00000AD1 5B                      	pop	ebx
  1932                                  
  1933                                  	; 29/05/2024
  1934                                  	;call	delay1_4ms
  1935                                  	;call	delay1_4ms
  1936                                  	;call	delay1_4ms
  1937                                  	;call	delay1_4ms
  1938                                  
  1939 00000AD2 66B80202                	mov	ax, 0202h
  1940 00000AD6 668B15[B4370000]          	mov	dx, [NAMBAR]
  1941 00000ADD 6683C218                  	add	dx, CODEC_PCM_OUT_REG		;18h
  1942                                    	;out	dx, ax
  1943                                  	; 29/05/2024
  1944 00000AE1 53                      	push	ebx
  1945 00000AE2 89C3                    	mov	ebx, eax  ; bx = data, word
  1946 00000AE4 B403                    	mov	ah, 3 ; write port, word
  1947 00000AE6 CD34                    	int	34h
  1948 00000AE8 5B                      	pop	ebx
  1949                                  
  1950                                   	; 29/05/2024
  1951                                  	;call	delay1_4ms
  1952                                  	;call	delay1_4ms
  1953                                  	;call	delay1_4ms
  1954                                  	;call	delay1_4ms
  1955                                  
  1956                                  	; 19/05/2024
  1957                                  	;clc
  1958                                  
  1959 00000AE9 C3                              retn
  1960                                  
  1961                                  reset_ac97_controller:
  1962                                  	; 29/05/2024 (TRDOS 386)
  1963                                  	; 19/05/2024
  1964                                  	; 11/11/2023
  1965                                  	; 10/06/2017
  1966                                  	; 29/05/2017
  1967                                  	; 28/05/2017
  1968                                  	; reset AC97 audio controller registers
  1969 00000AEA 31C0                    	xor	eax, eax
  1970 00000AEC 66BA0B00                        mov	dx, PI_CR_REG
  1971 00000AF0 660315[B6370000]        	add	dx, [NABMBAR]
  1972                                  	;out	dx, al
  1973                                  	; 29/05/2024
  1974                                  	; al = data, byte
  1975 00000AF7 B401                    	mov	ah, 1 ; write port, byte
  1976 00000AF9 CD34                    	int	34h
  1977                                  
  1978                                  	; 19/05/2024
  1979                                  	;call	delay1_4ms
  1980                                  
  1981 00000AFB 66BA1B00                        mov     dx, PO_CR_REG
  1982 00000AFF 660315[B6370000]        	add	dx, [NABMBAR]
  1983                                  	;out	dx, al
  1984                                  	; 29/05/2024
  1985                                  	; al = data, byte
  1986 00000B06 B401                    	mov	ah, 1 ; write port, byte
  1987 00000B08 CD34                    	int	34h
  1988                                  
  1989                                  	; 19/05/2024
  1990                                  	;call	delay1_4ms
  1991                                  
  1992 00000B0A 66BA2B00                        mov     dx, MC_CR_REG
  1993 00000B0E 660315[B6370000]        	add	dx, [NABMBAR]
  1994                                  	;out	dx, al
  1995                                  	; 29/05/2024
  1996                                  	; al = data, byte
  1997 00000B15 B401                    	mov	ah, 1 ; write port, byte
  1998 00000B17 CD34                    	int	34h
  1999                                  
  2000                                  	; 19/05/2024
  2001                                  	;call	delay1_4ms
  2002                                  
  2003 00000B19 B002                            mov	al, RR
  2004 00000B1B 66BA0B00                        mov	dx, PI_CR_REG
  2005 00000B1F 660315[B6370000]        	add	dx, [NABMBAR]
  2006                                  	;out	dx, al
  2007                                  	; 29/05/2024
  2008                                  	; al = data, byte
  2009 00000B26 B401                    	mov	ah, 1 ; write port, byte
  2010 00000B28 CD34                    	int	34h
  2011                                  
  2012                                  	; 19/05/2024
  2013                                  	;call	delay1_4ms
  2014                                  
  2015 00000B2A 66BA1B00                        mov	dx, PO_CR_REG
  2016 00000B2E 660315[B6370000]        	add	dx, [NABMBAR]
  2017                                  	;out	dx, al
  2018                                  	; 29/05/2024
  2019                                  	; al = data, byte
  2020 00000B35 B401                    	mov	ah, 1 ; write port, byte
  2021 00000B37 CD34                    	int	34h
  2022                                  
  2023                                  	; 19/05/2024
  2024                                  	;call	delay1_4ms
  2025                                  
  2026 00000B39 66BA2B00                        mov	dx, MC_CR_REG
  2027 00000B3D 660315[B6370000]        	add	dx, [NABMBAR]
  2028                                  	;out	dx, al
  2029                                  	; 29/05/2024
  2030                                  	; al = data, byte
  2031 00000B44 B401                    	mov	ah, 1 ; write port, byte
  2032 00000B46 CD34                    	int	34h
  2033                                  
  2034                                  	; 19/05/2024
  2035                                  	;call	delay1_4ms
  2036                                  
  2037 00000B48 C3                      	retn
  2038                                  
  2039                                  reset_ac97_codec:
  2040                                  	; 29/05/2024 (TRDOS 386)
  2041                                  	; 11/11/2023
  2042                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  2043 00000B49 66BA2C00                	mov	dx, GLOB_CNT_REG ; 2Ch
  2044 00000B4D 660315[B6370000]        	add	dx, [NABMBAR]
  2045                                  	;in	eax, dx
  2046                                  	; 29/05/2024
  2047 00000B54 B404                    	mov	ah, 4 ; read port, dword
  2048 00000B56 CD34                    	int	34h
  2049                                  
  2050                                  	;test	eax, 2
  2051                                  	; 06/08/2022
  2052 00000B58 A802                    	test	al, 2
  2053 00000B5A 7407                    	jz	short _r_ac97codec_cold
  2054                                  
  2055 00000B5C E80F000000              	call	warm_ac97codec_reset
  2056 00000B61 7308                    	jnc	short _r_ac97codec_ok
  2057                                  _r_ac97codec_cold:
  2058 00000B63 E845000000                      call	cold_ac97codec_reset
  2059 00000B68 7301                            jnc	short _r_ac97codec_ok
  2060                                  	
  2061                                  	; 16/04/2017
  2062                                          ;xor	eax, eax	; timeout error
  2063                                         	;stc
  2064 00000B6A C3                      	retn
  2065                                  
  2066                                  _r_ac97codec_ok:
  2067 00000B6B 31C0                            xor     eax, eax
  2068                                          ;mov	al, VIA_ACLINK_C00_READY ; 1
  2069 00000B6D FEC0                            inc	al
  2070 00000B6F C3                      	retn
  2071                                  
  2072                                  warm_ac97codec_reset:
  2073                                  	; 29/05/2024 (TRDOS 386)
  2074                                  	; 11/11/2023
  2075                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  2076                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  2077 00000B70 B806000000              	mov	eax, 6
  2078 00000B75 66BA2C00                	mov	dx, GLOB_CNT_REG ; 2Ch
  2079 00000B79 660315[B6370000]        	add	dx, [NABMBAR]
  2080                                  	;out	dx, eax
  2081                                  	; 29/05/2024
  2082 00000B80 53                      	push	ebx
  2083 00000B81 89C3                    	mov	ebx, eax  ; ebx = data, dword
  2084 00000B83 B405                    	mov	ah, 5 ; write port, dword
  2085 00000B85 CD34                    	int	34h
  2086 00000B87 5B                      	pop	ebx
  2087                                  
  2088                                  	; 30/05/2024
  2089 00000B88 B90A000000              	mov	ecx, 10	; total 1s
  2090                                  	; 29/05/2024
  2091                                  	;mov	ecx, 4000
  2092                                  _warm_ac97c_rst_wait:
  2093                                  	; 30/05/2024
  2094 00000B8D E8C0000000              	call	delay_100ms
  2095                                  
  2096 00000B92 66BA3000                	mov	dx, GLOB_STS_REG ; 30h
  2097 00000B96 660315[B6370000]        	add	dx, [NABMBAR]
  2098                                  	;in	eax, dx
  2099                                  	; 29/05/2024
  2100 00000B9D B404                    	mov	ah, 4 ; read port, dword
  2101 00000B9F CD34                    	int	34h
  2102                                  
  2103 00000BA1 A900030010              	test	eax, CTRL_ST_CREADY
  2104 00000BA6 7504                    	jnz	short _warm_ac97c_rst_ok
  2105                                  
  2106 00000BA8 49                      	dec	ecx
  2107 00000BA9 75E2                    	jnz	short _warm_ac97c_rst_wait
  2108                                  
  2109                                  _warm_ac97c_rst_fail:
  2110 00000BAB F9                              stc
  2111                                  _warm_ac97c_rst_ok:
  2112 00000BAC C3                      	retn
  2113                                  
  2114                                  cold_ac97codec_reset:
  2115                                  	; 11/11/2023
  2116                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  2117                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  2118 00000BAD B802000000                      mov	eax, 2
  2119 00000BB2 66BA2C00                	mov	dx, GLOB_CNT_REG ; 2Ch
  2120 00000BB6 660315[B6370000]        	add	dx, [NABMBAR]
  2121                                  	;out	dx, eax
  2122                                  	; 29/05/2024
  2123 00000BBD 53                      	push	ebx
  2124 00000BBE 89C3                    	mov	ebx, eax  ; ebx = data, dword
  2125 00000BC0 B405                    	mov	ah, 5 ; write port, dword
  2126 00000BC2 CD34                    	int	34h
  2127 00000BC4 5B                      	pop	ebx
  2128                                  
  2129                                  	; 30/05/2024
  2130 00000BC5 E888000000              	call	delay_100ms 	; wait 100 ms
  2131 00000BCA E883000000              	call	delay_100ms 	; wait 100 ms
  2132 00000BCF E87E000000              	call	delay_100ms 	; wait 100 ms
  2133 00000BD4 E879000000              	call	delay_100ms 	; wait 100 ms
  2134                                  
  2135                                  	; 30/05/2024
  2136 00000BD9 B910000000              	mov	ecx, 16	; total 20*100 ms = 2s
  2137                                  	; 29/05/2024
  2138                                  	;mov	ecx, 16000
  2139                                  _cold_ac97c_rst_wait:
  2140 00000BDE 66BA3000                	mov	dx, GLOB_STS_REG ; 30h
  2141 00000BE2 660315[B6370000]        	add	dx, [NABMBAR]
  2142                                  	;in	eax, dx
  2143                                  	; 29/05/2024
  2144 00000BE9 B404                    	mov	ah, 4 ; read port, dword
  2145 00000BEB CD34                    	int	34h
  2146                                  
  2147 00000BED A900030010              	test	eax, CTRL_ST_CREADY
  2148 00000BF2 7509                    	jnz	short _cold_ac97c_rst_ok
  2149                                  
  2150                                  	; 30/05/2024
  2151                                  	; 29/05/2024
  2152 00000BF4 E859000000              	call	delay_100ms
  2153                                  
  2154 00000BF9 49                      	dec	ecx
  2155 00000BFA 75E2                    	jnz	short _cold_ac97c_rst_wait
  2156                                  
  2157                                  _cold_ac97c_rst_fail:
  2158 00000BFC F9                              stc
  2159                                  _cold_ac97c_rst_ok:
  2160 00000BFD C3                      	retn
  2161                                  
  2162                                  ; 29/12/2024 (vgaplay3.s, NASM)
  2163                                  ; 18/12/2024 (ac97play.s, FASM)
  2164                                  ; 13/11/2024
  2165                                  ; 30/05/2024
  2166                                  %if 1
  2167                                  ;if 1
  2168                                  check_vra:
  2169                                  	; 29/05/2024
  2170 00000BFE C605[15370000]01        	mov	byte [VRA], 1
  2171                                  
  2172                                  	; 29/05/2024 - audio.s (TRDOS 386 Kernel) - 27/05/2024
  2173                                  	; 24/05/2024
  2174                                  	; 23/05/2024
  2175 00000C05 668B15[B4370000]        	mov	dx, [NAMBAR]
  2176 00000C0C 6683C228                	add	dx, CODEC_EXT_AUDIO_REG	; 28h
  2177                                  	;in	ax, dx
  2178                                  	; 29/05/2024
  2179 00000C10 B402                    	mov	ah, 2 ; read port, word
  2180 00000C12 CD34                    	int	34h
  2181                                  
  2182                                  	; 30/05/2024
  2183                                  	; 23/05/2024
  2184 00000C14 E848000000              	call	delay1_4ms
  2185                                  
  2186                                  	; 29/05/2024
  2187 00000C19 A801                    	test	al, BIT0
  2188                                  	;test	al, 1 ; BIT0 ; Variable Rate Audio bit
  2189 00000C1B 7507                    	jnz	short check_vra_ok
  2190                                  
  2191                                  vra_not_supported:
  2192                                  	; 13/11/2023
  2193 00000C1D C605[15370000]00        	mov	byte [VRA], 0
  2194                                  check_vra_ok:
  2195 00000C24 C3                      	retn
  2196                                  ;end if
  2197                                  %endif
  2198                                  
  2199                                  ; --------------------------------------------------------
  2200                                  ; --------------------------------------------------------
  2201                                  
  2202                                  ; 29/12/2024 (vgaplay3.s)
  2203                                  ; 18/12/2024 (ac97play.s)
  2204                                  ;
  2205                                  ; 18/11/2024
  2206                                  ; Ref: TRDOS 386 v2.0.9, audio.s, Erdogan Tan, 06/06/2024
  2207                                  
  2208                                  ac97_stop: 
  2209                                  	; 18/11/2024
  2210 00000C25 C605[08370000]02        	mov	byte [stopped], 2
  2211                                  
  2212                                  ac97_po_cmd@:
  2213 00000C2C 30C0                    	xor	al, al ; 0
  2214                                  ac97_po_cmd:
  2215 00000C2E 668B15[B6370000]        	mov     dx, [NABMBAR]
  2216 00000C35 6683C21B                        add     dx, PO_CR_REG	; PCM out control register
  2217                                  	;out	dx, al
  2218                                  	; 01/12/2024
  2219 00000C39 B401                    	mov	ah, 1 ; write port, byte
  2220 00000C3B CD34                    	int	34h
  2221 00000C3D C3                      	retn
  2222                                  
  2223                                  ac97_pause:
  2224 00000C3E C605[08370000]01        	mov	byte [stopped], 1 ; paused
  2225                                  	;mov	al, 0
  2226                                  	;jmp	short ac97_po_cmd
  2227 00000C45 EBE5                    	jmp	short ac97_po_cmd@
  2228                                  
  2229                                  ac97_play: ; continue to play (after pause)
  2230 00000C47 C605[08370000]00        	mov	byte [stopped], 0
  2231 00000C4E B001                    	mov	al, RPBM
  2232 00000C50 EBDC                    	jmp	short ac97_po_cmd
  2233                                  
  2234                                  ; --------------------------------------------------------
  2235                                  
  2236                                  PORTB		EQU 061h
  2237                                  REFRESH_STATUS	EQU 010h	; Refresh signal status
  2238                                  
  2239                                  	; 29/12/2024 (vgaplay3.s)
  2240                                  	; 18/12/2024
  2241                                  	; 01/12/2024 (ac97play.s)
  2242                                  delay_100ms:
  2243                                  	; 30/05/2024 (playwav7.s)
  2244 00000C52 51                      	push	ecx
  2245 00000C53 B990010000              	mov	ecx, 400  ; 400*0.25ms
  2246                                  _delay_x_ms:
  2247 00000C58 E804000000              	call	delay1_4ms
  2248 00000C5D E2F9                            loop	_delay_x_ms
  2249 00000C5F 59                      	pop	ecx
  2250 00000C60 C3                      	retn
  2251                                  
  2252                                  delay1_4ms:
  2253                                  	; 30/05/2024 (TRDOS 386)
  2254 00000C61 50                              push    eax 
  2255 00000C62 51                              push    ecx
  2256 00000C63 53                      	push	ebx
  2257 00000C64 52                      	push	edx
  2258 00000C65 B910000000                      mov     ecx, 16			; close enough.
  2259                                  	;in	al, PORTB
  2260                                  	; 30/05/2024
  2261 00000C6A 66BA6100                	mov	dx, PORTB
  2262 00000C6E B400                    	mov	ah, 0  ; read port, byte
  2263 00000C70 CD34                    	int	34h
  2264                                  
  2265 00000C72 2410                    	and	al, REFRESH_STATUS
  2266                                  	;mov	ah, al			; Start toggle state
  2267 00000C74 88C3                    	mov	bl, al
  2268 00000C76 09C9                    	or	ecx, ecx
  2269 00000C78 7401                    	jz	short _d4ms1
  2270 00000C7A 41                      	inc	ecx			; Throwaway first toggle
  2271                                  _d4ms1:	
  2272                                  	;in	al, PORTB		; Read system control port
  2273                                  	; 30/05/2024
  2274 00000C7B 66BA6100                	mov	dx, PORTB
  2275 00000C7F B400                    	mov	ah, 0  ; read port, byte
  2276 00000C81 CD34                    	int	34h
  2277                                  
  2278 00000C83 2410                    	and	al, REFRESH_STATUS	; Refresh toggles 15.085 microseconds
  2279                                  	;cmp	ah, al
  2280 00000C85 38C3                    	cmp	bl, al
  2281 00000C87 74F2                    	je	short _d4ms1		; Wait for state change
  2282                                  
  2283                                  	;mov	ah, al			; Update with new state
  2284 00000C89 88C3                    	mov	bl, al
  2285 00000C8B 49                      	dec	ecx
  2286 00000C8C 75ED                    	jnz	short _d4ms1
  2287                                  
  2288 00000C8E 5A                      	pop	edx
  2289 00000C8F 5B                              pop	ebx
  2290 00000C90 59                      	pop	ecx
  2291 00000C91 58                              pop	eax
  2292                                  c4ue_okk:
  2293 00000C92 C3                              retn
  2294                                  
  2295                                  ; --------------------------------------------------------
  2296                                  
  2297                                  getCurrentIndex:
  2298                                  	; returns AL = current index value
  2299                                  	; 01/12/2024
  2300                                  	; 29/05/2024 (TRDOS 386)
  2301                                  	; 08/11/2023
  2302 00000C93 668B15[B6370000]        	mov	dx, [NABMBAR]
  2303 00000C9A 6683C214                	add	dx, PO_CIV_REG
  2304                                  	;in	al, dx
  2305                                  	; 29/05/2024
  2306 00000C9E B400                    	mov	ah, 0 ; read port, byte
  2307 00000CA0 CD34                    	int	34h
  2308                                  uLVI2:	;	06/11/2023
  2309 00000CA2 C3                      	retn
  2310                                  
  2311                                  ; --------------------------------------------------------
  2312                                  
  2313                                  updateLVI:
  2314                                  	; 01/12/2024
  2315                                  	; 29/05/2024 (TRDOS 386)
  2316                                  	; 08/11/2023
  2317                                  	; 07/11/2023
  2318                                  	; 06/11/2023
  2319 00000CA3 668B15[B6370000]        	mov	dx, [NABMBAR]
  2320 00000CAA 6683C214                	add	dx, PO_CIV_REG
  2321                                  	; (Current Index Value and Last Valid Index value)
  2322                                  	;in	ax, dx
  2323                                  	; 29/05/2024
  2324 00000CAE B402                    	mov	ah, 2 ; read port, word
  2325 00000CB0 CD34                    	int	34h
  2326                                  
  2327 00000CB2 38E0                    	cmp	al, ah ; is current index = last index ?
  2328 00000CB4 75EC                    	jne	short uLVI2
  2329                                  
  2330                                  	; 08/11/2023	
  2331 00000CB6 E8D8FFFFFF              	call	getCurrentIndex
  2332                                   
  2333 00000CBB F605[46370000]01        	test	byte [flags], ENDOFFILE
  2334                                  	;jnz	short uLVI1
  2335 00000CC2 7418                    	jz	short uLVI0  ; 08/11/2023
  2336                                  
  2337                                  	; 08/11/2023
  2338 00000CC4 50                      	push	eax	; 29/05/2024 (32 bit)
  2339 00000CC5 668B15[B6370000]        	mov	dx, [NABMBAR]
  2340 00000CCC 6683C216                	add	dx, PO_SR_REG  ; PCM out status register
  2341                                  	;in	ax, dx
  2342                                  	; 29/05/2024
  2343 00000CD0 B402                    	mov	ah, 2 ; read port, word
  2344 00000CD2 CD34                    	int	34h
  2345                                  
  2346 00000CD4 A803                    	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
  2347                                  		      ; (has been processed)
  2348                                  		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
  2349 00000CD6 58                      	pop	eax
  2350 00000CD7 7407                    	jz	short uLVI1
  2351                                  uLVI3:
  2352 00000CD9 31C0                    	xor	eax, eax
  2353                                  	; zf = 1
  2354 00000CDB C3                      	retn
  2355                                  uLVI0:
  2356                                          ; not at the end of the file yet.
  2357 00000CDC FEC8                    	dec	al
  2358 00000CDE 241F                    	and	al, 1Fh
  2359                                  uLVI1:
  2360                                  	;call	setLastValidIndex
  2361                                  ;uLVI2:
  2362                                  	;retn
  2363                                  
  2364                                  ;input AL = index # to stop on
  2365                                  setLastValidIndex:
  2366                                  	; 01/12/2024
  2367                                  	; 29/05/2024 (TRDOS 386)
  2368                                  	; 08/11/2023
  2369 00000CE0 668B15[B6370000]        	mov	dx, [NABMBAR]
  2370 00000CE7 6683C215                	add	dx, PO_LVI_REG
  2371                                          ;out	dx, al
  2372                                  	; 29/05/2024
  2373                                  	; al = data, byte
  2374 00000CEB B401                    	mov	ah, 1 ; write port, byte
  2375 00000CED CD34                    	int	34h
  2376 00000CEF C3                      	retn
  2377                                  
  2378                                  ; --------------------------------------------------------
  2379                                  ; 07/12/2024
  2380                                  ; --------------------------------------------------------
  2381                                  
  2382                                  ; /////
  2383                                  	; 14/12/2024
  2384                                  	; 07/12/2024
  2385                                  	; 01/12/2024
  2386                                  	; 30/05/2024 (ich_wav4.asm, 19/05/2024)
  2387                                  loadFromFile:
  2388                                  	; 07/11/2023
  2389                                  
  2390 00000CF0 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2391                                  					; last of the file?
  2392 00000CF7 7402                    	jz	short lff_0		; no
  2393 00000CF9 F9                      	stc
  2394 00000CFA C3                      	retn
  2395                                  
  2396                                  lff_0:
  2397                                  	; 07/12/2024
  2398                                  	; 26/11/2023 (playwav8.s)
  2399                                  	;mov	edi, audio_buffer
  2400                                  
  2401                                  	; 01/12/2024 (TRDOS 386)
  2402                                  	; edi = audio buffer address
  2403                                  
  2404                                  	; 14/12/2024
  2405                                  	; 01/12/2024
  2406                                  	; 17/11/2024
  2407                                  	;mov	ebx, [filehandle]
  2408                                  	; 02/12/2024
  2409                                  	;mov	edx, [loadsize] 
  2410                                  
  2411                                  	; 17/11/2024
  2412 00000CFB 803D[AA370000]00        	cmp	byte [fbs_shift], 0
  2413 00000D02 7677                    	jna	short lff_1 ; stereo, 16 bit
  2414                                  
  2415                                  lff_2:
  2416                                  	; 01/12/2024
  2417 00000D04 BE[00500200]            	mov	esi, temp_buffer 
  2418                                  	; 14/12/2024
  2419                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00000D09 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000D0F 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00000D11 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000D17 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00000D1C CD40                <1>  int 40h
  2420 00000D1E 0F8289000000            	jc	lff_4 ; error !
  2421                                  
  2422                                  	; 01/12/2024
  2423                                  	; 14/11/2024
  2424 00000D24 A3[CC370000]            	mov	[count], eax
  2425                                  
  2426                                  	; 01/12/2024
  2427 00000D29 21C0                    	and	eax, eax
  2428                                  	;jz	short lff_3
  2429                                  	; 14/12/2024
  2430 00000D2B 0F8485000000            	jz	lff_10
  2431                                  
  2432 00000D31 8A1D[AA370000]          	mov	bl, [fbs_shift]
  2433                                  
  2434                                  	; 14/12/2024
  2435 00000D37 89FA                    	mov	edx, edi ; audio buffer start address
  2436                                  
  2437                                  	; 01/12/2024
  2438 00000D39 89C1                    	mov	ecx, eax
  2439 00000D3B 803D[3A370000]08        	cmp	byte [WAVE_BitsPerSample], 8 ; bits per sample (8 or 16)
  2440 00000D42 751E                    	jne	short lff_7 ; 16 bit samples
  2441                                  	; 8 bit samples
  2442 00000D44 FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
  2443 00000D46 740E                    	jz	short lff_6 ; 8 bit, stereo
  2444                                  	; 01/12/2024 (32bit registers)
  2445                                  lff_5:
  2446                                  	; mono & 8 bit
  2447 00000D48 AC                      	lodsb
  2448 00000D49 2C80                    	sub	al, 80h ; 08/11/2023
  2449 00000D4B C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
  2450 00000D4E 66AB                    	stosw	; left channel
  2451 00000D50 66AB                    	stosw	; right channel
  2452 00000D52 E2F4                    	loop	lff_5
  2453 00000D54 EB16                    	jmp	short lff_9
  2454                                  lff_6:
  2455                                  	; stereo & 8 bit
  2456 00000D56 AC                      	lodsb
  2457 00000D57 2C80                    	sub	al, 80h ; 08/11/2023
  2458 00000D59 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
  2459 00000D5C 66AB                    	stosw
  2460 00000D5E E2F6                    	loop	lff_6
  2461 00000D60 EB0A                    	jmp	short lff_9
  2462                                  lff_7:
  2463 00000D62 D1E9                    	shr	ecx, 1 ; word count
  2464                                  lff_8:
  2465 00000D64 66AD                    	lodsw
  2466 00000D66 66AB                    	stosw	; left channel
  2467 00000D68 66AB                    	stosw	; right channel
  2468 00000D6A E2F8                    	loop	lff_8
  2469                                  lff_9:
  2470                                  	; 14/12/2024
  2471 00000D6C 89F8                    	mov	eax, edi
  2472 00000D6E 8B0D[C0370000]          	mov	ecx, [buffersize] 
  2473 00000D74 01D1                    	add	ecx, edx ; + buffer start address
  2474 00000D76 39C8                    	cmp	eax, ecx	
  2475 00000D78 7225                    	jb	short lff_3
  2476 00000D7A C3                      	retn
  2477                                  	
  2478                                  lff_1:  
  2479                                  	; 07/12/2024
  2480                                  	; 01/12/2024
  2481                                  	;sys 	_read, [filehandle], esi, [loadsize] ; edx
  2482                                  	; 14/12/2024
  2483                                  	sys 	_read, [filehandle], edi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00000D7B 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000D81 89F9                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00000D83 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000D89 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00000D8E CD40                <1>  int 40h
  2484                                  	; 07/11/2023
  2485 00000D90 721B                    	jc	short lff_4 ; error !
  2486                                  
  2487                                  	; 01/12/2024
  2488                                  	; 14/11/2024
  2489 00000D92 A3[CC370000]            	mov	[count], eax
  2490                                  
  2491                                  	; 02/12/2024
  2492 00000D97 39D0                    	cmp	eax, edx ; cmp eax, [loadsize]	
  2493 00000D99 7411                    	je	short endLFF
  2494                                  	; edi = buffer (start) address
  2495 00000D9B 01C7                    	add	edi, eax
  2496 00000D9D 89D1                    	mov	ecx, edx
  2497                                  lff_3:
  2498                                  	;call	padfill			; blank pad the remainder
  2499                                  	; 21/12/2024
  2500                                  padfill:
  2501                                  	; 14/12/2024
  2502                                  	; 01/12/2024 (TRDOS 386, 32bit registers)
  2503                                  	; 17/11/2024
  2504                                  	;   di = offset (to be filled with ZEROs)
  2505                                  	;   bp = buffer segment
  2506                                  	;   ax = di = number of bytes loaded
  2507                                  	;   cx = buffer size (> loaded bytes)	
  2508                                  	; 07/11/2023
  2509                                  	; 06/11/2023
  2510                                  	; 17/02/2017
  2511                                  	; 01/12/2024
  2512 00000D9F 29C1                    	sub	ecx, eax
  2513                                  	; 01/12/2024
  2514                                  	; 25/11/2024
  2515 00000DA1 31C0                    	xor	eax, eax
  2516                                  	; 14/12/2024
  2517 00000DA3 F3AA                    	rep	stosb
  2518                                  	; 21/12/2024
  2519                                  	;retn
  2520                                  	; ----------
  2521                                          ;clc				; don't exit with CY yet.
  2522 00000DA5 800D[46370000]01                or	byte [flags], ENDOFFILE	; end of file flag
  2523                                  endLFF:
  2524 00000DAC C3                              retn
  2525                                  lff_4:
  2526                                  	; 08/11/2023
  2527 00000DAD B021                    	mov	al, '!'  ; error
  2528 00000DAF E885F9FFFF              	call	tL0
  2529                                  
  2530                                  	; 01/12/2024
  2531 00000DB4 31C0                    	xor	eax, eax
  2532                                  lff_10:
  2533                                  	; 14/12/2024
  2534 00000DB6 8B0D[C0370000]          	mov	ecx, [buffersize]
  2535 00000DBC EBE1                    	jmp	short lff_3
  2536                                  
  2537                                  ; /////
  2538                                  
  2539                                  ; --------------------------------------------------------
  2540                                  ; --------------------------------------------------------
  2541                                  	
  2542                                  write_audio_dev_info:
  2543                                  	; 30/05/2024
  2544                                       	;sys_msg msgAudioCardInfo, 0Fh
  2545                                  	; 01/12/2024
  2546                                  	sys 	_msg, msgAudioCardInfo, 255, 0Fh
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00000DBE BB[162C0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000DC3 B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00000DC8 BA0F000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000DCD B823000000          <1>  mov eax, %1
   106                              <1> 
   107 00000DD2 CD40                <1>  int 40h
  2547 00000DD4 C3                      	retn
  2548                                  
  2549                                  ; --------------------------------------------------------
  2550                                  
  2551                                  write_ac97_pci_dev_info:
  2552                                  	; 19/11/2024
  2553                                  	; 30/05/2024
  2554                                  	; 06/06/2017
  2555                                  	; 03/06/2017
  2556                                  	; BUS/DEV/FN
  2557                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  2558                                  	; DEV/VENDOR
  2559                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  2560                                  
  2561 00000DD5 A1[B0370000]            	mov	eax, [dev_vendor]
  2562 00000DDA 31DB                    	xor	ebx, ebx
  2563 00000DDC 88C3                    	mov	bl, al
  2564 00000DDE 88DA                    	mov	dl, bl
  2565 00000DE0 80E30F                  	and	bl, 0Fh
  2566 00000DE3 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2567 00000DE9 A2[842D0000]            	mov	[msgVendorId+3], al
  2568 00000DEE 88D3                    	mov	bl, dl
  2569 00000DF0 C0EB04                  	shr	bl, 4
  2570 00000DF3 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2571 00000DF9 A2[832D0000]            	mov	[msgVendorId+2], al
  2572 00000DFE 88E3                    	mov	bl, ah
  2573 00000E00 88DA                    	mov	dl, bl
  2574 00000E02 80E30F                  	and	bl, 0Fh
  2575 00000E05 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2576 00000E0B A2[822D0000]            	mov	[msgVendorId+1], al
  2577 00000E10 88D3                    	mov	bl, dl
  2578 00000E12 C0EB04                  	shr	bl, 4
  2579 00000E15 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2580 00000E1B A2[812D0000]            	mov	[msgVendorId], al
  2581 00000E20 C1E810                  	shr	eax, 16
  2582 00000E23 88C3                    	mov	bl, al
  2583 00000E25 88DA                    	mov	dl, bl
  2584 00000E27 80E30F                  	and	bl, 0Fh
  2585 00000E2A 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2586 00000E30 A2[952D0000]            	mov	[msgDevId+3], al
  2587 00000E35 88D3                    	mov	bl, dl
  2588 00000E37 C0EB04                  	shr	bl, 4
  2589 00000E3A 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2590 00000E40 A2[942D0000]            	mov	[msgDevId+2], al
  2591 00000E45 88E3                    	mov	bl, ah
  2592 00000E47 88DA                    	mov	dl, bl
  2593 00000E49 80E30F                  	and	bl, 0Fh
  2594 00000E4C 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2595 00000E52 A2[932D0000]            	mov	[msgDevId+1], al
  2596 00000E57 88D3                    	mov	bl, dl
  2597 00000E59 C0EB04                  	shr	bl, 4
  2598 00000E5C 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2599 00000E62 A2[922D0000]            	mov	[msgDevId], al
  2600                                  
  2601 00000E67 A1[AC370000]            	mov	eax, [bus_dev_fn]
  2602 00000E6C C1E808                  	shr	eax, 8
  2603 00000E6F 88C3                    	mov	bl, al
  2604 00000E71 88DA                    	mov	dl, bl
  2605 00000E73 80E307                  	and	bl, 7 ; bit 0,1,2
  2606 00000E76 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2607 00000E7C A2[BA2D0000]            	mov	[msgFncNo+1], al
  2608 00000E81 88D3                    	mov	bl, dl
  2609 00000E83 C0EB03                  	shr	bl, 3
  2610 00000E86 88DA                    	mov	dl, bl
  2611 00000E88 80E30F                  	and	bl, 0Fh
  2612 00000E8B 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2613 00000E91 A2[AC2D0000]            	mov	[msgDevNo+1], al
  2614 00000E96 88D3                    	mov	bl, dl
  2615 00000E98 C0EB04                  	shr	bl, 4
  2616 00000E9B 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2617 00000EA1 A2[AB2D0000]            	mov	[msgDevNo], al
  2618 00000EA6 88E3                    	mov	bl, ah
  2619 00000EA8 88DA                    	mov	dl, bl
  2620 00000EAA 80E30F                  	and	bl, 0Fh
  2621 00000EAD 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2622 00000EB3 A2[A02D0000]            	mov	[msgBusNo+1], al
  2623 00000EB8 88D3                    	mov	bl, dl
  2624 00000EBA C0EB04                  	shr	bl, 4
  2625 00000EBD 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2626 00000EC3 A2[9F2D0000]            	mov	[msgBusNo], al
  2627                                  
  2628                                  	;mov	ax, [ac97_NamBar]
  2629 00000EC8 66A1[B4370000]          	mov	ax, [NAMBAR]
  2630 00000ECE 88C3                    	mov	bl, al
  2631 00000ED0 88DA                    	mov	dl, bl
  2632 00000ED2 80E30F                  	and	bl, 0Fh
  2633 00000ED5 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2634 00000EDB A2[CA2D0000]            	mov	[msgNamBar+3], al
  2635 00000EE0 88D3                    	mov	bl, dl
  2636 00000EE2 C0EB04                  	shr	bl, 4
  2637 00000EE5 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2638 00000EEB A2[C92D0000]            	mov	[msgNamBar+2], al
  2639 00000EF0 88E3                    	mov	bl, ah
  2640 00000EF2 88DA                    	mov	dl, bl
  2641 00000EF4 80E30F                  	and	bl, 0Fh
  2642 00000EF7 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2643 00000EFD A2[C82D0000]            	mov	[msgNamBar+1], al
  2644 00000F02 88D3                    	mov	bl, dl
  2645 00000F04 C0EB04                  	shr	bl, 4
  2646 00000F07 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2647 00000F0D A2[C72D0000]            	mov	[msgNamBar], al
  2648                                  
  2649                                  	;mov	ax, [ac97_NabmBar]
  2650 00000F12 66A1[B6370000]          	mov	ax, [NABMBAR]
  2651 00000F18 88C3                    	mov	bl, al
  2652 00000F1A 88DA                    	mov	dl, bl
  2653 00000F1C 80E30F                  	and	bl, 0Fh
  2654 00000F1F 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2655 00000F25 A2[DA2D0000]            	mov	[msgNabmBar+3], al
  2656 00000F2A 88D3                    	mov	bl, dl
  2657 00000F2C C0EB04                  	shr	bl, 4
  2658 00000F2F 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2659 00000F35 A2[D92D0000]            	mov	[msgNabmBar+2], al
  2660 00000F3A 88E3                    	mov	bl, ah
  2661 00000F3C 88DA                    	mov	dl, bl
  2662 00000F3E 80E30F                  	and	bl, 0Fh
  2663 00000F41 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2664 00000F47 A2[D82D0000]            	mov	[msgNabmBar+1], al
  2665 00000F4C 88D3                    	mov	bl, dl
  2666 00000F4E C0EB04                  	shr	bl, 4
  2667 00000F51 8A83[3D2D0000]          	mov	al, [hex_chars+ebx]
  2668 00000F57 A2[D72D0000]            	mov	[msgNabmBar], al
  2669                                  
  2670 00000F5C 31C0                    	xor	eax, eax
  2671 00000F5E A0[47370000]            	mov	al, [ac97_int_ln_reg]
  2672 00000F63 B10A                    	mov	cl, 10
  2673 00000F65 F6F1                    	div	cl
  2674                                  	; 23/11/2024
  2675                                  	;add	[msgIRQ], ax
  2676 00000F67 66053030                	add	ax, 3030h
  2677 00000F6B 66A3[E32D0000]          	mov	[msgIRQ], ax
  2678                                  	;and	al, al
  2679 00000F71 3C30                    	cmp	al, 30h
  2680 00000F73 750D                    	jnz	short _w_ac97imsg_
  2681 00000F75 A0[E42D0000]            	mov	al, byte [msgIRQ+1]
  2682 00000F7A B420                    	mov	ah, ' '
  2683 00000F7C 66A3[E32D0000]          	mov	[msgIRQ], ax
  2684                                  _w_ac97imsg_:
  2685                                  	; 19/11/2024
  2686 00000F82 E8D81B0000              	call 	clear_window
  2687                                  	;mov	dh, 13
  2688                                  	; 30/12/2024 (video mode 13h)
  2689 00000F87 B60B                    	mov	dh, 11
  2690 00000F89 B200                    	mov	dl, 0
  2691 00000F8B E85E190000              	call	setCursorPosition
  2692                                  	;;;
  2693                                  	; 21/12/2024
  2694 00000F90 BD[4E2D0000]            	mov	ebp, msgAC97Info ; message
  2695                                  	; 22/12/2024
  2696                                  	;mov	cl, 07h ; color 
  2697 00000F95 E81F000000              	call	sys_gmsg
  2698                                  	;
  2699                                  	; 30/05/2024
  2700                                  write_VRA_info:
  2701                                  	; 21/12/2024
  2702 00000F9A BD[E82D0000]            	mov	ebp, msgVRAheader ; message
  2703                                  	;mov	cl, 07h ; color 
  2704 00000F9F E815000000              	call	sys_gmsg
  2705                                  	;
  2706 00000FA4 803D[15370000]00        	cmp	byte [VRA], 0
  2707 00000FAB 7607                    	jna	short _w_VRAi_no
  2708                                  _w_VRAi_yes:
  2709 00000FAD BD[F72D0000]            	mov	ebp, msgVRAyes
  2710 00000FB2 EB05                    	jmp	short _w_VRAi_yn_msg
  2711                                  _w_VRAi_no:
  2712 00000FB4 BD[FD2D0000]            	mov	ebp, msgVRAno
  2713                                  _w_VRAi_yn_msg:
  2714                                  	;mov	cl, 07h ; color 
  2715                                  	;call	sys_msg
  2716                                  	;retn
  2717                                  	;jmp	short sys_gmsg
  2718                                  	;;;
  2719                                  ; --------------------------------------------------------
  2720                                  
  2721                                  	; 31/12/2024 (int 31h)
  2722                                  	; 30/12/2024 (Video Mode 13h)
  2723                                  	; (write message in VGA/CGA mode)
  2724                                  	; 22/12/2024
  2725                                  	; 21/12/2024
  2726                                  	; (write message in VGA/VESA-VBE mode)
  2727                                  sys_gmsg:
  2728 00000FB9 8A4500                  	mov	al, [ebp]
  2729 00000FBC 20C0                    	and	al, al
  2730 00000FBE 740D                    	jz	short sys_gmsg_ok
  2731                                  
  2732                                  ; 31/12/2024
  2733                                  %if 0
  2734                                  	cmp	al, 20h
  2735                                  	jnb	short sys_gmsg_3
  2736                                  	cmp	al, CR ; 13
  2737                                  	jne	short sys_gmsg_2
  2738                                  	; carriege return, move cursor to column 0
  2739                                  	mov	word [screenpos], 0
  2740                                  sys_gmsg_1:
  2741                                  	inc	ebp
  2742                                  	jmp	short sys_gmsg
  2743                                  sys_gmsg_2:
  2744                                  	cmp	al, LF ; 10
  2745                                  	jne	short sys_gmsg_ok ; 22/12/2024
  2746                                  	; line feed, move cursor to next row
  2747                                  	;add	word [screenpos+2], 16
  2748                                  	; 30/12/2024
  2749                                  	add	word [screenpos+2], 8
  2750                                  	jmp	short sys_gmsg_1
  2751                                  sys_gmsg_3:
  2752                                  	mov	esi, [screenpos]
  2753                                  		; hw = (cursor) row
  2754                                  		; si = (cursor) column
  2755                                  	mov	ecx, 07h ; gray (light)
  2756                                  	call	write_character
  2757                                  	add	esi, 8
  2758                                  	;;;
  2759                                  	;cmp	si, 640
  2760                                  	; 30/12/2024 (cgaplay.s)
  2761                                  	cmp	si, 320
  2762                                  	jb	short sys_gmsg_5
  2763                                  	shr	esi, 16
  2764                                  	;add	si, 16
  2765                                  	;cmp	si, 480
  2766                                  	; 30/12/2024
  2767                                  	add	si, 8
  2768                                  	cmp	si, 200
  2769                                  	jb	short sys_gmsg_4
  2770                                  	xor	esi, esi
  2771                                  sys_gmsg_4:
  2772                                  	shl	esi, 16
  2773                                  	;;;
  2774                                  sys_gmsg_5:
  2775                                  	mov	[screenpos], esi
  2776                                  	inc	ebp
  2777                                  	jmp	short sys_gmsg
  2778                                  %endif
  2779                                  	; 31/12/2024
  2780 00000FC0 B907000000              	mov	ecx, 07h ; gray (light)
  2781 00000FC5 E8B01A0000              	call	write_character
  2782 00000FCA 45                      	inc	ebp
  2783 00000FCB EBEC                    	jmp	short sys_gmsg
  2784                                  
  2785                                  sys_gmsg_ok:
  2786 00000FCD C3                      	retn
  2787                                  	;;;
  2788                                  
  2789                                  ; --------------------------------------------------------
  2790                                  
  2791                                  ; 29/12/2024 - vgaplay3.s
  2792                                  ; 18/12/2024
  2793                                  ; 01/12/2024 - ac97play.s
  2794                                  ; 29/05/2024
  2795                                  ; 26/11/2023
  2796                                  ; 25/11/2023 - playwav6.s (32 bit registers, TRDOS 386 adaption)
  2797                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  2798                                  ; 14/11/2023
  2799                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  2800                                  ; --------------------------------------------------------
  2801                                  
  2802                                  ;;Note:	At the end of every buffer load,
  2803                                  ;;	during buffer switch/swap, there will be discontinuity
  2804                                  ;;	between the last converted sample and the 1st sample
  2805                                  ;;	of the next buffer.
  2806                                  ;;	(like as a dot noises vaguely between normal sound samples)
  2807                                  ;;	-To avoid this defect, the 1st sample of
  2808                                  ;;	the next buffer may be read from the wav file but
  2809                                  ;;	the file pointer would need to be set to 1 sample back
  2810                                  ;;	again via seek system call. Time comsumption problem! -
  2811                                  ;;
  2812                                  ;;	Erdogan Tan - 15/11/2023
  2813                                  ;;
  2814                                  ;;	((If entire wav data would be loaded at once.. conversion
  2815                                  ;;	defect/noise would disappear.. but for DOS, to keep
  2816                                  ;;	64KB buffer limit is important also it is important
  2817                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  2818                                  ;;	I have tested this program by using 2-30MB wav files.))
  2819                                  ;;
  2820                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  2821                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  2822                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  2823                                  ;;			Realtek ALC850 codec.
  2824                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  2825                                  
  2826                                  load_8khz_mono_8_bit:
  2827                                  	; 15/11/2023
  2828                                  	; 14/11/2023
  2829                                  	; 13/11/2023
  2830 00000FCE F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2831                                  					; last of the file?
  2832 00000FD5 7402                    	jz	short lff8m_0		; no
  2833 00000FD7 F9                      	stc
  2834 00000FD8 C3                      	retn
  2835                                  
  2836                                  lff8m_0:
  2837                                  	; 01/12/2024
  2838                                  	; edi = audio buffer address
  2839                                  	; 13/12/2024
  2840 00000FD9 893D[04320000]          	mov	[audio_buffer], edi
  2841 00000FDF BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2842                                          ;mov	edx, [loadsize]
  2843                                  
  2844                                  	; esi = buffer address
  2845                                  	;; edx = buffer size
  2846                                  
  2847                                  	; load file into memory
  2848                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00000FE4 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000FEA 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00000FEC 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000FF2 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00000FF7 CD40                <1>  int 40h
  2849 00000FF9 7305                    	jnc	short lff8m_6
  2850 00000FFB E9B3000000              	jmp	lff8m_5  ; error !
  2851                                  
  2852                                  lff8m_6:
  2853                                  	; 01/12/2024
  2854 00001000 A3[CC370000]            	mov	[count], eax
  2855                                  	;mov	edi, audio_buffer
  2856                                  	; 29/05/2024
  2857 00001005 8B3D[04320000]          	mov	edi, [audio_buffer]
  2858                                  	;and	eax, eax
  2859 0000100B 0F8499000000            	jz	lff8_eof
  2860                                  
  2861 00001011 89C1                    	mov	ecx, eax		; byte count
  2862                                  lff8m_1:
  2863 00001013 AC                      	lodsb
  2864 00001014 A2[C3260000]            	mov	[previous_val], al
  2865 00001019 2C80                    	sub	al, 80h
  2866 0000101B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2867 0000101F 66AB                    	stosw		; original sample (left channel)
  2868 00001021 66AB                    	stosw		; original sample (right channel)
  2869                                  	;xor	eax, eax
  2870 00001023 B080                    	mov	al, 80h
  2871 00001025 49                      	dec	ecx
  2872 00001026 7402                    	jz	short lff8m_2
  2873 00001028 8A06                    	mov	al, [esi]
  2874                                  lff8m_2:
  2875                                  	;mov	[next_val], ax
  2876 0000102A 88C7                    	mov	bh, al	; [next_val]
  2877 0000102C 8A25[C3260000]          	mov	ah, [previous_val]
  2878 00001032 00E0                    	add	al, ah	; [previous_val]
  2879 00001034 D0D8                    	rcr	al, 1
  2880 00001036 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  2881 00001038 00E0                    	add	al, ah	; [previous_val]
  2882 0000103A D0D8                    	rcr	al, 1	
  2883 0000103C 88C3                    	mov	bl, al 	; this is temporary interpolation value
  2884 0000103E 00E0                    	add	al, ah	; [previous_val]
  2885 00001040 D0D8                    	rcr	al, 1
  2886 00001042 2C80                    	sub	al, 80h
  2887 00001044 66C1E008                	shl	ax, 8	
  2888 00001048 66AB                    	stosw		; this is 1st interpolated sample (L)
  2889 0000104A 66AB                    	stosw		; this is 1st interpolated sample (R)
  2890 0000104C 88D8                    	mov	al, bl
  2891 0000104E 00D0                    	add	al, dl
  2892 00001050 D0D8                    	rcr	al, 1
  2893 00001052 2C80                    	sub	al, 80h
  2894 00001054 66C1E008                	shl	ax, 8
  2895 00001058 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2896 0000105A 66AB                    	stosw		; this is 2nd interpolated sample (R)
  2897 0000105C 88D0                    	mov	al, dl
  2898 0000105E 2C80                    	sub	al, 80h
  2899 00001060 66C1E008                	shl	ax, 8
  2900 00001064 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  2901 00001066 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  2902                                  	;mov	al, [next_val]
  2903 00001068 88F8                    	mov	al, bh
  2904 0000106A 00D0                    	add	al, dl
  2905 0000106C D0D8                    	rcr	al, 1
  2906 0000106E 88C3                    	mov	bl, al	; this is temporary interpolation value
  2907 00001070 00D0                    	add	al, dl
  2908 00001072 D0D8                    	rcr	al, 1
  2909 00001074 2C80                    	sub	al, 80h
  2910 00001076 66C1E008                	shl	ax, 8
  2911 0000107A 66AB                    	stosw		; this is 4th interpolated sample (L)
  2912 0000107C 66AB                    	stosw		; this is 4th interpolated sample (R)
  2913                                  	;mov	al, [next_val]
  2914 0000107E 88F8                    	mov	al, bh
  2915 00001080 00D8                    	add	al, bl
  2916 00001082 D0D8                    	rcr	al, 1
  2917 00001084 2C80                    	sub	al, 80h
  2918 00001086 66C1E008                	shl	ax, 8
  2919 0000108A 66AB                    	stosw		; this is 5th interpolated sample (L)
  2920 0000108C 66AB                    	stosw		; this is 5th interpolated sample (R)
  2921                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2922 0000108E 09C9                    	or	ecx, ecx
  2923 00001090 7581                    	jnz	short lff8m_1
  2924                                  
  2925                                  	; --------------
  2926                                  
  2927                                  lff8s_3:
  2928                                  lff8m_3:
  2929                                  lff8s2_3:
  2930                                  lff8m2_3:
  2931                                  lff16s_3:
  2932                                  lff16m_3:
  2933                                  lff16s2_3:
  2934                                  lff16m2_3:
  2935                                  lff24_3:
  2936                                  lff32_3:
  2937                                  lff44_3:
  2938                                  lff22_3:
  2939                                  lff11_3:
  2940                                  	; 08/12/2024 (BugFix)
  2941                                  	; 31/05/2024
  2942 00001092 8B0D[C0370000]          	mov	ecx, [buffersize] ; buffer size in words
  2943                                  	; 29/12/2024
  2944                                  	; 08/12/2024
  2945                                  	;shl	ecx, 1 ; buffer size in bytes
  2946                                  	; 13/12/2024
  2947 00001098 030D[04320000]          	add	ecx, [audio_buffer] ; + start address of the buffer
  2948 0000109E 29F9                    	sub	ecx, edi
  2949 000010A0 7607                    	jna	short lff8m_4
  2950                                  	;inc	ecx
  2951 000010A2 C1E902                  	shr	ecx, 2
  2952 000010A5 31C0                    	xor	eax, eax ; fill (remain part of) buffer with zeros
  2953 000010A7 F3AB                    	rep	stosd
  2954                                  lff8m_4:
  2955                                  	; 31/05/2024
  2956                                  	; cf=1
  2957                                  	; 08/12/2024
  2958                                  	;clc
  2959 000010A9 C3                      	retn
  2960                                  
  2961                                  lff8_eof:
  2962                                  lff16_eof:
  2963                                  lff24_eof:
  2964                                  lff32_eof:
  2965                                  lff44_eof:
  2966                                  lff22_eof:
  2967                                  lff11_eof:
  2968                                  	; 15/11/2023
  2969 000010AA C605[46370000]01        	mov	byte [flags], ENDOFFILE
  2970 000010B1 EBDF                    	jmp	short lff8m_3
  2971                                  
  2972                                  lff8s_5:
  2973                                  lff8m_5:
  2974                                  lff8s2_5:
  2975                                  lff8m2_5:
  2976                                  lff16s_5:
  2977                                  lff16m_5:
  2978                                  lff16s2_5:
  2979                                  lff16m2_5:
  2980                                  lff24_5:
  2981                                  lff32_5:
  2982                                  lff44_5:
  2983                                  lff22_5:
  2984                                  lff11_5:
  2985 000010B3 B021                    	mov	al, '!'  ; error
  2986 000010B5 E87FF6FFFF              	call	tL0
  2987                                  	
  2988                                  	;jmp	short lff8m_3
  2989                                  	; 15/11/2023
  2990 000010BA EBEE                    	jmp	lff8_eof
  2991                                  
  2992                                  	; --------------
  2993                                  
  2994                                  load_8khz_stereo_8_bit:
  2995                                  	; 15/11/2023
  2996                                  	; 14/11/2023
  2997                                  	; 13/11/2023
  2998 000010BC F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2999                                  					; last of the file?
  3000 000010C3 7402                    	jz	short lff8s_0		; no
  3001 000010C5 F9                      	stc
  3002 000010C6 C3                      	retn
  3003                                  
  3004                                  lff8s_0:
  3005                                  	; 01/12/2024
  3006                                  	; edi = audio buffer address
  3007                                  	; 13/12/2024
  3008 000010C7 893D[04320000]          	mov	[audio_buffer], edi
  3009 000010CD BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3010                                          ;mov	edx, [loadsize]
  3011                                  
  3012                                  	; esi = buffer address
  3013                                  	;; edx = buffer size
  3014                                  
  3015                                  	; load file into memory
  3016                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000010D2 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000010D8 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000010DA 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000010E0 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000010E5 CD40                <1>  int 40h
  3017 000010E7 72CA                    	jc	short lff8s_5 ; error !
  3018                                  
  3019                                  	; 01/12/2024
  3020 000010E9 A3[CC370000]            	mov	[count], eax
  3021                                  
  3022                                  	;mov	edi, audio_buffer
  3023                                  	; 29/05/2024
  3024                                  	;mov	edi, [audio_buffer]
  3025                                  	
  3026 000010EE D1E8                    	shr	eax, 1
  3027 000010F0 74B8                    	jz	short lff8_eof
  3028                                  
  3029 000010F2 89C1                    	mov	ecx, eax	; word count
  3030                                  lff8s_1:
  3031 000010F4 AC                      	lodsb
  3032 000010F5 A2[C3260000]            	mov	[previous_val_l], al
  3033 000010FA 2C80                    	sub	al, 80h
  3034 000010FC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3035 00001100 66AB                    	stosw		; original sample (L)
  3036 00001102 AC                      	lodsb
  3037 00001103 A2[C5260000]            	mov	[previous_val_r], al
  3038 00001108 2C80                    	sub	al, 80h
  3039 0000110A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3040 0000110E 66AB                    	stosw		; original sample (R)
  3041                                  
  3042                                  	;xor	eax, eax
  3043 00001110 66B88080                	mov	ax, 8080h
  3044 00001114 49                      	dec	ecx
  3045 00001115 7403                    	jz	short lff8s_2
  3046                                  		; convert 8 bit sample to 16 bit sample
  3047 00001117 668B06                  	mov	ax, [esi]
  3048                                  lff8s_2:
  3049 0000111A A2[C7260000]            	mov	[next_val_l], al
  3050 0000111F 8825[C9260000]          	mov	[next_val_r], ah
  3051 00001125 8A25[C3260000]          	mov	ah, [previous_val_l]
  3052 0000112B 00E0                    	add	al, ah
  3053 0000112D D0D8                    	rcr	al, 1
  3054 0000112F 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  3055 00001131 00E0                    	add	al, ah
  3056 00001133 D0D8                    	rcr	al, 1
  3057 00001135 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  3058 00001137 00E0                    	add	al, ah
  3059 00001139 D0D8                    	rcr	al, 1
  3060 0000113B 2C80                    	sub	al, 80h
  3061 0000113D 66C1E008                	shl	ax, 8
  3062 00001141 66AB                    	stosw		; this is 1st interpolated sample (L)
  3063 00001143 A0[C9260000]            	mov	al, [next_val_r]
  3064 00001148 8A25[C5260000]          	mov	ah, [previous_val_r]
  3065 0000114E 00E0                    	add	al, ah
  3066 00001150 D0D8                    	rcr	al, 1
  3067 00001152 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  3068 00001154 00E0                    	add	al, ah
  3069 00001156 D0D8                    	rcr	al, 1
  3070 00001158 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  3071 0000115A 00E0                    	add	al, ah
  3072 0000115C D0D8                    	rcr	al, 1
  3073 0000115E 2C80                    	sub	al, 80h
  3074 00001160 66C1E008                	shl	ax, 8
  3075 00001164 66AB                    	stosw		; this is 1st interpolated sample (R)
  3076 00001166 88D8                    	mov	al, bl
  3077 00001168 00D0                    	add	al, dl
  3078 0000116A D0D8                    	rcr	al, 1
  3079 0000116C 2C80                    	sub	al, 80h
  3080 0000116E 66C1E008                	shl	ax, 8
  3081 00001172 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3082 00001174 88F8                    	mov	al, bh
  3083 00001176 00F0                    	add	al, dh
  3084 00001178 D0D8                    	rcr	al, 1
  3085 0000117A 2C80                    	sub	al, 80h
  3086 0000117C 66C1E008                	shl	ax, 8
  3087 00001180 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3088 00001182 88D0                    	mov	al, dl
  3089 00001184 2C80                    	sub	al, 80h
  3090 00001186 66C1E008                	shl	ax, 8
  3091 0000118A 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  3092 0000118C 88F0                    	mov	al, dh
  3093 0000118E 2C80                    	sub	al, 80h
  3094 00001190 66C1E008                	shl	ax, 8
  3095 00001194 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  3096 00001196 A0[C7260000]            	mov	al, [next_val_l]
  3097 0000119B 00D0                    	add	al, dl
  3098 0000119D D0D8                    	rcr	al, 1
  3099 0000119F 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  3100 000011A1 00D0                    	add	al, dl
  3101 000011A3 D0D8                    	rcr	al, 1
  3102 000011A5 2C80                    	sub	al, 80h
  3103 000011A7 66C1E008                	shl	ax, 8
  3104 000011AB 66AB                    	stosw		; this is 4th interpolated sample (L)
  3105 000011AD A0[C9260000]            	mov	al, [next_val_r]
  3106 000011B2 00F0                    	add	al, dh
  3107 000011B4 D0D8                    	rcr	al, 1
  3108 000011B6 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  3109 000011B8 00F0                    	add	al, dh
  3110 000011BA D0D8                    	rcr	al, 1
  3111 000011BC 2C80                    	sub	al, 80h
  3112 000011BE 66C1E008                	shl	ax, 8
  3113 000011C2 66AB                    	stosw		; this is 4th interpolated sample (R)
  3114 000011C4 A0[C7260000]            	mov	al, [next_val_l]
  3115 000011C9 00D8                    	add	al, bl
  3116 000011CB D0D8                    	rcr	al, 1
  3117 000011CD 2C80                    	sub	al, 80h
  3118 000011CF 66C1E008                	shl	ax, 8
  3119 000011D3 66AB                    	stosw		; this is 5th interpolated sample (L)
  3120 000011D5 A0[C9260000]            	mov	al, [next_val_r]
  3121 000011DA 00F8                    	add	al, bh
  3122 000011DC D0D8                    	rcr	al, 1
  3123 000011DE 2C80                    	sub	al, 80h
  3124 000011E0 66C1E008                	shl	ax, 8
  3125 000011E4 66AB                    	stosw		; this is 5th interpolated sample (R)
  3126                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3127 000011E6 E305                    	jecxz	lff8s_6
  3128 000011E8 E907FFFFFF              	jmp	lff8s_1
  3129                                  lff8s_6:
  3130 000011ED E9A0FEFFFF              	jmp	lff8s_3
  3131                                  
  3132                                  load_8khz_mono_16_bit:
  3133                                  	; 13/11/2023
  3134 000011F2 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3135                                  					; last of the file?
  3136 000011F9 7402                    	jz	short lff8m2_0		; no
  3137 000011FB F9                      	stc
  3138 000011FC C3                      	retn
  3139                                  
  3140                                  lff8m2_0:
  3141                                  	; 01/12/2024
  3142                                  	; edi = audio buffer address
  3143                                  	; 13/12/2024
  3144 000011FD 893D[04320000]          	mov	[audio_buffer], edi
  3145 00001203 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3146                                          ;mov	edx, [loadsize]
  3147                                  
  3148                                  	; esi = buffer address
  3149                                  	;; edx = buffer size
  3150                                  
  3151                                  	; load file into memory
  3152                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001208 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 0000120E 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001210 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001216 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 0000121B CD40                <1>  int 40h
  3153 0000121D 0F82A0000000            	jc	lff8m2_7 ; error !
  3154                                  
  3155                                  	; 01/12/2024
  3156 00001223 A3[CC370000]            	mov	[count], eax
  3157                                  
  3158                                  	;mov	edi, audio_buffer
  3159                                  	; 29/05/2024
  3160                                  	;mov	edi, [audio_buffer]
  3161                                  	
  3162 00001228 D1E8                    	shr	eax, 1
  3163 0000122A 7505                    	jnz	short lff8m2_8
  3164 0000122C E979FEFFFF              	jmp	lff8_eof
  3165                                  
  3166                                  lff8m2_8:
  3167 00001231 89C1                    	mov	ecx, eax	; word count
  3168                                  lff8m2_1:
  3169 00001233 66AD                    	lodsw
  3170 00001235 66AB                    	stosw		; original sample (left channel)
  3171 00001237 66AB                    	stosw		; original sample (right channel)
  3172 00001239 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3173 0000123C 66A3[C3260000]          	mov	[previous_val], ax
  3174 00001242 31C0                    	xor	eax, eax
  3175 00001244 49                      	dec	ecx
  3176 00001245 7403                    	jz	short lff8m2_2
  3177 00001247 668B06                  	mov	ax, [esi]
  3178                                  lff8m2_2:
  3179 0000124A 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  3180 0000124D 89C5                    	mov	ebp, eax	; [next_val]
  3181 0000124F 660305[C3260000]        	add	ax, [previous_val]
  3182 00001256 66D1D8                  	rcr	ax, 1
  3183 00001259 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample
  3184 0000125B 660305[C3260000]        	add	ax, [previous_val]
  3185 00001262 66D1D8                  	rcr	ax, 1	; this is temporary interpolation value
  3186 00001265 89C3                    	mov	ebx, eax 		
  3187 00001267 660305[C3260000]        	add	ax, [previous_val]
  3188 0000126E 66D1D8                  	rcr	ax, 1
  3189 00001271 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3190 00001274 66AB                    	stosw		; this is 1st interpolated sample (L)
  3191 00001276 66AB                    	stosw		; this is 1st interpolated sample (R)
  3192 00001278 89D8                    	mov	eax, ebx
  3193 0000127A 6601D0                  	add	ax, dx
  3194 0000127D 66D1D8                  	rcr	ax, 1
  3195 00001280 80EC80                  	sub	ah, 80h
  3196 00001283 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3197 00001285 66AB                    	stosw		; this is 2nd interpolated sample (R)
  3198 00001287 89D0                    	mov	eax, edx
  3199 00001289 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3200 0000128C 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  3201 0000128E 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  3202 00001290 89E8                    	mov	eax, ebp
  3203 00001292 6601D0                  	add	ax, dx
  3204 00001295 66D1D8                  	rcr	ax, 1
  3205 00001298 89C3                    	mov	ebx, eax ; this is temporary interpolation value
  3206 0000129A 6601D0                  	add	ax, dx
  3207 0000129D 66D1D8                  	rcr	ax, 1
  3208 000012A0 80EC80                  	sub	ah, 80h
  3209 000012A3 66AB                    	stosw		; this is 4th interpolated sample (L)
  3210 000012A5 66AB                    	stosw		; this is 4th interpolated sample (R)
  3211 000012A7 89E8                    	mov	eax, ebp
  3212 000012A9 6601D8                  	add	ax, bx
  3213 000012AC 66D1D8                  	rcr	ax, 1
  3214 000012AF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3215 000012B2 66AB                    	stosw		; this is 5th interpolated sample (L)
  3216 000012B4 66AB                    	stosw		; this is 5th interpolated sample (R)
  3217                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3218 000012B6 09C9                    	or	ecx, ecx
  3219 000012B8 0F8575FFFFFF            	jnz	lff8m2_1
  3220 000012BE E9CFFDFFFF              	jmp	lff8m2_3
  3221                                  
  3222                                  lff8m2_7:
  3223                                  lff8s2_7:
  3224 000012C3 E9EBFDFFFF              	jmp	lff8m2_5  ; error
  3225                                  
  3226                                  load_8khz_stereo_16_bit:
  3227                                  	; 16/11/2023
  3228                                  	; 15/11/2023
  3229                                  	; 13/11/2023
  3230 000012C8 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3231                                  					; last of the file?
  3232 000012CF 7402                    	jz	short lff8s2_0		; no
  3233 000012D1 F9                      	stc
  3234 000012D2 C3                      	retn
  3235                                  
  3236                                  lff8s2_0:
  3237                                  	; 01/12/2024
  3238                                  	; edi = audio buffer address
  3239                                  	; 13/12/2024
  3240 000012D3 893D[04320000]          	mov	[audio_buffer], edi
  3241 000012D9 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3242                                          ;mov	edx, [loadsize]
  3243                                  
  3244                                  	; esi = buffer address
  3245                                  	;; edx = buffer size
  3246                                  
  3247                                  	; load file into memory
  3248                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000012DE 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000012E4 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000012E6 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000012EC B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000012F1 CD40                <1>  int 40h
  3249 000012F3 72CE                    	jc	short lff8s2_7 ; error !
  3250                                  
  3251                                  	; 01/12/2024
  3252 000012F5 A3[CC370000]            	mov	[count], eax
  3253                                  
  3254                                  	;mov	edi, audio_buffer
  3255                                  	; 29/05/2024
  3256                                  	;mov	edi, [audio_buffer]
  3257                                  	
  3258 000012FA C1E802                  	shr	eax, 2
  3259 000012FD 7505                    	jnz	short lff8s2_8
  3260 000012FF E9A6FDFFFF              	jmp	lff8_eof
  3261                                  
  3262                                  lff8s2_8:
  3263 00001304 89C1                    	mov	ecx, eax ; dword count
  3264                                  lff8s2_1:
  3265 00001306 66AD                    	lodsw
  3266 00001308 66AB                    	stosw		; original sample (L)
  3267                                  	; 15/11/2023
  3268 0000130A 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3269 0000130D 66A3[C3260000]          	mov	[previous_val_l], ax
  3270 00001313 66AD                    	lodsw
  3271 00001315 66AB                    	stosw		; original sample (R)
  3272 00001317 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3273 0000131A 66A3[C5260000]          	mov	[previous_val_r], ax
  3274 00001320 31D2                    	xor	edx, edx
  3275 00001322 31C0                    	xor	eax, eax
  3276                                  	; 16/11/2023
  3277 00001324 49                      	dec	ecx
  3278 00001325 7407                    	jz	short lff8s2_2
  3279 00001327 668B06                  	mov	ax, [esi]
  3280 0000132A 668B5602                	mov	dx, [esi+2]
  3281                                  lff8s2_2:
  3282 0000132E 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3283 00001331 66A3[C7260000]          	mov	[next_val_l], ax
  3284 00001337 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  3285 0000133A 668915[C9260000]        	mov	[next_val_r], dx
  3286 00001341 660305[C3260000]        	add	ax, [previous_val_l]
  3287 00001348 66D1D8                  	rcr	ax, 1
  3288 0000134B 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample (L)
  3289 0000134D 660305[C3260000]        	add	ax, [previous_val_l]
  3290 00001354 66D1D8                  	rcr	ax, 1	
  3291 00001357 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  3292 00001359 660305[C3260000]        	add	ax, [previous_val_l]
  3293 00001360 66D1D8                  	rcr	ax, 1
  3294 00001363 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3295 00001366 66AB                    	stosw		; this is 1st interpolated sample (L)
  3296 00001368 66A1[C9260000]          	mov	ax, [next_val_r]
  3297 0000136E 660305[C5260000]        	add	ax, [previous_val_r]
  3298 00001375 66D1D8                  	rcr	ax, 1
  3299 00001378 89C5                    	mov	ebp, eax ; this is interpolated middle (3th) sample (R)
  3300 0000137A 660305[C5260000]        	add	ax, [previous_val_r]
  3301 00001381 66D1D8                  	rcr	ax, 1
  3302 00001384 50                      	push	eax ; *	; this is temporary interpolation value (R)
  3303 00001385 660305[C5260000]        	add	ax, [previous_val_r]
  3304 0000138C 66D1D8                  	rcr	ax, 1
  3305 0000138F 80EC80                  	sub	ah, 80h
  3306 00001392 66AB                    	stosw		; this is 1st interpolated sample (R)
  3307 00001394 89D8                    	mov	eax, ebx
  3308 00001396 6601D0                  	add	ax, dx
  3309 00001399 66D1D8                  	rcr	ax, 1
  3310 0000139C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3311 0000139F 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3312 000013A1 58                      	pop	eax ; *
  3313 000013A2 6601E8                  	add	ax, bp
  3314 000013A5 66D1D8                  	rcr	ax, 1
  3315 000013A8 80EC80                  	sub	ah, 80h
  3316 000013AB 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3317 000013AD 89D0                    	mov	eax, edx
  3318 000013AF 80EC80                  	sub	ah, 80h
  3319 000013B2 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  3320 000013B4 89E8                    	mov	eax, ebp
  3321 000013B6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3322 000013B9 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  3323 000013BB 66A1[C7260000]          	mov	ax, [next_val_l]
  3324 000013C1 6601D0                  	add	ax, dx
  3325 000013C4 66D1D8                  	rcr	ax, 1
  3326 000013C7 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  3327 000013C9 6601D0                  	add	ax, dx
  3328 000013CC 66D1D8                  	rcr	ax, 1
  3329 000013CF 80EC80                  	sub	ah, 80h
  3330 000013D2 66AB                    	stosw		; this is 4th interpolated sample (L)
  3331 000013D4 66A1[C9260000]          	mov	ax, [next_val_r]
  3332 000013DA 6601E8                  	add	ax, bp
  3333 000013DD 66D1D8                  	rcr	ax, 1
  3334 000013E0 50                      	push	eax ; ** ; this is temporary interpolation value (R)
  3335 000013E1 6601E8                  	add	ax, bp
  3336 000013E4 66D1D8                  	rcr	ax, 1
  3337 000013E7 80EC80                  	sub	ah, 80h
  3338 000013EA 66AB                    	stosw		; this is 4th interpolated sample (R)
  3339 000013EC 66A1[C7260000]          	mov	ax, [next_val_l]
  3340 000013F2 6601D8                  	add	ax, bx
  3341 000013F5 66D1D8                  	rcr	ax, 1
  3342 000013F8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3343 000013FB 66AB                    	stosw		; this is 5th interpolated sample (L)
  3344 000013FD 58                      	pop	eax ; **
  3345 000013FE 660305[C9260000]        	add	ax, [next_val_r]
  3346 00001405 66D1D8                  	rcr	ax, 1
  3347 00001408 80EC80                  	sub	ah, 80h
  3348 0000140B 66AB                    	stosw		; this is 5th interpolated sample (R)
  3349                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3350 0000140D E305                    	jecxz	lff8_s2_9
  3351 0000140F E9F2FEFFFF              	jmp	lff8s2_1
  3352                                  lff8_s2_9:
  3353 00001414 E979FCFFFF              	jmp	lff8s2_3
  3354                                  
  3355                                  ; .....................
  3356                                  
  3357                                  load_16khz_mono_8_bit:
  3358                                  	; 14/11/2023
  3359                                  	; 13/11/2023
  3360 00001419 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3361                                  					; last of the file?
  3362 00001420 7402                    	jz	short lff16m_0		; no
  3363 00001422 F9                      	stc
  3364 00001423 C3                      	retn
  3365                                  
  3366                                  lff16m_0:
  3367                                  	; 01/12/2024
  3368                                  	; edi = audio buffer address
  3369                                  	; 13/12/2024
  3370 00001424 893D[04320000]          	mov	[audio_buffer], edi
  3371 0000142A BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3372                                          ;mov	edx, [loadsize]
  3373                                  
  3374                                  	; esi = buffer address
  3375                                  	;; edx = buffer size
  3376                                  
  3377                                  	; load file into memory
  3378                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 0000142F 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001435 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001437 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 0000143D B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001442 CD40                <1>  int 40h
  3379 00001444 7253                    	jc	short lff16m_7 ; error !
  3380                                  
  3381                                  	; 01/12/2024
  3382 00001446 A3[CC370000]            	mov	[count], eax
  3383                                  
  3384                                  	;mov	edi, audio_buffer
  3385                                  	; 29/05/2024
  3386                                  	;mov	edi, [audio_buffer]
  3387                                  	
  3388 0000144B 21C0                    	and	eax, eax
  3389 0000144D 7505                    	jnz	short lff16m_8
  3390 0000144F E956FCFFFF              	jmp	lff16_eof
  3391                                  
  3392                                  lff16m_8:
  3393 00001454 89C1                    	mov	ecx, eax		; byte count
  3394                                  lff16m_1:
  3395 00001456 AC                      	lodsb
  3396                                  	;mov	[previous_val], al
  3397 00001457 88C3                    	mov	bl, al
  3398 00001459 2C80                    	sub	al, 80h
  3399 0000145B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3400 0000145F 66AB                    	stosw		; original sample (left channel)
  3401 00001461 66AB                    	stosw		; original sample (right channel)
  3402                                  	;xor	ax, ax
  3403                                  	; 14/11/22023
  3404 00001463 B080                    	mov	al, 80h
  3405 00001465 49                      	dec	ecx
  3406 00001466 7402                    	jz	short lff16m_2
  3407 00001468 8A06                    	mov	al, [esi]
  3408                                  lff16m_2:
  3409                                  	;mov	[next_val], al
  3410 0000146A 88C7                    	mov	bh, al
  3411                                  	;add	al, [previous_val]
  3412 0000146C 00D8                    	add	al, bl
  3413 0000146E D0D8                    	rcr	al, 1
  3414 00001470 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  3415                                  	;add	al, [previous_val]
  3416 00001472 00D8                    	add	al, bl
  3417 00001474 D0D8                    	rcr	al, 1
  3418 00001476 2C80                    	sub	al, 80h
  3419 00001478 66C1E008                	shl	ax, 8
  3420 0000147C 66AB                    	stosw		; this is 1st interpolated sample (L)
  3421 0000147E 66AB                    	stosw		; this is 1st interpolated sample (R)
  3422                                  	;mov	al, [next_val]
  3423 00001480 88F8                    	mov	al, bh
  3424 00001482 00D0                    	add	al, dl
  3425 00001484 D0D8                    	rcr	al, 1
  3426 00001486 2C80                    	sub	al, 80h
  3427 00001488 66C1E008                	shl	ax, 8
  3428 0000148C 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3429 0000148E 66AB                    	stosw		; this is 2nd interpolated sample (R)
  3430                                  	
  3431                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3432 00001490 09C9                    	or	ecx, ecx
  3433 00001492 75C2                    	jnz	short lff16m_1
  3434 00001494 E9F9FBFFFF              	jmp	lff16m_3
  3435                                  
  3436                                  lff16m_7:
  3437                                  lff16s_7:
  3438 00001499 E915FCFFFF              	jmp	lff16m_5  ; error
  3439                                  
  3440                                  load_16khz_stereo_8_bit:
  3441                                  	; 14/11/2023
  3442                                  	; 13/11/2023
  3443 0000149E F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3444                                  					; last of the file?
  3445 000014A5 7402                    	jz	short lff16s_0		; no
  3446 000014A7 F9                      	stc
  3447 000014A8 C3                      	retn
  3448                                  
  3449                                  lff16s_0:
  3450                                  	; 01/12/2024
  3451                                  	; edi = audio buffer address
  3452                                  	; 13/12/2024
  3453 000014A9 893D[04320000]          	mov	[audio_buffer], edi
  3454 000014AF BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3455                                          ;mov	edx, [loadsize]
  3456                                  
  3457                                  	; esi = buffer address
  3458                                  	;; edx = buffer size
  3459                                  
  3460                                  	; load file into memory
  3461                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000014B4 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000014BA 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000014BC 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000014C2 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000014C7 CD40                <1>  int 40h
  3462 000014C9 72CE                    	jc	short lff16s_7 ; error !
  3463                                  
  3464                                  	; 01/12/2024
  3465 000014CB A3[CC370000]            	mov	[count], eax
  3466                                  
  3467                                  	;mov	edi, audio_buffer
  3468                                  	; 29/05/2024
  3469                                  	;mov	edi, [audio_buffer]
  3470                                  	
  3471 000014D0 D1E8                    	shr	eax, 1
  3472 000014D2 7505                    	jnz	short lff16s_8
  3473 000014D4 E9D1FBFFFF              	jmp	lff16_eof
  3474                                  
  3475                                  lff16s_8:
  3476 000014D9 89C1                    	mov	ecx, eax	; word count
  3477                                  lff16s_1:
  3478 000014DB AC                      	lodsb
  3479 000014DC A2[C3260000]            	mov	[previous_val_l], al
  3480 000014E1 2C80                    	sub	al, 80h
  3481 000014E3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3482 000014E7 66AB                    	stosw		; original sample (L)
  3483 000014E9 AC                      	lodsb
  3484 000014EA A2[C5260000]            	mov	[previous_val_r], al
  3485 000014EF 2C80                    	sub	al, 80h
  3486 000014F1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3487 000014F5 66AB                    	stosw		; original sample (R)
  3488                                  
  3489                                  	;xor	eax, eax
  3490 000014F7 66B88080                	mov	ax, 8080h
  3491 000014FB 49                      	dec	ecx
  3492 000014FC 7403                    	jz	short lff16s_2
  3493                                  		; convert 8 bit sample to 16 bit sample
  3494 000014FE 668B06                  	mov	ax, [esi]
  3495                                  lff16s_2:
  3496                                  	;mov	[next_val_l], al
  3497                                  	;mov	[next_val_r], ah
  3498 00001501 89C3                    	mov	ebx, eax
  3499 00001503 0205[C3260000]          	add	al, [previous_val_l]
  3500 00001509 D0D8                    	rcr	al, 1
  3501 0000150B 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  3502 0000150D 0205[C3260000]          	add	al, [previous_val_l]
  3503 00001513 D0D8                    	rcr	al, 1
  3504 00001515 2C80                    	sub	al, 80h
  3505 00001517 66C1E008                	shl	ax, 8
  3506 0000151B 66AB                    	stosw		; this is 1st interpolated sample (L)
  3507 0000151D 88F8                    	mov	al, bh	; [next_val_r]
  3508 0000151F 0205[C5260000]          	add	al, [previous_val_r]
  3509 00001525 D0D8                    	rcr	al, 1
  3510 00001527 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  3511 00001529 0205[C5260000]          	add	al, [previous_val_r]
  3512 0000152F D0D8                    	rcr	al, 1
  3513 00001531 2C80                    	sub	al, 80h
  3514 00001533 66C1E008                	shl	ax, 8
  3515 00001537 66AB                    	stosw		; this is 1st interpolated sample (R)
  3516 00001539 88D0                    	mov	al, dl
  3517 0000153B 00D8                    	add	al, bl	; [next_val_l]
  3518 0000153D D0D8                    	rcr	al, 1
  3519 0000153F 2C80                    	sub	al, 80h
  3520 00001541 66C1E008                	shl	ax, 8
  3521 00001545 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3522 00001547 88F0                    	mov	al, dh
  3523 00001549 00F8                    	add	al, bh	; [next_val_r]
  3524 0000154B D0D8                    	rcr	al, 1
  3525 0000154D 2C80                    	sub	al, 80h
  3526 0000154F 66C1E008                	shl	ax, 8
  3527 00001553 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3528                                  	
  3529                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3530 00001555 09C9                    	or	ecx, ecx
  3531 00001557 7582                    	jnz	short lff16s_1
  3532 00001559 E934FBFFFF              	jmp	lff16s_3
  3533                                  
  3534                                  load_16khz_mono_16_bit:
  3535                                  	; 15/11/2023
  3536                                  	; 13/11/2023
  3537 0000155E F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3538                                  					; last of the file?
  3539 00001565 7402                    	jz	short lff16m2_0		; no
  3540 00001567 F9                      	stc
  3541 00001568 C3                      	retn
  3542                                  
  3543                                  lff16m2_0:
  3544                                  	; 01/12/2024
  3545                                  	; edi = audio buffer address
  3546                                  	; 13/12/2024
  3547 00001569 893D[04320000]          	mov	[audio_buffer], edi
  3548 0000156F BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3549                                          ;mov	edx, [loadsize]
  3550                                  
  3551                                  	; esi = buffer address
  3552                                  	;; edx = buffer size
  3553                                  
  3554                                  	; load file into memory
  3555                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001574 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 0000157A 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 0000157C 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001582 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001587 CD40                <1>  int 40h
  3556 00001589 7255                    	jc	short lff16m2_7 ; error !
  3557                                  
  3558                                  	; 01/12/2024
  3559 0000158B A3[CC370000]            	mov	[count], eax
  3560                                  
  3561                                  	;mov	edi, audio_buffer
  3562                                  	; 29/05/2024
  3563                                  	;mov	edi, [audio_buffer]
  3564                                  	
  3565 00001590 D1E8                    	shr	eax, 1
  3566 00001592 7505                    	jnz	short lff16m2_8
  3567 00001594 E911FBFFFF              	jmp	lff16_eof
  3568                                  
  3569                                  lff16m2_8:
  3570 00001599 89C1                    	mov	ecx, eax  ; word count
  3571                                  lff16m2_1:
  3572 0000159B 66AD                    	lodsw
  3573 0000159D 66AB                    	stosw		; original sample (left channel)
  3574 0000159F 66AB                    	stosw		; original sample (right channel)
  3575 000015A1 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3576                                  	;mov	[previous_val], ax
  3577 000015A4 89C3                    	mov	ebx, eax
  3578 000015A6 31C0                    	xor	eax, eax
  3579 000015A8 49                      	dec	ecx
  3580 000015A9 7403                    	jz	short lff16m2_2
  3581 000015AB 668B06                  	mov	ax, [esi]
  3582                                  lff16m2_2:
  3583 000015AE 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3584 000015B1 89C5                    	mov	ebp, eax	; [next_val]
  3585                                  	;add	ax, [previous_val]
  3586 000015B3 6601D8                  	add	ax, bx
  3587 000015B6 66D1D8                  	rcr	ax, 1
  3588 000015B9 89C2                    	mov	edx, eax ; this is temporary interpolation value
  3589                                  	;add	ax, [previous_val]
  3590 000015BB 6601D8                  	add	ax, bx
  3591 000015BE 66D1D8                  	rcr	ax, 1
  3592 000015C1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3593 000015C4 66AB                    	stosw		; this is 1st interpolated sample (L)
  3594 000015C6 66AB                    	stosw		; this is 1st interpolated sample (R)
  3595 000015C8 89E8                    	mov	eax, ebp
  3596 000015CA 6601D0                  	add	ax, dx
  3597 000015CD 66D1D8                  	rcr	ax, 1
  3598 000015D0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3599 000015D3 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3600 000015D5 66AB                    	stosw		; this is 2nd interpolated sample (R)
  3601                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3602 000015D7 09C9                    	or	ecx, ecx
  3603 000015D9 75C0                    	jnz	short lff16m2_1
  3604 000015DB E9B2FAFFFF              	jmp	lff16m2_3
  3605                                  
  3606                                  lff16m2_7:
  3607                                  lff16s2_7:
  3608 000015E0 E9CEFAFFFF              	jmp	lff16m2_5  ; error
  3609                                  
  3610                                  load_16khz_stereo_16_bit:
  3611                                  	; 16/11/2023
  3612                                  	; 15/11/2023
  3613                                  	; 13/11/2023
  3614 000015E5 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3615                                  					; last of the file?
  3616 000015EC 7402                    	jz	short lff16s2_0		; no
  3617 000015EE F9                      	stc
  3618 000015EF C3                      	retn
  3619                                  
  3620                                  lff16s2_0:
  3621                                  	; 01/12/2024
  3622                                  	; edi = audio buffer address
  3623                                  	; 13/12/2024
  3624 000015F0 893D[04320000]          	mov	[audio_buffer], edi
  3625 000015F6 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3626                                          ;mov	edx, [loadsize]
  3627                                  
  3628                                  	; esi = buffer address
  3629                                  	;; edx = buffer size
  3630                                  
  3631                                  	; load file into memory
  3632                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000015FB 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001601 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001603 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001609 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 0000160E CD40                <1>  int 40h
  3633 00001610 72CE                    	jc	short lff16s2_7 ; error !
  3634                                  
  3635                                  	; 01/12/2024
  3636 00001612 A3[CC370000]            	mov	[count], eax
  3637                                  
  3638                                  	;mov	edi, audio_buffer
  3639                                  	; 29/05/2024
  3640                                  	;mov	edi, [audio_buffer]
  3641                                  	
  3642 00001617 C1E802                  	shr	eax, 2
  3643 0000161A 7505                    	jnz	short lff16s2_8
  3644 0000161C E989FAFFFF              	jmp	lff16_eof
  3645                                  
  3646                                  lff16s2_8:
  3647 00001621 89C1                    	mov	ecx, eax  ; dword count
  3648                                  lff16s2_1:
  3649 00001623 66AD                    	lodsw
  3650 00001625 66AB                    	stosw		; original sample (L)
  3651 00001627 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3652 0000162A 66A3[C3260000]          	mov	[previous_val_l], ax
  3653 00001630 66AD                    	lodsw
  3654 00001632 66AB                    	stosw		; original sample (R)
  3655 00001634 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3656 00001637 66A3[C5260000]          	mov	[previous_val_r], ax
  3657 0000163D 31D2                    	xor	edx, edx
  3658 0000163F 31C0                    	xor	eax, eax
  3659                                  	; 16/11/2023
  3660 00001641 49                      	dec	ecx
  3661 00001642 7407                    	jz	short lff16s2_2
  3662 00001644 668B06                  	mov	ax, [esi]
  3663 00001647 668B5602                	mov	dx, [esi+2]
  3664                                  lff16s2_2:
  3665 0000164B 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3666                                  	;mov	[next_val_l], ax
  3667 0000164E 89C5                    	mov	ebp, eax
  3668 00001650 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  3669 00001653 668915[C9260000]        	mov	[next_val_r], dx
  3670 0000165A 660305[C3260000]        	add	ax, [previous_val_l]
  3671 00001661 66D1D8                  	rcr	ax, 1
  3672 00001664 89C2                    	mov	edx, eax ; this is temporary interpolation value (L)
  3673 00001666 660305[C3260000]        	add	ax, [previous_val_l]
  3674 0000166D 66D1D8                  	rcr	ax, 1
  3675 00001670 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  3676 00001673 66AB                    	stosw		; this is 1st interpolated sample (L)
  3677 00001675 66A1[C9260000]          	mov	ax, [next_val_r]
  3678 0000167B 660305[C5260000]        	add	ax, [previous_val_r]
  3679 00001682 66D1D8                  	rcr	ax, 1
  3680 00001685 89C3                    	mov	ebx, eax ; this is temporary interpolation value (R)
  3681 00001687 660305[C5260000]        	add	ax, [previous_val_r]
  3682 0000168E 66D1D8                  	rcr	ax, 1
  3683 00001691 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3684 00001694 66AB                    	stosw		; this is 1st interpolated sample (R)
  3685                                  	;mov	ax, [next_val_l]
  3686 00001696 89E8                    	mov	eax, ebp
  3687 00001698 6601D0                  	add	ax, dx
  3688 0000169B 66D1D8                  	rcr	ax, 1
  3689 0000169E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3690 000016A1 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3691 000016A3 66A1[C9260000]          	mov	ax, [next_val_r]
  3692 000016A9 6601D8                  	add	ax, bx
  3693 000016AC 66D1D8                  	rcr	ax, 1
  3694 000016AF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3695 000016B2 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3696                                  	
  3697                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3698 000016B4 09C9                    	or	ecx, ecx
  3699 000016B6 0F8567FFFFFF            	jnz	lff16s2_1
  3700 000016BC E9D1F9FFFF              	jmp	lff16s2_3
  3701                                  
  3702                                  ; .....................
  3703                                  
  3704                                  load_24khz_mono_8_bit:
  3705                                  	; 15/11/2023
  3706 000016C1 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3707                                  					; last of the file?
  3708 000016C8 7402                    	jz	short lff24m_0		; no
  3709 000016CA F9                      	stc
  3710 000016CB C3                      	retn
  3711                                  
  3712                                  lff24m_0:
  3713                                  	; 01/12/2024
  3714                                  	; edi = audio buffer address
  3715                                  	; 13/12/2024
  3716 000016CC 893D[04320000]          	mov	[audio_buffer], edi
  3717 000016D2 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3718                                          ;mov	edx, [loadsize]
  3719                                  
  3720                                  	; esi = buffer address
  3721                                  	;; edx = buffer size
  3722                                  
  3723                                  	; load file into memory
  3724                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000016D7 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000016DD 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000016DF 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000016E5 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000016EA CD40                <1>  int 40h
  3725 000016EC 723B                    	jc	short lff24m_7 ; error !
  3726                                  
  3727                                  	; 01/12/2024
  3728 000016EE A3[CC370000]            	mov	[count], eax
  3729                                  
  3730                                  	;mov	edi, audio_buffer
  3731                                  	; 29/05/2024
  3732                                  	;mov	edi, [audio_buffer]
  3733                                  	
  3734 000016F3 21C0                    	and	eax, eax
  3735 000016F5 7505                    	jnz	short lff24m_8
  3736 000016F7 E9AEF9FFFF              	jmp	lff24_eof
  3737                                  
  3738                                  lff24m_8:
  3739 000016FC 89C1                    	mov	ecx, eax	; byte count
  3740                                  lff24m_1:
  3741 000016FE AC                      	lodsb
  3742                                  	;mov	[previous_val], al
  3743 000016FF 88C3                    	mov	bl, al
  3744 00001701 2C80                    	sub	al, 80h
  3745 00001703 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3746 00001707 66AB                    	stosw		; original sample (left channel)
  3747 00001709 66AB                    	stosw		; original sample (right channel)
  3748                                  	;xor	eax, eax
  3749 0000170B B080                    	mov	al, 80h
  3750 0000170D 49                      	dec	ecx
  3751 0000170E 7402                    	jz	short lff24m_2
  3752 00001710 8A06                    	mov	al, [esi]
  3753                                  lff24m_2:
  3754                                  	;;mov	[next_val], al
  3755                                  	;mov	bh, al
  3756                                  	;add	al, [previous_val]
  3757 00001712 00D8                    	add	al, bl
  3758 00001714 D0D8                    	rcr	al, 1
  3759 00001716 2C80                    	sub	al, 80h
  3760 00001718 66C1E008                	shl	ax, 8
  3761 0000171C 66AB                    	stosw		; this is interpolated sample (L)
  3762 0000171E 66AB                    	stosw		; this is interpolated sample (R)
  3763                                  	
  3764                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3765 00001720 09C9                    	or	ecx, ecx
  3766 00001722 75DA                    	jnz	short lff24m_1
  3767 00001724 E969F9FFFF              	jmp	lff24_3
  3768                                  
  3769                                  lff24m_7:
  3770                                  lff24s_7:
  3771 00001729 E985F9FFFF              	jmp	lff24_5  ; error
  3772                                  
  3773                                  load_24khz_stereo_8_bit:
  3774                                  	; 15/11/2023
  3775 0000172E F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3776                                  					; last of the file?
  3777 00001735 7402                    	jz	short lff24s_0		; no
  3778 00001737 F9                      	stc
  3779 00001738 C3                      	retn
  3780                                  
  3781                                  lff24s_0:
  3782                                  	; 01/12/2024
  3783                                  	; edi = audio buffer address
  3784                                  	; 13/12/2024
  3785 00001739 893D[04320000]          	mov	[audio_buffer], edi
  3786 0000173F BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3787                                          ;mov	edx, [loadsize]
  3788                                  
  3789                                  	; esi = buffer address
  3790                                  	;; edx = buffer size
  3791                                  
  3792                                  	; load file into memory
  3793                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001744 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 0000174A 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 0000174C 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001752 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001757 CD40                <1>  int 40h
  3794 00001759 72CE                    	jc	short lff24s_7 ; error !
  3795                                  
  3796                                  	; 01/12/2024
  3797 0000175B A3[CC370000]            	mov	[count], eax
  3798                                  
  3799                                  	;mov	edi, audio_buffer
  3800                                  	; 29/05/2024
  3801                                  	;mov	edi, [audio_buffer]
  3802                                  	
  3803 00001760 D1E8                    	shr	eax, 1
  3804 00001762 7505                    	jnz	short lff24s_8
  3805 00001764 E941F9FFFF              	jmp	lff24_eof
  3806                                  
  3807                                  lff24s_8:
  3808 00001769 89C1                    	mov	ecx, eax  ; word count
  3809                                  lff24s_1:
  3810 0000176B AC                      	lodsb
  3811 0000176C A2[C3260000]            	mov	[previous_val_l], al
  3812 00001771 2C80                    	sub	al, 80h
  3813 00001773 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3814 00001777 66AB                    	stosw		; original sample (L)
  3815 00001779 AC                      	lodsb
  3816 0000177A A2[C5260000]            	mov	[previous_val_r], al
  3817 0000177F 2C80                    	sub	al, 80h
  3818 00001781 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3819 00001785 66AB                    	stosw		; original sample (R)
  3820                                  
  3821                                  	;xor	eax, eax
  3822 00001787 66B88080                	mov	ax, 8080h
  3823 0000178B 49                      	dec	ecx
  3824 0000178C 7403                    	jz	short lff24s_2
  3825                                  		; convert 8 bit sample to 16 bit sample
  3826 0000178E 668B06                  	mov	ax, [esi]
  3827                                  lff24s_2:
  3828                                  	;;mov	[next_val_l], al
  3829                                  	;;mov	[next_val_r], ah
  3830                                  	;mov	bx, ax
  3831 00001791 88E7                    	mov	bh, ah
  3832 00001793 0205[C3260000]          	add	al, [previous_val_l]
  3833 00001799 D0D8                    	rcr	al, 1
  3834                                  	;mov	dl, al
  3835 0000179B 2C80                    	sub	al, 80h
  3836 0000179D 66C1E008                	shl	ax, 8
  3837 000017A1 66AB                    	stosw		; this is interpolated sample (L)
  3838 000017A3 88F8                    	mov	al, bh	; [next_val_r]
  3839 000017A5 0205[C5260000]          	add	al, [previous_val_r]
  3840 000017AB D0D8                    	rcr	al, 1
  3841                                  	;mov	dh, al
  3842 000017AD 2C80                    	sub	al, 80h
  3843 000017AF 66C1E008                	shl	ax, 8
  3844 000017B3 66AB                    	stosw		; this is interpolated sample (R)
  3845                                  		
  3846                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3847 000017B5 09C9                    	or	ecx, ecx
  3848 000017B7 75B2                    	jnz	short lff24s_1
  3849 000017B9 E9D4F8FFFF              	jmp	lff24_3
  3850                                  
  3851                                  load_24khz_mono_16_bit:
  3852                                  	; 15/11/2023
  3853 000017BE F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3854                                  					; last of the file?
  3855 000017C5 7402                    	jz	short lff24m2_0		; no
  3856 000017C7 F9                      	stc
  3857 000017C8 C3                      	retn
  3858                                  
  3859                                  lff24m2_0:
  3860                                  	; 01/12/2024
  3861                                  	; edi = audio buffer address
  3862                                  	; 13/12/2024
  3863 000017C9 893D[04320000]          	mov	[audio_buffer], edi
  3864 000017CF BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3865                                          ;mov	edx, [loadsize]
  3866                                  
  3867                                  	; esi = buffer address
  3868                                  	;; edx = buffer size
  3869                                  
  3870                                  	; load file into memory
  3871                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000017D4 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000017DA 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000017DC 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000017E2 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000017E7 CD40                <1>  int 40h
  3872 000017E9 7237                    	jc	short lff24m2_7 ; error !
  3873                                  
  3874                                  	; 01/12/2024
  3875 000017EB A3[CC370000]            	mov	[count], eax
  3876                                  
  3877                                  	;mov	edi, audio_buffer
  3878                                  	; 29/05/2024
  3879                                  	;mov	edi, [audio_buffer]
  3880                                  	
  3881 000017F0 D1E8                    	shr	eax, 1
  3882 000017F2 7505                    	jnz	short lff24m2_8
  3883 000017F4 E9B1F8FFFF              	jmp	lff24_eof
  3884                                  
  3885                                  lff24m2_8:
  3886 000017F9 89C1                    	mov	ecx, eax  ; word count
  3887                                  lff24m2_1:
  3888 000017FB 66AD                    	lodsw
  3889 000017FD 66AB                    	stosw		; original sample (left channel)
  3890 000017FF 66AB                    	stosw		; original sample (right channel)
  3891 00001801 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3892                                  	;mov	[previous_val], ax
  3893                                  	;mov	ebx, eax
  3894                                  	;xor	eax, eax
  3895 00001804 31DB                    	xor	ebx, ebx
  3896 00001806 49                      	dec	ecx
  3897 00001807 7403                    	jz	short lff24m2_2
  3898                                  	;mov	ax, [esi]
  3899 00001809 668B1E                  	mov	bx, [esi]
  3900                                  lff24m2_2:
  3901                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  3902                                  	;mov	ebp, eax	; [next_val]
  3903                                  	;add	ax, [previous_val]
  3904                                  	; ax = [previous_val]
  3905                                  	; bx = [next_val]
  3906 0000180C 6601D8                  	add	ax, bx
  3907 0000180F 66D1D8                  	rcr	ax, 1
  3908 00001812 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3909 00001815 66AB                    	stosw		; this is interpolated sample (L)
  3910 00001817 66AB                    	stosw		; this is interpolated sample (R)
  3911                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3912 00001819 09C9                    	or	ecx, ecx
  3913 0000181B 75DE                    	jnz	short lff24m2_1
  3914 0000181D E970F8FFFF              	jmp	lff24_3
  3915                                  
  3916                                  lff24m2_7:
  3917                                  lff24s2_7:
  3918 00001822 E98CF8FFFF              	jmp	lff24_5  ; error
  3919                                  
  3920                                  load_24khz_stereo_16_bit:
  3921                                  	; 16/11/2023
  3922                                  	; 15/11/2023
  3923 00001827 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3924                                  					; last of the file?
  3925 0000182E 7402                    	jz	short lff24s2_0		; no
  3926 00001830 F9                      	stc
  3927 00001831 C3                      	retn
  3928                                  
  3929                                  lff24s2_0:
  3930                                  	; 01/12/2024
  3931                                  	; edi = audio buffer address
  3932                                  	; 13/12/2024
  3933 00001832 893D[04320000]          	mov	[audio_buffer], edi
  3934 00001838 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3935                                          ;mov	edx, [loadsize]
  3936                                  
  3937                                  	; esi = buffer address
  3938                                  	;; edx = buffer size
  3939                                  
  3940                                  	; load file into memory
  3941                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 0000183D 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001843 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001845 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 0000184B B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001850 CD40                <1>  int 40h
  3942 00001852 72CE                    	jc	short lff24s2_7 ; error !
  3943                                  
  3944                                  	; 01/12/2024
  3945 00001854 A3[CC370000]            	mov	[count], eax
  3946                                  
  3947                                  	;mov	edi, audio_buffer
  3948                                  	; 29/05/2024
  3949                                  	;mov	edi, [audio_buffer]
  3950                                  	
  3951 00001859 C1E802                  	shr	eax, 2
  3952 0000185C 7505                    	jnz	short lff24s2_8
  3953 0000185E E947F8FFFF              	jmp	lff24_eof
  3954                                  
  3955                                  lff24s2_8:
  3956 00001863 89C1                    	mov	ecx, eax  ; dword count
  3957                                  lff24s2_1:
  3958 00001865 66AD                    	lodsw
  3959 00001867 66AB                    	stosw		; original sample (L)
  3960 00001869 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3961 0000186C 66A3[C3260000]          	mov	[previous_val_l], ax
  3962 00001872 66AD                    	lodsw
  3963 00001874 66AB                    	stosw		; original sample (R)
  3964 00001876 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3965                                  	;mov	[previous_val_r], ax
  3966 00001879 89C3                    	mov	ebx, eax
  3967 0000187B 31D2                    	xor	edx, edx
  3968 0000187D 31C0                    	xor	eax, eax
  3969                                  	; 16/11/2023
  3970 0000187F 49                      	dec	ecx
  3971 00001880 7407                    	jz	short lff24s2_2
  3972 00001882 668B06                  	mov	ax, [esi]
  3973 00001885 668B5602                	mov	dx, [esi+2]
  3974                                  lff24s2_2:
  3975 00001889 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3976                                  	;;mov	[next_val_l], ax
  3977                                  	;mov	ebp, eax
  3978 0000188C 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  3979                                  	;mov	[next_val_r], dx
  3980 0000188F 660305[C3260000]        	add	ax, [previous_val_l]
  3981 00001896 66D1D8                  	rcr	ax, 1
  3982 00001899 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  3983 0000189C 66AB                    	stosw		; this is interpolated sample (L)
  3984                                  	;mov	ax, [next_val_r]
  3985 0000189E 89D0                    	mov	eax, edx
  3986                                  	;add	ax, [previous_val_r]
  3987 000018A0 6601D8                  	add	ax, bx
  3988 000018A3 66D1D8                  	rcr	ax, 1
  3989 000018A6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3990 000018A9 66AB                    	stosw		; this is interpolated sample (R)
  3991                                  	
  3992                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3993 000018AB 09C9                    	or	ecx, ecx
  3994 000018AD 75B6                    	jnz	short lff24s2_1
  3995 000018AF E9DEF7FFFF              	jmp	lff24_3
  3996                                  
  3997                                  ; .....................
  3998                                  
  3999                                  load_32khz_mono_8_bit:
  4000                                  	; 15/11/2023
  4001 000018B4 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4002                                  					; last of the file?
  4003 000018BB 7402                    	jz	short lff32m_0		; no
  4004 000018BD F9                      	stc
  4005 000018BE C3                      	retn
  4006                                  
  4007                                  lff32m_0:
  4008                                  	; 01/12/2024
  4009                                  	; edi = audio buffer address
  4010                                  	; 13/12/2024
  4011 000018BF 893D[04320000]          	mov	[audio_buffer], edi
  4012 000018C5 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4013                                          ;mov	edx, [loadsize]
  4014                                  
  4015                                  	; esi = buffer address
  4016                                  	;; edx = buffer size
  4017                                  
  4018                                  	; load file into memory
  4019                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000018CA 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000018D0 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000018D2 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000018D8 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000018DD CD40                <1>  int 40h
  4020 000018DF 7247                    	jc	short lff32m_7 ; error !
  4021                                  
  4022                                  	; 01/12/2024
  4023 000018E1 A3[CC370000]            	mov	[count], eax
  4024                                  
  4025                                  	;mov	edi, audio_buffer
  4026                                  	; 29/05/2024
  4027                                  	;mov	edi, [audio_buffer]
  4028                                  	
  4029 000018E6 21C0                    	and	eax, eax
  4030 000018E8 7505                    	jnz	short lff32m_8
  4031 000018EA E9BBF7FFFF              	jmp	lff32_eof
  4032                                  
  4033                                  lff32m_8:
  4034 000018EF 89C1                    	mov	ecx, eax	; byte count
  4035                                  lff32m_1:
  4036 000018F1 AC                      	lodsb
  4037                                  	;mov	[previous_val], al
  4038 000018F2 88C3                    	mov	bl, al
  4039 000018F4 2C80                    	sub	al, 80h
  4040 000018F6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4041 000018FA 66AB                    	stosw		; original sample (left channel)
  4042 000018FC 66AB                    	stosw		; original sample (right channel)
  4043                                  	;xor	eax, eax
  4044 000018FE B080                    	mov	al, 80h
  4045 00001900 49                      	dec	ecx
  4046 00001901 7402                    	jz	short lff32m_2
  4047 00001903 8A06                    	mov	al, [esi]
  4048                                  lff32m_2:
  4049                                  	;;mov	[next_val], al
  4050                                  	;mov	bh, al
  4051                                  	;add	al, [previous_val]
  4052 00001905 00D8                    	add	al, bl
  4053 00001907 D0D8                    	rcr	al, 1
  4054 00001909 2C80                    	sub	al, 80h
  4055 0000190B 66C1E008                	shl	ax, 8
  4056 0000190F 66AB                    	stosw		; this is interpolated sample (L)
  4057 00001911 66AB                    	stosw		; this is interpolated sample (R)
  4058                                  	
  4059                                  	; different than 8-16-24 kHZ !
  4060                                  	; 'original-interpolated-original' trio samples
  4061 00001913 E30E                    	jecxz	lff32m_3
  4062                                  
  4063 00001915 AC                      	lodsb
  4064 00001916 2C80                    	sub	al, 80h
  4065 00001918 66C1E008                	shl	ax, 8
  4066 0000191C 66AB                    	stosw		; original sample (left channel)
  4067 0000191E 66AB                    	stosw		; original sample (right channel)
  4068                                  
  4069                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  4070 00001920 49                      	dec	ecx
  4071 00001921 75CE                    	jnz	short lff32m_1
  4072                                  lff32m_3:
  4073 00001923 E96AF7FFFF              	jmp	lff32_3
  4074                                  
  4075                                  lff32m_7:
  4076                                  lff32s_7:
  4077 00001928 E986F7FFFF              	jmp	lff32_5  ; error
  4078                                  
  4079                                  load_32khz_stereo_8_bit:
  4080                                  	; 15/11/2023
  4081 0000192D F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4082                                  					; last of the file?
  4083 00001934 7402                    	jz	short lff32s_0		; no
  4084 00001936 F9                      	stc
  4085 00001937 C3                      	retn
  4086                                  
  4087                                  lff32s_0:
  4088                                  	; 01/12/2024
  4089                                  	; edi = audio buffer address
  4090                                  	; 13/12/2024
  4091 00001938 893D[04320000]          	mov	[audio_buffer], edi
  4092 0000193E BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4093                                          ;mov	edx, [loadsize]
  4094                                  
  4095                                  	; esi = buffer address
  4096                                  	;; edx = buffer size
  4097                                  
  4098                                  	; load file into memory
  4099                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001943 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001949 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 0000194B 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001951 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001956 CD40                <1>  int 40h
  4100 00001958 72CE                    	jc	short lff32s_7 ; error !
  4101                                  
  4102                                  	; 01/12/2024
  4103 0000195A A3[CC370000]            	mov	[count], eax
  4104                                  
  4105                                  	;mov	edi, audio_buffer
  4106                                  	; 29/05/2024
  4107                                  	;mov	edi, [audio_buffer]
  4108                                  	
  4109 0000195F D1E8                    	shr	eax, 1
  4110 00001961 7505                    	jnz	short lff32s_8
  4111 00001963 E942F7FFFF              	jmp	lff32_eof
  4112                                  
  4113                                  lff32s_8:
  4114 00001968 89C1                    	mov	ecx, eax  ; word count
  4115                                  lff32s_1:
  4116 0000196A AC                      	lodsb
  4117 0000196B A2[C3260000]            	mov	[previous_val_l], al
  4118 00001970 2C80                    	sub	al, 80h
  4119 00001972 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4120 00001976 66AB                    	stosw		; original sample (L)
  4121 00001978 AC                      	lodsb
  4122 00001979 A2[C5260000]            	mov	[previous_val_r], al
  4123 0000197E 2C80                    	sub	al, 80h
  4124 00001980 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4125 00001984 66AB                    	stosw		; original sample (R)
  4126                                  
  4127                                  	;xor	eax, eax
  4128 00001986 66B88080                	mov	ax, 8080h
  4129 0000198A 49                      	dec	ecx
  4130 0000198B 7403                    	jz	short lff32s_2
  4131                                  		; convert 8 bit sample to 16 bit sample
  4132 0000198D 668B06                  	mov	ax, [esi]
  4133                                  lff32s_2:
  4134                                  	;;mov	[next_val_l], al
  4135                                  	;;mov	[next_val_r], ah
  4136                                  	;mov	bx, ax
  4137 00001990 88E7                    	mov	bh, ah
  4138 00001992 0205[C3260000]          	add	al, [previous_val_l]
  4139 00001998 D0D8                    	rcr	al, 1
  4140                                  	;mov	dl, al
  4141 0000199A 2C80                    	sub	al, 80h
  4142 0000199C 66C1E008                	shl	ax, 8
  4143 000019A0 66AB                    	stosw		; this is interpolated sample (L)
  4144 000019A2 88F8                    	mov	al, bh	; [next_val_r]
  4145 000019A4 0205[C5260000]          	add	al, [previous_val_r]
  4146 000019AA D0D8                    	rcr	al, 1
  4147                                  	;mov	dh, al
  4148 000019AC 2C80                    	sub	al, 80h
  4149 000019AE 66C1E008                	shl	ax, 8
  4150 000019B2 66AB                    	stosw		; this is interpolated sample (R)
  4151                                  
  4152                                  	; different than 8-16-24 kHZ !
  4153                                  	; 'original-interpolated-original' trio samples
  4154 000019B4 E315                    	jecxz	lff32s_3
  4155                                  
  4156 000019B6 AC                      	lodsb
  4157 000019B7 2C80                    	sub	al, 80h
  4158 000019B9 66C1E008                	shl	ax, 8
  4159 000019BD 66AB                    	stosw		; original sample (left channel)
  4160                                  
  4161 000019BF AC                      	lodsb
  4162 000019C0 2C80                    	sub	al, 80h
  4163 000019C2 66C1E008                	shl	ax, 8
  4164 000019C6 66AB                    	stosw		; original sample (right channel)
  4165                                  		
  4166                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  4167 000019C8 49                      	dec	ecx
  4168 000019C9 759F                    	jnz	short lff32s_1
  4169                                  lff32s_3:
  4170 000019CB E9C2F6FFFF              	jmp	lff32_3
  4171                                  
  4172                                  load_32khz_mono_16_bit:
  4173                                  	; 15/11/2023
  4174 000019D0 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4175                                  					; last of the file?
  4176 000019D7 7402                    	jz	short lff32m2_0		; no
  4177 000019D9 F9                      	stc
  4178 000019DA C3                      	retn
  4179                                  
  4180                                  lff32m2_0:
  4181                                  	; 01/12/2024
  4182                                  	; edi = audio buffer address
  4183                                  	; 13/12/2024
  4184 000019DB 893D[04320000]          	mov	[audio_buffer], edi
  4185 000019E1 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4186                                          ;mov	edx, [loadsize]
  4187                                  
  4188                                  	; esi = buffer address
  4189                                  	;; edx = buffer size
  4190                                  
  4191                                  	; load file into memory
  4192                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000019E6 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000019EC 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000019EE 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000019F4 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000019F9 CD40                <1>  int 40h
  4193 000019FB 723E                    	jc	short lff32m2_7 ; error !
  4194                                  
  4195                                  	; 01/12/2024
  4196 000019FD A3[CC370000]            	mov	[count], eax
  4197                                  
  4198                                  	;mov	edi, audio_buffer
  4199                                  	; 29/05/2024
  4200                                  	;mov	edi, [audio_buffer]
  4201                                  	
  4202 00001A02 D1E8                    	shr	eax, 1
  4203 00001A04 7505                    	jnz	short lff32m2_8
  4204 00001A06 E99FF6FFFF              	jmp	lff32_eof
  4205                                  
  4206                                  lff32m2_8:
  4207 00001A0B 89C1                    	mov	ecx, eax  ; word count
  4208                                  lff32m2_1:
  4209 00001A0D 66AD                    	lodsw
  4210 00001A0F 66AB                    	stosw		; original sample (left channel)
  4211 00001A11 66AB                    	stosw		; original sample (right channel)
  4212 00001A13 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4213                                  	;mov	[previous_val], ax
  4214                                  	;mov	ebx, eax
  4215                                  	;xor	eax, eax
  4216 00001A16 31DB                    	xor	ebx, ebx
  4217 00001A18 49                      	dec	ecx
  4218 00001A19 7403                    	jz	short lff32m2_2
  4219                                  	;mov	ax, [esi]
  4220 00001A1B 668B1E                  	mov	bx, [esi]
  4221                                  lff32m2_2:
  4222                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  4223                                  	;mov	ebp, eax	; [next_val]
  4224                                  	;add	ax, [previous_val]
  4225                                  	; ax = [previous_val]
  4226                                  	; bx = [next_val]
  4227 00001A1E 6601D8                  	add	ax, bx
  4228 00001A21 66D1D8                  	rcr	ax, 1
  4229 00001A24 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4230 00001A27 66AB                    	stosw		; this is interpolated sample (L)
  4231 00001A29 66AB                    	stosw		; this is interpolated sample (R)
  4232                                  
  4233                                  	; different than 8-16-24 kHZ !
  4234                                  	; 'original-interpolated-original' trio samples 
  4235 00001A2B E309                    	jecxz	lff32m2_3
  4236                                  
  4237 00001A2D 66AD                    	lodsw
  4238 00001A2F 66AB                    	stosw		; original sample (left channel)
  4239 00001A31 66AB                    	stosw		; original sample (right channel)
  4240                                  
  4241                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  4242 00001A33 49                      	dec	ecx
  4243 00001A34 75D7                    	jnz	short lff32m2_1
  4244                                  lff32m2_3:
  4245 00001A36 E957F6FFFF              	jmp	lff32_3
  4246                                  
  4247                                  lff32m2_7:
  4248                                  lff32s2_7:
  4249 00001A3B E973F6FFFF              	jmp	lff32_5  ; error
  4250                                  
  4251                                  load_32khz_stereo_16_bit:
  4252                                  	; 16/11/2023
  4253                                  	; 15/11/2023
  4254 00001A40 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4255                                  					; last of the file?
  4256 00001A47 7402                    	jz	short lff32s2_0		; no
  4257 00001A49 F9                      	stc
  4258 00001A4A C3                      	retn
  4259                                  
  4260                                  lff32s2_0:
  4261                                  	; 01/12/2024
  4262                                  	; edi = audio buffer address
  4263                                  	; 13/12/2024
  4264 00001A4B 893D[04320000]          	mov	[audio_buffer], edi
  4265 00001A51 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4266                                          ;mov	edx, [loadsize]
  4267                                  
  4268                                  	; esi = buffer address
  4269                                  	;; edx = buffer size
  4270                                  
  4271                                  	; load file into memory
  4272                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001A56 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001A5C 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001A5E 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001A64 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001A69 CD40                <1>  int 40h
  4273 00001A6B 72CE                    	jc	short lff32s2_7 ; error !
  4274                                  
  4275                                  	; 01/12/2024
  4276 00001A6D A3[CC370000]            	mov	[count], eax
  4277                                  
  4278                                  	;mov	edi, audio_buffer
  4279                                  	; 29/05/2024
  4280                                  	;mov	edi, [audio_buffer]
  4281                                  	
  4282 00001A72 C1E802                  	shr	eax, 2
  4283 00001A75 7505                    	jnz	short lff32s2_8
  4284 00001A77 E92EF6FFFF              	jmp	lff32_eof
  4285                                  
  4286                                  lff32s2_8:
  4287 00001A7C 89C1                    	mov	ecx, eax ; dword count
  4288                                  lff32s2_1:
  4289 00001A7E 66AD                    	lodsw
  4290 00001A80 66AB                    	stosw		; original sample (L)
  4291 00001A82 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  4292 00001A85 66A3[C3260000]          	mov	[previous_val_l], ax
  4293 00001A8B 66AD                    	lodsw
  4294 00001A8D 66AB                    	stosw		; original sample (R)
  4295 00001A8F 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  4296                                  	;mov	[previous_val_r], ax
  4297 00001A92 89C3                    	mov	ebx, eax
  4298 00001A94 31D2                    	xor	edx, edx
  4299 00001A96 31C0                    	xor	eax, eax
  4300                                  	; 16/11/2023
  4301 00001A98 49                      	dec	ecx
  4302 00001A99 7407                    	jz	short lff32s2_2
  4303 00001A9B 668B06                  	mov	ax, [esi]
  4304 00001A9E 668B5602                	mov	dx, [esi+2]
  4305                                  lff32s2_2:
  4306 00001AA2 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  4307                                  	;;mov	[next_val_l], ax
  4308                                  	;mov	ebp, eax
  4309 00001AA5 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  4310                                  	;mov	[next_val_r], dx
  4311 00001AA8 660305[C3260000]        	add	ax, [previous_val_l]
  4312 00001AAF 66D1D8                  	rcr	ax, 1
  4313 00001AB2 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  4314 00001AB5 66AB                    	stosw		; this is interpolated sample (L)
  4315                                  	;mov	ax, [next_val_r]
  4316 00001AB7 89D0                    	mov	eax, edx
  4317                                  	;add	ax, [previous_val_r]
  4318 00001AB9 6601D8                  	add	ax, bx
  4319 00001ABC 66D1D8                  	rcr	ax, 1
  4320 00001ABF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4321 00001AC2 66AB                    	stosw		; this is interpolated sample (R)
  4322                                  
  4323                                  	; different than 8-16-24 kHZ !
  4324                                  	; 'original-interpolated-original' trio samples
  4325 00001AC4 E30B                    	jecxz	lff32s2_3
  4326                                  
  4327 00001AC6 66AD                    	lodsw
  4328 00001AC8 66AB                    	stosw	; original sample (L)
  4329 00001ACA 66AD                    	lodsw
  4330 00001ACC 66AB                    	stosw	; original sample (R)
  4331                                  	
  4332                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  4333 00001ACE 49                      	dec	ecx
  4334 00001ACF 75AD                    	jnz	short lff32s2_1
  4335                                  lff32s2_3:
  4336 00001AD1 E9BCF5FFFF              	jmp	lff32_3
  4337                                  
  4338                                  ; .....................
  4339                                  
  4340                                  load_22khz_mono_8_bit:
  4341                                  	; 16/11/2023
  4342 00001AD6 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4343                                  					; last of the file?
  4344 00001ADD 7402                    	jz	short lff22m_0		; no
  4345 00001ADF F9                      	stc
  4346 00001AE0 C3                      	retn
  4347                                  
  4348                                  lff22m_0:
  4349                                  	; 01/12/2024
  4350                                  	; edi = audio buffer address
  4351                                  	; 13/12/2024
  4352 00001AE1 893D[04320000]          	mov	[audio_buffer], edi
  4353 00001AE7 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4354                                          ;mov	edx, [loadsize]
  4355                                  
  4356                                  	; esi = buffer address
  4357                                  	;; edx = buffer size
  4358                                  
  4359                                  	; load file into memory
  4360                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001AEC 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001AF2 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001AF4 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001AFA B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001AFF CD40                <1>  int 40h
  4361 00001B01 725D                    	jc	short lff22m_7 ; error !
  4362                                  
  4363                                  	; 01/12/2024
  4364 00001B03 A3[CC370000]            	mov	[count], eax
  4365                                  
  4366                                  	;mov	edi, audio_buffer
  4367                                  	; 29/05/2024
  4368                                  	;mov	edi, [audio_buffer]
  4369                                  	
  4370 00001B08 21C0                    	and	eax, eax
  4371 00001B0A 7505                    	jnz	short lff22m_8
  4372 00001B0C E999F5FFFF              	jmp	lff22_eof
  4373                                  
  4374                                  lff22m_8:
  4375 00001B11 89C1                    	mov	ecx, eax	; byte count
  4376                                  lff22m_9:
  4377 00001B13 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4378 00001B18 C605[CB260000]03        	mov	byte [faz], 3  ; 3 steps/phases
  4379                                  lff22m_1:
  4380                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4381 00001B1F AC                      	lodsb
  4382 00001B20 B280                    	mov	dl, 80h
  4383 00001B22 49                      	dec	ecx
  4384 00001B23 7402                    	jz	short lff22m_2_1
  4385 00001B25 8A16                    	mov	dl, [esi]
  4386                                  lff22m_2_1:	
  4387                                  	; al = [previous_val]
  4388                                  	; dl = [next_val]
  4389 00001B27 E851060000              	call	interpolating_3_8bit_mono ; 1 of 17
  4390 00001B2C E32D                    	jecxz	lff22m_3
  4391                                  lff22m_2_2:
  4392 00001B2E AC                      	lodsb
  4393 00001B2F B280                    	mov	dl, 80h
  4394 00001B31 49                      	dec	ecx
  4395 00001B32 7402                    	jz	short lff22m_2_3
  4396 00001B34 8A16                    	mov	dl, [esi]
  4397                                  lff22m_2_3:
  4398 00001B36 E8C6060000               	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  4399 00001B3B E31E                    	jecxz	lff22m_3
  4400 00001B3D 4D                      	dec	ebp
  4401 00001B3E 75EE                    	jnz	short lff22m_2_2
  4402                                  
  4403 00001B40 A0[CB260000]            	mov	al, [faz]
  4404 00001B45 FEC8                    	dec	al
  4405 00001B47 74CA                    	jz	short lff22m_9
  4406 00001B49 FE0D[CB260000]          	dec	byte [faz]
  4407 00001B4F BD04000000              	mov	ebp, 4
  4408 00001B54 FEC8                    	dec	al
  4409 00001B56 75C7                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  4410 00001B58 45                      	inc	ebp ; 5
  4411 00001B59 EBC4                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4412                                  
  4413                                  lff22m_3:
  4414                                  lff22s_3:
  4415 00001B5B E932F5FFFF              	jmp	lff22_3	; padfill
  4416                                  		; (put zeros in the remain words of the buffer)
  4417                                  lff22m_7:
  4418                                  lff22s_7:
  4419 00001B60 E94EF5FFFF              	jmp	lff22_5  ; error
  4420                                  
  4421                                  load_22khz_stereo_8_bit:
  4422                                  	; 16/11/2023
  4423 00001B65 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4424                                  					; last of the file?
  4425 00001B6C 7402                    	jz	short lff22s_0		; no
  4426 00001B6E F9                      	stc
  4427 00001B6F C3                      	retn
  4428                                  
  4429                                  lff22s_0:
  4430                                  	; 01/12/2024
  4431                                  	; edi = audio buffer address
  4432                                  	; 13/12/2024
  4433 00001B70 893D[04320000]          	mov	[audio_buffer], edi
  4434 00001B76 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4435                                          ;mov	edx, [loadsize]
  4436                                  
  4437                                  	; esi = buffer address
  4438                                  	;; edx = buffer size
  4439                                  
  4440                                  	; load file into memory
  4441                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001B7B 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001B81 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001B83 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001B89 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001B8E CD40                <1>  int 40h
  4442 00001B90 72CE                    	jc	short lff22s_7 ; error !
  4443                                  
  4444                                  	; 01/12/2024
  4445 00001B92 A3[CC370000]            	mov	[count], eax
  4446                                  
  4447                                  	;mov	edi, audio_buffer
  4448                                  	; 29/05/2024
  4449                                  	;mov	edi, [audio_buffer]
  4450                                  	
  4451 00001B97 D1E8                    	shr	eax, 1
  4452 00001B99 7505                    	jnz	short lff22s_8
  4453 00001B9B E90AF5FFFF              	jmp	lff22_eof
  4454                                  
  4455                                  lff22s_8:
  4456 00001BA0 89C1                    	mov	ecx, eax	; word count
  4457                                  lff22s_9:
  4458 00001BA2 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4459 00001BA7 C605[CB260000]03        	mov	byte [faz], 3  ; 3 steps/phase
  4460                                  lff22s_1:
  4461                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4462 00001BAE 66AD                    	lodsw
  4463 00001BB0 66BA8080                	mov	dx, 8080h
  4464 00001BB4 49                      	dec	ecx
  4465 00001BB5 7403                    	jz	short lff22s_2_1
  4466 00001BB7 668B16                  	mov	dx, [esi]
  4467                                  lff22s_2_1:	
  4468                                  	; al = [previous_val_l]
  4469                                  	; ah = [previous_val_r]
  4470                                  	; dl = [next_val_l]
  4471                                  	; dh = [next_val_r]
  4472 00001BBA E8EF050000              	call	interpolating_3_8bit_stereo ; 1 of 17
  4473 00001BBF E39A                    	jecxz	lff22s_3
  4474                                  lff22s_2_2:
  4475 00001BC1 66AD                    	lodsw
  4476 00001BC3 66BA8080                	mov	dx, 8080h
  4477 00001BC7 49                      	dec	ecx
  4478 00001BC8 7403                    	jz	short lff22s_2_3
  4479 00001BCA 668B16                  	mov	dx, [esi]
  4480                                  lff22s_2_3:
  4481 00001BCD E84C060000               	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  4482 00001BD2 E387                    	jecxz	lff22s_3
  4483 00001BD4 4D                      	dec	ebp
  4484 00001BD5 75EA                    	jnz	short lff22s_2_2
  4485                                  
  4486 00001BD7 A0[CB260000]            	mov	al, [faz]
  4487 00001BDC FEC8                    	dec	al
  4488 00001BDE 74C2                    	jz	short lff22s_9
  4489 00001BE0 FE0D[CB260000]          	dec	byte [faz]
  4490 00001BE6 BD04000000              	mov	ebp, 4
  4491 00001BEB FEC8                    	dec	al
  4492 00001BED 75BF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  4493 00001BEF 45                      	inc	ebp ; 5
  4494 00001BF0 EBBC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4495                                  
  4496                                  load_22khz_mono_16_bit:
  4497                                  	; 16/11/2023
  4498 00001BF2 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4499                                  					; last of the file?
  4500 00001BF9 7402                    	jz	short lff22m2_0		; no
  4501 00001BFB F9                      	stc
  4502 00001BFC C3                      	retn
  4503                                  
  4504                                  lff22m2_0:
  4505                                  	; 01/12/2024
  4506                                  	; edi = audio buffer address
  4507                                  	; 13/12/2024
  4508 00001BFD 893D[04320000]          	mov	[audio_buffer], edi
  4509 00001C03 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4510                                          ;mov	edx, [loadsize]
  4511                                  
  4512                                  	; esi = buffer address
  4513                                  	;; edx = buffer size
  4514                                  
  4515                                  	; load file into memory
  4516                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001C08 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001C0E 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001C10 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001C16 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001C1B CD40                <1>  int 40h
  4517 00001C1D 7261                    	jc	short lff22m2_7 ; error !
  4518                                  
  4519                                  	; 01/12/2024
  4520 00001C1F A3[CC370000]            	mov	[count], eax
  4521                                  
  4522                                  	;mov	edi, audio_buffer
  4523                                  	; 29/05/2024
  4524                                  	;mov	edi, [audio_buffer]
  4525                                  	
  4526 00001C24 D1E8                    	shr	eax, 1
  4527 00001C26 7505                    	jnz	short lff22m2_8
  4528 00001C28 E97DF4FFFF              	jmp	lff22_eof
  4529                                  
  4530                                  lff22m2_8:
  4531 00001C2D 89C1                    	mov	ecx, eax	; word count
  4532                                  lff22m2_9:
  4533 00001C2F BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4534 00001C34 C605[CB260000]03        	mov	byte [faz], 3  ; 3 steps/phases
  4535                                  lff22m2_1:
  4536                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4537 00001C3B 66AD                    	lodsw
  4538 00001C3D 31D2                    	xor	edx, edx
  4539 00001C3F 49                      	dec	ecx
  4540 00001C40 7403                    	jz	short lff22m2_2_1
  4541 00001C42 668B16                  	mov	dx, [esi]
  4542                                  lff22m2_2_1:	
  4543                                  	; ax = [previous_val]
  4544                                  	; dx = [next_val]
  4545 00001C45 E805060000              	call	interpolating_3_16bit_mono ; 1 of 17
  4546 00001C4A E32F                    	jecxz	lff22m2_3
  4547                                  lff22m2_2_2:
  4548 00001C4C 66AD                    	lodsw
  4549 00001C4E 31D2                    	xor	edx, edx
  4550 00001C50 49                      	dec	ecx
  4551 00001C51 7403                    	jz	short lff22m2_2_3
  4552 00001C53 668B16                  	mov	dx, [esi]
  4553                                  lff22m2_2_3:
  4554 00001C56 E887060000               	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  4555 00001C5B E31E                    	jecxz	lff22m2_3
  4556 00001C5D 4D                      	dec	ebp
  4557 00001C5E 75EC                    	jnz	short lff22m2_2_2
  4558                                  
  4559 00001C60 A0[CB260000]            	mov	al, [faz]
  4560 00001C65 FEC8                    	dec	al
  4561 00001C67 74C6                    	jz	short lff22m2_9
  4562 00001C69 FE0D[CB260000]          	dec	byte [faz]
  4563 00001C6F BD04000000              	mov	ebp, 4
  4564 00001C74 FEC8                    	dec	al
  4565 00001C76 75C3                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  4566 00001C78 45                      	inc	ebp ; 5
  4567 00001C79 EBC0                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4568                                  
  4569                                  lff22m2_3:
  4570                                  lff22s2_3:
  4571 00001C7B E912F4FFFF              	jmp	lff22_3	; padfill
  4572                                  		; (put zeros in the remain words of the buffer)
  4573                                  lff22m2_7:
  4574                                  lff22s2_7:
  4575 00001C80 E92EF4FFFF              	jmp	lff22_5  ; error
  4576                                  
  4577                                  load_22khz_stereo_16_bit:
  4578                                  	; 16/11/2023
  4579 00001C85 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4580                                  					; last of the file?
  4581 00001C8C 7402                    	jz	short lff22s2_0		; no
  4582 00001C8E F9                      	stc
  4583 00001C8F C3                      	retn
  4584                                  
  4585                                  lff22s2_0:
  4586                                  	; 01/12/2024
  4587                                  	; edi = audio buffer address
  4588                                  	; 13/12/2024
  4589 00001C90 893D[04320000]          	mov	[audio_buffer], edi
  4590 00001C96 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4591                                          ;mov	edx, [loadsize]
  4592                                  
  4593                                  	; esi = buffer address
  4594                                  	;; edx = buffer size
  4595                                  
  4596                                  	; load file into memory
  4597                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001C9B 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001CA1 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001CA3 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001CA9 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001CAE CD40                <1>  int 40h
  4598 00001CB0 72CE                    	jc	short lff22s2_7 ; error !
  4599                                  
  4600                                  	; 01/12/2024
  4601 00001CB2 A3[CC370000]            	mov	[count], eax
  4602                                  
  4603                                  	;mov	edi, audio_buffer
  4604                                  	; 29/05/2024
  4605                                  	;mov	edi, [audio_buffer]
  4606                                  	
  4607 00001CB7 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  4608 00001CBA 7505                    	jnz	short lff22s2_8
  4609 00001CBC E9E9F3FFFF              	jmp	lff22_eof
  4610                                  
  4611                                  lff22s2_8:
  4612 00001CC1 89C1                    	mov	ecx, eax	; dword count
  4613                                  lff22s2_9:
  4614 00001CC3 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4615 00001CC8 C605[CB260000]03        	mov	byte [faz], 3  ; 3 steps/phase
  4616                                  lff22s2_1:
  4617                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4618 00001CCF 66AD                    	lodsw
  4619 00001CD1 89C3                    	mov	ebx, eax
  4620 00001CD3 66AD                    	lodsw
  4621 00001CD5 8B16                    	mov	edx, [esi]
  4622 00001CD7 668915[C7260000]        	mov	[next_val_l], dx
  4623                                  	; 26/11/2023
  4624 00001CDE C1EA10                  	shr	edx, 16
  4625 00001CE1 49                      	dec	ecx
  4626 00001CE2 7509                    	jnz	short lff22s2_2_1
  4627 00001CE4 31D2                    	xor	edx, edx ; 0
  4628 00001CE6 668915[C7260000]        	mov	[next_val_l], dx
  4629                                  lff22s2_2_1:
  4630                                  	; bx = [previous_val_l]
  4631                                  	; ax = [previous_val_r]
  4632                                  	; [next_val_l]
  4633                                  	; dx = [next_val_r]
  4634 00001CED E88D050000              	call	interpolating_3_16bit_stereo ; 1 of 17 
  4635 00001CF2 E387                    	jecxz	lff22s2_3
  4636                                  lff22s2_2_2:
  4637 00001CF4 66AD                    	lodsw
  4638 00001CF6 89C3                    	mov	ebx, eax
  4639 00001CF8 66AD                    	lodsw
  4640 00001CFA 8B16                    	mov	edx, [esi]
  4641 00001CFC 668915[C7260000]        	mov	[next_val_l], dx
  4642                                  	; 26/11/2023
  4643 00001D03 C1EA10                  	shr	edx, 16
  4644 00001D06 49                      	dec	ecx
  4645 00001D07 7509                    	jnz	short lff22s2_2_3
  4646 00001D09 31D2                    	xor	edx, edx ; 0
  4647 00001D0B 668915[C7260000]        	mov	[next_val_l], dx
  4648                                  lff22s2_2_3:
  4649 00001D12 E8E3050000               	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  4650 00001D17 E31E                    	jecxz	lff22s2_2_4
  4651                                  
  4652 00001D19 4D                      	dec	ebp
  4653 00001D1A 75D8                    	jnz	short lff22s2_2_2
  4654                                  
  4655 00001D1C A0[CB260000]            	mov	al, [faz]
  4656 00001D21 FEC8                    	dec	al
  4657 00001D23 749E                    	jz	short lff22s2_9
  4658 00001D25 FE0D[CB260000]          	dec	byte [faz]
  4659 00001D2B BD04000000              	mov	ebp, 4
  4660 00001D30 FEC8                    	dec	al
  4661 00001D32 759B                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  4662 00001D34 45                      	inc	ebp ; 5
  4663 00001D35 EB98                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4664                                  
  4665                                  lff22s2_2_4:
  4666                                  	; 26/11/2023
  4667 00001D37 E956F3FFFF              	jmp	lff22_3	; padfill
  4668                                  
  4669                                  ; .....................
  4670                                  
  4671                                  load_11khz_mono_8_bit:
  4672                                  	; 18/11/2023
  4673 00001D3C F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4674                                  					; last of the file?
  4675 00001D43 7402                    	jz	short lff11m_0		; no
  4676 00001D45 F9                      	stc
  4677 00001D46 C3                      	retn
  4678                                  
  4679                                  lff11m_0:
  4680                                  	; 01/12/2024
  4681                                  	; edi = audio buffer address
  4682                                  	; 13/12/2024
  4683 00001D47 893D[04320000]          	mov	[audio_buffer], edi
  4684 00001D4D BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4685                                          ;mov	edx, [loadsize]
  4686                                  
  4687                                  	; esi = buffer address
  4688                                  	;; edx = buffer size
  4689                                  
  4690                                  	; load file into memory
  4691                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001D52 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001D58 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001D5A 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001D60 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001D65 CD40                <1>  int 40h
  4692 00001D67 7247                    	jc	short lff11m_7 ; error !
  4693                                  
  4694                                  	; 01/12/2024
  4695 00001D69 A3[CC370000]            	mov	[count], eax
  4696                                  
  4697                                  	;mov	edi, audio_buffer
  4698                                  	; 29/05/2024
  4699                                  	;mov	edi, [audio_buffer]
  4700                                  	
  4701 00001D6E 21C0                    	and	eax, eax
  4702 00001D70 7505                    	jnz	short lff11m_8
  4703 00001D72 E933F3FFFF              	jmp	lff11_eof
  4704                                  
  4705                                  lff11m_8:
  4706 00001D77 89C1                    	mov	ecx, eax		; byte count
  4707                                  lff11m_9:
  4708 00001D79 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4709                                  lff11m_1:
  4710                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4711 00001D7E AC                      	lodsb
  4712 00001D7F B280                    	mov	dl, 80h
  4713 00001D81 49                      	dec	ecx
  4714 00001D82 7402                    	jz	short lff11m_2_1
  4715 00001D84 8A16                    	mov	dl, [esi]
  4716                                  lff11m_2_1:	
  4717                                  	; al = [previous_val]
  4718                                  	; dl = [next_val]
  4719 00001D86 E8A0050000              	call	interpolating_5_8bit_mono
  4720 00001D8B E333                    	jecxz	lff11m_3
  4721                                  lff11m_2_2:
  4722 00001D8D AC                      	lodsb
  4723 00001D8E B280                    	mov	dl, 80h
  4724 00001D90 49                      	dec	ecx
  4725 00001D91 7402                    	jz	short lff11m_2_3
  4726 00001D93 8A16                    	mov	dl, [esi]
  4727                                  lff11m_2_3:
  4728 00001D95 E89D060000               	call	interpolating_4_8bit_mono
  4729 00001D9A E324                    	jecxz	lff11m_3
  4730                                  
  4731 00001D9C 4D                      	dec	ebp
  4732 00001D9D 74DA                    	jz	short lff11m_9
  4733                                  
  4734 00001D9F AC                      	lodsb
  4735 00001DA0 B280                    	mov	dl, 80h
  4736 00001DA2 49                      	dec	ecx
  4737 00001DA3 7402                    	jz	short lff11m_2_4
  4738 00001DA5 8A16                    	mov	dl, [esi]
  4739                                  lff11m_2_4:
  4740 00001DA7 E88B060000              	call	interpolating_4_8bit_mono
  4741 00001DAC E312                    	jecxz	lff11m_3
  4742 00001DAE EBCE                    	jmp	short lff11m_1
  4743                                  
  4744                                  lff11m_7:
  4745                                  lff11s_7:
  4746 00001DB0 E9FEF2FFFF              	jmp	lff11_5  ; error
  4747                                  
  4748                                  load_11khz_stereo_8_bit:
  4749                                  	; 18/11/2023
  4750 00001DB5 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4751                                  					; last of the file?
  4752 00001DBC 7407                    	jz	short lff11s_0		; no
  4753 00001DBE F9                      	stc
  4754 00001DBF C3                      	retn
  4755                                  
  4756                                  lff11m_3:
  4757                                  lff11s_3:
  4758 00001DC0 E9CDF2FFFF              	jmp	lff11_3	; padfill
  4759                                  		; (put zeros in the remain words of the buffer)
  4760                                  
  4761                                  lff11s_0:
  4762                                  	; 01/12/2024
  4763                                  	; edi = audio buffer address
  4764                                  	; 13/12/2024
  4765 00001DC5 893D[04320000]          	mov	[audio_buffer], edi
  4766 00001DCB BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4767                                          ;mov	edx, [loadsize]
  4768                                  
  4769                                  	; esi = buffer address
  4770                                  	;; edx = buffer size
  4771                                  
  4772                                  	; load file into memory
  4773                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001DD0 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001DD6 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001DD8 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001DDE B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001DE3 CD40                <1>  int 40h
  4774 00001DE5 72C9                    	jc	short lff11s_7 ; error !
  4775                                  
  4776                                  	; 01/12/2024
  4777 00001DE7 A3[CC370000]            	mov	[count], eax
  4778                                  
  4779                                  	;mov	edi, audio_buffer
  4780                                  	; 29/05/2024
  4781                                  	;mov	edi, [audio_buffer]
  4782                                  	
  4783 00001DEC D1E8                    	shr	eax, 1
  4784 00001DEE 7505                    	jnz	short lff11s_8
  4785 00001DF0 E9B5F2FFFF              	jmp	lff11_eof
  4786                                  
  4787                                  lff11s_8:
  4788 00001DF5 89C1                    	mov	ecx, eax	; word count
  4789                                  lff11s_9:
  4790 00001DF7 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4791                                  lff11s_1:
  4792                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4793 00001DFC 66AD                    	lodsw
  4794 00001DFE 66BA8080                	mov	dx, 8080h
  4795 00001E02 49                      	dec	ecx
  4796 00001E03 7403                    	jz	short lff11s_2_1
  4797 00001E05 668B16                  	mov	dx, [esi]
  4798                                  lff11s_2_1:	
  4799                                  	; al = [previous_val_l]
  4800                                  	; ah = [previous_val_r]
  4801                                  	; dl = [next_val_l]
  4802                                  	; dh = [next_val_r]
  4803 00001E08 E87D050000              	call	interpolating_5_8bit_stereo
  4804 00001E0D E3B1                    	jecxz	lff11s_3
  4805                                  lff11s_2_2:
  4806 00001E0F 66AD                    	lodsw
  4807 00001E11 66BA8080                	mov	dx, 8080h
  4808 00001E15 49                      	dec	ecx
  4809 00001E16 7403                    	jz	short lff11s_2_3
  4810 00001E18 668B16                  	mov	dx, [esi]
  4811                                  lff11s_2_3:
  4812 00001E1B E856060000               	call	interpolating_4_8bit_stereo
  4813 00001E20 E39E                    	jecxz	lff11s_3
  4814                                  	
  4815 00001E22 4D                      	dec	ebp
  4816 00001E23 74D2                    	jz	short lff11s_9
  4817                                  
  4818 00001E25 66AD                    	lodsw
  4819 00001E27 66BA8080                	mov	dx, 8080h
  4820 00001E2B 49                      	dec	ecx
  4821 00001E2C 7403                    	jz	short lff11s_2_4
  4822 00001E2E 668B16                  	mov	dx, [esi]
  4823                                  lff11s_2_4:
  4824 00001E31 E840060000              	call	interpolating_4_8bit_stereo
  4825 00001E36 E388                    	jecxz	lff11s_3
  4826 00001E38 EBC2                    	jmp	short lff11s_1
  4827                                  
  4828                                  load_11khz_mono_16_bit:
  4829                                  	; 18/11/2023
  4830 00001E3A F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4831                                  					; last of the file?
  4832 00001E41 7402                    	jz	short lff11m2_0		; no
  4833 00001E43 F9                      	stc
  4834 00001E44 C3                      	retn
  4835                                  
  4836                                  lff11m2_0:
  4837                                  	; 01/12/2024
  4838                                  	; edi = audio buffer address
  4839                                  	; 13/12/2024
  4840 00001E45 893D[04320000]          	mov	[audio_buffer], edi
  4841 00001E4B BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4842                                          ;mov	edx, [loadsize]
  4843                                  
  4844                                  	; esi = buffer address
  4845                                  	;; edx = buffer size
  4846                                  
  4847                                  	; load file into memory
  4848                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001E50 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001E56 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001E58 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001E5E B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001E63 CD40                <1>  int 40h
  4849 00001E65 724D                    	jc	short lff11m2_7 ; error !
  4850                                  
  4851                                  	; 01/12/2024
  4852 00001E67 A3[CC370000]            	mov	[count], eax
  4853                                  
  4854                                  	;mov	edi, audio_buffer
  4855                                  	; 29/05/2024
  4856                                  	;mov	edi, [audio_buffer]
  4857                                  	
  4858 00001E6C D1E8                    	shr	eax, 1
  4859 00001E6E 7505                    	jnz	short lff11m2_8
  4860 00001E70 E935F2FFFF              	jmp	lff11_eof
  4861                                  
  4862                                  lff11m2_8:
  4863 00001E75 89C1                    	mov	ecx, eax	; word count
  4864                                  lff11m2_9:
  4865 00001E77 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4866                                  lff11m2_1:
  4867                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4868 00001E7C 66AD                    	lodsw
  4869 00001E7E 31D2                    	xor	edx, edx
  4870 00001E80 49                      	dec	ecx
  4871 00001E81 7403                    	jz	short lff11m2_2_1
  4872 00001E83 668B16                  	mov	dx, [esi]
  4873                                  lff11m2_2_1:	
  4874                                  	; ax = [previous_val]
  4875                                  	; dx = [next_val]
  4876 00001E86 E858060000              	call	interpolating_5_16bit_mono
  4877 00001E8B E368                    	jecxz	lff11m2_3
  4878                                  lff11m2_2_2:
  4879 00001E8D 66AD                    	lodsw
  4880 00001E8F 31D2                    	xor	edx, edx
  4881 00001E91 49                      	dec	ecx
  4882 00001E92 7403                    	jz	short lff11m2_2_3
  4883 00001E94 668B16                  	mov	dx, [esi]
  4884                                  lff11m2_2_3:
  4885 00001E97 E871070000               	call	interpolating_4_16bit_mono
  4886 00001E9C E357                    	jecxz	lff11m2_3
  4887                                  
  4888 00001E9E 4D                      	dec	ebp
  4889 00001E9F 74D6                    	jz	short lff11m2_9
  4890                                  
  4891 00001EA1 66AD                    	lodsw
  4892 00001EA3 31D2                    	xor	edx, edx
  4893 00001EA5 49                      	dec	ecx
  4894 00001EA6 7403                    	jz	short lff11m2_2_4
  4895 00001EA8 668B16                  	mov	dx, [esi]
  4896                                  lff11m2_2_4:
  4897 00001EAB E85D070000               	call	interpolating_4_16bit_mono
  4898 00001EB0 E343                    	jecxz	lff11m2_3
  4899 00001EB2 EBC8                    	jmp	short lff11m2_1
  4900                                  
  4901                                  lff11m2_7:
  4902                                  lff11s2_7:
  4903 00001EB4 E9FAF1FFFF              	jmp	lff11_5  ; error
  4904                                  
  4905                                  load_11khz_stereo_16_bit:
  4906                                  	; 18/11/2023
  4907 00001EB9 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4908                                  					; last of the file?
  4909 00001EC0 7402                    	jz	short lff11s2_0		; no
  4910 00001EC2 F9                      	stc
  4911 00001EC3 C3                      	retn
  4912                                  
  4913                                  lff11s2_0:
  4914                                  	; 01/12/2024
  4915                                  	; edi = audio buffer address
  4916                                  	; 13/12/2024
  4917 00001EC4 893D[04320000]          	mov	[audio_buffer], edi
  4918 00001ECA BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4919                                          ;mov	edx, [loadsize]
  4920                                  
  4921                                  	; esi = buffer address
  4922                                  	;; edx = buffer size
  4923                                  
  4924                                  	; load file into memory
  4925                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001ECF 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001ED5 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001ED7 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001EDD B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001EE2 CD40                <1>  int 40h
  4926 00001EE4 72CE                    	jc	short lff11s2_7 ; error !
  4927                                  
  4928                                  	; 01/12/2024
  4929 00001EE6 A3[CC370000]            	mov	[count], eax
  4930                                  
  4931                                  	;mov	edi, audio_buffer
  4932                                  	; 29/05/2024
  4933                                  	;mov	edi, [audio_buffer]
  4934                                  	
  4935 00001EEB C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  4936 00001EEE 750A                    	jnz	short lff11s2_8
  4937 00001EF0 E9B5F1FFFF              	jmp	lff11_eof
  4938                                  
  4939                                  lff11m2_3:
  4940                                  lff11s2_3:
  4941 00001EF5 E998F1FFFF              	jmp	lff11_3	; padfill
  4942                                  		; (put zeros in the remain words of the buffer)
  4943                                  
  4944                                  lff11s2_8:
  4945 00001EFA 89C1                    	mov	ecx, eax	; dword count
  4946                                  lff11s2_9:
  4947 00001EFC BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4948                                  lff11s2_1:
  4949                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4950 00001F01 66AD                    	lodsw
  4951 00001F03 89C3                    	mov	ebx, eax
  4952 00001F05 66AD                    	lodsw
  4953 00001F07 8B16                    	mov	edx, [esi]
  4954 00001F09 8915[C7260000]          	mov	[next_val_l], edx
  4955                                  	; 26/11/2023
  4956 00001F0F C1EA10                  	shr	edx, 16
  4957                                  	;mov	[next_val_r], dx
  4958 00001F12 49                      	dec	ecx
  4959 00001F13 7509                    	jnz	short lff11s2_2_1
  4960 00001F15 31D2                    	xor	edx, edx ; 0
  4961 00001F17 668915[C7260000]        	mov	[next_val_l], dx
  4962                                  	;mov	[next_val_r], dx
  4963                                  lff11s2_2_1:
  4964                                  	; bx = [previous_val_l]
  4965                                  	; ax = [previous_val_r]
  4966                                  	; [next_val_l]
  4967                                  	; dx = [next_val_r]
  4968 00001F1E E81B060000              	call	interpolating_5_16bit_stereo
  4969 00001F23 E3D0                    	jecxz	lff11s2_3
  4970                                  lff11s2_2_2:
  4971 00001F25 66AD                    	lodsw
  4972 00001F27 89C3                    	mov	ebx, eax
  4973 00001F29 66AD                    	lodsw
  4974 00001F2B 8B16                    	mov	edx, [esi]
  4975 00001F2D 668915[C7260000]        	mov	[next_val_l], dx
  4976                                  	; 26/11/2023
  4977 00001F34 C1EA10                  	shr	edx, 16
  4978                                  	;mov	[next_val_r], dx
  4979 00001F37 49                      	dec	ecx
  4980 00001F38 7509                    	jnz	short lff11s2_2_3
  4981 00001F3A 31D2                    	xor	edx, edx ; 0
  4982 00001F3C 668915[C7260000]        	mov	[next_val_l], dx
  4983                                  	;mov	[next_val_r], dx
  4984                                  lff11s2_2_3:
  4985 00001F43 E8FE060000               	call	interpolating_4_16bit_stereo
  4986 00001F48 E3AB                    	jecxz	lff11s2_3
  4987                                  	
  4988 00001F4A 4D                      	dec	ebp
  4989 00001F4B 74AF                    	jz	short lff11s2_9
  4990                                  
  4991 00001F4D 66AD                    	lodsw
  4992 00001F4F 89C3                    	mov	ebx, eax
  4993 00001F51 66AD                    	lodsw
  4994 00001F53 8B16                    	mov	edx, [esi]
  4995 00001F55 668915[C7260000]        	mov	[next_val_l], dx
  4996                                  	; 26/11/2023
  4997 00001F5C C1EA10                  	shr	edx, 16
  4998                                  	;mov	[next_val_r], dx
  4999 00001F5F 49                      	dec	ecx
  5000 00001F60 7509                    	jnz	short lff11s2_2_4
  5001 00001F62 31D2                    	xor	edx, edx ; 0
  5002 00001F64 668915[C7260000]        	mov	[next_val_l], dx
  5003                                  	;mov	[next_val_r], dx
  5004                                  lff11s2_2_4:
  5005 00001F6B E8D6060000               	call	interpolating_4_16bit_stereo
  5006 00001F70 E383                    	jecxz	lff11s2_3
  5007 00001F72 EB8D                    	jmp	short lff11s2_1
  5008                                  
  5009                                  ; .....................
  5010                                  
  5011                                  load_44khz_mono_8_bit:
  5012                                  	; 18/11/2023
  5013 00001F74 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  5014                                  					; last of the file?
  5015 00001F7B 7402                    	jz	short lff44m_0		; no
  5016 00001F7D F9                      	stc
  5017 00001F7E C3                      	retn
  5018                                  
  5019                                  lff44m_0:
  5020                                  	; 01/12/2024
  5021                                  	; edi = audio buffer address
  5022                                  	; 13/12/2024
  5023 00001F7F 893D[04320000]          	mov	[audio_buffer], edi
  5024 00001F85 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5025                                          ;mov	edx, [loadsize]
  5026                                  
  5027                                  	; esi = buffer address
  5028                                  	;; edx = buffer size
  5029                                  
  5030                                  	; load file into memory
  5031                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001F8A 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001F90 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001F92 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001F98 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001F9D CD40                <1>  int 40h
  5032 00001F9F 7250                    	jc	short lff44m_7 ; error !
  5033                                  
  5034                                  	; 01/12/2024
  5035 00001FA1 A3[CC370000]            	mov	[count], eax
  5036                                  
  5037                                  	;mov	edi, audio_buffer
  5038                                  	; 29/05/2024
  5039                                  	;mov	edi, [audio_buffer]
  5040                                  	
  5041 00001FA6 21C0                    	and	eax, eax
  5042 00001FA8 7505                    	jnz	short lff44m_8
  5043 00001FAA E9FBF0FFFF              	jmp	lff44_eof
  5044                                  
  5045                                  lff44m_8:
  5046 00001FAF 89C1                    	mov	ecx, eax	; byte count
  5047                                  lff44m_9:
  5048 00001FB1 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5049 00001FB6 C605[CB260000]02        	mov	byte [faz], 2  ; 2 steps/phases
  5050                                  lff44m_1:
  5051                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5052                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5053 00001FBD AC                      	lodsb
  5054 00001FBE B280                    	mov	dl, 80h
  5055 00001FC0 49                      	dec	ecx
  5056 00001FC1 7402                    	jz	short lff44m_2_1
  5057 00001FC3 8A16                    	mov	dl, [esi]
  5058                                  lff44m_2_1:	
  5059                                  	; al = [previous_val]
  5060                                  	; dl = [next_val]
  5061 00001FC5 E837020000              	call	interpolating_2_8bit_mono
  5062 00001FCA E320                    	jecxz	lff44m_3
  5063                                  lff44m_2_2:
  5064 00001FCC AC                      	lodsb
  5065 00001FCD 2C80                    	sub	al, 80h
  5066 00001FCF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5067 00001FD3 66AB                    	stosw		; (L)
  5068 00001FD5 66AB                    	stosw		; (R)
  5069                                  
  5070 00001FD7 49                      	dec	ecx
  5071 00001FD8 7412                    	jz	short lff44m_3
  5072 00001FDA 4D                      	dec	ebp
  5073 00001FDB 75EF                    	jnz	short lff44m_2_2
  5074                                  	
  5075 00001FDD FE0D[CB260000]          	dec	byte [faz]
  5076 00001FE3 74CC                    	jz	short lff44m_9 
  5077 00001FE5 BD0B000000              	mov	ebp, 11
  5078 00001FEA EBD1                    	jmp	short lff44m_1
  5079                                  
  5080                                  lff44m_3:
  5081                                  lff44s_3:
  5082 00001FEC E9A1F0FFFF              	jmp	lff44_3	; padfill
  5083                                  		; (put zeros in the remain words of the buffer)
  5084                                  lff44m_7:
  5085                                  lff44s_7:
  5086 00001FF1 E9BDF0FFFF              	jmp	lff44_5  ; error
  5087                                  
  5088                                  load_44khz_stereo_8_bit:
  5089                                  	; 16/11/2023
  5090 00001FF6 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  5091                                  					; last of the file?
  5092 00001FFD 7402                    	jz	short lff44s_0		; no
  5093 00001FFF F9                      	stc
  5094 00002000 C3                      	retn
  5095                                  
  5096                                  lff44s_0:
  5097                                  	; 01/12/2024
  5098                                  	; edi = audio buffer address
  5099                                  	; 13/12/2024
  5100 00002001 893D[04320000]          	mov	[audio_buffer], edi
  5101 00002007 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5102                                          ;mov	edx, [loadsize]
  5103                                  
  5104                                  	; esi = buffer address
  5105                                  	;; edx = buffer size
  5106                                  
  5107                                  	; load file into memory
  5108                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 0000200C 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00002012 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00002014 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 0000201A B803000000          <1>  mov eax, %1
   106                              <1> 
   107 0000201F CD40                <1>  int 40h
  5109 00002021 72CE                    	jc	short lff44s_7 ; error !
  5110                                  
  5111                                  	; 01/12/2024
  5112 00002023 A3[CC370000]            	mov	[count], eax
  5113                                  
  5114                                  	;mov	edi, audio_buffer
  5115                                  	; 29/05/2024
  5116                                  	;mov	edi, [audio_buffer]
  5117                                  	
  5118 00002028 D1E8                    	shr	eax, 1
  5119 0000202A 7505                    	jnz	short lff44s_8
  5120 0000202C E979F0FFFF              	jmp	lff44_eof
  5121                                  
  5122                                  lff44s_8:
  5123 00002031 89C1                    	mov	ecx, eax	; word count
  5124                                  lff44s_9:
  5125 00002033 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5126 00002038 C605[CB260000]02        	mov	byte [faz], 2  ; 2 steps/phase
  5127                                  lff44s_1:
  5128                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5129                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5130 0000203F 66AD                    	lodsw
  5131 00002041 66BA8080                	mov	dx, 8080h
  5132 00002045 49                      	dec	ecx
  5133 00002046 7403                    	jz	short lff44s_2_1
  5134 00002048 668B16                  	mov	dx, [esi]
  5135                                  lff44s_2_1:	
  5136                                  	; al = [previous_val_l]
  5137                                  	; ah = [previous_val_r]
  5138                                  	; dl = [next_val_l]
  5139                                  	; dh = [next_val_r]
  5140 0000204B E8CE010000              	call	interpolating_2_8bit_stereo
  5141 00002050 E39A                    	jecxz	lff44s_3
  5142                                  lff44s_2_2:
  5143 00002052 AC                      	lodsb
  5144 00002053 2C80                    	sub	al, 80h
  5145 00002055 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5146 00002059 66AB                    	stosw		; (L)
  5147 0000205B AC                      	lodsb
  5148 0000205C 2C80                    	sub	al, 80h
  5149 0000205E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5150 00002062 66AB                    	stosw		; (R)
  5151                                  
  5152 00002064 49                      	dec	ecx
  5153 00002065 7485                    	jz	short lff44s_3	
  5154 00002067 4D                      	dec	ebp
  5155 00002068 75E8                    	jnz	short lff44s_2_2
  5156                                  	
  5157 0000206A FE0D[CB260000]          	dec	byte [faz]
  5158 00002070 74C1                    	jz	short lff44s_9 
  5159 00002072 BD0B000000              	mov	ebp, 11
  5160 00002077 EBC6                    	jmp	short lff44s_1
  5161                                  
  5162                                  load_44khz_mono_16_bit:
  5163                                  	; 18/11/2023
  5164 00002079 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  5165                                  					; last of the file?
  5166 00002080 7402                    	jz	short lff44m2_0		; no
  5167 00002082 F9                      	stc
  5168 00002083 C3                      	retn
  5169                                  
  5170                                  lff44m2_0:
  5171                                  	; 01/12/2024
  5172                                  	; edi = audio buffer address
  5173                                  	; 13/12/2024
  5174 00002084 893D[04320000]          	mov	[audio_buffer], edi
  5175 0000208A BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5176                                          ;mov	edx, [loadsize]
  5177                                  
  5178                                  	; esi = buffer address
  5179                                  	;; edx = buffer size
  5180                                  
  5181                                  	; load file into memory
  5182                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 0000208F 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00002095 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00002097 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 0000209D B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000020A2 CD40                <1>  int 40h
  5183 000020A4 724D                    	jc	short lff44m2_7 ; error !
  5184                                  
  5185                                  	; 01/12/2024
  5186 000020A6 A3[CC370000]            	mov	[count], eax
  5187                                  
  5188                                  	;mov	edi, audio_buffer
  5189                                  	; 29/05/2024
  5190                                  	;mov	edi, [audio_buffer]
  5191                                  	
  5192 000020AB D1E8                    	shr	eax, 1
  5193 000020AD 7505                    	jnz	short lff44m2_8
  5194 000020AF E9F6EFFFFF              	jmp	lff44_eof
  5195                                  
  5196                                  lff44m2_8:
  5197 000020B4 89C1                    	mov	ecx, eax	; word count
  5198                                  lff44m2_9:
  5199 000020B6 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5200 000020BB C605[CB260000]02        	mov	byte [faz], 2  ; 2 steps/phases
  5201                                  lff44m2_1:
  5202                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5203                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5204 000020C2 66AD                    	lodsw
  5205 000020C4 31D2                    	xor	edx, edx
  5206 000020C6 49                      	dec	ecx
  5207 000020C7 7403                    	jz	short lff44m2_2_1
  5208 000020C9 668B16                  	mov	dx, [esi]
  5209                                  lff44m2_2_1:	
  5210                                  	; ax = [previous_val]
  5211                                  	; dx = [next_val]
  5212 000020CC E811020000              	call	interpolating_2_16bit_mono
  5213 000020D1 E31B                    	jecxz	lff44m2_3
  5214                                  lff44m2_2_2:
  5215 000020D3 66AD                    	lodsw
  5216 000020D5 66AB                    	stosw		; (L)eft Channel
  5217 000020D7 66AB                    	stosw		; (R)ight Channel
  5218                                  
  5219 000020D9 49                      	dec	ecx
  5220 000020DA 7412                    	jz	short lff44m2_3	
  5221 000020DC 4D                      	dec	ebp
  5222 000020DD 75F4                    	jnz	short lff44m2_2_2
  5223                                  	
  5224 000020DF FE0D[CB260000]          	dec	byte [faz]
  5225 000020E5 74CF                    	jz	short lff44m2_9 
  5226 000020E7 BD0B000000              	mov	ebp, 11
  5227 000020EC EBD4                    	jmp	short lff44m2_1
  5228                                  
  5229                                  lff44m2_3:
  5230                                  lff44s2_3:
  5231 000020EE E99FEFFFFF              	jmp	lff44_3	; padfill
  5232                                  		; (put zeros in the remain words of the buffer)
  5233                                  lff44m2_7:
  5234                                  lff44s2_7:
  5235 000020F3 E9BBEFFFFF              	jmp	lff44_5  ; error
  5236                                  
  5237                                  load_44khz_stereo_16_bit:
  5238                                  	; 18/11/2023
  5239 000020F8 F605[46370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  5240                                  					; last of the file?
  5241 000020FF 7402                    	jz	short lff44s2_0		; no
  5242 00002101 F9                      	stc
  5243 00002102 C3                      	retn
  5244                                  
  5245                                  lff44s2_0:
  5246                                  	; 01/12/2024
  5247                                  	; edi = audio buffer address
  5248                                  	; 13/12/2024
  5249 00002103 893D[04320000]          	mov	[audio_buffer], edi
  5250 00002109 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5251                                          ;mov	edx, [loadsize]
  5252                                  
  5253                                  	; esi = buffer address
  5254                                  	;; edx = buffer size
  5255                                  
  5256                                  	; load file into memory
  5257                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 0000210E 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00002114 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00002116 8B15[BC370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 0000211C B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00002121 CD40                <1>  int 40h
  5258 00002123 72CE                    	jc	short lff44s2_7 ; error !
  5259                                  
  5260                                  	; 01/12/2024
  5261 00002125 A3[CC370000]            	mov	[count], eax
  5262                                  
  5263                                  	;mov	edi, audio_buffer
  5264                                  	; 29/05/2024
  5265                                  	;mov	edi, [audio_buffer]
  5266                                  	
  5267 0000212A C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  5268 0000212D 7505                    	jnz	short lff44s2_8
  5269 0000212F E976EFFFFF              	jmp	lff44_eof
  5270                                  
  5271                                  lff44s2_8:
  5272 00002134 89C1                    	mov	ecx, eax	; dword count
  5273                                  lff44s2_9:
  5274 00002136 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5275 0000213B C605[CB260000]02        	mov	byte [faz], 2  ; 2 steps/phase
  5276                                  lff44s2_1:
  5277                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5278                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5279 00002142 66AD                    	lodsw
  5280 00002144 89C3                    	mov	ebx, eax
  5281 00002146 66AD                    	lodsw
  5282                                  	;mov	dx, [esi]
  5283                                  	;mov	[next_val_l], dx
  5284                                  	;mov	dx, [esi+2]
  5285                                  	; 26/11/2023
  5286 00002148 8B16                    	mov	edx, [esi]
  5287 0000214A 668915[C7260000]        	mov	[next_val_l], dx
  5288 00002151 C1EA10                  	shr	edx, 16
  5289 00002154 49                      	dec	ecx
  5290 00002155 7509                    	jnz	short lff44s2_2_1
  5291 00002157 31D2                    	xor	edx, edx ; 0
  5292 00002159 668915[C7260000]        	mov	[next_val_l], dx
  5293                                  lff44s2_2_1:
  5294                                  	; bx = [previous_val_l]
  5295                                  	; ax = [previous_val_r]
  5296                                  	; [next_val_l]
  5297                                  	; dx = [next_val_r]
  5298 00002160 E895010000              	call	interpolating_2_16bit_stereo
  5299 00002165 E387                    	jecxz	lff44s2_3
  5300                                  lff44s2_2_2:
  5301                                  	;movsw		; (L)eft Channel
  5302                                  	;movsw		; (R)ight Channel
  5303 00002167 A5                      	movsd
  5304                                  
  5305 00002168 49                      	dec	ecx
  5306 00002169 7483                    	jz	short lff44s2_3	
  5307 0000216B 4D                      	dec	ebp
  5308 0000216C 75F9                    	jnz	short lff44s2_2_2
  5309                                  	
  5310 0000216E FE0D[CB260000]          	dec	byte [faz]
  5311 00002174 74C0                    	jz	short lff44s2_9 
  5312 00002176 BD0B000000              	mov	ebp, 11
  5313 0000217B EBC5                    	jmp	short lff44s2_1
  5314                                  
  5315                                  ; .....................
  5316                                  
  5317                                  interpolating_3_8bit_mono:
  5318                                  	; 16/11/2023
  5319                                  	; al = [previous_val]
  5320                                  	; dl = [next_val]
  5321                                  	; original-interpolated-interpolated
  5322 0000217D 88C3                    	mov	bl, al
  5323 0000217F 2C80                    	sub	al, 80h
  5324 00002181 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5325 00002185 66AB                    	stosw		; original sample (L)
  5326 00002187 66AB                    	stosw		; original sample (R)
  5327 00002189 88D8                    	mov	al, bl
  5328 0000218B 00D0                    	add	al, dl
  5329 0000218D D0D8                    	rcr	al, 1
  5330 0000218F 88C7                    	mov	bh, al	; interpolated middle (temporary)
  5331 00002191 00D8                    	add	al, bl
  5332 00002193 D0D8                    	rcr	al, 1
  5333 00002195 2C80                    	sub	al, 80h
  5334 00002197 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5335 0000219B 66AB                    	stosw		; interpolated sample 1 (L)
  5336 0000219D 66AB                    	stosw		; interpolated sample 1 (R)
  5337 0000219F 88F8                    	mov	al, bh
  5338 000021A1 00D0                    	add	al, dl	; [next_val]
  5339 000021A3 D0D8                    	rcr	al, 1
  5340 000021A5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5341 000021A9 66AB                    	stosw		; interpolated sample 2 (L)
  5342 000021AB 66AB                    	stosw		; interpolated sample 2 (R)
  5343 000021AD C3                      	retn
  5344                                  
  5345                                  interpolating_3_8bit_stereo:
  5346                                  	; 16/11/2023
  5347                                  	; al = [previous_val_l]
  5348                                  	; ah = [previous_val_r]
  5349                                  	; dl = [next_val_l]
  5350                                  	; dh = [next_val_r]
  5351                                  	; original-interpolated-interpolated
  5352 000021AE 89C3                    	mov	ebx, eax
  5353 000021B0 2C80                    	sub	al, 80h
  5354 000021B2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5355 000021B6 66AB                    	stosw		; original sample (L)
  5356 000021B8 88F8                    	mov	al, bh
  5357 000021BA 2C80                    	sub	al, 80h
  5358 000021BC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5359 000021C0 66AB                    	stosw		; original sample (R)
  5360 000021C2 88D8                    	mov	al, bl
  5361 000021C4 00D0                    	add	al, dl	; [next_val_l]
  5362 000021C6 D0D8                    	rcr	al, 1
  5363 000021C8 50                      	push	eax ; *	; al = interpolated middle (L) (temporary)
  5364 000021C9 00D8                    	add	al, bl	; [previous_val_l]
  5365 000021CB D0D8                    	rcr	al, 1
  5366 000021CD 2C80                    	sub	al, 80h
  5367 000021CF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5368 000021D3 66AB                    	stosw		; interpolated sample 1 (L)
  5369 000021D5 88F8                    	mov	al, bh
  5370 000021D7 00F0                    	add	al, dh	; [next_val_r]
  5371 000021D9 D0D8                    	rcr	al, 1
  5372 000021DB 50                      	push	eax ; ** ; al = interpolated middle (R) (temporary)
  5373 000021DC 00F8                    	add	al, bh	; [previous_val_r]
  5374 000021DE D0D8                    	rcr	al, 1
  5375 000021E0 2C80                    	sub	al, 80h
  5376 000021E2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5377 000021E6 66AB                    	stosw		; interpolated sample 1 (R)
  5378 000021E8 5B                      	pop	ebx ; **
  5379 000021E9 58                      	pop	eax ; *
  5380 000021EA 00D0                    	add	al, dl	; [next_val_l]
  5381 000021EC D0D8                    	rcr	al, 1
  5382 000021EE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5383 000021F2 66AB                    	stosw		; interpolated sample 2 (L)
  5384 000021F4 88D8                    	mov	al, bl
  5385 000021F6 00F0                    	add	al, dh	; [next_val_r]
  5386 000021F8 D0D8                    	rcr	al, 1
  5387 000021FA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5388 000021FE 66AB                    	stosw		; interpolated sample 2 (R)
  5389 00002200 C3                      	retn
  5390                                  
  5391                                  interpolating_2_8bit_mono:
  5392                                  	; 16/11/2023
  5393                                  	; al = [previous_val]
  5394                                  	; dl = [next_val]
  5395                                  	; original-interpolated
  5396 00002201 88C3                    	mov	bl, al
  5397 00002203 2C80                    	sub	al, 80h
  5398 00002205 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5399 00002209 66AB                    	stosw		; original sample (L)
  5400 0000220B 66AB                    	stosw		; original sample (R)
  5401 0000220D 88D8                    	mov	al, bl
  5402 0000220F 00D0                    	add	al, dl
  5403 00002211 D0D8                    	rcr	al, 1
  5404 00002213 2C80                    	sub	al, 80h
  5405 00002215 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5406 00002219 66AB                    	stosw		; interpolated sample (L)
  5407 0000221B 66AB                    	stosw		; interpolated sample (R)
  5408 0000221D C3                      	retn
  5409                                  
  5410                                  interpolating_2_8bit_stereo:
  5411                                  	; 16/11/2023
  5412                                  	; al = [previous_val_l]
  5413                                  	; ah = [previous_val_r]
  5414                                  	; dl = [next_val_l]
  5415                                  	; dh = [next_val_r]
  5416                                  	; original-interpolated
  5417 0000221E 89C3                    	mov	ebx, eax
  5418 00002220 2C80                    	sub	al, 80h
  5419 00002222 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5420 00002226 66AB                    	stosw		; original sample (L)
  5421 00002228 88F8                    	mov	al, bh
  5422 0000222A 2C80                    	sub	al, 80h
  5423 0000222C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5424 00002230 66AB                    	stosw		; original sample (R)
  5425 00002232 88D8                    	mov	al, bl	; [previous_val_l]
  5426 00002234 00D0                    	add	al, dl	; [next_val_l]
  5427 00002236 D0D8                    	rcr	al, 1
  5428 00002238 2C80                    	sub	al, 80h
  5429 0000223A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5430 0000223E 66AB                    	stosw		; interpolated sample (L)
  5431 00002240 88F8                    	mov	al, bh
  5432 00002242 00F0                    	add	al, dh	; [next_val_r]
  5433 00002244 D0D8                    	rcr	al, 1
  5434 00002246 2C80                    	sub	al, 80h
  5435 00002248 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5436 0000224C 66AB                    	stosw		; interpolated sample (R)
  5437 0000224E C3                      	retn
  5438                                  
  5439                                  interpolating_3_16bit_mono:
  5440                                  	; 16/11/2023
  5441                                  	; ax = [previous_val]
  5442                                  	; dx = [next_val]
  5443                                  	; original-interpolated-interpolated
  5444                                  
  5445 0000224F 66AB                    	stosw		; original sample (L)
  5446 00002251 66AB                    	stosw		; original sample (R)
  5447 00002253 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5448 00002256 50                      	push	eax ; *	; [previous_val]
  5449 00002257 80C680                  	add	dh, 80h
  5450 0000225A 6601D0                  	add	ax, dx
  5451 0000225D 66D1D8                  	rcr	ax, 1
  5452 00002260 5B                      	pop	ebx ; *
  5453 00002261 93                      	xchg	ebx, eax ; bx  = interpolated middle (temporary)
  5454 00002262 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  5455 00002265 66D1D8                  	rcr	ax, 1
  5456 00002268 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5457 0000226B 66AB                    	stosw 		; interpolated sample 1 (L)
  5458 0000226D 66AB                    	stosw		; interpolated sample 1 (R)
  5459 0000226F 89D8                    	mov	eax, ebx
  5460 00002271 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  5461 00002274 66D1D8                  	rcr	ax, 1
  5462 00002277 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5463 0000227A 66AB                    	stosw		; interpolated sample 2 (L)
  5464 0000227C 66AB                    	stosw		; interpolated sample 2 (R)
  5465 0000227E C3                      	retn
  5466                                  
  5467                                  interpolating_3_16bit_stereo:
  5468                                  	; 16/11/2023
  5469                                  	; bx = [previous_val_l]
  5470                                  	; ax = [previous_val_r]
  5471                                  	; [next_val_l]
  5472                                  	; dx = [next_val_r]
  5473                                  	; original-interpolated-interpolated
  5474                                  
  5475 0000227F 93                      	xchg	eax, ebx
  5476 00002280 66AB                    	stosw		; original sample (L)
  5477 00002282 93                      	xchg	eax, ebx
  5478 00002283 66AB                    	stosw		; original sample (R)
  5479 00002285 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5480 00002288 50                      	push	eax ; *	; [previous_val_r]
  5481 00002289 80C780                  	add	bh, 80h
  5482 0000228C 8005[C8260000]80        	add	byte [next_val_l+1], 80h
  5483 00002293 66A1[C7260000]          	mov	ax, [next_val_l]
  5484 00002299 6601D8                  	add	ax, bx	; [previous_val_l]
  5485 0000229C 66D1D8                  	rcr	ax, 1
  5486 0000229F 93                      	xchg	eax, ebx ; ax = [previous_val_l]
  5487 000022A0 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  5488 000022A3 66D1D8                  	rcr	ax, 1
  5489 000022A6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5490 000022A9 66AB                    	stosw 		; interpolated sample 1 (L)
  5491 000022AB 58                      	pop	eax  ; *
  5492 000022AC 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  5493 000022AF 52                      	push	edx  ; * ; [next_val_r]
  5494 000022B0 92                      	xchg	eax, edx
  5495 000022B1 6601D0                  	add	ax, dx	; [next_val_r] + [previous_val_r]
  5496 000022B4 66D1D8                  	rcr	ax, 1	; / 2
  5497 000022B7 50                      	push	eax ; ** ; interpolated middle (R)
  5498 000022B8 6601D0                  	add	ax, dx	; + [previous_val_r]
  5499 000022BB 66D1D8                  	rcr	ax, 1
  5500 000022BE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5501 000022C1 66AB                    	stosw 		; interpolated sample 1 (R)
  5502 000022C3 66A1[C7260000]          	mov	ax, [next_val_l]
  5503 000022C9 6601D8                  	add	ax, bx	; + interpolated middle (L)
  5504 000022CC 66D1D8                  	rcr	ax, 1
  5505 000022CF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5506 000022D2 66AB                    	stosw 		; interpolated sample 2 (L)
  5507 000022D4 58                      	pop	eax ; **
  5508 000022D5 5A                      	pop	edx ; *
  5509 000022D6 6601D0                  	add	ax, dx	; interpolated middle + [next_val_r]
  5510 000022D9 66D1D8                  	rcr	ax, 1	; / 2
  5511 000022DC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5512 000022DF 66AB                    	stosw 		; interpolated sample 2 (L)
  5513 000022E1 C3                      	retn
  5514                                  
  5515                                  interpolating_2_16bit_mono:
  5516                                  	; 16/11/2023
  5517                                  	; ax = [previous_val]
  5518                                  	; dx = [next_val]
  5519                                  	; original-interpolated
  5520                                  
  5521 000022E2 66AB                    	stosw		; original sample (L)
  5522 000022E4 66AB                    	stosw		; original sample (R)
  5523 000022E6 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5524 000022E9 80C680                  	add	dh, 80h
  5525 000022EC 6601D0                  	add	ax, dx
  5526 000022EF 66D1D8                  	rcr	ax, 1
  5527 000022F2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5528 000022F5 66AB                    	stosw		; interpolated sample (L)
  5529 000022F7 66AB                    	stosw		; interpolated sample (R)
  5530 000022F9 C3                      	retn
  5531                                  
  5532                                  interpolating_2_16bit_stereo:
  5533                                  	; 16/11/2023
  5534                                  	; bx = [previous_val_l]
  5535                                  	; ax = [previous_val_r]
  5536                                  	; [next_val_l]
  5537                                  	; dx = [next_val_r]
  5538                                  	; original-interpolated
  5539                                  
  5540 000022FA 93                      	xchg	eax, ebx
  5541 000022FB 66AB                    	stosw		; original sample (L)
  5542 000022FD 93                      	xchg	eax, ebx
  5543 000022FE 66AB                    	stosw		; original sample (R)
  5544 00002300 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5545 00002303 80C680                  	add	dh, 80h
  5546 00002306 6601D0                  	add	ax, dx	; [previous_val_r] + [next_val_r]
  5547 00002309 66D1D8                  	rcr	ax, 1	; / 2
  5548 0000230C 50                      	push	eax ; *	; interpolated sample (R)
  5549 0000230D 66A1[C7260000]          	mov	ax, [next_val_l]
  5550 00002313 80C480                  	add	ah, 80h
  5551 00002316 80C780                  	add	bh, 80h
  5552 00002319 6601D8                  	add	ax, bx	; [next_val_l] + [previous_val_l]
  5553 0000231C 66D1D8                  	rcr	ax, 1	; / 2
  5554 0000231F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5555 00002322 66AB                    	stosw 		; interpolated sample (L)
  5556 00002324 58                      	pop	eax ; *	
  5557 00002325 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5558 00002328 66AB                    	stosw 		; interpolated sample (R)
  5559 0000232A C3                      	retn
  5560                                  
  5561                                  interpolating_5_8bit_mono:
  5562                                  	; 17/11/2023
  5563                                  	; al = [previous_val]
  5564                                  	; dl = [next_val]
  5565                                  	; original-interpltd-interpltd-interpltd-interpltd
  5566 0000232B 88C3                    	mov	bl, al
  5567 0000232D 2C80                    	sub	al, 80h
  5568 0000232F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5569 00002333 66AB                    	stosw		; original sample (L)
  5570 00002335 66AB                    	stosw		; original sample (R)
  5571 00002337 88D8                    	mov	al, bl
  5572 00002339 00D0                    	add	al, dl
  5573 0000233B D0D8                    	rcr	al, 1
  5574 0000233D 88C7                    	mov	bh, al	; interpolated middle (temporary)
  5575 0000233F 00D8                    	add	al, bl  ; [previous_val]
  5576 00002341 D0D8                    	rcr	al, 1 	
  5577 00002343 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  5578 00002345 00D8                    	add	al, bl
  5579 00002347 D0D8                    	rcr	al, 1
  5580 00002349 2C80                    	sub	al, 80h
  5581 0000234B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5582 0000234F 66AB                    	stosw		; interpolated sample 1 (L)
  5583 00002351 66AB                    	stosw		; interpolated sample 1 (R)
  5584 00002353 88F8                    	mov	al, bh
  5585 00002355 00F0                    	add	al, dh
  5586 00002357 D0D8                    	rcr	al, 1
  5587 00002359 2C80                    	sub	al, 80h
  5588 0000235B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5589 0000235F 66AB                    	stosw		; interpolated sample 2 (L)
  5590 00002361 66AB                    	stosw		; interpolated sample 2 (R)
  5591 00002363 88F8                    	mov	al, bh
  5592 00002365 00D0                    	add	al, dl	; [next_val]
  5593 00002367 D0D8                    	rcr	al, 1
  5594 00002369 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  5595 0000236B 00F8                    	add	al, bh
  5596 0000236D D0D8                    	rcr	al, 1
  5597 0000236F 2C80                    	sub	al, 80h
  5598 00002371 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5599 00002375 66AB                    	stosw		; interpolated sample 3 (L)
  5600 00002377 66AB                    	stosw		; interpolated sample 3 (R)
  5601 00002379 88F0                    	mov	al, dh
  5602 0000237B 00D0                    	add	al, dl
  5603 0000237D D0D8                    	rcr	al, 1
  5604 0000237F 2C80                    	sub	al, 80h
  5605 00002381 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5606 00002385 66AB                    	stosw		; interpolated sample 4 (L)
  5607 00002387 66AB                    	stosw		; interpolated sample 4 (R)
  5608 00002389 C3                      	retn
  5609                                  
  5610                                  interpolating_5_8bit_stereo:
  5611                                  	; 17/11/2023
  5612                                  	; al = [previous_val_l]
  5613                                  	; ah = [previous_val_r]
  5614                                  	; dl = [next_val_l]
  5615                                  	; dh = [next_val_r]
  5616                                  	; original-interpltd-interpltd-interpltd-interpltd
  5617 0000238A 89C3                    	mov	ebx, eax
  5618 0000238C 2C80                    	sub	al, 80h
  5619 0000238E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5620 00002392 66AB                    	stosw		; original sample (L)
  5621 00002394 88F8                    	mov	al, bh
  5622 00002396 2C80                    	sub	al, 80h
  5623 00002398 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5624 0000239C 66AB                    	stosw		; original sample (R)
  5625 0000239E 52                      	push	edx ; *
  5626 0000239F 88D8                    	mov	al, bl
  5627 000023A1 00D0                    	add	al, dl	; [next_val_l]
  5628 000023A3 D0D8                    	rcr	al, 1
  5629 000023A5 50                      	push	eax ; **	; al = interpolated middle (L) (temporary)
  5630 000023A6 00D8                    	add	al, bl	; [previous_val_l]
  5631 000023A8 D0D8                    	rcr	al, 1
  5632 000023AA 86D8                    	xchg	al, bl
  5633 000023AC 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  5634 000023AE D0D8                    	rcr	al, 1
  5635 000023B0 2C80                    	sub	al, 80h
  5636 000023B2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5637 000023B6 66AB                    	stosw		; interpolated sample 1 (L)
  5638 000023B8 88F8                    	mov	al, bh
  5639 000023BA 00F0                    	add	al, dh	; [next_val_r]
  5640 000023BC D0D8                    	rcr	al, 1
  5641 000023BE 50                      	push	eax ; *** ; al = interpolated middle (R) (temporary)
  5642 000023BF 00F8                    	add	al, bh	; [previous_val_r]
  5643 000023C1 D0D8                    	rcr	al, 1
  5644 000023C3 86F8                    	xchg	al, bh
  5645 000023C5 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  5646 000023C7 D0D8                    	rcr	al, 1
  5647 000023C9 2C80                    	sub	al, 80h
  5648 000023CB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5649 000023CF 66AB                    	stosw		; interpolated sample 1 (R)
  5650 000023D1 5A                      	pop	edx ; ***
  5651 000023D2 58                      	pop	eax ; **	; al = interpolated middle (L) (temporary)
  5652 000023D3 86D8                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  5653 000023D5 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  5654 000023D7 D0D8                    	rcr	al, 1
  5655 000023D9 2C80                    	sub	al, 80h
  5656 000023DB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5657 000023DF 66AB                    	stosw		; interpolated sample 2 (L)
  5658 000023E1 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  5659 000023E3 86F8                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  5660 000023E5 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  5661 000023E7 D0D8                    	rcr	al, 1
  5662 000023E9 2C80                    	sub	al, 80h
  5663 000023EB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5664 000023EF 66AB                    	stosw		; interpolated sample 2 (R)
  5665 000023F1 5A                      	pop	edx ; *
  5666 000023F2 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  5667 000023F4 00D0                    	add	al, dl	; [next_val_l]
  5668 000023F6 D0D8                    	rcr	al, 1
  5669 000023F8 86D8                    	xchg	al, bl	; al = interpolated middle (R) (temporary)
  5670 000023FA 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp)
  5671 000023FC D0D8                    	rcr	al, 1
  5672 000023FE 2C80                    	sub	al, 80h
  5673 00002400 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5674 00002404 66AB                    	stosw		; interpolated sample 3 (L)
  5675 00002406 88F8                    	mov	al, bh	
  5676 00002408 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  5677 0000240A D0D8                    	rcr	al, 1
  5678 0000240C 86F8                    	xchg	al, bh	; al = interpolated middle (R)
  5679 0000240E 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  5680 00002410 D0D8                    	rcr	al, 1
  5681 00002412 2C80                    	sub	al, 80h
  5682 00002414 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5683 00002418 66AB                    	stosw		; interpolated sample 3 (R)
  5684 0000241A 88D8                    	mov	al, bl
  5685 0000241C 00D0                    	add	al, dl	; [next_val_l]
  5686 0000241E D0D8                    	rcr	al, 1
  5687 00002420 2C80                    	sub	al, 80h
  5688 00002422 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5689 00002426 66AB                    	stosw		; interpolated sample 4 (L)
  5690 00002428 88F8                    	mov	al, bh
  5691 0000242A 00F0                    	add	al, dh	; [next_val_r]
  5692 0000242C D0D8                    	rcr	al, 1
  5693 0000242E 2C80                    	sub	al, 80h
  5694 00002430 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5695 00002434 66AB                    	stosw		; interpolated sample 4 (R)
  5696 00002436 C3                      	retn
  5697                                  
  5698                                  interpolating_4_8bit_mono:
  5699                                  	; 17/11/2023
  5700                                  	; al = [previous_val]
  5701                                  	; dl = [next_val]
  5702                                  	; original-interpolated-interpolated-interpolated
  5703 00002437 88C3                    	mov	bl, al
  5704 00002439 2C80                    	sub	al, 80h
  5705 0000243B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5706 0000243F 66AB                    	stosw		; original sample (L)
  5707 00002441 66AB                    	stosw		; original sample (R)
  5708 00002443 88D8                    	mov	al, bl
  5709 00002445 00D0                    	add	al, dl	
  5710 00002447 D0D8                    	rcr	al, 1
  5711 00002449 86D8                    	xchg	al, bl  ; al = [previous_val]
  5712 0000244B 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  5713 0000244D D0D8                    	rcr	al, 1 	
  5714 0000244F 2C80                    	sub	al, 80h
  5715 00002451 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5716 00002455 66AB                    	stosw		; interpolated sample 1 (L)
  5717 00002457 66AB                    	stosw		; interpolated sample 1 (R)
  5718 00002459 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  5719 0000245B 2C80                    	sub	al, 80h
  5720 0000245D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5721 00002461 66AB                    	stosw		; interpolated sample 2 (L)
  5722 00002463 66AB                    	stosw		; interpolated sample 2 (R)
  5723 00002465 88D8                    	mov	al, bl
  5724 00002467 00D0                    	add	al, dl	; [next_val]
  5725 00002469 D0D8                    	rcr	al, 1
  5726 0000246B 2C80                    	sub	al, 80h
  5727 0000246D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5728 00002471 66AB                    	stosw		; interpolated sample 3 (L)
  5729 00002473 66AB                    	stosw		; interpolated sample 3 (R)
  5730 00002475 C3                      	retn
  5731                                  
  5732                                  interpolating_4_8bit_stereo:
  5733                                  	; 17/11/2023
  5734                                  	; al = [previous_val_l]
  5735                                  	; ah = [previous_val_r]
  5736                                  	; dl = [next_val_l]
  5737                                  	; dh = [next_val_r]	
  5738                                  	; original-interpolated-interpolated-interpolated
  5739 00002476 89C3                    	mov	ebx, eax
  5740 00002478 2C80                    	sub	al, 80h
  5741 0000247A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5742 0000247E 66AB                    	stosw		; original sample (L)
  5743 00002480 88F8                    	mov	al, bh
  5744 00002482 2C80                    	sub	al, 80h
  5745 00002484 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5746 00002488 66AB                    	stosw		; original sample (R)
  5747 0000248A 88D8                    	mov	al, bl
  5748 0000248C 00D0                    	add	al, dl	; [next_val_l]
  5749 0000248E D0D8                    	rcr	al, 1
  5750 00002490 86D8                    	xchg	al, bl	; al = [previous_val_l]
  5751 00002492 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  5752 00002494 D0D8                    	rcr	al, 1
  5753 00002496 2C80                    	sub	al, 80h
  5754 00002498 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5755 0000249C 66AB                    	stosw		; interpolated sample 1 (L)
  5756 0000249E 88F8                    	mov	al, bh
  5757 000024A0 00F0                    	add	al, dh	; [next_val_r]
  5758 000024A2 D0D8                    	rcr	al, 1
  5759 000024A4 86F8                    	xchg	al, bh	; al = [previous_val_h]
  5760 000024A6 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  5761 000024A8 D0D8                    	rcr	al, 1
  5762 000024AA 2C80                    	sub	al, 80h
  5763 000024AC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5764 000024B0 66AB                    	stosw		; interpolated sample 1 (R)
  5765 000024B2 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  5766 000024B4 2C80                    	sub	al, 80h
  5767 000024B6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5768 000024BA 66AB                    	stosw		; interpolated sample 2 (L)
  5769 000024BC 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  5770 000024BE 2C80                    	sub	al, 80h
  5771 000024C0 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5772 000024C4 66AB                    	stosw		; interpolated sample 2 (L)
  5773 000024C6 88D8                    	mov	al, bl
  5774 000024C8 00D0                    	add	al, dl	; [next_val_l]
  5775 000024CA D0D8                    	rcr	al, 1
  5776 000024CC 2C80                    	sub	al, 80h
  5777 000024CE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5778 000024D2 66AB                    	stosw		; interpolated sample 3 (L)
  5779 000024D4 88F8                    	mov	al, bh
  5780 000024D6 00F0                    	add	al, dh	; [next_val_r]
  5781 000024D8 D0D8                    	rcr	al, 1
  5782 000024DA 2C80                    	sub	al, 80h
  5783 000024DC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5784 000024E0 66AB                    	stosw		; interpolated sample 3 (R)
  5785 000024E2 C3                      	retn
  5786                                  
  5787                                  interpolating_5_16bit_mono:
  5788                                  	; 18/11/2023
  5789                                  	; ax = [previous_val]
  5790                                  	; dx = [next_val]
  5791                                  	; original-interpltd-interpltd-interpltd-interpltd
  5792 000024E3 66AB                    	stosw		; original sample (L)
  5793 000024E5 66AB                    	stosw		; original sample (R)
  5794 000024E7 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5795 000024EA 89C3                    	mov	ebx, eax ; [previous_val]
  5796 000024EC 80C680                  	add	dh, 80h
  5797 000024EF 6601D0                  	add	ax, dx
  5798 000024F2 66D1D8                  	rcr	ax, 1
  5799 000024F5 50                      	push	eax ; *	; interpolated middle (temporary)
  5800 000024F6 6601D8                  	add	ax, bx	; interpolated middle + [previous_val] 
  5801 000024F9 66D1D8                  	rcr	ax, 1
  5802 000024FC 50                      	push	eax ; **	; interpolated 1st quarter (temporary)
  5803 000024FD 6601D8                  	add	ax, bx	; 1st quarter + [previous_val]
  5804 00002500 66D1D8                  	rcr	ax, 1	
  5805 00002503 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5806 00002506 66AB                    	stosw 		; interpolated sample 1 (L)
  5807 00002508 66AB                    	stosw		; interpolated sample 1 (R)
  5808 0000250A 58                      	pop	eax ; **
  5809 0000250B 5B                      	pop	ebx ; *
  5810 0000250C 6601D8                  	add	ax, bx	; 1st quarter + middle
  5811 0000250F 66D1D8                  	rcr	ax, 1	; / 2
  5812 00002512 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  5813 00002515 66AB                    	stosw		; interpolated sample 2 (L)
  5814 00002517 66AB                    	stosw		; interpolated sample 2 (R)
  5815 00002519 89D8                    	mov	eax, ebx
  5816 0000251B 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  5817 0000251E 66D1D8                  	rcr	ax, 1
  5818 00002521 50                      	push	eax ; *	; interpolated 3rd quarter (temporary)
  5819 00002522 6601D8                  	add	ax, bx	; + interpolated middle
  5820 00002525 66D1D8                  	rcr	ax, 1
  5821 00002528 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5822 0000252B 66AB                    	stosw		; interpolated sample 3 (L)
  5823 0000252D 66AB                    	stosw		; interpolated sample 3 (R)
  5824 0000252F 58                      	pop	eax ; *	
  5825 00002530 6601D0                  	add	ax, dx	; 3rd quarter + [next_val]
  5826 00002533 66D1D8                  	rcr	ax, 1	; / 2
  5827 00002536 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5828 00002539 66AB                    	stosw		; interpolated sample 4 (L)
  5829 0000253B 66AB                    	stosw		; interpolated sample 4 (R)
  5830 0000253D C3                      	retn
  5831                                  
  5832                                  interpolating_5_16bit_stereo:
  5833                                  	; 18/11/2023
  5834                                  	; bx = [previous_val_l]
  5835                                  	; ax = [previous_val_r]
  5836                                  	; [next_val_l]
  5837                                  	; [next_val_r]
  5838                                  	; original-interpltd-interpltd-interpltd-interpltd
  5839 0000253E 51                      	push	ecx ; !
  5840 0000253F 93                      	xchg	eax, ebx
  5841 00002540 66AB                    	stosw		; original sample (L)
  5842 00002542 93                      	xchg	eax, ebx
  5843 00002543 66AB                    	stosw		; original sample (R)
  5844 00002545 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5845 00002548 50                      	push	eax ; *	; [previous_val_r]
  5846 00002549 80C780                  	add	bh, 80h
  5847 0000254C 8005[C8260000]80        	add	byte [next_val_l+1], 80h
  5848 00002553 66A1[C7260000]          	mov	ax, [next_val_l]
  5849 00002559 6601D8                  	add	ax, bx	; [previous_val_l]
  5850 0000255C 66D1D8                  	rcr	ax, 1
  5851 0000255F 89C1                    	mov	ecx, eax ; interpolated middle (L)
  5852 00002561 6601D8                  	add	ax, bx	
  5853 00002564 66D1D8                  	rcr	ax, 1
  5854 00002567 89C2                    	mov	edx, eax ; interpolated 1st quarter (L)
  5855 00002569 6601D8                  	add	ax, bx	; [previous_val_l]
  5856 0000256C 66D1D8                  	rcr	ax, 1
  5857 0000256F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5858 00002572 66AB                    	stosw 		; interpolated sample 1 (L)
  5859 00002574 89C8                    	mov	eax, ecx
  5860 00002576 6601D0                  	add	ax, dx	; middle (L) + 1st quarter (L)
  5861 00002579 66D1D8                  	rcr	ax, 1	; / 2
  5862 0000257C 89C3                    	mov	ebx, eax  ; interpolated sample 2 (L)
  5863 0000257E 5A                      	pop	edx ; *	; [previous_val_r]
  5864 0000257F 89D0                    	mov	eax, edx
  5865 00002581 8005[CA260000]80        	add	byte [next_val_r+1], 80h
  5866 00002588 660305[C9260000]        	add	ax, [next_val_r]
  5867 0000258F 66D1D8                  	rcr	ax, 1
  5868 00002592 50                      	push	eax ; *	; interpolated middle (R)
  5869 00002593 6601D0                  	add	ax, dx
  5870 00002596 66D1D8                  	rcr	ax, 1
  5871 00002599 50                      	push	eax ; ** ; interpolated 1st quarter (R)
  5872 0000259A 6601D0                  	add	ax, dx	; [previous_val_r]
  5873 0000259D 66D1D8                  	rcr	ax, 1
  5874 000025A0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5875 000025A3 66AB                    	stosw 		; interpolated sample 1 (R)
  5876 000025A5 89D8                    	mov	eax, ebx
  5877 000025A7 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5878 000025AA 66AB                    	stosw 		; interpolated sample 2 (L)
  5879 000025AC 58                      	pop	eax ; **
  5880 000025AD 5A                      	pop	edx ; *
  5881 000025AE 6601D0                  	add	ax, dx	; 1st quarter (R) + middle (R)
  5882 000025B1 66D1D8                  	rcr	ax, 1	; / 2
  5883 000025B4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5884 000025B7 66AB                    	stosw 		; interpolated sample 2 (R)
  5885 000025B9 89C8                    	mov	eax, ecx
  5886 000025BB 660305[C7260000]        	add	ax, [next_val_l]
  5887 000025C2 66D1D8                  	rcr	ax, 1
  5888 000025C5 50                      	push	eax ; * ; interpolated 3rd quarter (L)
  5889 000025C6 6601C8                  	add	ax, cx	; interpolated middle (L)
  5890 000025C9 66D1D8                  	rcr	ax, 1
  5891 000025CC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5892 000025CF 66AB                    	stosw 		; interpolated sample 3 (L)
  5893 000025D1 89D0                    	mov	eax, edx
  5894 000025D3 660305[C9260000]        	add	ax, [next_val_r]
  5895 000025DA 66D1D8                  	rcr	ax, 1
  5896 000025DD 50                      	push	eax ; ** ; interpolated 3rd quarter (R)
  5897 000025DE 6601D0                  	add	ax, dx	; interpolated middle (R)
  5898 000025E1 66D1D8                  	rcr	ax, 1
  5899 000025E4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5900 000025E7 66AB                    	stosw 		; interpolated sample 3 (R)
  5901 000025E9 5B                      	pop	ebx ; **
  5902 000025EA 58                      	pop	eax ; *
  5903 000025EB 660305[C7260000]        	add	ax, [next_val_l]
  5904 000025F2 66D1D8                  	rcr	ax, 1
  5905 000025F5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5906 000025F8 66AB                    	stosw 		; interpolated sample 4 (L)
  5907 000025FA 89D8                    	mov	eax, ebx
  5908 000025FC 660305[C9260000]        	add	ax, [next_val_r]
  5909 00002603 66D1D8                  	rcr	ax, 1
  5910 00002606 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5911 00002609 66AB                    	stosw 		; interpolated sample 4 (R)
  5912 0000260B 59                      	pop	ecx ; !
  5913 0000260C C3                      	retn
  5914                                  
  5915                                  interpolating_4_16bit_mono:
  5916                                  	; 18/11/2023
  5917                                  	; ax = [previous_val]
  5918                                  	; dx = [next_val]
  5919                                  	; original-interpolated
  5920                                  
  5921 0000260D 66AB                    	stosw		; original sample (L)
  5922 0000260F 66AB                    	stosw		; original sample (R)
  5923 00002611 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5924 00002614 89C3                    	mov	ebx, eax ; [previous_val]
  5925 00002616 80C680                  	add	dh, 80h
  5926 00002619 6601D0                  	add	ax, dx	; [previous_val] + [next_val]
  5927 0000261C 66D1D8                  	rcr	ax, 1
  5928 0000261F 93                      	xchg	eax, ebx
  5929 00002620 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  5930 00002623 66D1D8                  	rcr	ax, 1
  5931 00002626 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5932 00002629 66AB                    	stosw 		; interpolated sample 1 (L)
  5933 0000262B 66AB                    	stosw		; interpolated sample 1 (R)
  5934 0000262D 89D8                    	mov	eax, ebx ; interpolated middle
  5935 0000262F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5936 00002632 66AB                    	stosw 		; interpolated sample 2 (L)
  5937 00002634 66AB                    	stosw		; interpolated sample 2 (R)
  5938 00002636 89D8                    	mov	eax, ebx
  5939 00002638 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  5940 0000263B 66D1D8                  	rcr	ax, 1
  5941 0000263E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5942 00002641 66AB                    	stosw		; interpolated sample 3 (L)
  5943 00002643 66AB                    	stosw		; interpolated sample 3 (R)
  5944 00002645 C3                      	retn
  5945                                  
  5946                                  interpolating_4_16bit_stereo:
  5947                                  	; 18/11/2023
  5948                                  	; bx = [previous_val_l]
  5949                                  	; ax = [previous_val_r]
  5950                                  	; [next_val_l]
  5951                                  	; [next_val_r]
  5952                                  	; original-interpolated-interpolated-interpolated
  5953 00002646 93                      	xchg	eax, ebx
  5954 00002647 66AB                    	stosw		; original sample (L)
  5955 00002649 93                      	xchg	eax, ebx
  5956 0000264A 66AB                    	stosw		; original sample (R)
  5957 0000264C 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5958 0000264F 89C2                    	mov	edx, eax ; [previous_val_r]
  5959 00002651 80C780                  	add	bh, 80h
  5960 00002654 8005[C8260000]80        	add	byte [next_val_l+1], 80h
  5961 0000265B 66A1[C7260000]          	mov	ax, [next_val_l]
  5962 00002661 6601D8                  	add	ax, bx	; [previous_val_l]
  5963 00002664 66D1D8                  	rcr	ax, 1
  5964 00002667 93                      	xchg	eax, ebx
  5965 00002668 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  5966 0000266B 66D1D8                  	rcr	ax, 1
  5967 0000266E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5968 00002671 66AB                    	stosw 		; interpolated sample 1 (L)
  5969 00002673 8005[CA260000]80        	add	byte [next_val_r+1], 80h
  5970 0000267A 89D0                    	mov	eax, edx ; [previous_val_r]
  5971 0000267C 660305[C9260000]        	add	ax, [next_val_r]
  5972 00002683 66D1D8                  	rcr	ax, 1
  5973 00002686 92                      	xchg	eax, edx
  5974 00002687 6601D0                  	add	ax, dx	; dx = interpolated middle (R)
  5975 0000268A 66D1D8                  	rcr	ax, 1
  5976 0000268D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5977 00002690 66AB                    	stosw 		; interpolated sample 1 (R)
  5978 00002692 89D8                    	mov	eax, ebx
  5979 00002694 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5980 00002697 66AB                    	stosw 		; interpolated sample 2 (L)
  5981 00002699 89D0                    	mov	eax, edx
  5982 0000269B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5983 0000269E 66AB                    	stosw 		; interpolated sample 2 (R)
  5984 000026A0 89D8                    	mov	eax, ebx
  5985 000026A2 660305[C7260000]        	add	ax, [next_val_l]
  5986 000026A9 66D1D8                  	rcr	ax, 1
  5987 000026AC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5988 000026AF 66AB                    	stosw 		; interpolated sample 3 (L)
  5989 000026B1 89D0                    	mov	eax, edx
  5990 000026B3 660305[C9260000]        	add	ax, [next_val_r]
  5991 000026BA 66D1D8                  	rcr	ax, 1
  5992 000026BD 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5993 000026C0 66AB                    	stosw 		; interpolated sample 3 (R)
  5994 000026C2 C3                      	retn
  5995                                  
  5996                                  ; 13/11/2023
  5997                                  previous_val:
  5998 000026C3 0000                    previous_val_l: dw 0
  5999 000026C5 0000                    previous_val_r: dw 0
  6000                                  next_val:
  6001 000026C7 0000                    next_val_l: dw 0
  6002 000026C9 0000                    next_val_r: dw 0
  6003                                  
  6004                                  ; 16/11/2023
  6005 000026CB 00                      faz:	db 0
  6006                                  
  6007                                  ; --------------------------------------------------------
  6008                                  ; 14/11/2024 - Erdogan Tan
  6009                                  ; --------------------------------------------------------
  6010                                  
  6011                                  	; 07/12/2024
  6012                                  	; 01/12/2024 (32bit registers)
  6013                                  	; 29/11/2024
  6014                                  checkUpdateEvents:
  6015 000026CC E8B9010000              	call	check4keyboardstop
  6016 000026D1 7272                    	jc	short c4ue_ok
  6017                                  
  6018                                  	; 18/11/2024
  6019 000026D3 50                      	push	eax ; *
  6020 000026D4 09C0                    	or	eax, eax
  6021 000026D6 0F84D1000000            	jz	c4ue_cpt
  6022                                  
  6023                                  	; 18/11/2024
  6024 000026DC 3C20                    	cmp	al, 20h ; SPACE (spacebar) ; pause/play
  6025 000026DE 7543                    	jne	short c4ue_chk_s
  6026 000026E0 803D[08370000]00        	cmp	byte [stopped], 0
  6027 000026E7 7714                    	ja	short c4ue_chk_ps
  6028                                  	; pause
  6029 000026E9 E850E5FFFF              	call	ac97_pause
  6030                                  	; 21/11/2024
  6031 000026EE A0[09370000]            	mov	al, [tLO]
  6032 000026F3 A2[0A370000]            	mov	byte [tLP], al
  6033 000026F8 E9B0000000              	jmp	c4ue_cpt
  6034                                  c4ue_chk_ps:
  6035 000026FD 803D[08370000]01        	cmp	byte [stopped], 1
  6036 00002704 770A                    	ja	short c4ue_replay
  6037                                  	; continue to play (after a pause)
  6038 00002706 E83CE5FFFF              	call	ac97_play 
  6039 0000270B E99D000000              	jmp	c4ue_cpt
  6040                                  c4ue_replay:
  6041                                  	; 19/11/2024
  6042 00002710 58                      	pop	eax ; *
  6043 00002711 58                      	pop	eax ; return address
  6044                                  	; 07/02/2024
  6045                                  	;mov	al, [volume]
  6046                                  	;call	SetmasterVolume
  6047 00002712 C605[08370000]00        	mov	byte [stopped], 0
  6048 00002719 E812040000              	call	move_to_beginning
  6049                                  	;jmp	PlayWav
  6050                                  	; 07/12/2024
  6051 0000271E E99ADEFFFF              	jmp	RePlayWav
  6052                                  
  6053                                  c4ue_chk_s:
  6054 00002723 3C53                    	cmp	al, 'S'	; stop
  6055 00002725 751F                    	jne	short c4ue_chk_fb
  6056 00002727 803D[08370000]00        	cmp	byte [stopped], 0
  6057 0000272E 777D                    	ja	c4ue_cpt ; Already stopped/paused
  6058 00002730 E8F0E4FFFF              	call	ac97_stop
  6059                                  	; 19/11/2024
  6060 00002735 C605[09370000]00        	mov	byte [tLO], 0
  6061                                  	; 21/11/2024
  6062 0000273C C605[0A370000]30        	mov	byte [tLP], '0'
  6063 00002743 EB68                    	jmp	c4ue_cpt
  6064                                  
  6065                                  	; 01/12/2024
  6066                                  	; 18/11/2024
  6067                                  c4ue_ok:
  6068 00002745 C3                      	retn
  6069                                  
  6070                                  c4ue_chk_fb:
  6071                                  	; 17/11/2024
  6072 00002746 3C46                    	cmp	al, 'F'
  6073 00002748 7507                    	jne	short c4ue_chk_b
  6074 0000274A E8B9030000              	call 	Player_ProcessKey_Forwards
  6075 0000274F EB5C                    	jmp	c4ue_cpt
  6076                                  
  6077                                  c4ue_chk_b:
  6078 00002751 3C42                    	cmp	al, 'B'
  6079                                  	;;jne	short c4ue_cpt
  6080                                  	; 19/11/2024
  6081                                  	;jne	short c4ue_chk_h
  6082                                  	; 25/12/2024
  6083                                  	; 29/11/2024
  6084 00002753 7507                    	jne	short c4ue_chk_n
  6085 00002755 E8AA030000              	call 	Player_ProcessKey_Backwards
  6086 0000275A EB51                    	jmp	short c4ue_cpt
  6087                                  
  6088                                  	;;;
  6089                                  	; 25/12/2024
  6090                                  	; 29/11/2024
  6091                                  c4ue_chk_n:
  6092 0000275C 3C4E                    	cmp	al, 'N'
  6093 0000275E 7404                    	je	short c4ue_nps
  6094                                  c4ue_chk_p:
  6095 00002760 3C50                    	cmp	al, 'P'
  6096 00002762 7509                    	jne	short c4ue_chk_h
  6097                                  c4ue_nps:
  6098 00002764 C605[08370000]03        	mov	byte [stopped], 3
  6099 0000276B EB40                    	jmp	short c4ue_cpt
  6100                                  	;;;
  6101                                  
  6102                                  c4ue_chk_h:
  6103                                  	; 19/11/2024
  6104 0000276D 3C48                    	cmp	al, 'H'
  6105 0000276F 750E                    	jne	short c4ue_chk_cr
  6106 00002771 C605[0B370000]00        	mov	byte [wpoints], 0
  6107 00002778 E858E6FFFF              	call 	write_ac97_pci_dev_info
  6108                                  	; 30/12/2024
  6109 0000277D EB2E                    	jmp	short c4ue_cpt
  6110                                  c4ue_chk_cr:
  6111                                  	;;;
  6112                                  	; 24/12/2024 (wave lighting points option)
  6113                                  	;mov	ah, [wpoints]
  6114                                  	; 30/12/2024
  6115 0000277F 31DB                    	xor	ebx, ebx
  6116 00002781 8A1D[0B370000]          	mov	bl, [wpoints]
  6117 00002787 3C47                    	cmp	al, 'G'
  6118 00002789 7406                    	je	short c4ue_g
  6119                                  	; 19/11/2024
  6120 0000278B 3C0D                    	cmp	al, 0Dh ; ENTER/CR key
  6121 0000278D 751E                    	jne	short c4ue_cpt
  6122                                  	; 23/11/2024
  6123                                  	;xor	ebx, ebx
  6124                                  	; 30/12/2024
  6125                                  	;mov	bl, ah ; 24/12/2024
  6126 0000278F FEC3                    	inc	bl
  6127                                  c4ue_g:	; 30/12/2024
  6128 00002791 80E307                  	and	bl, 07h
  6129 00002794 7501                    	jnz	short c4ue_sc
  6130 00002796 43                      	inc	ebx
  6131                                  c4ue_sc:
  6132 00002797 881D[0B370000]          	mov	[wpoints], bl
  6133                                  	; 30/12/2024
  6134 0000279D 8A83[EB310000]          	mov	al, [ebx+colors-1] ; 1 to 7
  6135                                  	; 24/12/2024
  6136 000027A3 A2[F3310000]            	mov	[ccolor], al
  6137                                  	; 30/12/2024
  6138 000027A8 E8B2030000              	call	clear_window
  6139                                  	;;;
  6140                                  c4ue_cpt:
  6141                                  	; 24/12/2024
  6142                                  	; 18/11/2024
  6143 000027AD 59                      	pop	ecx ; *
  6144                                  	;;;
  6145                                  	; 29/12/2024
  6146                                  	; 24/12/2024 (skip wave lighting if data is not loaded yet)
  6147                                  	;cmp	byte [SRB], 0
  6148                                  	;ja	short c4ue_vb_ok
  6149                                  	;;;
  6150                                  	; 01/12/2024 (TRDOS 386)
  6151                                  	sys	_time, 4 ; get timer ticks (18.2 ticks/second),
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000027AE BB04000000          <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99                              <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101                              <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000027B3 B80D000000          <1>  mov eax, %1
   106                              <1> 
   107 000027B8 CD40                <1>  int 40h
  6152                                  	; 24/12/2024
  6153                                  	; 18/11/2024
  6154                                  	;pop	ecx ; *
  6155                                  	; 01/12/2024
  6156 000027BA 3B05[D4370000]          	cmp	eax, [timerticks]
  6157                                  	;je	short c4ue_ok
  6158                                  	; 18/11/2024
  6159 000027C0 7408                    	je	short c4ue_skip_utt
  6160                                  c4ue_utt:	
  6161                                  	; 01/12/2024
  6162 000027C2 A3[D4370000]            	mov	[timerticks], eax
  6163 000027C7 EB05                    	jmp	short c4ue_cpt_@
  6164                                  
  6165                                  	; 30/12/2024
  6166                                  c4ue_vb_ok:
  6167 000027C9 C3                      	retn
  6168                                  
  6169                                  c4ue_skip_utt:
  6170                                  	; 18/11/2024
  6171 000027CA 21C9                    	and	ecx, ecx
  6172 000027CC 74FB                    	jz	short c4ue_vb_ok
  6173                                  c4ue_cpt_@:
  6174                                  	; 18/11/2024
  6175 000027CE 803D[08370000]00        	cmp	byte [stopped], 0
  6176 000027D5 77F2                    	ja	short c4ue_vb_ok
  6177                                  	
  6178 000027D7 E8C2010000              	call	CalcProgressTime
  6179                                  
  6180                                  	;cmp	ax, [ProgressTime]
  6181                                  	; 01/12/2024
  6182 000027DC 3B05[C8370000]          	cmp	eax, [ProgressTime]
  6183                                  	;je	short c4ue_vb_ok
  6184                                  			; same second, no need to update
  6185                                  	; 23/11/2024
  6186 000027E2 7405                    	je	short c4ue_uvb
  6187                                  
  6188                                  	;call	UpdateProgressTime
  6189                                  	;call	UpdateProgressBar@
  6190 000027E4 E89F020000              	call	UpdateProgressBar
  6191                                  
  6192                                  	; 23/11/2024
  6193                                  c4ue_uvb:
  6194 000027E9 803D[0B370000]00        	cmp	byte [wpoints], 0
  6195 000027F0 76D7                    	jna	short c4ue_vb_ok
  6196                                  
  6197                                  	; 30/12/2024
  6198                                  	;call	UpdateWavePoints
  6199                                  	;retn
  6200                                  
  6201                                  ; --------------------------------------------------------
  6202                                  ; 27/12/2024 - Erdogan Tan
  6203                                  ; --------------------------------------------------------
  6204                                  
  6205                                  	; 30/12/2024 (cgaplay.s)
  6206                                  	;  * 320*200 pixels, 256 colors
  6207                                  	;  * 64 volume levels
  6208                                  	; 29/12/2024
  6209                                  	; 27/12/2024 (DMA Buffer Tracking)
  6210                                  	; 26/12/2024
  6211                                  	; 24/12/2024
  6212                                  UpdateWavePoints:
  6213 000027F2 BE[08320000]            	mov	esi, prev_points
  6214 000027F7 833E00                  	cmp	dword [esi], 0
  6215 000027FA 740B                    	jz	short lights_off_ok
  6216                                  	;mov	ecx, 640
  6217                                  	; 30/12/2024
  6218 000027FC B940010000              	mov	ecx, 320
  6219                                  light_off:
  6220 00002801 AD                      	lodsd
  6221                                  	; eax = wave point (lighting point) address
  6222 00002802 C60000                  	mov	byte [eax], 0 ; black point (light off)
  6223 00002805 E2FA                    	loop	light_off	
  6224                                  
  6225                                  lights_off_ok:
  6226                                  	; 29/12/2024
  6227 00002807 803D[09370000]32        	cmp	byte [tLO],'2'
  6228 0000280E 7507                    	jne	short lights_on_buff_1
  6229                                  lights_on_buff_2:
  6230 00002810 BA[00500100]            	mov	edx, WAVBUFFER_2
  6231 00002815 EB05                    	jmp	short lights_on
  6232                                  lights_on_buff_1:
  6233 00002817 BA[00500000]            	mov	edx, WAVBUFFER_1
  6234                                  lights_on:
  6235 0000281C 3915[10370000]          	cmp	[pbuf_s], edx
  6236 00002822 7520                    	jne	short lights_on_2
  6237 00002824 8B1D[F4310000]          	mov	ebx, [wpoints_dif]
  6238 0000282A 8B35[0C370000]          	mov	esi, [pbuf_o]
  6239 00002830 8B0D[C0370000]          	mov	ecx, [buffersize] ; bytes
  6240 00002836 29D9                    	sub	ecx, ebx ; sub ecx, [wpoints_dif]
  6241 00002838 01DE                    	add	esi, ebx
  6242 0000283A 7204                    	jc	short lights_on_1
  6243 0000283C 39CE                    	cmp	esi, ecx
  6244 0000283E 760C                    	jna	short lights_on_3
  6245                                  lights_on_1:
  6246 00002840 89CE                    	mov	esi, ecx
  6247 00002842 EB08                    	jmp	short lights_on_3
  6248                                  
  6249                                  lights_on_2:
  6250                                  	; 29/12/2024
  6251 00002844 8915[10370000]          	mov	[pbuf_s], edx
  6252 0000284A 31F6                    	xor	esi, esi ; 0
  6253                                  lights_on_3:
  6254 0000284C 8935[0C370000]          	mov	[pbuf_o], esi
  6255                                  	; 29/12/2024
  6256                                  	;add	esi, [pbuf_s]
  6257 00002852 01D6                    	add	esi, edx
  6258                                  	;mov	ecx, 640
  6259                                  	; 30/12/2024
  6260 00002854 B940010000              	mov	ecx, 320
  6261 00002859 89CD                    	mov	ebp, ecx
  6262                                  	; 26/12/2024
  6263 0000285B BF[08320000]            	mov	edi, prev_points
  6264 00002860 8B1D[F8310000]          	mov	ebx, [graphstart] ; start (top) line
  6265                                  lights_on_4:
  6266 00002866 31C0                    	xor	eax, eax ; 0
  6267 00002868 66AD                    	lodsw	; left
  6268 0000286A 80C480                  	add	ah, 80h
  6269 0000286D 89C2                    	mov	edx, eax
  6270 0000286F 66AD                    	lodsw	; right
  6271                                  	;add	ax, dx
  6272 00002871 80C480                  	add	ah, 80h
  6273                                  	;;shr	eax, 9	; 128 volume levels
  6274                                  	; 01/01/2024
  6275 00002874 01D0                    	add	eax, edx
  6276                                  	;;shr	eax, 10	; (L+R/2) & 128 volume levels
  6277                                  	;shr	eax, 9	; (L+R/2) & 256 volume levels
  6278                                  	; 30/12/2024
  6279 00002876 C1E80B                  	shr	eax, 11	; (L+R/2) & 64 volume levels
  6280                                  	; * 320 row  ; 30/12/2024
  6281 00002879 F7E5                    	mul	ebp	; * 640 (row) 
  6282 0000287B 01D8                    	add	eax, ebx ; + column
  6283 0000287D 8A15[F3310000]          	mov	dl, [ccolor]
  6284 00002883 8810                    	mov	[eax], dl ; pixel (light on) color
  6285 00002885 AB                      	stosd		; save light on addr in prev_points
  6286 00002886 43                      	inc	ebx
  6287 00002887 E2DD                    	loop	lights_on_4
  6288 00002889 C3                      	retn
  6289                                  
  6290                                  ; --------------------------------------------------------
  6291                                  ; 19/05/2024 - (playwav4.asm) ich_wav4.asm
  6292                                  ; --------------------------------------------------------
  6293                                  
  6294                                  	; 29/12/2024
  6295                                  	; 25/12/2024
  6296                                  	; 07/12/2024
  6297                                  	; 01/12/2024 (TRDOS 386)
  6298                                  	; 29/11/2024
  6299                                  check4keyboardstop:
  6300                                  	; 19/05/2024
  6301                                  	; 08/11/2023
  6302                                  	; 04/11/2023
  6303 0000288A B401                    	mov	ah, 1
  6304                                  	;int	16h
  6305                                  	; 01/12/2024 (TRDOS 386 keyboard interrupt)
  6306 0000288C CD32                    	int	32h
  6307                                  	;clc
  6308 0000288E 7433                    	jz	short _cksr
  6309                                  
  6310 00002890 30E4                    	xor	ah, ah
  6311                                  	;int	16h
  6312                                  	; 01/12/2024 (TRDOS 386 keyboard interrupt)
  6313 00002892 CD32                    	int	32h
  6314                                  
  6315                                  	; 25/12/2024
  6316                                  	; 29/11/2024
  6317                                  	;mov	[command], al
  6318                                  
  6319                                  	;;;
  6320                                  	; 19/05/2024 (change PCM out volume)
  6321 00002894 3C2B                    	cmp	al, '+'
  6322 00002896 750D                    	jne	short p_1
  6323                                  	
  6324 00002898 A0[ED280000]            	mov	al, [volume]
  6325 0000289D 3C00                    	cmp	al, 0
  6326 0000289F 7624                    	jna	short p_3
  6327 000028A1 FEC8                    	dec	al
  6328 000028A3 EB0F                    	jmp	short p_2
  6329                                  p_1:
  6330 000028A5 3C2D                    	cmp	al, '-'
  6331 000028A7 751D                    	jne	short p_4
  6332                                  
  6333 000028A9 A0[ED280000]            	mov	al, [volume]
  6334 000028AE 3C1F                    	cmp	al, 31
  6335 000028B0 7313                    	jnb	short p_3
  6336 000028B2 FEC0                    	inc	al
  6337                                  p_2:
  6338 000028B4 A2[ED280000]            	mov	[volume], al
  6339                                  	; 29/12/2024
  6340                                  	; 14/11/2024
  6341 000028B9 E8B0DEFFFF              	call	SetPCMOutVolume
  6342                                  	; 15/11/2024 (QEMU)
  6343                                  	; 07/12/2024
  6344                                  	;call	SetMasterVolume
  6345                                  	;call	UpdateVolume
  6346                                  	;;clc
  6347                                  	;retn
  6348 000028BE E97C010000              	jmp	UpdateVolume
  6349                                  	;mov	ah, al
  6350                                  	;mov    dx, [NAMBAR]
  6351                                    	;;add   dx, CODEC_MASTER_VOL_REG
  6352                                  	;add	dx, CODEC_PCM_OUT_REG
  6353                                  	;out    dx, ax
  6354                                  	;
  6355                                  	;call   delay1_4ms
  6356                                          ;call   delay1_4ms
  6357                                          ;call   delay1_4ms
  6358                                          ;call   delay1_4ms
  6359                                  _cksr:		; 19/05/2024
  6360                                  	; 18/12/2024
  6361 000028C3 31C0                    	xor	eax, eax
  6362                                  	;clc
  6363                                  p_3:
  6364 000028C5 C3                      	retn
  6365                                  p_4:
  6366                                  	; 17/11/2024
  6367 000028C6 80FC01                  	cmp	ah, 01h  ; ESC
  6368 000028C9 7419                        	je	short p_q
  6369                                  	;cmp	ax, 2E03h ; 21/12/2024 
  6370 000028CB 3C03                    	cmp	al, 03h  ; CTRL+C
  6371 000028CD 7415                    	je	short p_q
  6372                                  
  6373                                  	; 18/11/2024
  6374 000028CF 3C20                    	cmp	al, 20h
  6375 000028D1 7419                    	je	short p_r
  6376                                  
  6377                                  	; 19/11/2024
  6378 000028D3 3C0D                    	cmp	al, 0Dh ; CR/ENTER
  6379 000028D5 7415                    	je	short p_r
  6380                                  
  6381 000028D7 24DF                    	and	al, 0DFh
  6382                                  
  6383                                  	; 25/12/2024
  6384                                  	; 29/11/2024
  6385 000028D9 A2[16370000]            	mov	[command], al
  6386                                  
  6387                                  	;cmp	al, 'B'
  6388                                  	;je	short p_r
  6389                                  	;cmp	al, 'F'
  6390                                  	;je	short p_r
  6391                                  
  6392                                  	; 29/11/2024
  6393                                  	;cmp	al, 'N'
  6394                                  	;je	short p_r
  6395                                  	;cmp	al, 'P'
  6396                                  	;je	short p_r
  6397                                  
  6398 000028DE 3C51                    	cmp	al, 'Q'
  6399                                  	;je	short p_q
  6400 000028E0 7409                    	je	short p_quit ; 29/11/2024
  6401                                  
  6402 000028E2 F8                      	clc
  6403 000028E3 C3                      	retn
  6404                                  
  6405                                  	;;;
  6406                                  ;_cskr:	
  6407                                  p_q:
  6408                                  	; 27/12/2024
  6409 000028E4 C605[16370000]51        	mov	byte [command], 'Q'
  6410                                  p_quit:
  6411 000028EB F9                      	stc
  6412                                  p_r:
  6413 000028EC C3                      	retn
  6414                                  
  6415                                  ; 29/05/2024
  6416                                  ; 19/05/2024
  6417                                  volume: 
  6418                                  	;db	02h
  6419                                  ; 26/12/2024
  6420 000028ED 03                      	db	03h
  6421                                  
  6422                                  ; --------------------------------------------------------
  6423                                  
  6424                                  	; 31/12/2024 (int31h)
  6425                                  	; 30/12/2024
  6426                                  	; simulate cursor position in VGA mode 13h
  6427                                  	; ! for 320*200, 256 colors (1 byte/pixel) !
  6428                                  setCursorPosition:
  6429                                  	; dh = Row
  6430                                  	; dl = Column
  6431                                  
  6432                                  	; 31/12/2024
  6433 000028EE B700                    	mov	bh, 0
  6434 000028F0 B402                    	mov	ah, 02h
  6435                                  	;int	10h
  6436 000028F2 CD31                    	int	31h
  6437 000028F4 C3                      	retn
  6438                                  
  6439                                  ; 31/12/2024
  6440                                  %if 0
  6441                                  	xor	eax, eax
  6442                                  	; row height is 8 pixels (8*8)
  6443                                  	mov	al, dh
  6444                                  	shl	eax, 3
  6445                                  	add	ax, 2	; top margin
  6446                                  	shl	eax, 16
  6447                                  	mov	al, dl	; * 8 ; character width = 8 pixels
  6448                                  	shl	ax, 3
  6449                                  			; hw = row, ax = column
  6450                                  	mov	[screenpos], eax
  6451                                  	; 22/12/2024
  6452                                  	xor	eax, eax
  6453                                  	retn
  6454                                  %endif
  6455                                  	
  6456                                  ; --------------------------------------------------------
  6457                                  ; 14/11/2024
  6458                                  ; (Ref: player.asm, out_cs.asm, Matan Alfasi, 2017)
  6459                                  
  6460                                  ;; NAME:	SetTotalTime
  6461                                  ;; DESCRIPTION: Calculates the total time in seconds in file
  6462                                  ;; INPUT:	DATA_SubchunkSize, WAVE_SampleRate, WAVE_BlockAlign
  6463                                  ;; OUTPUT:	CurrentTotalTime=Total time in seconds in file,
  6464                                  ;; 		Output on the screen of the total time in seconds
  6465                                  
  6466                                  	; 01/12/2024 (32 bit registers)
  6467                                  SetTotalTime:
  6468                                  	;; Calculate total seconds in file
  6469                                  	;mov	ax, [DATA_SubchunkSize]
  6470                                  	;mov	dx, [DATA_SubchunkSize + 2]
  6471                                  	;mov	bx, [WAVE_SampleRate]
  6472                                  	;div	bx
  6473                                  	;xor	dx, dx
  6474                                  	; 01/12/2024
  6475 000028F5 A1[40370000]            	mov	eax, [DATA_SubchunkSize]
  6476 000028FA 0FB71D[30370000]        	movzx	ebx, word [WAVE_SampleRate]
  6477 00002901 31D2                    	xor	edx, edx
  6478 00002903 F7F3                    	div	ebx
  6479                                  
  6480                                  	;mov	bx, [WAVE_BlockAlign]
  6481                                  	;div	bx
  6482                                  	; 01/12/2024
  6483 00002905 668B1D[38370000]        	mov	bx, [WAVE_BlockAlign]
  6484 0000290C 31D2                    	xor	edx, edx
  6485 0000290E F7F3                    	div	ebx
  6486                                  
  6487                                  	;mov	[TotalTime], ax
  6488 00002910 A3[C4370000]            	mov	[TotalTime], eax
  6489                                  
  6490 00002915 B33C                    	mov	bl, 60
  6491 00002917 F6F3                    	div	bl
  6492                                  
  6493                                  	;; al = minutes, ah = seconds
  6494 00002919 50                      	push	eax ; **
  6495 0000291A 50                      	push	eax ; *
  6496                                  
  6497                                  	;mov	dh, 24
  6498                                  	; 21/12/2024 (640*480)
  6499                                  	;mov	dh, 32
  6500                                  	;mov	dl, 42
  6501                                  	; 30/12/2024 (320*200)
  6502 0000291B B617                    	mov	dh, 23
  6503 0000291D B216                    	mov	dl, 22
  6504 0000291F E8CAFFFFFF              	call	setCursorPosition
  6505                                  
  6506 00002924 58                      	pop	eax ; *
  6507 00002925 30E4                    	xor	ah, ah
  6508 00002927 BD02000000              	mov	ebp, 2
  6509 0000292C E812000000              	call	PrintNumber
  6510                                  	
  6511                                  	;mov	dh, 24
  6512                                  	; 21/12/2024 (640*480)
  6513                                  	;mov	dh, 32
  6514                                  	;mov	dl, 45
  6515                                  	; 30/12/2024 (320*200)
  6516 00002931 B617                    	mov	dh, 23
  6517 00002933 B219                    	mov	dl, 25
  6518 00002935 E8B4FFFFFF              	call	setCursorPosition
  6519                                  
  6520 0000293A 58                      	pop	eax ; **
  6521 0000293B 88E0                    	mov	al, ah
  6522 0000293D 30E4                    	xor	ah, ah
  6523                                  	; 21/12/2024
  6524 0000293F 66BD0200                	mov	bp, 2
  6525                                  	;jmp	short PrintNumber
  6526                                  
  6527                                  ; --------------------------------------------------------
  6528                                  
  6529                                  	; 31/12/2024 (int 31h)
  6530                                  	; 21/12/2024 (write numbers in VESA VBE graphics mode)
  6531                                  	; 01/12/2024 (32bit registers)
  6532                                  PrintNumber:
  6533                                  	; eax = binary number
  6534                                  	; ebp = digits
  6535                                  	;mov	esi, [screenpos]
  6536                                  		; hw = row, si = column
  6537 00002943 BB0A000000              	mov	ebx, 10
  6538 00002948 31C9                    	xor	ecx, ecx
  6539                                  printNumber_CutNumber:
  6540 0000294A 41                      	inc	ecx
  6541 0000294B 31D2                    	xor	edx, edx
  6542 0000294D F7F3                    	div	ebx
  6543 0000294F 52                      	push	edx
  6544 00002950 39E9                    	cmp	ecx, ebp
  6545 00002952 7402                    	je	short printNumber_printloop
  6546 00002954 EBF4                    	jmp	printNumber_CutNumber
  6547                                  
  6548                                  printNumber_printloop:
  6549 00002956 58                      	pop	eax
  6550                                  	; 21/12/2024
  6551                                  	; ebp = count of digits
  6552                                  	; eax <= 9
  6553                                  
  6554 00002957 0430                    	add	al, '0'
  6555                                  	
  6556                                  	; esi = pixel position (hw = row, si = column)
  6557                                  	; eax = al = character
  6558                                  	;call	write_character
  6559                                  	; 22/12/2024
  6560 00002959 E817010000              	call	write_character_white
  6561                                  
  6562 0000295E 4D                      	dec	ebp
  6563 0000295F 7402                     	jz	short printNumber_ok
  6564                                  	;add	esi, 8	; next column
  6565 00002961 EBF3                    	jmp	short printNumber_printloop
  6566                                  printNumber_ok:
  6567 00002963 C3                      	retn
  6568                                  
  6569                                  ; --------------------------------------------------------
  6570                                  
  6571                                  	; 14/11/2024 - Erdogan Tan
  6572                                  SetProgressTime:
  6573                                  	;; Calculate playing/progress seconds in file
  6574 00002964 E835000000              	call	CalcProgressTime
  6575                                  
  6576                                  	; 01/12/2024 (32bit registers)
  6577                                  UpdateProgressTime:
  6578                                  	; eax = (new) progress time 
  6579                                  
  6580 00002969 A3[C8370000]            	mov	[ProgressTime], eax
  6581                                  
  6582 0000296E B33C                    	mov	bl, 60
  6583 00002970 F6F3                    	div	bl
  6584                                  
  6585                                  	;; al = minutes, ah = seconds
  6586 00002972 50                      	push	eax ; **
  6587 00002973 50                      	push	eax ; *
  6588                                  
  6589                                  	;mov	dh, 24
  6590                                  	; 21/12/2024 (640*480)
  6591                                  	;mov	dh, 32
  6592                                  	;mov	dl, 33
  6593                                  	; 30/12/2024 (320*200)
  6594 00002974 B617                    	mov	dh, 23
  6595 00002976 B20D                    	mov	dl, 13
  6596 00002978 E871FFFFFF              	call	setCursorPosition
  6597                                  
  6598 0000297D 58                      	pop	eax ; *
  6599 0000297E 30E4                    	xor	ah, ah
  6600 00002980 BD02000000              	mov	ebp, 2
  6601 00002985 E8B9FFFFFF              	call	PrintNumber
  6602                                  	
  6603                                  	;mov	dh, 24
  6604                                  	; 21/12/2024 (640*480)
  6605                                  	;mov	dh, 32
  6606                                  	;mov	dl, 36
  6607                                  	; 30/12/2024 (320*200)
  6608 0000298A B617                    	mov	dh, 23
  6609 0000298C B210                    	mov	dl, 16
  6610 0000298E E85BFFFFFF              	call	setCursorPosition
  6611                                  
  6612 00002993 58                      	pop	eax ; **
  6613 00002994 88E0                    	mov	al, ah
  6614 00002996 30E4                    	xor	ah, ah
  6615                                  	; 21/12/2024
  6616 00002998 66BD0200                	mov	bp, 2
  6617 0000299C EBA5                    	jmp	short PrintNumber
  6618                                  
  6619                                  ; --------------------------------------------------------
  6620                                  
  6621                                  	; 01/12/2024 (32bit registers)
  6622                                  	; 17/11/2024
  6623                                  	; 14/11/2024
  6624                                  CalcProgressTime:
  6625                                  	;mov	ax, [LoadedDataBytes]
  6626                                  	;mov	dx, [LoadedDataBytes+2]
  6627                                  	;mov	bx, ax
  6628                                  	;or	bx, dx
  6629                                  	;jz	short cpt_ok
  6630                                  	; 01/12/2024
  6631 0000299E A1[D0370000]            	mov	eax, [LoadedDataBytes]
  6632 000029A3 09C0                    	or	eax, eax
  6633 000029A5 7416                    	jz	short cpt_ok
  6634                                  
  6635                                  	;mov	bx, [WAVE_SampleRate]
  6636                                  	;div	bx
  6637                                  	;xor	dx, dx
  6638                                  	;mov	bx, [WAVE_BlockAlign]
  6639                                  	;div	bx
  6640                                  	; 01/12/2024
  6641 000029A7 0FB71D[30370000]        	movzx	ebx, word [WAVE_SampleRate]
  6642 000029AE 31D2                    	xor	edx, edx
  6643 000029B0 F7F3                    	div	ebx
  6644 000029B2 31D2                    	xor	edx, edx
  6645 000029B4 668B1D[38370000]        	mov	bx, [WAVE_BlockAlign]
  6646 000029BB F7F3                    	div	ebx
  6647                                  cpt_ok:
  6648                                  	; eax = (new) progress time
  6649 000029BD C3                      	retn
  6650                                  
  6651                                  ; --------------------------------------------------------
  6652                                  ; 14/11/2024
  6653                                  ; (Ref: player.asm, out_cs.asm, Matan Alfasi, 2017)
  6654                                  
  6655                                  ;; DESCRIPTION: Update file information on template
  6656                                  ;; PARAMS:	WAVE parameters and other variables
  6657                                  ;; REGS:	AX(RW)
  6658                                  ;; VARS:	CurrentFileName, WAVE_SampleRate, 
  6659                                  ;; RETURNS:	On-screen file info is updated.
  6660                                  
  6661                                  	; 01/12/2024 (32bit registers)
  6662                                  UpdateFileInfo:
  6663                                  	;; Print File Name
  6664                                  	;mov	dh, 9
  6665                                  	; 21/12/2024 (640*480 graphics display)
  6666                                  	;mov	dh, 8
  6667                                  	;mov	dl, 23
  6668                                  	; 30/12/2024 (320*200, video mode 13h)
  6669 000029BE B607                    	mov	dh, 7
  6670 000029C0 B208                    	mov	dl, 8
  6671 000029C2 E827FFFFFF              	call	setCursorPosition
  6672                                  	
  6673 000029C7 BE[58370000]            	mov	esi, wav_file_name
  6674                                  	
  6675                                  	;;;
  6676                                  	; 14/11/2024
  6677                                  	; skip directory separators
  6678                                  	; (note: asciiz string, max. 79 bytes except zero tail)
  6679 000029CC 89F3                    	mov	ebx, esi
  6680                                  chk4_nxt_sep:
  6681 000029CE AC                      	lodsb
  6682 000029CF 3C2F                    	cmp	al, '/'	; 14/12/2024
  6683 000029D1 7406                    	je	short chg_fpos
  6684 000029D3 20C0                    	and	al, al
  6685 000029D5 7406                    	jz	short chg_fpos_ok
  6686 000029D7 EBF5                    	jmp	short chk4_nxt_sep
  6687                                  chg_fpos:
  6688 000029D9 89F3                    	mov	ebx, esi
  6689 000029DB EBF1                    	jmp	short chk4_nxt_sep
  6690                                  chg_fpos_ok:
  6691 000029DD 89DE                    	mov	esi, ebx ; file name (without its path/directory)
  6692                                  	;;;
  6693                                  _fnl_chk:
  6694                                  	; 30/12/2024 (cgaplay.s)
  6695                                  	; ????????.wav
  6696                                  	; 26/12/2024 (file name length limit -display-)
  6697 000029DF BB0C000000              	mov	ebx, 12
  6698                                  	;mov	ebx, 17 ; ????????.wav?????
  6699 000029E4 56                      	push	esi
  6700                                  _fnl_chk_loop:
  6701 000029E5 AC                      	lodsb
  6702 000029E6 20C0                    	and	al, al
  6703 000029E8 7406                    	jz	short _fnl_ok
  6704 000029EA 4B                       	dec	ebx
  6705 000029EB 75F8                    	jnz	short _fnl_chk_loop
  6706 000029ED C60600                  	mov	byte [esi], 0
  6707                                  _fnl_ok:
  6708 000029F0 5E                      	pop	esi
  6709                                  	;;;
  6710                                  
  6711 000029F1 E870000000              	call	PrintString
  6712                                  	
  6713                                  	;; Print Frequency
  6714                                  	;mov	dh, 10
  6715                                  	; 21/12/2024 (640*480 graphics display)
  6716                                  	;mov	dh, 9
  6717                                  	;mov	dl, 23
  6718                                  	; 30/12/2024 (320*200, video mode 13h)
  6719 000029F6 B608                    	mov	dh, 8
  6720 000029F8 B208                    	mov	dl, 8
  6721 000029FA E8EFFEFFFF              	call	setCursorPosition
  6722                                  	;movzx	eax, word [WAVE_SampleRate]
  6723                                  	; 22/12/2024
  6724                                  	; eax = 0
  6725 000029FF 66A1[30370000]          	mov	ax, [WAVE_SampleRate]
  6726 00002A05 BD05000000              	mov	ebp, 5
  6727 00002A0A E834FFFFFF              	call	PrintNumber
  6728                                  
  6729                                  	;; Print BitRate
  6730                                  	;mov	dh, 9
  6731                                  	; 21/12/2024 (640*480 graphics display)
  6732                                  	;mov	dh, 8
  6733                                  	;mov	dl, 57
  6734                                  	; 30/12/2024 (320*200, video mode 13h)
  6735 00002A0F B607                    	mov	dh, 7
  6736 00002A11 B21F                    	mov	dl, 31
  6737 00002A13 E8D6FEFFFF              	call	setCursorPosition
  6738 00002A18 66A1[3A370000]          	mov	ax, [WAVE_BitsPerSample]
  6739 00002A1E 66BD0200                	mov	bp, 2
  6740 00002A22 E81CFFFFFF              	call	PrintNumber
  6741                                  
  6742                                  	;; Print Channel Number
  6743                                  	;mov	dh, 10
  6744                                  	; 21/12/2024 (640*480 graphics display)
  6745                                  	;mov	dh, 9
  6746                                  	;mov	dl, 57
  6747                                  	; 30/12/2024 (320*200, video mode 13h)
  6748 00002A27 B608                    	mov	dh, 8
  6749 00002A29 B21F                    	mov	dl, 31
  6750 00002A2B E8BEFEFFFF              	call	setCursorPosition
  6751 00002A30 66A1[2E370000]          	mov	ax, [WAVE_NumChannels]
  6752 00002A36 66BD0100                	mov	bp, 1
  6753 00002A3A E804FFFFFF              	call	PrintNumber
  6754                                  
  6755                                  	;call	UpdateVolume
  6756                                  	;retn
  6757                                  
  6758                                  ; --------------------------------------------------------
  6759                                  
  6760                                  	; 14/11/2024
  6761                                  UpdateVolume:
  6762                                  	;; Print Volume
  6763                                  	;mov	dh, 24
  6764                                  	; 21/12/2024 (640*480)
  6765                                  	;mov	dh, 32
  6766                                  	;mov	dl, 75
  6767                                  	; 30/12/2024 (320*200, video mode 13h)
  6768 00002A3F B617                    	mov	dh, 23
  6769 00002A41 B223                    	mov	dl, 35
  6770 00002A43 E8A6FEFFFF              	call	setCursorPosition
  6771                                  	; 22/12/2024
  6772                                  	; eax = 0
  6773                                  
  6774 00002A48 A0[ED280000]            	mov	al, [volume]
  6775                                  
  6776 00002A4D B364                    	mov	bl, 100
  6777 00002A4F F6E3                    	mul	bl
  6778                                  
  6779 00002A51 B31F                    	mov	bl, 31
  6780 00002A53 F6F3                    	div	bl
  6781                                  
  6782                                  	;neg	ax
  6783                                  	;add	ax, 100	
  6784                                  	; 01/12/2024
  6785 00002A55 B464                    	mov	ah, 100
  6786 00002A57 28C4                    	sub	ah, al
  6787 00002A59 0FB6C4                  	movzx	eax, ah
  6788                                  	;xor	ah, ah
  6789                                  	;mov	bp, 3
  6790 00002A5C BD03000000              	mov	ebp, 3
  6791                                  	;call	PrintNumber
  6792                                  	;retn
  6793 00002A61 E9DDFEFFFF              	jmp	PrintNumber	
  6794                                  
  6795                                  ; --------------------------------------------------------
  6796                                  
  6797                                  	; 31/12/2024 (int 31h)
  6798                                  	; 21/12/2024
  6799                                  	; write text in VESA VBE graphics mode
  6800                                  PrintString:
  6801                                  	; esi = string address
  6802                                  printstr_loop:
  6803 00002A66 31C0                    	xor	eax, eax
  6804 00002A68 AC                      	lodsb
  6805 00002A69 08C0                    	or	al, al
  6806 00002A6B 7407                    	jz	short printstr_ok
  6807                                  
  6808                                  	;push	esi
  6809                                  
  6810                                  	;mov	esi, [screenpos]
  6811                                  
  6812                                  	; esi = pixel position (hw = row, si = column)
  6813                                  	; eax = al = character
  6814                                  	;call	write_character
  6815                                  	; 22/12/2024
  6816 00002A6D E803000000              	call	write_character_white
  6817                                  
  6818                                  	; 31/12/2024
  6819                                  	;add	word [screenpos], 8 ; update column (only, not row)
  6820                                  
  6821                                  	;pop	esi
  6822 00002A72 EBF2                    	jmp	short printstr_loop
  6823                                  
  6824                                  printstr_ok:
  6825 00002A74 C3                      	retn
  6826                                  
  6827                                  ; --------------------------------------------------------
  6828                                  
  6829                                  	; 31/12/2024 (int 31h)
  6830                                  	; 30/12/2024
  6831                                  	; write character (at cursor position)
  6832                                  	; in video mode 13h (320*200, 256 colors)
  6833                                  	; 21/12/2024
  6834                                  	; write character (at cursor position)
  6835                                  	; in graphics mode (640*480, 256 colors)
  6836                                  	; 22/12/2024
  6837                                  write_character_white:
  6838 00002A75 B90F000000              	mov	ecx, 0Fh
  6839                                  	; 26/12/2024
  6840                                  	;movzx	ecx, byte [tcolor]
  6841                                  write_character:
  6842                                  	; esi = pixel position (hw = row, si = column)
  6843                                  	; eax = al = character
  6844                                  	; cl = color
  6845 00002A7A 890D[FC310000]          	mov	[wcolor], ecx ; 22/12/2024
  6846                                  
  6847                                  ; 31/12/2024
  6848                                  %if 0
  6849                                  	; 30/12/2024
  6850                                  	; 22/12/2024
  6851                                  	push	eax
  6852                                  	; clear previous character pixels
  6853                                  	mov	edi, fillblock
  6854                                  	;;sys	_video, 020Fh, 0, 8001h
  6855                                  	; 30/12/2024
  6856                                  	sys	_video, 010Fh, 0, 8000h ; 8*8 userfont
  6857                                  	pop	eax
  6858                                  
  6859                                  	; 30/12/2024
  6860                                  	;shl	eax, 4 ; 8*16 pixel user font
  6861                                  	;mov	edi, fontbuff2 ; start of user font data
  6862                                  	;add	edi, eax
  6863                                  
  6864                                  	; 21/12/2024
  6865                                  	; NOTE:
  6866                                  	; TRDOS 386 does not use 8*14 pixel fonts in sysvideo
  6867                                  	; system calls -in graphics mode-
  6868                                  	; because 8*16 pixel operations are faster
  6869                                  	;			than 8*14 pixel operations.
  6870                                  	; ((so, 8*14 fonts can be converted to 8*16 fonts by
  6871                                  	; adding 2 empty lines))
  6872                                  	; (8*14 characters can be written via pixel operations)
  6873                                    	
  6874                                  	; 21/12/2024 (TRDOS 386 v2.0.9, trdosk6.s, 27/09/2024)
  6875                                  	;;;;;;;;;;;;;;;;; ; sysvideo system call
  6876                                  	;sysvideo:
  6877                                  	;   function in BH
  6878                                  	;	02h: Super VGA, LINEAR FRAME BUFFER data transfers
  6879                                  	;   sub function in BL
  6880                                  	;	0Fh: WRITE CHARACTER (FONT)
  6881                                  	;          CL = char's color (8 bit, 256 colors)
  6882                                  	;	If DH bit 7 = 1
  6883                                  	;	   USER FONT (from user buffer)
  6884                                  	;	         DL = 1 -> 8x16 pixel font
  6885                                   	;	   EDI = user's font buffer address
  6886                                  	;		(NOTE: byte order is as row0,row1,row2..)
  6887                                  	;	   ESI = start position (row, column)
  6888                                  	;		(HW = row, SI = column)
  6889                                  	;;;;;;;;;;;;;;;;;
  6890                                  
  6891                                  	;sys	_video, 020Fh, [wcolor], 8001h
  6892                                  
  6893                                  	; 30/12/2024
  6894                                  	; sysvideo system call
  6895                                  	; BH = 01h = VGA graphics (0A0000h) data transfers
  6896                                  	; BL = 0Fh = write character/font
  6897                                  	; DH = 01h = 8*8 system font 
  6898                                  	; CL = [wcolor] = color
  6899                                  	; ESI = cursor/writing position (pixels)
  6900                                  	;	HW = row, SI = column
  6901                                  	; DL = character (ASCII code)
  6902                                  
  6903                                  	mov	ah, 01h ; 8*8 pixels
  6904                                  
  6905                                  	sys	_video, 010Fh, [wcolor], eax
  6906                                  %endif
  6907                                  
  6908                                  	; 31/12/2024
  6909 00002A80 0FB6D9                  	movzx	ebx, cl ; bl = foreground color
  6910                                  	; al = character (ASCII code)
  6911 00002A83 B40E                    	mov	ah, 0Eh
  6912                                  	;int	10h
  6913 00002A85 CD31                    	int	31h
  6914 00002A87 C3                      	retn
  6915                                  
  6916                                  ; --------------------------------------------------------
  6917                                  
  6918                                  	; 30/12/2024
  6919                                  	; write characters in video mode 13h
  6920                                  	; (320*200 pixels, 256 colors)
  6921                                  	; 22/12/2024
  6922                                  	; 21/12/2024
  6923                                  	; (write chars in VESA VBE graphics mode)
  6924                                  	; 14/11/2024
  6925                                  	; (Ref: player.asm, Matan Alfasi, 2017)
  6926                                  	; (Modification: Erdogan Tan, 14/11/2024)
  6927                                  
  6928                                  	;PROGRESSBAR_ROW equ 23
  6929                                  	; 21/12/2024 (640*480)
  6930                                  	;PROGRESSBAR_ROW equ 31
  6931                                  	; 30/12/2024 (320*200)
  6932                                  	PROGRESSBAR_ROW equ 22
  6933                                  
  6934                                  UpdateProgressBar:
  6935 00002A88 E8D7FEFFFF              	call	SetProgressTime	; 14/11/2024
  6936                                  
  6937                                  	; 01/12/2024 (32bit registers)
  6938 00002A8D A1[C8370000]            	mov	eax, [ProgressTime]
  6939                                  UpdateProgressBar@:
  6940                                  	;mov	edx, 80
  6941                                  	; 30/12/2024
  6942 00002A92 BA28000000              	mov	edx, 40 ; 320*200 pixels, 40 columns 
  6943 00002A97 F7E2                    	mul	edx
  6944 00002A99 8B1D[C4370000]          	mov	ebx, [TotalTime]
  6945 00002A9F F7F3                    	div	ebx
  6946                                  
  6947                                  	; 22/12/2024
  6948                                  	; check progress bar indicator position if it is same 
  6949 00002AA1 3A05[01320000]          	cmp	al, [pbprev]
  6950 00002AA7 7427                    	je	short UpdateProgressBar_ok
  6951 00002AA9 A2[01320000]            	mov	[pbprev], al
  6952                                  
  6953                                  UpdateProgressBar@@:
  6954                                  	;; Push for the 'Clean' part
  6955 00002AAE 50                      	push	eax ; **
  6956 00002AAF 50                      	push	eax ; *
  6957                                  
  6958                                  	;; Set cursor position
  6959 00002AB0 B616                    	mov	dh, PROGRESSBAR_ROW
  6960 00002AB2 B200                    	mov	dl, 0
  6961 00002AB4 E835FEFFFF              	call	setCursorPosition
  6962                                  
  6963 00002AB9 58                      	pop	eax ; *
  6964 00002ABA 09C0                    	or	eax, eax
  6965 00002ABC 7426                    	jz	short UpdateProgressBar_Clean
  6966                                  
  6967                                  UpdateProgressBar_DrawProgress:
  6968                                  	; 31/12/2024 (int 31h)
  6969                                  	; 22/12/2024
  6970                                  	; 21/12/2024
  6971                                  	; (write progress bar chars in graphics mode)
  6972                                  	;;;;
  6973 00002ABE 89C5                    	mov	ebp, eax
  6974 00002AC0 50                      	push	eax ; ***
  6975                                  	; 31/12/2024
  6976                                  	;mov	esi, [screenpos]
  6977                                  UpdateProgressBar_DrawProgress_@:
  6978 00002AC1 B8DF000000              	mov	eax, 223
  6979                                  	
  6980                                  	; esi = pixel position (hw = row, si = column)
  6981                                  	; eax = al = character
  6982                                  	;call	write_character
  6983                                  	; 22/12/2024
  6984 00002AC6 E8AAFFFFFF              	call	write_character_white
  6985                                  
  6986 00002ACB 4D                      	dec	ebp
  6987 00002ACC 7403                    	jz	short UpdateProgressBar_DrawCursor
  6988                                  
  6989                                  	; 31/12/2024
  6990                                  	;add	esi, 8 ; next column
  6991 00002ACE EBF1                    	jmp	short UpdateProgressBar_DrawProgress_@
  6992                                  	;;;
  6993                                  
  6994                                  UpdateProgressBar_ok:
  6995 00002AD0 C3                      	retn
  6996                                  
  6997                                  UpdateProgressBar_DrawCursor:
  6998                                  	; 22/12/2024
  6999 00002AD1 5A                      	pop	edx ; ***
  7000 00002AD2 B616                    	mov	dh, PROGRESSBAR_ROW
  7001                                  	; 31/12/2024
  7002 00002AD4 FECA                    	dec	dl ; last written position again
  7003 00002AD6 E813FEFFFF              	call	setCursorPosition
  7004                                  
  7005                                  	; 21/12/2024
  7006                                  	; (write progress bar character in graphics mode)
  7007                                  	;;;;
  7008                                  	;;;mov	eax, 223
  7009                                  	;;;shl	eax, 4 ; 8*16 pixel user font
  7010                                  	;;mov	eax, 223*16
  7011                                  	;;mov	edi, fontbuff2 ; start of user font data
  7012                                  	;;add	edi, eax
  7013                                  	;mov	edi, fontbuff2+(223*16)
  7014                                  	;
  7015                                  	;sys	_video, 020Fh, 0Ch, 8001h
  7016                                  	; 22/12/2024
  7017                                  	;mov	eax, 223
  7018                                  	; eax = 0
  7019 00002ADB B0DF                    	mov	al, 223
  7020 00002ADD B10C                    	mov	cl, 0Ch ; red
  7021 00002ADF E896FFFFFF              	call	write_character
  7022                                  	;;;;
  7023                                  
  7024                                  UpdateProgressBar_Clean:
  7025                                  	;pop	eax  ; **
  7026                                  	; 22/12/2024
  7027 00002AE4 5A                      	pop	edx  ; **
  7028                                  	; 30/12/2024
  7029                                  	; 21/12/2024
  7030                                  	;mov	ebp, 80
  7031                                  	; 30/12/2024
  7032 00002AE5 BD28000000              	mov	ebp, 40 ; 40 columns (320*200 pixels)
  7033                                  	;sub	bp, ax
  7034 00002AEA 6629D5                  	sub	bp, dx ; 22/12/2024
  7035                                  	;jz	short UpdateProgressBar_ok
  7036                                  	; 31/12/2024
  7037 00002AED 76E1                    	jna	short UpdateProgressBar_ok
  7038                                  
  7039 00002AEF B616                    	mov	dh, PROGRESSBAR_ROW
  7040                                  	;mov	dl, al ; 22/12/2024
  7041 00002AF1 E8F8FDFFFF              	call	setCursorPosition
  7042                                  
  7043                                  	; 21/12/2024
  7044                                  	; (write progress bar chars in graphics mode)
  7045                                  	;;;;
  7046                                  	; 31/12/2024
  7047                                  	;mov	esi, [screenpos]
  7048                                  UpdateProgressBar_Clean_@:
  7049                                  	;;;mov	eax, 223
  7050                                  	;;;shl	eax, 4 ; 8*16 pixel user font
  7051                                  	;;mov	eax, 223*16
  7052                                  	;mov	edi, fontbuff2 ; start of user font data
  7053                                  	;add	edi, eax
  7054                                  	;mov	edi, fontbuff2+(223*16)
  7055                                  	;
  7056                                  	;sys	_video, 020Fh, 08h, 8001h
  7057                                  	; 22/12/2024
  7058                                  	;mov	eax, 223
  7059                                  	; eax = 0
  7060 00002AF6 B0DF                    	mov	al, 223
  7061 00002AF8 B108                    	mov	cl, 08h ; gray (dark)
  7062 00002AFA E87BFFFFFF              	call	write_character
  7063                                  	;;;;
  7064                                  
  7065 00002AFF 4D                      	dec	ebp
  7066 00002B00 74CE                    	jz	short UpdateProgressBar_ok
  7067                                  
  7068                                  	; 31/12/2024
  7069                                  	;add	esi, 8 ; next column
  7070 00002B02 EBF2                    	jmp	short UpdateProgressBar_Clean_@
  7071                                  	;;;;
  7072                                  
  7073                                  ; --------------------------------------------------------
  7074                                  ; 17/11/2024
  7075                                  
  7076                                  Player_ProcessKey_Backwards:
  7077                                  	;; In order to go backwards 5 seconds:
  7078                                  	;; Update file pointer to the beginning, skip headers
  7079 00002B04 B142                    	mov	cl, 'B'
  7080 00002B06 EB02                    	jmp	short Player_ProcessKey_B_or_F
  7081                                  
  7082                                  Player_ProcessKey_Forwards:
  7083                                  	;; In order to fast-forward 5 seconds, set the file pointer
  7084                                  	;; to CUR_SEEK + 5 * Freq
  7085                                  
  7086 00002B08 B146                    	mov	cl, 'F'
  7087                                  	;jmp	short Player_ProcessKey_B_or_F
  7088                                  
  7089                                  	; 01/12/2024 (32bit regsisters)
  7090                                  Player_ProcessKey_B_or_F:
  7091                                  	; 17/11/2024
  7092                                  	; 04/11/2024
  7093                                  	; (Ref: player.asm, Matan Alfasi, 2017)
  7094                                    
  7095                                  	; 04/11/2024
  7096 00002B0A B805000000              	mov	eax, 5
  7097 00002B0F 0FB71D[38370000]        	movzx	ebx, word [WAVE_BlockAlign]
  7098 00002B16 F7E3                    	mul	ebx
  7099 00002B18 668B1D[30370000]        	mov	bx, [WAVE_SampleRate]
  7100 00002B1F F7E3                    	mul	ebx
  7101                                  	; eax = transfer byte count for 5 seconds
  7102                                  	
  7103                                  	; 17/11/2024
  7104 00002B21 80F942                  	cmp	cl, 'B'
  7105                                  	;mov	bx, [LoadedDataBytes]
  7106                                  	;mov	cx, [LoadedDataBytes+2]
  7107                                  	; 01/12/2024
  7108 00002B24 8B0D[D0370000]          	mov	ecx, [LoadedDataBytes]
  7109 00002B2A 7508                    	jne	short move_forward ; cl = 'F'
  7110                                  move_backward:
  7111                                  	;sub	bx, ax
  7112                                  	;sbb	cx, dx
  7113 00002B2C 29C1                    	sub	ecx, eax
  7114 00002B2E 7316                    	jnc	short move_file_pointer
  7115                                  move_to_beginning:
  7116                                  	;xor	cx, cx ; 0
  7117                                  	;xor	bx, bx ; 0
  7118 00002B30 31C9                    	xor	ecx, ecx
  7119 00002B32 EB12                    	jmp	short move_file_pointer
  7120                                  move_forward: 
  7121                                  	;add	bx, ax
  7122                                  	;adc	cx, dx
  7123 00002B34 01C1                    	add	ecx, eax
  7124 00002B36 7208                    	jc	short move_to_end
  7125                                  	;cmp	cx, [DATA_SubchunkSize+2]
  7126                                  	;ja	short move_to_end
  7127                                  	;jb	short move_file_pointer
  7128                                  	;cmp	bx, [DATA_SubchunkSize]
  7129                                  	;jna	short move_file_pointer
  7130 00002B38 3B0D[40370000]          	cmp	ecx, [DATA_SubchunkSize]
  7131 00002B3E 7606                    	jna	short move_file_pointer
  7132                                  move_to_end:
  7133                                  	;mov	bx, [DATA_SubchunkSize]
  7134                                  	;mov	cx, [DATA_SubchunkSize+2]
  7135 00002B40 8B0D[40370000]          	mov	ecx, [DATA_SubchunkSize]
  7136                                  move_file_pointer:
  7137                                  	;mov	dx, bx    
  7138                                  	;mov	[LoadedDataBytes], dx
  7139                                  	;mov	[LoadedDataBytes+2], cx
  7140 00002B46 890D[D0370000]          	mov	[LoadedDataBytes], ecx
  7141                                  	;add	dx, 44 ; + header
  7142                                  	;adc	cx, 0
  7143 00002B4C 83C12C                  	add	ecx, 44 
  7144                                  
  7145                                  	; seek
  7146                                  	;mov	bx, [filehandle]
  7147                                  	;mov	ax, 4200h
  7148                                  	;int	21h
  7149                                  	; 01/12/2024
  7150 00002B4F 31D2                    	xor	edx, edx ; offset from beginning of the file
  7151                                  	; ecx = offset	
  7152                                  	; ebx = file handle
  7153                                  	; edx = 0
  7154                                  	sys	_seek, [filehandle]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00002B51 8B1D[48370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99                              <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101                              <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00002B57 B813000000          <1>  mov eax, %1
   106                              <1> 
   107 00002B5C CD40                <1>  int 40h
  7155 00002B5E C3                      	retn
  7156                                  
  7157                                  ; --------------------------------------------------------
  7158                                  
  7159                                  	; 30/12/2024 (video mode 13h)
  7160                                  	; (320*200, 256 colors)
  7161                                  	; 25/12/2024
  7162                                  	; 22/12/2024 (VESA VBE mode graphics) 
  7163                                  	; (640*480, 256 colors)
  7164                                  clear_window:
  7165                                  	;mov	edi, [LFB_ADDR]
  7166                                  	; 30/12/2024
  7167                                  	;mov	edi, 0A0000h
  7168                                  	;;add	edi, (13*80*8*14)
  7169                                  	; 25/12/2024
  7170                                  	;;add	edi, 164*640
  7171                                  	;add	edi, 12*8*320
  7172                                  	; 30/12/2024
  7173                                  	;mov	edi, [graphstart] ; 12*8*320
  7174 00002B5F BF80700A00              	mov	edi, 0A0000h+(11*8*320)+(2*320) ; *
  7175                                  				; AC97 info start 
  7176 00002B64 29C0                    	sub	eax, eax
  7177                                  	;;mov	ecx, (16*640*14)/4 ; 16 rows
  7178                                  	;mov	ecx, 64*640 ; 256 volume level points
  7179                                  	; 30/12/2024
  7180                                  	;mov	ecx, (8*8*320)/4 ; 8 rows 
  7181 00002B66 B900190000              	mov	ecx, (10*8*320)/4 ; *
  7182 00002B6B F3AB                    	rep	stosd
  7183                                  	; 24/12/2024
  7184 00002B6D A3[08320000]            	mov	[prev_points], eax ; 0
  7185                                  	;
  7186 00002B72 C3                      	retn
  7187                                  
  7188                                  ; -------------------------------------------------------------
  7189                                  ; ac97.inc (11/11/2023)
  7190                                  ; -------------------------------------------------------------
  7191                                  
  7192                                  ; special characters
  7193                                  LF      EQU 10
  7194                                  CR      EQU 13
  7195                                  
  7196                                  ; PCI stuff
  7197                                  
  7198                                  BIT0  EQU 1
  7199                                  BIT1  EQU 2
  7200                                  BIT2  EQU 4
  7201                                  BIT8  EQU 100h
  7202                                  BIT9  EQU 200h
  7203                                  BIT28 EQU 10000000h
  7204                                  BIT30 EQU 40000000h
  7205                                  BIT31 EQU 80000000h
  7206                                  
  7207                                  BUP		equ	BIT30		; Buffer Underrun Policy.
  7208                                  					; if this buffer is the last buffer
  7209                                  					; in a playback, fill the remaining
  7210                                  					; samples with 0 (silence) or not.
  7211                                  					; It's a good idea to set this to 1
  7212                                  					; for the last buffer in playback,
  7213                                  					; otherwise you're likely to get a lot
  7214                                  					; of noise at the end of the sound.
  7215                                  
  7216                                  RR		equ	BIT1		; reset registers. Nukes all regs
  7217                                                                          ; except bits 4:2 of this register.
  7218                                                                          ; Only set this bit if BIT 0 is 0
  7219                                  RPBM		equ	BIT0		; Run/Pause
  7220                                  					; set this bit to start the codec!
  7221                                  IO_ENA		EQU	BIT0		; i/o decode enable
  7222                                  BM_ENA		EQU	BIT2		; bus master enable
  7223                                  
  7224                                  PCI_INDEX_PORT  EQU     0CF8h
  7225                                  PCI_DATA_PORT   EQU     0CFCh
  7226                                  PCI32           EQU     BIT31           ; bitflag to signal 32bit access
  7227                                  PCI16           EQU     BIT30           ; bitflag for 16bit access
  7228                                  
  7229                                  AC97_INT_LINE	equ	3Ch		; AC97 Interrupt Line register offset
  7230                                  
  7231                                  ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
  7232                                  
  7233                                  INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
  7234                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  7235                                  SIS_VID		equ	1039h
  7236                                  NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
  7237                                  AMD_VID		equ	1022h
  7238                                  
  7239                                  ICH_DID         equ     2415h           ; ICH device ID
  7240                                  ICH0_DID        equ     2425h           ; ICH0
  7241                                  ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
  7242                                                                          ; they all should be compatible.
  7243                                  
  7244                                  ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
  7245                                  ICH3_DID	equ     2485h           ; ICH3
  7246                                  ICH4_DID        equ     24C5h           ; ICH4
  7247                                  ICH5_DID	equ     24D5h           ; ICH5
  7248                                  ICH6_DID	equ     266Eh           ; ICH6
  7249                                  ESB6300_DID	equ     25A6h           ; 6300ESB
  7250                                  ESB631X_DID	equ     2698h           ; 631XESB
  7251                                  ICH7_DID	equ	27DEh		; ICH7
  7252                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  7253                                  MX82440_DID	equ	7195h
  7254                                  SI7012_DID	equ	7012h
  7255                                  NFORCE_DID	equ	01B1h
  7256                                  NFORCE2_DID	equ	006Ah
  7257                                  AMD8111_DID	equ	746Dh
  7258                                  AMD768_DID	equ	7445h
  7259                                  ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
  7260                                  CK804_DID	equ	0059h
  7261                                  MCP04_DID	equ	003Ah
  7262                                  CK8_DID		equ	008Ah
  7263                                  NFORCE3_DID	equ	00DAh
  7264                                  CK8S_DID	equ	00EAh
  7265                                  
  7266                                  NAMBAR_REG	equ	10h		; native audio mixer BAR
  7267                                  NABMBAR_REG	equ	14h		; native audio bus mastering BAR
  7268                                  
  7269                                  CODEC_MASTER_VOL_REG	equ	02h	; master volume
  7270                                  CODEC_MASTER_TONE_REG	equ	08h	; master tone (R+L)
  7271                                  CODEC_PCM_OUT_REG 	equ	18h     ; PCM output volume
  7272                                  CODEC_EXT_AUDIO_REG	equ	28h	; extended audio
  7273                                  CODEC_EXT_AUDIO_CTRL_REG equ	2Ah	; extended audio control
  7274                                  CODEC_PCM_FRONT_DACRATE_REG equ	2Ch	; PCM out sample rate
  7275                                  
  7276                                  ; ICH supports 3 different types of register sets for three types of things
  7277                                  ; it can do, thus:
  7278                                  ;
  7279                                  ; PCM in (for recording) aka PI
  7280                                  ; PCM out (for playback) aka PO
  7281                                  ; MIC in (for recording) aka MC
  7282                                  
  7283                                  PI_BDBAR_REG	equ	0		; PCM in buffer descriptor BAR
  7284                                  PO_BDBAR_REG	equ	10h		; PCM out buffer descriptor BAR
  7285                                  
  7286                                  GLOB_CNT_REG	equ	2Ch		; Global control register
  7287                                  GLOB_STS_REG 	equ	30h		; Global Status register (RO)
  7288                                  
  7289                                  PI_CR_REG 	equ	0Bh		; PCM in Control Register
  7290                                  PO_CR_REG	equ	1Bh		; PCM out Control Register
  7291                                  MC_CR_REG	equ	2Bh		; MIC in Control Register
  7292                                  
  7293                                  PCI_CMD_REG	EQU	04h		; reg 04h, command register
  7294                                  
  7295                                  CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
  7296                                  CODEC_REG_POWERDOWN	equ	26h
  7297                                  
  7298                                  PO_CIV_REG	equ	14h		; PCM out current Index value (RO)
  7299                                  PO_LVI_REG	equ	15h		; PCM out Last Valid Index
  7300                                  PO_SR_REG	equ	16h		; PCM out Status register
  7301                                  
  7302                                  ; -------------------------------------------------------------
  7303                                  
  7304                                  ; 22/12/2024
  7305 00002B73 90                      align 4
  7306                                  
  7307                                  ; 13/11/2024
  7308                                  ; ('<<' to 'shl' conversion for FASM)
  7309                                  ;
  7310                                  ; 29/05/2024 (TRDOS 386)
  7311                                  ; 17/02/2017
  7312                                  ; Valid ICH device IDs
  7313                                  
  7314                                  valid_ids:
  7315                                  	;dd (ICH_DID shl 16) + INTEL_VID	; 8086h:2415h
  7316 00002B74 86801524                	dd (ICH_DID << 16) + INTEL_VID		; 8086h:2415h
  7317 00002B78 86802524                	dd (ICH0_DID << 16) + INTEL_VID		; 8086h:2425h
  7318 00002B7C 86804524                	dd (ICH2_DID << 16) + INTEL_VID		; 8086h:2445h
  7319 00002B80 86808524                	dd (ICH3_DID << 16) + INTEL_VID		; 8086h:2485h
  7320 00002B84 8680C524                	dd (ICH4_DID << 16) + INTEL_VID		; 8086h:24C5h
  7321 00002B88 8680D524                	dd (ICH5_DID << 16) + INTEL_VID		; 8086h:24D5h
  7322 00002B8C 86806E26                	dd (ICH6_DID << 16) + INTEL_VID		; 8086h:266Eh
  7323 00002B90 8680A625                	dd (ESB6300_DID << 16) + INTEL_VID	; 8086h:25A6h
  7324 00002B94 86809826                	dd (ESB631X_DID << 16) + INTEL_VID	; 8086h:2698h
  7325 00002B98 8680DE27                	dd (ICH7_DID << 16) + INTEL_VID		; 8086h:27DEh
  7326                                  	; 03/11/2023 - Erdogan Tan
  7327 00002B9C 86809571                	dd (MX82440_DID << 16) + INTEL_VID	; 8086h:7195h
  7328 00002BA0 39101270                	dd (SI7012_DID << 16)  + SIS_VID	; 1039h:7012h
  7329 00002BA4 DE10B101                	dd (NFORCE_DID << 16)  + NVIDIA_VID	; 10DEh:01B1h
  7330 00002BA8 DE106A00                	dd (NFORCE2_DID << 16) + NVIDIA_VID	; 10DEh:006Ah
  7331 00002BAC 22106D74                	dd (AMD8111_DID << 16) + AMD_VID	; 1022h:746Dh
  7332 00002BB0 22104574                	dd (AMD768_DID << 16)  + AMD_VID	; 1022h:7445h
  7333 00002BB4 DE105900                	dd (CK804_DID << 16) + NVIDIA_VID	; 10DEh:0059h
  7334 00002BB8 DE103A00                	dd (MCP04_DID << 16) + NVIDIA_VID	; 10DEh:003Ah
  7335 00002BBC DE108A00                	dd (CK8_DID << 16) + NVIDIA_VID		; 1022h:008Ah
  7336 00002BC0 DE10DA00                	dd (NFORCE3_DID << 16) + NVIDIA_VID	; 10DEh:00DAh
  7337 00002BC4 DE10EA00                	dd (CK8S_DID << 16) + NVIDIA_VID	; 10DEh:00EAh
  7338                                  
  7339                                  valid_id_count equ (($ - valid_ids)>>2)	; 05/11/2023
  7340                                  ; 13/11/2024
  7341                                  ;valid_id_count = ($ - valid_ids) shr 2	; 05/11/2023
  7342                                  
  7343 00002BC8 00000000                	dd 0
  7344                                  
  7345                                  Credits:
  7346 00002BCC 564741205741562050-     	db 'VGA WAV Player for TRDOS 386 by Erdogan Tan. '
  7346 00002BD5 6C6179657220666F72-
  7346 00002BDE 205452444F53203338-
  7346 00002BE7 36206279204572646F-
  7346 00002BF0 67616E2054616E2E20 
  7347 00002BF9 4A616E756172792032-     	db 'January 2025.',10,13,0
  7347 00002C02 3032352E0A0D00     
  7348 00002C09 30312F30312F323032-     	db '01/01/2025', 10,13
  7348 00002C12 350A0D             
  7349                                  ; 15/11/2024
  7350                                  reset:
  7351 00002C15 00                      	db 0
  7352                                  
  7353                                  msgAudioCardInfo:
  7354 00002C16 666F7220496E74656C-     	db 'for Intel AC97 (ICH) Audio Controller.', 10,13,0
  7354 00002C1F 204143393720284943-
  7354 00002C28 482920417564696F20-
  7354 00002C31 436F6E74726F6C6C65-
  7354 00002C3A 722E0A0D00         
  7355                                  
  7356                                  	; 31/12/2024
  7357                                  msg_usage:
  7358 00002C3F 75736167653A204347-     	db 'usage: CGAPLAY1 <FileName1> <FileName2> <...>',10,13,0
  7358 00002C48 41504C415931203C46-
  7358 00002C51 696C654E616D65313E-
  7358 00002C5A 203C46696C654E616D-
  7358 00002C63 65323E203C2E2E2E3E-
  7358 00002C6C 0A0D00             
  7359                                  
  7360                                  noDevMsg:
  7361 00002C6F 4572726F723A20556E-     	db 'Error: Unable to find AC97 audio device!'
  7361 00002C78 61626C6520746F2066-
  7361 00002C81 696E64204143393720-
  7361 00002C8A 617564696F20646576-
  7361 00002C93 69636521           
  7362 00002C97 0A0D00                  	db 10,13,0
  7363                                  
  7364                                  noFileErrMsg:
  7365 00002C9A 4572726F723A206669-     	db 'Error: file not found.',10,13,0
  7365 00002CA3 6C65206E6F7420666F-
  7365 00002CAC 756E642E0A0D00     
  7366                                  
  7367                                  ; 07/12/2024
  7368                                  trdos386_err_msg:
  7369 00002CB3 5452444F5320333836-     	db 'TRDOS 386 System call error !',10,13,0
  7369 00002CBC 2053797374656D2063-
  7369 00002CC5 616C6C206572726F72-
  7369 00002CCE 20210A0D00         
  7370                                  
  7371                                  ; 29/05/2024
  7372                                  ; 11/11/2023
  7373                                  msg_init_err:
  7374 00002CD3 0D0A                    	db CR, LF
  7375 00002CD5 4143393720436F6E74-     	db 'AC97 Controller/Codec initialization error !'
  7375 00002CDE 726F6C6C65722F436F-
  7375 00002CE7 64656320696E697469-
  7375 00002CF0 616C697A6174696F6E-
  7375 00002CF9 206572726F722021   
  7376 00002D01 0D0A00                  	db CR, LF, 0 ; 07/12/2024
  7377                                  
  7378                                  ; 25/11/2023
  7379                                  msg_no_vra:
  7380 00002D04 0A0D                    	db 10,13
  7381 00002D06 4E6F20565241207375-     	db 'No VRA support ! Only 48 kHZ sample rate supported !'
  7381 00002D0F 70706F72742021204F-
  7381 00002D18 6E6C79203438206B48-
  7381 00002D21 5A2073616D706C6520-
  7381 00002D2A 726174652073757070-
  7381 00002D33 6F727465642021     
  7382 00002D3A 0A0D00                  	db 10,13,0
  7383                                  
  7384                                  ; 19/11/2024
  7385                                  ; 03/06/2017
  7386                                  hex_chars:
  7387 00002D3D 303132333435363738-     	db '0123456789ABCDEF', 0
  7387 00002D46 3941424344454600   
  7388                                  msgAC97Info:
  7389 00002D4E 0D0A                    	db 0Dh, 0Ah
  7390 00002D50 204143393720417564-     	db ' AC97 Audio Controller & Codec Info', 0Dh, 0Ah 
  7390 00002D59 696F20436F6E74726F-
  7390 00002D62 6C6C6572202620436F-
  7390 00002D6B 64656320496E666F0D-
  7390 00002D74 0A                 
  7391 00002D75 2056656E646F722049-     	db ' Vendor ID: '
  7391 00002D7E 443A20             
  7392                                  msgVendorId:
  7393 00002D81 303030306820446576-     	db '0000h Device ID: '
  7393 00002D8A 6963652049443A20   
  7394                                  msgDevId:
  7395 00002D92 30303030680D0A          	db '0000h', 0Dh, 0Ah
  7396 00002D99 204275733A20            	db ' Bus: '
  7397                                  msgBusNo:
  7398 00002D9F 303068204465766963-     	db '00h Device: '
  7398 00002DA8 653A20             
  7399                                  msgDevNo:
  7400 00002DAB 3030682046756E6374-     	db '00h Function: '
  7400 00002DB4 696F6E3A20         
  7401                                  msgFncNo:
  7402 00002DB9 303068                  	db '00h'
  7403 00002DBC 0D0A                    	db 0Dh, 0Ah
  7404 00002DBE 204E414D4241523A20      	db ' NAMBAR: '
  7405                                  msgNamBar:
  7406 00002DC7 30303030682020          	db '0000h  '
  7407 00002DCE 4E41424D4241523A20      	db 'NABMBAR: '
  7408                                  msgNabmBar:
  7409 00002DD7 303030306820204952-     	db '0000h  IRQ: '
  7409 00002DE0 513A20             
  7410                                  msgIRQ:
  7411 00002DE3 3030                    	dw 3030h
  7412 00002DE5 0D0A00                  	db 0Dh, 0Ah, 0
  7413                                  ; 25/11/2023
  7414                                  msgVRAheader:
  7415 00002DE8 205652412073757070-     	db ' VRA support: '
  7415 00002DF1 6F72743A20         
  7416 00002DF6 00                      	db 0	
  7417                                  msgVRAyes:
  7418 00002DF7 5945530D0A00            	db 'YES', 0Dh, 0Ah, 0
  7419                                  msgVRAno:
  7420 00002DFD 4E4F200D0A              	db 'NO ', 0Dh, 0Ah
  7421                                  	;db ' (Interpolated sample rate playing method)'
  7422                                  	; 30/12/2024
  7423 00002E02 2028496E746572706F-     	db ' (Interpolated samplerate play method)'
  7423 00002E0B 6C617465642073616D-
  7423 00002E14 706C65726174652070-
  7423 00002E1D 6C6179206D6574686F-
  7423 00002E26 6429               
  7424 00002E28 0D0A00                  	db 0Dh, 0Ah, 0
  7425                                  
  7426 00002E2B 90                      align 4
  7427                                  
  7428                                  ; -------------------------------------------------------------
  7429                                  
  7430                                  	; 30/12/2024
  7431                                  PlayingScreen:
  7432 00002E2C DBDBDBDBDBDBDBDBDB-     	db  14 dup(219), " DOS Player ", 14 dup(219)
  7432 00002E35 DBDBDBDBDB20444F53-
  7432 00002E3E 20506C6179657220DB-
  7432 00002E47 DBDBDBDBDBDBDBDBDB-
  7432 00002E50 DBDBDBDB           
  7433 00002E54 C9CDCDCDCDCDCDCDCD-     	db  201, 38 dup(205), 187
  7433 00002E5D CDCDCDCDCDCDCDCDCD-
  7433 00002E66 CDCDCDCDCDCDCDCDCD-
  7433 00002E6F CDCDCDCDCDCDCDCDCD-
  7433 00002E78 CDCDCDBB           
  7434 00002E7C BA203C53706163653E-     	db  186, " <Space> Play/Pause <N>/<P> Next/Prev ", 186
  7434 00002E85 20506C61792F506175-
  7434 00002E8E 7365203C4E3E2F3C50-
  7434 00002E97 3E204E6578742F5072-
  7434 00002EA0 657620BA           
  7435 00002EA4 BA203C533E20202020-     	db  186, " <S>     Stop       <Enter> Color     ", 186
  7435 00002EAD 2053746F7020202020-
  7435 00002EB6 2020203C456E746572-
  7435 00002EBF 3E20436F6C6F722020-
  7435 00002EC8 202020BA           
  7436 00002ECC BA203C463E20202020-     	db  186, " <F>     Forwards   <+>/<-> Volume    ", 186
  7436 00002ED5 20466F727761726473-
  7436 00002EDE 2020203C2B3E2F3C2D-
  7436 00002EE7 3E20566F6C756D6520-
  7436 00002EF0 202020BA           
  7437 00002EF4 BA203C423E20202020-     	db  186, " <B>     Backwards  <Q>     Quit Prg  ", 186
  7437 00002EFD 204261636B77617264-
  7437 00002F06 7320203C513E202020-
  7437 00002F0F 202051756974205072-
  7437 00002F18 672020BA           
  7438 00002F1C CCCDCDCDCDCDCDCDCD-     	db  204, 38 dup(205), 185
  7438 00002F25 CDCDCDCDCDCDCDCDCD-
  7438 00002F2E CDCDCDCDCDCDCDCDCD-
  7438 00002F37 CDCDCDCDCDCDCDCDCD-
  7438 00002F40 CDCDCDB9           
  7439 00002F44 BA2046696C653A2020-     	db  186, " File:              Bits:     0       ", 186
  7439 00002F4D 202020202020202020-
  7439 00002F56 202020426974733A20-
  7439 00002F5F 202020203020202020-
  7439 00002F68 202020BA           
  7440 00002F6C BA20467265713A2030-     	db  186, " Freq: 0     Hz     Channels: 0       ", 186
  7440 00002F75 2020202020487A2020-
  7440 00002F7E 2020204368616E6E65-
  7440 00002F87 6C733A203020202020-
  7440 00002F90 202020BA           
  7441 00002F94 C8CDCDCDCDCDCDCDCD-     	db  200, 38 dup(205), 188
  7441 00002F9D CDCDCDCDCDCDCDCDCD-
  7441 00002FA6 CDCDCDCDCDCDCDCDCD-
  7441 00002FAF CDCDCDCDCDCDCDCDCD-
  7441 00002FB8 CDCDCDBC           
  7442 00002FBC 202020202020202020-     	db  40 dup(32)
  7442 00002FC5 202020202020202020-
  7442 00002FCE 202020202020202020-
  7442 00002FD7 202020202020202020-
  7442 00002FE0 20202020           
  7443                                  improper_samplerate_txt:
  7444                                  read_error_txt:
  7445 00002FE4 202020202020202020-     	db  40 dup(32)
  7445 00002FED 202020202020202020-
  7445 00002FF6 202020202020202020-
  7445 00002FFF 202020202020202020-
  7445 00003008 20202020           
  7446 0000300C 202020202020202020-     	db  40 dup(32)
  7446 00003015 202020202020202020-
  7446 0000301E 202020202020202020-
  7446 00003027 202020202020202020-
  7446 00003030 20202020           
  7447 00003034 202020202020202020-     	db  40 dup(32)
  7447 0000303D 202020202020202020-
  7447 00003046 202020202020202020-
  7447 0000304F 202020202020202020-
  7447 00003058 20202020           
  7448 0000305C 202020202020202020-     	db  40 dup(32)
  7448 00003065 202020202020202020-
  7448 0000306E 202020202020202020-
  7448 00003077 202020202020202020-
  7448 00003080 20202020           
  7449 00003084 202020202020202020-     	db  40 dup(32)
  7449 0000308D 202020202020202020-
  7449 00003096 202020202020202020-
  7449 0000309F 202020202020202020-
  7449 000030A8 20202020           
  7450 000030AC 202020202020202020-     	db  40 dup(32)
  7450 000030B5 202020202020202020-
  7450 000030BE 202020202020202020-
  7450 000030C7 202020202020202020-
  7450 000030D0 20202020           
  7451 000030D4 202020202020202020-     	db  40 dup(32)
  7451 000030DD 202020202020202020-
  7451 000030E6 202020202020202020-
  7451 000030EF 202020202020202020-
  7451 000030F8 20202020           
  7452 000030FC 202020202020202020-     	db  40 dup(32)
  7452 00003105 202020202020202020-
  7452 0000310E 202020202020202020-
  7452 00003117 202020202020202020-
  7452 00003120 20202020           
  7453 00003124 202020202020202020-     	db  40 dup(32)
  7453 0000312D 202020202020202020-
  7453 00003136 202020202020202020-
  7453 0000313F 202020202020202020-
  7453 00003148 20202020           
  7454 0000314C 202020202020202020-     	db  40 dup(32)
  7454 00003155 202020202020202020-
  7454 0000315E 202020202020202020-
  7454 00003167 202020202020202020-
  7454 00003170 20202020           
  7455 00003174 CDCDCDCDCDCDCDCDCD-     	db  40 dup(205)
  7455 0000317D CDCDCDCDCDCDCDCDCD-
  7455 00003186 CDCDCDCDCDCDCDCDCD-
  7455 0000318F CDCDCDCDCDCDCDCDCD-
  7455 00003198 CDCDCDCD           
  7456 0000319C 202020202020202020-     	db  40 dup(32)
  7456 000031A5 202020202020202020-
  7456 000031AE 202020202020202020-
  7456 000031B7 202020202020202020-
  7456 000031C0 20202020           
  7457 000031C4 202020202020202020-     	db  13 dup(32), "00:00 ", 174, 175, " 00:00", 4 dup(32), "VOL 000%"
  7457 000031CD 2020202030303A3030-
  7457 000031D6 20AEAF2030303A3030-
  7457 000031DF 20202020564F4C2030-
  7457 000031E8 303025             
  7458                                  	;db  40 dup(32) ; not necessary
  7459 000031EB 00                      	db 0
  7460                                  
  7461                                  ; -------------------------------------------------------------
  7462                                  
  7463                                  ; 31/12/2024
  7464                                  	; 30/12/2024
  7465                                  ;fillblock:
  7466                                  ;	times 8 db 0FFh
  7467                                  ;	dw 0
  7468                                  
  7469                                  ; -------------------------------------------------------------
  7470                                  
  7471                                  ; 30/12/2024
  7472                                  ; 23/11/2024
  7473                                  colors:
  7474 000031EC 0F0B0A0C0E090D          	db 0Fh, 0Bh, 0Ah, 0Ch, 0Eh, 09h, 0Dh
  7475                                  	; white, cyan, green, red, yellow, blue, magenta
  7476 000031F3 0B                      ccolor:	db 0Bh	; cyan
  7477                                  
  7478                                  EOF: 
  7479                                  
  7480                                  ; -------------------------------------------------------------
  7481                                  
  7482                                  bss:
  7483                                  
  7484                                  ABSOLUTE bss
  7485                                  
  7486                                  alignb 4
  7487                                  
  7488                                  ; 24/12/2024
  7489                                  wpoints_dif:	; wave lighting points factor (differential) 
  7490 000031F4 ????????                	resd 1	; required bytes for 1/18 second wave lighting
  7491                                  graphstart:
  7492 000031F8 ????????                	resd 1	; start (top) line/row for wave lighting points 	 
  7493                                  
  7494                                  ; 30/12/2024
  7495                                  ;LFB_ADDR:
  7496                                  ;	resd 1
  7497                                  
  7498                                  ;nextrow:
  7499                                  	;resd 1
  7500                                  
  7501                                  ; 31/12/2024
  7502                                  ;screenpos: ; hw = (cursor) row, lw = (cursor) column
  7503                                  	;resd 1
  7504                                  
  7505 000031FC ????????                wcolor:	resd 1
  7506                                  ; 26/12/2024
  7507                                  ;tcolor: resb 1 ; text color
  7508                                  columns:
  7509 00003200 ??                      	resb 1
  7510 00003201 ??                      pbprev:	resb 1 ; previous progress bar indicator position
  7511                                  
  7512 00003202 ????                    alignb 4
  7513                                  
  7514                                  bss_start:
  7515                                  
  7516                                  ; 29/12/2024
  7517                                  audio_buffer:
  7518 00003204 ????????                	resd 1
  7519                                  
  7520                                  ; 30/12/2024
  7521                                  prev_points:
  7522 00003208 <res 500h>              	resd 320 ; previous wave points (which are lighting)	
  7523                                  
  7524                                  ; 18/11/2024
  7525                                  stopped:
  7526 00003708 ??                      	resb 1
  7527 00003709 ??                      tLO:	resb 1
  7528                                  ; 21/11/2024
  7529 0000370A ??                      tLP:	resb 1
  7530                                  ; 30/12/2024
  7531                                  wpoints:
  7532 0000370B ??                      	resb 1
  7533 0000370C ????????                pbuf_o:	resd 1
  7534                                  ; 29/12/2024
  7535 00003710 ????????                pbuf_s:	resd 1
  7536                                  
  7537                                  ; 07/12/2024
  7538                                  ; 24/11/2024
  7539                                  half_buffer:
  7540 00003714 ??                      	resb 1	; dma half buffer 1 or 2 (0 or 1)
  7541                                  
  7542                                  ; 30/05/2024
  7543 00003715 ??                      VRA:	resb 1	; Variable Rate Audio Support Status
  7544                                  
  7545                                  ; 25/12/2024
  7546                                  ; 29/11/2024
  7547                                  command:
  7548 00003716 ??                      	resb 1
  7549                                  filecount:
  7550 00003717 ??                      	resb 1
  7551                                  
  7552                                  ; 30/11/2024
  7553                                  alignb 4
  7554                                  
  7555                                  ;;;;;;;;;;;;;;
  7556                                  ; 14/11/2024
  7557                                  ; (Ref: player.asm, Matan Alfasi, 2017)  
  7558                                  WAVFILEHEADERbuff:
  7559                                  RIFF_ChunkID:
  7560 00003718 ????????                	resd 1	; Must be equal to "RIFF" - big-endian
  7561                                  		; 0x52494646
  7562                                  RIFF_ChunkSize:
  7563 0000371C ????????                	resd 1	; Represents total file size, not 
  7564                                          	; including the first 2 fields 
  7565                                  		; (Total_File_Size - 8), little-endian
  7566                                  RIFF_Format:
  7567 00003720 ????????                	resd 1	; Must be equal to "WAVE" - big-endian
  7568                                  		; 0x57415645
  7569                                  
  7570                                  ;; WAVE header parameters ("Sub-chunk")
  7571                                  WAVE_SubchunkID:
  7572 00003724 ????????                	resd 1	; Must be equal to "fmt " - big-endian
  7573                                  		; 0x666d7420
  7574                                  WAVE_SubchunkSize:
  7575 00003728 ????????                	resd 1	; Represents total chunk size
  7576                                  WAVE_AudioFormat:
  7577 0000372C ????                    	resw 1	; PCM (Raw) - is 1, other - is a form 
  7578                                  		; of compression, not supported.
  7579                                  WAVE_NumChannels:
  7580 0000372E ????                    	resw 1	; Number of channels, Mono-1, Stereo-2
  7581                                  WAVE_SampleRate:
  7582 00003730 ????????                	resd 1	; Frequency rate, in Hz (8000, 44100 ...)
  7583                                  WAVE_ByteRate:
  7584 00003734 ????????                	resd 1	; SampleRate * NumChannels * BytesPerSample
  7585                                  WAVE_BlockAlign:
  7586 00003738 ????                    	resw 1	; NumChannels * BytesPerSample
  7587                                  		; Number of bytes for one sample.
  7588                                  WAVE_BitsPerSample:
  7589 0000373A ????                    	resw 1	; 8 = 8 bits, 16 = 16 bits, etc.
  7590                                  
  7591                                  ;; DATA header parameters
  7592                                  DATA_SubchunkID:
  7593 0000373C ????????                	resd 1	; Must be equal to "data" - big-endian
  7594                                          	; 0x64617461
  7595                                  DATA_SubchunkSize:
  7596 00003740 ????????                	resd 1	; NumSamples * NumChannels * BytesPerSample
  7597                                          	; Number of bytes in the data.
  7598                                  ;;;;;;;;;;;;;;
  7599                                  
  7600                                  ; 28/12/2024
  7601                                  ; 15/11/2024
  7602                                  ;cursortype:
  7603 00003744 ????                    	resw 1
  7604 00003746 ??                      flags:	resb 1
  7605                                  ; 06/11/2023
  7606                                  ac97_int_ln_reg:
  7607 00003747 ??                      	resb 1
  7608                                  filehandle:
  7609 00003748 ????????                	resd 1
  7610                                  
  7611                                  ; 25/12/2024
  7612                                  ; 30/11/2024
  7613                                  ;argc:	resb 1	; argument count
  7614 0000374C ????????                argv:	resd 1	; current argument (wav file) ptr
  7615 00003750 ????????                argvf:	resd 1	; 1st argument (wav file) ptr
  7616 00003754 ????????                argvl:	resd 1	; last argument (wav file) ptr
  7617                                  
  7618                                  ; 30/05/2024
  7619                                  wav_file_name:
  7620 00003758 <res 50h>               	resb 80	; wave file, path name (<= 80 bytes)
  7621 000037A8 ????                    	resw 1	; 30/11/2024
  7622                                  
  7623                                  ; 08/11/2023
  7624                                  ; 07/11/2023
  7625                                  fbs_shift:
  7626 000037AA ??                      	resb 1
  7627                                  ; 07/12/2024
  7628 000037AB ??                      SRB:	resb 1
  7629                                  
  7630                                  ; 12/11/2016 - Erdogan Tan
  7631                                  bus_dev_fn:
  7632 000037AC ????????                	resd 1
  7633                                  dev_vendor:
  7634 000037B0 ????????                	resd 1
  7635                                  
  7636                                  ; 17/02/2017
  7637                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  7638                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  7639                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  7640                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  7641 000037B4 ????                    NAMBAR:	resw 1	; BAR for mixer
  7642                                  NABMBAR:
  7643 000037B6 ????                    	resw 1	; BAR for bus master regs
  7644                                  
  7645                                  ; 15/11/2024
  7646                                  loadfromwavfile:
  7647 000037B8 ????????                	resd 1	; 'loadfromfile' or load+conversion proc address
  7648                                  loadsize:
  7649 000037BC ????????                	resd 1	; (.wav file) read count (bytes) per one time
  7650                                  buffersize:
  7651 000037C0 ????????                	resd 1	; 16 bit samples (not bytes)
  7652                                  		
  7653                                  ; 14/11/2024
  7654                                  TotalTime:
  7655 000037C4 ????????                	resd 1	; Total (WAV File) Playing Time in seconds
  7656                                  ProgressTime:
  7657 000037C8 ????????                	resd 1
  7658 000037CC ????????                count:	resd 1	; byte count of one (wav file) read
  7659                                  LoadedDataBytes:
  7660 000037D0 ????????                	resd 1	; total read/load count
  7661                                  
  7662                                  timerticks:
  7663 000037D4 ????????                	resd 1	; (to eliminate excessive lookup of events in tuneloop)
  7664                                  		; (in order to get the emulator/qemu to run correctly)
  7665                                  ; 01/12/2024
  7666                                  _bdl_buffer:
  7667 000037D8 ????????                	resd 1
  7668                                  
  7669                                  ; 14/11/2024
  7670                                  bss_end:
  7671                                  
  7672                                  ; 29/12/2024
  7673 000037DC <res 824h>              alignb 4096
  7674                                  
  7675                                  ; 01/12/2024
  7676                                  BDL_BUFFER:
  7677 00004000 <res 100h>              	resb 256
  7678                                  	; 02/12/2024
  7679 00004100 <res F00h>              	resb 4096-256
  7680                                  
  7681                                  ;alignb 4096
  7682                                  
  7683                                  ; 29/05/2024
  7684                                  WAVBUFFER_1:
  7685 00005000 <res 10000h>            	resb 65536
  7686                                  WAVBUFFER_2:
  7687 00015000 <res 10000h>            	resb 65536
  7688                                  
  7689                                  ; 01/12/2024
  7690                                  ; 26/11/2023
  7691                                  temp_buffer:
  7692 00025000 <res 10000h>            	resb 65536  ;  resb BUFFERSIZE
