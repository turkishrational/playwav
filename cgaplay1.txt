     1                                  ; ****************************************************************************
     2                                  ; cgaplay1.s - TRDOS 386 (TRDOS v2.0.9) WAV PLAYER - Video Mode 13h
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; CGAPLAY1.PRG ! AC'97 (ICH) .WAV PLAYER program by Erdogan TAN
     5                                  ;
     6                                  ; 27/12/2024				- play music from multiple wav files -
     7                                  ;
     8                                  ; [ Last Modification: 18/01/2025 ]
     9                                  ;
    10                                  ; Modified from VGAPLAY3.PRG .wav player program by Erdogan Tan, 30/12/2024
    11                                  ;
    12                                  ; ****************************************************************************
    13                                  ; nasm cgaplay1.s -l cgaplay1.txt -o CGAPLAY1.PRG -Z error.txt
    14                                  
    15                                  ; 31/12/2024
    16                                  ; cgaplay1.s (int 31h modifications on cgaplay.s)
    17                                  ; 30/12/2024 (cgaplay.s)
    18                                  ; vgaplay3.s
    19                                  ; 27/12/2024
    20                                  ; vgaplay2.s : DMA buffer tracking (instead of user's audio buffer)
    21                                  ; 18/12/2024
    22                                  ; ac97play.s : TUNELOOP version (playing without AC97 interrupt)
    23                                  
    24                                  ; vgaplay.s (26/12/2024) - play music from multiple wav files -
    25                                  ; dplayvga.s (25/12/2024) - play music from single wav file -
    26                                  ; ac97play.s (18/12/2024) - play music from multiple wav files -
    27                                  
    28                                  ; 07/12/2024 - playwav9.s - interrupt (srb) + tuneloop version
    29                                  ; ------------------------------------------------------------
    30                                  ; INTERRUPT (SRB) + TUNELOOP version ; 24/11/2024 (PLAYWAV9.ASM)
    31                                  ;	(running in DOSBOX, VIRTUALBOX, QEMU is ok)
    32                                  ; Signal Response Byte = message/signal to user about an event/interrupt
    33                                  ;	    as requested (TuneLoop procedure continuously checks this SRB)
    34                                  ; (TRDOS 386 v2 feature is used here as very simple interrupt handler output)
    35                                  
    36                                  ; ------------------------------------------------------------
    37                                  
    38                                  ; 30/11/2024
    39                                  ; 20/08/2024 ; TRDOS 386 v2.0.9
    40                                  ; 29/04/2016
    41                                  _ver 	equ 0
    42                                  _exit 	equ 1
    43                                  _fork 	equ 2
    44                                  _read 	equ 3
    45                                  _write	equ 4
    46                                  _open	equ 5
    47                                  _close 	equ 6
    48                                  _wait 	equ 7
    49                                  _creat 	equ 8
    50                                  _link 	equ 9
    51                                  _unlink	equ 10
    52                                  _exec	equ 11
    53                                  _chdir	equ 12
    54                                  _time 	equ 13
    55                                  _mkdir 	equ 14
    56                                  _chmod	equ 15
    57                                  _chown	equ 16
    58                                  _break	equ 17
    59                                  _stat	equ 18
    60                                  _seek	equ 19
    61                                  _tell 	equ 20
    62                                  _mount	equ 21
    63                                  _umount	equ 22
    64                                  _setuid	equ 23
    65                                  _getuid	equ 24
    66                                  _stime	equ 25
    67                                  _quit	equ 26
    68                                  _intr	equ 27
    69                                  _fstat	equ 28
    70                                  _emt 	equ 29
    71                                  _mdate 	equ 30
    72                                  _video 	equ 31
    73                                  _audio	equ 32
    74                                  _timer	equ 33
    75                                  _sleep	equ 34
    76                                  _msg    equ 35
    77                                  _geterr	equ 36
    78                                  _fpsave	equ 37
    79                                  _pri	equ 38
    80                                  _rele	equ 39
    81                                  _fff	equ 40
    82                                  _fnf	equ 41
    83                                  _alloc	equ 42
    84                                  _dalloc equ 43
    85                                  _calbac equ 44
    86                                  _dma	equ 45
    87                                  _stdio  equ 46
    88                                  
    89                                  ; ------------------------------------------------------------
    90                                  
    91                                  %macro sys 1-4
    92                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)
    93                                      ; 03/09/2015
    94                                      ; 13/04/2015
    95                                      ; Retro UNIX 386 v1 system call.
    96                                      %if %0 >= 2
    97                                          mov ebx, %2
    98                                          %if %0 >= 3
    99                                              mov ecx, %3
   100                                              %if %0 = 4
   101                                                 mov edx, %4
   102                                              %endif
   103                                          %endif
   104                                      %endif
   105                                      mov eax, %1
   106                                      ;int 30h
   107                                      int 40h ; TRDOS 386 (TRDOS v2.0)
   108                                  %endmacro
   109                                  
   110                                  ; Retro UNIX 386 v1 system call format:
   111                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
   112                                  
   113                                  ; ------------------------------------------------------------
   114                                  
   115                                  ; player internal variables and other equates.
   116                                  BUFFERSIZE	equ 65536
   117                                  ENDOFFILE	equ 1		; flag for knowing end of file
   118                                  
   119                                  ; ------------------------------------------------------------
   120                                  
   121                                  [BITS 32] ; 32-bit intructions
   122                                  
   123                                  [ORG 0]
   124                                  
   125                                  START_CODE:
   126                                  	; Prints the Credits Text.
   127                                  	sys	_msg, Credits, 255, 0Bh
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00000000 BB[AC2B0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000005 B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 0000000A BA0B000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 0000000F B823000000          <1>  mov eax, %1
   106                              <1> 
   107 00000014 CD40                <1>  int 40h
   128                                  
   129                                  	; clear bss
   130 00000016 BF[E4310000]            	mov	edi, bss_start
   131 0000001B B976010000              	mov	ecx, (bss_end - bss_start)/4
   132 00000020 31C0                    	xor	eax, eax
   133 00000022 F3AB                    	rep	stosd
   134                                  
   135                                  ; -------------------------------------------------------------
   136                                  
   137                                  	; 21/12/2024
   138                                  	; Detect (& Enable) AC'97 Audio Device
   139 00000024 E860070000              	call	DetectAC97
   140 00000029 731B                    	jnc	short ac97_hardware_ready
   141                                  
   142                                  	; 30/11/2024
   143                                  	; 30/05/2024
   144                                  _dev_not_ready:
   145                                  	; couldn't find the audio device!
   146                                  	sys	_msg, noDevMsg, 255, 0Fh
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 0000002B BB[4F2C0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000030 B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00000035 BA0F000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 0000003A B823000000          <1>  mov eax, %1
   106                              <1> 
   107 0000003F CD40                <1>  int 40h
   147 00000041 E975040000                      jmp     Exit
   148                                  
   149                                  ac97_hardware_ready:
   150 00000046 E8750D0000              	call	write_audio_dev_info
   151                                  
   152                                  ; -------------------------------------------------------------
   153                                  
   154                                  	; 30/12/2024
   155                                  	;;;
   156                                  	; DIRECT VGA MEMORY ACCESS
   157                                  	; bl = 0, bh = 5
   158                                  	; Direct access/map to VGA memory (0A0000h)
   159                                  
   160                                  	sys	_video, 0500h
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 0000004B BB00050000          <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99                              <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101                              <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000050 B81F000000          <1>  mov eax, %1
   106                              <1> 
   107 00000055 CD40                <1>  int 40h
   161 00000057 3D00000A00              	cmp	eax, 0A0000h
   162 0000005C 7405                    	je	short _a
   163                                  
   164                                  	; 30/12/2024
   165 0000005E E9A0040000              	jmp	trdos386_error
   166                                  
   167                                  _a:
   168                                  	;; Set Video Mode to 13h
   169                                  	;sys	_video, 0813h
   170                                  	;cmp	eax, 14h 
   171                                  	;je	short mode_13h_set_ok
   172                                  
   173                                  	; set VGA mode by using int 31h
   174 00000063 66B81300                	mov	ax, 13h	; mode 13h ; 
   175 00000067 CD31                    	int	31h	; real mode: int 10h
   176                                  
   177                                  ; -------------------------------------------------------------
   178                                  
   179                                  mode_13h_set_ok:
   180                                  	; 30/12/2024
   181                                  	; 24/12/2024 (setting for wave lighting points)
   182                                  	;mov	eax, 0A0000h
   183                                  	;;add	eax, 12*8*320
   184                                  	;add	eax, (13*8*320)+(2*320)
   185                                  			; wave graphics start (top) line/row
   186                                  			; 64 volume levels
   187                                  	;mov	[graphstart], eax
   188                                  	; 30/12/2024
   189                                  	;mov	dword [graphstart], 0A0000h+(13*8*320)+(4*320)
   190                                  	; 01/01/2025
   191 00000069 C705[D8310000]0073-     	mov	dword [graphstart], 0A0000h+(11*8*320)+(4*320)
   191 00000071 0A00               
   192                                  
   193                                  ; -------------------------------------------------------------
   194                                  
   195                                  	; 25/12/2024
   196                                  	; 28/11/2024
   197                                  Player_InitalizePSP:
   198                                  	; 30/11/2024
   199                                  	; (TRDOS 386 -Retro UNIX 386- argument transfer method)
   200                                  	; (stack: argc,argv0addr,argv1addr,argv2addr ..
   201                                  	;			.. argv0text, argv1text ..) 
   202                                  	; ---- argc, argv[] ----
   203 00000073 89E6                    	mov	esi, esp
   204 00000075 AD                      	lodsd
   205 00000076 83F802                  	cmp	eax, 2 ; two arguments 
   206                                  		; (program file name & mod file name)
   207 00000079 0F8245040000            	jb	pmsg_usage ; nothing to do
   208                                  	;mov	[argc], al
   209 0000007F C1E002                  	shl	eax, 2 ; *4
   210 00000082 01E0                    	add	eax, esp
   211                                  	; eax = last argument's address pointer
   212 00000084 A3[34370000]            	mov	[argvl], eax ; last wav file (argument)
   213 00000089 8935[2C370000]          	mov	[argv], esi ; current argument (PRG file name)
   214 0000008F AD                      	lodsd	; skip program (PRG) file name
   215 00000090 8935[30370000]          	mov	[argvf], esi ; 1st wav file (argument)
   216                                  
   217                                  	; 30/12/2024
   218                                  Player_ParseParameters:
   219 00000096 EB2A                    	jmp	short Player_ParseNextParameter
   220                                  	; 25/12/2024
   221                                  check_p_command:
   222                                  	; 07/12/2024
   223 00000098 8B35[2C370000]          	mov	esi, [argv]
   224                                  	;
   225 0000009E 803D[F6360000]50          	cmp	byte [command], 'P'
   226 000000A5 7410                    	je	short Player_ParsePreviousParameter
   227                                      
   228                                  	; 07/12/2024
   229                                  	; 30/11/2024
   230                                  	;mov	esi, [argv] ; current argument (wav file) ptr
   231 000000A7 83C604                  	add	esi, 4
   232 000000AA 3B35[34370000]          	cmp	esi, [argvl] ; last argument (wav file) ptr
   233 000000B0 7610                    	jna	short Player_ParseNextParameter
   234                                  jmp_Player_Quit:
   235 000000B2 E9A5040000              	jmp	Player_Quit
   236                                  
   237                                  Player_ParsePreviousParameter:
   238                                  	; 29/11/2024
   239                                  	;mov	byte [command], 0
   240                                  	; 30/11/2024
   241                                  	;mov	esi, [argv] ; 07/12/2024	
   242 000000B7 3B35[30370000]          	cmp	esi, [argvf] ; first argument (wav file) ptr
   243 000000BD 7603                    	jna	short Player_ParseNextParameter
   244 000000BF 83EE04                  	sub	esi, 4
   245                                  Player_ParseNextParameter:
   246                                  	; 30/11/2024
   247 000000C2 8935[2C370000]          	mov	[argv], esi  ; set as current argument
   248                                  
   249                                  	; 01/12/2024
   250 000000C8 8B36                    	mov	esi, [esi]
   251                                  
   252                                  	; 30/12/2024
   253                                  	; 29/11/2024
   254 000000CA E83C000000              	call	GetFileName
   255                                  	;jcxz	jmp_Player_Quit
   256 000000CF E3E1                    	jecxz	jmp_Player_Quit ; 30/11/2024
   257                                  
   258                                  	; 30/12/2024
   259                                          ; open existing file
   260                                  	; 28/11/2024
   261 000000D1 BA[38370000]            	mov	edx, wav_file_name
   262 000000D6 E8FE060000                      call	openFile ; no error? ok.
   263 000000DB 7376                            jnc	getwavparms	; 14/11/2024
   264                                  
   265                                  	; 29/11/2024
   266 000000DD 803D[F7360000]00        	cmp	byte [filecount], 0
   267 000000E4 77B2                    	ja	short check_p_command
   268                                  
   269                                  	; 25/12/2024
   270                                  	; 21/12/2024
   271 000000E6 E869040000              	call	set_text_mode
   272                                  	; file not found!
   273                                  	; 30/11/2024
   274                                  	sys	_msg, noFileErrMsg, 255, 0Ch
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000000EB BB[7A2C0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000000F0 B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000000F5 BA0C000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000000FA B823000000          <1>  mov eax, %1
   106                              <1> 
   107 000000FF CD40                <1>  int 40h
   275 00000101 E9B5030000                      jmp     Exit
   276                                  
   277                                  _exit_:
   278 00000106 E9AB030000              	jmp	terminate
   279                                  
   280                                  ; -------------------------------------------------------------
   281                                  
   282                                  	; 26/12/2024
   283                                  	; 25/12/2024
   284                                  	; 30/11/2024 (32bit)
   285                                  	; 29/11/2024
   286                                  	; 30/05/2024
   287                                  GetFileName:
   288 0000010B BF[38370000]            	mov	edi, wav_file_name 
   289                                  	; 30/11/2024
   290                                  	;mov	esi, [argv]
   291 00000110 31C9                    	xor	ecx, ecx ; 0
   292                                  ScanName:
   293 00000112 AC                      	lodsb
   294                                  	;test	al, al
   295                                  	;jz	short a_4
   296                                  	; 29/11/2024
   297 00000113 3C0D                    	cmp	al, 0Dh
   298 00000115 7638                    	jna	short a_4
   299 00000117 3C20                    	cmp	al, 20h
   300 00000119 74F7                    	je	short ScanName	; scan start of name.
   301 0000011B AA                      	stosb
   302 0000011C B4FF                    	mov	ah, 0FFh
   303                                  	;;;
   304                                  	; 14/11/2024
   305                                  	; (max. path length = 64 bytes for MSDOS ?) (*)
   306                                  	;xor	ecx, ecx ; 0
   307                                  	;;;
   308                                  a_0:	
   309 0000011E FEC4                    	inc	ah
   310                                  a_1:
   311                                  	;;;
   312                                  	; 14/11/2024
   313 00000120 41                      	inc	ecx
   314                                  	;;;
   315 00000121 AC                      	lodsb
   316 00000122 AA                      	stosb
   317 00000123 3C2E                    	cmp	al, '.'
   318 00000125 74F7                    	je	short a_0
   319                                  	; 29/11/2024
   320 00000127 3C20                    	cmp	al, 20h
   321                                  	;and	al, al
   322                                  	;jnz	short a_1
   323                                  	;;;
   324                                  	; 14/11/2024
   325 00000129 7613                    	jna	short a_3
   326 0000012B 20E4                    	and	ah, ah
   327 0000012D 7406                    	jz	short a_2
   328 0000012F 3C2F                    	cmp	al, '/'	; 14/12/2024
   329 00000131 7502                    	jne	short a_2
   330 00000133 B400                    	mov	ah, 0
   331                                  a_2:
   332 00000135 80F94B                  	cmp	cl, 75	; 64+8+'.'+3 -> offset 75 is the last chr
   333 00000138 72E6                    	jb	short a_1
   334                                  	; 29/11/2024
   335 0000013A 29C9                    	sub	ecx, ecx
   336 0000013C EB11                    	jmp	short a_4
   337                                  a_3:
   338                                  	; 29/11/2024
   339 0000013E 4F                      	dec	edi
   340                                  	;;;
   341 0000013F 08E4                    	or	ah, ah		; if period NOT found,
   342 00000141 750C                    	jnz	short a_4 	; then add a .WAV extension.
   343                                  SetExt:
   344                                  	; 29/11/2024
   345                                  	;dec	edi
   346 00000143 C7072E574156            	mov	dword [edi], '.WAV'
   347                                  				; ! 64+12 is DOS limit
   348                                  				; but writing +4 must not
   349                                  				; destroy the following data	 
   350                                  	;mov	byte [edi+4], 0	; so, 80 bytes path + 0 is possible here
   351                                  	; 29/11/2024
   352 00000149 83C104                  	add	ecx, 4
   353 0000014C 83C704                  	add	edi, 4
   354                                  a_4:	
   355 0000014F C60700                  	mov	byte [edi], 0
   356                                  	; 30/11/2024
   357 00000152 C3                      	retn
   358                                  
   359                                  ; -------------------------------------------------------------
   360                                  
   361                                  getwavparms:
   362                                  	; 14/11/2024
   363 00000153 E8B3060000                     	call    getWAVParameters
   364 00000158 72AC                    	jc	short _exit_		; nothing to do
   365                                  
   366                                  	; 17/11/2024
   367 0000015A B304                    	mov	bl, 4
   368 0000015C 2A1D[18370000]          	sub	bl, byte [WAVE_BlockAlign]
   369                                  			; = 0 for 16 bit stereo
   370                                  			; = 2 for 8 bit stereo or 16 bit mono
   371                                  			; = 3 for 8 bit mono	
   372                                  
   373 00000162 D0EB                    	shr	bl, 1	;  0 -->  0,  2 -->  1,  3 -->  1
   374                                  	; 15/11/2024
   375 00000164 80D300                  	adc	bl, 0	; 3 --> 1 --> 2
   376 00000167 881D[8A370000]          	mov	byte [fbs_shift], bl	; = 2 mono and 8 bit
   377                                  					; = 0 stereo and 16 bit
   378                                  					; = 1 mono or 8 bit
   379                                  	; 29/12/2024
   380                                  	; 30/05/2024
   381 0000016D E8FA070000              	call	codecConfig		; unmute codec, set rates.
   382 00000172 0F8269030000            	jc	init_err
   383                                  
   384                                  ; -------------------------------------------------------------
   385                                  
   386                                  StartPlay:
   387                                  	; 30/12/2024
   388 00000178 C605[EB360000]01        	mov	byte [wpoints], 1
   389                                  
   390                                  	;;;
   391                                  	; 09/12/2024
   392 0000017F B834290000              	mov	eax, 10548 ; (48000*10/182)*4
   393 00000184 803D[F5360000]00        	cmp	byte [VRA], 0
   394 0000018B 7614                    	jna	short _w ; 48kHZ (interpolation)
   395                                  	;
   396 0000018D 66A1[10370000]          	mov	ax, [WAVE_SampleRate]
   397 00000193 B90A000000              	mov	ecx, 10
   398 00000198 F7E1                    	mul	ecx
   399 0000019A B1B6                    	mov	cl, 182
   400 0000019C F7F1                    	div	ecx
   401                                  	; ax = samples per 1/18.2 second
   402                                  	;mov	cl, byte [WAVE_BlockAlign]
   403                                  	; 09/12/2024 
   404                                  	;mov	cl, 4 ; 16 bit, stereo
   405                                  	;mul	ecx
   406 0000019E C1E002                  	shl	eax, 2 ; * 4
   407                                  _w:
   408 000001A1 A3[D4310000]            	mov	[wpoints_dif], eax ; buffer read differential (distance)
   409                                  				; for wave volume leds update
   410                                  				; (byte stream per 1/18.2 second)
   411                                  
   412                                  ; -------------------------------------------------------------
   413                                  
   414                                  	; 25/12/2024
   415 000001A6 FE05[F7360000]          	inc	byte [filecount]
   416 000001AC C605[F6360000]00        	mov	byte [command], 0
   417                                  	; 30/12/2024
   418 000001B3 C605[E1310000]FF        	mov	byte [pbprev], -1
   419                                  
   420                                  ; -------------------------------------------------------------
   421                                  
   422                                  	; 07/12/2024 (playwav9.s)
   423                                  
   424                                  	; 18/11/2023 (ich_wav4.asm)
   425                                  	; 13/11/2023 (ich_wav3.asm)
   426                                  
   427 000001BA 803D[F5360000]01        	cmp	byte [VRA], 1
   428 000001C1 7226                    	jb	short chk_sample_rate
   429                                  
   430                                  playwav_48_khz:
   431 000001C3 C705[98370000]-         	mov	dword [loadfromwavfile], loadFromFile
   431 000001C9 [F20C0000]         
   432                                  	;mov	dword [loadsize], 0 ; 65536
   433                                  	;;;
   434                                  	; 17/11/2024
   435                                  	;mov	word [buffersize], 32768
   436                                  	;mov	ax, BUFFERSIZE/2 ; 32760
   437                                  	; 30/11/2024
   438                                  	;mov	eax, BUFFERSIZE/2 ; 32768
   439                                  	; 07/12/2024
   440 000001CD B800000100              	mov	eax, BUFFERSIZE ; 65536
   441 000001D2 A3[A0370000]            	mov	[buffersize], eax	; 16 bit samples
   442                                  	; 07/12/2024
   443                                  	;shl	eax, 1			; bytes
   444 000001D7 8A0D[8A370000]          	mov	cl, [fbs_shift]
   445 000001DD D3E8                    	shr	eax, cl 
   446                                  	;mov	[loadsize], ax ; 16380 or 32760 or 65520
   447 000001DF A3[9C370000]            	mov	[loadsize], eax ; 16384 or 32768 or 65536
   448                                  	;;;
   449                                  	;jmp	PlayNow ; 30/05/2024
   450                                  	; 07/12/2024
   451 000001E4 E95F020000              	jmp	Player_Template
   452                                  
   453                                  chk_sample_rate:
   454                                  	; set conversion parameters
   455                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   456 000001E9 66A1[10370000]          	mov	ax, [WAVE_SampleRate]
   457 000001EF 663D80BB                	cmp	ax, 48000
   458 000001F3 74CE                    	je	short playwav_48_khz
   459                                  chk_22khz:
   460 000001F5 663D2256                	cmp	ax, 22050
   461 000001F9 7545                    	jne	short chk_11khz
   462 000001FB 803D[1A370000]08        	cmp	byte [WAVE_BitsPerSample], 8
   463 00000202 7615                    	jna	short chk_22khz_1
   464 00000204 BB[871C0000]            	mov	ebx, load_22khz_stereo_16_bit
   465 00000209 803D[0E370000]01        	cmp	byte [WAVE_NumChannels], 1
   466 00000210 751A                    	jne	short chk_22khz_2
   467 00000212 BB[F41B0000]            	mov	ebx, load_22khz_mono_16_bit
   468 00000217 EB13                    	jmp	short chk_22khz_2
   469                                  chk_22khz_1:
   470 00000219 BB[671B0000]            	mov	ebx, load_22khz_stereo_8_bit
   471 0000021E 803D[0E370000]01        	cmp	byte [WAVE_NumChannels], 1
   472 00000225 7505                    	jne	short chk_22khz_2
   473 00000227 BB[D81A0000]            	mov	ebx, load_22khz_mono_8_bit
   474                                  chk_22khz_2:
   475 0000022C B85A1D0000              	mov	eax, 7514  ; (442*17)
   476 00000231 BA25000000              	mov	edx, 37
   477 00000236 B911000000              	mov	ecx, 17
   478 0000023B E9DB010000              	jmp	set_sizes
   479                                  chk_11khz:
   480 00000240 663D112B                	cmp	ax, 11025
   481 00000244 7545                    	jne	short chk_44khz
   482 00000246 803D[1A370000]08        	cmp	byte [WAVE_BitsPerSample], 8
   483 0000024D 7615                    	jna	short chk_11khz_1
   484 0000024F BB[BB1E0000]            	mov	ebx, load_11khz_stereo_16_bit
   485 00000254 803D[0E370000]01        	cmp	byte [WAVE_NumChannels], 1
   486 0000025B 751A                    	jne	short chk_11khz_2
   487 0000025D BB[3C1E0000]            	mov	ebx, load_11khz_mono_16_bit
   488 00000262 EB13                    	jmp	short chk_11khz_2
   489                                  chk_11khz_1:
   490 00000264 BB[B71D0000]            	mov	ebx, load_11khz_stereo_8_bit
   491 00000269 803D[0E370000]01        	cmp	byte [WAVE_NumChannels], 1 
   492 00000270 7505                    	jne	short chk_11khz_2
   493 00000272 BB[3E1D0000]            	mov	ebx, load_11khz_mono_8_bit
   494                                  chk_11khz_2:
   495 00000277 B8AD0E0000              	mov	eax, 3757  ; (221*17)
   496 0000027C BA4A000000              	mov	edx, 74
   497 00000281 B911000000              	mov	ecx, 17
   498 00000286 E990010000              	jmp	set_sizes
   499                                  chk_44khz:
   500 0000028B 663D44AC                	cmp	ax, 44100
   501 0000028F 7545                    	jne	short chk_16khz
   502 00000291 803D[1A370000]08        	cmp	byte [WAVE_BitsPerSample], 8
   503 00000298 7615                    	jna	short chk_44khz_1
   504 0000029A BB[DA200000]            	mov	ebx, load_44khz_stereo_16_bit
   505 0000029F 803D[0E370000]01        	cmp	byte [WAVE_NumChannels], 1
   506 000002A6 751A                    	jne	short chk_44khz_2
   507 000002A8 BB[5B200000]            	mov	ebx, load_44khz_mono_16_bit
   508 000002AD EB13                    	jmp	short chk_44khz_2
   509                                  chk_44khz_1:
   510 000002AF BB[D81F0000]            	mov	ebx, load_44khz_stereo_8_bit
   511 000002B4 803D[0E370000]01        	cmp	byte [WAVE_NumChannels], 1
   512 000002BB 7505                    	jne	short chk_44khz_2
   513 000002BD BB[561F0000]            	mov	ebx, load_44khz_mono_8_bit
   514                                  chk_44khz_2:
   515                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   516 000002C2 B8D93A0000              	mov	eax, 15065 ; (655*23)
   517                                  	; 18/11/2023 ((file size + bss + stack) <= 64KB)
   518                                  	;mov	ax, 14076 ; (612*23)
   519                                  	; 17/11/2024
   520                                  	;mov	ax, 12650 ; (550*23)
   521 000002C7 BA19000000              	mov	edx, 25
   522 000002CC B917000000              	mov	ecx, 23
   523 000002D1 E945010000              	jmp	set_sizes
   524                                  chk_16khz:
   525 000002D6 663D803E                	cmp	ax, 16000
   526 000002DA 7545                    	jne	short chk_8khz
   527 000002DC 803D[1A370000]08        	cmp	byte [WAVE_BitsPerSample], 8
   528 000002E3 7615                    	jna	short chk_16khz_1
   529 000002E5 BB[E7150000]            	mov	ebx, load_16khz_stereo_16_bit
   530 000002EA 803D[0E370000]01        	cmp	byte [WAVE_NumChannels], 1 
   531 000002F1 751A                    	jne	short chk_16khz_2
   532 000002F3 BB[60150000]            	mov	ebx, load_16khz_mono_16_bit
   533 000002F8 EB13                    	jmp	short chk_16khz_2
   534                                  chk_16khz_1:
   535 000002FA BB[A0140000]            	mov	ebx, load_16khz_stereo_8_bit
   536 000002FF 803D[0E370000]01        	cmp	byte [WAVE_NumChannels], 1
   537 00000306 7505                    	jne	short chk_16khz_2
   538 00000308 BB[1B140000]            	mov	ebx, load_16khz_mono_8_bit
   539                                  chk_16khz_2:
   540                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   541 0000030D B855150000              	mov	eax, 5461
   542                                  	; 17/11/2024
   543                                  	;mov	ax, 5460
   544 00000312 BA03000000              	mov	edx, 3
   545 00000317 B901000000              	mov	ecx, 1
   546 0000031C E9FA000000              	jmp	set_sizes
   547                                  chk_8khz:
   548 00000321 663D401F                	cmp	ax, 8000
   549 00000325 7545                    	jne	short chk_24khz
   550 00000327 803D[1A370000]08        	cmp	byte [WAVE_BitsPerSample], 8
   551 0000032E 7615                    	jna	short chk_8khz_1
   552 00000330 BB[CA120000]            	mov	ebx, load_8khz_stereo_16_bit
   553 00000335 803D[0E370000]01        	cmp	byte [WAVE_NumChannels], 1
   554 0000033C 751A                    	jne	short chk_8khz_2
   555 0000033E BB[F4110000]            	mov	ebx, load_8khz_mono_16_bit
   556 00000343 EB13                    	jmp	short chk_8khz_2
   557                                  chk_8khz_1:
   558 00000345 BB[BE100000]            	mov	ebx, load_8khz_stereo_8_bit
   559 0000034A 803D[0E370000]01        	cmp	byte [WAVE_NumChannels], 1 
   560 00000351 7505                    	jne	short chk_8khz_2
   561 00000353 BB[D00F0000]            	mov	ebx, load_8khz_mono_8_bit
   562                                  chk_8khz_2:
   563 00000358 B8AA0A0000              	mov	eax, 2730
   564 0000035D BA06000000              	mov	edx, 6
   565 00000362 B901000000              	mov	ecx, 1
   566 00000367 E9AF000000              	jmp	set_sizes
   567                                  chk_24khz:
   568 0000036C 663DC05D                	cmp	ax, 24000
   569 00000370 7563                    	jne	short chk_32khz
   570 00000372 803D[1A370000]08        	cmp	byte [WAVE_BitsPerSample], 8
   571 00000379 7615                    	jna	short chk_24khz_1
   572                                  	; 18/01/2025 (BugFix)
   573                                  	; bx -> ebx
   574 0000037B BB[29180000]            	mov	ebx, load_24khz_stereo_16_bit
   575 00000380 803D[0E370000]01        	cmp	byte [WAVE_NumChannels], 1
   576 00000387 751A                    	jne	short chk_24khz_2
   577 00000389 BB[C0170000]            	mov	ebx, load_24khz_mono_16_bit
   578 0000038E EB13                    	jmp	short chk_24khz_2
   579                                  chk_24khz_1:
   580 00000390 BB[30170000]            	mov	ebx, load_24khz_stereo_8_bit
   581 00000395 803D[0E370000]01        	cmp	byte [WAVE_NumChannels], 1 
   582 0000039C 7505                    	jne	short chk_24khz_2
   583 0000039E BB[C3160000]            	mov	ebx, load_24khz_mono_8_bit
   584                                  chk_24khz_2:
   585                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   586 000003A3 B800200000              	mov	eax, 8192
   587                                  	; 17/11/2024
   588                                  	;mov	ax, 8190
   589 000003A8 BA02000000              	mov	edx, 2
   590 000003AD B901000000              	mov	ecx, 1
   591 000003B2 EB67                    	jmp	short set_sizes
   592                                  
   593                                  	; 07/12/2024
   594                                  vra_needed:
   595                                  	; 30/11/2024 (TRDOS 386, ax -> eax)
   596                                  	; 13/11/2023
   597 000003B4 58                      	pop	eax ; discard return address to the caller
   598                                  	; 30/05/2024
   599                                  vra_err:
   600                                  	; 21/12/2024
   601 000003B5 E89A010000              	call	set_text_mode
   602                                  	; 30/11/2024
   603                                  	sys	_msg, msg_no_vra, 255, 0Fh
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000003BA BB[E42C0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000003BF B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000003C4 BA0F000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000003C9 B823000000          <1>  mov eax, %1
   106                              <1> 
   107 000003CE CD40                <1>  int 40h
   604 000003D0 E9E6000000              	jmp	Exit
   605                                  
   606                                  chk_32khz:
   607 000003D5 663D007D                	cmp	ax, 32000
   608 000003D9 75D9                    	jne	short vra_needed
   609 000003DB 803D[1A370000]08        	cmp	byte [WAVE_BitsPerSample], 8
   610 000003E2 7615                    	jna	short chk_32khz_1
   611 000003E4 BB[421A0000]            	mov	ebx, load_32khz_stereo_16_bit
   612 000003E9 803D[0E370000]01        	cmp	byte [WAVE_NumChannels], 1
   613 000003F0 751A                    	jne	short chk_32khz_2
   614 000003F2 BB[D2190000]            	mov	ebx, load_32khz_mono_16_bit
   615 000003F7 EB13                    	jmp	short chk_32khz_2
   616                                  chk_32khz_1:
   617 000003F9 BB[2F190000]            	mov	ebx, load_32khz_stereo_8_bit
   618 000003FE 803D[0E370000]01        	cmp	byte [WAVE_NumChannels], 1
   619 00000405 7505                    	jne	short chk_32khz_2
   620 00000407 BB[B6180000]            	mov	ebx, load_32khz_mono_8_bit
   621                                  chk_32khz_2:
   622                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   623 0000040C B8AA2A0000              	mov	eax, 10922
   624                                  	; 17/11/2024
   625                                  	;mov	ax, 10920
   626 00000411 BA03000000              	mov	edx, 3
   627 00000416 B902000000              	mov	ecx, 2
   628                                  	;jmp	short set_sizes
   629                                  set_sizes:
   630                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   631                                  	;;;
   632                                  	; 17/11/2024
   633 0000041B 51                      	push	ecx
   634 0000041C B102                    	mov	cl, 2
   635 0000041E 2A0D[8A370000]          	sub	cl, [fbs_shift]
   636                                  		; = 2 for 16 bit stereo
   637                                  		; = 1 for 16 bit mono or 8 bit stereo
   638                                  		; = 0 for 8 bit mono
   639 00000424 D3E0                    	shl	eax, cl
   640 00000426 59                      	pop	ecx	
   641 00000427 A3[9C370000]            	mov	[loadsize], eax	; (one) read count in bytes
   642                                  	;;;
   643 0000042C F7E2                    	mul	edx
   644 0000042E 83F901                  	cmp	ecx, 1
   645 00000431 7402                    	je	short s_2
   646                                  s_1:
   647 00000433 F7F1                    	div	ecx
   648                                  s_2:
   649                                  	;;;
   650                                  	; eax = byte count of (to be) converted samples 
   651                                  	
   652                                  	; 17/11/2024
   653                                  	;;;
   654 00000435 8A0D[8A370000]          	mov	cl, [fbs_shift]
   655                                  
   656 0000043B D3E0                    	shl	eax, cl
   657                                  		; *1 for 16 bit stereo
   658                                  		; *2 for 16 bit mono or 8 bit stereo
   659                                  		; *4 for for 8 bit mono
   660                                  	;;;
   661                                  
   662                                  	; eax = 16 bit stereo byte count (target buffer size)
   663                                  	
   664                                  	; 07/12/2024
   665                                  	;shr	eax, 1	; buffer size is 16 bit sample count
   666 0000043D A3[A0370000]            	mov	[buffersize], eax ; buffer size in bytes
   667 00000442 891D[98370000]          	mov	[loadfromwavfile], ebx
   668                                  
   669                                  ; -------------------------------------------------------------
   670                                  
   671                                  	; 30/12/2024
   672                                  Player_Template:
   673                                  	; 21/12/2024
   674 00000448 E8DF000000              	call	clearscreen
   675 0000044D E8E9000000              	call	drawplayingscreen
   676                                  
   677                                  	; 14/11/2024
   678 00000452 E87E240000              	call	SetTotalTime
   679 00000457 E842250000              	call	UpdateFileInfo
   680                                  
   681                                  ; -------------------------------------------------------------
   682                                  
   683                                  	; 30/12/2024 (cgaplay.s)
   684                                  	; 29/12/2024 (vgaplay3.s)
   685                                  	; 18/12/2024 (ac97play.s)
   686                                  PlayNow:
   687                                  	; 01/12/2024 (32bit)
   688                                  	; 14/11/2024
   689                                  	;mov	al, 3	; 0 = max, 31 = min
   690                                  	; 14/12/2024
   691 0000045C A0[CD280000]            	mov	al, [volume]
   692 00000461 E80F030000              	call	SetPCMOutVolume@
   693                                  	; 15/11/2024
   694                                  	;;call	SetMasterVolume
   695                                  	;call	SetPCMOutVolume
   696                                  
   697                                  	;;;
   698                                  	; 14/11/2024
   699 00000466 E8FD250000              	call	UpdateProgressBar
   700                                  	;;;
   701                                  
   702                                   	; 30/05/2024
   703                                  	; playwav4.asm
   704                                  _2:	
   705 0000046B E8FA230000              	call	check4keyboardstop	; flush keyboard buffer
   706 00000470 72F9                    	jc	short _2		; 07/11/2023
   707                                  
   708                                  ; play the .wav file. Most of the good stuff is in here.
   709                                  
   710                                  	; 05/12/2024
   711                                  	; 02/12/2024
   712                                  	;mov	eax, [_bdl_buffer]	; BDL_BUFFER physical address
   713                                  ;_3:
   714 00000472 E8EA000000              	call    PlayWav
   715                                  
   716                                  	; 30/12/2024
   717                                  	; 29/12/2024 (vgaplay3.s)
   718                                  	; 27/12/2024 (vgaplay.s)
   719                                  _3:
   720                                  
   721                                  ; close the .wav file and exit.
   722                                  
   723                                  	; 25/12/2024
   724 00000477 E878030000              	call	closeFile
   725                                  
   726                                  	; 25/12/2024
   727                                  	;;;
   728                                  	; reset file loading and EOF parameters
   729                                  	; 18/12/2024
   730 0000047C C705[AC370000]0000-     	mov	dword [count], 0
   730 00000484 0000               
   731 00000486 C705[B0370000]0000-     	mov	dword [LoadedDataBytes], 0
   731 0000048E 0000               
   732 00000490 C605[26370000]00        	mov	byte [flags], 0
   733 00000497 C605[E8360000]00        	mov	byte [stopped], 0
   734                                  	; 29/12/2024
   735 0000049E C705[F0360000]0000-     	mov	dword [pbuf_s], 0
   735 000004A6 0000               
   736                                  	;;;
   737                                  
   738 000004A8 803D[F6360000]51        	cmp	byte [command], 'Q'
   739 000004AF 7405                    	je	short terminate
   740 000004B1 E9E2FBFFFF              	jmp	check_p_command
   741                                  
   742                                  terminate:
   743 000004B6 E899000000              	call	set_text_mode
   744                                  Exit:
   745                                  	sys	_exit
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97                              <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99                              <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101                              <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000004BB B801000000          <1>  mov eax, %1
   106                              <1> 
   107 000004C0 CD40                <1>  int 40h
   746                                  halt:
   747 000004C2 EBFE                    	jmp	short halt
   748                                  
   749                                  ; -------------------------------------------------------------
   750                                  
   751                                  	; 30/05/2024
   752                                  pmsg_usage:
   753                                  	; 21/12/2024
   754 000004C4 E88B000000              	call	set_text_mode
   755                                  	; 01/12/2024
   756                                  	sys	_msg, msg_usage, 255, 0Fh
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000004C9 BB[1F2C0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000004CE B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000004D3 BA0F000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000004D8 B823000000          <1>  mov eax, %1
   106                              <1> 
   107 000004DD CD40                <1>  int 40h
   757 000004DF EBDA                    	jmp	short Exit
   758                                  
   759                                  ; -------------------------------------------------------------
   760                                  
   761                                  	; 30/05/2024
   762                                  init_err:
   763                                  	; 21/12/2024
   764 000004E1 E86E000000              	call	set_text_mode
   765                                  	; 01/12/2024
   766                                  	sys	_msg, msg_init_err, 255, 0Fh
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000004E6 BB[B32C0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000004EB B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000004F0 BA0F000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000004F5 B823000000          <1>  mov eax, %1
   106                              <1> 
   107 000004FA CD40                <1>  int 40h
   767 000004FC EBBD                    	jmp	short Exit
   768                                  
   769                                  ; -------------------------------------------------------------
   770                                  
   771                                  	; 07/12/2024
   772                                  error_exit:
   773                                  	; 21/12/2024
   774 000004FE E851000000              	call	set_text_mode
   775                                  trdos386_error:
   776                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00000503 BB[932C0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000508 B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 0000050D BA0E000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000512 B823000000          <1>  mov eax, %1
   106                              <1> 
   107 00000517 CD40                <1>  int 40h
   777 00000519 EBA0                    	jmp	short Exit
   778                                  
   779                                  ; -------------------------------------------------------------
   780                                  
   781                                  	; 21/12/2024
   782                                  print_msg:
   783 0000051B B40E                    	mov	ah, 0Eh
   784 0000051D BB07000000              	mov	ebx, 7
   785                                  	;mov	bl, 7 ; char attribute & color
   786                                  p_next_chr:
   787 00000522 AC                      	lodsb
   788 00000523 08C0                    	or	al, al
   789 00000525 7404                    	jz	short p_retn ; retn
   790 00000527 CD31                    	int	31h
   791 00000529 EBF7                    	jmp	short p_next_chr
   792                                  p_retn:
   793 0000052B C3                      	retn
   794                                  
   795                                  ; -------------------------------------------------------------
   796                                  
   797                                  	; 30/12/2024
   798                                  clearscreen:
   799                                  	; fast clear
   800                                  	; 320*200, 256 colors
   801 0000052C BF00000A00              	mov	edi, 0A0000h
   802 00000531 B9803E0000              	mov	ecx, (320*200*1)/4
   803 00000536 31C0                    	xor	eax, eax
   804 00000538 F3AB                    	rep	stosd
   805 0000053A C3                      	retn
   806                                  
   807                                  ; -------------------------------------------------------------
   808                                  
   809                                  	; 31/12/2024 (int 31h)
   810                                  	; 30/12/2024 (VGA Mode 13h, 320*200 pixels, 256 colors)
   811                                  	; 26/12/2024
   812                                  	; 21/12/2024
   813                                  drawplayingscreen:
   814 0000053B BD[0C2E0000]            	mov	ebp, PlayingScreen
   815                                  
   816                                  ; 31/12/2024
   817                                  %if 0
   818                                  	;mov	esi, 0 ; row 0, column 0
   819                                  	mov	esi, 00020000h ; row 2, column 0 ; top margin = 2
   820                                  p_d_x:
   821                                  	mov	byte [columns], 40
   822                                  	mov	dh, 01h ; 8x8 system font
   823                                  p_d_x_n:
   824                                  	mov	dl, [ebp]
   825                                  	and	dl, dl
   826                                  	jz	short p_d_x_ok
   827                                  
   828                                  	; sysvideo system call
   829                                  	; BH = 01h = VGA graphics (0A0000h) data transfers
   830                                  	; BL = 0Fh = write character/font
   831                                  	; DH = 01h = 8*8 system font 
   832                                  	; CL = 0Fh = color (white)
   833                                  	; ESI = cursor/writing position (pixels)
   834                                  	;	HW = row, SI = column
   835                                  
   836                                  	sys	_video, 010Fh, 0Fh
   837                                  
   838                                  	inc	ebp
   839                                  	add	si, 8 ; next char pos
   840                                  	dec	byte [columns]
   841                                  	jnz	short p_d_x_n	; next column
   842                                  	xor	si, si
   843                                  	add	esi, 00080000h	; next row ; 8*8
   844                                  	jmp	short p_d_x
   845                                  p_d_x_ok:
   846                                  	retn
   847                                  %endif
   848                                  	; 31/12/2024
   849 00000540 B800130000              	mov	eax, 1300h ; write character string
   850 00000545 BB0F000000              	mov	ebx, 0Fh
   851 0000054A B9C0030000              	mov	ecx, 24*40
   852 0000054F 31D2                    	xor	edx, edx
   853                                  	;int	10h
   854 00000551 CD31                    	int	31h
   855                                  
   856 00000553 C3                      	retn
   857                                  
   858                                  ; -------------------------------------------------------------
   859                                  
   860                                  	; 21/12/2024
   861                                  set_text_mode:
   862 00000554 30E4                    	xor    ah, ah
   863 00000556 B003                    	mov    al, 3                        
   864                                   	;int   10h ; al = 03h text mode, int 10 video
   865 00000558 CD31                    	int    31h ; TRDOS 386 - Video interrupt
   866 0000055A C3                      	retn
   867                                  
   868                                  ; -------------------------------------------------------------
   869                                  
   870                                  	; 02/12/2024
   871                                  Player_Quit@:
   872 0000055B 58                      	pop	eax ; return addr (call PlayWav@)
   873                                  	
   874                                  	; 29/11/2024
   875                                  Player_Quit:
   876 0000055C E955FFFFFF              	jmp	 terminate
   877                                  
   878                                  ; -------------------------------------------------------------
   879                                  
   880                                  	; 30/12/2024 (cgaplay.s)
   881                                  	; 29/12/2024 (vgaplay3.s)
   882                                  	; 02/12/2024 (ac97play.s)
   883                                  PlayWav:
   884                                  	; 30/12/2024
   885 00000561 A1[B8370000]            	mov	eax, [_bdl_buffer] ; BDL_BUFFER physical address
   886 00000566 09C0                    	or	eax, eax
   887 00000568 751D                    	jnz	short PlayWav@
   888                                  
   889                                  	; 29/05/2024
   890                                  	; Allocate memory block (33 pages)
   891                                  	sys	_alloc, BDL_BUFFER, 33*4096, 0	; no upper limit
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 0000056A BB[00400000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 0000056F B900100200          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00000574 BA00000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000579 B82A000000          <1>  mov eax, %1
   106                              <1> 
   107 0000057E CD40                <1>  int 40h
   892                                  	;jc	short Player_Quit ; 01/12/2024
   893 00000580 72D9                    	jc	short Player_Quit@ ; 02/12/2024
   894                                  
   895 00000582 A3[B8370000]            	mov	[_bdl_buffer], eax ; BDL_BUFFER physical address
   896                                  
   897                                  PlayWav@:
   898                                  	; create Buffer Descriptor List
   899                                  
   900                                  	;  Generic Form of Buffer Descriptor
   901                                  	;  ---------------------------------
   902                                  	;  63   62    61-48    47-32   31-0
   903                                  	;  ---  ---  --------  ------- -----
   904                                  	;  IOC  BUP -reserved- Buffer  Buffer
   905                                  	;		      Length   Pointer
   906                                  	;		      [15:0]   [31:0]
   907                                  
   908                                  	; 30/12/2024	
   909                                  
   910 00000587 0500100000              	add	eax, 4096	; WAVBUFFER_1 physical address
   911 0000058C 89C3                    	mov	ebx, eax
   912                                  	;mov	[wav_buffer1], eax
   913                                  	;add	eax, 65536	; WAVBUFFER_2 physical address
   914                                  	;mov	[wav_buffer2], eax
   915                                  
   916 0000058E BF[00400000]            	mov	edi, BDL_BUFFER
   917 00000593 B910000000              	mov	ecx, 16
   918                                  _pw0:
   919                                  	;mov	eax, WAVBUFFER_1
   920 00000598 89D8                    	mov	eax, ebx	; WAVBUFFER_1 physical address
   921 0000059A AB                      	stosd
   922                                  
   923 0000059B A1[A0370000]            	mov	eax, [buffersize]
   924                                  	; 02/12/2024
   925 000005A0 D1E8                    	shr	eax, 1 ; buffer size in word
   926 000005A2 0D00000040              	or	eax, BUP	; tuneloop (without interrupt)
   927 000005A7 AB                      	stosd
   928                                  
   929                                  	;mov	eax, WAVBUFFER_2
   930 000005A8 89D8                    	mov	eax, ebx
   931 000005AA 0500000100              	add	eax, 65536	; WAVBUFFER_2 physical address
   932 000005AF AB                      	stosd
   933                                  
   934 000005B0 A1[A0370000]            	mov	eax, [buffersize]
   935                                  	; 02/12/2024
   936 000005B5 D1E8                    	shr	eax, 1 ; buffer size in word
   937 000005B7 0D00000040              	or	eax, BUP	; tuneloop (without interrupt)
   938 000005BC AB                      	stosd
   939                                  
   940 000005BD E2D9                    	loop	_pw0
   941                                  
   942                                  	; 14/11/2024
   943                                  	;mov	dword [count], ecx ; 0
   944                                  	;mov	dword [LoadedDataBytes], 0
   945                                  
   946                                  RePlayWav:
   947                                  	; 01/12/2024
   948                                  	; load 64k into buffer 1
   949 000005BF BF[00500000]            	mov	edi, WAVBUFFER_1
   950 000005C4 FF15[98370000]          	call	dword [loadfromwavfile]
   951                                  	; 01/12/2024
   952                                  	; 14/11/2024
   953 000005CA A1[AC370000]            	mov	eax, [count]
   954 000005CF 0105[B0370000]          	add	[LoadedDataBytes], eax
   955                                  
   956                                  	; 18/12/2024
   957 000005D5 C705[AC370000]0000-     	mov	dword [count], 0
   957 000005DD 0000               
   958                                  
   959                                  	; and 64k into buffer 2
   960 000005DF BF[00500100]            	mov	edi, WAVBUFFER_2
   961 000005E4 FF15[98370000]          	call	dword [loadfromwavfile]
   962                                  	; 01/12/2024
   963                                  	; 14/11/2024
   964 000005EA A1[AC370000]            	mov	eax, [count]
   965 000005EF 0105[B0370000]          	add	[LoadedDataBytes], eax
   966                                  	
   967                                  	; write NABMBAR+10h with offset of buffer descriptor list
   968                                  
   969                                         	;;mov	eax, BDL_BUFFER
   970                                          ;mov	eax, esi	; BDL_BUFFER physical address
   971                                  
   972                                  	;mov	eax, [_bdl_buffer] ; BDL_BUFFER physical address
   973                                  	; 02/12/2024
   974 000005F5 8B1D[B8370000]          	mov	ebx, [_bdl_buffer]
   975                                  
   976 000005FB 668B15[96370000]        	mov	dx, [NABMBAR]
   977 00000602 6683C210                        add     dx, PO_BDBAR_REG	; set pointer to BDL
   978                                  	;out	dx, eax 		; write to AC97 controller
   979                                  	; 29/05/2024
   980                                  	;mov	ebx, eax ; data, dword
   981                                  	; 02/12/2024
   982                                  	; ebx = [_bdl_buffer] ; data, dword
   983 00000606 B405                    	mov	ah, 5	; write port dword
   984 00000608 CD34                    	int	34h
   985                                  
   986                                  	; 31/05/2024
   987                                  	; 19/05/2024
   988                                  	;call	delay1_4ms
   989                                  
   990 0000060A B01F                            mov	al, 31
   991 0000060C E8D1060000              	call	setLastValidIndex
   992                                  
   993                                  	; 31/05/2024
   994                                  	; 19/05/2024
   995                                  	;call	delay1_4ms
   996                                  
   997                                  	; 17/02/2017
   998 00000611 668B15[96370000]                mov	dx, [NABMBAR]
   999 00000618 6683C21B                        add	dx, PO_CR_REG		; PCM out Control Register
  1000                                          ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
  1001                                  	;			; (LVBI interrupt will not be enabled)
  1002                                  	; 06/11/2023 (TUNELOOP version, without interrupt)
  1003 0000061C B001                    	mov	al, RPBM
  1004                                  	;out	dx, al			; Start bus master operation.
  1005                                  	; 29/05/2024
  1006                                  	; al = data, byte
  1007 0000061E B401                    	mov	ah, 1 ; write port, byte
  1008 00000620 CD34                    	int	34h
  1009                                  
  1010                                  	; 30/12/2024
  1011                                  
  1012                                  ; -------------------------------------------
  1013                                  
  1014                                  	; 30/12/2024 (cgaplay.s)
  1015                                  	; 29/12/2024 (vgaplay3.s)
  1016                                  	; 18/12/2024 (ac97play.s)
  1017                                  	; 01/12/2024 (32bit)
  1018                                  	; 29/11/2024
  1019                                  tuneLoop:
  1020                                  	; 30/05/2024
  1021                                  	; 18/11/2023 (ich_wav4.asm)
  1022                                  	; 08/11/2023
  1023                                  	; 06/11/2023
  1024                                  tLWait:
  1025                                  	; 18/11/2024
  1026 00000622 803D[E8360000]00        	cmp	byte [stopped], 0
  1027                                  	;jna	short tL@
  1028                                  	; 21/11/2024
  1029 00000629 7718                    	ja	short tLWait@
  1030 0000062B A0[EA360000]            	mov	al, [tLP]
  1031 00000630 3C31                    	cmp	al, '1'
  1032 00000632 7458                    	je	short tL1@
  1033 00000634 0F87A3000000            	ja	tL2@
  1034 0000063A B031                    	mov	al, '1'
  1035 0000063C A2[EA360000]            	mov	[tLP], al
  1036 00000641 EB49                    	jmp	short tL1@ 
  1037                                  tLWait@:	; 21/11/2024
  1038                                  	;;;
  1039                                  	; 09/12/2024
  1040 00000643 803D[E8360000]03        	cmp	byte [stopped], 3
  1041 0000064A 0F83DF000000            	jnb	_exitt_
  1042                                  	;;;
  1043 00000650 E857200000              	call	checkUpdateEvents
  1044 00000655 0F82D4000000            	jc	_exitt_
  1045                                  	;;;
  1046                                  	; 29/11/2024
  1047 0000065B 803D[F6360000]4E        	cmp	byte [command], 'N'
  1048 00000662 0F84C7000000            	je	_exitt_
  1049 00000668 803D[F6360000]50        	cmp	byte [command], 'P'
  1050 0000066F 0F84BA000000            	je	_exitt_
  1051                                  	;;;
  1052 00000675 803D[E9360000]30        	cmp	byte [tLO], '0'
  1053 0000067C 74A4                    	je	short tLWait
  1054 0000067E E8B6000000              	call	tLZ
  1055 00000683 C605[E9360000]30        	mov	byte [tLO], '0'
  1056 0000068A EB96                    	jmp	short tLWait
  1057                                  
  1058                                  ;tLO:	db 0
  1059                                  	
  1060                                  tL1@:
  1061                                  	;mov	al, '1'
  1062                                  	; 19/11/2024
  1063 0000068C A2[E9360000]            	mov	[tLO], al
  1064 00000691 E8A5000000              	call	tL0
  1065                                  tL1:
  1066 00000696 E80A060000              	call	updateLVI	; /set LVI != CIV/
  1067 0000069B 0F848E000000            	jz	_exitt_		; 08/11/2023
  1068                                  	;;;
  1069                                  	;call	check4keyboardstop
  1070                                  	; 14/11/2024
  1071 000006A1 E806200000              	call	checkUpdateEvents
  1072 000006A6 0F8283000000            	jc	_exitt_
  1073                                  	; 18/11/2024
  1074 000006AC 803D[E8360000]00        	cmp	byte [stopped], 0
  1075 000006B3 778E                    	ja	short tLWait@	; 21/11/2024
  1076                                  	;;;
  1077 000006B5 E8DB050000              	call	getCurrentIndex
  1078 000006BA A801                    	test	al, BIT0
  1079 000006BC 74D8                    	jz	short tL1	; loop if buffer 2 is not playing
  1080                                  
  1081                                  	; load buffer 1
  1082                                  	;mov	ax, [WAV_BUFFER1]
  1083                                  	; 01/12/2024
  1084 000006BE BF[00500000]            	mov	edi, WAVBUFFER_1	
  1085                                  
  1086                                  	;call	loadFromFile
  1087                                  	; 18/11/2023
  1088                                  	;call	word [loadfromwavfile]
  1089                                  	; 01/12/2024
  1090 000006C3 FF15[98370000]          	call	dword [loadfromwavfile]
  1091 000006C9 7264                    	jc	short _exitt_	; end of file
  1092                                  
  1093                                  	; 14/11/2024
  1094                                  	;mov	ax, [count]
  1095                                  	;add	[LoadedDataBytes], ax
  1096                                  	;adc	word [LoadedDataBytes+2], 0
  1097                                  	; 01/12/2024
  1098 000006CB A1[AC370000]            	mov	eax, [count]
  1099 000006D0 0105[B0370000]          	add	[LoadedDataBytes], eax
  1100                                  
  1101 000006D6 B032                    	mov	al, '2'
  1102                                  	; 21/11/2024
  1103 000006D8 A2[EA360000]            	mov	[tLP], al
  1104                                  tL2@:
  1105                                  	; 19/11/2024
  1106 000006DD A2[E9360000]            	mov	[tLO], al
  1107 000006E2 E854000000              	call	tL0
  1108                                  tL2:
  1109 000006E7 E8B9050000              	call    updateLVI
  1110 000006EC 7441                    	jz	short _exitt_	; 08/11/2023
  1111                                  	;;;
  1112                                  	;call	check4keyboardstop
  1113                                  	; 14/11/2024
  1114 000006EE E8B91F0000              	call	checkUpdateEvents
  1115 000006F3 723A                    	jc	short _exitt_
  1116                                  	; 18/11/2024
  1117 000006F5 803D[E8360000]00        	cmp	byte [stopped], 0
  1118 000006FC 0F8741FFFFFF            	ja	tLWait@		; 21/11/2024 
  1119                                  	;;;
  1120 00000702 E88E050000              	call    getCurrentIndex
  1121 00000707 A801                    	test	al, BIT0
  1122 00000709 75DC                    	jnz	short tL2	; loop if buffer 1 is not playing
  1123                                  
  1124                                  	; load buffer 2
  1125                                  	;mov	ax, [WAV_BUFFER2]
  1126                                  	; 01/12/2024
  1127 0000070B BF[00500100]            	mov	edi, WAVBUFFER_2
  1128                                  	;call	loadFromFile
  1129                                  	; 18/11/2023
  1130                                  	;call	word [loadfromwavfile]
  1131                                  	; 01/12/2024
  1132 00000710 FF15[98370000]          	call	dword [loadfromwavfile]
  1133                                  	;jnc	short tuneLoop
  1134 00000716 7217                    	jc	short _exitt_
  1135                                  
  1136                                  	; 14/11/2024
  1137                                  	;mov	ax, [count]
  1138                                  	;add	[LoadedDataBytes], ax
  1139                                  	;adc	word [LoadedDataBytes+2], 0
  1140                                  	; 01/12/2024
  1141 00000718 A1[AC370000]            	mov	eax, [count]
  1142 0000071D 0105[B0370000]          	add	[LoadedDataBytes], eax	
  1143                                  
  1144                                  	; 21/11/2024
  1145 00000723 C605[EA360000]31        	mov	byte [tLP], '1'
  1146 0000072A E9F3FEFFFF              	jmp	tuneLoop
  1147                                  
  1148                                  	; 29/12/2024 (vgaplay3.s)
  1149                                  _exitt_:
  1150                                  	; 07/12/2024
  1151                                  	; Stop Playing
  1152                                  	;mov	byte [stopped], 2
  1153                                  	;sys	_audio, 0700h
  1154 0000072F E8F3040000              	call	ac97_stop
  1155                                  
  1156                                  	;;;
  1157                                  	; 14/11/2024
  1158 00000734 E82F230000              	call	UpdateProgressBar
  1159                                  	;;;
  1160                                  
  1161                                  	; 18/11/2024
  1162                                  tLZ:
  1163                                  	; 30/05/2024
  1164 00000739 B030                    	mov	al, '0'
  1165                                  
  1166                                  	;add	al, '0'
  1167                                  	;call	tL0
  1168                                  	;
  1169                                  	;retn
  1170                                  	; 06/11/2023
  1171                                  	;jmp	short tL0
  1172                                  	;retn
  1173                                  
  1174                                  tL0:
  1175                                  	; 31/12/2024 (int 31h)
  1176                                  	; 30/12/2024 (cgaplay.s)
  1177                                  	; 29/05/2024 (TRDOS 386)
  1178                                  	; 08/11/2023
  1179                                  	; 05/11/2023
  1180                                  	; 17/02/2017 - Buffer switch test (temporary)
  1181                                  	; 06/11/2023
  1182                                  	; al = buffer indicator ('1', '2' or '0' -stop- )
  1183                                  
  1184                                  	; 30/12/2024 (video mode 13h modification)
  1185                                  	; (320*200, 256 colors)
  1186                                  	;;;
  1187 0000073B 88C2                    	mov	dl, al ; character
  1188 0000073D BF00000A00              	mov	edi, 0A0000h
  1189                                  
  1190 00000742 BB08000000              	mov	ebx, 8 ; 8 pixels (8*8 pixels font)
  1191                                  
  1192 00000747 B00C                    	mov	al, 0Ch ; red
  1193                                  tL0_1:
  1194                                  	;mov	ecx, 8 ; 8 pixels (8*8 pixels font)
  1195 00000749 B907000000              	mov	ecx, 7
  1196                                  tL0_2:
  1197 0000074E AA                      	stosb
  1198 0000074F 49                      	dec	ecx
  1199 00000750 75FC                    	jnz	short tL0_2
  1200 00000752 4B                      	dec	ebx
  1201 00000753 7408                    	jz	short tL0_3
  1202                                  	;add	edi, 320-8 ; next line
  1203 00000755 81C739010000            	add	edi, 320-7
  1204 0000075B EBEC                    	jmp	short tL0_1
  1205                                  tL0_3:
  1206                                  
  1207                                  ; 31/12/2024
  1208                                  %if 0
  1209                                  	; write system font
  1210                                  	mov	dh, 01h
  1211                                  	;mov	dl, al ; character
  1212                                  	xor	esi, esi ; = row 0, column 0
  1213                                  	sys	_video, 010Fh, 0Eh ; yellow
  1214                                  	;;;
  1215                                  %endif
  1216                                  	; 31/12/2024
  1217 0000075D 52                      	push	edx
  1218 0000075E 31D2                    	xor	edx, edx ; row 0, column 0
  1219 00000760 E869210000              	call	setCursorPosition
  1220 00000765 58                      	pop	eax
  1221                                  	;
  1222 00000766 B40E                    	mov	ah, 0Eh
  1223 00000768 BB0E000000              	mov	ebx, 0Eh
  1224                                  	;int	10h
  1225 0000076D CD31                    	int	31h
  1226                                  	
  1227 0000076F C3                      	retn
  1228                                  
  1229                                  ; -------------------------------------------
  1230                                  
  1231                                  	; 29/12/2024 (vgaplay3.s)
  1232                                  	; 18/12/2024 (ac97play.s)
  1233                                  	; 14/11/2024
  1234                                  ;SetMasterVolume:
  1235                                  	; 15/11/2024
  1236                                  SetPCMOutVolume:
  1237                                  	;cmp	al, 31
  1238                                  	;ja	short setvolume_ok
  1239 00000770 A2[CD280000]            	mov	[volume], al  ; max = 0, min = 31
  1240                                  SetPCMOutVolume@:	; 19/11/2024
  1241 00000775 88C4                    	mov	ah, al
  1242 00000777 668B15[94370000]        	mov	dx, [NAMBAR]
  1243                                  	; 15/11/2024 (QEMU)
  1244                                    	;add	dx, CODEC_MASTER_VOL_REG
  1245 0000077E 6683C218                	add	dx, CODEC_PCM_OUT_REG
  1246                                  	;out	dx, ax
  1247                                  	; 01/12/2024
  1248                                  	; bx = data, word
  1249                                  	; 03/12/2024
  1250 00000782 89C3                    	mov	ebx, eax
  1251 00000784 B403                    	mov	ah, 3  ; write port, word
  1252 00000786 CD34                    	int	34h
  1253                                  ;setvolume_ok:
  1254 00000788 C3                      	retn
  1255                                  
  1256                                  ; -------------------------------------------
  1257                                  
  1258                                  	; 29/12/2024 (vgaplay3.s)
  1259                                  	; 18/12/2024 (ac97play.s)
  1260                                  	; 30/05/2024
  1261                                  DetectAC97:
  1262                                  DetectICH:
  1263                                  	; 22/11/2023
  1264                                  	; 19/11/2023
  1265                                  	; 01/11/2023 - TRDOS 386 Kernel v2.0.7
  1266                                  	;; 10/06/2017
  1267                                  	;; 05/06/2017
  1268                                  	;; 29/05/2017
  1269                                  	;; 28/05/2017
  1270                                  
  1271                                  	; 01/12/2024
  1272                                  	; 19/11/2023
  1273 00000789 BE[542B0000]            	mov	esi, valid_ids	; address of Valid ICH (AC97) Device IDs
  1274 0000078E B915000000              	mov	ecx, valid_id_count
  1275                                  pfd_1:
  1276 00000793 AD                      	lodsd
  1277 00000794 E8A8000000              	call	pciFindDevice
  1278 00000799 7303                    	jnc	short d_ac97_1
  1279 0000079B E2F6                    	loop	pfd_1
  1280                                  
  1281                                  	;stc
  1282 0000079D C3                      	retn
  1283                                  
  1284                                  d_ac97_1:
  1285                                  	; eax = BUS/DEV/FN
  1286                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1287                                  	; edx = DEV/VENDOR
  1288                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1289                                  
  1290                                  	; playwav4.asm - 19/05/2024
  1291                                  
  1292 0000079E A3[8C370000]            	mov	[bus_dev_fn], eax
  1293 000007A3 8915[90370000]          	mov	[dev_vendor], edx
  1294                                  
  1295                                  	; get ICH base address regs for mixer and bus master
  1296                                  
  1297 000007A9 B010                            mov     al, NAMBAR_REG
  1298 000007AB E81F010000                      call    pciRegRead16			; read PCI registers 10-11
  1299                                          ;and    dx, IO_ADDR_MASK 		; mask off BIT0
  1300                                  	; 19/05/2024
  1301 000007B0 80E2FE                  	and	dl, 0FEh
  1302                                  
  1303 000007B3 668915[94370000]                mov     [NAMBAR], dx			; save audio mixer base addr
  1304                                  
  1305 000007BA B014                    	mov     al, NABMBAR_REG
  1306 000007BC E80E010000                      call    pciRegRead16
  1307                                          ;and    dx, IO_ADDR_MASK
  1308                                  	; 19/05/2024
  1309 000007C1 80E2C0                  	and	dl, 0C0h
  1310                                  
  1311 000007C4 668915[96370000]                mov     [NABMBAR], dx			; save bus master base addr
  1312                                  
  1313 000007CB B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
  1314 000007CD E8F6000000              	call	pciRegRead8 ; 17/02/2017
  1315                                  	
  1316 000007D2 8815[27370000]          	mov	[ac97_int_ln_reg], dl
  1317                                  
  1318                                  	;clc
  1319                                  
  1320 000007D8 C3                      	retn
  1321                                  
  1322                                  ; ----------------------------------
  1323                                  	
  1324                                  	; 26/12/2024
  1325                                  	; 07/12/2024
  1326                                  	; 01/12/2024
  1327                                  	; 14/11/2024
  1328                                  	; INPUT: ds:dx = file name address
  1329                                  	; OUTPUT: [filehandle] = ; -1 = not open
  1330                                  openFile:
  1331                                  	; 26/12/2024
  1332                                  	; 01/12/2024
  1333                                  	sys	_open, edx, 0
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000007D9 89D3                <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000007DB B900000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101                              <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000007E0 B805000000          <1>  mov eax, %1
   106                              <1> 
   107 000007E5 CD40                <1>  int 40h
  1334                                  	; 07/12/2024
  1335                                  	;sys	_open, wav_file_name, 0
  1336 000007E7 7305                    	jnc	short _of1
  1337                                  
  1338 000007E9 B8FFFFFFFF              	mov	eax, -1
  1339                                  	; cf = 1 -> not found or access error
  1340                                  _of1:
  1341 000007EE A3[28370000]            	mov	[filehandle], eax
  1342 000007F3 C3                      	retn
  1343                                  
  1344                                  ; ----------------------------------
  1345                                  
  1346                                  ; close the currently open file
  1347                                  
  1348                                  	; 01/12/2024
  1349                                  	; 14/11/2024
  1350                                  	; INPUT: [filehandle] ; -1 = not open
  1351                                  	; OUTPUT: none
  1352                                  closeFile:
  1353 000007F4 833D[28370000]FF        	cmp	dword [filehandle], -1
  1354 000007FB 740D                    	jz	short _cf1
  1355                                  	; 01/12/2024
  1356                                  	sys	_close, [filehandle]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000007FD 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99                              <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101                              <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000803 B806000000          <1>  mov eax, %1
   106                              <1> 
   107 00000808 CD40                <1>  int 40h
  1357                                  	;mov 	dword [filehandle], -1
  1358                                  _cf1:
  1359 0000080A C3                      	retn
  1360                                  
  1361                                  ; ----------------------------------
  1362                                  
  1363                                  	; 01/12/2024
  1364                                  	; 14/11/2024 - Erdogan Tan
  1365                                  getWAVParameters:
  1366                                  ; reads WAV file header(s) (44 bytes) from the .wav file.
  1367                                  ; entry: none - assumes file is already open
  1368                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
  1369                                  ;	cx = number of channels (mono=1, stereo=2)
  1370                                  ;	dx = bits per sample (8, 16)
  1371                                  ;	bx = number of bytes per sample (1 to 4)
  1372                                  
  1373                                          ;mov	dx, WAVFILEHEADERbuff
  1374                                  	;mov	bx, [filehandle]
  1375                                          ;mov	cx, 44			; 44 bytes
  1376                                  	;mov	ah, 3Fh
  1377                                          ;int	21h
  1378                                  	;jc	short gwavp_retn
  1379                                  	; 01/12/2024 (TRDOS 386)
  1380                                  	sys	_read, [filehandle], WAVFILEHEADERbuff, 44
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 0000080B 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000811 B9[F8360000]        <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00000816 BA2C000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 0000081B B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00000820 CD40                <1>  int 40h
  1381 00000822 721C                    	jc	short gwavp_retn
  1382                                  
  1383 00000824 83F82C                  	cmp	eax, 44
  1384 00000827 7217                    	jb	short gwavp_retn
  1385                                  
  1386 00000829 813D[00370000]5741-     	cmp	dword [RIFF_Format], 'WAVE'
  1386 00000831 5645               
  1387 00000833 750A                    	jne	short gwavp_stc_retn
  1388                                  
  1389 00000835 66833D[0C370000]01      	cmp	word [WAVE_AudioFormat], 1 ; Offset 20, must be 1 (= PCM)
  1390                                  	;jne	short gwavp_stc_retn
  1391 0000083D 7401                    	je	short gwavp_retn ; 15/11/2024
  1392                                  
  1393                                  	; 15/11/2024
  1394                                  	;mov	cx, [WAVE_NumChannels]	; return num of channels in CX
  1395                                          ;mov    ax, [WAVE_SampleRate]	; return sample rate in AX
  1396                                  	;mov	dx, [WAVE_BitsPerSample] 
  1397                                  					; return bits per sample value in DX
  1398                                  	;mov	bx, [WAVE_BlockAlign]	; return bytes per sample in BX
  1399                                  ;gwavp_retn:
  1400                                          ;retn
  1401                                  
  1402                                  gwavp_stc_retn:
  1403 0000083F F9                      	stc
  1404                                  gwavp_retn:
  1405 00000840 C3                      	retn
  1406                                  
  1407                                  
  1408                                  ; 29/12/2024 (vgaplay3.s)
  1409                                  ; 18/12/2024 (ac97play.s)
  1410                                  ; --------------------------------------------------------
  1411                                  ; 27/05/2024 - (TRDOS 386 Kernel) audio.s
  1412                                  ; --------------------------------------------------------
  1413                                  
  1414                                  NOT_PCI32_PCI16	EQU 03FFFFFFFh ; NOT BIT31+BIT30 ; 19/03/2017
  1415                                  NOT_BIT31 EQU 7FFFFFFFh
  1416                                  
  1417                                  pciFindDevice:
  1418                                  	; 19/11/2023
  1419                                  	; 03/04/2017 ('pci.asm', 20/03/2017)
  1420                                  	;
  1421                                  	; scan through PCI space looking for a device+vendor ID
  1422                                  	;
  1423                                  	; Entry: EAX=Device+Vendor ID
  1424                                  	;
  1425                                  	; Exit: EAX=PCI address if device found
  1426                                  	;	EDX=Device+Vendor ID
  1427                                  	;       CY clear if found, set if not found. EAX invalid if CY set.
  1428                                  	;
  1429                                  	; Destroys: ebx, edi ; 19/11/2023
  1430                                  
  1431                                          ; 19/11/2023
  1432 00000841 89C3                    	mov	ebx, eax
  1433 00000843 BF00000080              	mov	edi, 80000000h
  1434                                  nextPCIdevice:
  1435 00000848 89F8                    	mov 	eax, edi		; read PCI registers
  1436 0000084A E88C000000              	call	pciRegRead32
  1437                                  	; 19/11/2023
  1438 0000084F 39DA                    	cmp	edx, ebx
  1439 00000851 7412                    	je	short PCIScanExit	; found
  1440                                  	; 19/11/2023
  1441 00000853 81FF00F8FF80            	cmp	edi, 80FFF800h
  1442 00000859 7308                    	jnb	short pfd_nf		; not found
  1443 0000085B 81C700010000            	add	edi, 100h
  1444 00000861 EBE5                    	jmp	short nextPCIdevice
  1445                                  pfd_nf:
  1446 00000863 F9                      	stc
  1447 00000864 C3                      	retn
  1448                                  PCIScanExit:
  1449                                  	;pushf
  1450 00000865 B8FFFFFF7F              	mov	eax, NOT_BIT31 	; 19/03/2017
  1451 0000086A 21F8                    	and	eax, edi	; return only bus/dev/fn #
  1452 0000086C C3                      	retn
  1453                                  
  1454                                  pciRegRead:
  1455                                  	; 01/12/2024
  1456                                  	; 03/04/2017 ('pci.asm', 20/03/2017)
  1457                                  	;
  1458                                  	; 8/16/32bit PCI reader
  1459                                  	;
  1460                                  	; Entry: EAX=PCI Bus/Device/fn/register number
  1461                                  	;           BIT30 set if 32 bit access requested
  1462                                  	;           BIT29 set if 16 bit access requested
  1463                                  	;           otherwise defaults to 8 bit read
  1464                                  	;
  1465                                  	; Exit:  DL,DX,EDX register data depending on requested read size
  1466                                  	;
  1467                                  	; Note1: this routine is meant to be called via pciRegRead8,
  1468                                  	;	 pciRegread16 or pciRegRead32, listed below.
  1469                                  	;
  1470                                  	; Note2: don't attempt to read 32 bits of data from a non dword
  1471                                  	;	 aligned reg number. Likewise, don't do 16 bit reads from
  1472                                  	;	 non word aligned reg #
  1473                                  
  1474 0000086D 53                      	push	ebx
  1475 0000086E 51                      	push	ecx
  1476 0000086F 89C3                            mov     ebx, eax		; save eax, dh
  1477 00000871 88F1                            mov     cl, dh
  1478                                  
  1479 00000873 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; clear out data size request
  1480 00000878 0D00000080                      or      eax, BIT31		; make a PCI access request
  1481 0000087D 24FC                            and     al, ~3 ; NOT 3 ; 0FCh	; force index to be dword
  1482                                  
  1483 0000087F 66BAF80C                        mov     dx, PCI_INDEX_PORT
  1484                                          ;out	dx, eax			; write PCI selector
  1485                                  	; 29/05/2024
  1486 00000883 53                      	push	ebx
  1487 00000884 89C3                    	mov	ebx, eax ; data, dword
  1488 00000886 B405                    	mov	ah, 5 ; write port, dword
  1489                                  	; dx = port number
  1490 00000888 CD34                    	int	34h
  1491 0000088A 5B                      	pop	ebx
  1492                                  	
  1493 0000088B 66BAFC0C                        mov     dx, PCI_DATA_PORT
  1494 0000088F 88D8                            mov     al, bl
  1495 00000891 2403                            and     al, 3			; figure out which port to
  1496 00000893 00C2                            add     dl, al			; read to
  1497                                  
  1498 00000895 F7C3000000C0            	test    ebx, PCI32+PCI16
  1499 0000089B 750A                            jnz     short _pregr0
  1500                                  
  1501                                  	;in	al, dx			; return 8 bits of data
  1502                                  	; 29/05/2024
  1503 0000089D B400                    	mov	ah, 0 ; read port, byte
  1504                                  	; dx = port number
  1505 0000089F CD34                    	int	34h
  1506                                          
  1507 000008A1 88C2                    	mov	dl, al
  1508 000008A3 88CE                    	mov     dh, cl			; restore dh for 8 bit read
  1509 000008A5 EB17                    	jmp	short _pregr2
  1510                                  _pregr0:	
  1511 000008A7 F7C300000080            	test    ebx, PCI32
  1512 000008AD 7509                            jnz	short _pregr1
  1513                                  
  1514                                  	;in	ax, dx
  1515                                  	; 29/05/2024
  1516 000008AF B402                    	mov	ah, 2 ; read port, word
  1517                                  	; dx = port number
  1518 000008B1 CD34                    	int	34h
  1519                                  
  1520 000008B3 6689C2                  	mov     dx, ax			; return 16 bits of data
  1521 000008B6 EB06                    	jmp	short _pregr2
  1522                                  _pregr1:
  1523                                  	;in	eax, dx			; return 32 bits of data
  1524                                  	; 29/05/2024
  1525 000008B8 B404                    	mov	ah, 4 ; read port, dword
  1526                                  	; dx = port number
  1527 000008BA CD34                    	int	34h
  1528                                  
  1529 000008BC 89C2                    	mov	edx, eax
  1530                                  _pregr2:
  1531 000008BE 89D8                    	mov     eax, ebx		; restore eax
  1532 000008C0 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; clear out data size request
  1533 000008C5 59                      	pop	ecx
  1534 000008C6 5B                      	pop	ebx
  1535 000008C7 C3                      	retn
  1536                                  
  1537                                  pciRegRead8:
  1538 000008C8 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 8 bit read size
  1539 000008CD EB9E                            jmp     short pciRegRead	; call generic PCI access
  1540                                  
  1541                                  pciRegRead16:
  1542 000008CF 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 16 bit read size
  1543 000008D4 0D00000040                      or      eax, PCI16		; call generic PCI access
  1544 000008D9 EB92                            jmp     short pciRegRead
  1545                                  
  1546                                  pciRegRead32:
  1547 000008DB 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 32 bit read size
  1548 000008E0 0D00000080                      or      eax, PCI32		; call generic PCI access
  1549 000008E5 EB86                            jmp     pciRegRead
  1550                                  
  1551                                  pciRegWrite:
  1552                                  	; 01/12/2024
  1553                                  	; 03/04/2017 ('pci.asm', 29/11/2016)
  1554                                  	;
  1555                                  	; 8/16/32bit PCI writer
  1556                                  	;
  1557                                  	; Entry: EAX=PCI Bus/Device/fn/register number
  1558                                  	;           BIT31 set if 32 bit access requested
  1559                                  	;           BIT30 set if 16 bit access requested
  1560                                  	;           otherwise defaults to 8bit read
  1561                                  	;        DL/DX/EDX data to write depending on size
  1562                                  	;
  1563                                  	; Note1: this routine is meant to be called via pciRegWrite8,
  1564                                  	;	 pciRegWrite16 or pciRegWrite32 as detailed below.
  1565                                  	;
  1566                                  	; Note2: don't attempt to write 32bits of data from a non dword
  1567                                  	;	 aligned reg number. Likewise, don't do 16 bit writes from
  1568                                  	;	 non word aligned reg #
  1569                                  
  1570 000008E7 53                      	push	ebx
  1571 000008E8 51                      	push	ecx
  1572 000008E9 89C3                            mov     ebx, eax		; save eax, edx
  1573 000008EB 89D1                            mov     ecx, edx
  1574 000008ED 25FFFFFF3F              	and     eax, NOT_PCI32_PCI16	; clear out data size request
  1575 000008F2 0D00000080                      or      eax, BIT31		; make a PCI access request
  1576 000008F7 24FC                            and     al, ~3 ; NOT 3 ; 0FCh	; force index to be dword
  1577                                  
  1578 000008F9 66BAF80C                        mov     dx, PCI_INDEX_PORT
  1579                                  	;out	dx, eax			; write PCI selector
  1580                                  	; 29/05/2024
  1581 000008FD 53                      	push	ebx
  1582 000008FE 89C3                    	mov	ebx, eax ; data, dword
  1583 00000900 B405                    	mov	ah, 5 ; write port, dword
  1584                                  	; dx = port number
  1585 00000902 CD34                    	int	34h
  1586 00000904 5B                      	pop	ebx
  1587                                  	
  1588 00000905 66BAFC0C                        mov     dx, PCI_DATA_PORT
  1589 00000909 88D8                            mov     al, bl
  1590 0000090B 2403                            and     al, 3			; figure out which port to
  1591 0000090D 00C2                            add     dl, al			; write to
  1592                                  
  1593 0000090F F7C3000000C0            	test    ebx, PCI32+PCI16
  1594 00000915 7508                            jnz     short _pregw0
  1595 00000917 88C8                    	mov	al, cl 			; put data into al
  1596                                  	;out	dx, al
  1597                                  	; 29/05/2024
  1598                                  	; al = data, byte
  1599 00000919 B401                    	mov	ah, 1 ; write port, byte
  1600                                  	; dx = port number
  1601 0000091B CD34                    	int	34h
  1602                                  
  1603 0000091D EB1F                    	jmp	short _pregw2
  1604                                  _pregw0:
  1605 0000091F F7C300000080            	test    ebx, PCI32
  1606 00000925 750D                            jnz     short _pregw1
  1607 00000927 6689C8                  	mov	ax, cx			; put data into ax
  1608                                  	;out	dx, ax
  1609                                  	; 29/05/2024
  1610 0000092A 53                      	push	ebx
  1611 0000092B 89C3                    	mov	ebx, eax ; data, word
  1612 0000092D B403                    	mov	ah, 3 ; write port, word
  1613                                  	; dx = port number
  1614 0000092F CD34                    	int	34h
  1615 00000931 5B                      	pop	ebx
  1616                                  
  1617 00000932 EB0A                    	jmp	short _pregw2
  1618                                  _pregw1:
  1619 00000934 89C8                    	mov	eax, ecx		; put data into eax
  1620                                  	;out	dx, eax
  1621                                  	; 29/05/2024
  1622 00000936 53                      	push	ebx
  1623 00000937 89C3                    	mov	ebx, eax ; data, dword
  1624 00000939 B405                    	mov	ah, 5 ; write port, dword
  1625                                  	; dx = port number
  1626 0000093B CD34                    	int	34h
  1627 0000093D 5B                      	pop	ebx
  1628                                  _pregw2:
  1629 0000093E 89D8                            mov     eax, ebx		; restore eax
  1630 00000940 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; clear out data size request
  1631 00000945 89CA                            mov     edx, ecx		; restore dx
  1632 00000947 59                      	pop	ecx
  1633 00000948 5B                      	pop	ebx
  1634 00000949 C3                      	retn
  1635                                  
  1636                                  pciRegWrite8:
  1637 0000094A 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 8 bit write size
  1638 0000094F EB96                            jmp	short pciRegWrite	; call generic PCI access
  1639                                  
  1640                                  pciRegWrite16:
  1641 00000951 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 16 bit write size
  1642 00000956 0D00000040                      or      eax, PCI16		; call generic PCI access
  1643 0000095B EB8A                            jmp	short pciRegWrite
  1644                                  
  1645                                  pciRegWrite32:
  1646 0000095D 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 32 bit write size
  1647 00000962 0D00000080                      or      eax, PCI32		; call generic PCI access
  1648 00000967 E97BFFFFFF                      jmp	pciRegWrite
  1649                                  
  1650                                  ; --------------------------------------------------------
  1651                                  ; 19/05/2024 - (playwav4.asm) ac97_vra.asm
  1652                                  ; --------------------------------------------------------
  1653                                  
  1654                                  	; 13/11/2023
  1655                                  
  1656                                  ;VRA:	db 1
  1657                                  
  1658                                  codecConfig:
  1659                                  	; 01/12/2024 (ac97play.s)
  1660                                  	; 29/05/2024 (playwav7.s modification)
  1661                                  	; 19/05/2024
  1662                                  	; 19/11/2023
  1663                                  	; 15/11/2023
  1664                                  	; 04/11/2023
  1665                                  	; 17/02/2017 
  1666                                  	; 07/11/2016 (Erdogan Tan)
  1667                                  
  1668                                  	;AC97_EA_VRA equ 1
  1669                                  	AC97_EA_VRA equ BIT0
  1670                                  
  1671                                  	; 04/11/2023
  1672                                  init_ac97_controller:
  1673 0000096C A1[8C370000]            	mov	eax, [bus_dev_fn]
  1674 00000971 B004                    	mov	al, PCI_CMD_REG
  1675 00000973 E857FFFFFF              	call	pciRegRead16		; read PCI command register
  1676 00000978 80CA05                  	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
  1677 0000097B E8D1FFFFFF              	call	pciRegWrite16
  1678                                  
  1679                                  	;call	delay_100ms
  1680                                  
  1681                                  	; 19/05/2024
  1682                                  	; ('PLAYMOD3.ASM', Erdogan Tan, 18/05/2024)
  1683                                  
  1684                                  init_ac97_codec:
  1685                                  	; 18/11/2023
  1686 00000980 BD28000000              	mov	ebp, 40
  1687                                  	; 29/05/2024
  1688                                  	;mov	ebp, 1000
  1689                                  _initc_1:
  1690                                  	; 29/05/2024
  1691 00000985 66BA3000                	mov	dx, GLOB_STS_REG ; 30h
  1692 00000989 660315[96370000]        	add	dx, [NABMBAR]
  1693                                  	;in	eax, dx
  1694 00000990 B404                    	mov	ah, 4	; read port, dword
  1695 00000992 CD34                    	int	34h
  1696                                  
  1697                                  	; 19/05/2024
  1698                                  	;call	delay1_4ms
  1699                                  
  1700 00000994 83F8FF                  	cmp	eax, 0FFFFFFFFh ; -1
  1701 00000997 750A                    	jne	short _initc_3
  1702                                  _initc_2:
  1703 00000999 4D                      	dec	ebp
  1704 0000099A 7425                    	jz	short _ac97_codec_ready
  1705                                  
  1706                                  	; 31/05/2024
  1707 0000099C E8B3020000              	call	delay_100ms
  1708 000009A1 EBE2                    	jmp	short _initc_1
  1709                                  _initc_3:
  1710 000009A3 A900030010              	test	eax, CTRL_ST_CREADY
  1711 000009A8 7517                    	jnz	short _ac97_codec_ready
  1712                                  
  1713                                  	; 30/05/2024
  1714 000009AA 803D[F52B0000]01        	cmp	byte [reset], 1
  1715 000009B1 73E6                    	jnb	short _initc_2
  1716                                  
  1717 000009B3 E893010000              	call	reset_ac97_codec
  1718                                  	; 30/05/2024
  1719 000009B8 C605[F52B0000]01        	mov	byte [reset], 1
  1720                                  	; 19/05/2024
  1721 000009BF EBD8                    	jmp	short _initc_2
  1722                                  
  1723                                  _ac97_codec_ready:
  1724 000009C1 668B15[94370000]        	mov	dx, [NAMBAR]
  1725                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1726                                  	;out	dx, ax
  1727                                  	; 29/05/2024
  1728 000009C8 53                      	push	ebx
  1729 000009C9 89C3                    	mov	ebx, eax ; bx = data, word
  1730 000009CB B403                    	mov	ah, 3	; write port, word
  1731 000009CD CD34                    	int	34h
  1732 000009CF 5B                      	pop	ebx
  1733                                  
  1734                                  	; 31/05/2024
  1735                                  	; 29/05/2024
  1736                                  	;call	delay_100ms
  1737                                  
  1738                                  	; 19/11/2023
  1739 000009D0 09ED                    	or	ebp, ebp
  1740 000009D2 7539                    	jnz	short _ac97_codec_init_ok
  1741                                  
  1742 000009D4 31C0                    	xor	eax, eax ; 0
  1743 000009D6 668B15[94370000]        	mov	dx, [NAMBAR]
  1744 000009DD 6683C226                	add	dx, CODEC_REG_POWERDOWN
  1745                                  	;out	dx, ax
  1746                                  	; 29/05/2024
  1747 000009E1 53                      	push	ebx
  1748 000009E2 89C3                    	mov	ebx, eax
  1749 000009E4 B403                    	mov	ah, 3	; write port, word
  1750 000009E6 CD34                    	int	34h
  1751 000009E8 5B                      	pop	ebx
  1752                                  
  1753                                  	; 19/11/2023
  1754                                  	; wait for 1 second
  1755                                  	; 19/05/2024
  1756 000009E9 B9E8030000              	mov	ecx, 1000 ; 1000*4*0.25ms = 1s
  1757                                  	;;mov	ecx, 10
  1758                                  	; 30/05/2024
  1759                                  	;mov	ecx, 40
  1760                                  _ac97_codec_rloop:
  1761                                  	;call	delay_100ms
  1762                                  	; 31/05/2024
  1763 000009EE E870020000              	call	delay1_4ms
  1764                                  
  1765                                  	;mov	dx, [NAMBAR]
  1766                                  	;add	dx, CODEC_REG_POWERDOWN
  1767                                  	;in	ax, dx
  1768                                  	; 29/05/2024
  1769 000009F3 668B15[94370000]        	mov	dx, [NAMBAR]
  1770 000009FA 6683C226                	add	dx, CODEC_REG_POWERDOWN
  1771                                  	; 31/05/2024
  1772 000009FE B402                    	mov	ah, 2	; read port, word
  1773 00000A00 CD34                    	int	34h
  1774                                  
  1775                                  	; 31/05/2024
  1776                                  	;call	delay1_4ms
  1777                                  	
  1778 00000A02 6683E00F                	and	ax, 0Fh
  1779 00000A06 3C0F                    	cmp	al, 0Fh
  1780 00000A08 7403                    	je	short _ac97_codec_init_ok
  1781 00000A0A E2E2                    	loop	_ac97_codec_rloop 
  1782                                  
  1783                                  init_ac97_codec_err1:
  1784                                  	;stc	; cf = 1 ; 19/05/2024
  1785                                  init_ac97_codec_err2:
  1786 00000A0C C3                      	retn
  1787                                  
  1788                                  _ac97_codec_init_ok:
  1789 00000A0D E8DA000000              	call 	reset_ac97_controller
  1790                                  
  1791                                  	; 31/05/2024
  1792                                  	; 30/05/2024
  1793                                  	; 19/05/2024
  1794                                  	;call	delay_100ms
  1795                                  
  1796                                  	; 30/05/2024
  1797                                  	;call	delay1_4ms
  1798                                  	;call	delay1_4ms
  1799                                  	;call	delay1_4ms
  1800                                  	;call	delay1_4ms
  1801                                  
  1802                                  	; 01/12/2024
  1803                                  setup_ac97_codec:
  1804                                  	; 12/11/2023
  1805 00000A12 66813D[10370000]80-     	cmp	word [WAVE_SampleRate], 48000
  1805 00000A1A BB                 
  1806 00000A1B 0F849C000000            	je	skip_rate
  1807                                  	
  1808                                  	; 31/05/2024
  1809                                  	; 30/05/2024
  1810                                  	; 29/05/2024
  1811                                  	;cmp	byte [VRA], 0
  1812                                  	;jna	short skip_rate
  1813                                  
  1814                                  	; 11/11/2023
  1815 00000A21 668B15[94370000]        	mov	dx, [NAMBAR]
  1816 00000A28 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1817                                  	;in	ax, dx
  1818                                  	; 29/05/2024
  1819 00000A2C B402                    	mov	ah, 2 ; read port, word
  1820 00000A2E CD34                    	int	34h
  1821                                  
  1822                                  	; 30/05/2024
  1823                                  	; 19/05/2024
  1824 00000A30 E82E020000              	call	delay1_4ms
  1825                                  
  1826                                  	;and	al, ~BIT1 ; Clear DRA
  1827                                  	;;;
  1828                                  	; 30/05/2024
  1829 00000A35 24FC                    	and	al, ~(BIT1+BIT0) ; Clear DRA+VRA
  1830                                  	; 01/12/2024 (FASM)
  1831                                  	;and	al, NOT (BIT1+BIT0) ; 0FCh
  1832                                  	;out	dx, ax
  1833                                  	; 31/05/2024
  1834 00000A37 53                      	push	ebx
  1835 00000A38 89C3                    	mov	ebx, eax
  1836 00000A3A 668B15[94370000]        	mov	dx, [NAMBAR]
  1837 00000A41 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1838 00000A45 B403                    	mov	ah, 3 ; write port, word
  1839 00000A47 CD34                    	int	34h
  1840 00000A49 5B                      	pop	ebx
  1841                                  
  1842                                  	; 31/05/2024
  1843 00000A4A E8B1010000              	call	check_vra
  1844                                  
  1845                                  	; 31/05/2024 - temporary (interpolated sample rate test)
  1846                                  	;mov	byte [VRA], 0
  1847                                  
  1848                                  	; 31/05/2024
  1849 00000A4F 803D[F5360000]00        	cmp	byte [VRA], 0
  1850 00000A56 7665                    	jna	short skip_rate
  1851                                  
  1852 00000A58 668B15[94370000]        	mov	dx, [NAMBAR]
  1853 00000A5F 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1854                                  	;in	ax, dx
  1855                                  	; 31/05/2024
  1856 00000A63 B402                    	mov	ah, 2 ; read port, word
  1857 00000A65 CD34                    	int	34h
  1858                                  
  1859                                  	;and	al, ~BIT1 ; Clear DRA
  1860                                  	;;;
  1861                                  
  1862 00000A67 0C01                    	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
  1863                                  	;out	dx, ax	; Enable variable rate audio
  1864                                  	; 29/05/2024
  1865 00000A69 53                      	push	ebx
  1866 00000A6A 89C3                    	mov	ebx, eax
  1867                                  	;
  1868                                  	; 30/05/2024
  1869 00000A6C 668B15[94370000]        	mov	dx, [NAMBAR]
  1870 00000A73 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1871                                  	;
  1872 00000A77 B403                    	mov	ah, 3 ; write port, word
  1873 00000A79 CD34                    	int	34h
  1874 00000A7B 5B                      	pop	ebx
  1875                                  
  1876                                  	;mov	cx, 10
  1877 00000A7C B90A000000              	mov	ecx, 10 ; 30/05/2024
  1878                                  check_vra_loop:
  1879                                  	; 31/05/2024
  1880                                  	;call	delay_100ms
  1881                                  	; 30/05/2024
  1882 00000A81 E8DD010000              	call	delay1_4ms
  1883                                  
  1884                                  	; 11/11/2023
  1885                                  	;in	ax, dx
  1886                                  	; 29/05/2024
  1887 00000A86 668B15[94370000]        	mov	dx, [NAMBAR]
  1888 00000A8D 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1889 00000A91 B402                    	mov	ah, 2 ; read port, word
  1890 00000A93 CD34                    	int	34h
  1891                                  
  1892 00000A95 A801                    	test	al, AC97_EA_VRA ; 1
  1893 00000A97 750B                    	jnz	short set_rate
  1894                                  
  1895                                  	; 11/11/2023
  1896 00000A99 E2E6                    	loop	check_vra_loop
  1897                                  
  1898                                  ;vra_not_supported:	; 19/05/2024
  1899 00000A9B C605[F5360000]00        	mov	byte [VRA], 0
  1900 00000AA2 EB19                    	jmp	short skip_rate
  1901                                  
  1902                                  set_rate:
  1903                                  	;mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1904                                  	; 01/12/2024
  1905 00000AA4 66A1[10370000]          	mov	ax, [WAVE_SampleRate]
  1906                                  
  1907 00000AAA 668B15[94370000]        	mov    	dx, [NAMBAR]
  1908 00000AB1 6683C22C                	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch
  1909                                  	;out	dx, ax 	; PCM Front/Center Output Sample Rate
  1910                                  	; 29/05/2024
  1911 00000AB5 53                      	push	ebx
  1912 00000AB6 89C3                    	mov	ebx, eax  ; bx = data, word
  1913 00000AB8 B403                    	mov	ah, 3 ; write port, word
  1914 00000ABA CD34                    	int	34h
  1915 00000ABC 5B                      	pop	ebx
  1916                                  
  1917                                  	; 29/05/2024
  1918                                  	;call	delay_100ms
  1919                                  	; 30/05/2024
  1920                                  	;call	delay1_4ms
  1921                                  
  1922                                  	; 12/11/2023
  1923                                  skip_rate:
  1924 00000ABD 66B80202                	mov	ax, 0202h
  1925 00000AC1 668B15[94370000]          	mov	dx, [NAMBAR]
  1926 00000AC8 6683C202                  	add	dx, CODEC_MASTER_VOL_REG ;02h
  1927                                  	;out	dx, ax
  1928                                  	; 29/05/2024
  1929 00000ACC 53                      	push	ebx
  1930 00000ACD 89C3                    	mov	ebx, eax  ; bx = data, word
  1931 00000ACF B403                    	mov	ah, 3 ; write port, word
  1932 00000AD1 CD34                    	int	34h
  1933 00000AD3 5B                      	pop	ebx
  1934                                  
  1935                                  	; 29/05/2024
  1936                                  	;call	delay1_4ms
  1937                                  	;call	delay1_4ms
  1938                                  	;call	delay1_4ms
  1939                                  	;call	delay1_4ms
  1940                                  
  1941 00000AD4 66B80202                	mov	ax, 0202h
  1942 00000AD8 668B15[94370000]          	mov	dx, [NAMBAR]
  1943 00000ADF 6683C218                  	add	dx, CODEC_PCM_OUT_REG		;18h
  1944                                    	;out	dx, ax
  1945                                  	; 29/05/2024
  1946 00000AE3 53                      	push	ebx
  1947 00000AE4 89C3                    	mov	ebx, eax  ; bx = data, word
  1948 00000AE6 B403                    	mov	ah, 3 ; write port, word
  1949 00000AE8 CD34                    	int	34h
  1950 00000AEA 5B                      	pop	ebx
  1951                                  
  1952                                   	; 29/05/2024
  1953                                  	;call	delay1_4ms
  1954                                  	;call	delay1_4ms
  1955                                  	;call	delay1_4ms
  1956                                  	;call	delay1_4ms
  1957                                  
  1958                                  	; 19/05/2024
  1959                                  	;clc
  1960                                  
  1961 00000AEB C3                              retn
  1962                                  
  1963                                  reset_ac97_controller:
  1964                                  	; 29/05/2024 (TRDOS 386)
  1965                                  	; 19/05/2024
  1966                                  	; 11/11/2023
  1967                                  	; 10/06/2017
  1968                                  	; 29/05/2017
  1969                                  	; 28/05/2017
  1970                                  	; reset AC97 audio controller registers
  1971 00000AEC 31C0                    	xor	eax, eax
  1972 00000AEE 66BA0B00                        mov	dx, PI_CR_REG
  1973 00000AF2 660315[96370000]        	add	dx, [NABMBAR]
  1974                                  	;out	dx, al
  1975                                  	; 29/05/2024
  1976                                  	; al = data, byte
  1977 00000AF9 B401                    	mov	ah, 1 ; write port, byte
  1978 00000AFB CD34                    	int	34h
  1979                                  
  1980                                  	; 19/05/2024
  1981                                  	;call	delay1_4ms
  1982                                  
  1983 00000AFD 66BA1B00                        mov     dx, PO_CR_REG
  1984 00000B01 660315[96370000]        	add	dx, [NABMBAR]
  1985                                  	;out	dx, al
  1986                                  	; 29/05/2024
  1987                                  	; al = data, byte
  1988 00000B08 B401                    	mov	ah, 1 ; write port, byte
  1989 00000B0A CD34                    	int	34h
  1990                                  
  1991                                  	; 19/05/2024
  1992                                  	;call	delay1_4ms
  1993                                  
  1994 00000B0C 66BA2B00                        mov     dx, MC_CR_REG
  1995 00000B10 660315[96370000]        	add	dx, [NABMBAR]
  1996                                  	;out	dx, al
  1997                                  	; 29/05/2024
  1998                                  	; al = data, byte
  1999 00000B17 B401                    	mov	ah, 1 ; write port, byte
  2000 00000B19 CD34                    	int	34h
  2001                                  
  2002                                  	; 19/05/2024
  2003                                  	;call	delay1_4ms
  2004                                  
  2005 00000B1B B002                            mov	al, RR
  2006 00000B1D 66BA0B00                        mov	dx, PI_CR_REG
  2007 00000B21 660315[96370000]        	add	dx, [NABMBAR]
  2008                                  	;out	dx, al
  2009                                  	; 29/05/2024
  2010                                  	; al = data, byte
  2011 00000B28 B401                    	mov	ah, 1 ; write port, byte
  2012 00000B2A CD34                    	int	34h
  2013                                  
  2014                                  	; 19/05/2024
  2015                                  	;call	delay1_4ms
  2016                                  
  2017 00000B2C 66BA1B00                        mov	dx, PO_CR_REG
  2018 00000B30 660315[96370000]        	add	dx, [NABMBAR]
  2019                                  	;out	dx, al
  2020                                  	; 29/05/2024
  2021                                  	; al = data, byte
  2022 00000B37 B401                    	mov	ah, 1 ; write port, byte
  2023 00000B39 CD34                    	int	34h
  2024                                  
  2025                                  	; 19/05/2024
  2026                                  	;call	delay1_4ms
  2027                                  
  2028 00000B3B 66BA2B00                        mov	dx, MC_CR_REG
  2029 00000B3F 660315[96370000]        	add	dx, [NABMBAR]
  2030                                  	;out	dx, al
  2031                                  	; 29/05/2024
  2032                                  	; al = data, byte
  2033 00000B46 B401                    	mov	ah, 1 ; write port, byte
  2034 00000B48 CD34                    	int	34h
  2035                                  
  2036                                  	; 19/05/2024
  2037                                  	;call	delay1_4ms
  2038                                  
  2039 00000B4A C3                      	retn
  2040                                  
  2041                                  reset_ac97_codec:
  2042                                  	; 29/05/2024 (TRDOS 386)
  2043                                  	; 11/11/2023
  2044                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  2045 00000B4B 66BA2C00                	mov	dx, GLOB_CNT_REG ; 2Ch
  2046 00000B4F 660315[96370000]        	add	dx, [NABMBAR]
  2047                                  	;in	eax, dx
  2048                                  	; 29/05/2024
  2049 00000B56 B404                    	mov	ah, 4 ; read port, dword
  2050 00000B58 CD34                    	int	34h
  2051                                  
  2052                                  	;test	eax, 2
  2053                                  	; 06/08/2022
  2054 00000B5A A802                    	test	al, 2
  2055 00000B5C 7407                    	jz	short _r_ac97codec_cold
  2056                                  
  2057 00000B5E E80F000000              	call	warm_ac97codec_reset
  2058 00000B63 7308                    	jnc	short _r_ac97codec_ok
  2059                                  _r_ac97codec_cold:
  2060 00000B65 E845000000                      call	cold_ac97codec_reset
  2061 00000B6A 7301                            jnc	short _r_ac97codec_ok
  2062                                  	
  2063                                  	; 16/04/2017
  2064                                          ;xor	eax, eax	; timeout error
  2065                                         	;stc
  2066 00000B6C C3                      	retn
  2067                                  
  2068                                  _r_ac97codec_ok:
  2069 00000B6D 31C0                            xor     eax, eax
  2070                                          ;mov	al, VIA_ACLINK_C00_READY ; 1
  2071 00000B6F FEC0                            inc	al
  2072 00000B71 C3                      	retn
  2073                                  
  2074                                  warm_ac97codec_reset:
  2075                                  	; 29/05/2024 (TRDOS 386)
  2076                                  	; 11/11/2023
  2077                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  2078                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  2079 00000B72 B806000000              	mov	eax, 6
  2080 00000B77 66BA2C00                	mov	dx, GLOB_CNT_REG ; 2Ch
  2081 00000B7B 660315[96370000]        	add	dx, [NABMBAR]
  2082                                  	;out	dx, eax
  2083                                  	; 29/05/2024
  2084 00000B82 53                      	push	ebx
  2085 00000B83 89C3                    	mov	ebx, eax  ; ebx = data, dword
  2086 00000B85 B405                    	mov	ah, 5 ; write port, dword
  2087 00000B87 CD34                    	int	34h
  2088 00000B89 5B                      	pop	ebx
  2089                                  
  2090                                  	; 30/05/2024
  2091 00000B8A B90A000000              	mov	ecx, 10	; total 1s
  2092                                  	; 29/05/2024
  2093                                  	;mov	ecx, 4000
  2094                                  _warm_ac97c_rst_wait:
  2095                                  	; 30/05/2024
  2096 00000B8F E8C0000000              	call	delay_100ms
  2097                                  
  2098 00000B94 66BA3000                	mov	dx, GLOB_STS_REG ; 30h
  2099 00000B98 660315[96370000]        	add	dx, [NABMBAR]
  2100                                  	;in	eax, dx
  2101                                  	; 29/05/2024
  2102 00000B9F B404                    	mov	ah, 4 ; read port, dword
  2103 00000BA1 CD34                    	int	34h
  2104                                  
  2105 00000BA3 A900030010              	test	eax, CTRL_ST_CREADY
  2106 00000BA8 7504                    	jnz	short _warm_ac97c_rst_ok
  2107                                  
  2108 00000BAA 49                      	dec	ecx
  2109 00000BAB 75E2                    	jnz	short _warm_ac97c_rst_wait
  2110                                  
  2111                                  _warm_ac97c_rst_fail:
  2112 00000BAD F9                              stc
  2113                                  _warm_ac97c_rst_ok:
  2114 00000BAE C3                      	retn
  2115                                  
  2116                                  cold_ac97codec_reset:
  2117                                  	; 11/11/2023
  2118                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  2119                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  2120 00000BAF B802000000                      mov	eax, 2
  2121 00000BB4 66BA2C00                	mov	dx, GLOB_CNT_REG ; 2Ch
  2122 00000BB8 660315[96370000]        	add	dx, [NABMBAR]
  2123                                  	;out	dx, eax
  2124                                  	; 29/05/2024
  2125 00000BBF 53                      	push	ebx
  2126 00000BC0 89C3                    	mov	ebx, eax  ; ebx = data, dword
  2127 00000BC2 B405                    	mov	ah, 5 ; write port, dword
  2128 00000BC4 CD34                    	int	34h
  2129 00000BC6 5B                      	pop	ebx
  2130                                  
  2131                                  	; 30/05/2024
  2132 00000BC7 E888000000              	call	delay_100ms 	; wait 100 ms
  2133 00000BCC E883000000              	call	delay_100ms 	; wait 100 ms
  2134 00000BD1 E87E000000              	call	delay_100ms 	; wait 100 ms
  2135 00000BD6 E879000000              	call	delay_100ms 	; wait 100 ms
  2136                                  
  2137                                  	; 30/05/2024
  2138 00000BDB B910000000              	mov	ecx, 16	; total 20*100 ms = 2s
  2139                                  	; 29/05/2024
  2140                                  	;mov	ecx, 16000
  2141                                  _cold_ac97c_rst_wait:
  2142 00000BE0 66BA3000                	mov	dx, GLOB_STS_REG ; 30h
  2143 00000BE4 660315[96370000]        	add	dx, [NABMBAR]
  2144                                  	;in	eax, dx
  2145                                  	; 29/05/2024
  2146 00000BEB B404                    	mov	ah, 4 ; read port, dword
  2147 00000BED CD34                    	int	34h
  2148                                  
  2149 00000BEF A900030010              	test	eax, CTRL_ST_CREADY
  2150 00000BF4 7509                    	jnz	short _cold_ac97c_rst_ok
  2151                                  
  2152                                  	; 30/05/2024
  2153                                  	; 29/05/2024
  2154 00000BF6 E859000000              	call	delay_100ms
  2155                                  
  2156 00000BFB 49                      	dec	ecx
  2157 00000BFC 75E2                    	jnz	short _cold_ac97c_rst_wait
  2158                                  
  2159                                  _cold_ac97c_rst_fail:
  2160 00000BFE F9                              stc
  2161                                  _cold_ac97c_rst_ok:
  2162 00000BFF C3                      	retn
  2163                                  
  2164                                  ; 29/12/2024 (vgaplay3.s, NASM)
  2165                                  ; 18/12/2024 (ac97play.s, FASM)
  2166                                  ; 13/11/2024
  2167                                  ; 30/05/2024
  2168                                  %if 1
  2169                                  ;if 1
  2170                                  check_vra:
  2171                                  	; 29/05/2024
  2172 00000C00 C605[F5360000]01        	mov	byte [VRA], 1
  2173                                  
  2174                                  	; 29/05/2024 - audio.s (TRDOS 386 Kernel) - 27/05/2024
  2175                                  	; 24/05/2024
  2176                                  	; 23/05/2024
  2177 00000C07 668B15[94370000]        	mov	dx, [NAMBAR]
  2178 00000C0E 6683C228                	add	dx, CODEC_EXT_AUDIO_REG	; 28h
  2179                                  	;in	ax, dx
  2180                                  	; 29/05/2024
  2181 00000C12 B402                    	mov	ah, 2 ; read port, word
  2182 00000C14 CD34                    	int	34h
  2183                                  
  2184                                  	; 30/05/2024
  2185                                  	; 23/05/2024
  2186 00000C16 E848000000              	call	delay1_4ms
  2187                                  
  2188                                  	; 29/05/2024
  2189 00000C1B A801                    	test	al, BIT0
  2190                                  	;test	al, 1 ; BIT0 ; Variable Rate Audio bit
  2191 00000C1D 7507                    	jnz	short check_vra_ok
  2192                                  
  2193                                  vra_not_supported:
  2194                                  	; 13/11/2023
  2195 00000C1F C605[F5360000]00        	mov	byte [VRA], 0
  2196                                  check_vra_ok:
  2197 00000C26 C3                      	retn
  2198                                  ;end if
  2199                                  %endif
  2200                                  
  2201                                  ; --------------------------------------------------------
  2202                                  ; --------------------------------------------------------
  2203                                  
  2204                                  ; 29/12/2024 (vgaplay3.s)
  2205                                  ; 18/12/2024 (ac97play.s)
  2206                                  ;
  2207                                  ; 18/11/2024
  2208                                  ; Ref: TRDOS 386 v2.0.9, audio.s, Erdogan Tan, 06/06/2024
  2209                                  
  2210                                  ac97_stop: 
  2211                                  	; 18/11/2024
  2212 00000C27 C605[E8360000]02        	mov	byte [stopped], 2
  2213                                  
  2214                                  ac97_po_cmd@:
  2215 00000C2E 30C0                    	xor	al, al ; 0
  2216                                  ac97_po_cmd:
  2217 00000C30 668B15[96370000]        	mov     dx, [NABMBAR]
  2218 00000C37 6683C21B                        add     dx, PO_CR_REG	; PCM out control register
  2219                                  	;out	dx, al
  2220                                  	; 01/12/2024
  2221 00000C3B B401                    	mov	ah, 1 ; write port, byte
  2222 00000C3D CD34                    	int	34h
  2223 00000C3F C3                      	retn
  2224                                  
  2225                                  ac97_pause:
  2226 00000C40 C605[E8360000]01        	mov	byte [stopped], 1 ; paused
  2227                                  	;mov	al, 0
  2228                                  	;jmp	short ac97_po_cmd
  2229 00000C47 EBE5                    	jmp	short ac97_po_cmd@
  2230                                  
  2231                                  ac97_play: ; continue to play (after pause)
  2232 00000C49 C605[E8360000]00        	mov	byte [stopped], 0
  2233 00000C50 B001                    	mov	al, RPBM
  2234 00000C52 EBDC                    	jmp	short ac97_po_cmd
  2235                                  
  2236                                  ; --------------------------------------------------------
  2237                                  
  2238                                  PORTB		EQU 061h
  2239                                  REFRESH_STATUS	EQU 010h	; Refresh signal status
  2240                                  
  2241                                  	; 29/12/2024 (vgaplay3.s)
  2242                                  	; 18/12/2024
  2243                                  	; 01/12/2024 (ac97play.s)
  2244                                  delay_100ms:
  2245                                  	; 30/05/2024 (playwav7.s)
  2246 00000C54 51                      	push	ecx
  2247 00000C55 B990010000              	mov	ecx, 400  ; 400*0.25ms
  2248                                  _delay_x_ms:
  2249 00000C5A E804000000              	call	delay1_4ms
  2250 00000C5F E2F9                            loop	_delay_x_ms
  2251 00000C61 59                      	pop	ecx
  2252 00000C62 C3                      	retn
  2253                                  
  2254                                  delay1_4ms:
  2255                                  	; 30/05/2024 (TRDOS 386)
  2256 00000C63 50                              push    eax 
  2257 00000C64 51                              push    ecx
  2258 00000C65 53                      	push	ebx
  2259 00000C66 52                      	push	edx
  2260 00000C67 B910000000                      mov     ecx, 16			; close enough.
  2261                                  	;in	al, PORTB
  2262                                  	; 30/05/2024
  2263 00000C6C 66BA6100                	mov	dx, PORTB
  2264 00000C70 B400                    	mov	ah, 0  ; read port, byte
  2265 00000C72 CD34                    	int	34h
  2266                                  
  2267 00000C74 2410                    	and	al, REFRESH_STATUS
  2268                                  	;mov	ah, al			; Start toggle state
  2269 00000C76 88C3                    	mov	bl, al
  2270 00000C78 09C9                    	or	ecx, ecx
  2271 00000C7A 7401                    	jz	short _d4ms1
  2272 00000C7C 41                      	inc	ecx			; Throwaway first toggle
  2273                                  _d4ms1:	
  2274                                  	;in	al, PORTB		; Read system control port
  2275                                  	; 30/05/2024
  2276 00000C7D 66BA6100                	mov	dx, PORTB
  2277 00000C81 B400                    	mov	ah, 0  ; read port, byte
  2278 00000C83 CD34                    	int	34h
  2279                                  
  2280 00000C85 2410                    	and	al, REFRESH_STATUS	; Refresh toggles 15.085 microseconds
  2281                                  	;cmp	ah, al
  2282 00000C87 38C3                    	cmp	bl, al
  2283 00000C89 74F2                    	je	short _d4ms1		; Wait for state change
  2284                                  
  2285                                  	;mov	ah, al			; Update with new state
  2286 00000C8B 88C3                    	mov	bl, al
  2287 00000C8D 49                      	dec	ecx
  2288 00000C8E 75ED                    	jnz	short _d4ms1
  2289                                  
  2290 00000C90 5A                      	pop	edx
  2291 00000C91 5B                              pop	ebx
  2292 00000C92 59                      	pop	ecx
  2293 00000C93 58                              pop	eax
  2294                                  c4ue_okk:
  2295 00000C94 C3                              retn
  2296                                  
  2297                                  ; --------------------------------------------------------
  2298                                  
  2299                                  getCurrentIndex:
  2300                                  	; returns AL = current index value
  2301                                  	; 01/12/2024
  2302                                  	; 29/05/2024 (TRDOS 386)
  2303                                  	; 08/11/2023
  2304 00000C95 668B15[96370000]        	mov	dx, [NABMBAR]
  2305 00000C9C 6683C214                	add	dx, PO_CIV_REG
  2306                                  	;in	al, dx
  2307                                  	; 29/05/2024
  2308 00000CA0 B400                    	mov	ah, 0 ; read port, byte
  2309 00000CA2 CD34                    	int	34h
  2310                                  uLVI2:	;	06/11/2023
  2311 00000CA4 C3                      	retn
  2312                                  
  2313                                  ; --------------------------------------------------------
  2314                                  
  2315                                  updateLVI:
  2316                                  	; 01/12/2024
  2317                                  	; 29/05/2024 (TRDOS 386)
  2318                                  	; 08/11/2023
  2319                                  	; 07/11/2023
  2320                                  	; 06/11/2023
  2321 00000CA5 668B15[96370000]        	mov	dx, [NABMBAR]
  2322 00000CAC 6683C214                	add	dx, PO_CIV_REG
  2323                                  	; (Current Index Value and Last Valid Index value)
  2324                                  	;in	ax, dx
  2325                                  	; 29/05/2024
  2326 00000CB0 B402                    	mov	ah, 2 ; read port, word
  2327 00000CB2 CD34                    	int	34h
  2328                                  
  2329 00000CB4 38E0                    	cmp	al, ah ; is current index = last index ?
  2330 00000CB6 75EC                    	jne	short uLVI2
  2331                                  
  2332                                  	; 08/11/2023	
  2333 00000CB8 E8D8FFFFFF              	call	getCurrentIndex
  2334                                   
  2335 00000CBD F605[26370000]01        	test	byte [flags], ENDOFFILE
  2336                                  	;jnz	short uLVI1
  2337 00000CC4 7418                    	jz	short uLVI0  ; 08/11/2023
  2338                                  
  2339                                  	; 08/11/2023
  2340 00000CC6 50                      	push	eax	; 29/05/2024 (32 bit)
  2341 00000CC7 668B15[96370000]        	mov	dx, [NABMBAR]
  2342 00000CCE 6683C216                	add	dx, PO_SR_REG  ; PCM out status register
  2343                                  	;in	ax, dx
  2344                                  	; 29/05/2024
  2345 00000CD2 B402                    	mov	ah, 2 ; read port, word
  2346 00000CD4 CD34                    	int	34h
  2347                                  
  2348 00000CD6 A803                    	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
  2349                                  		      ; (has been processed)
  2350                                  		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
  2351 00000CD8 58                      	pop	eax
  2352 00000CD9 7407                    	jz	short uLVI1
  2353                                  uLVI3:
  2354 00000CDB 31C0                    	xor	eax, eax
  2355                                  	; zf = 1
  2356 00000CDD C3                      	retn
  2357                                  uLVI0:
  2358                                          ; not at the end of the file yet.
  2359 00000CDE FEC8                    	dec	al
  2360 00000CE0 241F                    	and	al, 1Fh
  2361                                  uLVI1:
  2362                                  	;call	setLastValidIndex
  2363                                  ;uLVI2:
  2364                                  	;retn
  2365                                  
  2366                                  ;input AL = index # to stop on
  2367                                  setLastValidIndex:
  2368                                  	; 01/12/2024
  2369                                  	; 29/05/2024 (TRDOS 386)
  2370                                  	; 08/11/2023
  2371 00000CE2 668B15[96370000]        	mov	dx, [NABMBAR]
  2372 00000CE9 6683C215                	add	dx, PO_LVI_REG
  2373                                          ;out	dx, al
  2374                                  	; 29/05/2024
  2375                                  	; al = data, byte
  2376 00000CED B401                    	mov	ah, 1 ; write port, byte
  2377 00000CEF CD34                    	int	34h
  2378 00000CF1 C3                      	retn
  2379                                  
  2380                                  ; --------------------------------------------------------
  2381                                  ; 07/12/2024
  2382                                  ; --------------------------------------------------------
  2383                                  
  2384                                  ; /////
  2385                                  	; 14/12/2024
  2386                                  	; 07/12/2024
  2387                                  	; 01/12/2024
  2388                                  	; 30/05/2024 (ich_wav4.asm, 19/05/2024)
  2389                                  loadFromFile:
  2390                                  	; 07/11/2023
  2391                                  
  2392 00000CF2 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2393                                  					; last of the file?
  2394 00000CF9 7402                    	jz	short lff_0		; no
  2395 00000CFB F9                      	stc
  2396 00000CFC C3                      	retn
  2397                                  
  2398                                  lff_0:
  2399                                  	; 07/12/2024
  2400                                  	; 26/11/2023 (playwav8.s)
  2401                                  	;mov	edi, audio_buffer
  2402                                  
  2403                                  	; 01/12/2024 (TRDOS 386)
  2404                                  	; edi = audio buffer address
  2405                                  
  2406                                  	; 14/12/2024
  2407                                  	; 01/12/2024
  2408                                  	; 17/11/2024
  2409                                  	;mov	ebx, [filehandle]
  2410                                  	; 02/12/2024
  2411                                  	;mov	edx, [loadsize] 
  2412                                  
  2413                                  	; 17/11/2024
  2414 00000CFD 803D[8A370000]00        	cmp	byte [fbs_shift], 0
  2415 00000D04 7677                    	jna	short lff_1 ; stereo, 16 bit
  2416                                  
  2417                                  lff_2:
  2418                                  	; 01/12/2024
  2419 00000D06 BE[00500200]            	mov	esi, temp_buffer 
  2420                                  	; 14/12/2024
  2421                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00000D0B 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000D11 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00000D13 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000D19 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00000D1E CD40                <1>  int 40h
  2422 00000D20 0F8289000000            	jc	lff_4 ; error !
  2423                                  
  2424                                  	; 01/12/2024
  2425                                  	; 14/11/2024
  2426 00000D26 A3[AC370000]            	mov	[count], eax
  2427                                  
  2428                                  	; 01/12/2024
  2429 00000D2B 21C0                    	and	eax, eax
  2430                                  	;jz	short lff_3
  2431                                  	; 14/12/2024
  2432 00000D2D 0F8485000000            	jz	lff_10
  2433                                  
  2434 00000D33 8A1D[8A370000]          	mov	bl, [fbs_shift]
  2435                                  
  2436                                  	; 14/12/2024
  2437 00000D39 89FA                    	mov	edx, edi ; audio buffer start address
  2438                                  
  2439                                  	; 01/12/2024
  2440 00000D3B 89C1                    	mov	ecx, eax
  2441 00000D3D 803D[1A370000]08        	cmp	byte [WAVE_BitsPerSample], 8 ; bits per sample (8 or 16)
  2442 00000D44 751E                    	jne	short lff_7 ; 16 bit samples
  2443                                  	; 8 bit samples
  2444 00000D46 FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
  2445 00000D48 740E                    	jz	short lff_6 ; 8 bit, stereo
  2446                                  	; 01/12/2024 (32bit registers)
  2447                                  lff_5:
  2448                                  	; mono & 8 bit
  2449 00000D4A AC                      	lodsb
  2450 00000D4B 2C80                    	sub	al, 80h ; 08/11/2023
  2451 00000D4D C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
  2452 00000D50 66AB                    	stosw	; left channel
  2453 00000D52 66AB                    	stosw	; right channel
  2454 00000D54 E2F4                    	loop	lff_5
  2455 00000D56 EB16                    	jmp	short lff_9
  2456                                  lff_6:
  2457                                  	; stereo & 8 bit
  2458 00000D58 AC                      	lodsb
  2459 00000D59 2C80                    	sub	al, 80h ; 08/11/2023
  2460 00000D5B C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
  2461 00000D5E 66AB                    	stosw
  2462 00000D60 E2F6                    	loop	lff_6
  2463 00000D62 EB0A                    	jmp	short lff_9
  2464                                  lff_7:
  2465 00000D64 D1E9                    	shr	ecx, 1 ; word count
  2466                                  lff_8:
  2467 00000D66 66AD                    	lodsw
  2468 00000D68 66AB                    	stosw	; left channel
  2469 00000D6A 66AB                    	stosw	; right channel
  2470 00000D6C E2F8                    	loop	lff_8
  2471                                  lff_9:
  2472                                  	; 14/12/2024
  2473 00000D6E 89F8                    	mov	eax, edi
  2474 00000D70 8B0D[A0370000]          	mov	ecx, [buffersize] 
  2475 00000D76 01D1                    	add	ecx, edx ; + buffer start address
  2476 00000D78 39C8                    	cmp	eax, ecx	
  2477 00000D7A 7225                    	jb	short lff_3
  2478 00000D7C C3                      	retn
  2479                                  	
  2480                                  lff_1:  
  2481                                  	; 07/12/2024
  2482                                  	; 01/12/2024
  2483                                  	;sys 	_read, [filehandle], esi, [loadsize] ; edx
  2484                                  	; 14/12/2024
  2485                                  	sys 	_read, [filehandle], edi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00000D7D 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000D83 89F9                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00000D85 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000D8B B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00000D90 CD40                <1>  int 40h
  2486                                  	; 07/11/2023
  2487 00000D92 721B                    	jc	short lff_4 ; error !
  2488                                  
  2489                                  	; 01/12/2024
  2490                                  	; 14/11/2024
  2491 00000D94 A3[AC370000]            	mov	[count], eax
  2492                                  
  2493                                  	; 02/12/2024
  2494 00000D99 39D0                    	cmp	eax, edx ; cmp eax, [loadsize]	
  2495 00000D9B 7411                    	je	short endLFF
  2496                                  	; edi = buffer (start) address
  2497 00000D9D 01C7                    	add	edi, eax
  2498 00000D9F 89D1                    	mov	ecx, edx
  2499                                  lff_3:
  2500                                  	;call	padfill			; blank pad the remainder
  2501                                  	; 21/12/2024
  2502                                  padfill:
  2503                                  	; 14/12/2024
  2504                                  	; 01/12/2024 (TRDOS 386, 32bit registers)
  2505                                  	; 17/11/2024
  2506                                  	;   di = offset (to be filled with ZEROs)
  2507                                  	;   bp = buffer segment
  2508                                  	;   ax = di = number of bytes loaded
  2509                                  	;   cx = buffer size (> loaded bytes)	
  2510                                  	; 07/11/2023
  2511                                  	; 06/11/2023
  2512                                  	; 17/02/2017
  2513                                  	; 01/12/2024
  2514 00000DA1 29C1                    	sub	ecx, eax
  2515                                  	; 01/12/2024
  2516                                  	; 25/11/2024
  2517 00000DA3 31C0                    	xor	eax, eax
  2518                                  	; 14/12/2024
  2519 00000DA5 F3AA                    	rep	stosb
  2520                                  	; 21/12/2024
  2521                                  	;retn
  2522                                  	; ----------
  2523                                          ;clc				; don't exit with CY yet.
  2524 00000DA7 800D[26370000]01                or	byte [flags], ENDOFFILE	; end of file flag
  2525                                  endLFF:
  2526 00000DAE C3                              retn
  2527                                  lff_4:
  2528                                  	; 08/11/2023
  2529 00000DAF B021                    	mov	al, '!'  ; error
  2530 00000DB1 E885F9FFFF              	call	tL0
  2531                                  
  2532                                  	; 01/12/2024
  2533 00000DB6 31C0                    	xor	eax, eax
  2534                                  lff_10:
  2535                                  	; 14/12/2024
  2536 00000DB8 8B0D[A0370000]          	mov	ecx, [buffersize]
  2537 00000DBE EBE1                    	jmp	short lff_3
  2538                                  
  2539                                  ; /////
  2540                                  
  2541                                  ; --------------------------------------------------------
  2542                                  ; --------------------------------------------------------
  2543                                  	
  2544                                  write_audio_dev_info:
  2545                                  	; 30/05/2024
  2546                                       	;sys_msg msgAudioCardInfo, 0Fh
  2547                                  	; 01/12/2024
  2548                                  	sys 	_msg, msgAudioCardInfo, 255, 0Fh
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00000DC0 BB[F62B0000]        <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000DC5 B9FF000000          <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00000DCA BA0F000000          <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000DCF B823000000          <1>  mov eax, %1
   106                              <1> 
   107 00000DD4 CD40                <1>  int 40h
  2549 00000DD6 C3                      	retn
  2550                                  
  2551                                  ; --------------------------------------------------------
  2552                                  
  2553                                  write_ac97_pci_dev_info:
  2554                                  	; 19/11/2024
  2555                                  	; 30/05/2024
  2556                                  	; 06/06/2017
  2557                                  	; 03/06/2017
  2558                                  	; BUS/DEV/FN
  2559                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  2560                                  	; DEV/VENDOR
  2561                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  2562                                  
  2563 00000DD7 A1[90370000]            	mov	eax, [dev_vendor]
  2564 00000DDC 31DB                    	xor	ebx, ebx
  2565 00000DDE 88C3                    	mov	bl, al
  2566 00000DE0 88DA                    	mov	dl, bl
  2567 00000DE2 80E30F                  	and	bl, 0Fh
  2568 00000DE5 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2569 00000DEB A2[642D0000]            	mov	[msgVendorId+3], al
  2570 00000DF0 88D3                    	mov	bl, dl
  2571 00000DF2 C0EB04                  	shr	bl, 4
  2572 00000DF5 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2573 00000DFB A2[632D0000]            	mov	[msgVendorId+2], al
  2574 00000E00 88E3                    	mov	bl, ah
  2575 00000E02 88DA                    	mov	dl, bl
  2576 00000E04 80E30F                  	and	bl, 0Fh
  2577 00000E07 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2578 00000E0D A2[622D0000]            	mov	[msgVendorId+1], al
  2579 00000E12 88D3                    	mov	bl, dl
  2580 00000E14 C0EB04                  	shr	bl, 4
  2581 00000E17 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2582 00000E1D A2[612D0000]            	mov	[msgVendorId], al
  2583 00000E22 C1E810                  	shr	eax, 16
  2584 00000E25 88C3                    	mov	bl, al
  2585 00000E27 88DA                    	mov	dl, bl
  2586 00000E29 80E30F                  	and	bl, 0Fh
  2587 00000E2C 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2588 00000E32 A2[752D0000]            	mov	[msgDevId+3], al
  2589 00000E37 88D3                    	mov	bl, dl
  2590 00000E39 C0EB04                  	shr	bl, 4
  2591 00000E3C 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2592 00000E42 A2[742D0000]            	mov	[msgDevId+2], al
  2593 00000E47 88E3                    	mov	bl, ah
  2594 00000E49 88DA                    	mov	dl, bl
  2595 00000E4B 80E30F                  	and	bl, 0Fh
  2596 00000E4E 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2597 00000E54 A2[732D0000]            	mov	[msgDevId+1], al
  2598 00000E59 88D3                    	mov	bl, dl
  2599 00000E5B C0EB04                  	shr	bl, 4
  2600 00000E5E 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2601 00000E64 A2[722D0000]            	mov	[msgDevId], al
  2602                                  
  2603 00000E69 A1[8C370000]            	mov	eax, [bus_dev_fn]
  2604 00000E6E C1E808                  	shr	eax, 8
  2605 00000E71 88C3                    	mov	bl, al
  2606 00000E73 88DA                    	mov	dl, bl
  2607 00000E75 80E307                  	and	bl, 7 ; bit 0,1,2
  2608 00000E78 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2609 00000E7E A2[9A2D0000]            	mov	[msgFncNo+1], al
  2610 00000E83 88D3                    	mov	bl, dl
  2611 00000E85 C0EB03                  	shr	bl, 3
  2612 00000E88 88DA                    	mov	dl, bl
  2613 00000E8A 80E30F                  	and	bl, 0Fh
  2614 00000E8D 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2615 00000E93 A2[8C2D0000]            	mov	[msgDevNo+1], al
  2616 00000E98 88D3                    	mov	bl, dl
  2617 00000E9A C0EB04                  	shr	bl, 4
  2618 00000E9D 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2619 00000EA3 A2[8B2D0000]            	mov	[msgDevNo], al
  2620 00000EA8 88E3                    	mov	bl, ah
  2621 00000EAA 88DA                    	mov	dl, bl
  2622 00000EAC 80E30F                  	and	bl, 0Fh
  2623 00000EAF 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2624 00000EB5 A2[802D0000]            	mov	[msgBusNo+1], al
  2625 00000EBA 88D3                    	mov	bl, dl
  2626 00000EBC C0EB04                  	shr	bl, 4
  2627 00000EBF 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2628 00000EC5 A2[7F2D0000]            	mov	[msgBusNo], al
  2629                                  
  2630                                  	;mov	ax, [ac97_NamBar]
  2631 00000ECA 66A1[94370000]          	mov	ax, [NAMBAR]
  2632 00000ED0 88C3                    	mov	bl, al
  2633 00000ED2 88DA                    	mov	dl, bl
  2634 00000ED4 80E30F                  	and	bl, 0Fh
  2635 00000ED7 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2636 00000EDD A2[AA2D0000]            	mov	[msgNamBar+3], al
  2637 00000EE2 88D3                    	mov	bl, dl
  2638 00000EE4 C0EB04                  	shr	bl, 4
  2639 00000EE7 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2640 00000EED A2[A92D0000]            	mov	[msgNamBar+2], al
  2641 00000EF2 88E3                    	mov	bl, ah
  2642 00000EF4 88DA                    	mov	dl, bl
  2643 00000EF6 80E30F                  	and	bl, 0Fh
  2644 00000EF9 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2645 00000EFF A2[A82D0000]            	mov	[msgNamBar+1], al
  2646 00000F04 88D3                    	mov	bl, dl
  2647 00000F06 C0EB04                  	shr	bl, 4
  2648 00000F09 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2649 00000F0F A2[A72D0000]            	mov	[msgNamBar], al
  2650                                  
  2651                                  	;mov	ax, [ac97_NabmBar]
  2652 00000F14 66A1[96370000]          	mov	ax, [NABMBAR]
  2653 00000F1A 88C3                    	mov	bl, al
  2654 00000F1C 88DA                    	mov	dl, bl
  2655 00000F1E 80E30F                  	and	bl, 0Fh
  2656 00000F21 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2657 00000F27 A2[BA2D0000]            	mov	[msgNabmBar+3], al
  2658 00000F2C 88D3                    	mov	bl, dl
  2659 00000F2E C0EB04                  	shr	bl, 4
  2660 00000F31 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2661 00000F37 A2[B92D0000]            	mov	[msgNabmBar+2], al
  2662 00000F3C 88E3                    	mov	bl, ah
  2663 00000F3E 88DA                    	mov	dl, bl
  2664 00000F40 80E30F                  	and	bl, 0Fh
  2665 00000F43 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2666 00000F49 A2[B82D0000]            	mov	[msgNabmBar+1], al
  2667 00000F4E 88D3                    	mov	bl, dl
  2668 00000F50 C0EB04                  	shr	bl, 4
  2669 00000F53 8A83[1D2D0000]          	mov	al, [hex_chars+ebx]
  2670 00000F59 A2[B72D0000]            	mov	[msgNabmBar], al
  2671                                  
  2672 00000F5E 31C0                    	xor	eax, eax
  2673 00000F60 A0[27370000]            	mov	al, [ac97_int_ln_reg]
  2674 00000F65 B10A                    	mov	cl, 10
  2675 00000F67 F6F1                    	div	cl
  2676                                  	; 23/11/2024
  2677                                  	;add	[msgIRQ], ax
  2678 00000F69 66053030                	add	ax, 3030h
  2679 00000F6D 66A3[C32D0000]          	mov	[msgIRQ], ax
  2680                                  	;and	al, al
  2681 00000F73 3C30                    	cmp	al, 30h
  2682 00000F75 750D                    	jnz	short _w_ac97imsg_
  2683 00000F77 A0[C42D0000]            	mov	al, byte [msgIRQ+1]
  2684 00000F7C B420                    	mov	ah, ' '
  2685 00000F7E 66A3[C32D0000]          	mov	[msgIRQ], ax
  2686                                  _w_ac97imsg_:
  2687                                  	; 19/11/2024
  2688 00000F84 E8B61B0000              	call 	clear_window
  2689                                  	;mov	dh, 13
  2690                                  	; 30/12/2024 (video mode 13h)
  2691 00000F89 B60B                    	mov	dh, 11
  2692 00000F8B B200                    	mov	dl, 0
  2693 00000F8D E83C190000              	call	setCursorPosition
  2694                                  	;;;
  2695                                  	; 21/12/2024
  2696 00000F92 BD[2E2D0000]            	mov	ebp, msgAC97Info ; message
  2697                                  	; 22/12/2024
  2698                                  	;mov	cl, 07h ; color 
  2699 00000F97 E81F000000              	call	sys_gmsg
  2700                                  	;
  2701                                  	; 30/05/2024
  2702                                  write_VRA_info:
  2703                                  	; 21/12/2024
  2704 00000F9C BD[C82D0000]            	mov	ebp, msgVRAheader ; message
  2705                                  	;mov	cl, 07h ; color 
  2706 00000FA1 E815000000              	call	sys_gmsg
  2707                                  	;
  2708 00000FA6 803D[F5360000]00        	cmp	byte [VRA], 0
  2709 00000FAD 7607                    	jna	short _w_VRAi_no
  2710                                  _w_VRAi_yes:
  2711 00000FAF BD[D72D0000]            	mov	ebp, msgVRAyes
  2712 00000FB4 EB05                    	jmp	short _w_VRAi_yn_msg
  2713                                  _w_VRAi_no:
  2714 00000FB6 BD[DD2D0000]            	mov	ebp, msgVRAno
  2715                                  _w_VRAi_yn_msg:
  2716                                  	;mov	cl, 07h ; color 
  2717                                  	;call	sys_msg
  2718                                  	;retn
  2719                                  	;jmp	short sys_gmsg
  2720                                  	;;;
  2721                                  ; --------------------------------------------------------
  2722                                  
  2723                                  	; 31/12/2024 (int 31h)
  2724                                  	; 30/12/2024 (Video Mode 13h)
  2725                                  	; (write message in VGA/CGA mode)
  2726                                  	; 22/12/2024
  2727                                  	; 21/12/2024
  2728                                  	; (write message in VGA/VESA-VBE mode)
  2729                                  sys_gmsg:
  2730 00000FBB 8A4500                  	mov	al, [ebp]
  2731 00000FBE 20C0                    	and	al, al
  2732 00000FC0 740D                    	jz	short sys_gmsg_ok
  2733                                  
  2734                                  ; 31/12/2024
  2735                                  %if 0
  2736                                  	cmp	al, 20h
  2737                                  	jnb	short sys_gmsg_3
  2738                                  	cmp	al, CR ; 13
  2739                                  	jne	short sys_gmsg_2
  2740                                  	; carriege return, move cursor to column 0
  2741                                  	mov	word [screenpos], 0
  2742                                  sys_gmsg_1:
  2743                                  	inc	ebp
  2744                                  	jmp	short sys_gmsg
  2745                                  sys_gmsg_2:
  2746                                  	cmp	al, LF ; 10
  2747                                  	jne	short sys_gmsg_ok ; 22/12/2024
  2748                                  	; line feed, move cursor to next row
  2749                                  	;add	word [screenpos+2], 16
  2750                                  	; 30/12/2024
  2751                                  	add	word [screenpos+2], 8
  2752                                  	jmp	short sys_gmsg_1
  2753                                  sys_gmsg_3:
  2754                                  	mov	esi, [screenpos]
  2755                                  		; hw = (cursor) row
  2756                                  		; si = (cursor) column
  2757                                  	mov	ecx, 07h ; gray (light)
  2758                                  	call	write_character
  2759                                  	add	esi, 8
  2760                                  	;;;
  2761                                  	;cmp	si, 640
  2762                                  	; 30/12/2024 (cgaplay.s)
  2763                                  	cmp	si, 320
  2764                                  	jb	short sys_gmsg_5
  2765                                  	shr	esi, 16
  2766                                  	;add	si, 16
  2767                                  	;cmp	si, 480
  2768                                  	; 30/12/2024
  2769                                  	add	si, 8
  2770                                  	cmp	si, 200
  2771                                  	jb	short sys_gmsg_4
  2772                                  	xor	esi, esi
  2773                                  sys_gmsg_4:
  2774                                  	shl	esi, 16
  2775                                  	;;;
  2776                                  sys_gmsg_5:
  2777                                  	mov	[screenpos], esi
  2778                                  	inc	ebp
  2779                                  	jmp	short sys_gmsg
  2780                                  %endif
  2781                                  	; 31/12/2024
  2782 00000FC2 B907000000              	mov	ecx, 07h ; gray (light)
  2783 00000FC7 E88E1A0000              	call	write_character
  2784 00000FCC 45                      	inc	ebp
  2785 00000FCD EBEC                    	jmp	short sys_gmsg
  2786                                  
  2787                                  sys_gmsg_ok:
  2788 00000FCF C3                      	retn
  2789                                  	;;;
  2790                                  
  2791                                  ; --------------------------------------------------------
  2792                                  
  2793                                  ; 29/12/2024 - vgaplay3.s
  2794                                  ; 18/12/2024
  2795                                  ; 01/12/2024 - ac97play.s
  2796                                  ; 29/05/2024
  2797                                  ; 26/11/2023
  2798                                  ; 25/11/2023 - playwav6.s (32 bit registers, TRDOS 386 adaption)
  2799                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  2800                                  ; 14/11/2023
  2801                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  2802                                  ; --------------------------------------------------------
  2803                                  
  2804                                  ;;Note:	At the end of every buffer load,
  2805                                  ;;	during buffer switch/swap, there will be discontinuity
  2806                                  ;;	between the last converted sample and the 1st sample
  2807                                  ;;	of the next buffer.
  2808                                  ;;	(like as a dot noises vaguely between normal sound samples)
  2809                                  ;;	-To avoid this defect, the 1st sample of
  2810                                  ;;	the next buffer may be read from the wav file but
  2811                                  ;;	the file pointer would need to be set to 1 sample back
  2812                                  ;;	again via seek system call. Time comsumption problem! -
  2813                                  ;;
  2814                                  ;;	Erdogan Tan - 15/11/2023
  2815                                  ;;
  2816                                  ;;	((If entire wav data would be loaded at once.. conversion
  2817                                  ;;	defect/noise would disappear.. but for DOS, to keep
  2818                                  ;;	64KB buffer limit is important also it is important
  2819                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  2820                                  ;;	I have tested this program by using 2-30MB wav files.))
  2821                                  ;;
  2822                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  2823                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  2824                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  2825                                  ;;			Realtek ALC850 codec.
  2826                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  2827                                  
  2828                                  load_8khz_mono_8_bit:
  2829                                  	; 15/11/2023
  2830                                  	; 14/11/2023
  2831                                  	; 13/11/2023
  2832 00000FD0 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2833                                  					; last of the file?
  2834 00000FD7 7402                    	jz	short lff8m_0		; no
  2835 00000FD9 F9                      	stc
  2836 00000FDA C3                      	retn
  2837                                  
  2838                                  lff8m_0:
  2839                                  	; 01/12/2024
  2840                                  	; edi = audio buffer address
  2841                                  	; 13/12/2024
  2842 00000FDB 893D[E4310000]          	mov	[audio_buffer], edi
  2843 00000FE1 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2844                                          ;mov	edx, [loadsize]
  2845                                  
  2846                                  	; esi = buffer address
  2847                                  	;; edx = buffer size
  2848                                  
  2849                                  	; load file into memory
  2850                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00000FE6 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00000FEC 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00000FEE 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00000FF4 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00000FF9 CD40                <1>  int 40h
  2851 00000FFB 7305                    	jnc	short lff8m_6
  2852 00000FFD E9B3000000              	jmp	lff8m_5  ; error !
  2853                                  
  2854                                  lff8m_6:
  2855                                  	; 01/12/2024
  2856 00001002 A3[AC370000]            	mov	[count], eax
  2857                                  	;mov	edi, audio_buffer
  2858                                  	; 29/05/2024
  2859 00001007 8B3D[E4310000]          	mov	edi, [audio_buffer]
  2860                                  	;and	eax, eax
  2861 0000100D 0F8499000000            	jz	lff8_eof
  2862                                  
  2863 00001013 89C1                    	mov	ecx, eax		; byte count
  2864                                  lff8m_1:
  2865 00001015 AC                      	lodsb
  2866 00001016 A2[A3260000]            	mov	[previous_val], al
  2867 0000101B 2C80                    	sub	al, 80h
  2868 0000101D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2869 00001021 66AB                    	stosw		; original sample (left channel)
  2870 00001023 66AB                    	stosw		; original sample (right channel)
  2871                                  	;xor	eax, eax
  2872 00001025 B080                    	mov	al, 80h
  2873 00001027 49                      	dec	ecx
  2874 00001028 7402                    	jz	short lff8m_2
  2875 0000102A 8A06                    	mov	al, [esi]
  2876                                  lff8m_2:
  2877                                  	;mov	[next_val], ax
  2878 0000102C 88C7                    	mov	bh, al	; [next_val]
  2879 0000102E 8A25[A3260000]          	mov	ah, [previous_val]
  2880 00001034 00E0                    	add	al, ah	; [previous_val]
  2881 00001036 D0D8                    	rcr	al, 1
  2882 00001038 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  2883 0000103A 00E0                    	add	al, ah	; [previous_val]
  2884 0000103C D0D8                    	rcr	al, 1	
  2885 0000103E 88C3                    	mov	bl, al 	; this is temporary interpolation value
  2886 00001040 00E0                    	add	al, ah	; [previous_val]
  2887 00001042 D0D8                    	rcr	al, 1
  2888 00001044 2C80                    	sub	al, 80h
  2889 00001046 66C1E008                	shl	ax, 8	
  2890 0000104A 66AB                    	stosw		; this is 1st interpolated sample (L)
  2891 0000104C 66AB                    	stosw		; this is 1st interpolated sample (R)
  2892 0000104E 88D8                    	mov	al, bl
  2893 00001050 00D0                    	add	al, dl
  2894 00001052 D0D8                    	rcr	al, 1
  2895 00001054 2C80                    	sub	al, 80h
  2896 00001056 66C1E008                	shl	ax, 8
  2897 0000105A 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2898 0000105C 66AB                    	stosw		; this is 2nd interpolated sample (R)
  2899 0000105E 88D0                    	mov	al, dl
  2900 00001060 2C80                    	sub	al, 80h
  2901 00001062 66C1E008                	shl	ax, 8
  2902 00001066 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  2903 00001068 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  2904                                  	;mov	al, [next_val]
  2905 0000106A 88F8                    	mov	al, bh
  2906 0000106C 00D0                    	add	al, dl
  2907 0000106E D0D8                    	rcr	al, 1
  2908 00001070 88C3                    	mov	bl, al	; this is temporary interpolation value
  2909 00001072 00D0                    	add	al, dl
  2910 00001074 D0D8                    	rcr	al, 1
  2911 00001076 2C80                    	sub	al, 80h
  2912 00001078 66C1E008                	shl	ax, 8
  2913 0000107C 66AB                    	stosw		; this is 4th interpolated sample (L)
  2914 0000107E 66AB                    	stosw		; this is 4th interpolated sample (R)
  2915                                  	;mov	al, [next_val]
  2916 00001080 88F8                    	mov	al, bh
  2917 00001082 00D8                    	add	al, bl
  2918 00001084 D0D8                    	rcr	al, 1
  2919 00001086 2C80                    	sub	al, 80h
  2920 00001088 66C1E008                	shl	ax, 8
  2921 0000108C 66AB                    	stosw		; this is 5th interpolated sample (L)
  2922 0000108E 66AB                    	stosw		; this is 5th interpolated sample (R)
  2923                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2924 00001090 09C9                    	or	ecx, ecx
  2925 00001092 7581                    	jnz	short lff8m_1
  2926                                  
  2927                                  	; --------------
  2928                                  
  2929                                  lff8s_3:
  2930                                  lff8m_3:
  2931                                  lff8s2_3:
  2932                                  lff8m2_3:
  2933                                  lff16s_3:
  2934                                  lff16m_3:
  2935                                  lff16s2_3:
  2936                                  lff16m2_3:
  2937                                  lff24_3:
  2938                                  lff32_3:
  2939                                  lff44_3:
  2940                                  lff22_3:
  2941                                  lff11_3:
  2942                                  	; 08/12/2024 (BugFix)
  2943                                  	; 31/05/2024
  2944 00001094 8B0D[A0370000]          	mov	ecx, [buffersize] ; buffer size in words
  2945                                  	; 29/12/2024
  2946                                  	; 08/12/2024
  2947                                  	;shl	ecx, 1 ; buffer size in bytes
  2948                                  	; 13/12/2024
  2949 0000109A 030D[E4310000]          	add	ecx, [audio_buffer] ; + start address of the buffer
  2950 000010A0 29F9                    	sub	ecx, edi
  2951 000010A2 7607                    	jna	short lff8m_4
  2952                                  	;inc	ecx
  2953 000010A4 C1E902                  	shr	ecx, 2
  2954 000010A7 31C0                    	xor	eax, eax ; fill (remain part of) buffer with zeros
  2955 000010A9 F3AB                    	rep	stosd
  2956                                  lff8m_4:
  2957                                  	; 31/05/2024
  2958                                  	; cf=1
  2959                                  	; 08/12/2024
  2960                                  	;clc
  2961 000010AB C3                      	retn
  2962                                  
  2963                                  lff8_eof:
  2964                                  lff16_eof:
  2965                                  lff24_eof:
  2966                                  lff32_eof:
  2967                                  lff44_eof:
  2968                                  lff22_eof:
  2969                                  lff11_eof:
  2970                                  	; 15/11/2023
  2971 000010AC C605[26370000]01        	mov	byte [flags], ENDOFFILE
  2972 000010B3 EBDF                    	jmp	short lff8m_3
  2973                                  
  2974                                  lff8s_5:
  2975                                  lff8m_5:
  2976                                  lff8s2_5:
  2977                                  lff8m2_5:
  2978                                  lff16s_5:
  2979                                  lff16m_5:
  2980                                  lff16s2_5:
  2981                                  lff16m2_5:
  2982                                  lff24_5:
  2983                                  lff32_5:
  2984                                  lff44_5:
  2985                                  lff22_5:
  2986                                  lff11_5:
  2987 000010B5 B021                    	mov	al, '!'  ; error
  2988 000010B7 E87FF6FFFF              	call	tL0
  2989                                  	
  2990                                  	;jmp	short lff8m_3
  2991                                  	; 15/11/2023
  2992 000010BC EBEE                    	jmp	lff8_eof
  2993                                  
  2994                                  	; --------------
  2995                                  
  2996                                  load_8khz_stereo_8_bit:
  2997                                  	; 15/11/2023
  2998                                  	; 14/11/2023
  2999                                  	; 13/11/2023
  3000 000010BE F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3001                                  					; last of the file?
  3002 000010C5 7402                    	jz	short lff8s_0		; no
  3003 000010C7 F9                      	stc
  3004 000010C8 C3                      	retn
  3005                                  
  3006                                  lff8s_0:
  3007                                  	; 01/12/2024
  3008                                  	; edi = audio buffer address
  3009                                  	; 13/12/2024
  3010 000010C9 893D[E4310000]          	mov	[audio_buffer], edi
  3011 000010CF BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3012                                          ;mov	edx, [loadsize]
  3013                                  
  3014                                  	; esi = buffer address
  3015                                  	;; edx = buffer size
  3016                                  
  3017                                  	; load file into memory
  3018                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000010D4 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000010DA 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000010DC 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000010E2 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000010E7 CD40                <1>  int 40h
  3019 000010E9 72CA                    	jc	short lff8s_5 ; error !
  3020                                  
  3021                                  	; 01/12/2024
  3022 000010EB A3[AC370000]            	mov	[count], eax
  3023                                  
  3024                                  	;mov	edi, audio_buffer
  3025                                  	; 29/05/2024
  3026                                  	;mov	edi, [audio_buffer]
  3027                                  	
  3028 000010F0 D1E8                    	shr	eax, 1
  3029 000010F2 74B8                    	jz	short lff8_eof
  3030                                  
  3031 000010F4 89C1                    	mov	ecx, eax	; word count
  3032                                  lff8s_1:
  3033 000010F6 AC                      	lodsb
  3034 000010F7 A2[A3260000]            	mov	[previous_val_l], al
  3035 000010FC 2C80                    	sub	al, 80h
  3036 000010FE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3037 00001102 66AB                    	stosw		; original sample (L)
  3038 00001104 AC                      	lodsb
  3039 00001105 A2[A5260000]            	mov	[previous_val_r], al
  3040 0000110A 2C80                    	sub	al, 80h
  3041 0000110C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3042 00001110 66AB                    	stosw		; original sample (R)
  3043                                  
  3044                                  	;xor	eax, eax
  3045 00001112 66B88080                	mov	ax, 8080h
  3046 00001116 49                      	dec	ecx
  3047 00001117 7403                    	jz	short lff8s_2
  3048                                  		; convert 8 bit sample to 16 bit sample
  3049 00001119 668B06                  	mov	ax, [esi]
  3050                                  lff8s_2:
  3051 0000111C A2[A7260000]            	mov	[next_val_l], al
  3052 00001121 8825[A9260000]          	mov	[next_val_r], ah
  3053 00001127 8A25[A3260000]          	mov	ah, [previous_val_l]
  3054 0000112D 00E0                    	add	al, ah
  3055 0000112F D0D8                    	rcr	al, 1
  3056 00001131 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  3057 00001133 00E0                    	add	al, ah
  3058 00001135 D0D8                    	rcr	al, 1
  3059 00001137 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  3060 00001139 00E0                    	add	al, ah
  3061 0000113B D0D8                    	rcr	al, 1
  3062 0000113D 2C80                    	sub	al, 80h
  3063 0000113F 66C1E008                	shl	ax, 8
  3064 00001143 66AB                    	stosw		; this is 1st interpolated sample (L)
  3065 00001145 A0[A9260000]            	mov	al, [next_val_r]
  3066 0000114A 8A25[A5260000]          	mov	ah, [previous_val_r]
  3067 00001150 00E0                    	add	al, ah
  3068 00001152 D0D8                    	rcr	al, 1
  3069 00001154 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  3070 00001156 00E0                    	add	al, ah
  3071 00001158 D0D8                    	rcr	al, 1
  3072 0000115A 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  3073 0000115C 00E0                    	add	al, ah
  3074 0000115E D0D8                    	rcr	al, 1
  3075 00001160 2C80                    	sub	al, 80h
  3076 00001162 66C1E008                	shl	ax, 8
  3077 00001166 66AB                    	stosw		; this is 1st interpolated sample (R)
  3078 00001168 88D8                    	mov	al, bl
  3079 0000116A 00D0                    	add	al, dl
  3080 0000116C D0D8                    	rcr	al, 1
  3081 0000116E 2C80                    	sub	al, 80h
  3082 00001170 66C1E008                	shl	ax, 8
  3083 00001174 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3084 00001176 88F8                    	mov	al, bh
  3085 00001178 00F0                    	add	al, dh
  3086 0000117A D0D8                    	rcr	al, 1
  3087 0000117C 2C80                    	sub	al, 80h
  3088 0000117E 66C1E008                	shl	ax, 8
  3089 00001182 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3090 00001184 88D0                    	mov	al, dl
  3091 00001186 2C80                    	sub	al, 80h
  3092 00001188 66C1E008                	shl	ax, 8
  3093 0000118C 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  3094 0000118E 88F0                    	mov	al, dh
  3095 00001190 2C80                    	sub	al, 80h
  3096 00001192 66C1E008                	shl	ax, 8
  3097 00001196 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  3098 00001198 A0[A7260000]            	mov	al, [next_val_l]
  3099 0000119D 00D0                    	add	al, dl
  3100 0000119F D0D8                    	rcr	al, 1
  3101 000011A1 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  3102 000011A3 00D0                    	add	al, dl
  3103 000011A5 D0D8                    	rcr	al, 1
  3104 000011A7 2C80                    	sub	al, 80h
  3105 000011A9 66C1E008                	shl	ax, 8
  3106 000011AD 66AB                    	stosw		; this is 4th interpolated sample (L)
  3107 000011AF A0[A9260000]            	mov	al, [next_val_r]
  3108 000011B4 00F0                    	add	al, dh
  3109 000011B6 D0D8                    	rcr	al, 1
  3110 000011B8 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  3111 000011BA 00F0                    	add	al, dh
  3112 000011BC D0D8                    	rcr	al, 1
  3113 000011BE 2C80                    	sub	al, 80h
  3114 000011C0 66C1E008                	shl	ax, 8
  3115 000011C4 66AB                    	stosw		; this is 4th interpolated sample (R)
  3116 000011C6 A0[A7260000]            	mov	al, [next_val_l]
  3117 000011CB 00D8                    	add	al, bl
  3118 000011CD D0D8                    	rcr	al, 1
  3119 000011CF 2C80                    	sub	al, 80h
  3120 000011D1 66C1E008                	shl	ax, 8
  3121 000011D5 66AB                    	stosw		; this is 5th interpolated sample (L)
  3122 000011D7 A0[A9260000]            	mov	al, [next_val_r]
  3123 000011DC 00F8                    	add	al, bh
  3124 000011DE D0D8                    	rcr	al, 1
  3125 000011E0 2C80                    	sub	al, 80h
  3126 000011E2 66C1E008                	shl	ax, 8
  3127 000011E6 66AB                    	stosw		; this is 5th interpolated sample (R)
  3128                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3129 000011E8 E305                    	jecxz	lff8s_6
  3130 000011EA E907FFFFFF              	jmp	lff8s_1
  3131                                  lff8s_6:
  3132 000011EF E9A0FEFFFF              	jmp	lff8s_3
  3133                                  
  3134                                  load_8khz_mono_16_bit:
  3135                                  	; 13/11/2023
  3136 000011F4 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3137                                  					; last of the file?
  3138 000011FB 7402                    	jz	short lff8m2_0		; no
  3139 000011FD F9                      	stc
  3140 000011FE C3                      	retn
  3141                                  
  3142                                  lff8m2_0:
  3143                                  	; 01/12/2024
  3144                                  	; edi = audio buffer address
  3145                                  	; 13/12/2024
  3146 000011FF 893D[E4310000]          	mov	[audio_buffer], edi
  3147 00001205 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3148                                          ;mov	edx, [loadsize]
  3149                                  
  3150                                  	; esi = buffer address
  3151                                  	;; edx = buffer size
  3152                                  
  3153                                  	; load file into memory
  3154                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 0000120A 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001210 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001212 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001218 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 0000121D CD40                <1>  int 40h
  3155 0000121F 0F82A0000000            	jc	lff8m2_7 ; error !
  3156                                  
  3157                                  	; 01/12/2024
  3158 00001225 A3[AC370000]            	mov	[count], eax
  3159                                  
  3160                                  	;mov	edi, audio_buffer
  3161                                  	; 29/05/2024
  3162                                  	;mov	edi, [audio_buffer]
  3163                                  	
  3164 0000122A D1E8                    	shr	eax, 1
  3165 0000122C 7505                    	jnz	short lff8m2_8
  3166 0000122E E979FEFFFF              	jmp	lff8_eof
  3167                                  
  3168                                  lff8m2_8:
  3169 00001233 89C1                    	mov	ecx, eax	; word count
  3170                                  lff8m2_1:
  3171 00001235 66AD                    	lodsw
  3172 00001237 66AB                    	stosw		; original sample (left channel)
  3173 00001239 66AB                    	stosw		; original sample (right channel)
  3174 0000123B 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3175 0000123E 66A3[A3260000]          	mov	[previous_val], ax
  3176 00001244 31C0                    	xor	eax, eax
  3177 00001246 49                      	dec	ecx
  3178 00001247 7403                    	jz	short lff8m2_2
  3179 00001249 668B06                  	mov	ax, [esi]
  3180                                  lff8m2_2:
  3181 0000124C 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  3182 0000124F 89C5                    	mov	ebp, eax	; [next_val]
  3183 00001251 660305[A3260000]        	add	ax, [previous_val]
  3184 00001258 66D1D8                  	rcr	ax, 1
  3185 0000125B 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample
  3186 0000125D 660305[A3260000]        	add	ax, [previous_val]
  3187 00001264 66D1D8                  	rcr	ax, 1	; this is temporary interpolation value
  3188 00001267 89C3                    	mov	ebx, eax 		
  3189 00001269 660305[A3260000]        	add	ax, [previous_val]
  3190 00001270 66D1D8                  	rcr	ax, 1
  3191 00001273 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3192 00001276 66AB                    	stosw		; this is 1st interpolated sample (L)
  3193 00001278 66AB                    	stosw		; this is 1st interpolated sample (R)
  3194 0000127A 89D8                    	mov	eax, ebx
  3195 0000127C 6601D0                  	add	ax, dx
  3196 0000127F 66D1D8                  	rcr	ax, 1
  3197 00001282 80EC80                  	sub	ah, 80h
  3198 00001285 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3199 00001287 66AB                    	stosw		; this is 2nd interpolated sample (R)
  3200 00001289 89D0                    	mov	eax, edx
  3201 0000128B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3202 0000128E 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  3203 00001290 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  3204 00001292 89E8                    	mov	eax, ebp
  3205 00001294 6601D0                  	add	ax, dx
  3206 00001297 66D1D8                  	rcr	ax, 1
  3207 0000129A 89C3                    	mov	ebx, eax ; this is temporary interpolation value
  3208 0000129C 6601D0                  	add	ax, dx
  3209 0000129F 66D1D8                  	rcr	ax, 1
  3210 000012A2 80EC80                  	sub	ah, 80h
  3211 000012A5 66AB                    	stosw		; this is 4th interpolated sample (L)
  3212 000012A7 66AB                    	stosw		; this is 4th interpolated sample (R)
  3213 000012A9 89E8                    	mov	eax, ebp
  3214 000012AB 6601D8                  	add	ax, bx
  3215 000012AE 66D1D8                  	rcr	ax, 1
  3216 000012B1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3217 000012B4 66AB                    	stosw		; this is 5th interpolated sample (L)
  3218 000012B6 66AB                    	stosw		; this is 5th interpolated sample (R)
  3219                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3220 000012B8 09C9                    	or	ecx, ecx
  3221 000012BA 0F8575FFFFFF            	jnz	lff8m2_1
  3222 000012C0 E9CFFDFFFF              	jmp	lff8m2_3
  3223                                  
  3224                                  lff8m2_7:
  3225                                  lff8s2_7:
  3226 000012C5 E9EBFDFFFF              	jmp	lff8m2_5  ; error
  3227                                  
  3228                                  load_8khz_stereo_16_bit:
  3229                                  	; 16/11/2023
  3230                                  	; 15/11/2023
  3231                                  	; 13/11/2023
  3232 000012CA F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3233                                  					; last of the file?
  3234 000012D1 7402                    	jz	short lff8s2_0		; no
  3235 000012D3 F9                      	stc
  3236 000012D4 C3                      	retn
  3237                                  
  3238                                  lff8s2_0:
  3239                                  	; 01/12/2024
  3240                                  	; edi = audio buffer address
  3241                                  	; 13/12/2024
  3242 000012D5 893D[E4310000]          	mov	[audio_buffer], edi
  3243 000012DB BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3244                                          ;mov	edx, [loadsize]
  3245                                  
  3246                                  	; esi = buffer address
  3247                                  	;; edx = buffer size
  3248                                  
  3249                                  	; load file into memory
  3250                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000012E0 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000012E6 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000012E8 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000012EE B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000012F3 CD40                <1>  int 40h
  3251 000012F5 72CE                    	jc	short lff8s2_7 ; error !
  3252                                  
  3253                                  	; 01/12/2024
  3254 000012F7 A3[AC370000]            	mov	[count], eax
  3255                                  
  3256                                  	;mov	edi, audio_buffer
  3257                                  	; 29/05/2024
  3258                                  	;mov	edi, [audio_buffer]
  3259                                  	
  3260 000012FC C1E802                  	shr	eax, 2
  3261 000012FF 7505                    	jnz	short lff8s2_8
  3262 00001301 E9A6FDFFFF              	jmp	lff8_eof
  3263                                  
  3264                                  lff8s2_8:
  3265 00001306 89C1                    	mov	ecx, eax ; dword count
  3266                                  lff8s2_1:
  3267 00001308 66AD                    	lodsw
  3268 0000130A 66AB                    	stosw		; original sample (L)
  3269                                  	; 15/11/2023
  3270 0000130C 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3271 0000130F 66A3[A3260000]          	mov	[previous_val_l], ax
  3272 00001315 66AD                    	lodsw
  3273 00001317 66AB                    	stosw		; original sample (R)
  3274 00001319 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3275 0000131C 66A3[A5260000]          	mov	[previous_val_r], ax
  3276 00001322 31D2                    	xor	edx, edx
  3277 00001324 31C0                    	xor	eax, eax
  3278                                  	; 16/11/2023
  3279 00001326 49                      	dec	ecx
  3280 00001327 7407                    	jz	short lff8s2_2
  3281 00001329 668B06                  	mov	ax, [esi]
  3282 0000132C 668B5602                	mov	dx, [esi+2]
  3283                                  lff8s2_2:
  3284 00001330 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3285 00001333 66A3[A7260000]          	mov	[next_val_l], ax
  3286 00001339 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  3287 0000133C 668915[A9260000]        	mov	[next_val_r], dx
  3288 00001343 660305[A3260000]        	add	ax, [previous_val_l]
  3289 0000134A 66D1D8                  	rcr	ax, 1
  3290 0000134D 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample (L)
  3291 0000134F 660305[A3260000]        	add	ax, [previous_val_l]
  3292 00001356 66D1D8                  	rcr	ax, 1	
  3293 00001359 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  3294 0000135B 660305[A3260000]        	add	ax, [previous_val_l]
  3295 00001362 66D1D8                  	rcr	ax, 1
  3296 00001365 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3297 00001368 66AB                    	stosw		; this is 1st interpolated sample (L)
  3298 0000136A 66A1[A9260000]          	mov	ax, [next_val_r]
  3299 00001370 660305[A5260000]        	add	ax, [previous_val_r]
  3300 00001377 66D1D8                  	rcr	ax, 1
  3301 0000137A 89C5                    	mov	ebp, eax ; this is interpolated middle (3th) sample (R)
  3302 0000137C 660305[A5260000]        	add	ax, [previous_val_r]
  3303 00001383 66D1D8                  	rcr	ax, 1
  3304 00001386 50                      	push	eax ; *	; this is temporary interpolation value (R)
  3305 00001387 660305[A5260000]        	add	ax, [previous_val_r]
  3306 0000138E 66D1D8                  	rcr	ax, 1
  3307 00001391 80EC80                  	sub	ah, 80h
  3308 00001394 66AB                    	stosw		; this is 1st interpolated sample (R)
  3309 00001396 89D8                    	mov	eax, ebx
  3310 00001398 6601D0                  	add	ax, dx
  3311 0000139B 66D1D8                  	rcr	ax, 1
  3312 0000139E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3313 000013A1 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3314 000013A3 58                      	pop	eax ; *
  3315 000013A4 6601E8                  	add	ax, bp
  3316 000013A7 66D1D8                  	rcr	ax, 1
  3317 000013AA 80EC80                  	sub	ah, 80h
  3318 000013AD 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3319 000013AF 89D0                    	mov	eax, edx
  3320 000013B1 80EC80                  	sub	ah, 80h
  3321 000013B4 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  3322 000013B6 89E8                    	mov	eax, ebp
  3323 000013B8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3324 000013BB 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  3325 000013BD 66A1[A7260000]          	mov	ax, [next_val_l]
  3326 000013C3 6601D0                  	add	ax, dx
  3327 000013C6 66D1D8                  	rcr	ax, 1
  3328 000013C9 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  3329 000013CB 6601D0                  	add	ax, dx
  3330 000013CE 66D1D8                  	rcr	ax, 1
  3331 000013D1 80EC80                  	sub	ah, 80h
  3332 000013D4 66AB                    	stosw		; this is 4th interpolated sample (L)
  3333 000013D6 66A1[A9260000]          	mov	ax, [next_val_r]
  3334 000013DC 6601E8                  	add	ax, bp
  3335 000013DF 66D1D8                  	rcr	ax, 1
  3336 000013E2 50                      	push	eax ; ** ; this is temporary interpolation value (R)
  3337 000013E3 6601E8                  	add	ax, bp
  3338 000013E6 66D1D8                  	rcr	ax, 1
  3339 000013E9 80EC80                  	sub	ah, 80h
  3340 000013EC 66AB                    	stosw		; this is 4th interpolated sample (R)
  3341 000013EE 66A1[A7260000]          	mov	ax, [next_val_l]
  3342 000013F4 6601D8                  	add	ax, bx
  3343 000013F7 66D1D8                  	rcr	ax, 1
  3344 000013FA 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3345 000013FD 66AB                    	stosw		; this is 5th interpolated sample (L)
  3346 000013FF 58                      	pop	eax ; **
  3347 00001400 660305[A9260000]        	add	ax, [next_val_r]
  3348 00001407 66D1D8                  	rcr	ax, 1
  3349 0000140A 80EC80                  	sub	ah, 80h
  3350 0000140D 66AB                    	stosw		; this is 5th interpolated sample (R)
  3351                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3352 0000140F E305                    	jecxz	lff8_s2_9
  3353 00001411 E9F2FEFFFF              	jmp	lff8s2_1
  3354                                  lff8_s2_9:
  3355 00001416 E979FCFFFF              	jmp	lff8s2_3
  3356                                  
  3357                                  ; .....................
  3358                                  
  3359                                  load_16khz_mono_8_bit:
  3360                                  	; 14/11/2023
  3361                                  	; 13/11/2023
  3362 0000141B F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3363                                  					; last of the file?
  3364 00001422 7402                    	jz	short lff16m_0		; no
  3365 00001424 F9                      	stc
  3366 00001425 C3                      	retn
  3367                                  
  3368                                  lff16m_0:
  3369                                  	; 01/12/2024
  3370                                  	; edi = audio buffer address
  3371                                  	; 13/12/2024
  3372 00001426 893D[E4310000]          	mov	[audio_buffer], edi
  3373 0000142C BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3374                                          ;mov	edx, [loadsize]
  3375                                  
  3376                                  	; esi = buffer address
  3377                                  	;; edx = buffer size
  3378                                  
  3379                                  	; load file into memory
  3380                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001431 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001437 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001439 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 0000143F B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001444 CD40                <1>  int 40h
  3381 00001446 7253                    	jc	short lff16m_7 ; error !
  3382                                  
  3383                                  	; 01/12/2024
  3384 00001448 A3[AC370000]            	mov	[count], eax
  3385                                  
  3386                                  	;mov	edi, audio_buffer
  3387                                  	; 29/05/2024
  3388                                  	;mov	edi, [audio_buffer]
  3389                                  	
  3390 0000144D 21C0                    	and	eax, eax
  3391 0000144F 7505                    	jnz	short lff16m_8
  3392 00001451 E956FCFFFF              	jmp	lff16_eof
  3393                                  
  3394                                  lff16m_8:
  3395 00001456 89C1                    	mov	ecx, eax		; byte count
  3396                                  lff16m_1:
  3397 00001458 AC                      	lodsb
  3398                                  	;mov	[previous_val], al
  3399 00001459 88C3                    	mov	bl, al
  3400 0000145B 2C80                    	sub	al, 80h
  3401 0000145D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3402 00001461 66AB                    	stosw		; original sample (left channel)
  3403 00001463 66AB                    	stosw		; original sample (right channel)
  3404                                  	;xor	ax, ax
  3405                                  	; 14/11/22023
  3406 00001465 B080                    	mov	al, 80h
  3407 00001467 49                      	dec	ecx
  3408 00001468 7402                    	jz	short lff16m_2
  3409 0000146A 8A06                    	mov	al, [esi]
  3410                                  lff16m_2:
  3411                                  	;mov	[next_val], al
  3412 0000146C 88C7                    	mov	bh, al
  3413                                  	;add	al, [previous_val]
  3414 0000146E 00D8                    	add	al, bl
  3415 00001470 D0D8                    	rcr	al, 1
  3416 00001472 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  3417                                  	;add	al, [previous_val]
  3418 00001474 00D8                    	add	al, bl
  3419 00001476 D0D8                    	rcr	al, 1
  3420 00001478 2C80                    	sub	al, 80h
  3421 0000147A 66C1E008                	shl	ax, 8
  3422 0000147E 66AB                    	stosw		; this is 1st interpolated sample (L)
  3423 00001480 66AB                    	stosw		; this is 1st interpolated sample (R)
  3424                                  	;mov	al, [next_val]
  3425 00001482 88F8                    	mov	al, bh
  3426 00001484 00D0                    	add	al, dl
  3427 00001486 D0D8                    	rcr	al, 1
  3428 00001488 2C80                    	sub	al, 80h
  3429 0000148A 66C1E008                	shl	ax, 8
  3430 0000148E 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3431 00001490 66AB                    	stosw		; this is 2nd interpolated sample (R)
  3432                                  	
  3433                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3434 00001492 09C9                    	or	ecx, ecx
  3435 00001494 75C2                    	jnz	short lff16m_1
  3436 00001496 E9F9FBFFFF              	jmp	lff16m_3
  3437                                  
  3438                                  lff16m_7:
  3439                                  lff16s_7:
  3440 0000149B E915FCFFFF              	jmp	lff16m_5  ; error
  3441                                  
  3442                                  load_16khz_stereo_8_bit:
  3443                                  	; 14/11/2023
  3444                                  	; 13/11/2023
  3445 000014A0 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3446                                  					; last of the file?
  3447 000014A7 7402                    	jz	short lff16s_0		; no
  3448 000014A9 F9                      	stc
  3449 000014AA C3                      	retn
  3450                                  
  3451                                  lff16s_0:
  3452                                  	; 01/12/2024
  3453                                  	; edi = audio buffer address
  3454                                  	; 13/12/2024
  3455 000014AB 893D[E4310000]          	mov	[audio_buffer], edi
  3456 000014B1 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3457                                          ;mov	edx, [loadsize]
  3458                                  
  3459                                  	; esi = buffer address
  3460                                  	;; edx = buffer size
  3461                                  
  3462                                  	; load file into memory
  3463                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000014B6 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000014BC 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000014BE 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000014C4 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000014C9 CD40                <1>  int 40h
  3464 000014CB 72CE                    	jc	short lff16s_7 ; error !
  3465                                  
  3466                                  	; 01/12/2024
  3467 000014CD A3[AC370000]            	mov	[count], eax
  3468                                  
  3469                                  	;mov	edi, audio_buffer
  3470                                  	; 29/05/2024
  3471                                  	;mov	edi, [audio_buffer]
  3472                                  	
  3473 000014D2 D1E8                    	shr	eax, 1
  3474 000014D4 7505                    	jnz	short lff16s_8
  3475 000014D6 E9D1FBFFFF              	jmp	lff16_eof
  3476                                  
  3477                                  lff16s_8:
  3478 000014DB 89C1                    	mov	ecx, eax	; word count
  3479                                  lff16s_1:
  3480 000014DD AC                      	lodsb
  3481 000014DE A2[A3260000]            	mov	[previous_val_l], al
  3482 000014E3 2C80                    	sub	al, 80h
  3483 000014E5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3484 000014E9 66AB                    	stosw		; original sample (L)
  3485 000014EB AC                      	lodsb
  3486 000014EC A2[A5260000]            	mov	[previous_val_r], al
  3487 000014F1 2C80                    	sub	al, 80h
  3488 000014F3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3489 000014F7 66AB                    	stosw		; original sample (R)
  3490                                  
  3491                                  	;xor	eax, eax
  3492 000014F9 66B88080                	mov	ax, 8080h
  3493 000014FD 49                      	dec	ecx
  3494 000014FE 7403                    	jz	short lff16s_2
  3495                                  		; convert 8 bit sample to 16 bit sample
  3496 00001500 668B06                  	mov	ax, [esi]
  3497                                  lff16s_2:
  3498                                  	;mov	[next_val_l], al
  3499                                  	;mov	[next_val_r], ah
  3500 00001503 89C3                    	mov	ebx, eax
  3501 00001505 0205[A3260000]          	add	al, [previous_val_l]
  3502 0000150B D0D8                    	rcr	al, 1
  3503 0000150D 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  3504 0000150F 0205[A3260000]          	add	al, [previous_val_l]
  3505 00001515 D0D8                    	rcr	al, 1
  3506 00001517 2C80                    	sub	al, 80h
  3507 00001519 66C1E008                	shl	ax, 8
  3508 0000151D 66AB                    	stosw		; this is 1st interpolated sample (L)
  3509 0000151F 88F8                    	mov	al, bh	; [next_val_r]
  3510 00001521 0205[A5260000]          	add	al, [previous_val_r]
  3511 00001527 D0D8                    	rcr	al, 1
  3512 00001529 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  3513 0000152B 0205[A5260000]          	add	al, [previous_val_r]
  3514 00001531 D0D8                    	rcr	al, 1
  3515 00001533 2C80                    	sub	al, 80h
  3516 00001535 66C1E008                	shl	ax, 8
  3517 00001539 66AB                    	stosw		; this is 1st interpolated sample (R)
  3518 0000153B 88D0                    	mov	al, dl
  3519 0000153D 00D8                    	add	al, bl	; [next_val_l]
  3520 0000153F D0D8                    	rcr	al, 1
  3521 00001541 2C80                    	sub	al, 80h
  3522 00001543 66C1E008                	shl	ax, 8
  3523 00001547 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3524 00001549 88F0                    	mov	al, dh
  3525 0000154B 00F8                    	add	al, bh	; [next_val_r]
  3526 0000154D D0D8                    	rcr	al, 1
  3527 0000154F 2C80                    	sub	al, 80h
  3528 00001551 66C1E008                	shl	ax, 8
  3529 00001555 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3530                                  	
  3531                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3532 00001557 09C9                    	or	ecx, ecx
  3533 00001559 7582                    	jnz	short lff16s_1
  3534 0000155B E934FBFFFF              	jmp	lff16s_3
  3535                                  
  3536                                  load_16khz_mono_16_bit:
  3537                                  	; 15/11/2023
  3538                                  	; 13/11/2023
  3539 00001560 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3540                                  					; last of the file?
  3541 00001567 7402                    	jz	short lff16m2_0		; no
  3542 00001569 F9                      	stc
  3543 0000156A C3                      	retn
  3544                                  
  3545                                  lff16m2_0:
  3546                                  	; 01/12/2024
  3547                                  	; edi = audio buffer address
  3548                                  	; 13/12/2024
  3549 0000156B 893D[E4310000]          	mov	[audio_buffer], edi
  3550 00001571 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3551                                          ;mov	edx, [loadsize]
  3552                                  
  3553                                  	; esi = buffer address
  3554                                  	;; edx = buffer size
  3555                                  
  3556                                  	; load file into memory
  3557                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001576 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 0000157C 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 0000157E 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001584 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001589 CD40                <1>  int 40h
  3558 0000158B 7255                    	jc	short lff16m2_7 ; error !
  3559                                  
  3560                                  	; 01/12/2024
  3561 0000158D A3[AC370000]            	mov	[count], eax
  3562                                  
  3563                                  	;mov	edi, audio_buffer
  3564                                  	; 29/05/2024
  3565                                  	;mov	edi, [audio_buffer]
  3566                                  	
  3567 00001592 D1E8                    	shr	eax, 1
  3568 00001594 7505                    	jnz	short lff16m2_8
  3569 00001596 E911FBFFFF              	jmp	lff16_eof
  3570                                  
  3571                                  lff16m2_8:
  3572 0000159B 89C1                    	mov	ecx, eax  ; word count
  3573                                  lff16m2_1:
  3574 0000159D 66AD                    	lodsw
  3575 0000159F 66AB                    	stosw		; original sample (left channel)
  3576 000015A1 66AB                    	stosw		; original sample (right channel)
  3577 000015A3 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3578                                  	;mov	[previous_val], ax
  3579 000015A6 89C3                    	mov	ebx, eax
  3580 000015A8 31C0                    	xor	eax, eax
  3581 000015AA 49                      	dec	ecx
  3582 000015AB 7403                    	jz	short lff16m2_2
  3583 000015AD 668B06                  	mov	ax, [esi]
  3584                                  lff16m2_2:
  3585 000015B0 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3586 000015B3 89C5                    	mov	ebp, eax	; [next_val]
  3587                                  	;add	ax, [previous_val]
  3588 000015B5 6601D8                  	add	ax, bx
  3589 000015B8 66D1D8                  	rcr	ax, 1
  3590 000015BB 89C2                    	mov	edx, eax ; this is temporary interpolation value
  3591                                  	;add	ax, [previous_val]
  3592 000015BD 6601D8                  	add	ax, bx
  3593 000015C0 66D1D8                  	rcr	ax, 1
  3594 000015C3 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3595 000015C6 66AB                    	stosw		; this is 1st interpolated sample (L)
  3596 000015C8 66AB                    	stosw		; this is 1st interpolated sample (R)
  3597 000015CA 89E8                    	mov	eax, ebp
  3598 000015CC 6601D0                  	add	ax, dx
  3599 000015CF 66D1D8                  	rcr	ax, 1
  3600 000015D2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3601 000015D5 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3602 000015D7 66AB                    	stosw		; this is 2nd interpolated sample (R)
  3603                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3604 000015D9 09C9                    	or	ecx, ecx
  3605 000015DB 75C0                    	jnz	short lff16m2_1
  3606 000015DD E9B2FAFFFF              	jmp	lff16m2_3
  3607                                  
  3608                                  lff16m2_7:
  3609                                  lff16s2_7:
  3610 000015E2 E9CEFAFFFF              	jmp	lff16m2_5  ; error
  3611                                  
  3612                                  load_16khz_stereo_16_bit:
  3613                                  	; 16/11/2023
  3614                                  	; 15/11/2023
  3615                                  	; 13/11/2023
  3616 000015E7 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3617                                  					; last of the file?
  3618 000015EE 7402                    	jz	short lff16s2_0		; no
  3619 000015F0 F9                      	stc
  3620 000015F1 C3                      	retn
  3621                                  
  3622                                  lff16s2_0:
  3623                                  	; 01/12/2024
  3624                                  	; edi = audio buffer address
  3625                                  	; 13/12/2024
  3626 000015F2 893D[E4310000]          	mov	[audio_buffer], edi
  3627 000015F8 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3628                                          ;mov	edx, [loadsize]
  3629                                  
  3630                                  	; esi = buffer address
  3631                                  	;; edx = buffer size
  3632                                  
  3633                                  	; load file into memory
  3634                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000015FD 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001603 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001605 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 0000160B B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001610 CD40                <1>  int 40h
  3635 00001612 72CE                    	jc	short lff16s2_7 ; error !
  3636                                  
  3637                                  	; 01/12/2024
  3638 00001614 A3[AC370000]            	mov	[count], eax
  3639                                  
  3640                                  	;mov	edi, audio_buffer
  3641                                  	; 29/05/2024
  3642                                  	;mov	edi, [audio_buffer]
  3643                                  	
  3644 00001619 C1E802                  	shr	eax, 2
  3645 0000161C 7505                    	jnz	short lff16s2_8
  3646 0000161E E989FAFFFF              	jmp	lff16_eof
  3647                                  
  3648                                  lff16s2_8:
  3649 00001623 89C1                    	mov	ecx, eax  ; dword count
  3650                                  lff16s2_1:
  3651 00001625 66AD                    	lodsw
  3652 00001627 66AB                    	stosw		; original sample (L)
  3653 00001629 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3654 0000162C 66A3[A3260000]          	mov	[previous_val_l], ax
  3655 00001632 66AD                    	lodsw
  3656 00001634 66AB                    	stosw		; original sample (R)
  3657 00001636 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3658 00001639 66A3[A5260000]          	mov	[previous_val_r], ax
  3659 0000163F 31D2                    	xor	edx, edx
  3660 00001641 31C0                    	xor	eax, eax
  3661                                  	; 16/11/2023
  3662 00001643 49                      	dec	ecx
  3663 00001644 7407                    	jz	short lff16s2_2
  3664 00001646 668B06                  	mov	ax, [esi]
  3665 00001649 668B5602                	mov	dx, [esi+2]
  3666                                  lff16s2_2:
  3667 0000164D 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3668                                  	;mov	[next_val_l], ax
  3669 00001650 89C5                    	mov	ebp, eax
  3670 00001652 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  3671 00001655 668915[A9260000]        	mov	[next_val_r], dx
  3672 0000165C 660305[A3260000]        	add	ax, [previous_val_l]
  3673 00001663 66D1D8                  	rcr	ax, 1
  3674 00001666 89C2                    	mov	edx, eax ; this is temporary interpolation value (L)
  3675 00001668 660305[A3260000]        	add	ax, [previous_val_l]
  3676 0000166F 66D1D8                  	rcr	ax, 1
  3677 00001672 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  3678 00001675 66AB                    	stosw		; this is 1st interpolated sample (L)
  3679 00001677 66A1[A9260000]          	mov	ax, [next_val_r]
  3680 0000167D 660305[A5260000]        	add	ax, [previous_val_r]
  3681 00001684 66D1D8                  	rcr	ax, 1
  3682 00001687 89C3                    	mov	ebx, eax ; this is temporary interpolation value (R)
  3683 00001689 660305[A5260000]        	add	ax, [previous_val_r]
  3684 00001690 66D1D8                  	rcr	ax, 1
  3685 00001693 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3686 00001696 66AB                    	stosw		; this is 1st interpolated sample (R)
  3687                                  	;mov	ax, [next_val_l]
  3688 00001698 89E8                    	mov	eax, ebp
  3689 0000169A 6601D0                  	add	ax, dx
  3690 0000169D 66D1D8                  	rcr	ax, 1
  3691 000016A0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3692 000016A3 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3693 000016A5 66A1[A9260000]          	mov	ax, [next_val_r]
  3694 000016AB 6601D8                  	add	ax, bx
  3695 000016AE 66D1D8                  	rcr	ax, 1
  3696 000016B1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3697 000016B4 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3698                                  	
  3699                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3700 000016B6 09C9                    	or	ecx, ecx
  3701 000016B8 0F8567FFFFFF            	jnz	lff16s2_1
  3702 000016BE E9D1F9FFFF              	jmp	lff16s2_3
  3703                                  
  3704                                  ; .....................
  3705                                  
  3706                                  load_24khz_mono_8_bit:
  3707                                  	; 15/11/2023
  3708 000016C3 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3709                                  					; last of the file?
  3710 000016CA 7402                    	jz	short lff24m_0		; no
  3711 000016CC F9                      	stc
  3712 000016CD C3                      	retn
  3713                                  
  3714                                  lff24m_0:
  3715                                  	; 01/12/2024
  3716                                  	; edi = audio buffer address
  3717                                  	; 13/12/2024
  3718 000016CE 893D[E4310000]          	mov	[audio_buffer], edi
  3719 000016D4 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3720                                          ;mov	edx, [loadsize]
  3721                                  
  3722                                  	; esi = buffer address
  3723                                  	;; edx = buffer size
  3724                                  
  3725                                  	; load file into memory
  3726                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000016D9 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000016DF 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000016E1 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000016E7 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000016EC CD40                <1>  int 40h
  3727 000016EE 723B                    	jc	short lff24m_7 ; error !
  3728                                  
  3729                                  	; 01/12/2024
  3730 000016F0 A3[AC370000]            	mov	[count], eax
  3731                                  
  3732                                  	;mov	edi, audio_buffer
  3733                                  	; 29/05/2024
  3734                                  	;mov	edi, [audio_buffer]
  3735                                  	
  3736 000016F5 21C0                    	and	eax, eax
  3737 000016F7 7505                    	jnz	short lff24m_8
  3738 000016F9 E9AEF9FFFF              	jmp	lff24_eof
  3739                                  
  3740                                  lff24m_8:
  3741 000016FE 89C1                    	mov	ecx, eax	; byte count
  3742                                  lff24m_1:
  3743 00001700 AC                      	lodsb
  3744                                  	;mov	[previous_val], al
  3745 00001701 88C3                    	mov	bl, al
  3746 00001703 2C80                    	sub	al, 80h
  3747 00001705 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3748 00001709 66AB                    	stosw		; original sample (left channel)
  3749 0000170B 66AB                    	stosw		; original sample (right channel)
  3750                                  	;xor	eax, eax
  3751 0000170D B080                    	mov	al, 80h
  3752 0000170F 49                      	dec	ecx
  3753 00001710 7402                    	jz	short lff24m_2
  3754 00001712 8A06                    	mov	al, [esi]
  3755                                  lff24m_2:
  3756                                  	;;mov	[next_val], al
  3757                                  	;mov	bh, al
  3758                                  	;add	al, [previous_val]
  3759 00001714 00D8                    	add	al, bl
  3760 00001716 D0D8                    	rcr	al, 1
  3761 00001718 2C80                    	sub	al, 80h
  3762 0000171A 66C1E008                	shl	ax, 8
  3763 0000171E 66AB                    	stosw		; this is interpolated sample (L)
  3764 00001720 66AB                    	stosw		; this is interpolated sample (R)
  3765                                  	
  3766                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3767 00001722 09C9                    	or	ecx, ecx
  3768 00001724 75DA                    	jnz	short lff24m_1
  3769 00001726 E969F9FFFF              	jmp	lff24_3
  3770                                  
  3771                                  lff24m_7:
  3772                                  lff24s_7:
  3773 0000172B E985F9FFFF              	jmp	lff24_5  ; error
  3774                                  
  3775                                  load_24khz_stereo_8_bit:
  3776                                  	; 15/11/2023
  3777 00001730 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3778                                  					; last of the file?
  3779 00001737 7402                    	jz	short lff24s_0		; no
  3780 00001739 F9                      	stc
  3781 0000173A C3                      	retn
  3782                                  
  3783                                  lff24s_0:
  3784                                  	; 01/12/2024
  3785                                  	; edi = audio buffer address
  3786                                  	; 13/12/2024
  3787 0000173B 893D[E4310000]          	mov	[audio_buffer], edi
  3788 00001741 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3789                                          ;mov	edx, [loadsize]
  3790                                  
  3791                                  	; esi = buffer address
  3792                                  	;; edx = buffer size
  3793                                  
  3794                                  	; load file into memory
  3795                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001746 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 0000174C 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 0000174E 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001754 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001759 CD40                <1>  int 40h
  3796 0000175B 72CE                    	jc	short lff24s_7 ; error !
  3797                                  
  3798                                  	; 01/12/2024
  3799 0000175D A3[AC370000]            	mov	[count], eax
  3800                                  
  3801                                  	;mov	edi, audio_buffer
  3802                                  	; 29/05/2024
  3803                                  	;mov	edi, [audio_buffer]
  3804                                  	
  3805 00001762 D1E8                    	shr	eax, 1
  3806 00001764 7505                    	jnz	short lff24s_8
  3807 00001766 E941F9FFFF              	jmp	lff24_eof
  3808                                  
  3809                                  lff24s_8:
  3810 0000176B 89C1                    	mov	ecx, eax  ; word count
  3811                                  lff24s_1:
  3812 0000176D AC                      	lodsb
  3813 0000176E A2[A3260000]            	mov	[previous_val_l], al
  3814 00001773 2C80                    	sub	al, 80h
  3815 00001775 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3816 00001779 66AB                    	stosw		; original sample (L)
  3817 0000177B AC                      	lodsb
  3818 0000177C A2[A5260000]            	mov	[previous_val_r], al
  3819 00001781 2C80                    	sub	al, 80h
  3820 00001783 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3821 00001787 66AB                    	stosw		; original sample (R)
  3822                                  
  3823                                  	;xor	eax, eax
  3824 00001789 66B88080                	mov	ax, 8080h
  3825 0000178D 49                      	dec	ecx
  3826 0000178E 7403                    	jz	short lff24s_2
  3827                                  		; convert 8 bit sample to 16 bit sample
  3828 00001790 668B06                  	mov	ax, [esi]
  3829                                  lff24s_2:
  3830                                  	;;mov	[next_val_l], al
  3831                                  	;;mov	[next_val_r], ah
  3832                                  	;mov	bx, ax
  3833 00001793 88E7                    	mov	bh, ah
  3834 00001795 0205[A3260000]          	add	al, [previous_val_l]
  3835 0000179B D0D8                    	rcr	al, 1
  3836                                  	;mov	dl, al
  3837 0000179D 2C80                    	sub	al, 80h
  3838 0000179F 66C1E008                	shl	ax, 8
  3839 000017A3 66AB                    	stosw		; this is interpolated sample (L)
  3840 000017A5 88F8                    	mov	al, bh	; [next_val_r]
  3841 000017A7 0205[A5260000]          	add	al, [previous_val_r]
  3842 000017AD D0D8                    	rcr	al, 1
  3843                                  	;mov	dh, al
  3844 000017AF 2C80                    	sub	al, 80h
  3845 000017B1 66C1E008                	shl	ax, 8
  3846 000017B5 66AB                    	stosw		; this is interpolated sample (R)
  3847                                  		
  3848                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3849 000017B7 09C9                    	or	ecx, ecx
  3850 000017B9 75B2                    	jnz	short lff24s_1
  3851 000017BB E9D4F8FFFF              	jmp	lff24_3
  3852                                  
  3853                                  load_24khz_mono_16_bit:
  3854                                  	; 15/11/2023
  3855 000017C0 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3856                                  					; last of the file?
  3857 000017C7 7402                    	jz	short lff24m2_0		; no
  3858 000017C9 F9                      	stc
  3859 000017CA C3                      	retn
  3860                                  
  3861                                  lff24m2_0:
  3862                                  	; 01/12/2024
  3863                                  	; edi = audio buffer address
  3864                                  	; 13/12/2024
  3865 000017CB 893D[E4310000]          	mov	[audio_buffer], edi
  3866 000017D1 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3867                                          ;mov	edx, [loadsize]
  3868                                  
  3869                                  	; esi = buffer address
  3870                                  	;; edx = buffer size
  3871                                  
  3872                                  	; load file into memory
  3873                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000017D6 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000017DC 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000017DE 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000017E4 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000017E9 CD40                <1>  int 40h
  3874 000017EB 7237                    	jc	short lff24m2_7 ; error !
  3875                                  
  3876                                  	; 01/12/2024
  3877 000017ED A3[AC370000]            	mov	[count], eax
  3878                                  
  3879                                  	;mov	edi, audio_buffer
  3880                                  	; 29/05/2024
  3881                                  	;mov	edi, [audio_buffer]
  3882                                  	
  3883 000017F2 D1E8                    	shr	eax, 1
  3884 000017F4 7505                    	jnz	short lff24m2_8
  3885 000017F6 E9B1F8FFFF              	jmp	lff24_eof
  3886                                  
  3887                                  lff24m2_8:
  3888 000017FB 89C1                    	mov	ecx, eax  ; word count
  3889                                  lff24m2_1:
  3890 000017FD 66AD                    	lodsw
  3891 000017FF 66AB                    	stosw		; original sample (left channel)
  3892 00001801 66AB                    	stosw		; original sample (right channel)
  3893 00001803 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3894                                  	;mov	[previous_val], ax
  3895                                  	;mov	ebx, eax
  3896                                  	;xor	eax, eax
  3897 00001806 31DB                    	xor	ebx, ebx
  3898 00001808 49                      	dec	ecx
  3899 00001809 7403                    	jz	short lff24m2_2
  3900                                  	;mov	ax, [esi]
  3901 0000180B 668B1E                  	mov	bx, [esi]
  3902                                  lff24m2_2:
  3903                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  3904                                  	;mov	ebp, eax	; [next_val]
  3905                                  	;add	ax, [previous_val]
  3906                                  	; ax = [previous_val]
  3907                                  	; bx = [next_val]
  3908 0000180E 6601D8                  	add	ax, bx
  3909 00001811 66D1D8                  	rcr	ax, 1
  3910 00001814 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3911 00001817 66AB                    	stosw		; this is interpolated sample (L)
  3912 00001819 66AB                    	stosw		; this is interpolated sample (R)
  3913                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3914 0000181B 09C9                    	or	ecx, ecx
  3915 0000181D 75DE                    	jnz	short lff24m2_1
  3916 0000181F E970F8FFFF              	jmp	lff24_3
  3917                                  
  3918                                  lff24m2_7:
  3919                                  lff24s2_7:
  3920 00001824 E98CF8FFFF              	jmp	lff24_5  ; error
  3921                                  
  3922                                  load_24khz_stereo_16_bit:
  3923                                  	; 16/11/2023
  3924                                  	; 15/11/2023
  3925 00001829 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3926                                  					; last of the file?
  3927 00001830 7402                    	jz	short lff24s2_0		; no
  3928 00001832 F9                      	stc
  3929 00001833 C3                      	retn
  3930                                  
  3931                                  lff24s2_0:
  3932                                  	; 01/12/2024
  3933                                  	; edi = audio buffer address
  3934                                  	; 13/12/2024
  3935 00001834 893D[E4310000]          	mov	[audio_buffer], edi
  3936 0000183A BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3937                                          ;mov	edx, [loadsize]
  3938                                  
  3939                                  	; esi = buffer address
  3940                                  	;; edx = buffer size
  3941                                  
  3942                                  	; load file into memory
  3943                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 0000183F 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001845 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001847 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 0000184D B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001852 CD40                <1>  int 40h
  3944 00001854 72CE                    	jc	short lff24s2_7 ; error !
  3945                                  
  3946                                  	; 01/12/2024
  3947 00001856 A3[AC370000]            	mov	[count], eax
  3948                                  
  3949                                  	;mov	edi, audio_buffer
  3950                                  	; 29/05/2024
  3951                                  	;mov	edi, [audio_buffer]
  3952                                  	
  3953 0000185B C1E802                  	shr	eax, 2
  3954 0000185E 7505                    	jnz	short lff24s2_8
  3955 00001860 E947F8FFFF              	jmp	lff24_eof
  3956                                  
  3957                                  lff24s2_8:
  3958 00001865 89C1                    	mov	ecx, eax  ; dword count
  3959                                  lff24s2_1:
  3960 00001867 66AD                    	lodsw
  3961 00001869 66AB                    	stosw		; original sample (L)
  3962 0000186B 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3963 0000186E 66A3[A3260000]          	mov	[previous_val_l], ax
  3964 00001874 66AD                    	lodsw
  3965 00001876 66AB                    	stosw		; original sample (R)
  3966 00001878 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3967                                  	;mov	[previous_val_r], ax
  3968 0000187B 89C3                    	mov	ebx, eax
  3969 0000187D 31D2                    	xor	edx, edx
  3970 0000187F 31C0                    	xor	eax, eax
  3971                                  	; 16/11/2023
  3972 00001881 49                      	dec	ecx
  3973 00001882 7407                    	jz	short lff24s2_2
  3974 00001884 668B06                  	mov	ax, [esi]
  3975 00001887 668B5602                	mov	dx, [esi+2]
  3976                                  lff24s2_2:
  3977 0000188B 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3978                                  	;;mov	[next_val_l], ax
  3979                                  	;mov	ebp, eax
  3980 0000188E 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  3981                                  	;mov	[next_val_r], dx
  3982 00001891 660305[A3260000]        	add	ax, [previous_val_l]
  3983 00001898 66D1D8                  	rcr	ax, 1
  3984 0000189B 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  3985 0000189E 66AB                    	stosw		; this is interpolated sample (L)
  3986                                  	;mov	ax, [next_val_r]
  3987 000018A0 89D0                    	mov	eax, edx
  3988                                  	;add	ax, [previous_val_r]
  3989 000018A2 6601D8                  	add	ax, bx
  3990 000018A5 66D1D8                  	rcr	ax, 1
  3991 000018A8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3992 000018AB 66AB                    	stosw		; this is interpolated sample (R)
  3993                                  	
  3994                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3995 000018AD 09C9                    	or	ecx, ecx
  3996 000018AF 75B6                    	jnz	short lff24s2_1
  3997 000018B1 E9DEF7FFFF              	jmp	lff24_3
  3998                                  
  3999                                  ; .....................
  4000                                  
  4001                                  load_32khz_mono_8_bit:
  4002                                  	; 15/11/2023
  4003 000018B6 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4004                                  					; last of the file?
  4005 000018BD 7402                    	jz	short lff32m_0		; no
  4006 000018BF F9                      	stc
  4007 000018C0 C3                      	retn
  4008                                  
  4009                                  lff32m_0:
  4010                                  	; 01/12/2024
  4011                                  	; edi = audio buffer address
  4012                                  	; 13/12/2024
  4013 000018C1 893D[E4310000]          	mov	[audio_buffer], edi
  4014 000018C7 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4015                                          ;mov	edx, [loadsize]
  4016                                  
  4017                                  	; esi = buffer address
  4018                                  	;; edx = buffer size
  4019                                  
  4020                                  	; load file into memory
  4021                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000018CC 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000018D2 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000018D4 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000018DA B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000018DF CD40                <1>  int 40h
  4022 000018E1 7247                    	jc	short lff32m_7 ; error !
  4023                                  
  4024                                  	; 01/12/2024
  4025 000018E3 A3[AC370000]            	mov	[count], eax
  4026                                  
  4027                                  	;mov	edi, audio_buffer
  4028                                  	; 29/05/2024
  4029                                  	;mov	edi, [audio_buffer]
  4030                                  	
  4031 000018E8 21C0                    	and	eax, eax
  4032 000018EA 7505                    	jnz	short lff32m_8
  4033 000018EC E9BBF7FFFF              	jmp	lff32_eof
  4034                                  
  4035                                  lff32m_8:
  4036 000018F1 89C1                    	mov	ecx, eax	; byte count
  4037                                  lff32m_1:
  4038 000018F3 AC                      	lodsb
  4039                                  	;mov	[previous_val], al
  4040 000018F4 88C3                    	mov	bl, al
  4041 000018F6 2C80                    	sub	al, 80h
  4042 000018F8 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4043 000018FC 66AB                    	stosw		; original sample (left channel)
  4044 000018FE 66AB                    	stosw		; original sample (right channel)
  4045                                  	;xor	eax, eax
  4046 00001900 B080                    	mov	al, 80h
  4047 00001902 49                      	dec	ecx
  4048 00001903 7402                    	jz	short lff32m_2
  4049 00001905 8A06                    	mov	al, [esi]
  4050                                  lff32m_2:
  4051                                  	;;mov	[next_val], al
  4052                                  	;mov	bh, al
  4053                                  	;add	al, [previous_val]
  4054 00001907 00D8                    	add	al, bl
  4055 00001909 D0D8                    	rcr	al, 1
  4056 0000190B 2C80                    	sub	al, 80h
  4057 0000190D 66C1E008                	shl	ax, 8
  4058 00001911 66AB                    	stosw		; this is interpolated sample (L)
  4059 00001913 66AB                    	stosw		; this is interpolated sample (R)
  4060                                  	
  4061                                  	; different than 8-16-24 kHZ !
  4062                                  	; 'original-interpolated-original' trio samples
  4063 00001915 E30E                    	jecxz	lff32m_3
  4064                                  
  4065 00001917 AC                      	lodsb
  4066 00001918 2C80                    	sub	al, 80h
  4067 0000191A 66C1E008                	shl	ax, 8
  4068 0000191E 66AB                    	stosw		; original sample (left channel)
  4069 00001920 66AB                    	stosw		; original sample (right channel)
  4070                                  
  4071                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  4072 00001922 49                      	dec	ecx
  4073 00001923 75CE                    	jnz	short lff32m_1
  4074                                  lff32m_3:
  4075 00001925 E96AF7FFFF              	jmp	lff32_3
  4076                                  
  4077                                  lff32m_7:
  4078                                  lff32s_7:
  4079 0000192A E986F7FFFF              	jmp	lff32_5  ; error
  4080                                  
  4081                                  load_32khz_stereo_8_bit:
  4082                                  	; 15/11/2023
  4083 0000192F F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4084                                  					; last of the file?
  4085 00001936 7402                    	jz	short lff32s_0		; no
  4086 00001938 F9                      	stc
  4087 00001939 C3                      	retn
  4088                                  
  4089                                  lff32s_0:
  4090                                  	; 01/12/2024
  4091                                  	; edi = audio buffer address
  4092                                  	; 13/12/2024
  4093 0000193A 893D[E4310000]          	mov	[audio_buffer], edi
  4094 00001940 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4095                                          ;mov	edx, [loadsize]
  4096                                  
  4097                                  	; esi = buffer address
  4098                                  	;; edx = buffer size
  4099                                  
  4100                                  	; load file into memory
  4101                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001945 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 0000194B 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 0000194D 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001953 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001958 CD40                <1>  int 40h
  4102 0000195A 72CE                    	jc	short lff32s_7 ; error !
  4103                                  
  4104                                  	; 01/12/2024
  4105 0000195C A3[AC370000]            	mov	[count], eax
  4106                                  
  4107                                  	;mov	edi, audio_buffer
  4108                                  	; 29/05/2024
  4109                                  	;mov	edi, [audio_buffer]
  4110                                  	
  4111 00001961 D1E8                    	shr	eax, 1
  4112 00001963 7505                    	jnz	short lff32s_8
  4113 00001965 E942F7FFFF              	jmp	lff32_eof
  4114                                  
  4115                                  lff32s_8:
  4116 0000196A 89C1                    	mov	ecx, eax  ; word count
  4117                                  lff32s_1:
  4118 0000196C AC                      	lodsb
  4119 0000196D A2[A3260000]            	mov	[previous_val_l], al
  4120 00001972 2C80                    	sub	al, 80h
  4121 00001974 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4122 00001978 66AB                    	stosw		; original sample (L)
  4123 0000197A AC                      	lodsb
  4124 0000197B A2[A5260000]            	mov	[previous_val_r], al
  4125 00001980 2C80                    	sub	al, 80h
  4126 00001982 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4127 00001986 66AB                    	stosw		; original sample (R)
  4128                                  
  4129                                  	;xor	eax, eax
  4130 00001988 66B88080                	mov	ax, 8080h
  4131 0000198C 49                      	dec	ecx
  4132 0000198D 7403                    	jz	short lff32s_2
  4133                                  		; convert 8 bit sample to 16 bit sample
  4134 0000198F 668B06                  	mov	ax, [esi]
  4135                                  lff32s_2:
  4136                                  	;;mov	[next_val_l], al
  4137                                  	;;mov	[next_val_r], ah
  4138                                  	;mov	bx, ax
  4139 00001992 88E7                    	mov	bh, ah
  4140 00001994 0205[A3260000]          	add	al, [previous_val_l]
  4141 0000199A D0D8                    	rcr	al, 1
  4142                                  	;mov	dl, al
  4143 0000199C 2C80                    	sub	al, 80h
  4144 0000199E 66C1E008                	shl	ax, 8
  4145 000019A2 66AB                    	stosw		; this is interpolated sample (L)
  4146 000019A4 88F8                    	mov	al, bh	; [next_val_r]
  4147 000019A6 0205[A5260000]          	add	al, [previous_val_r]
  4148 000019AC D0D8                    	rcr	al, 1
  4149                                  	;mov	dh, al
  4150 000019AE 2C80                    	sub	al, 80h
  4151 000019B0 66C1E008                	shl	ax, 8
  4152 000019B4 66AB                    	stosw		; this is interpolated sample (R)
  4153                                  
  4154                                  	; different than 8-16-24 kHZ !
  4155                                  	; 'original-interpolated-original' trio samples
  4156 000019B6 E315                    	jecxz	lff32s_3
  4157                                  
  4158 000019B8 AC                      	lodsb
  4159 000019B9 2C80                    	sub	al, 80h
  4160 000019BB 66C1E008                	shl	ax, 8
  4161 000019BF 66AB                    	stosw		; original sample (left channel)
  4162                                  
  4163 000019C1 AC                      	lodsb
  4164 000019C2 2C80                    	sub	al, 80h
  4165 000019C4 66C1E008                	shl	ax, 8
  4166 000019C8 66AB                    	stosw		; original sample (right channel)
  4167                                  		
  4168                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  4169 000019CA 49                      	dec	ecx
  4170 000019CB 759F                    	jnz	short lff32s_1
  4171                                  lff32s_3:
  4172 000019CD E9C2F6FFFF              	jmp	lff32_3
  4173                                  
  4174                                  load_32khz_mono_16_bit:
  4175                                  	; 15/11/2023
  4176 000019D2 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4177                                  					; last of the file?
  4178 000019D9 7402                    	jz	short lff32m2_0		; no
  4179 000019DB F9                      	stc
  4180 000019DC C3                      	retn
  4181                                  
  4182                                  lff32m2_0:
  4183                                  	; 01/12/2024
  4184                                  	; edi = audio buffer address
  4185                                  	; 13/12/2024
  4186 000019DD 893D[E4310000]          	mov	[audio_buffer], edi
  4187 000019E3 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4188                                          ;mov	edx, [loadsize]
  4189                                  
  4190                                  	; esi = buffer address
  4191                                  	;; edx = buffer size
  4192                                  
  4193                                  	; load file into memory
  4194                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000019E8 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000019EE 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000019F0 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000019F6 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 000019FB CD40                <1>  int 40h
  4195 000019FD 723E                    	jc	short lff32m2_7 ; error !
  4196                                  
  4197                                  	; 01/12/2024
  4198 000019FF A3[AC370000]            	mov	[count], eax
  4199                                  
  4200                                  	;mov	edi, audio_buffer
  4201                                  	; 29/05/2024
  4202                                  	;mov	edi, [audio_buffer]
  4203                                  	
  4204 00001A04 D1E8                    	shr	eax, 1
  4205 00001A06 7505                    	jnz	short lff32m2_8
  4206 00001A08 E99FF6FFFF              	jmp	lff32_eof
  4207                                  
  4208                                  lff32m2_8:
  4209 00001A0D 89C1                    	mov	ecx, eax  ; word count
  4210                                  lff32m2_1:
  4211 00001A0F 66AD                    	lodsw
  4212 00001A11 66AB                    	stosw		; original sample (left channel)
  4213 00001A13 66AB                    	stosw		; original sample (right channel)
  4214 00001A15 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4215                                  	;mov	[previous_val], ax
  4216                                  	;mov	ebx, eax
  4217                                  	;xor	eax, eax
  4218 00001A18 31DB                    	xor	ebx, ebx
  4219 00001A1A 49                      	dec	ecx
  4220 00001A1B 7403                    	jz	short lff32m2_2
  4221                                  	;mov	ax, [esi]
  4222 00001A1D 668B1E                  	mov	bx, [esi]
  4223                                  lff32m2_2:
  4224                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  4225                                  	;mov	ebp, eax	; [next_val]
  4226                                  	;add	ax, [previous_val]
  4227                                  	; ax = [previous_val]
  4228                                  	; bx = [next_val]
  4229 00001A20 6601D8                  	add	ax, bx
  4230 00001A23 66D1D8                  	rcr	ax, 1
  4231 00001A26 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4232 00001A29 66AB                    	stosw		; this is interpolated sample (L)
  4233 00001A2B 66AB                    	stosw		; this is interpolated sample (R)
  4234                                  
  4235                                  	; different than 8-16-24 kHZ !
  4236                                  	; 'original-interpolated-original' trio samples 
  4237 00001A2D E309                    	jecxz	lff32m2_3
  4238                                  
  4239 00001A2F 66AD                    	lodsw
  4240 00001A31 66AB                    	stosw		; original sample (left channel)
  4241 00001A33 66AB                    	stosw		; original sample (right channel)
  4242                                  
  4243                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  4244 00001A35 49                      	dec	ecx
  4245 00001A36 75D7                    	jnz	short lff32m2_1
  4246                                  lff32m2_3:
  4247 00001A38 E957F6FFFF              	jmp	lff32_3
  4248                                  
  4249                                  lff32m2_7:
  4250                                  lff32s2_7:
  4251 00001A3D E973F6FFFF              	jmp	lff32_5  ; error
  4252                                  
  4253                                  load_32khz_stereo_16_bit:
  4254                                  	; 16/11/2023
  4255                                  	; 15/11/2023
  4256 00001A42 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4257                                  					; last of the file?
  4258 00001A49 7402                    	jz	short lff32s2_0		; no
  4259 00001A4B F9                      	stc
  4260 00001A4C C3                      	retn
  4261                                  
  4262                                  lff32s2_0:
  4263                                  	; 01/12/2024
  4264                                  	; edi = audio buffer address
  4265                                  	; 13/12/2024
  4266 00001A4D 893D[E4310000]          	mov	[audio_buffer], edi
  4267 00001A53 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4268                                          ;mov	edx, [loadsize]
  4269                                  
  4270                                  	; esi = buffer address
  4271                                  	;; edx = buffer size
  4272                                  
  4273                                  	; load file into memory
  4274                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001A58 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001A5E 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001A60 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001A66 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001A6B CD40                <1>  int 40h
  4275 00001A6D 72CE                    	jc	short lff32s2_7 ; error !
  4276                                  
  4277                                  	; 01/12/2024
  4278 00001A6F A3[AC370000]            	mov	[count], eax
  4279                                  
  4280                                  	;mov	edi, audio_buffer
  4281                                  	; 29/05/2024
  4282                                  	;mov	edi, [audio_buffer]
  4283                                  	
  4284 00001A74 C1E802                  	shr	eax, 2
  4285 00001A77 7505                    	jnz	short lff32s2_8
  4286 00001A79 E92EF6FFFF              	jmp	lff32_eof
  4287                                  
  4288                                  lff32s2_8:
  4289 00001A7E 89C1                    	mov	ecx, eax ; dword count
  4290                                  lff32s2_1:
  4291 00001A80 66AD                    	lodsw
  4292 00001A82 66AB                    	stosw		; original sample (L)
  4293 00001A84 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  4294 00001A87 66A3[A3260000]          	mov	[previous_val_l], ax
  4295 00001A8D 66AD                    	lodsw
  4296 00001A8F 66AB                    	stosw		; original sample (R)
  4297 00001A91 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  4298                                  	;mov	[previous_val_r], ax
  4299 00001A94 89C3                    	mov	ebx, eax
  4300 00001A96 31D2                    	xor	edx, edx
  4301 00001A98 31C0                    	xor	eax, eax
  4302                                  	; 16/11/2023
  4303 00001A9A 49                      	dec	ecx
  4304 00001A9B 7407                    	jz	short lff32s2_2
  4305 00001A9D 668B06                  	mov	ax, [esi]
  4306 00001AA0 668B5602                	mov	dx, [esi+2]
  4307                                  lff32s2_2:
  4308 00001AA4 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  4309                                  	;;mov	[next_val_l], ax
  4310                                  	;mov	ebp, eax
  4311 00001AA7 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  4312                                  	;mov	[next_val_r], dx
  4313 00001AAA 660305[A3260000]        	add	ax, [previous_val_l]
  4314 00001AB1 66D1D8                  	rcr	ax, 1
  4315 00001AB4 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  4316 00001AB7 66AB                    	stosw		; this is interpolated sample (L)
  4317                                  	;mov	ax, [next_val_r]
  4318 00001AB9 89D0                    	mov	eax, edx
  4319                                  	;add	ax, [previous_val_r]
  4320 00001ABB 6601D8                  	add	ax, bx
  4321 00001ABE 66D1D8                  	rcr	ax, 1
  4322 00001AC1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4323 00001AC4 66AB                    	stosw		; this is interpolated sample (R)
  4324                                  
  4325                                  	; different than 8-16-24 kHZ !
  4326                                  	; 'original-interpolated-original' trio samples
  4327 00001AC6 E30B                    	jecxz	lff32s2_3
  4328                                  
  4329 00001AC8 66AD                    	lodsw
  4330 00001ACA 66AB                    	stosw	; original sample (L)
  4331 00001ACC 66AD                    	lodsw
  4332 00001ACE 66AB                    	stosw	; original sample (R)
  4333                                  	
  4334                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  4335 00001AD0 49                      	dec	ecx
  4336 00001AD1 75AD                    	jnz	short lff32s2_1
  4337                                  lff32s2_3:
  4338 00001AD3 E9BCF5FFFF              	jmp	lff32_3
  4339                                  
  4340                                  ; .....................
  4341                                  
  4342                                  load_22khz_mono_8_bit:
  4343                                  	; 16/11/2023
  4344 00001AD8 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4345                                  					; last of the file?
  4346 00001ADF 7402                    	jz	short lff22m_0		; no
  4347 00001AE1 F9                      	stc
  4348 00001AE2 C3                      	retn
  4349                                  
  4350                                  lff22m_0:
  4351                                  	; 01/12/2024
  4352                                  	; edi = audio buffer address
  4353                                  	; 13/12/2024
  4354 00001AE3 893D[E4310000]          	mov	[audio_buffer], edi
  4355 00001AE9 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4356                                          ;mov	edx, [loadsize]
  4357                                  
  4358                                  	; esi = buffer address
  4359                                  	;; edx = buffer size
  4360                                  
  4361                                  	; load file into memory
  4362                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001AEE 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001AF4 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001AF6 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001AFC B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001B01 CD40                <1>  int 40h
  4363 00001B03 725D                    	jc	short lff22m_7 ; error !
  4364                                  
  4365                                  	; 01/12/2024
  4366 00001B05 A3[AC370000]            	mov	[count], eax
  4367                                  
  4368                                  	;mov	edi, audio_buffer
  4369                                  	; 29/05/2024
  4370                                  	;mov	edi, [audio_buffer]
  4371                                  	
  4372 00001B0A 21C0                    	and	eax, eax
  4373 00001B0C 7505                    	jnz	short lff22m_8
  4374 00001B0E E999F5FFFF              	jmp	lff22_eof
  4375                                  
  4376                                  lff22m_8:
  4377 00001B13 89C1                    	mov	ecx, eax	; byte count
  4378                                  lff22m_9:
  4379 00001B15 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4380 00001B1A C605[AB260000]03        	mov	byte [faz], 3  ; 3 steps/phases
  4381                                  lff22m_1:
  4382                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4383 00001B21 AC                      	lodsb
  4384 00001B22 B280                    	mov	dl, 80h
  4385 00001B24 49                      	dec	ecx
  4386 00001B25 7402                    	jz	short lff22m_2_1
  4387 00001B27 8A16                    	mov	dl, [esi]
  4388                                  lff22m_2_1:	
  4389                                  	; al = [previous_val]
  4390                                  	; dl = [next_val]
  4391 00001B29 E831060000              	call	interpolating_3_8bit_mono ; 1 of 17
  4392 00001B2E E32D                    	jecxz	lff22m_3
  4393                                  lff22m_2_2:
  4394 00001B30 AC                      	lodsb
  4395 00001B31 B280                    	mov	dl, 80h
  4396 00001B33 49                      	dec	ecx
  4397 00001B34 7402                    	jz	short lff22m_2_3
  4398 00001B36 8A16                    	mov	dl, [esi]
  4399                                  lff22m_2_3:
  4400 00001B38 E8A6060000               	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  4401 00001B3D E31E                    	jecxz	lff22m_3
  4402 00001B3F 4D                      	dec	ebp
  4403 00001B40 75EE                    	jnz	short lff22m_2_2
  4404                                  
  4405 00001B42 A0[AB260000]            	mov	al, [faz]
  4406 00001B47 FEC8                    	dec	al
  4407 00001B49 74CA                    	jz	short lff22m_9
  4408 00001B4B FE0D[AB260000]          	dec	byte [faz]
  4409 00001B51 BD04000000              	mov	ebp, 4
  4410 00001B56 FEC8                    	dec	al
  4411 00001B58 75C7                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  4412 00001B5A 45                      	inc	ebp ; 5
  4413 00001B5B EBC4                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4414                                  
  4415                                  lff22m_3:
  4416                                  lff22s_3:
  4417 00001B5D E932F5FFFF              	jmp	lff22_3	; padfill
  4418                                  		; (put zeros in the remain words of the buffer)
  4419                                  lff22m_7:
  4420                                  lff22s_7:
  4421 00001B62 E94EF5FFFF              	jmp	lff22_5  ; error
  4422                                  
  4423                                  load_22khz_stereo_8_bit:
  4424                                  	; 16/11/2023
  4425 00001B67 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4426                                  					; last of the file?
  4427 00001B6E 7402                    	jz	short lff22s_0		; no
  4428 00001B70 F9                      	stc
  4429 00001B71 C3                      	retn
  4430                                  
  4431                                  lff22s_0:
  4432                                  	; 01/12/2024
  4433                                  	; edi = audio buffer address
  4434                                  	; 13/12/2024
  4435 00001B72 893D[E4310000]          	mov	[audio_buffer], edi
  4436 00001B78 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4437                                          ;mov	edx, [loadsize]
  4438                                  
  4439                                  	; esi = buffer address
  4440                                  	;; edx = buffer size
  4441                                  
  4442                                  	; load file into memory
  4443                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001B7D 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001B83 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001B85 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001B8B B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001B90 CD40                <1>  int 40h
  4444 00001B92 72CE                    	jc	short lff22s_7 ; error !
  4445                                  
  4446                                  	; 01/12/2024
  4447 00001B94 A3[AC370000]            	mov	[count], eax
  4448                                  
  4449                                  	;mov	edi, audio_buffer
  4450                                  	; 29/05/2024
  4451                                  	;mov	edi, [audio_buffer]
  4452                                  	
  4453 00001B99 D1E8                    	shr	eax, 1
  4454 00001B9B 7505                    	jnz	short lff22s_8
  4455 00001B9D E90AF5FFFF              	jmp	lff22_eof
  4456                                  
  4457                                  lff22s_8:
  4458 00001BA2 89C1                    	mov	ecx, eax	; word count
  4459                                  lff22s_9:
  4460 00001BA4 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4461 00001BA9 C605[AB260000]03        	mov	byte [faz], 3  ; 3 steps/phase
  4462                                  lff22s_1:
  4463                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4464 00001BB0 66AD                    	lodsw
  4465 00001BB2 66BA8080                	mov	dx, 8080h
  4466 00001BB6 49                      	dec	ecx
  4467 00001BB7 7403                    	jz	short lff22s_2_1
  4468 00001BB9 668B16                  	mov	dx, [esi]
  4469                                  lff22s_2_1:	
  4470                                  	; al = [previous_val_l]
  4471                                  	; ah = [previous_val_r]
  4472                                  	; dl = [next_val_l]
  4473                                  	; dh = [next_val_r]
  4474 00001BBC E8CF050000              	call	interpolating_3_8bit_stereo ; 1 of 17
  4475 00001BC1 E39A                    	jecxz	lff22s_3
  4476                                  lff22s_2_2:
  4477 00001BC3 66AD                    	lodsw
  4478 00001BC5 66BA8080                	mov	dx, 8080h
  4479 00001BC9 49                      	dec	ecx
  4480 00001BCA 7403                    	jz	short lff22s_2_3
  4481 00001BCC 668B16                  	mov	dx, [esi]
  4482                                  lff22s_2_3:
  4483 00001BCF E82C060000               	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  4484 00001BD4 E387                    	jecxz	lff22s_3
  4485 00001BD6 4D                      	dec	ebp
  4486 00001BD7 75EA                    	jnz	short lff22s_2_2
  4487                                  
  4488 00001BD9 A0[AB260000]            	mov	al, [faz]
  4489 00001BDE FEC8                    	dec	al
  4490 00001BE0 74C2                    	jz	short lff22s_9
  4491 00001BE2 FE0D[AB260000]          	dec	byte [faz]
  4492 00001BE8 BD04000000              	mov	ebp, 4
  4493 00001BED FEC8                    	dec	al
  4494 00001BEF 75BF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  4495 00001BF1 45                      	inc	ebp ; 5
  4496 00001BF2 EBBC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4497                                  
  4498                                  load_22khz_mono_16_bit:
  4499                                  	; 16/11/2023
  4500 00001BF4 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4501                                  					; last of the file?
  4502 00001BFB 7402                    	jz	short lff22m2_0		; no
  4503 00001BFD F9                      	stc
  4504 00001BFE C3                      	retn
  4505                                  
  4506                                  lff22m2_0:
  4507                                  	; 01/12/2024
  4508                                  	; edi = audio buffer address
  4509                                  	; 13/12/2024
  4510 00001BFF 893D[E4310000]          	mov	[audio_buffer], edi
  4511 00001C05 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4512                                          ;mov	edx, [loadsize]
  4513                                  
  4514                                  	; esi = buffer address
  4515                                  	;; edx = buffer size
  4516                                  
  4517                                  	; load file into memory
  4518                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001C0A 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001C10 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001C12 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001C18 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001C1D CD40                <1>  int 40h
  4519 00001C1F 7261                    	jc	short lff22m2_7 ; error !
  4520                                  
  4521                                  	; 01/12/2024
  4522 00001C21 A3[AC370000]            	mov	[count], eax
  4523                                  
  4524                                  	;mov	edi, audio_buffer
  4525                                  	; 29/05/2024
  4526                                  	;mov	edi, [audio_buffer]
  4527                                  	
  4528 00001C26 D1E8                    	shr	eax, 1
  4529 00001C28 7505                    	jnz	short lff22m2_8
  4530 00001C2A E97DF4FFFF              	jmp	lff22_eof
  4531                                  
  4532                                  lff22m2_8:
  4533 00001C2F 89C1                    	mov	ecx, eax	; word count
  4534                                  lff22m2_9:
  4535 00001C31 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4536 00001C36 C605[AB260000]03        	mov	byte [faz], 3  ; 3 steps/phases
  4537                                  lff22m2_1:
  4538                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4539 00001C3D 66AD                    	lodsw
  4540 00001C3F 31D2                    	xor	edx, edx
  4541 00001C41 49                      	dec	ecx
  4542 00001C42 7403                    	jz	short lff22m2_2_1
  4543 00001C44 668B16                  	mov	dx, [esi]
  4544                                  lff22m2_2_1:	
  4545                                  	; ax = [previous_val]
  4546                                  	; dx = [next_val]
  4547 00001C47 E8E5050000              	call	interpolating_3_16bit_mono ; 1 of 17
  4548 00001C4C E32F                    	jecxz	lff22m2_3
  4549                                  lff22m2_2_2:
  4550 00001C4E 66AD                    	lodsw
  4551 00001C50 31D2                    	xor	edx, edx
  4552 00001C52 49                      	dec	ecx
  4553 00001C53 7403                    	jz	short lff22m2_2_3
  4554 00001C55 668B16                  	mov	dx, [esi]
  4555                                  lff22m2_2_3:
  4556 00001C58 E867060000               	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  4557 00001C5D E31E                    	jecxz	lff22m2_3
  4558 00001C5F 4D                      	dec	ebp
  4559 00001C60 75EC                    	jnz	short lff22m2_2_2
  4560                                  
  4561 00001C62 A0[AB260000]            	mov	al, [faz]
  4562 00001C67 FEC8                    	dec	al
  4563 00001C69 74C6                    	jz	short lff22m2_9
  4564 00001C6B FE0D[AB260000]          	dec	byte [faz]
  4565 00001C71 BD04000000              	mov	ebp, 4
  4566 00001C76 FEC8                    	dec	al
  4567 00001C78 75C3                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  4568 00001C7A 45                      	inc	ebp ; 5
  4569 00001C7B EBC0                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4570                                  
  4571                                  lff22m2_3:
  4572                                  lff22s2_3:
  4573 00001C7D E912F4FFFF              	jmp	lff22_3	; padfill
  4574                                  		; (put zeros in the remain words of the buffer)
  4575                                  lff22m2_7:
  4576                                  lff22s2_7:
  4577 00001C82 E92EF4FFFF              	jmp	lff22_5  ; error
  4578                                  
  4579                                  load_22khz_stereo_16_bit:
  4580                                  	; 16/11/2023
  4581 00001C87 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4582                                  					; last of the file?
  4583 00001C8E 7402                    	jz	short lff22s2_0		; no
  4584 00001C90 F9                      	stc
  4585 00001C91 C3                      	retn
  4586                                  
  4587                                  lff22s2_0:
  4588                                  	; 01/12/2024
  4589                                  	; edi = audio buffer address
  4590                                  	; 13/12/2024
  4591 00001C92 893D[E4310000]          	mov	[audio_buffer], edi
  4592 00001C98 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4593                                          ;mov	edx, [loadsize]
  4594                                  
  4595                                  	; esi = buffer address
  4596                                  	;; edx = buffer size
  4597                                  
  4598                                  	; load file into memory
  4599                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001C9D 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001CA3 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001CA5 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001CAB B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001CB0 CD40                <1>  int 40h
  4600 00001CB2 72CE                    	jc	short lff22s2_7 ; error !
  4601                                  
  4602                                  	; 01/12/2024
  4603 00001CB4 A3[AC370000]            	mov	[count], eax
  4604                                  
  4605                                  	;mov	edi, audio_buffer
  4606                                  	; 29/05/2024
  4607                                  	;mov	edi, [audio_buffer]
  4608                                  	
  4609 00001CB9 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  4610 00001CBC 7505                    	jnz	short lff22s2_8
  4611 00001CBE E9E9F3FFFF              	jmp	lff22_eof
  4612                                  
  4613                                  lff22s2_8:
  4614 00001CC3 89C1                    	mov	ecx, eax	; dword count
  4615                                  lff22s2_9:
  4616 00001CC5 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4617 00001CCA C605[AB260000]03        	mov	byte [faz], 3  ; 3 steps/phase
  4618                                  lff22s2_1:
  4619                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4620 00001CD1 66AD                    	lodsw
  4621 00001CD3 89C3                    	mov	ebx, eax
  4622 00001CD5 66AD                    	lodsw
  4623 00001CD7 8B16                    	mov	edx, [esi]
  4624 00001CD9 668915[A7260000]        	mov	[next_val_l], dx
  4625                                  	; 26/11/2023
  4626 00001CE0 C1EA10                  	shr	edx, 16
  4627 00001CE3 49                      	dec	ecx
  4628 00001CE4 7509                    	jnz	short lff22s2_2_1
  4629 00001CE6 31D2                    	xor	edx, edx ; 0
  4630 00001CE8 668915[A7260000]        	mov	[next_val_l], dx
  4631                                  lff22s2_2_1:
  4632                                  	; bx = [previous_val_l]
  4633                                  	; ax = [previous_val_r]
  4634                                  	; [next_val_l]
  4635                                  	; dx = [next_val_r]
  4636 00001CEF E86D050000              	call	interpolating_3_16bit_stereo ; 1 of 17 
  4637 00001CF4 E387                    	jecxz	lff22s2_3
  4638                                  lff22s2_2_2:
  4639 00001CF6 66AD                    	lodsw
  4640 00001CF8 89C3                    	mov	ebx, eax
  4641 00001CFA 66AD                    	lodsw
  4642 00001CFC 8B16                    	mov	edx, [esi]
  4643 00001CFE 668915[A7260000]        	mov	[next_val_l], dx
  4644                                  	; 26/11/2023
  4645 00001D05 C1EA10                  	shr	edx, 16
  4646 00001D08 49                      	dec	ecx
  4647 00001D09 7509                    	jnz	short lff22s2_2_3
  4648 00001D0B 31D2                    	xor	edx, edx ; 0
  4649 00001D0D 668915[A7260000]        	mov	[next_val_l], dx
  4650                                  lff22s2_2_3:
  4651 00001D14 E8C3050000               	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  4652 00001D19 E31E                    	jecxz	lff22s2_2_4
  4653                                  
  4654 00001D1B 4D                      	dec	ebp
  4655 00001D1C 75D8                    	jnz	short lff22s2_2_2
  4656                                  
  4657 00001D1E A0[AB260000]            	mov	al, [faz]
  4658 00001D23 FEC8                    	dec	al
  4659 00001D25 749E                    	jz	short lff22s2_9
  4660 00001D27 FE0D[AB260000]          	dec	byte [faz]
  4661 00001D2D BD04000000              	mov	ebp, 4
  4662 00001D32 FEC8                    	dec	al
  4663 00001D34 759B                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  4664 00001D36 45                      	inc	ebp ; 5
  4665 00001D37 EB98                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4666                                  
  4667                                  lff22s2_2_4:
  4668                                  	; 26/11/2023
  4669 00001D39 E956F3FFFF              	jmp	lff22_3	; padfill
  4670                                  
  4671                                  ; .....................
  4672                                  
  4673                                  load_11khz_mono_8_bit:
  4674                                  	; 18/11/2023
  4675 00001D3E F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4676                                  					; last of the file?
  4677 00001D45 7402                    	jz	short lff11m_0		; no
  4678 00001D47 F9                      	stc
  4679 00001D48 C3                      	retn
  4680                                  
  4681                                  lff11m_0:
  4682                                  	; 01/12/2024
  4683                                  	; edi = audio buffer address
  4684                                  	; 13/12/2024
  4685 00001D49 893D[E4310000]          	mov	[audio_buffer], edi
  4686 00001D4F BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4687                                          ;mov	edx, [loadsize]
  4688                                  
  4689                                  	; esi = buffer address
  4690                                  	;; edx = buffer size
  4691                                  
  4692                                  	; load file into memory
  4693                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001D54 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001D5A 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001D5C 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001D62 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001D67 CD40                <1>  int 40h
  4694 00001D69 7247                    	jc	short lff11m_7 ; error !
  4695                                  
  4696                                  	; 01/12/2024
  4697 00001D6B A3[AC370000]            	mov	[count], eax
  4698                                  
  4699                                  	;mov	edi, audio_buffer
  4700                                  	; 29/05/2024
  4701                                  	;mov	edi, [audio_buffer]
  4702                                  	
  4703 00001D70 21C0                    	and	eax, eax
  4704 00001D72 7505                    	jnz	short lff11m_8
  4705 00001D74 E933F3FFFF              	jmp	lff11_eof
  4706                                  
  4707                                  lff11m_8:
  4708 00001D79 89C1                    	mov	ecx, eax		; byte count
  4709                                  lff11m_9:
  4710 00001D7B BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4711                                  lff11m_1:
  4712                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4713 00001D80 AC                      	lodsb
  4714 00001D81 B280                    	mov	dl, 80h
  4715 00001D83 49                      	dec	ecx
  4716 00001D84 7402                    	jz	short lff11m_2_1
  4717 00001D86 8A16                    	mov	dl, [esi]
  4718                                  lff11m_2_1:	
  4719                                  	; al = [previous_val]
  4720                                  	; dl = [next_val]
  4721 00001D88 E87E050000              	call	interpolating_5_8bit_mono
  4722 00001D8D E333                    	jecxz	lff11m_3
  4723                                  lff11m_2_2:
  4724 00001D8F AC                      	lodsb
  4725 00001D90 B280                    	mov	dl, 80h
  4726 00001D92 49                      	dec	ecx
  4727 00001D93 7402                    	jz	short lff11m_2_3
  4728 00001D95 8A16                    	mov	dl, [esi]
  4729                                  lff11m_2_3:
  4730 00001D97 E87B060000               	call	interpolating_4_8bit_mono
  4731 00001D9C E324                    	jecxz	lff11m_3
  4732                                  
  4733 00001D9E 4D                      	dec	ebp
  4734 00001D9F 74DA                    	jz	short lff11m_9
  4735                                  
  4736 00001DA1 AC                      	lodsb
  4737 00001DA2 B280                    	mov	dl, 80h
  4738 00001DA4 49                      	dec	ecx
  4739 00001DA5 7402                    	jz	short lff11m_2_4
  4740 00001DA7 8A16                    	mov	dl, [esi]
  4741                                  lff11m_2_4:
  4742 00001DA9 E869060000              	call	interpolating_4_8bit_mono
  4743 00001DAE E312                    	jecxz	lff11m_3
  4744 00001DB0 EBCE                    	jmp	short lff11m_1
  4745                                  
  4746                                  lff11m_7:
  4747                                  lff11s_7:
  4748 00001DB2 E9FEF2FFFF              	jmp	lff11_5  ; error
  4749                                  
  4750                                  load_11khz_stereo_8_bit:
  4751                                  	; 18/11/2023
  4752 00001DB7 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4753                                  					; last of the file?
  4754 00001DBE 7407                    	jz	short lff11s_0		; no
  4755 00001DC0 F9                      	stc
  4756 00001DC1 C3                      	retn
  4757                                  
  4758                                  lff11m_3:
  4759                                  lff11s_3:
  4760 00001DC2 E9CDF2FFFF              	jmp	lff11_3	; padfill
  4761                                  		; (put zeros in the remain words of the buffer)
  4762                                  
  4763                                  lff11s_0:
  4764                                  	; 01/12/2024
  4765                                  	; edi = audio buffer address
  4766                                  	; 13/12/2024
  4767 00001DC7 893D[E4310000]          	mov	[audio_buffer], edi
  4768 00001DCD BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4769                                          ;mov	edx, [loadsize]
  4770                                  
  4771                                  	; esi = buffer address
  4772                                  	;; edx = buffer size
  4773                                  
  4774                                  	; load file into memory
  4775                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001DD2 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001DD8 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001DDA 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001DE0 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001DE5 CD40                <1>  int 40h
  4776 00001DE7 72C9                    	jc	short lff11s_7 ; error !
  4777                                  
  4778                                  	; 01/12/2024
  4779 00001DE9 A3[AC370000]            	mov	[count], eax
  4780                                  
  4781                                  	;mov	edi, audio_buffer
  4782                                  	; 29/05/2024
  4783                                  	;mov	edi, [audio_buffer]
  4784                                  	
  4785 00001DEE D1E8                    	shr	eax, 1
  4786 00001DF0 7505                    	jnz	short lff11s_8
  4787 00001DF2 E9B5F2FFFF              	jmp	lff11_eof
  4788                                  
  4789                                  lff11s_8:
  4790 00001DF7 89C1                    	mov	ecx, eax	; word count
  4791                                  lff11s_9:
  4792 00001DF9 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4793                                  lff11s_1:
  4794                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4795 00001DFE 66AD                    	lodsw
  4796 00001E00 66BA8080                	mov	dx, 8080h
  4797 00001E04 49                      	dec	ecx
  4798 00001E05 7403                    	jz	short lff11s_2_1
  4799 00001E07 668B16                  	mov	dx, [esi]
  4800                                  lff11s_2_1:	
  4801                                  	; al = [previous_val_l]
  4802                                  	; ah = [previous_val_r]
  4803                                  	; dl = [next_val_l]
  4804                                  	; dh = [next_val_r]
  4805 00001E0A E85B050000              	call	interpolating_5_8bit_stereo
  4806 00001E0F E3B1                    	jecxz	lff11s_3
  4807                                  lff11s_2_2:
  4808 00001E11 66AD                    	lodsw
  4809 00001E13 66BA8080                	mov	dx, 8080h
  4810 00001E17 49                      	dec	ecx
  4811 00001E18 7403                    	jz	short lff11s_2_3
  4812 00001E1A 668B16                  	mov	dx, [esi]
  4813                                  lff11s_2_3:
  4814 00001E1D E834060000               	call	interpolating_4_8bit_stereo
  4815 00001E22 E39E                    	jecxz	lff11s_3
  4816                                  	
  4817 00001E24 4D                      	dec	ebp
  4818 00001E25 74D2                    	jz	short lff11s_9
  4819                                  
  4820 00001E27 66AD                    	lodsw
  4821 00001E29 66BA8080                	mov	dx, 8080h
  4822 00001E2D 49                      	dec	ecx
  4823 00001E2E 7403                    	jz	short lff11s_2_4
  4824 00001E30 668B16                  	mov	dx, [esi]
  4825                                  lff11s_2_4:
  4826 00001E33 E81E060000              	call	interpolating_4_8bit_stereo
  4827 00001E38 E388                    	jecxz	lff11s_3
  4828 00001E3A EBC2                    	jmp	short lff11s_1
  4829                                  
  4830                                  load_11khz_mono_16_bit:
  4831                                  	; 18/11/2023
  4832 00001E3C F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4833                                  					; last of the file?
  4834 00001E43 7402                    	jz	short lff11m2_0		; no
  4835 00001E45 F9                      	stc
  4836 00001E46 C3                      	retn
  4837                                  
  4838                                  lff11m2_0:
  4839                                  	; 01/12/2024
  4840                                  	; edi = audio buffer address
  4841                                  	; 13/12/2024
  4842 00001E47 893D[E4310000]          	mov	[audio_buffer], edi
  4843 00001E4D BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4844                                          ;mov	edx, [loadsize]
  4845                                  
  4846                                  	; esi = buffer address
  4847                                  	;; edx = buffer size
  4848                                  
  4849                                  	; load file into memory
  4850                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001E52 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001E58 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001E5A 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001E60 B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001E65 CD40                <1>  int 40h
  4851 00001E67 724D                    	jc	short lff11m2_7 ; error !
  4852                                  
  4853                                  	; 01/12/2024
  4854 00001E69 A3[AC370000]            	mov	[count], eax
  4855                                  
  4856                                  	;mov	edi, audio_buffer
  4857                                  	; 29/05/2024
  4858                                  	;mov	edi, [audio_buffer]
  4859                                  	
  4860 00001E6E D1E8                    	shr	eax, 1
  4861 00001E70 7505                    	jnz	short lff11m2_8
  4862 00001E72 E935F2FFFF              	jmp	lff11_eof
  4863                                  
  4864                                  lff11m2_8:
  4865 00001E77 89C1                    	mov	ecx, eax	; word count
  4866                                  lff11m2_9:
  4867 00001E79 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4868                                  lff11m2_1:
  4869                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4870 00001E7E 66AD                    	lodsw
  4871 00001E80 31D2                    	xor	edx, edx
  4872 00001E82 49                      	dec	ecx
  4873 00001E83 7403                    	jz	short lff11m2_2_1
  4874 00001E85 668B16                  	mov	dx, [esi]
  4875                                  lff11m2_2_1:	
  4876                                  	; ax = [previous_val]
  4877                                  	; dx = [next_val]
  4878 00001E88 E836060000              	call	interpolating_5_16bit_mono
  4879 00001E8D E368                    	jecxz	lff11m2_3
  4880                                  lff11m2_2_2:
  4881 00001E8F 66AD                    	lodsw
  4882 00001E91 31D2                    	xor	edx, edx
  4883 00001E93 49                      	dec	ecx
  4884 00001E94 7403                    	jz	short lff11m2_2_3
  4885 00001E96 668B16                  	mov	dx, [esi]
  4886                                  lff11m2_2_3:
  4887 00001E99 E84F070000               	call	interpolating_4_16bit_mono
  4888 00001E9E E357                    	jecxz	lff11m2_3
  4889                                  
  4890 00001EA0 4D                      	dec	ebp
  4891 00001EA1 74D6                    	jz	short lff11m2_9
  4892                                  
  4893 00001EA3 66AD                    	lodsw
  4894 00001EA5 31D2                    	xor	edx, edx
  4895 00001EA7 49                      	dec	ecx
  4896 00001EA8 7403                    	jz	short lff11m2_2_4
  4897 00001EAA 668B16                  	mov	dx, [esi]
  4898                                  lff11m2_2_4:
  4899 00001EAD E83B070000               	call	interpolating_4_16bit_mono
  4900 00001EB2 E343                    	jecxz	lff11m2_3
  4901 00001EB4 EBC8                    	jmp	short lff11m2_1
  4902                                  
  4903                                  lff11m2_7:
  4904                                  lff11s2_7:
  4905 00001EB6 E9FAF1FFFF              	jmp	lff11_5  ; error
  4906                                  
  4907                                  load_11khz_stereo_16_bit:
  4908                                  	; 18/01/2025
  4909                                  	; 18/11/2023
  4910 00001EBB F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4911                                  					; last of the file?
  4912 00001EC2 7402                    	jz	short lff11s2_0		; no
  4913 00001EC4 F9                      	stc
  4914 00001EC5 C3                      	retn
  4915                                  
  4916                                  lff11s2_0:
  4917                                  	; 01/12/2024
  4918                                  	; edi = audio buffer address
  4919                                  	; 13/12/2024
  4920 00001EC6 893D[E4310000]          	mov	[audio_buffer], edi
  4921 00001ECC BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4922                                          ;mov	edx, [loadsize]
  4923                                  
  4924                                  	; esi = buffer address
  4925                                  	;; edx = buffer size
  4926                                  
  4927                                  	; load file into memory
  4928                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001ED1 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001ED7 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001ED9 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001EDF B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001EE4 CD40                <1>  int 40h
  4929 00001EE6 72CE                    	jc	short lff11s2_7 ; error !
  4930                                  
  4931                                  	; 01/12/2024
  4932 00001EE8 A3[AC370000]            	mov	[count], eax
  4933                                  
  4934                                  	;mov	edi, audio_buffer
  4935                                  	; 29/05/2024
  4936                                  	;mov	edi, [audio_buffer]
  4937                                  	
  4938 00001EED C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  4939 00001EF0 750A                    	jnz	short lff11s2_8
  4940 00001EF2 E9B5F1FFFF              	jmp	lff11_eof
  4941                                  
  4942                                  lff11m2_3:
  4943                                  lff11s2_3:
  4944 00001EF7 E998F1FFFF              	jmp	lff11_3	; padfill
  4945                                  		; (put zeros in the remain words of the buffer)
  4946                                  
  4947                                  lff11s2_8:
  4948 00001EFC 89C1                    	mov	ecx, eax	; dword count
  4949                                  lff11s2_9:
  4950 00001EFE BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4951                                  lff11s2_1:
  4952                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4953 00001F03 66AD                    	lodsw
  4954 00001F05 89C3                    	mov	ebx, eax
  4955 00001F07 66AD                    	lodsw
  4956 00001F09 8B16                    	mov	edx, [esi]
  4957                                  	; 18/01/2025
  4958                                  	;mov	[next_val_l], edx
  4959                                  	; 26/11/2023
  4960                                  	;shr	edx, 16
  4961                                  	;mov	[next_val_r], dx
  4962 00001F0B 49                      	dec	ecx
  4963 00001F0C 7502                    	jnz	short lff11s2_2_1
  4964 00001F0E 31D2                    	xor	edx, edx ; 0
  4965                                  	;mov	[next_val_l], dx
  4966                                  	;mov	[next_val_r], dx
  4967                                  lff11s2_2_1:
  4968                                  	; bx = [previous_val_l]
  4969                                  	; ax = [previous_val_r]
  4970                                  	; [next_val_l]
  4971                                  	; dx = [next_val_r]
  4972                                  	;;;
  4973                                  	; 18/01/2025 (BugFix)
  4974 00001F10 8915[A7260000]          	mov	[next_val_l], edx
  4975                                  	;;;
  4976 00001F16 E803060000              	call	interpolating_5_16bit_stereo
  4977 00001F1B E3DA                    	jecxz	lff11s2_3
  4978                                  lff11s2_2_2:
  4979 00001F1D 66AD                    	lodsw
  4980 00001F1F 89C3                    	mov	ebx, eax
  4981 00001F21 66AD                    	lodsw
  4982 00001F23 8B16                    	mov	edx, [esi]
  4983                                  	; 18/01/2025
  4984                                  	;mov	[next_val_l], dx
  4985                                  	; 26/11/2023
  4986                                  	;shr	edx, 16
  4987                                  	;mov	[next_val_r], dx
  4988 00001F25 49                      	dec	ecx
  4989 00001F26 7502                    	jnz	short lff11s2_2_3
  4990 00001F28 31D2                    	xor	edx, edx ; 0
  4991                                  	;mov	[next_val_l], dx
  4992                                  	;mov	[next_val_r], dx
  4993                                  lff11s2_2_3:
  4994                                  	;;;
  4995                                  	; 18/01/2025 (BugFix)
  4996 00001F2A 8915[A7260000]          	mov	[next_val_l], edx
  4997                                  	;;;
  4998 00001F30 E8F1060000              	call	interpolating_4_16bit_stereo
  4999 00001F35 E3C0                    	jecxz	lff11s2_3
  5000                                  	
  5001 00001F37 4D                      	dec	ebp
  5002 00001F38 74C4                    	jz	short lff11s2_9
  5003                                  
  5004 00001F3A 66AD                    	lodsw
  5005 00001F3C 89C3                    	mov	ebx, eax
  5006 00001F3E 66AD                    	lodsw
  5007 00001F40 8B16                    	mov	edx, [esi]
  5008                                  	; 18/01/2025
  5009                                  	;mov	[next_val_l], dx
  5010                                  	; 26/11/2023
  5011                                  	;shr	edx, 16
  5012                                  	;mov	[next_val_r], dx
  5013 00001F42 49                      	dec	ecx
  5014 00001F43 7502                    	jnz	short lff11s2_2_4
  5015 00001F45 31D2                    	xor	edx, edx ; 0
  5016                                  	;mov	[next_val_l], dx
  5017                                  	;mov	[next_val_r], dx
  5018                                  lff11s2_2_4:
  5019                                  	;;;
  5020                                  	; 18/01/2025 (BugFix)
  5021 00001F47 8915[A7260000]          	mov	[next_val_l], edx
  5022                                  	;;;
  5023 00001F4D E8D4060000               	call	interpolating_4_16bit_stereo
  5024 00001F52 E3A3                    	jecxz	lff11s2_3
  5025 00001F54 EBAD                    	jmp	short lff11s2_1
  5026                                  
  5027                                  ; .....................
  5028                                  
  5029                                  load_44khz_mono_8_bit:
  5030                                  	; 18/11/2023
  5031 00001F56 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  5032                                  					; last of the file?
  5033 00001F5D 7402                    	jz	short lff44m_0		; no
  5034 00001F5F F9                      	stc
  5035 00001F60 C3                      	retn
  5036                                  
  5037                                  lff44m_0:
  5038                                  	; 01/12/2024
  5039                                  	; edi = audio buffer address
  5040                                  	; 13/12/2024
  5041 00001F61 893D[E4310000]          	mov	[audio_buffer], edi
  5042 00001F67 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5043                                          ;mov	edx, [loadsize]
  5044                                  
  5045                                  	; esi = buffer address
  5046                                  	;; edx = buffer size
  5047                                  
  5048                                  	; load file into memory
  5049                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001F6C 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001F72 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001F74 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001F7A B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00001F7F CD40                <1>  int 40h
  5050 00001F81 7250                    	jc	short lff44m_7 ; error !
  5051                                  
  5052                                  	; 01/12/2024
  5053 00001F83 A3[AC370000]            	mov	[count], eax
  5054                                  
  5055                                  	;mov	edi, audio_buffer
  5056                                  	; 29/05/2024
  5057                                  	;mov	edi, [audio_buffer]
  5058                                  	
  5059 00001F88 21C0                    	and	eax, eax
  5060 00001F8A 7505                    	jnz	short lff44m_8
  5061 00001F8C E91BF1FFFF              	jmp	lff44_eof
  5062                                  
  5063                                  lff44m_8:
  5064 00001F91 89C1                    	mov	ecx, eax	; byte count
  5065                                  lff44m_9:
  5066 00001F93 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5067 00001F98 C605[AB260000]02        	mov	byte [faz], 2  ; 2 steps/phases
  5068                                  lff44m_1:
  5069                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5070                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5071 00001F9F AC                      	lodsb
  5072 00001FA0 B280                    	mov	dl, 80h
  5073 00001FA2 49                      	dec	ecx
  5074 00001FA3 7402                    	jz	short lff44m_2_1
  5075 00001FA5 8A16                    	mov	dl, [esi]
  5076                                  lff44m_2_1:	
  5077                                  	; al = [previous_val]
  5078                                  	; dl = [next_val]
  5079 00001FA7 E837020000              	call	interpolating_2_8bit_mono
  5080 00001FAC E320                    	jecxz	lff44m_3
  5081                                  lff44m_2_2:
  5082 00001FAE AC                      	lodsb
  5083 00001FAF 2C80                    	sub	al, 80h
  5084 00001FB1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5085 00001FB5 66AB                    	stosw		; (L)
  5086 00001FB7 66AB                    	stosw		; (R)
  5087                                  
  5088 00001FB9 49                      	dec	ecx
  5089 00001FBA 7412                    	jz	short lff44m_3
  5090 00001FBC 4D                      	dec	ebp
  5091 00001FBD 75EF                    	jnz	short lff44m_2_2
  5092                                  	
  5093 00001FBF FE0D[AB260000]          	dec	byte [faz]
  5094 00001FC5 74CC                    	jz	short lff44m_9 
  5095 00001FC7 BD0B000000              	mov	ebp, 11
  5096 00001FCC EBD1                    	jmp	short lff44m_1
  5097                                  
  5098                                  lff44m_3:
  5099                                  lff44s_3:
  5100 00001FCE E9C1F0FFFF              	jmp	lff44_3	; padfill
  5101                                  		; (put zeros in the remain words of the buffer)
  5102                                  lff44m_7:
  5103                                  lff44s_7:
  5104 00001FD3 E9DDF0FFFF              	jmp	lff44_5  ; error
  5105                                  
  5106                                  load_44khz_stereo_8_bit:
  5107                                  	; 16/11/2023
  5108 00001FD8 F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  5109                                  					; last of the file?
  5110 00001FDF 7402                    	jz	short lff44s_0		; no
  5111 00001FE1 F9                      	stc
  5112 00001FE2 C3                      	retn
  5113                                  
  5114                                  lff44s_0:
  5115                                  	; 01/12/2024
  5116                                  	; edi = audio buffer address
  5117                                  	; 13/12/2024
  5118 00001FE3 893D[E4310000]          	mov	[audio_buffer], edi
  5119 00001FE9 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5120                                          ;mov	edx, [loadsize]
  5121                                  
  5122                                  	; esi = buffer address
  5123                                  	;; edx = buffer size
  5124                                  
  5125                                  	; load file into memory
  5126                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00001FEE 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00001FF4 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00001FF6 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00001FFC B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00002001 CD40                <1>  int 40h
  5127 00002003 72CE                    	jc	short lff44s_7 ; error !
  5128                                  
  5129                                  	; 01/12/2024
  5130 00002005 A3[AC370000]            	mov	[count], eax
  5131                                  
  5132                                  	;mov	edi, audio_buffer
  5133                                  	; 29/05/2024
  5134                                  	;mov	edi, [audio_buffer]
  5135                                  	
  5136 0000200A D1E8                    	shr	eax, 1
  5137 0000200C 7505                    	jnz	short lff44s_8
  5138 0000200E E999F0FFFF              	jmp	lff44_eof
  5139                                  
  5140                                  lff44s_8:
  5141 00002013 89C1                    	mov	ecx, eax	; word count
  5142                                  lff44s_9:
  5143 00002015 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5144 0000201A C605[AB260000]02        	mov	byte [faz], 2  ; 2 steps/phase
  5145                                  lff44s_1:
  5146                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5147                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5148 00002021 66AD                    	lodsw
  5149 00002023 66BA8080                	mov	dx, 8080h
  5150 00002027 49                      	dec	ecx
  5151 00002028 7403                    	jz	short lff44s_2_1
  5152 0000202A 668B16                  	mov	dx, [esi]
  5153                                  lff44s_2_1:	
  5154                                  	; al = [previous_val_l]
  5155                                  	; ah = [previous_val_r]
  5156                                  	; dl = [next_val_l]
  5157                                  	; dh = [next_val_r]
  5158 0000202D E8CE010000              	call	interpolating_2_8bit_stereo
  5159 00002032 E39A                    	jecxz	lff44s_3
  5160                                  lff44s_2_2:
  5161 00002034 AC                      	lodsb
  5162 00002035 2C80                    	sub	al, 80h
  5163 00002037 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5164 0000203B 66AB                    	stosw		; (L)
  5165 0000203D AC                      	lodsb
  5166 0000203E 2C80                    	sub	al, 80h
  5167 00002040 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5168 00002044 66AB                    	stosw		; (R)
  5169                                  
  5170 00002046 49                      	dec	ecx
  5171 00002047 7485                    	jz	short lff44s_3	
  5172 00002049 4D                      	dec	ebp
  5173 0000204A 75E8                    	jnz	short lff44s_2_2
  5174                                  	
  5175 0000204C FE0D[AB260000]          	dec	byte [faz]
  5176 00002052 74C1                    	jz	short lff44s_9 
  5177 00002054 BD0B000000              	mov	ebp, 11
  5178 00002059 EBC6                    	jmp	short lff44s_1
  5179                                  
  5180                                  load_44khz_mono_16_bit:
  5181                                  	; 18/11/2023
  5182 0000205B F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  5183                                  					; last of the file?
  5184 00002062 7402                    	jz	short lff44m2_0		; no
  5185 00002064 F9                      	stc
  5186 00002065 C3                      	retn
  5187                                  
  5188                                  lff44m2_0:
  5189                                  	; 01/12/2024
  5190                                  	; edi = audio buffer address
  5191                                  	; 13/12/2024
  5192 00002066 893D[E4310000]          	mov	[audio_buffer], edi
  5193 0000206C BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5194                                          ;mov	edx, [loadsize]
  5195                                  
  5196                                  	; esi = buffer address
  5197                                  	;; edx = buffer size
  5198                                  
  5199                                  	; load file into memory
  5200                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00002071 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 00002077 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 00002079 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 0000207F B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00002084 CD40                <1>  int 40h
  5201 00002086 724D                    	jc	short lff44m2_7 ; error !
  5202                                  
  5203                                  	; 01/12/2024
  5204 00002088 A3[AC370000]            	mov	[count], eax
  5205                                  
  5206                                  	;mov	edi, audio_buffer
  5207                                  	; 29/05/2024
  5208                                  	;mov	edi, [audio_buffer]
  5209                                  	
  5210 0000208D D1E8                    	shr	eax, 1
  5211 0000208F 7505                    	jnz	short lff44m2_8
  5212 00002091 E916F0FFFF              	jmp	lff44_eof
  5213                                  
  5214                                  lff44m2_8:
  5215 00002096 89C1                    	mov	ecx, eax	; word count
  5216                                  lff44m2_9:
  5217 00002098 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5218 0000209D C605[AB260000]02        	mov	byte [faz], 2  ; 2 steps/phases
  5219                                  lff44m2_1:
  5220                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5221                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5222 000020A4 66AD                    	lodsw
  5223 000020A6 31D2                    	xor	edx, edx
  5224 000020A8 49                      	dec	ecx
  5225 000020A9 7403                    	jz	short lff44m2_2_1
  5226 000020AB 668B16                  	mov	dx, [esi]
  5227                                  lff44m2_2_1:	
  5228                                  	; ax = [previous_val]
  5229                                  	; dx = [next_val]
  5230 000020AE E811020000              	call	interpolating_2_16bit_mono
  5231 000020B3 E31B                    	jecxz	lff44m2_3
  5232                                  lff44m2_2_2:
  5233 000020B5 66AD                    	lodsw
  5234 000020B7 66AB                    	stosw		; (L)eft Channel
  5235 000020B9 66AB                    	stosw		; (R)ight Channel
  5236                                  
  5237 000020BB 49                      	dec	ecx
  5238 000020BC 7412                    	jz	short lff44m2_3	
  5239 000020BE 4D                      	dec	ebp
  5240 000020BF 75F4                    	jnz	short lff44m2_2_2
  5241                                  	
  5242 000020C1 FE0D[AB260000]          	dec	byte [faz]
  5243 000020C7 74CF                    	jz	short lff44m2_9 
  5244 000020C9 BD0B000000              	mov	ebp, 11
  5245 000020CE EBD4                    	jmp	short lff44m2_1
  5246                                  
  5247                                  lff44m2_3:
  5248                                  lff44s2_3:
  5249 000020D0 E9BFEFFFFF              	jmp	lff44_3	; padfill
  5250                                  		; (put zeros in the remain words of the buffer)
  5251                                  lff44m2_7:
  5252                                  lff44s2_7:
  5253 000020D5 E9DBEFFFFF              	jmp	lff44_5  ; error
  5254                                  
  5255                                  load_44khz_stereo_16_bit:
  5256                                  	; 18/11/2023
  5257 000020DA F605[26370000]01                test    byte [flags], ENDOFFILE	; have we already read the
  5258                                  					; last of the file?
  5259 000020E1 7402                    	jz	short lff44s2_0		; no
  5260 000020E3 F9                      	stc
  5261 000020E4 C3                      	retn
  5262                                  
  5263                                  lff44s2_0:
  5264                                  	; 01/12/2024
  5265                                  	; edi = audio buffer address
  5266                                  	; 13/12/2024
  5267 000020E5 893D[E4310000]          	mov	[audio_buffer], edi
  5268 000020EB BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5269                                          ;mov	edx, [loadsize]
  5270                                  
  5271                                  	; esi = buffer address
  5272                                  	;; edx = buffer size
  5273                                  
  5274                                  	; load file into memory
  5275                                  	sys 	_read, [filehandle], esi, [loadsize]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 000020F0 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99 000020F6 89F1                <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101 000020F8 8B15[9C370000]      <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 000020FE B803000000          <1>  mov eax, %1
   106                              <1> 
   107 00002103 CD40                <1>  int 40h
  5276 00002105 72CE                    	jc	short lff44s2_7 ; error !
  5277                                  
  5278                                  	; 01/12/2024
  5279 00002107 A3[AC370000]            	mov	[count], eax
  5280                                  
  5281                                  	;mov	edi, audio_buffer
  5282                                  	; 29/05/2024
  5283                                  	;mov	edi, [audio_buffer]
  5284                                  	
  5285 0000210C C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  5286 0000210F 7505                    	jnz	short lff44s2_8
  5287 00002111 E996EFFFFF              	jmp	lff44_eof
  5288                                  
  5289                                  lff44s2_8:
  5290 00002116 89C1                    	mov	ecx, eax	; dword count
  5291                                  lff44s2_9:
  5292 00002118 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5293 0000211D C605[AB260000]02        	mov	byte [faz], 2  ; 2 steps/phase
  5294                                  lff44s2_1:
  5295                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5296                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5297 00002124 66AD                    	lodsw
  5298 00002126 89C3                    	mov	ebx, eax
  5299 00002128 66AD                    	lodsw
  5300                                  	;mov	dx, [esi]
  5301                                  	;mov	[next_val_l], dx
  5302                                  	;mov	dx, [esi+2]
  5303                                  	; 26/11/2023
  5304 0000212A 8B16                    	mov	edx, [esi]
  5305 0000212C 668915[A7260000]        	mov	[next_val_l], dx
  5306 00002133 C1EA10                  	shr	edx, 16
  5307 00002136 49                      	dec	ecx
  5308 00002137 7509                    	jnz	short lff44s2_2_1
  5309 00002139 31D2                    	xor	edx, edx ; 0
  5310 0000213B 668915[A7260000]        	mov	[next_val_l], dx
  5311                                  lff44s2_2_1:
  5312                                  	; bx = [previous_val_l]
  5313                                  	; ax = [previous_val_r]
  5314                                  	; [next_val_l]
  5315                                  	; dx = [next_val_r]
  5316 00002142 E895010000              	call	interpolating_2_16bit_stereo
  5317 00002147 E387                    	jecxz	lff44s2_3
  5318                                  lff44s2_2_2:
  5319                                  	;movsw		; (L)eft Channel
  5320                                  	;movsw		; (R)ight Channel
  5321 00002149 A5                      	movsd
  5322                                  
  5323 0000214A 49                      	dec	ecx
  5324 0000214B 7483                    	jz	short lff44s2_3	
  5325 0000214D 4D                      	dec	ebp
  5326 0000214E 75F9                    	jnz	short lff44s2_2_2
  5327                                  	
  5328 00002150 FE0D[AB260000]          	dec	byte [faz]
  5329 00002156 74C0                    	jz	short lff44s2_9 
  5330 00002158 BD0B000000              	mov	ebp, 11
  5331 0000215D EBC5                    	jmp	short lff44s2_1
  5332                                  
  5333                                  ; .....................
  5334                                  
  5335                                  interpolating_3_8bit_mono:
  5336                                  	; 16/11/2023
  5337                                  	; al = [previous_val]
  5338                                  	; dl = [next_val]
  5339                                  	; original-interpolated-interpolated
  5340 0000215F 88C3                    	mov	bl, al
  5341 00002161 2C80                    	sub	al, 80h
  5342 00002163 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5343 00002167 66AB                    	stosw		; original sample (L)
  5344 00002169 66AB                    	stosw		; original sample (R)
  5345 0000216B 88D8                    	mov	al, bl
  5346 0000216D 00D0                    	add	al, dl
  5347 0000216F D0D8                    	rcr	al, 1
  5348 00002171 88C7                    	mov	bh, al	; interpolated middle (temporary)
  5349 00002173 00D8                    	add	al, bl
  5350 00002175 D0D8                    	rcr	al, 1
  5351 00002177 2C80                    	sub	al, 80h
  5352 00002179 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5353 0000217D 66AB                    	stosw		; interpolated sample 1 (L)
  5354 0000217F 66AB                    	stosw		; interpolated sample 1 (R)
  5355 00002181 88F8                    	mov	al, bh
  5356 00002183 00D0                    	add	al, dl	; [next_val]
  5357 00002185 D0D8                    	rcr	al, 1
  5358 00002187 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5359 0000218B 66AB                    	stosw		; interpolated sample 2 (L)
  5360 0000218D 66AB                    	stosw		; interpolated sample 2 (R)
  5361 0000218F C3                      	retn
  5362                                  
  5363                                  interpolating_3_8bit_stereo:
  5364                                  	; 16/11/2023
  5365                                  	; al = [previous_val_l]
  5366                                  	; ah = [previous_val_r]
  5367                                  	; dl = [next_val_l]
  5368                                  	; dh = [next_val_r]
  5369                                  	; original-interpolated-interpolated
  5370 00002190 89C3                    	mov	ebx, eax
  5371 00002192 2C80                    	sub	al, 80h
  5372 00002194 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5373 00002198 66AB                    	stosw		; original sample (L)
  5374 0000219A 88F8                    	mov	al, bh
  5375 0000219C 2C80                    	sub	al, 80h
  5376 0000219E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5377 000021A2 66AB                    	stosw		; original sample (R)
  5378 000021A4 88D8                    	mov	al, bl
  5379 000021A6 00D0                    	add	al, dl	; [next_val_l]
  5380 000021A8 D0D8                    	rcr	al, 1
  5381 000021AA 50                      	push	eax ; *	; al = interpolated middle (L) (temporary)
  5382 000021AB 00D8                    	add	al, bl	; [previous_val_l]
  5383 000021AD D0D8                    	rcr	al, 1
  5384 000021AF 2C80                    	sub	al, 80h
  5385 000021B1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5386 000021B5 66AB                    	stosw		; interpolated sample 1 (L)
  5387 000021B7 88F8                    	mov	al, bh
  5388 000021B9 00F0                    	add	al, dh	; [next_val_r]
  5389 000021BB D0D8                    	rcr	al, 1
  5390 000021BD 50                      	push	eax ; ** ; al = interpolated middle (R) (temporary)
  5391 000021BE 00F8                    	add	al, bh	; [previous_val_r]
  5392 000021C0 D0D8                    	rcr	al, 1
  5393 000021C2 2C80                    	sub	al, 80h
  5394 000021C4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5395 000021C8 66AB                    	stosw		; interpolated sample 1 (R)
  5396 000021CA 5B                      	pop	ebx ; **
  5397 000021CB 58                      	pop	eax ; *
  5398 000021CC 00D0                    	add	al, dl	; [next_val_l]
  5399 000021CE D0D8                    	rcr	al, 1
  5400 000021D0 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5401 000021D4 66AB                    	stosw		; interpolated sample 2 (L)
  5402 000021D6 88D8                    	mov	al, bl
  5403 000021D8 00F0                    	add	al, dh	; [next_val_r]
  5404 000021DA D0D8                    	rcr	al, 1
  5405 000021DC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5406 000021E0 66AB                    	stosw		; interpolated sample 2 (R)
  5407 000021E2 C3                      	retn
  5408                                  
  5409                                  interpolating_2_8bit_mono:
  5410                                  	; 16/11/2023
  5411                                  	; al = [previous_val]
  5412                                  	; dl = [next_val]
  5413                                  	; original-interpolated
  5414 000021E3 88C3                    	mov	bl, al
  5415 000021E5 2C80                    	sub	al, 80h
  5416 000021E7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5417 000021EB 66AB                    	stosw		; original sample (L)
  5418 000021ED 66AB                    	stosw		; original sample (R)
  5419 000021EF 88D8                    	mov	al, bl
  5420 000021F1 00D0                    	add	al, dl
  5421 000021F3 D0D8                    	rcr	al, 1
  5422 000021F5 2C80                    	sub	al, 80h
  5423 000021F7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5424 000021FB 66AB                    	stosw		; interpolated sample (L)
  5425 000021FD 66AB                    	stosw		; interpolated sample (R)
  5426 000021FF C3                      	retn
  5427                                  
  5428                                  interpolating_2_8bit_stereo:
  5429                                  	; 16/11/2023
  5430                                  	; al = [previous_val_l]
  5431                                  	; ah = [previous_val_r]
  5432                                  	; dl = [next_val_l]
  5433                                  	; dh = [next_val_r]
  5434                                  	; original-interpolated
  5435 00002200 89C3                    	mov	ebx, eax
  5436 00002202 2C80                    	sub	al, 80h
  5437 00002204 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5438 00002208 66AB                    	stosw		; original sample (L)
  5439 0000220A 88F8                    	mov	al, bh
  5440 0000220C 2C80                    	sub	al, 80h
  5441 0000220E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5442 00002212 66AB                    	stosw		; original sample (R)
  5443 00002214 88D8                    	mov	al, bl	; [previous_val_l]
  5444 00002216 00D0                    	add	al, dl	; [next_val_l]
  5445 00002218 D0D8                    	rcr	al, 1
  5446 0000221A 2C80                    	sub	al, 80h
  5447 0000221C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5448 00002220 66AB                    	stosw		; interpolated sample (L)
  5449 00002222 88F8                    	mov	al, bh
  5450 00002224 00F0                    	add	al, dh	; [next_val_r]
  5451 00002226 D0D8                    	rcr	al, 1
  5452 00002228 2C80                    	sub	al, 80h
  5453 0000222A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5454 0000222E 66AB                    	stosw		; interpolated sample (R)
  5455 00002230 C3                      	retn
  5456                                  
  5457                                  interpolating_3_16bit_mono:
  5458                                  	; 16/11/2023
  5459                                  	; ax = [previous_val]
  5460                                  	; dx = [next_val]
  5461                                  	; original-interpolated-interpolated
  5462                                  
  5463 00002231 66AB                    	stosw		; original sample (L)
  5464 00002233 66AB                    	stosw		; original sample (R)
  5465 00002235 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5466 00002238 50                      	push	eax ; *	; [previous_val]
  5467 00002239 80C680                  	add	dh, 80h
  5468 0000223C 6601D0                  	add	ax, dx
  5469 0000223F 66D1D8                  	rcr	ax, 1
  5470 00002242 5B                      	pop	ebx ; *
  5471 00002243 93                      	xchg	ebx, eax ; bx  = interpolated middle (temporary)
  5472 00002244 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  5473 00002247 66D1D8                  	rcr	ax, 1
  5474 0000224A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5475 0000224D 66AB                    	stosw 		; interpolated sample 1 (L)
  5476 0000224F 66AB                    	stosw		; interpolated sample 1 (R)
  5477 00002251 89D8                    	mov	eax, ebx
  5478 00002253 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  5479 00002256 66D1D8                  	rcr	ax, 1
  5480 00002259 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5481 0000225C 66AB                    	stosw		; interpolated sample 2 (L)
  5482 0000225E 66AB                    	stosw		; interpolated sample 2 (R)
  5483 00002260 C3                      	retn
  5484                                  
  5485                                  interpolating_3_16bit_stereo:
  5486                                  	; 16/11/2023
  5487                                  	; bx = [previous_val_l]
  5488                                  	; ax = [previous_val_r]
  5489                                  	; [next_val_l]
  5490                                  	; dx = [next_val_r]
  5491                                  	; original-interpolated-interpolated
  5492                                  
  5493 00002261 93                      	xchg	eax, ebx
  5494 00002262 66AB                    	stosw		; original sample (L)
  5495 00002264 93                      	xchg	eax, ebx
  5496 00002265 66AB                    	stosw		; original sample (R)
  5497 00002267 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5498 0000226A 50                      	push	eax ; *	; [previous_val_r]
  5499 0000226B 80C780                  	add	bh, 80h
  5500 0000226E 8005[A8260000]80        	add	byte [next_val_l+1], 80h
  5501 00002275 66A1[A7260000]          	mov	ax, [next_val_l]
  5502 0000227B 6601D8                  	add	ax, bx	; [previous_val_l]
  5503 0000227E 66D1D8                  	rcr	ax, 1
  5504 00002281 93                      	xchg	eax, ebx ; ax = [previous_val_l]
  5505 00002282 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  5506 00002285 66D1D8                  	rcr	ax, 1
  5507 00002288 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5508 0000228B 66AB                    	stosw 		; interpolated sample 1 (L)
  5509 0000228D 58                      	pop	eax  ; *
  5510 0000228E 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  5511 00002291 52                      	push	edx  ; * ; [next_val_r]
  5512 00002292 92                      	xchg	eax, edx
  5513 00002293 6601D0                  	add	ax, dx	; [next_val_r] + [previous_val_r]
  5514 00002296 66D1D8                  	rcr	ax, 1	; / 2
  5515 00002299 50                      	push	eax ; ** ; interpolated middle (R)
  5516 0000229A 6601D0                  	add	ax, dx	; + [previous_val_r]
  5517 0000229D 66D1D8                  	rcr	ax, 1
  5518 000022A0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5519 000022A3 66AB                    	stosw 		; interpolated sample 1 (R)
  5520 000022A5 66A1[A7260000]          	mov	ax, [next_val_l]
  5521 000022AB 6601D8                  	add	ax, bx	; + interpolated middle (L)
  5522 000022AE 66D1D8                  	rcr	ax, 1
  5523 000022B1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5524 000022B4 66AB                    	stosw 		; interpolated sample 2 (L)
  5525 000022B6 58                      	pop	eax ; **
  5526 000022B7 5A                      	pop	edx ; *
  5527 000022B8 6601D0                  	add	ax, dx	; interpolated middle + [next_val_r]
  5528 000022BB 66D1D8                  	rcr	ax, 1	; / 2
  5529 000022BE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5530 000022C1 66AB                    	stosw 		; interpolated sample 2 (L)
  5531 000022C3 C3                      	retn
  5532                                  
  5533                                  interpolating_2_16bit_mono:
  5534                                  	; 16/11/2023
  5535                                  	; ax = [previous_val]
  5536                                  	; dx = [next_val]
  5537                                  	; original-interpolated
  5538                                  
  5539 000022C4 66AB                    	stosw		; original sample (L)
  5540 000022C6 66AB                    	stosw		; original sample (R)
  5541 000022C8 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5542 000022CB 80C680                  	add	dh, 80h
  5543 000022CE 6601D0                  	add	ax, dx
  5544 000022D1 66D1D8                  	rcr	ax, 1
  5545 000022D4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5546 000022D7 66AB                    	stosw		; interpolated sample (L)
  5547 000022D9 66AB                    	stosw		; interpolated sample (R)
  5548 000022DB C3                      	retn
  5549                                  
  5550                                  interpolating_2_16bit_stereo:
  5551                                  	; 18/01/2025
  5552                                  	; 16/11/2023
  5553                                  	; bx = [previous_val_l]
  5554                                  	; ax = [previous_val_r]
  5555                                  	; [next_val_l]
  5556                                  	; dx = [next_val_r]
  5557                                  	; original-interpolated
  5558                                  
  5559 000022DC 93                      	xchg	eax, ebx
  5560 000022DD 66AB                    	stosw		; original sample (L)
  5561 000022DF 93                      	xchg	eax, ebx
  5562 000022E0 66AB                    	stosw		; original sample (R)
  5563 000022E2 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5564 000022E5 80C680                  	add	dh, 80h
  5565 000022E8 6601D0                  	add	ax, dx	; [previous_val_r] + [next_val_r]
  5566 000022EB 66D1D8                  	rcr	ax, 1	; / 2
  5567                                  	; 18/01/2025
  5568 000022EE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5569                                  	;push	eax ; *	; interpolated sample (R)
  5570                                  	; 18/01/2025
  5571 000022F1 C1E010                  	shl	eax, 16
  5572 000022F4 66A1[A7260000]          	mov	ax, [next_val_l]
  5573 000022FA 80C480                  	add	ah, 80h
  5574 000022FD 80C780                  	add	bh, 80h
  5575 00002300 6601D8                  	add	ax, bx	; [next_val_l] + [previous_val_l]
  5576 00002303 66D1D8                  	rcr	ax, 1	; / 2
  5577 00002306 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5578                                  	; 18/01/2025
  5579                                  	;stosw 		; interpolated sample (L)
  5580                                  	;pop	eax ; *	
  5581                                  	;sub	ah, 80h	; -32768 to +32767 format again
  5582                                  	;stosw 		; interpolated sample (R)
  5583                                  	; 18/01/2025
  5584 00002309 AB                      	stosd
  5585 0000230A C3                      	retn
  5586                                  
  5587                                  interpolating_5_8bit_mono:
  5588                                  	; 17/11/2023
  5589                                  	; al = [previous_val]
  5590                                  	; dl = [next_val]
  5591                                  	; original-interpltd-interpltd-interpltd-interpltd
  5592 0000230B 88C3                    	mov	bl, al
  5593 0000230D 2C80                    	sub	al, 80h
  5594 0000230F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5595 00002313 66AB                    	stosw		; original sample (L)
  5596 00002315 66AB                    	stosw		; original sample (R)
  5597 00002317 88D8                    	mov	al, bl
  5598 00002319 00D0                    	add	al, dl
  5599 0000231B D0D8                    	rcr	al, 1
  5600 0000231D 88C7                    	mov	bh, al	; interpolated middle (temporary)
  5601 0000231F 00D8                    	add	al, bl  ; [previous_val]
  5602 00002321 D0D8                    	rcr	al, 1 	
  5603 00002323 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  5604 00002325 00D8                    	add	al, bl
  5605 00002327 D0D8                    	rcr	al, 1
  5606 00002329 2C80                    	sub	al, 80h
  5607 0000232B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5608 0000232F 66AB                    	stosw		; interpolated sample 1 (L)
  5609 00002331 66AB                    	stosw		; interpolated sample 1 (R)
  5610 00002333 88F8                    	mov	al, bh
  5611 00002335 00F0                    	add	al, dh
  5612 00002337 D0D8                    	rcr	al, 1
  5613 00002339 2C80                    	sub	al, 80h
  5614 0000233B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5615 0000233F 66AB                    	stosw		; interpolated sample 2 (L)
  5616 00002341 66AB                    	stosw		; interpolated sample 2 (R)
  5617 00002343 88F8                    	mov	al, bh
  5618 00002345 00D0                    	add	al, dl	; [next_val]
  5619 00002347 D0D8                    	rcr	al, 1
  5620 00002349 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  5621 0000234B 00F8                    	add	al, bh
  5622 0000234D D0D8                    	rcr	al, 1
  5623 0000234F 2C80                    	sub	al, 80h
  5624 00002351 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5625 00002355 66AB                    	stosw		; interpolated sample 3 (L)
  5626 00002357 66AB                    	stosw		; interpolated sample 3 (R)
  5627 00002359 88F0                    	mov	al, dh
  5628 0000235B 00D0                    	add	al, dl
  5629 0000235D D0D8                    	rcr	al, 1
  5630 0000235F 2C80                    	sub	al, 80h
  5631 00002361 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5632 00002365 66AB                    	stosw		; interpolated sample 4 (L)
  5633 00002367 66AB                    	stosw		; interpolated sample 4 (R)
  5634 00002369 C3                      	retn
  5635                                  
  5636                                  interpolating_5_8bit_stereo:
  5637                                  	; 17/11/2023
  5638                                  	; al = [previous_val_l]
  5639                                  	; ah = [previous_val_r]
  5640                                  	; dl = [next_val_l]
  5641                                  	; dh = [next_val_r]
  5642                                  	; original-interpltd-interpltd-interpltd-interpltd
  5643 0000236A 89C3                    	mov	ebx, eax
  5644 0000236C 2C80                    	sub	al, 80h
  5645 0000236E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5646 00002372 66AB                    	stosw		; original sample (L)
  5647 00002374 88F8                    	mov	al, bh
  5648 00002376 2C80                    	sub	al, 80h
  5649 00002378 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5650 0000237C 66AB                    	stosw		; original sample (R)
  5651 0000237E 52                      	push	edx ; *
  5652 0000237F 88D8                    	mov	al, bl
  5653 00002381 00D0                    	add	al, dl	; [next_val_l]
  5654 00002383 D0D8                    	rcr	al, 1
  5655 00002385 50                      	push	eax ; **	; al = interpolated middle (L) (temporary)
  5656 00002386 00D8                    	add	al, bl	; [previous_val_l]
  5657 00002388 D0D8                    	rcr	al, 1
  5658 0000238A 86D8                    	xchg	al, bl
  5659 0000238C 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  5660 0000238E D0D8                    	rcr	al, 1
  5661 00002390 2C80                    	sub	al, 80h
  5662 00002392 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5663 00002396 66AB                    	stosw		; interpolated sample 1 (L)
  5664 00002398 88F8                    	mov	al, bh
  5665 0000239A 00F0                    	add	al, dh	; [next_val_r]
  5666 0000239C D0D8                    	rcr	al, 1
  5667 0000239E 50                      	push	eax ; *** ; al = interpolated middle (R) (temporary)
  5668 0000239F 00F8                    	add	al, bh	; [previous_val_r]
  5669 000023A1 D0D8                    	rcr	al, 1
  5670 000023A3 86F8                    	xchg	al, bh
  5671 000023A5 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  5672 000023A7 D0D8                    	rcr	al, 1
  5673 000023A9 2C80                    	sub	al, 80h
  5674 000023AB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5675 000023AF 66AB                    	stosw		; interpolated sample 1 (R)
  5676 000023B1 5A                      	pop	edx ; ***
  5677 000023B2 58                      	pop	eax ; **	; al = interpolated middle (L) (temporary)
  5678 000023B3 86D8                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  5679 000023B5 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  5680 000023B7 D0D8                    	rcr	al, 1
  5681 000023B9 2C80                    	sub	al, 80h
  5682 000023BB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5683 000023BF 66AB                    	stosw		; interpolated sample 2 (L)
  5684 000023C1 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  5685 000023C3 86F8                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  5686 000023C5 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  5687 000023C7 D0D8                    	rcr	al, 1
  5688 000023C9 2C80                    	sub	al, 80h
  5689 000023CB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5690 000023CF 66AB                    	stosw		; interpolated sample 2 (R)
  5691 000023D1 5A                      	pop	edx ; *
  5692 000023D2 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  5693 000023D4 00D0                    	add	al, dl	; [next_val_l]
  5694 000023D6 D0D8                    	rcr	al, 1
  5695 000023D8 86D8                    	xchg	al, bl	; al = interpolated middle (R) (temporary)
  5696 000023DA 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp)
  5697 000023DC D0D8                    	rcr	al, 1
  5698 000023DE 2C80                    	sub	al, 80h
  5699 000023E0 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5700 000023E4 66AB                    	stosw		; interpolated sample 3 (L)
  5701 000023E6 88F8                    	mov	al, bh	
  5702 000023E8 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  5703 000023EA D0D8                    	rcr	al, 1
  5704 000023EC 86F8                    	xchg	al, bh	; al = interpolated middle (R)
  5705 000023EE 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  5706 000023F0 D0D8                    	rcr	al, 1
  5707 000023F2 2C80                    	sub	al, 80h
  5708 000023F4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5709 000023F8 66AB                    	stosw		; interpolated sample 3 (R)
  5710 000023FA 88D8                    	mov	al, bl
  5711 000023FC 00D0                    	add	al, dl	; [next_val_l]
  5712 000023FE D0D8                    	rcr	al, 1
  5713 00002400 2C80                    	sub	al, 80h
  5714 00002402 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5715 00002406 66AB                    	stosw		; interpolated sample 4 (L)
  5716 00002408 88F8                    	mov	al, bh
  5717 0000240A 00F0                    	add	al, dh	; [next_val_r]
  5718 0000240C D0D8                    	rcr	al, 1
  5719 0000240E 2C80                    	sub	al, 80h
  5720 00002410 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5721 00002414 66AB                    	stosw		; interpolated sample 4 (R)
  5722 00002416 C3                      	retn
  5723                                  
  5724                                  interpolating_4_8bit_mono:
  5725                                  	; 17/11/2023
  5726                                  	; al = [previous_val]
  5727                                  	; dl = [next_val]
  5728                                  	; original-interpolated-interpolated-interpolated
  5729 00002417 88C3                    	mov	bl, al
  5730 00002419 2C80                    	sub	al, 80h
  5731 0000241B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5732 0000241F 66AB                    	stosw		; original sample (L)
  5733 00002421 66AB                    	stosw		; original sample (R)
  5734 00002423 88D8                    	mov	al, bl
  5735 00002425 00D0                    	add	al, dl	
  5736 00002427 D0D8                    	rcr	al, 1
  5737 00002429 86D8                    	xchg	al, bl  ; al = [previous_val]
  5738 0000242B 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  5739 0000242D D0D8                    	rcr	al, 1 	
  5740 0000242F 2C80                    	sub	al, 80h
  5741 00002431 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5742 00002435 66AB                    	stosw		; interpolated sample 1 (L)
  5743 00002437 66AB                    	stosw		; interpolated sample 1 (R)
  5744 00002439 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  5745 0000243B 2C80                    	sub	al, 80h
  5746 0000243D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5747 00002441 66AB                    	stosw		; interpolated sample 2 (L)
  5748 00002443 66AB                    	stosw		; interpolated sample 2 (R)
  5749 00002445 88D8                    	mov	al, bl
  5750 00002447 00D0                    	add	al, dl	; [next_val]
  5751 00002449 D0D8                    	rcr	al, 1
  5752 0000244B 2C80                    	sub	al, 80h
  5753 0000244D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5754 00002451 66AB                    	stosw		; interpolated sample 3 (L)
  5755 00002453 66AB                    	stosw		; interpolated sample 3 (R)
  5756 00002455 C3                      	retn
  5757                                  
  5758                                  interpolating_4_8bit_stereo:
  5759                                  	; 17/11/2023
  5760                                  	; al = [previous_val_l]
  5761                                  	; ah = [previous_val_r]
  5762                                  	; dl = [next_val_l]
  5763                                  	; dh = [next_val_r]	
  5764                                  	; original-interpolated-interpolated-interpolated
  5765 00002456 89C3                    	mov	ebx, eax
  5766 00002458 2C80                    	sub	al, 80h
  5767 0000245A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5768 0000245E 66AB                    	stosw		; original sample (L)
  5769 00002460 88F8                    	mov	al, bh
  5770 00002462 2C80                    	sub	al, 80h
  5771 00002464 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5772 00002468 66AB                    	stosw		; original sample (R)
  5773 0000246A 88D8                    	mov	al, bl
  5774 0000246C 00D0                    	add	al, dl	; [next_val_l]
  5775 0000246E D0D8                    	rcr	al, 1
  5776 00002470 86D8                    	xchg	al, bl	; al = [previous_val_l]
  5777 00002472 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  5778 00002474 D0D8                    	rcr	al, 1
  5779 00002476 2C80                    	sub	al, 80h
  5780 00002478 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5781 0000247C 66AB                    	stosw		; interpolated sample 1 (L)
  5782 0000247E 88F8                    	mov	al, bh
  5783 00002480 00F0                    	add	al, dh	; [next_val_r]
  5784 00002482 D0D8                    	rcr	al, 1
  5785 00002484 86F8                    	xchg	al, bh	; al = [previous_val_h]
  5786 00002486 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  5787 00002488 D0D8                    	rcr	al, 1
  5788 0000248A 2C80                    	sub	al, 80h
  5789 0000248C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5790 00002490 66AB                    	stosw		; interpolated sample 1 (R)
  5791 00002492 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  5792 00002494 2C80                    	sub	al, 80h
  5793 00002496 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5794 0000249A 66AB                    	stosw		; interpolated sample 2 (L)
  5795 0000249C 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  5796 0000249E 2C80                    	sub	al, 80h
  5797 000024A0 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5798 000024A4 66AB                    	stosw		; interpolated sample 2 (L)
  5799 000024A6 88D8                    	mov	al, bl
  5800 000024A8 00D0                    	add	al, dl	; [next_val_l]
  5801 000024AA D0D8                    	rcr	al, 1
  5802 000024AC 2C80                    	sub	al, 80h
  5803 000024AE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5804 000024B2 66AB                    	stosw		; interpolated sample 3 (L)
  5805 000024B4 88F8                    	mov	al, bh
  5806 000024B6 00F0                    	add	al, dh	; [next_val_r]
  5807 000024B8 D0D8                    	rcr	al, 1
  5808 000024BA 2C80                    	sub	al, 80h
  5809 000024BC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5810 000024C0 66AB                    	stosw		; interpolated sample 3 (R)
  5811 000024C2 C3                      	retn
  5812                                  
  5813                                  interpolating_5_16bit_mono:
  5814                                  	; 18/11/2023
  5815                                  	; ax = [previous_val]
  5816                                  	; dx = [next_val]
  5817                                  	; original-interpltd-interpltd-interpltd-interpltd
  5818 000024C3 66AB                    	stosw		; original sample (L)
  5819 000024C5 66AB                    	stosw		; original sample (R)
  5820 000024C7 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5821 000024CA 89C3                    	mov	ebx, eax ; [previous_val]
  5822 000024CC 80C680                  	add	dh, 80h
  5823 000024CF 6601D0                  	add	ax, dx
  5824 000024D2 66D1D8                  	rcr	ax, 1
  5825 000024D5 50                      	push	eax ; *	; interpolated middle (temporary)
  5826 000024D6 6601D8                  	add	ax, bx	; interpolated middle + [previous_val] 
  5827 000024D9 66D1D8                  	rcr	ax, 1
  5828 000024DC 50                      	push	eax ; **	; interpolated 1st quarter (temporary)
  5829 000024DD 6601D8                  	add	ax, bx	; 1st quarter + [previous_val]
  5830 000024E0 66D1D8                  	rcr	ax, 1	
  5831 000024E3 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5832 000024E6 66AB                    	stosw 		; interpolated sample 1 (L)
  5833 000024E8 66AB                    	stosw		; interpolated sample 1 (R)
  5834 000024EA 58                      	pop	eax ; **
  5835 000024EB 5B                      	pop	ebx ; *
  5836 000024EC 6601D8                  	add	ax, bx	; 1st quarter + middle
  5837 000024EF 66D1D8                  	rcr	ax, 1	; / 2
  5838 000024F2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  5839 000024F5 66AB                    	stosw		; interpolated sample 2 (L)
  5840 000024F7 66AB                    	stosw		; interpolated sample 2 (R)
  5841 000024F9 89D8                    	mov	eax, ebx
  5842 000024FB 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  5843 000024FE 66D1D8                  	rcr	ax, 1
  5844 00002501 50                      	push	eax ; *	; interpolated 3rd quarter (temporary)
  5845 00002502 6601D8                  	add	ax, bx	; + interpolated middle
  5846 00002505 66D1D8                  	rcr	ax, 1
  5847 00002508 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5848 0000250B 66AB                    	stosw		; interpolated sample 3 (L)
  5849 0000250D 66AB                    	stosw		; interpolated sample 3 (R)
  5850 0000250F 58                      	pop	eax ; *	
  5851 00002510 6601D0                  	add	ax, dx	; 3rd quarter + [next_val]
  5852 00002513 66D1D8                  	rcr	ax, 1	; / 2
  5853 00002516 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5854 00002519 66AB                    	stosw		; interpolated sample 4 (L)
  5855 0000251B 66AB                    	stosw		; interpolated sample 4 (R)
  5856 0000251D C3                      	retn
  5857                                  
  5858                                  interpolating_5_16bit_stereo:
  5859                                  	; 18/11/2023
  5860                                  	; bx = [previous_val_l]
  5861                                  	; ax = [previous_val_r]
  5862                                  	; [next_val_l]
  5863                                  	; [next_val_r]
  5864                                  	; original-interpltd-interpltd-interpltd-interpltd
  5865 0000251E 51                      	push	ecx ; !
  5866 0000251F 93                      	xchg	eax, ebx
  5867 00002520 66AB                    	stosw		; original sample (L)
  5868 00002522 93                      	xchg	eax, ebx
  5869 00002523 66AB                    	stosw		; original sample (R)
  5870 00002525 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5871 00002528 50                      	push	eax ; *	; [previous_val_r]
  5872 00002529 80C780                  	add	bh, 80h
  5873 0000252C 8005[A8260000]80        	add	byte [next_val_l+1], 80h
  5874 00002533 66A1[A7260000]          	mov	ax, [next_val_l]
  5875 00002539 6601D8                  	add	ax, bx	; [previous_val_l]
  5876 0000253C 66D1D8                  	rcr	ax, 1
  5877 0000253F 89C1                    	mov	ecx, eax ; interpolated middle (L)
  5878 00002541 6601D8                  	add	ax, bx	
  5879 00002544 66D1D8                  	rcr	ax, 1
  5880 00002547 89C2                    	mov	edx, eax ; interpolated 1st quarter (L)
  5881 00002549 6601D8                  	add	ax, bx	; [previous_val_l]
  5882 0000254C 66D1D8                  	rcr	ax, 1
  5883 0000254F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5884 00002552 66AB                    	stosw 		; interpolated sample 1 (L)
  5885 00002554 89C8                    	mov	eax, ecx
  5886 00002556 6601D0                  	add	ax, dx	; middle (L) + 1st quarter (L)
  5887 00002559 66D1D8                  	rcr	ax, 1	; / 2
  5888 0000255C 89C3                    	mov	ebx, eax  ; interpolated sample 2 (L)
  5889 0000255E 5A                      	pop	edx ; *	; [previous_val_r]
  5890 0000255F 89D0                    	mov	eax, edx
  5891 00002561 8005[AA260000]80        	add	byte [next_val_r+1], 80h
  5892 00002568 660305[A9260000]        	add	ax, [next_val_r]
  5893 0000256F 66D1D8                  	rcr	ax, 1
  5894 00002572 50                      	push	eax ; *	; interpolated middle (R)
  5895 00002573 6601D0                  	add	ax, dx
  5896 00002576 66D1D8                  	rcr	ax, 1
  5897 00002579 50                      	push	eax ; ** ; interpolated 1st quarter (R)
  5898 0000257A 6601D0                  	add	ax, dx	; [previous_val_r]
  5899 0000257D 66D1D8                  	rcr	ax, 1
  5900 00002580 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5901 00002583 66AB                    	stosw 		; interpolated sample 1 (R)
  5902 00002585 89D8                    	mov	eax, ebx
  5903 00002587 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5904 0000258A 66AB                    	stosw 		; interpolated sample 2 (L)
  5905 0000258C 58                      	pop	eax ; **
  5906 0000258D 5A                      	pop	edx ; *
  5907 0000258E 6601D0                  	add	ax, dx	; 1st quarter (R) + middle (R)
  5908 00002591 66D1D8                  	rcr	ax, 1	; / 2
  5909 00002594 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5910 00002597 66AB                    	stosw 		; interpolated sample 2 (R)
  5911 00002599 89C8                    	mov	eax, ecx
  5912 0000259B 660305[A7260000]        	add	ax, [next_val_l]
  5913 000025A2 66D1D8                  	rcr	ax, 1
  5914 000025A5 50                      	push	eax ; * ; interpolated 3rd quarter (L)
  5915 000025A6 6601C8                  	add	ax, cx	; interpolated middle (L)
  5916 000025A9 66D1D8                  	rcr	ax, 1
  5917 000025AC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5918 000025AF 66AB                    	stosw 		; interpolated sample 3 (L)
  5919 000025B1 89D0                    	mov	eax, edx
  5920 000025B3 660305[A9260000]        	add	ax, [next_val_r]
  5921 000025BA 66D1D8                  	rcr	ax, 1
  5922 000025BD 50                      	push	eax ; ** ; interpolated 3rd quarter (R)
  5923 000025BE 6601D0                  	add	ax, dx	; interpolated middle (R)
  5924 000025C1 66D1D8                  	rcr	ax, 1
  5925 000025C4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5926 000025C7 66AB                    	stosw 		; interpolated sample 3 (R)
  5927 000025C9 5B                      	pop	ebx ; **
  5928 000025CA 58                      	pop	eax ; *
  5929 000025CB 660305[A7260000]        	add	ax, [next_val_l]
  5930 000025D2 66D1D8                  	rcr	ax, 1
  5931 000025D5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5932 000025D8 66AB                    	stosw 		; interpolated sample 4 (L)
  5933 000025DA 89D8                    	mov	eax, ebx
  5934 000025DC 660305[A9260000]        	add	ax, [next_val_r]
  5935 000025E3 66D1D8                  	rcr	ax, 1
  5936 000025E6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5937 000025E9 66AB                    	stosw 		; interpolated sample 4 (R)
  5938 000025EB 59                      	pop	ecx ; !
  5939 000025EC C3                      	retn
  5940                                  
  5941                                  interpolating_4_16bit_mono:
  5942                                  	; 18/11/2023
  5943                                  	; ax = [previous_val]
  5944                                  	; dx = [next_val]
  5945                                  	; original-interpolated
  5946                                  
  5947 000025ED 66AB                    	stosw		; original sample (L)
  5948 000025EF 66AB                    	stosw		; original sample (R)
  5949 000025F1 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5950 000025F4 89C3                    	mov	ebx, eax ; [previous_val]
  5951 000025F6 80C680                  	add	dh, 80h
  5952 000025F9 6601D0                  	add	ax, dx	; [previous_val] + [next_val]
  5953 000025FC 66D1D8                  	rcr	ax, 1
  5954 000025FF 93                      	xchg	eax, ebx
  5955 00002600 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  5956 00002603 66D1D8                  	rcr	ax, 1
  5957 00002606 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5958 00002609 66AB                    	stosw 		; interpolated sample 1 (L)
  5959 0000260B 66AB                    	stosw		; interpolated sample 1 (R)
  5960 0000260D 89D8                    	mov	eax, ebx ; interpolated middle
  5961 0000260F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5962 00002612 66AB                    	stosw 		; interpolated sample 2 (L)
  5963 00002614 66AB                    	stosw		; interpolated sample 2 (R)
  5964 00002616 89D8                    	mov	eax, ebx
  5965 00002618 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  5966 0000261B 66D1D8                  	rcr	ax, 1
  5967 0000261E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5968 00002621 66AB                    	stosw		; interpolated sample 3 (L)
  5969 00002623 66AB                    	stosw		; interpolated sample 3 (R)
  5970 00002625 C3                      	retn
  5971                                  
  5972                                  interpolating_4_16bit_stereo:
  5973                                  	; 18/11/2023
  5974                                  	; bx = [previous_val_l]
  5975                                  	; ax = [previous_val_r]
  5976                                  	; [next_val_l]
  5977                                  	; [next_val_r]
  5978                                  	; original-interpolated-interpolated-interpolated
  5979 00002626 93                      	xchg	eax, ebx
  5980 00002627 66AB                    	stosw		; original sample (L)
  5981 00002629 93                      	xchg	eax, ebx
  5982 0000262A 66AB                    	stosw		; original sample (R)
  5983 0000262C 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5984 0000262F 89C2                    	mov	edx, eax ; [previous_val_r]
  5985 00002631 80C780                  	add	bh, 80h
  5986 00002634 8005[A8260000]80        	add	byte [next_val_l+1], 80h
  5987 0000263B 66A1[A7260000]          	mov	ax, [next_val_l]
  5988 00002641 6601D8                  	add	ax, bx	; [previous_val_l]
  5989 00002644 66D1D8                  	rcr	ax, 1
  5990 00002647 93                      	xchg	eax, ebx
  5991 00002648 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  5992 0000264B 66D1D8                  	rcr	ax, 1
  5993 0000264E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5994 00002651 66AB                    	stosw 		; interpolated sample 1 (L)
  5995 00002653 8005[AA260000]80        	add	byte [next_val_r+1], 80h
  5996 0000265A 89D0                    	mov	eax, edx ; [previous_val_r]
  5997 0000265C 660305[A9260000]        	add	ax, [next_val_r]
  5998 00002663 66D1D8                  	rcr	ax, 1
  5999 00002666 92                      	xchg	eax, edx
  6000 00002667 6601D0                  	add	ax, dx	; dx = interpolated middle (R)
  6001 0000266A 66D1D8                  	rcr	ax, 1
  6002 0000266D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  6003 00002670 66AB                    	stosw 		; interpolated sample 1 (R)
  6004 00002672 89D8                    	mov	eax, ebx
  6005 00002674 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  6006 00002677 66AB                    	stosw 		; interpolated sample 2 (L)
  6007 00002679 89D0                    	mov	eax, edx
  6008 0000267B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  6009 0000267E 66AB                    	stosw 		; interpolated sample 2 (R)
  6010 00002680 89D8                    	mov	eax, ebx
  6011 00002682 660305[A7260000]        	add	ax, [next_val_l]
  6012 00002689 66D1D8                  	rcr	ax, 1
  6013 0000268C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  6014 0000268F 66AB                    	stosw 		; interpolated sample 3 (L)
  6015 00002691 89D0                    	mov	eax, edx
  6016 00002693 660305[A9260000]        	add	ax, [next_val_r]
  6017 0000269A 66D1D8                  	rcr	ax, 1
  6018 0000269D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  6019 000026A0 66AB                    	stosw 		; interpolated sample 3 (R)
  6020 000026A2 C3                      	retn
  6021                                  
  6022                                  ; 13/11/2023
  6023                                  previous_val:
  6024 000026A3 0000                    previous_val_l: dw 0
  6025 000026A5 0000                    previous_val_r: dw 0
  6026                                  next_val:
  6027 000026A7 0000                    next_val_l: dw 0
  6028 000026A9 0000                    next_val_r: dw 0
  6029                                  
  6030                                  ; 16/11/2023
  6031 000026AB 00                      faz:	db 0
  6032                                  
  6033                                  ; --------------------------------------------------------
  6034                                  ; 14/11/2024 - Erdogan Tan
  6035                                  ; --------------------------------------------------------
  6036                                  
  6037                                  	; 07/12/2024
  6038                                  	; 01/12/2024 (32bit registers)
  6039                                  	; 29/11/2024
  6040                                  checkUpdateEvents:
  6041 000026AC E8B9010000              	call	check4keyboardstop
  6042 000026B1 7272                    	jc	short c4ue_ok
  6043                                  
  6044                                  	; 18/11/2024
  6045 000026B3 50                      	push	eax ; *
  6046 000026B4 09C0                    	or	eax, eax
  6047 000026B6 0F84D1000000            	jz	c4ue_cpt
  6048                                  
  6049                                  	; 18/11/2024
  6050 000026BC 3C20                    	cmp	al, 20h ; SPACE (spacebar) ; pause/play
  6051 000026BE 7543                    	jne	short c4ue_chk_s
  6052 000026C0 803D[E8360000]00        	cmp	byte [stopped], 0
  6053 000026C7 7714                    	ja	short c4ue_chk_ps
  6054                                  	; pause
  6055 000026C9 E872E5FFFF              	call	ac97_pause
  6056                                  	; 21/11/2024
  6057 000026CE A0[E9360000]            	mov	al, [tLO]
  6058 000026D3 A2[EA360000]            	mov	byte [tLP], al
  6059 000026D8 E9B0000000              	jmp	c4ue_cpt
  6060                                  c4ue_chk_ps:
  6061 000026DD 803D[E8360000]01        	cmp	byte [stopped], 1
  6062 000026E4 770A                    	ja	short c4ue_replay
  6063                                  	; continue to play (after a pause)
  6064 000026E6 E85EE5FFFF              	call	ac97_play 
  6065 000026EB E99D000000              	jmp	c4ue_cpt
  6066                                  c4ue_replay:
  6067                                  	; 19/11/2024
  6068 000026F0 58                      	pop	eax ; *
  6069 000026F1 58                      	pop	eax ; return address
  6070                                  	; 07/02/2024
  6071                                  	;mov	al, [volume]
  6072                                  	;call	SetmasterVolume
  6073 000026F2 C605[E8360000]00        	mov	byte [stopped], 0
  6074 000026F9 E812040000              	call	move_to_beginning
  6075                                  	;jmp	PlayWav
  6076                                  	; 07/12/2024
  6077 000026FE E9BCDEFFFF              	jmp	RePlayWav
  6078                                  
  6079                                  c4ue_chk_s:
  6080 00002703 3C53                    	cmp	al, 'S'	; stop
  6081 00002705 751F                    	jne	short c4ue_chk_fb
  6082 00002707 803D[E8360000]00        	cmp	byte [stopped], 0
  6083 0000270E 777D                    	ja	c4ue_cpt ; Already stopped/paused
  6084 00002710 E812E5FFFF              	call	ac97_stop
  6085                                  	; 19/11/2024
  6086 00002715 C605[E9360000]00        	mov	byte [tLO], 0
  6087                                  	; 21/11/2024
  6088 0000271C C605[EA360000]30        	mov	byte [tLP], '0'
  6089 00002723 EB68                    	jmp	c4ue_cpt
  6090                                  
  6091                                  	; 01/12/2024
  6092                                  	; 18/11/2024
  6093                                  c4ue_ok:
  6094 00002725 C3                      	retn
  6095                                  
  6096                                  c4ue_chk_fb:
  6097                                  	; 17/11/2024
  6098 00002726 3C46                    	cmp	al, 'F'
  6099 00002728 7507                    	jne	short c4ue_chk_b
  6100 0000272A E8B9030000              	call 	Player_ProcessKey_Forwards
  6101 0000272F EB5C                    	jmp	c4ue_cpt
  6102                                  
  6103                                  c4ue_chk_b:
  6104 00002731 3C42                    	cmp	al, 'B'
  6105                                  	;;jne	short c4ue_cpt
  6106                                  	; 19/11/2024
  6107                                  	;jne	short c4ue_chk_h
  6108                                  	; 25/12/2024
  6109                                  	; 29/11/2024
  6110 00002733 7507                    	jne	short c4ue_chk_n
  6111 00002735 E8AA030000              	call 	Player_ProcessKey_Backwards
  6112 0000273A EB51                    	jmp	short c4ue_cpt
  6113                                  
  6114                                  	;;;
  6115                                  	; 25/12/2024
  6116                                  	; 29/11/2024
  6117                                  c4ue_chk_n:
  6118 0000273C 3C4E                    	cmp	al, 'N'
  6119 0000273E 7404                    	je	short c4ue_nps
  6120                                  c4ue_chk_p:
  6121 00002740 3C50                    	cmp	al, 'P'
  6122 00002742 7509                    	jne	short c4ue_chk_h
  6123                                  c4ue_nps:
  6124 00002744 C605[E8360000]03        	mov	byte [stopped], 3
  6125 0000274B EB40                    	jmp	short c4ue_cpt
  6126                                  	;;;
  6127                                  
  6128                                  c4ue_chk_h:
  6129                                  	; 19/11/2024
  6130 0000274D 3C48                    	cmp	al, 'H'
  6131 0000274F 750E                    	jne	short c4ue_chk_cr
  6132 00002751 C605[EB360000]00        	mov	byte [wpoints], 0
  6133 00002758 E87AE6FFFF              	call 	write_ac97_pci_dev_info
  6134                                  	; 30/12/2024
  6135 0000275D EB2E                    	jmp	short c4ue_cpt
  6136                                  c4ue_chk_cr:
  6137                                  	;;;
  6138                                  	; 24/12/2024 (wave lighting points option)
  6139                                  	;mov	ah, [wpoints]
  6140                                  	; 30/12/2024
  6141 0000275F 31DB                    	xor	ebx, ebx
  6142 00002761 8A1D[EB360000]          	mov	bl, [wpoints]
  6143 00002767 3C47                    	cmp	al, 'G'
  6144 00002769 7406                    	je	short c4ue_g
  6145                                  	; 19/11/2024
  6146 0000276B 3C0D                    	cmp	al, 0Dh ; ENTER/CR key
  6147 0000276D 751E                    	jne	short c4ue_cpt
  6148                                  	; 23/11/2024
  6149                                  	;xor	ebx, ebx
  6150                                  	; 30/12/2024
  6151                                  	;mov	bl, ah ; 24/12/2024
  6152 0000276F FEC3                    	inc	bl
  6153                                  c4ue_g:	; 30/12/2024
  6154 00002771 80E307                  	and	bl, 07h
  6155 00002774 7501                    	jnz	short c4ue_sc
  6156 00002776 43                      	inc	ebx
  6157                                  c4ue_sc:
  6158 00002777 881D[EB360000]          	mov	[wpoints], bl
  6159                                  	; 30/12/2024
  6160 0000277D 8A83[CB310000]          	mov	al, [ebx+colors-1] ; 1 to 7
  6161                                  	; 24/12/2024
  6162 00002783 A2[D3310000]            	mov	[ccolor], al
  6163                                  	; 30/12/2024
  6164 00002788 E8B2030000              	call	clear_window
  6165                                  	;;;
  6166                                  c4ue_cpt:
  6167                                  	; 24/12/2024
  6168                                  	; 18/11/2024
  6169 0000278D 59                      	pop	ecx ; *
  6170                                  	;;;
  6171                                  	; 29/12/2024
  6172                                  	; 24/12/2024 (skip wave lighting if data is not loaded yet)
  6173                                  	;cmp	byte [SRB], 0
  6174                                  	;ja	short c4ue_vb_ok
  6175                                  	;;;
  6176                                  	; 01/12/2024 (TRDOS 386)
  6177                                  	sys	_time, 4 ; get timer ticks (18.2 ticks/second),
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 0000278E BB04000000          <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99                              <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101                              <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00002793 B80D000000          <1>  mov eax, %1
   106                              <1> 
   107 00002798 CD40                <1>  int 40h
  6178                                  	; 24/12/2024
  6179                                  	; 18/11/2024
  6180                                  	;pop	ecx ; *
  6181                                  	; 01/12/2024
  6182 0000279A 3B05[B4370000]          	cmp	eax, [timerticks]
  6183                                  	;je	short c4ue_ok
  6184                                  	; 18/11/2024
  6185 000027A0 7408                    	je	short c4ue_skip_utt
  6186                                  c4ue_utt:	
  6187                                  	; 01/12/2024
  6188 000027A2 A3[B4370000]            	mov	[timerticks], eax
  6189 000027A7 EB05                    	jmp	short c4ue_cpt_@
  6190                                  
  6191                                  	; 30/12/2024
  6192                                  c4ue_vb_ok:
  6193 000027A9 C3                      	retn
  6194                                  
  6195                                  c4ue_skip_utt:
  6196                                  	; 18/11/2024
  6197 000027AA 21C9                    	and	ecx, ecx
  6198 000027AC 74FB                    	jz	short c4ue_vb_ok
  6199                                  c4ue_cpt_@:
  6200                                  	; 18/11/2024
  6201 000027AE 803D[E8360000]00        	cmp	byte [stopped], 0
  6202 000027B5 77F2                    	ja	short c4ue_vb_ok
  6203                                  	
  6204 000027B7 E8C2010000              	call	CalcProgressTime
  6205                                  
  6206                                  	;cmp	ax, [ProgressTime]
  6207                                  	; 01/12/2024
  6208 000027BC 3B05[A8370000]          	cmp	eax, [ProgressTime]
  6209                                  	;je	short c4ue_vb_ok
  6210                                  			; same second, no need to update
  6211                                  	; 23/11/2024
  6212 000027C2 7405                    	je	short c4ue_uvb
  6213                                  
  6214                                  	;call	UpdateProgressTime
  6215                                  	;call	UpdateProgressBar@
  6216 000027C4 E89F020000              	call	UpdateProgressBar
  6217                                  
  6218                                  	; 23/11/2024
  6219                                  c4ue_uvb:
  6220 000027C9 803D[EB360000]00        	cmp	byte [wpoints], 0
  6221 000027D0 76D7                    	jna	short c4ue_vb_ok
  6222                                  
  6223                                  	; 30/12/2024
  6224                                  	;call	UpdateWavePoints
  6225                                  	;retn
  6226                                  
  6227                                  ; --------------------------------------------------------
  6228                                  ; 27/12/2024 - Erdogan Tan
  6229                                  ; --------------------------------------------------------
  6230                                  
  6231                                  	; 30/12/2024 (cgaplay.s)
  6232                                  	;  * 320*200 pixels, 256 colors
  6233                                  	;  * 64 volume levels
  6234                                  	; 29/12/2024
  6235                                  	; 27/12/2024 (DMA Buffer Tracking)
  6236                                  	; 26/12/2024
  6237                                  	; 24/12/2024
  6238                                  UpdateWavePoints:
  6239 000027D2 BE[E8310000]            	mov	esi, prev_points
  6240 000027D7 833E00                  	cmp	dword [esi], 0
  6241 000027DA 740B                    	jz	short lights_off_ok
  6242                                  	;mov	ecx, 640
  6243                                  	; 30/12/2024
  6244 000027DC B940010000              	mov	ecx, 320
  6245                                  light_off:
  6246 000027E1 AD                      	lodsd
  6247                                  	; eax = wave point (lighting point) address
  6248 000027E2 C60000                  	mov	byte [eax], 0 ; black point (light off)
  6249 000027E5 E2FA                    	loop	light_off	
  6250                                  
  6251                                  lights_off_ok:
  6252                                  	; 29/12/2024
  6253 000027E7 803D[E9360000]32        	cmp	byte [tLO],'2'
  6254 000027EE 7507                    	jne	short lights_on_buff_1
  6255                                  lights_on_buff_2:
  6256 000027F0 BA[00500100]            	mov	edx, WAVBUFFER_2
  6257 000027F5 EB05                    	jmp	short lights_on
  6258                                  lights_on_buff_1:
  6259 000027F7 BA[00500000]            	mov	edx, WAVBUFFER_1
  6260                                  lights_on:
  6261 000027FC 3915[F0360000]          	cmp	[pbuf_s], edx
  6262 00002802 7520                    	jne	short lights_on_2
  6263 00002804 8B1D[D4310000]          	mov	ebx, [wpoints_dif]
  6264 0000280A 8B35[EC360000]          	mov	esi, [pbuf_o]
  6265 00002810 8B0D[A0370000]          	mov	ecx, [buffersize] ; bytes
  6266 00002816 29D9                    	sub	ecx, ebx ; sub ecx, [wpoints_dif]
  6267 00002818 01DE                    	add	esi, ebx
  6268 0000281A 7204                    	jc	short lights_on_1
  6269 0000281C 39CE                    	cmp	esi, ecx
  6270 0000281E 760C                    	jna	short lights_on_3
  6271                                  lights_on_1:
  6272 00002820 89CE                    	mov	esi, ecx
  6273 00002822 EB08                    	jmp	short lights_on_3
  6274                                  
  6275                                  lights_on_2:
  6276                                  	; 29/12/2024
  6277 00002824 8915[F0360000]          	mov	[pbuf_s], edx
  6278 0000282A 31F6                    	xor	esi, esi ; 0
  6279                                  lights_on_3:
  6280 0000282C 8935[EC360000]          	mov	[pbuf_o], esi
  6281                                  	; 29/12/2024
  6282                                  	;add	esi, [pbuf_s]
  6283 00002832 01D6                    	add	esi, edx
  6284                                  	;mov	ecx, 640
  6285                                  	; 30/12/2024
  6286 00002834 B940010000              	mov	ecx, 320
  6287 00002839 89CD                    	mov	ebp, ecx
  6288                                  	; 26/12/2024
  6289 0000283B BF[E8310000]            	mov	edi, prev_points
  6290 00002840 8B1D[D8310000]          	mov	ebx, [graphstart] ; start (top) line
  6291                                  lights_on_4:
  6292 00002846 31C0                    	xor	eax, eax ; 0
  6293 00002848 66AD                    	lodsw	; left
  6294 0000284A 80C480                  	add	ah, 80h
  6295 0000284D 89C2                    	mov	edx, eax
  6296 0000284F 66AD                    	lodsw	; right
  6297                                  	;add	ax, dx
  6298 00002851 80C480                  	add	ah, 80h
  6299                                  	;;shr	eax, 9	; 128 volume levels
  6300                                  	; 01/01/2024
  6301 00002854 01D0                    	add	eax, edx
  6302                                  	;;shr	eax, 10	; (L+R/2) & 128 volume levels
  6303                                  	;shr	eax, 9	; (L+R/2) & 256 volume levels
  6304                                  	; 30/12/2024
  6305 00002856 C1E80B                  	shr	eax, 11	; (L+R/2) & 64 volume levels
  6306                                  	; * 320 row  ; 30/12/2024
  6307 00002859 F7E5                    	mul	ebp	; * 640 (row) 
  6308 0000285B 01D8                    	add	eax, ebx ; + column
  6309 0000285D 8A15[D3310000]          	mov	dl, [ccolor]
  6310 00002863 8810                    	mov	[eax], dl ; pixel (light on) color
  6311 00002865 AB                      	stosd		; save light on addr in prev_points
  6312 00002866 43                      	inc	ebx
  6313 00002867 E2DD                    	loop	lights_on_4
  6314 00002869 C3                      	retn
  6315                                  
  6316                                  ; --------------------------------------------------------
  6317                                  ; 19/05/2024 - (playwav4.asm) ich_wav4.asm
  6318                                  ; --------------------------------------------------------
  6319                                  
  6320                                  	; 29/12/2024
  6321                                  	; 25/12/2024
  6322                                  	; 07/12/2024
  6323                                  	; 01/12/2024 (TRDOS 386)
  6324                                  	; 29/11/2024
  6325                                  check4keyboardstop:
  6326                                  	; 19/05/2024
  6327                                  	; 08/11/2023
  6328                                  	; 04/11/2023
  6329 0000286A B401                    	mov	ah, 1
  6330                                  	;int	16h
  6331                                  	; 01/12/2024 (TRDOS 386 keyboard interrupt)
  6332 0000286C CD32                    	int	32h
  6333                                  	;clc
  6334 0000286E 7433                    	jz	short _cksr
  6335                                  
  6336 00002870 30E4                    	xor	ah, ah
  6337                                  	;int	16h
  6338                                  	; 01/12/2024 (TRDOS 386 keyboard interrupt)
  6339 00002872 CD32                    	int	32h
  6340                                  
  6341                                  	; 25/12/2024
  6342                                  	; 29/11/2024
  6343                                  	;mov	[command], al
  6344                                  
  6345                                  	;;;
  6346                                  	; 19/05/2024 (change PCM out volume)
  6347 00002874 3C2B                    	cmp	al, '+'
  6348 00002876 750D                    	jne	short p_1
  6349                                  	
  6350 00002878 A0[CD280000]            	mov	al, [volume]
  6351 0000287D 3C00                    	cmp	al, 0
  6352 0000287F 7624                    	jna	short p_3
  6353 00002881 FEC8                    	dec	al
  6354 00002883 EB0F                    	jmp	short p_2
  6355                                  p_1:
  6356 00002885 3C2D                    	cmp	al, '-'
  6357 00002887 751D                    	jne	short p_4
  6358                                  
  6359 00002889 A0[CD280000]            	mov	al, [volume]
  6360 0000288E 3C1F                    	cmp	al, 31
  6361 00002890 7313                    	jnb	short p_3
  6362 00002892 FEC0                    	inc	al
  6363                                  p_2:
  6364 00002894 A2[CD280000]            	mov	[volume], al
  6365                                  	; 29/12/2024
  6366                                  	; 14/11/2024
  6367 00002899 E8D2DEFFFF              	call	SetPCMOutVolume
  6368                                  	; 15/11/2024 (QEMU)
  6369                                  	; 07/12/2024
  6370                                  	;call	SetMasterVolume
  6371                                  	;call	UpdateVolume
  6372                                  	;;clc
  6373                                  	;retn
  6374 0000289E E97C010000              	jmp	UpdateVolume
  6375                                  	;mov	ah, al
  6376                                  	;mov    dx, [NAMBAR]
  6377                                    	;;add   dx, CODEC_MASTER_VOL_REG
  6378                                  	;add	dx, CODEC_PCM_OUT_REG
  6379                                  	;out    dx, ax
  6380                                  	;
  6381                                  	;call   delay1_4ms
  6382                                          ;call   delay1_4ms
  6383                                          ;call   delay1_4ms
  6384                                          ;call   delay1_4ms
  6385                                  _cksr:		; 19/05/2024
  6386                                  	; 18/12/2024
  6387 000028A3 31C0                    	xor	eax, eax
  6388                                  	;clc
  6389                                  p_3:
  6390 000028A5 C3                      	retn
  6391                                  p_4:
  6392                                  	; 17/11/2024
  6393 000028A6 80FC01                  	cmp	ah, 01h  ; ESC
  6394 000028A9 7419                        	je	short p_q
  6395                                  	;cmp	ax, 2E03h ; 21/12/2024 
  6396 000028AB 3C03                    	cmp	al, 03h  ; CTRL+C
  6397 000028AD 7415                    	je	short p_q
  6398                                  
  6399                                  	; 18/11/2024
  6400 000028AF 3C20                    	cmp	al, 20h
  6401 000028B1 7419                    	je	short p_r
  6402                                  
  6403                                  	; 19/11/2024
  6404 000028B3 3C0D                    	cmp	al, 0Dh ; CR/ENTER
  6405 000028B5 7415                    	je	short p_r
  6406                                  
  6407 000028B7 24DF                    	and	al, 0DFh
  6408                                  
  6409                                  	; 25/12/2024
  6410                                  	; 29/11/2024
  6411 000028B9 A2[F6360000]            	mov	[command], al
  6412                                  
  6413                                  	;cmp	al, 'B'
  6414                                  	;je	short p_r
  6415                                  	;cmp	al, 'F'
  6416                                  	;je	short p_r
  6417                                  
  6418                                  	; 29/11/2024
  6419                                  	;cmp	al, 'N'
  6420                                  	;je	short p_r
  6421                                  	;cmp	al, 'P'
  6422                                  	;je	short p_r
  6423                                  
  6424 000028BE 3C51                    	cmp	al, 'Q'
  6425                                  	;je	short p_q
  6426 000028C0 7409                    	je	short p_quit ; 29/11/2024
  6427                                  
  6428 000028C2 F8                      	clc
  6429 000028C3 C3                      	retn
  6430                                  
  6431                                  	;;;
  6432                                  ;_cskr:	
  6433                                  p_q:
  6434                                  	; 27/12/2024
  6435 000028C4 C605[F6360000]51        	mov	byte [command], 'Q'
  6436                                  p_quit:
  6437 000028CB F9                      	stc
  6438                                  p_r:
  6439 000028CC C3                      	retn
  6440                                  
  6441                                  ; 29/05/2024
  6442                                  ; 19/05/2024
  6443                                  volume: 
  6444                                  	;db	02h
  6445                                  ; 26/12/2024
  6446 000028CD 03                      	db	03h
  6447                                  
  6448                                  ; --------------------------------------------------------
  6449                                  
  6450                                  	; 31/12/2024 (int31h)
  6451                                  	; 30/12/2024
  6452                                  	; simulate cursor position in VGA mode 13h
  6453                                  	; ! for 320*200, 256 colors (1 byte/pixel) !
  6454                                  setCursorPosition:
  6455                                  	; dh = Row
  6456                                  	; dl = Column
  6457                                  
  6458                                  	; 31/12/2024
  6459 000028CE B700                    	mov	bh, 0
  6460 000028D0 B402                    	mov	ah, 02h
  6461                                  	;int	10h
  6462 000028D2 CD31                    	int	31h
  6463 000028D4 C3                      	retn
  6464                                  
  6465                                  ; 31/12/2024
  6466                                  %if 0
  6467                                  	xor	eax, eax
  6468                                  	; row height is 8 pixels (8*8)
  6469                                  	mov	al, dh
  6470                                  	shl	eax, 3
  6471                                  	add	ax, 2	; top margin
  6472                                  	shl	eax, 16
  6473                                  	mov	al, dl	; * 8 ; character width = 8 pixels
  6474                                  	shl	ax, 3
  6475                                  			; hw = row, ax = column
  6476                                  	mov	[screenpos], eax
  6477                                  	; 22/12/2024
  6478                                  	xor	eax, eax
  6479                                  	retn
  6480                                  %endif
  6481                                  	
  6482                                  ; --------------------------------------------------------
  6483                                  ; 14/11/2024
  6484                                  ; (Ref: player.asm, out_cs.asm, Matan Alfasi, 2017)
  6485                                  
  6486                                  ;; NAME:	SetTotalTime
  6487                                  ;; DESCRIPTION: Calculates the total time in seconds in file
  6488                                  ;; INPUT:	DATA_SubchunkSize, WAVE_SampleRate, WAVE_BlockAlign
  6489                                  ;; OUTPUT:	CurrentTotalTime=Total time in seconds in file,
  6490                                  ;; 		Output on the screen of the total time in seconds
  6491                                  
  6492                                  	; 01/12/2024 (32 bit registers)
  6493                                  SetTotalTime:
  6494                                  	;; Calculate total seconds in file
  6495                                  	;mov	ax, [DATA_SubchunkSize]
  6496                                  	;mov	dx, [DATA_SubchunkSize + 2]
  6497                                  	;mov	bx, [WAVE_SampleRate]
  6498                                  	;div	bx
  6499                                  	;xor	dx, dx
  6500                                  	; 01/12/2024
  6501 000028D5 A1[20370000]            	mov	eax, [DATA_SubchunkSize]
  6502 000028DA 0FB71D[10370000]        	movzx	ebx, word [WAVE_SampleRate]
  6503 000028E1 31D2                    	xor	edx, edx
  6504 000028E3 F7F3                    	div	ebx
  6505                                  
  6506                                  	;mov	bx, [WAVE_BlockAlign]
  6507                                  	;div	bx
  6508                                  	; 01/12/2024
  6509 000028E5 668B1D[18370000]        	mov	bx, [WAVE_BlockAlign]
  6510 000028EC 31D2                    	xor	edx, edx
  6511 000028EE F7F3                    	div	ebx
  6512                                  
  6513                                  	;mov	[TotalTime], ax
  6514 000028F0 A3[A4370000]            	mov	[TotalTime], eax
  6515                                  
  6516 000028F5 B33C                    	mov	bl, 60
  6517 000028F7 F6F3                    	div	bl
  6518                                  
  6519                                  	;; al = minutes, ah = seconds
  6520 000028F9 50                      	push	eax ; **
  6521 000028FA 50                      	push	eax ; *
  6522                                  
  6523                                  	;mov	dh, 24
  6524                                  	; 21/12/2024 (640*480)
  6525                                  	;mov	dh, 32
  6526                                  	;mov	dl, 42
  6527                                  	; 30/12/2024 (320*200)
  6528 000028FB B617                    	mov	dh, 23
  6529 000028FD B216                    	mov	dl, 22
  6530 000028FF E8CAFFFFFF              	call	setCursorPosition
  6531                                  
  6532 00002904 58                      	pop	eax ; *
  6533 00002905 30E4                    	xor	ah, ah
  6534 00002907 BD02000000              	mov	ebp, 2
  6535 0000290C E812000000              	call	PrintNumber
  6536                                  	
  6537                                  	;mov	dh, 24
  6538                                  	; 21/12/2024 (640*480)
  6539                                  	;mov	dh, 32
  6540                                  	;mov	dl, 45
  6541                                  	; 30/12/2024 (320*200)
  6542 00002911 B617                    	mov	dh, 23
  6543 00002913 B219                    	mov	dl, 25
  6544 00002915 E8B4FFFFFF              	call	setCursorPosition
  6545                                  
  6546 0000291A 58                      	pop	eax ; **
  6547 0000291B 88E0                    	mov	al, ah
  6548 0000291D 30E4                    	xor	ah, ah
  6549                                  	; 21/12/2024
  6550 0000291F 66BD0200                	mov	bp, 2
  6551                                  	;jmp	short PrintNumber
  6552                                  
  6553                                  ; --------------------------------------------------------
  6554                                  
  6555                                  	; 31/12/2024 (int 31h)
  6556                                  	; 21/12/2024 (write numbers in VESA VBE graphics mode)
  6557                                  	; 01/12/2024 (32bit registers)
  6558                                  PrintNumber:
  6559                                  	; eax = binary number
  6560                                  	; ebp = digits
  6561                                  	;mov	esi, [screenpos]
  6562                                  		; hw = row, si = column
  6563 00002923 BB0A000000              	mov	ebx, 10
  6564 00002928 31C9                    	xor	ecx, ecx
  6565                                  printNumber_CutNumber:
  6566 0000292A 41                      	inc	ecx
  6567 0000292B 31D2                    	xor	edx, edx
  6568 0000292D F7F3                    	div	ebx
  6569 0000292F 52                      	push	edx
  6570 00002930 39E9                    	cmp	ecx, ebp
  6571 00002932 7402                    	je	short printNumber_printloop
  6572 00002934 EBF4                    	jmp	printNumber_CutNumber
  6573                                  
  6574                                  printNumber_printloop:
  6575 00002936 58                      	pop	eax
  6576                                  	; 21/12/2024
  6577                                  	; ebp = count of digits
  6578                                  	; eax <= 9
  6579                                  
  6580 00002937 0430                    	add	al, '0'
  6581                                  	
  6582                                  	; esi = pixel position (hw = row, si = column)
  6583                                  	; eax = al = character
  6584                                  	;call	write_character
  6585                                  	; 22/12/2024
  6586 00002939 E817010000              	call	write_character_white
  6587                                  
  6588 0000293E 4D                      	dec	ebp
  6589 0000293F 7402                     	jz	short printNumber_ok
  6590                                  	;add	esi, 8	; next column
  6591 00002941 EBF3                    	jmp	short printNumber_printloop
  6592                                  printNumber_ok:
  6593 00002943 C3                      	retn
  6594                                  
  6595                                  ; --------------------------------------------------------
  6596                                  
  6597                                  	; 14/11/2024 - Erdogan Tan
  6598                                  SetProgressTime:
  6599                                  	;; Calculate playing/progress seconds in file
  6600 00002944 E835000000              	call	CalcProgressTime
  6601                                  
  6602                                  	; 01/12/2024 (32bit registers)
  6603                                  UpdateProgressTime:
  6604                                  	; eax = (new) progress time 
  6605                                  
  6606 00002949 A3[A8370000]            	mov	[ProgressTime], eax
  6607                                  
  6608 0000294E B33C                    	mov	bl, 60
  6609 00002950 F6F3                    	div	bl
  6610                                  
  6611                                  	;; al = minutes, ah = seconds
  6612 00002952 50                      	push	eax ; **
  6613 00002953 50                      	push	eax ; *
  6614                                  
  6615                                  	;mov	dh, 24
  6616                                  	; 21/12/2024 (640*480)
  6617                                  	;mov	dh, 32
  6618                                  	;mov	dl, 33
  6619                                  	; 30/12/2024 (320*200)
  6620 00002954 B617                    	mov	dh, 23
  6621 00002956 B20D                    	mov	dl, 13
  6622 00002958 E871FFFFFF              	call	setCursorPosition
  6623                                  
  6624 0000295D 58                      	pop	eax ; *
  6625 0000295E 30E4                    	xor	ah, ah
  6626 00002960 BD02000000              	mov	ebp, 2
  6627 00002965 E8B9FFFFFF              	call	PrintNumber
  6628                                  	
  6629                                  	;mov	dh, 24
  6630                                  	; 21/12/2024 (640*480)
  6631                                  	;mov	dh, 32
  6632                                  	;mov	dl, 36
  6633                                  	; 30/12/2024 (320*200)
  6634 0000296A B617                    	mov	dh, 23
  6635 0000296C B210                    	mov	dl, 16
  6636 0000296E E85BFFFFFF              	call	setCursorPosition
  6637                                  
  6638 00002973 58                      	pop	eax ; **
  6639 00002974 88E0                    	mov	al, ah
  6640 00002976 30E4                    	xor	ah, ah
  6641                                  	; 21/12/2024
  6642 00002978 66BD0200                	mov	bp, 2
  6643 0000297C EBA5                    	jmp	short PrintNumber
  6644                                  
  6645                                  ; --------------------------------------------------------
  6646                                  
  6647                                  	; 01/12/2024 (32bit registers)
  6648                                  	; 17/11/2024
  6649                                  	; 14/11/2024
  6650                                  CalcProgressTime:
  6651                                  	;mov	ax, [LoadedDataBytes]
  6652                                  	;mov	dx, [LoadedDataBytes+2]
  6653                                  	;mov	bx, ax
  6654                                  	;or	bx, dx
  6655                                  	;jz	short cpt_ok
  6656                                  	; 01/12/2024
  6657 0000297E A1[B0370000]            	mov	eax, [LoadedDataBytes]
  6658 00002983 09C0                    	or	eax, eax
  6659 00002985 7416                    	jz	short cpt_ok
  6660                                  
  6661                                  	;mov	bx, [WAVE_SampleRate]
  6662                                  	;div	bx
  6663                                  	;xor	dx, dx
  6664                                  	;mov	bx, [WAVE_BlockAlign]
  6665                                  	;div	bx
  6666                                  	; 01/12/2024
  6667 00002987 0FB71D[10370000]        	movzx	ebx, word [WAVE_SampleRate]
  6668 0000298E 31D2                    	xor	edx, edx
  6669 00002990 F7F3                    	div	ebx
  6670 00002992 31D2                    	xor	edx, edx
  6671 00002994 668B1D[18370000]        	mov	bx, [WAVE_BlockAlign]
  6672 0000299B F7F3                    	div	ebx
  6673                                  cpt_ok:
  6674                                  	; eax = (new) progress time
  6675 0000299D C3                      	retn
  6676                                  
  6677                                  ; --------------------------------------------------------
  6678                                  ; 14/11/2024
  6679                                  ; (Ref: player.asm, out_cs.asm, Matan Alfasi, 2017)
  6680                                  
  6681                                  ;; DESCRIPTION: Update file information on template
  6682                                  ;; PARAMS:	WAVE parameters and other variables
  6683                                  ;; REGS:	AX(RW)
  6684                                  ;; VARS:	CurrentFileName, WAVE_SampleRate, 
  6685                                  ;; RETURNS:	On-screen file info is updated.
  6686                                  
  6687                                  	; 01/12/2024 (32bit registers)
  6688                                  UpdateFileInfo:
  6689                                  	;; Print File Name
  6690                                  	;mov	dh, 9
  6691                                  	; 21/12/2024 (640*480 graphics display)
  6692                                  	;mov	dh, 8
  6693                                  	;mov	dl, 23
  6694                                  	; 30/12/2024 (320*200, video mode 13h)
  6695 0000299E B607                    	mov	dh, 7
  6696 000029A0 B208                    	mov	dl, 8
  6697 000029A2 E827FFFFFF              	call	setCursorPosition
  6698                                  	
  6699 000029A7 BE[38370000]            	mov	esi, wav_file_name
  6700                                  	
  6701                                  	;;;
  6702                                  	; 14/11/2024
  6703                                  	; skip directory separators
  6704                                  	; (note: asciiz string, max. 79 bytes except zero tail)
  6705 000029AC 89F3                    	mov	ebx, esi
  6706                                  chk4_nxt_sep:
  6707 000029AE AC                      	lodsb
  6708 000029AF 3C2F                    	cmp	al, '/'	; 14/12/2024
  6709 000029B1 7406                    	je	short chg_fpos
  6710 000029B3 20C0                    	and	al, al
  6711 000029B5 7406                    	jz	short chg_fpos_ok
  6712 000029B7 EBF5                    	jmp	short chk4_nxt_sep
  6713                                  chg_fpos:
  6714 000029B9 89F3                    	mov	ebx, esi
  6715 000029BB EBF1                    	jmp	short chk4_nxt_sep
  6716                                  chg_fpos_ok:
  6717 000029BD 89DE                    	mov	esi, ebx ; file name (without its path/directory)
  6718                                  	;;;
  6719                                  _fnl_chk:
  6720                                  	; 30/12/2024 (cgaplay.s)
  6721                                  	; ????????.wav
  6722                                  	; 26/12/2024 (file name length limit -display-)
  6723 000029BF BB0C000000              	mov	ebx, 12
  6724                                  	;mov	ebx, 17 ; ????????.wav?????
  6725 000029C4 56                      	push	esi
  6726                                  _fnl_chk_loop:
  6727 000029C5 AC                      	lodsb
  6728 000029C6 20C0                    	and	al, al
  6729 000029C8 7406                    	jz	short _fnl_ok
  6730 000029CA 4B                       	dec	ebx
  6731 000029CB 75F8                    	jnz	short _fnl_chk_loop
  6732 000029CD C60600                  	mov	byte [esi], 0
  6733                                  _fnl_ok:
  6734 000029D0 5E                      	pop	esi
  6735                                  	;;;
  6736                                  
  6737 000029D1 E870000000              	call	PrintString
  6738                                  	
  6739                                  	;; Print Frequency
  6740                                  	;mov	dh, 10
  6741                                  	; 21/12/2024 (640*480 graphics display)
  6742                                  	;mov	dh, 9
  6743                                  	;mov	dl, 23
  6744                                  	; 30/12/2024 (320*200, video mode 13h)
  6745 000029D6 B608                    	mov	dh, 8
  6746 000029D8 B208                    	mov	dl, 8
  6747 000029DA E8EFFEFFFF              	call	setCursorPosition
  6748                                  	;movzx	eax, word [WAVE_SampleRate]
  6749                                  	; 22/12/2024
  6750                                  	; eax = 0
  6751 000029DF 66A1[10370000]          	mov	ax, [WAVE_SampleRate]
  6752 000029E5 BD05000000              	mov	ebp, 5
  6753 000029EA E834FFFFFF              	call	PrintNumber
  6754                                  
  6755                                  	;; Print BitRate
  6756                                  	;mov	dh, 9
  6757                                  	; 21/12/2024 (640*480 graphics display)
  6758                                  	;mov	dh, 8
  6759                                  	;mov	dl, 57
  6760                                  	; 30/12/2024 (320*200, video mode 13h)
  6761 000029EF B607                    	mov	dh, 7
  6762 000029F1 B21F                    	mov	dl, 31
  6763 000029F3 E8D6FEFFFF              	call	setCursorPosition
  6764 000029F8 66A1[1A370000]          	mov	ax, [WAVE_BitsPerSample]
  6765 000029FE 66BD0200                	mov	bp, 2
  6766 00002A02 E81CFFFFFF              	call	PrintNumber
  6767                                  
  6768                                  	;; Print Channel Number
  6769                                  	;mov	dh, 10
  6770                                  	; 21/12/2024 (640*480 graphics display)
  6771                                  	;mov	dh, 9
  6772                                  	;mov	dl, 57
  6773                                  	; 30/12/2024 (320*200, video mode 13h)
  6774 00002A07 B608                    	mov	dh, 8
  6775 00002A09 B21F                    	mov	dl, 31
  6776 00002A0B E8BEFEFFFF              	call	setCursorPosition
  6777 00002A10 66A1[0E370000]          	mov	ax, [WAVE_NumChannels]
  6778 00002A16 66BD0100                	mov	bp, 1
  6779 00002A1A E804FFFFFF              	call	PrintNumber
  6780                                  
  6781                                  	;call	UpdateVolume
  6782                                  	;retn
  6783                                  
  6784                                  ; --------------------------------------------------------
  6785                                  
  6786                                  	; 14/11/2024
  6787                                  UpdateVolume:
  6788                                  	;; Print Volume
  6789                                  	;mov	dh, 24
  6790                                  	; 21/12/2024 (640*480)
  6791                                  	;mov	dh, 32
  6792                                  	;mov	dl, 75
  6793                                  	; 30/12/2024 (320*200, video mode 13h)
  6794 00002A1F B617                    	mov	dh, 23
  6795 00002A21 B223                    	mov	dl, 35
  6796 00002A23 E8A6FEFFFF              	call	setCursorPosition
  6797                                  	; 22/12/2024
  6798                                  	; eax = 0
  6799                                  
  6800 00002A28 A0[CD280000]            	mov	al, [volume]
  6801                                  
  6802 00002A2D B364                    	mov	bl, 100
  6803 00002A2F F6E3                    	mul	bl
  6804                                  
  6805 00002A31 B31F                    	mov	bl, 31
  6806 00002A33 F6F3                    	div	bl
  6807                                  
  6808                                  	;neg	ax
  6809                                  	;add	ax, 100	
  6810                                  	; 01/12/2024
  6811 00002A35 B464                    	mov	ah, 100
  6812 00002A37 28C4                    	sub	ah, al
  6813 00002A39 0FB6C4                  	movzx	eax, ah
  6814                                  	;xor	ah, ah
  6815                                  	;mov	bp, 3
  6816 00002A3C BD03000000              	mov	ebp, 3
  6817                                  	;call	PrintNumber
  6818                                  	;retn
  6819 00002A41 E9DDFEFFFF              	jmp	PrintNumber	
  6820                                  
  6821                                  ; --------------------------------------------------------
  6822                                  
  6823                                  	; 31/12/2024 (int 31h)
  6824                                  	; 21/12/2024
  6825                                  	; write text in VESA VBE graphics mode
  6826                                  PrintString:
  6827                                  	; esi = string address
  6828                                  printstr_loop:
  6829 00002A46 31C0                    	xor	eax, eax
  6830 00002A48 AC                      	lodsb
  6831 00002A49 08C0                    	or	al, al
  6832 00002A4B 7407                    	jz	short printstr_ok
  6833                                  
  6834                                  	;push	esi
  6835                                  
  6836                                  	;mov	esi, [screenpos]
  6837                                  
  6838                                  	; esi = pixel position (hw = row, si = column)
  6839                                  	; eax = al = character
  6840                                  	;call	write_character
  6841                                  	; 22/12/2024
  6842 00002A4D E803000000              	call	write_character_white
  6843                                  
  6844                                  	; 31/12/2024
  6845                                  	;add	word [screenpos], 8 ; update column (only, not row)
  6846                                  
  6847                                  	;pop	esi
  6848 00002A52 EBF2                    	jmp	short printstr_loop
  6849                                  
  6850                                  printstr_ok:
  6851 00002A54 C3                      	retn
  6852                                  
  6853                                  ; --------------------------------------------------------
  6854                                  
  6855                                  	; 31/12/2024 (int 31h)
  6856                                  	; 30/12/2024
  6857                                  	; write character (at cursor position)
  6858                                  	; in video mode 13h (320*200, 256 colors)
  6859                                  	; 21/12/2024
  6860                                  	; write character (at cursor position)
  6861                                  	; in graphics mode (640*480, 256 colors)
  6862                                  	; 22/12/2024
  6863                                  write_character_white:
  6864 00002A55 B90F000000              	mov	ecx, 0Fh
  6865                                  	; 26/12/2024
  6866                                  	;movzx	ecx, byte [tcolor]
  6867                                  write_character:
  6868                                  	; esi = pixel position (hw = row, si = column)
  6869                                  	; eax = al = character
  6870                                  	; cl = color
  6871 00002A5A 890D[DC310000]          	mov	[wcolor], ecx ; 22/12/2024
  6872                                  
  6873                                  ; 31/12/2024
  6874                                  %if 0
  6875                                  	; 30/12/2024
  6876                                  	; 22/12/2024
  6877                                  	push	eax
  6878                                  	; clear previous character pixels
  6879                                  	mov	edi, fillblock
  6880                                  	;;sys	_video, 020Fh, 0, 8001h
  6881                                  	; 30/12/2024
  6882                                  	sys	_video, 010Fh, 0, 8000h ; 8*8 userfont
  6883                                  	pop	eax
  6884                                  
  6885                                  	; 30/12/2024
  6886                                  	;shl	eax, 4 ; 8*16 pixel user font
  6887                                  	;mov	edi, fontbuff2 ; start of user font data
  6888                                  	;add	edi, eax
  6889                                  
  6890                                  	; 21/12/2024
  6891                                  	; NOTE:
  6892                                  	; TRDOS 386 does not use 8*14 pixel fonts in sysvideo
  6893                                  	; system calls -in graphics mode-
  6894                                  	; because 8*16 pixel operations are faster
  6895                                  	;			than 8*14 pixel operations.
  6896                                  	; ((so, 8*14 fonts can be converted to 8*16 fonts by
  6897                                  	; adding 2 empty lines))
  6898                                  	; (8*14 characters can be written via pixel operations)
  6899                                    	
  6900                                  	; 21/12/2024 (TRDOS 386 v2.0.9, trdosk6.s, 27/09/2024)
  6901                                  	;;;;;;;;;;;;;;;;; ; sysvideo system call
  6902                                  	;sysvideo:
  6903                                  	;   function in BH
  6904                                  	;	02h: Super VGA, LINEAR FRAME BUFFER data transfers
  6905                                  	;   sub function in BL
  6906                                  	;	0Fh: WRITE CHARACTER (FONT)
  6907                                  	;          CL = char's color (8 bit, 256 colors)
  6908                                  	;	If DH bit 7 = 1
  6909                                  	;	   USER FONT (from user buffer)
  6910                                  	;	         DL = 1 -> 8x16 pixel font
  6911                                   	;	   EDI = user's font buffer address
  6912                                  	;		(NOTE: byte order is as row0,row1,row2..)
  6913                                  	;	   ESI = start position (row, column)
  6914                                  	;		(HW = row, SI = column)
  6915                                  	;;;;;;;;;;;;;;;;;
  6916                                  
  6917                                  	;sys	_video, 020Fh, [wcolor], 8001h
  6918                                  
  6919                                  	; 30/12/2024
  6920                                  	; sysvideo system call
  6921                                  	; BH = 01h = VGA graphics (0A0000h) data transfers
  6922                                  	; BL = 0Fh = write character/font
  6923                                  	; DH = 01h = 8*8 system font 
  6924                                  	; CL = [wcolor] = color
  6925                                  	; ESI = cursor/writing position (pixels)
  6926                                  	;	HW = row, SI = column
  6927                                  	; DL = character (ASCII code)
  6928                                  
  6929                                  	mov	ah, 01h ; 8*8 pixels
  6930                                  
  6931                                  	sys	_video, 010Fh, [wcolor], eax
  6932                                  %endif
  6933                                  
  6934                                  	; 31/12/2024
  6935 00002A60 0FB6D9                  	movzx	ebx, cl ; bl = foreground color
  6936                                  	; al = character (ASCII code)
  6937 00002A63 B40E                    	mov	ah, 0Eh
  6938                                  	;int	10h
  6939 00002A65 CD31                    	int	31h
  6940 00002A67 C3                      	retn
  6941                                  
  6942                                  ; --------------------------------------------------------
  6943                                  
  6944                                  	; 30/12/2024
  6945                                  	; write characters in video mode 13h
  6946                                  	; (320*200 pixels, 256 colors)
  6947                                  	; 22/12/2024
  6948                                  	; 21/12/2024
  6949                                  	; (write chars in VESA VBE graphics mode)
  6950                                  	; 14/11/2024
  6951                                  	; (Ref: player.asm, Matan Alfasi, 2017)
  6952                                  	; (Modification: Erdogan Tan, 14/11/2024)
  6953                                  
  6954                                  	;PROGRESSBAR_ROW equ 23
  6955                                  	; 21/12/2024 (640*480)
  6956                                  	;PROGRESSBAR_ROW equ 31
  6957                                  	; 30/12/2024 (320*200)
  6958                                  	PROGRESSBAR_ROW equ 22
  6959                                  
  6960                                  UpdateProgressBar:
  6961 00002A68 E8D7FEFFFF              	call	SetProgressTime	; 14/11/2024
  6962                                  
  6963                                  	; 01/12/2024 (32bit registers)
  6964 00002A6D A1[A8370000]            	mov	eax, [ProgressTime]
  6965                                  UpdateProgressBar@:
  6966                                  	;mov	edx, 80
  6967                                  	; 30/12/2024
  6968 00002A72 BA28000000              	mov	edx, 40 ; 320*200 pixels, 40 columns 
  6969 00002A77 F7E2                    	mul	edx
  6970 00002A79 8B1D[A4370000]          	mov	ebx, [TotalTime]
  6971 00002A7F F7F3                    	div	ebx
  6972                                  
  6973                                  	; 22/12/2024
  6974                                  	; check progress bar indicator position if it is same 
  6975 00002A81 3A05[E1310000]          	cmp	al, [pbprev]
  6976 00002A87 7427                    	je	short UpdateProgressBar_ok
  6977 00002A89 A2[E1310000]            	mov	[pbprev], al
  6978                                  
  6979                                  UpdateProgressBar@@:
  6980                                  	;; Push for the 'Clean' part
  6981 00002A8E 50                      	push	eax ; **
  6982 00002A8F 50                      	push	eax ; *
  6983                                  
  6984                                  	;; Set cursor position
  6985 00002A90 B616                    	mov	dh, PROGRESSBAR_ROW
  6986 00002A92 B200                    	mov	dl, 0
  6987 00002A94 E835FEFFFF              	call	setCursorPosition
  6988                                  
  6989 00002A99 58                      	pop	eax ; *
  6990 00002A9A 09C0                    	or	eax, eax
  6991 00002A9C 7426                    	jz	short UpdateProgressBar_Clean
  6992                                  
  6993                                  UpdateProgressBar_DrawProgress:
  6994                                  	; 31/12/2024 (int 31h)
  6995                                  	; 22/12/2024
  6996                                  	; 21/12/2024
  6997                                  	; (write progress bar chars in graphics mode)
  6998                                  	;;;;
  6999 00002A9E 89C5                    	mov	ebp, eax
  7000 00002AA0 50                      	push	eax ; ***
  7001                                  	; 31/12/2024
  7002                                  	;mov	esi, [screenpos]
  7003                                  UpdateProgressBar_DrawProgress_@:
  7004 00002AA1 B8DF000000              	mov	eax, 223
  7005                                  	
  7006                                  	; esi = pixel position (hw = row, si = column)
  7007                                  	; eax = al = character
  7008                                  	;call	write_character
  7009                                  	; 22/12/2024
  7010 00002AA6 E8AAFFFFFF              	call	write_character_white
  7011                                  
  7012 00002AAB 4D                      	dec	ebp
  7013 00002AAC 7403                    	jz	short UpdateProgressBar_DrawCursor
  7014                                  
  7015                                  	; 31/12/2024
  7016                                  	;add	esi, 8 ; next column
  7017 00002AAE EBF1                    	jmp	short UpdateProgressBar_DrawProgress_@
  7018                                  	;;;
  7019                                  
  7020                                  UpdateProgressBar_ok:
  7021 00002AB0 C3                      	retn
  7022                                  
  7023                                  UpdateProgressBar_DrawCursor:
  7024                                  	; 22/12/2024
  7025 00002AB1 5A                      	pop	edx ; ***
  7026 00002AB2 B616                    	mov	dh, PROGRESSBAR_ROW
  7027                                  	; 31/12/2024
  7028 00002AB4 FECA                    	dec	dl ; last written position again
  7029 00002AB6 E813FEFFFF              	call	setCursorPosition
  7030                                  
  7031                                  	; 21/12/2024
  7032                                  	; (write progress bar character in graphics mode)
  7033                                  	;;;;
  7034                                  	;;;mov	eax, 223
  7035                                  	;;;shl	eax, 4 ; 8*16 pixel user font
  7036                                  	;;mov	eax, 223*16
  7037                                  	;;mov	edi, fontbuff2 ; start of user font data
  7038                                  	;;add	edi, eax
  7039                                  	;mov	edi, fontbuff2+(223*16)
  7040                                  	;
  7041                                  	;sys	_video, 020Fh, 0Ch, 8001h
  7042                                  	; 22/12/2024
  7043                                  	;mov	eax, 223
  7044                                  	; eax = 0
  7045 00002ABB B0DF                    	mov	al, 223
  7046 00002ABD B10C                    	mov	cl, 0Ch ; red
  7047 00002ABF E896FFFFFF              	call	write_character
  7048                                  	;;;;
  7049                                  
  7050                                  UpdateProgressBar_Clean:
  7051                                  	;pop	eax  ; **
  7052                                  	; 22/12/2024
  7053 00002AC4 5A                      	pop	edx  ; **
  7054                                  	; 30/12/2024
  7055                                  	; 21/12/2024
  7056                                  	;mov	ebp, 80
  7057                                  	; 30/12/2024
  7058 00002AC5 BD28000000              	mov	ebp, 40 ; 40 columns (320*200 pixels)
  7059                                  	;sub	bp, ax
  7060 00002ACA 6629D5                  	sub	bp, dx ; 22/12/2024
  7061                                  	;jz	short UpdateProgressBar_ok
  7062                                  	; 31/12/2024
  7063 00002ACD 76E1                    	jna	short UpdateProgressBar_ok
  7064                                  
  7065 00002ACF B616                    	mov	dh, PROGRESSBAR_ROW
  7066                                  	;mov	dl, al ; 22/12/2024
  7067 00002AD1 E8F8FDFFFF              	call	setCursorPosition
  7068                                  
  7069                                  	; 21/12/2024
  7070                                  	; (write progress bar chars in graphics mode)
  7071                                  	;;;;
  7072                                  	; 31/12/2024
  7073                                  	;mov	esi, [screenpos]
  7074                                  UpdateProgressBar_Clean_@:
  7075                                  	;;;mov	eax, 223
  7076                                  	;;;shl	eax, 4 ; 8*16 pixel user font
  7077                                  	;;mov	eax, 223*16
  7078                                  	;mov	edi, fontbuff2 ; start of user font data
  7079                                  	;add	edi, eax
  7080                                  	;mov	edi, fontbuff2+(223*16)
  7081                                  	;
  7082                                  	;sys	_video, 020Fh, 08h, 8001h
  7083                                  	; 22/12/2024
  7084                                  	;mov	eax, 223
  7085                                  	; eax = 0
  7086 00002AD6 B0DF                    	mov	al, 223
  7087 00002AD8 B108                    	mov	cl, 08h ; gray (dark)
  7088 00002ADA E87BFFFFFF              	call	write_character
  7089                                  	;;;;
  7090                                  
  7091 00002ADF 4D                      	dec	ebp
  7092 00002AE0 74CE                    	jz	short UpdateProgressBar_ok
  7093                                  
  7094                                  	; 31/12/2024
  7095                                  	;add	esi, 8 ; next column
  7096 00002AE2 EBF2                    	jmp	short UpdateProgressBar_Clean_@
  7097                                  	;;;;
  7098                                  
  7099                                  ; --------------------------------------------------------
  7100                                  ; 17/11/2024
  7101                                  
  7102                                  Player_ProcessKey_Backwards:
  7103                                  	;; In order to go backwards 5 seconds:
  7104                                  	;; Update file pointer to the beginning, skip headers
  7105 00002AE4 B142                    	mov	cl, 'B'
  7106 00002AE6 EB02                    	jmp	short Player_ProcessKey_B_or_F
  7107                                  
  7108                                  Player_ProcessKey_Forwards:
  7109                                  	;; In order to fast-forward 5 seconds, set the file pointer
  7110                                  	;; to CUR_SEEK + 5 * Freq
  7111                                  
  7112 00002AE8 B146                    	mov	cl, 'F'
  7113                                  	;jmp	short Player_ProcessKey_B_or_F
  7114                                  
  7115                                  	; 01/12/2024 (32bit regsisters)
  7116                                  Player_ProcessKey_B_or_F:
  7117                                  	; 17/11/2024
  7118                                  	; 04/11/2024
  7119                                  	; (Ref: player.asm, Matan Alfasi, 2017)
  7120                                    
  7121                                  	; 04/11/2024
  7122 00002AEA B805000000              	mov	eax, 5
  7123 00002AEF 0FB71D[18370000]        	movzx	ebx, word [WAVE_BlockAlign]
  7124 00002AF6 F7E3                    	mul	ebx
  7125 00002AF8 668B1D[10370000]        	mov	bx, [WAVE_SampleRate]
  7126 00002AFF F7E3                    	mul	ebx
  7127                                  	; eax = transfer byte count for 5 seconds
  7128                                  	
  7129                                  	; 17/11/2024
  7130 00002B01 80F942                  	cmp	cl, 'B'
  7131                                  	;mov	bx, [LoadedDataBytes]
  7132                                  	;mov	cx, [LoadedDataBytes+2]
  7133                                  	; 01/12/2024
  7134 00002B04 8B0D[B0370000]          	mov	ecx, [LoadedDataBytes]
  7135 00002B0A 7508                    	jne	short move_forward ; cl = 'F'
  7136                                  move_backward:
  7137                                  	;sub	bx, ax
  7138                                  	;sbb	cx, dx
  7139 00002B0C 29C1                    	sub	ecx, eax
  7140 00002B0E 7316                    	jnc	short move_file_pointer
  7141                                  move_to_beginning:
  7142                                  	;xor	cx, cx ; 0
  7143                                  	;xor	bx, bx ; 0
  7144 00002B10 31C9                    	xor	ecx, ecx
  7145 00002B12 EB12                    	jmp	short move_file_pointer
  7146                                  move_forward: 
  7147                                  	;add	bx, ax
  7148                                  	;adc	cx, dx
  7149 00002B14 01C1                    	add	ecx, eax
  7150 00002B16 7208                    	jc	short move_to_end
  7151                                  	;cmp	cx, [DATA_SubchunkSize+2]
  7152                                  	;ja	short move_to_end
  7153                                  	;jb	short move_file_pointer
  7154                                  	;cmp	bx, [DATA_SubchunkSize]
  7155                                  	;jna	short move_file_pointer
  7156 00002B18 3B0D[20370000]          	cmp	ecx, [DATA_SubchunkSize]
  7157 00002B1E 7606                    	jna	short move_file_pointer
  7158                                  move_to_end:
  7159                                  	;mov	bx, [DATA_SubchunkSize]
  7160                                  	;mov	cx, [DATA_SubchunkSize+2]
  7161 00002B20 8B0D[20370000]          	mov	ecx, [DATA_SubchunkSize]
  7162                                  move_file_pointer:
  7163                                  	;mov	dx, bx    
  7164                                  	;mov	[LoadedDataBytes], dx
  7165                                  	;mov	[LoadedDataBytes+2], cx
  7166 00002B26 890D[B0370000]          	mov	[LoadedDataBytes], ecx
  7167                                  	;add	dx, 44 ; + header
  7168                                  	;adc	cx, 0
  7169 00002B2C 83C12C                  	add	ecx, 44 
  7170                                  
  7171                                  	; seek
  7172                                  	;mov	bx, [filehandle]
  7173                                  	;mov	ax, 4200h
  7174                                  	;int	21h
  7175                                  	; 01/12/2024
  7176 00002B2F 31D2                    	xor	edx, edx ; offset from beginning of the file
  7177                                  	; ecx = offset	
  7178                                  	; ebx = file handle
  7179                                  	; edx = 0
  7180                                  	sys	_seek, [filehandle]
    92                              <1> 
    93                              <1> 
    94                              <1> 
    95                              <1> 
    96                              <1>  %if %0 >= 2
    97 00002B31 8B1D[28370000]      <1>  mov ebx, %2
    98                              <1>  %if %0 >= 3
    99                              <1>  mov ecx, %3
   100                              <1>  %if %0 = 4
   101                              <1>  mov edx, %4
   102                              <1>  %endif
   103                              <1>  %endif
   104                              <1>  %endif
   105 00002B37 B813000000          <1>  mov eax, %1
   106                              <1> 
   107 00002B3C CD40                <1>  int 40h
  7181 00002B3E C3                      	retn
  7182                                  
  7183                                  ; --------------------------------------------------------
  7184                                  
  7185                                  	; 30/12/2024 (video mode 13h)
  7186                                  	; (320*200, 256 colors)
  7187                                  	; 25/12/2024
  7188                                  	; 22/12/2024 (VESA VBE mode graphics) 
  7189                                  	; (640*480, 256 colors)
  7190                                  clear_window:
  7191                                  	;mov	edi, [LFB_ADDR]
  7192                                  	; 30/12/2024
  7193                                  	;mov	edi, 0A0000h
  7194                                  	;;add	edi, (13*80*8*14)
  7195                                  	; 25/12/2024
  7196                                  	;;add	edi, 164*640
  7197                                  	;add	edi, 12*8*320
  7198                                  	; 30/12/2024
  7199                                  	;mov	edi, [graphstart] ; 12*8*320
  7200 00002B3F BF80700A00              	mov	edi, 0A0000h+(11*8*320)+(2*320) ; *
  7201                                  				; AC97 info start 
  7202 00002B44 29C0                    	sub	eax, eax
  7203                                  	;;mov	ecx, (16*640*14)/4 ; 16 rows
  7204                                  	;mov	ecx, 64*640 ; 256 volume level points
  7205                                  	; 30/12/2024
  7206                                  	;mov	ecx, (8*8*320)/4 ; 8 rows 
  7207 00002B46 B900190000              	mov	ecx, (10*8*320)/4 ; *
  7208 00002B4B F3AB                    	rep	stosd
  7209                                  	; 24/12/2024
  7210 00002B4D A3[E8310000]            	mov	[prev_points], eax ; 0
  7211                                  	;
  7212 00002B52 C3                      	retn
  7213                                  
  7214                                  ; -------------------------------------------------------------
  7215                                  ; ac97.inc (11/11/2023)
  7216                                  ; -------------------------------------------------------------
  7217                                  
  7218                                  ; special characters
  7219                                  LF      EQU 10
  7220                                  CR      EQU 13
  7221                                  
  7222                                  ; PCI stuff
  7223                                  
  7224                                  BIT0  EQU 1
  7225                                  BIT1  EQU 2
  7226                                  BIT2  EQU 4
  7227                                  BIT8  EQU 100h
  7228                                  BIT9  EQU 200h
  7229                                  BIT28 EQU 10000000h
  7230                                  BIT30 EQU 40000000h
  7231                                  BIT31 EQU 80000000h
  7232                                  
  7233                                  BUP		equ	BIT30		; Buffer Underrun Policy.
  7234                                  					; if this buffer is the last buffer
  7235                                  					; in a playback, fill the remaining
  7236                                  					; samples with 0 (silence) or not.
  7237                                  					; It's a good idea to set this to 1
  7238                                  					; for the last buffer in playback,
  7239                                  					; otherwise you're likely to get a lot
  7240                                  					; of noise at the end of the sound.
  7241                                  
  7242                                  RR		equ	BIT1		; reset registers. Nukes all regs
  7243                                                                          ; except bits 4:2 of this register.
  7244                                                                          ; Only set this bit if BIT 0 is 0
  7245                                  RPBM		equ	BIT0		; Run/Pause
  7246                                  					; set this bit to start the codec!
  7247                                  IO_ENA		EQU	BIT0		; i/o decode enable
  7248                                  BM_ENA		EQU	BIT2		; bus master enable
  7249                                  
  7250                                  PCI_INDEX_PORT  EQU     0CF8h
  7251                                  PCI_DATA_PORT   EQU     0CFCh
  7252                                  PCI32           EQU     BIT31           ; bitflag to signal 32bit access
  7253                                  PCI16           EQU     BIT30           ; bitflag for 16bit access
  7254                                  
  7255                                  AC97_INT_LINE	equ	3Ch		; AC97 Interrupt Line register offset
  7256                                  
  7257                                  ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
  7258                                  
  7259                                  INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
  7260                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  7261                                  SIS_VID		equ	1039h
  7262                                  NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
  7263                                  AMD_VID		equ	1022h
  7264                                  
  7265                                  ICH_DID         equ     2415h           ; ICH device ID
  7266                                  ICH0_DID        equ     2425h           ; ICH0
  7267                                  ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
  7268                                                                          ; they all should be compatible.
  7269                                  
  7270                                  ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
  7271                                  ICH3_DID	equ     2485h           ; ICH3
  7272                                  ICH4_DID        equ     24C5h           ; ICH4
  7273                                  ICH5_DID	equ     24D5h           ; ICH5
  7274                                  ICH6_DID	equ     266Eh           ; ICH6
  7275                                  ESB6300_DID	equ     25A6h           ; 6300ESB
  7276                                  ESB631X_DID	equ     2698h           ; 631XESB
  7277                                  ICH7_DID	equ	27DEh		; ICH7
  7278                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  7279                                  MX82440_DID	equ	7195h
  7280                                  SI7012_DID	equ	7012h
  7281                                  NFORCE_DID	equ	01B1h
  7282                                  NFORCE2_DID	equ	006Ah
  7283                                  AMD8111_DID	equ	746Dh
  7284                                  AMD768_DID	equ	7445h
  7285                                  ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
  7286                                  CK804_DID	equ	0059h
  7287                                  MCP04_DID	equ	003Ah
  7288                                  CK8_DID		equ	008Ah
  7289                                  NFORCE3_DID	equ	00DAh
  7290                                  CK8S_DID	equ	00EAh
  7291                                  
  7292                                  NAMBAR_REG	equ	10h		; native audio mixer BAR
  7293                                  NABMBAR_REG	equ	14h		; native audio bus mastering BAR
  7294                                  
  7295                                  CODEC_MASTER_VOL_REG	equ	02h	; master volume
  7296                                  CODEC_MASTER_TONE_REG	equ	08h	; master tone (R+L)
  7297                                  CODEC_PCM_OUT_REG 	equ	18h     ; PCM output volume
  7298                                  CODEC_EXT_AUDIO_REG	equ	28h	; extended audio
  7299                                  CODEC_EXT_AUDIO_CTRL_REG equ	2Ah	; extended audio control
  7300                                  CODEC_PCM_FRONT_DACRATE_REG equ	2Ch	; PCM out sample rate
  7301                                  
  7302                                  ; ICH supports 3 different types of register sets for three types of things
  7303                                  ; it can do, thus:
  7304                                  ;
  7305                                  ; PCM in (for recording) aka PI
  7306                                  ; PCM out (for playback) aka PO
  7307                                  ; MIC in (for recording) aka MC
  7308                                  
  7309                                  PI_BDBAR_REG	equ	0		; PCM in buffer descriptor BAR
  7310                                  PO_BDBAR_REG	equ	10h		; PCM out buffer descriptor BAR
  7311                                  
  7312                                  GLOB_CNT_REG	equ	2Ch		; Global control register
  7313                                  GLOB_STS_REG 	equ	30h		; Global Status register (RO)
  7314                                  
  7315                                  PI_CR_REG 	equ	0Bh		; PCM in Control Register
  7316                                  PO_CR_REG	equ	1Bh		; PCM out Control Register
  7317                                  MC_CR_REG	equ	2Bh		; MIC in Control Register
  7318                                  
  7319                                  PCI_CMD_REG	EQU	04h		; reg 04h, command register
  7320                                  
  7321                                  CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
  7322                                  CODEC_REG_POWERDOWN	equ	26h
  7323                                  
  7324                                  PO_CIV_REG	equ	14h		; PCM out current Index value (RO)
  7325                                  PO_LVI_REG	equ	15h		; PCM out Last Valid Index
  7326                                  PO_SR_REG	equ	16h		; PCM out Status register
  7327                                  
  7328                                  ; -------------------------------------------------------------
  7329                                  
  7330                                  ; 22/12/2024
  7331 00002B53 90                      align 4
  7332                                  
  7333                                  ; 13/11/2024
  7334                                  ; ('<<' to 'shl' conversion for FASM)
  7335                                  ;
  7336                                  ; 29/05/2024 (TRDOS 386)
  7337                                  ; 17/02/2017
  7338                                  ; Valid ICH device IDs
  7339                                  
  7340                                  valid_ids:
  7341                                  	;dd (ICH_DID shl 16) + INTEL_VID	; 8086h:2415h
  7342 00002B54 86801524                	dd (ICH_DID << 16) + INTEL_VID		; 8086h:2415h
  7343 00002B58 86802524                	dd (ICH0_DID << 16) + INTEL_VID		; 8086h:2425h
  7344 00002B5C 86804524                	dd (ICH2_DID << 16) + INTEL_VID		; 8086h:2445h
  7345 00002B60 86808524                	dd (ICH3_DID << 16) + INTEL_VID		; 8086h:2485h
  7346 00002B64 8680C524                	dd (ICH4_DID << 16) + INTEL_VID		; 8086h:24C5h
  7347 00002B68 8680D524                	dd (ICH5_DID << 16) + INTEL_VID		; 8086h:24D5h
  7348 00002B6C 86806E26                	dd (ICH6_DID << 16) + INTEL_VID		; 8086h:266Eh
  7349 00002B70 8680A625                	dd (ESB6300_DID << 16) + INTEL_VID	; 8086h:25A6h
  7350 00002B74 86809826                	dd (ESB631X_DID << 16) + INTEL_VID	; 8086h:2698h
  7351 00002B78 8680DE27                	dd (ICH7_DID << 16) + INTEL_VID		; 8086h:27DEh
  7352                                  	; 03/11/2023 - Erdogan Tan
  7353 00002B7C 86809571                	dd (MX82440_DID << 16) + INTEL_VID	; 8086h:7195h
  7354 00002B80 39101270                	dd (SI7012_DID << 16)  + SIS_VID	; 1039h:7012h
  7355 00002B84 DE10B101                	dd (NFORCE_DID << 16)  + NVIDIA_VID	; 10DEh:01B1h
  7356 00002B88 DE106A00                	dd (NFORCE2_DID << 16) + NVIDIA_VID	; 10DEh:006Ah
  7357 00002B8C 22106D74                	dd (AMD8111_DID << 16) + AMD_VID	; 1022h:746Dh
  7358 00002B90 22104574                	dd (AMD768_DID << 16)  + AMD_VID	; 1022h:7445h
  7359 00002B94 DE105900                	dd (CK804_DID << 16) + NVIDIA_VID	; 10DEh:0059h
  7360 00002B98 DE103A00                	dd (MCP04_DID << 16) + NVIDIA_VID	; 10DEh:003Ah
  7361 00002B9C DE108A00                	dd (CK8_DID << 16) + NVIDIA_VID		; 1022h:008Ah
  7362 00002BA0 DE10DA00                	dd (NFORCE3_DID << 16) + NVIDIA_VID	; 10DEh:00DAh
  7363 00002BA4 DE10EA00                	dd (CK8S_DID << 16) + NVIDIA_VID	; 10DEh:00EAh
  7364                                  
  7365                                  valid_id_count equ (($ - valid_ids)>>2)	; 05/11/2023
  7366                                  ; 13/11/2024
  7367                                  ;valid_id_count = ($ - valid_ids) shr 2	; 05/11/2023
  7368                                  
  7369 00002BA8 00000000                	dd 0
  7370                                  
  7371                                  Credits:
  7372 00002BAC 564741205741562050-     	db 'VGA WAV Player for TRDOS 386 by Erdogan Tan. '
  7372 00002BB5 6C6179657220666F72-
  7372 00002BBE 205452444F53203338-
  7372 00002BC7 36206279204572646F-
  7372 00002BD0 67616E2054616E2E20 
  7373 00002BD9 4A616E756172792032-     	db 'January 2025.',10,13,0
  7373 00002BE2 3032352E0A0D00     
  7374                                  	;db '01/01/2025', 10,13
  7375 00002BE9 31382F30312F323032-     	db '18/01/2025', 10,13
  7375 00002BF2 350A0D             
  7376                                  ; 15/11/2024
  7377                                  reset:
  7378 00002BF5 00                      	db 0
  7379                                  
  7380                                  msgAudioCardInfo:
  7381 00002BF6 666F7220496E74656C-     	db 'for Intel AC97 (ICH) Audio Controller.', 10,13,0
  7381 00002BFF 204143393720284943-
  7381 00002C08 482920417564696F20-
  7381 00002C11 436F6E74726F6C6C65-
  7381 00002C1A 722E0A0D00         
  7382                                  
  7383                                  	; 31/12/2024
  7384                                  msg_usage:
  7385 00002C1F 75736167653A204347-     	db 'usage: CGAPLAY1 <FileName1> <FileName2> <...>',10,13,0
  7385 00002C28 41504C415931203C46-
  7385 00002C31 696C654E616D65313E-
  7385 00002C3A 203C46696C654E616D-
  7385 00002C43 65323E203C2E2E2E3E-
  7385 00002C4C 0A0D00             
  7386                                  
  7387                                  noDevMsg:
  7388 00002C4F 4572726F723A20556E-     	db 'Error: Unable to find AC97 audio device!'
  7388 00002C58 61626C6520746F2066-
  7388 00002C61 696E64204143393720-
  7388 00002C6A 617564696F20646576-
  7388 00002C73 69636521           
  7389 00002C77 0A0D00                  	db 10,13,0
  7390                                  
  7391                                  noFileErrMsg:
  7392 00002C7A 4572726F723A206669-     	db 'Error: file not found.',10,13,0
  7392 00002C83 6C65206E6F7420666F-
  7392 00002C8C 756E642E0A0D00     
  7393                                  
  7394                                  ; 07/12/2024
  7395                                  trdos386_err_msg:
  7396 00002C93 5452444F5320333836-     	db 'TRDOS 386 System call error !',10,13,0
  7396 00002C9C 2053797374656D2063-
  7396 00002CA5 616C6C206572726F72-
  7396 00002CAE 20210A0D00         
  7397                                  
  7398                                  ; 29/05/2024
  7399                                  ; 11/11/2023
  7400                                  msg_init_err:
  7401 00002CB3 0D0A                    	db CR, LF
  7402 00002CB5 4143393720436F6E74-     	db 'AC97 Controller/Codec initialization error !'
  7402 00002CBE 726F6C6C65722F436F-
  7402 00002CC7 64656320696E697469-
  7402 00002CD0 616C697A6174696F6E-
  7402 00002CD9 206572726F722021   
  7403 00002CE1 0D0A00                  	db CR, LF, 0 ; 07/12/2024
  7404                                  
  7405                                  ; 25/11/2023
  7406                                  msg_no_vra:
  7407 00002CE4 0A0D                    	db 10,13
  7408 00002CE6 4E6F20565241207375-     	db 'No VRA support ! Only 48 kHZ sample rate supported !'
  7408 00002CEF 70706F72742021204F-
  7408 00002CF8 6E6C79203438206B48-
  7408 00002D01 5A2073616D706C6520-
  7408 00002D0A 726174652073757070-
  7408 00002D13 6F727465642021     
  7409 00002D1A 0A0D00                  	db 10,13,0
  7410                                  
  7411                                  ; 19/11/2024
  7412                                  ; 03/06/2017
  7413                                  hex_chars:
  7414 00002D1D 303132333435363738-     	db '0123456789ABCDEF', 0
  7414 00002D26 3941424344454600   
  7415                                  msgAC97Info:
  7416 00002D2E 0D0A                    	db 0Dh, 0Ah
  7417 00002D30 204143393720417564-     	db ' AC97 Audio Controller & Codec Info', 0Dh, 0Ah 
  7417 00002D39 696F20436F6E74726F-
  7417 00002D42 6C6C6572202620436F-
  7417 00002D4B 64656320496E666F0D-
  7417 00002D54 0A                 
  7418 00002D55 2056656E646F722049-     	db ' Vendor ID: '
  7418 00002D5E 443A20             
  7419                                  msgVendorId:
  7420 00002D61 303030306820446576-     	db '0000h Device ID: '
  7420 00002D6A 6963652049443A20   
  7421                                  msgDevId:
  7422 00002D72 30303030680D0A          	db '0000h', 0Dh, 0Ah
  7423 00002D79 204275733A20            	db ' Bus: '
  7424                                  msgBusNo:
  7425 00002D7F 303068204465766963-     	db '00h Device: '
  7425 00002D88 653A20             
  7426                                  msgDevNo:
  7427 00002D8B 3030682046756E6374-     	db '00h Function: '
  7427 00002D94 696F6E3A20         
  7428                                  msgFncNo:
  7429 00002D99 303068                  	db '00h'
  7430 00002D9C 0D0A                    	db 0Dh, 0Ah
  7431 00002D9E 204E414D4241523A20      	db ' NAMBAR: '
  7432                                  msgNamBar:
  7433 00002DA7 30303030682020          	db '0000h  '
  7434 00002DAE 4E41424D4241523A20      	db 'NABMBAR: '
  7435                                  msgNabmBar:
  7436 00002DB7 303030306820204952-     	db '0000h  IRQ: '
  7436 00002DC0 513A20             
  7437                                  msgIRQ:
  7438 00002DC3 3030                    	dw 3030h
  7439 00002DC5 0D0A00                  	db 0Dh, 0Ah, 0
  7440                                  ; 25/11/2023
  7441                                  msgVRAheader:
  7442 00002DC8 205652412073757070-     	db ' VRA support: '
  7442 00002DD1 6F72743A20         
  7443 00002DD6 00                      	db 0	
  7444                                  msgVRAyes:
  7445 00002DD7 5945530D0A00            	db 'YES', 0Dh, 0Ah, 0
  7446                                  msgVRAno:
  7447 00002DDD 4E4F200D0A              	db 'NO ', 0Dh, 0Ah
  7448                                  	;db ' (Interpolated sample rate playing method)'
  7449                                  	; 30/12/2024
  7450 00002DE2 2028496E746572706F-     	db ' (Interpolated samplerate play method)'
  7450 00002DEB 6C617465642073616D-
  7450 00002DF4 706C65726174652070-
  7450 00002DFD 6C6179206D6574686F-
  7450 00002E06 6429               
  7451 00002E08 0D0A00                  	db 0Dh, 0Ah, 0
  7452                                  
  7453 00002E0B 90                      align 4
  7454                                  
  7455                                  ; -------------------------------------------------------------
  7456                                  
  7457                                  	; 30/12/2024
  7458                                  PlayingScreen:
  7459 00002E0C DBDBDBDBDBDBDBDBDB-     	db  14 dup(219), " DOS Player ", 14 dup(219)
  7459 00002E15 DBDBDBDBDB20444F53-
  7459 00002E1E 20506C6179657220DB-
  7459 00002E27 DBDBDBDBDBDBDBDBDB-
  7459 00002E30 DBDBDBDB           
  7460 00002E34 C9CDCDCDCDCDCDCDCD-     	db  201, 38 dup(205), 187
  7460 00002E3D CDCDCDCDCDCDCDCDCD-
  7460 00002E46 CDCDCDCDCDCDCDCDCD-
  7460 00002E4F CDCDCDCDCDCDCDCDCD-
  7460 00002E58 CDCDCDBB           
  7461 00002E5C BA203C53706163653E-     	db  186, " <Space> Play/Pause <N>/<P> Next/Prev ", 186
  7461 00002E65 20506C61792F506175-
  7461 00002E6E 7365203C4E3E2F3C50-
  7461 00002E77 3E204E6578742F5072-
  7461 00002E80 657620BA           
  7462 00002E84 BA203C533E20202020-     	db  186, " <S>     Stop       <Enter> Color     ", 186
  7462 00002E8D 2053746F7020202020-
  7462 00002E96 2020203C456E746572-
  7462 00002E9F 3E20436F6C6F722020-
  7462 00002EA8 202020BA           
  7463 00002EAC BA203C463E20202020-     	db  186, " <F>     Forwards   <+>/<-> Volume    ", 186
  7463 00002EB5 20466F727761726473-
  7463 00002EBE 2020203C2B3E2F3C2D-
  7463 00002EC7 3E20566F6C756D6520-
  7463 00002ED0 202020BA           
  7464 00002ED4 BA203C423E20202020-     	db  186, " <B>     Backwards  <Q>     Quit Prg  ", 186
  7464 00002EDD 204261636B77617264-
  7464 00002EE6 7320203C513E202020-
  7464 00002EEF 202051756974205072-
  7464 00002EF8 672020BA           
  7465 00002EFC CCCDCDCDCDCDCDCDCD-     	db  204, 38 dup(205), 185
  7465 00002F05 CDCDCDCDCDCDCDCDCD-
  7465 00002F0E CDCDCDCDCDCDCDCDCD-
  7465 00002F17 CDCDCDCDCDCDCDCDCD-
  7465 00002F20 CDCDCDB9           
  7466 00002F24 BA2046696C653A2020-     	db  186, " File:              Bits:     0       ", 186
  7466 00002F2D 202020202020202020-
  7466 00002F36 202020426974733A20-
  7466 00002F3F 202020203020202020-
  7466 00002F48 202020BA           
  7467 00002F4C BA20467265713A2030-     	db  186, " Freq: 0     Hz     Channels: 0       ", 186
  7467 00002F55 2020202020487A2020-
  7467 00002F5E 2020204368616E6E65-
  7467 00002F67 6C733A203020202020-
  7467 00002F70 202020BA           
  7468 00002F74 C8CDCDCDCDCDCDCDCD-     	db  200, 38 dup(205), 188
  7468 00002F7D CDCDCDCDCDCDCDCDCD-
  7468 00002F86 CDCDCDCDCDCDCDCDCD-
  7468 00002F8F CDCDCDCDCDCDCDCDCD-
  7468 00002F98 CDCDCDBC           
  7469 00002F9C 202020202020202020-     	db  40 dup(32)
  7469 00002FA5 202020202020202020-
  7469 00002FAE 202020202020202020-
  7469 00002FB7 202020202020202020-
  7469 00002FC0 20202020           
  7470                                  improper_samplerate_txt:
  7471                                  read_error_txt:
  7472 00002FC4 202020202020202020-     	db  40 dup(32)
  7472 00002FCD 202020202020202020-
  7472 00002FD6 202020202020202020-
  7472 00002FDF 202020202020202020-
  7472 00002FE8 20202020           
  7473 00002FEC 202020202020202020-     	db  40 dup(32)
  7473 00002FF5 202020202020202020-
  7473 00002FFE 202020202020202020-
  7473 00003007 202020202020202020-
  7473 00003010 20202020           
  7474 00003014 202020202020202020-     	db  40 dup(32)
  7474 0000301D 202020202020202020-
  7474 00003026 202020202020202020-
  7474 0000302F 202020202020202020-
  7474 00003038 20202020           
  7475 0000303C 202020202020202020-     	db  40 dup(32)
  7475 00003045 202020202020202020-
  7475 0000304E 202020202020202020-
  7475 00003057 202020202020202020-
  7475 00003060 20202020           
  7476 00003064 202020202020202020-     	db  40 dup(32)
  7476 0000306D 202020202020202020-
  7476 00003076 202020202020202020-
  7476 0000307F 202020202020202020-
  7476 00003088 20202020           
  7477 0000308C 202020202020202020-     	db  40 dup(32)
  7477 00003095 202020202020202020-
  7477 0000309E 202020202020202020-
  7477 000030A7 202020202020202020-
  7477 000030B0 20202020           
  7478 000030B4 202020202020202020-     	db  40 dup(32)
  7478 000030BD 202020202020202020-
  7478 000030C6 202020202020202020-
  7478 000030CF 202020202020202020-
  7478 000030D8 20202020           
  7479 000030DC 202020202020202020-     	db  40 dup(32)
  7479 000030E5 202020202020202020-
  7479 000030EE 202020202020202020-
  7479 000030F7 202020202020202020-
  7479 00003100 20202020           
  7480 00003104 202020202020202020-     	db  40 dup(32)
  7480 0000310D 202020202020202020-
  7480 00003116 202020202020202020-
  7480 0000311F 202020202020202020-
  7480 00003128 20202020           
  7481 0000312C 202020202020202020-     	db  40 dup(32)
  7481 00003135 202020202020202020-
  7481 0000313E 202020202020202020-
  7481 00003147 202020202020202020-
  7481 00003150 20202020           
  7482 00003154 CDCDCDCDCDCDCDCDCD-     	db  40 dup(205)
  7482 0000315D CDCDCDCDCDCDCDCDCD-
  7482 00003166 CDCDCDCDCDCDCDCDCD-
  7482 0000316F CDCDCDCDCDCDCDCDCD-
  7482 00003178 CDCDCDCD           
  7483 0000317C 202020202020202020-     	db  40 dup(32)
  7483 00003185 202020202020202020-
  7483 0000318E 202020202020202020-
  7483 00003197 202020202020202020-
  7483 000031A0 20202020           
  7484 000031A4 202020202020202020-     	db  13 dup(32), "00:00 ", 174, 175, " 00:00", 4 dup(32), "VOL 000%"
  7484 000031AD 2020202030303A3030-
  7484 000031B6 20AEAF2030303A3030-
  7484 000031BF 20202020564F4C2030-
  7484 000031C8 303025             
  7485                                  	;db  40 dup(32) ; not necessary
  7486 000031CB 00                      	db 0
  7487                                  
  7488                                  ; -------------------------------------------------------------
  7489                                  
  7490                                  ; 31/12/2024
  7491                                  	; 30/12/2024
  7492                                  ;fillblock:
  7493                                  ;	times 8 db 0FFh
  7494                                  ;	dw 0
  7495                                  
  7496                                  ; -------------------------------------------------------------
  7497                                  
  7498                                  ; 30/12/2024
  7499                                  ; 23/11/2024
  7500                                  colors:
  7501 000031CC 0F0B0A0C0E090D          	db 0Fh, 0Bh, 0Ah, 0Ch, 0Eh, 09h, 0Dh
  7502                                  	; white, cyan, green, red, yellow, blue, magenta
  7503 000031D3 0B                      ccolor:	db 0Bh	; cyan
  7504                                  
  7505                                  EOF: 
  7506                                  
  7507                                  ; -------------------------------------------------------------
  7508                                  
  7509                                  bss:
  7510                                  
  7511                                  ABSOLUTE bss
  7512                                  
  7513                                  alignb 4
  7514                                  
  7515                                  ; 24/12/2024
  7516                                  wpoints_dif:	; wave lighting points factor (differential) 
  7517 000031D4 ????????                	resd 1	; required bytes for 1/18 second wave lighting
  7518                                  graphstart:
  7519 000031D8 ????????                	resd 1	; start (top) line/row for wave lighting points 	 
  7520                                  
  7521                                  ; 30/12/2024
  7522                                  ;LFB_ADDR:
  7523                                  ;	resd 1
  7524                                  
  7525                                  ;nextrow:
  7526                                  	;resd 1
  7527                                  
  7528                                  ; 31/12/2024
  7529                                  ;screenpos: ; hw = (cursor) row, lw = (cursor) column
  7530                                  	;resd 1
  7531                                  
  7532 000031DC ????????                wcolor:	resd 1
  7533                                  ; 26/12/2024
  7534                                  ;tcolor: resb 1 ; text color
  7535                                  columns:
  7536 000031E0 ??                      	resb 1
  7537 000031E1 ??                      pbprev:	resb 1 ; previous progress bar indicator position
  7538                                  
  7539 000031E2 ????                    alignb 4
  7540                                  
  7541                                  bss_start:
  7542                                  
  7543                                  ; 29/12/2024
  7544                                  audio_buffer:
  7545 000031E4 ????????                	resd 1
  7546                                  
  7547                                  ; 30/12/2024
  7548                                  prev_points:
  7549 000031E8 <res 500h>              	resd 320 ; previous wave points (which are lighting)	
  7550                                  
  7551                                  ; 18/11/2024
  7552                                  stopped:
  7553 000036E8 ??                      	resb 1
  7554 000036E9 ??                      tLO:	resb 1
  7555                                  ; 21/11/2024
  7556 000036EA ??                      tLP:	resb 1
  7557                                  ; 30/12/2024
  7558                                  wpoints:
  7559 000036EB ??                      	resb 1
  7560 000036EC ????????                pbuf_o:	resd 1
  7561                                  ; 29/12/2024
  7562 000036F0 ????????                pbuf_s:	resd 1
  7563                                  
  7564                                  ; 07/12/2024
  7565                                  ; 24/11/2024
  7566                                  half_buffer:
  7567 000036F4 ??                      	resb 1	; dma half buffer 1 or 2 (0 or 1)
  7568                                  
  7569                                  ; 30/05/2024
  7570 000036F5 ??                      VRA:	resb 1	; Variable Rate Audio Support Status
  7571                                  
  7572                                  ; 25/12/2024
  7573                                  ; 29/11/2024
  7574                                  command:
  7575 000036F6 ??                      	resb 1
  7576                                  filecount:
  7577 000036F7 ??                      	resb 1
  7578                                  
  7579                                  ; 30/11/2024
  7580                                  alignb 4
  7581                                  
  7582                                  ;;;;;;;;;;;;;;
  7583                                  ; 14/11/2024
  7584                                  ; (Ref: player.asm, Matan Alfasi, 2017)  
  7585                                  WAVFILEHEADERbuff:
  7586                                  RIFF_ChunkID:
  7587 000036F8 ????????                	resd 1	; Must be equal to "RIFF" - big-endian
  7588                                  		; 0x52494646
  7589                                  RIFF_ChunkSize:
  7590 000036FC ????????                	resd 1	; Represents total file size, not 
  7591                                          	; including the first 2 fields 
  7592                                  		; (Total_File_Size - 8), little-endian
  7593                                  RIFF_Format:
  7594 00003700 ????????                	resd 1	; Must be equal to "WAVE" - big-endian
  7595                                  		; 0x57415645
  7596                                  
  7597                                  ;; WAVE header parameters ("Sub-chunk")
  7598                                  WAVE_SubchunkID:
  7599 00003704 ????????                	resd 1	; Must be equal to "fmt " - big-endian
  7600                                  		; 0x666d7420
  7601                                  WAVE_SubchunkSize:
  7602 00003708 ????????                	resd 1	; Represents total chunk size
  7603                                  WAVE_AudioFormat:
  7604 0000370C ????                    	resw 1	; PCM (Raw) - is 1, other - is a form 
  7605                                  		; of compression, not supported.
  7606                                  WAVE_NumChannels:
  7607 0000370E ????                    	resw 1	; Number of channels, Mono-1, Stereo-2
  7608                                  WAVE_SampleRate:
  7609 00003710 ????????                	resd 1	; Frequency rate, in Hz (8000, 44100 ...)
  7610                                  WAVE_ByteRate:
  7611 00003714 ????????                	resd 1	; SampleRate * NumChannels * BytesPerSample
  7612                                  WAVE_BlockAlign:
  7613 00003718 ????                    	resw 1	; NumChannels * BytesPerSample
  7614                                  		; Number of bytes for one sample.
  7615                                  WAVE_BitsPerSample:
  7616 0000371A ????                    	resw 1	; 8 = 8 bits, 16 = 16 bits, etc.
  7617                                  
  7618                                  ;; DATA header parameters
  7619                                  DATA_SubchunkID:
  7620 0000371C ????????                	resd 1	; Must be equal to "data" - big-endian
  7621                                          	; 0x64617461
  7622                                  DATA_SubchunkSize:
  7623 00003720 ????????                	resd 1	; NumSamples * NumChannels * BytesPerSample
  7624                                          	; Number of bytes in the data.
  7625                                  ;;;;;;;;;;;;;;
  7626                                  
  7627                                  ; 28/12/2024
  7628                                  ; 15/11/2024
  7629                                  ;cursortype:
  7630 00003724 ????                    	resw 1
  7631 00003726 ??                      flags:	resb 1
  7632                                  ; 06/11/2023
  7633                                  ac97_int_ln_reg:
  7634 00003727 ??                      	resb 1
  7635                                  filehandle:
  7636 00003728 ????????                	resd 1
  7637                                  
  7638                                  ; 25/12/2024
  7639                                  ; 30/11/2024
  7640                                  ;argc:	resb 1	; argument count
  7641 0000372C ????????                argv:	resd 1	; current argument (wav file) ptr
  7642 00003730 ????????                argvf:	resd 1	; 1st argument (wav file) ptr
  7643 00003734 ????????                argvl:	resd 1	; last argument (wav file) ptr
  7644                                  
  7645                                  ; 30/05/2024
  7646                                  wav_file_name:
  7647 00003738 <res 50h>               	resb 80	; wave file, path name (<= 80 bytes)
  7648 00003788 ????                    	resw 1	; 30/11/2024
  7649                                  
  7650                                  ; 08/11/2023
  7651                                  ; 07/11/2023
  7652                                  fbs_shift:
  7653 0000378A ??                      	resb 1
  7654                                  ; 07/12/2024
  7655 0000378B ??                      SRB:	resb 1
  7656                                  
  7657                                  ; 12/11/2016 - Erdogan Tan
  7658                                  bus_dev_fn:
  7659 0000378C ????????                	resd 1
  7660                                  dev_vendor:
  7661 00003790 ????????                	resd 1
  7662                                  
  7663                                  ; 17/02/2017
  7664                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  7665                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  7666                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  7667                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  7668 00003794 ????                    NAMBAR:	resw 1	; BAR for mixer
  7669                                  NABMBAR:
  7670 00003796 ????                    	resw 1	; BAR for bus master regs
  7671                                  
  7672                                  ; 15/11/2024
  7673                                  loadfromwavfile:
  7674 00003798 ????????                	resd 1	; 'loadfromfile' or load+conversion proc address
  7675                                  loadsize:
  7676 0000379C ????????                	resd 1	; (.wav file) read count (bytes) per one time
  7677                                  buffersize:
  7678 000037A0 ????????                	resd 1	; 16 bit samples (not bytes)
  7679                                  		
  7680                                  ; 14/11/2024
  7681                                  TotalTime:
  7682 000037A4 ????????                	resd 1	; Total (WAV File) Playing Time in seconds
  7683                                  ProgressTime:
  7684 000037A8 ????????                	resd 1
  7685 000037AC ????????                count:	resd 1	; byte count of one (wav file) read
  7686                                  LoadedDataBytes:
  7687 000037B0 ????????                	resd 1	; total read/load count
  7688                                  
  7689                                  timerticks:
  7690 000037B4 ????????                	resd 1	; (to eliminate excessive lookup of events in tuneloop)
  7691                                  		; (in order to get the emulator/qemu to run correctly)
  7692                                  ; 01/12/2024
  7693                                  _bdl_buffer:
  7694 000037B8 ????????                	resd 1
  7695                                  
  7696                                  ; 14/11/2024
  7697                                  bss_end:
  7698                                  
  7699                                  ; 29/12/2024
  7700 000037BC <res 844h>              alignb 4096
  7701                                  
  7702                                  ; 01/12/2024
  7703                                  BDL_BUFFER:
  7704 00004000 <res 100h>              	resb 256
  7705                                  	; 02/12/2024
  7706 00004100 <res F00h>              	resb 4096-256
  7707                                  
  7708                                  ;alignb 4096
  7709                                  
  7710                                  ; 29/05/2024
  7711                                  WAVBUFFER_1:
  7712 00005000 <res 10000h>            	resb 65536
  7713                                  WAVBUFFER_2:
  7714 00015000 <res 10000h>            	resb 65536
  7715                                  
  7716                                  ; 01/12/2024
  7717                                  ; 26/11/2023
  7718                                  temp_buffer:
  7719 00025000 <res 10000h>            	resb 65536  ;  resb BUFFERSIZE
