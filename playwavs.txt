     1                                  ; ****************************************************************************
     2                                  ; playwav6.s (for TRDOS 386)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYWAV6.PRG ! AC'97 (ICH) .WAV PLAYER program by Erdogan TAN
     5                                  ;
     6                                  ; 25/11/2023
     7                                  ;
     8                                  ; [ Last Modification: 17/01/2025 ]
     9                                  ;
    10                                  ; Modified from PLAYWAV5.PRG .wav player program by Erdogan Tan, 18/08/2020
    11                                  ;
    12                                  ; Assembler: NASM version 2.15
    13                                  ;	     nasm playwav6.s -l playwav6.txt -o PLAYWAV6.PRG	
    14                                  ; ----------------------------------------------------------------------------
    15                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002
    16                                  
    17                                  ; previous version: playwav3.s (17/06/2017)
    18                                  
    19                                  ; CODE
    20                                  
    21                                  ; 14/07/2020
    22                                  ; 31/12/2017
    23                                  ; TRDOS 386 (v2.0) system calls
    24                                  _ver 	equ 0
    25                                  _exit 	equ 1
    26                                  _fork 	equ 2
    27                                  _read 	equ 3
    28                                  _write	equ 4
    29                                  _open	equ 5
    30                                  _close 	equ 6
    31                                  _wait 	equ 7
    32                                  _create	equ 8
    33                                  _rename	equ 9
    34                                  _delete	equ 10
    35                                  _exec	equ 11
    36                                  _chdir	equ 12
    37                                  _time 	equ 13
    38                                  _mkdir 	equ 14
    39                                  _chmod	equ 15
    40                                  _rmdir	equ 16
    41                                  _break	equ 17
    42                                  _drive	equ 18
    43                                  _seek	equ 19
    44                                  _tell 	equ 20
    45                                  _memory	equ 21
    46                                  _prompt	equ 22
    47                                  _path	equ 23
    48                                  _env	equ 24
    49                                  _stime	equ 25
    50                                  _quit	equ 26
    51                                  _intr	equ 27
    52                                  _dir	equ 28
    53                                  _emt 	equ 29
    54                                  _ldrvt 	equ 30
    55                                  _video 	equ 31
    56                                  _audio	equ 32
    57                                  _timer	equ 33
    58                                  _sleep	equ 34
    59                                  _msg    equ 35
    60                                  _geterr	equ 36
    61                                  _fpstat	equ 37
    62                                  _pri	equ 38
    63                                  _rele	equ 39
    64                                  _fff	equ 40
    65                                  _fnf	equ 41
    66                                  _alloc	equ 42
    67                                  _dalloc equ 43
    68                                  _calbac equ 44
    69                                  _dma	equ 45
    70                                  
    71                                  %macro sys 1-4
    72                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)	
    73                                      ; 03/09/2015	
    74                                      ; 13/04/2015
    75                                      ; Retro UNIX 386 v1 system call.	
    76                                      %if %0 >= 2   
    77                                          mov ebx, %2
    78                                          %if %0 >= 3    
    79                                              mov ecx, %3
    80                                              %if %0 = 4
    81                                                 mov edx, %4   
    82                                              %endif
    83                                          %endif
    84                                      %endif
    85                                      mov eax, %1
    86                                      ;int 30h
    87                                      int 40h ; TRDOS 386 (TRDOS v2.0)	   
    88                                  %endmacro
    89                                  
    90                                  ; TRDOS 386 (and Retro UNIX 386 v1) system call format:
    91                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
    92                                  
    93                                  BUFFERSIZE	equ	32768	; audio buffer size 
    94                                  ENDOFFILE       equ     1	; flag for knowing end of file
    95                                  
    96                                  [BITS 32]
    97                                  
    98                                  [ORG 0] 
    99                                  
   100                                  _STARTUP:
   101                                  	; Prints the Credits Text.
   102                                  	sys	_msg, Credits, 255, 0Bh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000000 BB[EB200000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000005 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000000A BA0B000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000000F B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000014 CD40                <1>  int 40h
   103                                  
   104                                  	; clear bss
   105 00000016 B9[A1240000]            	mov	ecx, bss_end
   106 0000001B BF[15240000]            	mov	edi, bss_start
   107 00000020 29F9                    	sub	ecx, edi
   108 00000022 D1E9                    	shr	ecx, 1
   109 00000024 31C0                    	xor	eax, eax
   110 00000026 F366AB                  	rep	stosw
   111                                  
   112                                  	; Detect (& Enable) AC'97 Audio Device
   113 00000029 E89B040000              	call	DetectAC97
   114 0000002E 731B                    	jnc     short GetFileName
   115                                  
   116                                  _dev_not_ready:
   117                                  ; couldn't find the audio device!
   118                                  	sys	_msg, noDevMsg, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000030 BB[D9210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000035 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000003A BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000003F B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000044 CD40                <1>  int 40h
   119 00000046 E958040000                      jmp     Exit
   120                                  
   121                                  GetFileName:  
   122 0000004B 89E6                    	mov	esi, esp
   123 0000004D AD                      	lodsd
   124 0000004E 83F802                  	cmp	eax, 2 ; two arguments 
   125                                  	       ; (program file name & mod file name)
   126 00000051 0F825A040000            	jb	pmsg_usage ; nothing to do
   127                                  
   128 00000057 AD                      	lodsd ; program file name address 
   129 00000058 AD                      	lodsd ; mod file name address (file to be read)
   130 00000059 89C6                    	mov	esi, eax
   131 0000005B BF[41240000]            	mov	edi, wav_file_name
   132                                  ScanName:       
   133 00000060 AC                      	lodsb
   134 00000061 84C0                    	test	al, al
   135 00000063 0F8448040000            	je	pmsg_usage
   136 00000069 3C20                    	cmp	al, 20h
   137 0000006B 74F3                    	je	short ScanName	; scan start of name.
   138 0000006D AA                      	stosb
   139 0000006E B4FF                    	mov	ah, 0FFh
   140                                  a_0:	
   141 00000070 FEC4                    	inc	ah
   142                                  a_1:
   143 00000072 AC                      	lodsb
   144 00000073 AA                      	stosb
   145 00000074 3C2E                    	cmp	al, '.'
   146 00000076 74F8                    	je	short a_0	
   147 00000078 20C0                    	and	al, al
   148 0000007A 75F6                    	jnz	short a_1
   149                                  
   150 0000007C 08E4                    	or	ah, ah		; if period NOT found,
   151 0000007E 750B                    	jnz	short _1 	; then add a .WAV extension.
   152                                  SetExt:
   153 00000080 4F                      	dec	edi
   154 00000081 C7072E574156            	mov	dword [edi], '.WAV'
   155 00000087 C6470400                	mov	byte [edi+4], 0
   156                                  
   157                                  _1:
   158                                  
   159                                  ; 26/11/2023
   160                                  %if 0
   161                                  	; Allocate Audio Buffer (for user)
   162                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   163                                  	; 26/11/2023
   164                                  	sys	_audio, 0200h, [buffersize], audio_buffer
   165                                  	jnc	short _2
   166                                  error_exit:
   167                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
   168                                  	jmp	Exit
   169                                  _2:
   170                                  	; DIRECT CGA (TEXT MODE) MEMORY ACCESS
   171                                  	; bl = 0, bh = 4
   172                                  	; Direct access/map to CGA (Text) memory (0B8000h)
   173                                  
   174                                  	sys	_video, 0400h
   175                                  	cmp	eax, 0B8000h
   176                                  	jne	short error_exit
   177                                  
   178                                  	; Initialize Audio Device (bh = 3)
   179                                  	sys	_audio, 0301h, 0, audio_int_handler 
   180                                  ;	jc	short error_exit
   181                                  _3:
   182                                  
   183                                  %endif
   184 0000008B E897060000              	call	write_audio_dev_info 
   185                                  
   186                                  ; open the file
   187                                          ; open existing file
   188 00000090 E841040000                      call    openFile ; no error? ok.
   189 00000095 731B                            jnc     short _gsr
   190                                  
   191                                  ; file not found!
   192                                  	sys	_msg, noFileErrMsg, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000097 BB[04220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000009C B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000000A1 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000000A6 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000000AB CD40                <1>  int 40h
   193                                  _exit_:
   194 000000AD E9F1030000                      jmp     Exit
   195                                  
   196                                  _gsr:  
   197 000000B2 E859040000                     	call    getSampleRate		; read the sample rate
   198                                                                          ; pass it onto codec.
   199                                  	;jc	Exit
   200                                  	; 25/11/2023
   201 000000B7 72F4                    	jc	short _exit_
   202                                  
   203 000000B9 66A3[1A240000]          	mov	[sample_rate], ax
   204 000000BF 880D[18240000]          	mov	[stmo], cl
   205 000000C5 8815[19240000]          	mov	[bps], dl
   206                                  
   207                                  	; 26/11/2023
   208 000000CB C605[94240000]00        	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   209 000000D2 FEC9                    	dec	cl
   210 000000D4 7506                    	jnz	short _gsr_1 ; stereo
   211 000000D6 FE05[94240000]          	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   212                                  _gsr_1:	
   213 000000DC 80FA08                  	cmp	dl, 8 
   214 000000DF 7706                    	ja	short _gsr_2 ; 16 bit samples
   215 000000E1 FE05[94240000]          	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   216                                  _gsr_2:	
   217                                  	; 06/06/2017
   218                                  	sys	_audio, 0E00h ; get audio controller info
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000000E7 BB000E0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000000EC B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000000F1 CD40                <1>  int 40h
   219 000000F3 0F82FE020000            	jc	error_exit ; 25/11/2023
   220                                  
   221                                  	;cmp	ah, 2 ; ICH ? (Intel AC'97 Audio Controller)
   222                                  	;jne	_dev_not_ready	
   223                                  
   224                                  	; EAX = IRQ Number in AL
   225                                  	;	Audio Device Number in AH 
   226                                  	; EBX = DEV/VENDOR ID
   227                                  	;       (DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV)
   228                                  	; ECX = BUS/DEV/FN 
   229                                  	;       (00000000BBBBBBBBDDDDDFFF00000000)
   230                                  	; EDX = NABMBAR/NAMBAR (for AC97)
   231                                  	;      (Low word, DX = NAMBAR address)
   232                                  	; EDX = Base IO Addr (DX) for SB16 & VT8233
   233                                  
   234 000000F9 A2[93240000]            	mov	[ac97_int_ln_reg], al
   235 000000FE 891D[95240000]          	mov	[dev_vendor], ebx
   236 00000104 890D[99240000]          	mov	[bus_dev_fn], ecx
   237                                  	;mov	[ac97_NamBar], dx
   238                                  	;shr	dx, 16
   239                                  	;mov	[ac97_NabmBar], dx
   240 0000010A 8915[9D240000]          	mov	[ac97_NamBar], edx	
   241                                    
   242                                  	; 06/06/2024
   243                                  	;; 01/06/2024
   244                                  	;; Reset Audio Device (bh = 8)
   245                                  	;sys	_audio, 0800h
   246                                  	;;jc	error_exit	
   247                                  	;jc	short init_err
   248                                  
   249 00000110 E8F4060000              	call	write_ac97_pci_dev_info
   250                                  
   251                                  	; 01/06/2024
   252                                  	; 25/11/2023
   253                                  	; Get AC'97 Codec info
   254                                  	; (Function 14, sub function 1)
   255                                  	sys	_audio, 0E01h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000115 BB010E0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000011A B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000011F CD40                <1>  int 40h
   256                                  	; 06/06/2024
   257 00000121 7310                    	jnc	short _gsr_3
   258                                  
   259                                  	; 06/06/2024
   260                                  	; a 2nd attempt
   261                                  	sys	_audio, 0E01h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000123 BB010E0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000128 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000012D CD40                <1>  int 40h
   262 0000012F 7302                    	jnc	short _gsr_3
   263                                  
   264 00000131 D1E0                    	shl	eax, 1 ; clears AL BIT 0
   265                                  _gsr_3:
   266                                  	; Save Variable Rate Audio support bit
   267 00000133 2401                    	and	al, 1
   268 00000135 A2[24240000]            	mov	[VRA], al
   269                                  
   270                                  	; 06/06/2024
   271                                  	; ebx = codec vendor id1 & id2 (bx)
   272 0000013A E8DE080000              	call	write_codec_info
   273                                  
   274                                  	; 25/11/2023
   275 0000013F E88C080000              	call	write_VRA_info
   276                                  
   277                                  	; 01/05/2017
   278 00000144 E8F5050000              	call	write_wav_file_info
   279                                  
   280                                  	; 25/11/2023
   281                                  	; ------------------------------------------
   282                                  
   283 00000149 803D[24240000]01        	cmp	byte [VRA], 1
   284 00000150 7220                    	jb	short chk_sample_rate
   285                                  
   286                                  playwav_48_khz:	
   287                                  	;mov	dword [loadfromwavfile], loadFromFile
   288                                  	;mov	dword [buffersize], 65536
   289 00000152 E987020000              	jmp	PlayNow
   290                                  
   291                                  	; 01/06/2024
   292                                  init_err:
   293                                  	sys	_msg, msg_init_err, 255, 0Eh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000157 BB[3D220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000015C B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000161 BA0E000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000166 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000016B CD40                <1>  int 40h
   294 0000016D E931030000              	jmp	Exit
   295                                  
   296                                  chk_sample_rate:
   297                                  	; set conversion parameters
   298                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   299 00000172 66A1[1A240000]          	mov	ax, [sample_rate]
   300 00000178 663D80BB                	cmp	ax, 48000
   301 0000017C 74D4                    	je	short playwav_48_khz
   302                                  chk_22khz:
   303 0000017E 663D2256                	cmp	ax, 22050
   304 00000182 7545                    	jne	short chk_11khz
   305 00000184 803D[19240000]08        	cmp	byte [bps], 8
   306 0000018B 7615                    	jna	short chk_22khz_1
   307 0000018D BB[F8160000]            	mov	ebx, load_22khz_stereo_16_bit
   308 00000192 803D[18240000]01        	cmp	byte [stmo], 1 
   309 00000199 751A                    	jne	short chk_22khz_2
   310 0000019B BB[6B160000]            	mov	ebx, load_22khz_mono_16_bit
   311 000001A0 EB13                    	jmp	short chk_22khz_2
   312                                  chk_22khz_1:
   313 000001A2 BB[E4150000]            	mov	ebx, load_22khz_stereo_8_bit
   314 000001A7 803D[18240000]01        	cmp	byte [stmo], 1 
   315 000001AE 7505                    	jne	short chk_22khz_2
   316 000001B0 BB[5B150000]            	mov	ebx, load_22khz_mono_8_bit
   317                                  chk_22khz_2:
   318 000001B5 B85A1D0000              	mov	eax, 7514  ; (442*17)
   319 000001BA BA25000000              	mov	edx, 37
   320 000001BF B911000000              	mov	ecx, 17 
   321 000001C4 E9BA010000              	jmp	set_sizes	
   322                                  chk_11khz:
   323 000001C9 663D112B                	cmp	ax, 11025
   324 000001CD 7545                    	jne	short chk_44khz
   325 000001CF 803D[19240000]08        	cmp	byte [bps], 8
   326 000001D6 7615                    	jna	short chk_11khz_1
   327 000001D8 BB[14190000]            	mov	ebx, load_11khz_stereo_16_bit
   328 000001DD 803D[18240000]01        	cmp	byte [stmo], 1 
   329 000001E4 751A                    	jne	short chk_11khz_2
   330 000001E6 BB[9B180000]            	mov	ebx, load_11khz_mono_16_bit
   331 000001EB EB13                    	jmp	short chk_11khz_2
   332                                  chk_11khz_1:
   333 000001ED BB[21180000]            	mov	ebx, load_11khz_stereo_8_bit
   334 000001F2 803D[18240000]01        	cmp	byte [stmo], 1 
   335 000001F9 7505                    	jne	short chk_11khz_2
   336 000001FB BB[A9170000]            	mov	ebx, load_11khz_mono_8_bit
   337                                  chk_11khz_2:
   338 00000200 B8AD0E0000              	mov	eax, 3757  ; (221*17)
   339 00000205 BA4A000000              	mov	edx, 74
   340 0000020A B911000000              	mov	ecx, 17
   341 0000020F E96F010000              	jmp	set_sizes 
   342                                  chk_44khz:
   343 00000214 663D44AC                	cmp	ax, 44100
   344 00000218 7545                    	jne	short chk_16khz
   345 0000021A 803D[19240000]08        	cmp	byte [bps], 8
   346 00000221 7615                    	jna	short chk_44khz_1
   347 00000223 BB[1B1B0000]            	mov	ebx, load_44khz_stereo_16_bit
   348 00000228 803D[18240000]01        	cmp	byte [stmo], 1 
   349 0000022F 751A                    	jne	short chk_44khz_2
   350 00000231 BB[A21A0000]            	mov	ebx, load_44khz_mono_16_bit
   351 00000236 EB13                    	jmp	short chk_44khz_2
   352                                  chk_44khz_1:
   353 00000238 BB[251A0000]            	mov	ebx, load_44khz_stereo_8_bit
   354 0000023D 803D[18240000]01        	cmp	byte [stmo], 1 
   355 00000244 7505                    	jne	short chk_44khz_2
   356 00000246 BB[A9190000]            	mov	ebx, load_44khz_mono_8_bit
   357                                  chk_44khz_2:
   358 0000024B B8D93A0000              	mov	eax, 15065 ; (655*23)
   359 00000250 BA19000000              	mov	edx, 25
   360 00000255 B917000000              	mov	ecx, 23
   361 0000025A E924010000              	jmp	set_sizes 
   362                                  chk_16khz:
   363 0000025F 663D803E                	cmp	ax, 16000
   364 00000263 7545                    	jne	short chk_8khz
   365 00000265 803D[19240000]08        	cmp	byte [bps], 8
   366 0000026C 7615                    	jna	short chk_16khz_1
   367 0000026E BB[A0100000]            	mov	ebx, load_16khz_stereo_16_bit
   368 00000273 803D[18240000]01        	cmp	byte [stmo], 1 
   369 0000027A 751A                    	jne	short chk_16khz_2
   370 0000027C BB[1F100000]            	mov	ebx, load_16khz_mono_16_bit
   371 00000281 EB13                    	jmp	short chk_16khz_2
   372                                  chk_16khz_1:
   373 00000283 BB[650F0000]            	mov	ebx, load_16khz_stereo_8_bit
   374 00000288 803D[18240000]01        	cmp	byte [stmo], 1 
   375 0000028F 7505                    	jne	short chk_16khz_2
   376 00000291 BB[E60E0000]            	mov	ebx, load_16khz_mono_8_bit
   377                                  chk_16khz_2:
   378 00000296 B855150000              	mov	eax, 5461
   379 0000029B BA03000000              	mov	edx, 3
   380 000002A0 B901000000              	mov	ecx, 1
   381 000002A5 E9D9000000              	jmp	set_sizes 
   382                                  chk_8khz:
   383 000002AA 663D401F                	cmp	ax, 8000
   384 000002AE 7545                    	jne	short chk_24khz
   385 000002B0 803D[19240000]08        	cmp	byte [bps], 8
   386 000002B7 7615                    	jna	short chk_8khz_1
   387 000002B9 BB[9B0D0000]            	mov	ebx, load_8khz_stereo_16_bit
   388 000002BE 803D[18240000]01        	cmp	byte [stmo], 1 
   389 000002C5 751A                    	jne	short chk_8khz_2
   390 000002C7 BB[CB0C0000]            	mov	ebx, load_8khz_mono_16_bit
   391 000002CC EB13                    	jmp	short chk_8khz_2
   392                                  chk_8khz_1:
   393 000002CE BB[9B0B0000]            	mov	ebx, load_8khz_stereo_8_bit
   394 000002D3 803D[18240000]01        	cmp	byte [stmo], 1 
   395 000002DA 7505                    	jne	short chk_8khz_2
   396 000002DC BB[B70A0000]            	mov	ebx, load_8khz_mono_8_bit
   397                                  chk_8khz_2:
   398 000002E1 B8AA0A0000              	mov	eax, 2730
   399 000002E6 BA06000000              	mov	edx, 6
   400 000002EB B901000000              	mov	ecx, 1
   401 000002F0 E98E000000              	jmp	set_sizes 
   402                                  chk_24khz:
   403 000002F5 663DC05D                	cmp	ax, 24000
   404 000002F9 7542                    	jne	short chk_32khz
   405 000002FB 803D[19240000]08        	cmp	byte [bps], 8
   406 00000302 7615                    	jna	short chk_24khz_1
   407 00000304 BB[CA120000]            	mov	ebx, load_24khz_stereo_16_bit
   408 00000309 803D[18240000]01        	cmp	byte [stmo], 1 
   409 00000310 751A                    	jne	short chk_24khz_2
   410 00000312 BB[67120000]            	mov	ebx, load_24khz_mono_16_bit
   411 00000317 EB13                    	jmp	short chk_24khz_2
   412                                  chk_24khz_1:
   413 00000319 BB[DD110000]            	mov	ebx, load_24khz_stereo_8_bit
   414 0000031E 803D[18240000]01        	cmp	byte [stmo], 1 
   415 00000325 7505                    	jne	short chk_24khz_2
   416 00000327 BB[76110000]            	mov	ebx, load_24khz_mono_8_bit
   417                                  chk_24khz_2:
   418 0000032C B800200000              	mov	eax, 8192
   419 00000331 BA02000000              	mov	edx, 2
   420 00000336 B901000000              	mov	ecx, 1
   421 0000033B EB46                    	jmp	short set_sizes 
   422                                  chk_32khz:
   423 0000033D 663D007D                	cmp	ax, 32000
   424 00000341 7574                    	jne	short vra_needed
   425 00000343 803D[19240000]08        	cmp	byte [bps], 8
   426 0000034A 7615                    	jna	short chk_32khz_1
   427 0000034C BB[CB140000]            	mov	ebx, load_32khz_stereo_16_bit
   428 00000351 803D[18240000]01        	cmp	byte [stmo], 1 
   429 00000358 751A                    	jne	short chk_32khz_2
   430 0000035A BB[61140000]            	mov	ebx, load_32khz_mono_16_bit
   431 0000035F EB13                    	jmp	short chk_32khz_2
   432                                  chk_32khz_1:
   433 00000361 BB[C4130000]            	mov	ebx, load_32khz_stereo_8_bit
   434 00000366 803D[18240000]01        	cmp	byte [stmo], 1 
   435 0000036D 7505                    	jne	short chk_32khz_2
   436 0000036F BB[51130000]            	mov	ebx, load_32khz_mono_8_bit
   437                                  chk_32khz_2:
   438 00000374 B8AA2A0000              	mov	eax, 10922
   439 00000379 BA03000000              	mov	edx, 3
   440 0000037E B902000000              	mov	ecx, 2
   441                                  	;jmp	short set_sizes 
   442                                  set_sizes:
   443 00000383 803D[18240000]01        	cmp	byte [stmo], 1
   444 0000038A 7402                    	je	short ss_1
   445 0000038C D1E0                    	shl	eax, 1
   446                                  ss_1:
   447 0000038E 803D[19240000]08        	cmp	byte [bps], 8
   448 00000395 7602                    	jna	short ss_2
   449                                  	; 16 bit samples
   450 00000397 D1E0                    	shl	eax, 1
   451                                  ss_2:
   452 00000399 A3[D6030000]            	mov	[loadsize], eax
   453 0000039E F7E2                    	mul	edx
   454                                  	;cmp	ecx, 1
   455                                  	;je	short ss_3
   456                                  ;ss_3:
   457 000003A0 F7F1                    	div	ecx
   458 000003A2 8A0D[94240000]          	mov	cl, [fbs_shift]
   459 000003A8 D3E0                    	shl	eax, cl
   460                                  	; 26/11/2023
   461                                  	;shr	eax, 1	; buffer size is 16 bit sample count
   462 000003AA A3[DA030000]            	mov	[buffersize], eax ; buffer size in bytes 
   463 000003AF 891D[D2030000]          	mov	[loadfromwavfile], ebx
   464 000003B5 EB27                    	jmp	short PlayNow
   465                                  
   466                                  vra_needed:
   467                                  	sys	_msg, msg_no_vra, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003B7 BB[6E220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003BC B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000003C1 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000003C6 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000003CB CD40                <1>  int 40h
   468 000003CD E9D1000000              	jmp	Exit
   469                                  
   470                                  	; 26/11/2023
   471                                  	; 13/11/2023
   472                                  loadfromwavfile:
   473 000003D2 [82050000]              	dd	loadFromFile
   474                                  loadsize:	; read from wav file
   475 000003D6 00000000                	dd	0
   476                                  buffersize:	; write to DMA buffer
   477 000003DA 00000100                	dd	65536 ; bytes
   478                                  
   479                                  PlayNow: 
   480                                  
   481                                  ; 26/11/2023
   482                                  %if 1
   483                                  	; Allocate Audio Buffer (for user)
   484                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   485                                  	; 26/11/2023
   486                                  	sys	_audio, 0200h, [buffersize], audio_buffer
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003DE BB00020000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003E3 8B0D[DA030000]      <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000003E9 BA[00300000]        <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000003EE B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000003F3 CD40                <1>  int 40h
   487 000003F5 731B                    	jnc	short _2
   488                                  
   489                                  	; 26/11/2023 - temporary
   490                                  	;sys	_msg, test_1, 255, 0Ch
   491                                  
   492                                  error_exit:
   493                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003F7 BB[1D220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003FC B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000401 BA0E000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000406 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000040B CD40                <1>  int 40h
   494 0000040D E991000000              	jmp	Exit
   495                                  _2:
   496                                  	; DIRECT CGA (TEXT MODE) MEMORY ACCESS
   497                                  	; bl = 0, bh = 4
   498                                  	; Direct access/map to CGA (Text) memory (0B8000h)
   499                                  
   500                                  	sys	_video, 0400h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000412 BB00040000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000417 B81F000000          <1>  mov eax, %1
    86                              <1> 
    87 0000041C CD40                <1>  int 40h
   501 0000041E 3D00800B00              	cmp	eax, 0B8000h
   502 00000423 75D2                    	jne	short error_exit
   503                                  
   504                                  	; 01/06/2024
   505                                  	; Initialize Audio Device (bh = 3)
   506                                  	sys	_audio, 0301h, 0, audio_int_handler 
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000425 BB01030000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000042A B900000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000042F BA[6E050000]        <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000434 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000439 CD40                <1>  int 40h
   507                                  	;jc	short error_exit
   508 0000043B 0F8216FDFFFF            	jc	init_err
   509                                  _3:
   510                                  
   511                                  %endif
   512                                  
   513                                  ;
   514                                  ; position file pointer to start in actual wav data
   515                                  ; MUCH improvement should really be done here to check if sample size is
   516                                  ; supported, make sure there are 2 channels, etc.  
   517                                  ;
   518                                          ;mov     ah, 42h
   519                                          ;mov     al, 0	; from start of file
   520                                          ;mov     bx, [FileHandle]
   521                                          ;xor     cx, cx
   522                                          ;mov     dx, 44	; jump past .wav/riff header
   523                                          ;int     21h
   524                                  
   525                                  	sys	_seek, [FileHandle], 44, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000441 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000447 B92C000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000044C BA00000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000451 B813000000          <1>  mov eax, %1
    86                              <1> 
    87 00000456 CD40                <1>  int 40h
   526                                  
   527                                  	sys	_msg, nextline, 255, 07h ; 01/05/2017
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000458 BB[F3220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000045D B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000462 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000467 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000046C CD40                <1>  int 40h
   528                                  
   529                                  ; play the .wav file. Most of the good stuff is in here.
   530                                  
   531 0000046E E8C2010000                      call    PlayWav
   532                                  
   533                                  ; close the .wav file and exit.
   534                                  
   535                                  StopPlaying:
   536                                  	; Stop Playing
   537                                  	sys	_audio, 0700h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000473 BB00070000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000478 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000047D CD40                <1>  int 40h
   538                                  	; Cancel callback service (for user)
   539                                  	sys	_audio, 0900h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000047F BB00090000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000484 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000489 CD40                <1>  int 40h
   540                                  	; Deallocate Audio Buffer (for user)
   541                                  	sys	_audio, 0A00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000048B BB000A0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000490 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000495 CD40                <1>  int 40h
   542                                  	; Disable Audio Device
   543                                  	sys	_audio, 0C00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000497 BB000C0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000049C B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000004A1 CD40                <1>  int 40h
   544                                  Exit:  
   545 000004A3 E847000000                      call    closeFile
   546                                           
   547                                  	sys	_exit	; Bye!
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004A8 B801000000          <1>  mov eax, %1
    86                              <1> 
    87 000004AD CD40                <1>  int 40h
   548                                  here:
   549 000004AF EBFE                    	jmp	short here
   550                                  
   551                                  pmsg_usage:
   552                                  	sys	_msg, msg_usage, 255, 0Bh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004B1 BB[BA210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000004B6 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000004BB BA0B000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004C0 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000004C5 CD40                <1>  int 40h
   553 000004C7 EBDA                    	jmp	short Exit
   554                                  
   555                                  	; 25/11/2023
   556                                  DetectAC97:
   557                                  	; Detect (BH=1) AC'97 (BL=2) Audio Device
   558                                          sys	_audio, 0102h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004C9 BB02010000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004CE B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000004D3 CD40                <1>  int 40h
   559                                  
   560                                  ; 01/06/2024
   561                                  %if 0
   562                                  	jc	short DetectAC97_retn
   563                                  
   564                                  	; 25/11/2023
   565                                  	; Get AC'97 Codec info
   566                                  	; (Function 14, sub function 1)
   567                                  	sys	_audio, 0E01h
   568                                  	; Save Variable Rate Audio support bit
   569                                  	and	al, 1
   570                                  	mov	[VRA], al
   571                                  %endif
   572                                  
   573                                  DetectAC97_retn:
   574 000004D5 C3                      	retn
   575                                  
   576                                  ;open or create file
   577                                  ;
   578                                  ;input: ds:dx-->filename (asciiz)
   579                                  ;       al=file Mode (create or open)
   580                                  ;output: none  cs:[FileHandle] filled
   581                                  ;
   582                                  openFile:
   583                                  	;mov	ah, 3Bh	; start with a mode
   584                                  	;add	ah, al	; add in create or open mode
   585                                  	;xor	ecx, ecx
   586                                  	;int	21h
   587                                  	;jc	short _of1
   588                                  	;;mov	[cs:FileHandle], ax
   589                                  
   590                                  	sys	_open, wav_file_name, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004D6 BB[41240000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000004DB B900000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004E0 B805000000          <1>  mov eax, %1
    86                              <1> 
    87 000004E5 CD40                <1>  int 40h
   591 000004E7 7205                    	jc	short _of1
   592                                  
   593 000004E9 A3[E7200000]            	mov	[FileHandle], eax
   594                                  _of1:
   595 000004EE C3                      	retn
   596                                  
   597                                  ; close the currently open file
   598                                  ; input: none, uses cs:[FileHandle]
   599                                  closeFile:
   600 000004EF 833D[E7200000]FF        	cmp	dword [FileHandle], -1
   601 000004F6 7417                    	je	short _cf1
   602                                  	;mov    bx, [FileHandle]  
   603                                  	;mov    ax, 3E00h
   604                                          ;int    21h              ;close file
   605                                  
   606                                  	sys	_close, [FileHandle]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004F8 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004FE B806000000          <1>  mov eax, %1
    86                              <1> 
    87 00000503 CD40                <1>  int 40h
   607 00000505 C705[E7200000]FFFF-     	mov 	dword [FileHandle], -1
   607 0000050D FFFF               
   608                                  _cf1:
   609 0000050F C3                      	retn
   610                                  
   611                                  getSampleRate:
   612                                  	
   613                                  ; reads the sample rate from the .wav file.
   614                                  ; entry: none - assumes file is already open
   615                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   616                                  ;	cx = number of channels (mono=1, stereo=2)
   617                                  ;	dx = bits per sample (8, 16)
   618                                  
   619 00000510 53                      	push    ebx
   620                                  
   621                                          ;mov	ah, 42h
   622                                          ;mov	al, 0	; from start of file
   623                                          ;mov	bx, [FileHandle]
   624                                          ;xor	ecx, ecx
   625                                          ;mov	dx, 08h	; "WAVE"
   626                                          ;int	21h
   627                                  	
   628                                  	sys	_seek, [FileHandle], 8, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000511 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000517 B908000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000051C BA00000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000521 B813000000          <1>  mov eax, %1
    86                              <1> 
    87 00000526 CD40                <1>  int 40h
   629                                  
   630                                          ;mov	dx, smpRBuff
   631                                          ;mov	cx, 28	; 28 bytes
   632                                  	;mov	ah, 3fh
   633                                          ;int	21h
   634                                  
   635                                  	sys	_read, [FileHandle], smpRBuff, 28
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000528 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000052E B9[25240000]        <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000533 BA1C000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000538 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000053D CD40                <1>  int 40h
   636                                  
   637 0000053F 813D[25240000]5741-     	cmp	dword [smpRBuff], 'WAVE'
   637 00000547 5645               
   638 00000549 7520                    	jne	short gsr_stc
   639                                  
   640 0000054B 66833D[31240000]01      	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   641 00000553 7516                    	jne	short gsr_stc
   642                                  
   643 00000555 668B0D[33240000]        	mov	cx, [smpRBuff+14]	; return num of channels in CX
   644 0000055C 66A1[35240000]                  mov     ax, [smpRBuff+16]	; return sample rate in AX
   645 00000562 668B15[3F240000]        	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   646                                  gsr_retn:
   647 00000569 5B                              pop     ebx
   648 0000056A C3                              retn
   649                                  gsr_stc:
   650 0000056B F9                      	stc
   651 0000056C EBFB                    	jmp	short gsr_retn
   652                                  
   653                                  audio_int_handler:
   654                                  	; 13/12/2024
   655                                  	; 18/08/2020 (14/10/2020, 'wavplay2.s')
   656                                  
   657                                  	;mov	byte [srb], 1 ; interrupt (or signal response byte)
   658                                  	
   659                                  	;cmp	byte [cbs_busy], 1
   660                                  	;jnb	short _callback_bsy_retn
   661                                  	
   662                                  	;mov	byte [cbs_busy], 1
   663                                  
   664                                  	; 13/12/2024
   665                                  	;mov	al, [half_buff]
   666                                  	;
   667                                  	;cmp	al, 1
   668                                  	;jb	short _callback_retn
   669                                  
   670                                  	; 18/08/2020
   671                                  	;mov	byte [srb], 1
   672                                  	; 13/12/2024
   673 0000056E FE05[22240000]          	inc	byte [srb]
   674                                  
   675                                  	; 13/12/2024
   676                                  	;xor	byte [half_buff], 3 ; 2->1, 1->2
   677                                  
   678                                  	; 13/12/2024
   679                                  	;add	al, '0'
   680                                  ;tL0:	; 26/11/2023
   681                                  	;mov	ah, 4Eh
   682                                  	;mov	ebx, 0B8000h ; video display page address
   683                                  	;mov	[ebx], ax ; show playing buffer (1, 2)
   684                                  ;_callback_retn:
   685                                  	;;mov	byte [cbs_busy], 0
   686                                  ;_callback_bsy_retn:
   687                                  	sys	_rele ; return from callback service 
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000574 B827000000          <1>  mov eax, %1
    86                              <1> 
    87 00000579 CD40                <1>  int 40h
   688                                  	; we must not come here !
   689                                  	sys	_exit
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000057B B801000000          <1>  mov eax, %1
    86                              <1> 
    87 00000580 CD40                <1>  int 40h
   690                                  	
   691                                  loadFromFile:
   692                                  	; 26/11/2023
   693 00000582 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
   694                                  					; last of the file?
   695 00000589 7402                    	jz	short lff_0		; no
   696 0000058B F9                      	stc
   697 0000058C C3                      	retn
   698                                  lff_0:
   699                                  	; 13/06/2017
   700                                  	;mov	edx, BUFFERSIZE
   701                                  	; 26/11/2023
   702 0000058D BF[00300000]            	mov	edi, audio_buffer
   703 00000592 8B15[DA030000]          	mov	edx, [buffersize]	; bytes
   704 00000598 8A0D[94240000]          	mov	cl, [fbs_shift]   
   705 0000059E 20C9                    	and	cl, cl
   706 000005A0 7409                    	jz	short lff_1 ; stereo, 16 bit
   707                                  
   708                                  	; fbs_shift =
   709                                  	;	2 for mono and 8 bit sample (multiplier = 4)
   710                                  	;	1 for mono or 8 bit sample (multiplier = 2)
   711 000005A2 D3EA                    	shr	edx, cl
   712                                  	;inc	edx
   713                                  
   714 000005A4 BE[00300100]            	mov     esi, temp_buffer
   715 000005A9 EB02                    	jmp	short lff_2
   716                                  lff_1:
   717                                  	;mov	esi, audio_buffer
   718 000005AB 89FE                    	mov	esi, edi ; audio_buffer
   719                                  lff_2:
   720                                  	; 17/03/2017
   721                                  	; esi = buffer address
   722                                  	; edx = buffer size
   723                                   
   724                                  	; 26/11/2023
   725                                  	; load file into memory
   726                                  	sys 	_read, [FileHandle], esi
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000005AD 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000005B3 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000005B5 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000005BA CD40                <1>  int 40h
   727                                  	; 14/12/2024
   728 000005BC 8B0D[DA030000]          	mov	ecx, [buffersize]
   729                                  	;jc	short padfill ; error !
   730                                  	; 14/12/2024
   731 000005C2 7255                    	jc	short lff_10
   732                                  
   733 000005C4 21C0                    	and	eax, eax
   734 000005C6 7453                    	jz	short padfill
   735                                  lff_3:
   736                                  	; 26/11/2023
   737 000005C8 8A1D[94240000]          	mov	bl, [fbs_shift]
   738 000005CE 20DB                    	and	bl, bl
   739 000005D0 7456                    	jz	short lff_11
   740                                  
   741                                  	; 14/12/2024
   742                                  	;sub	ecx, eax
   743                                  	;mov	ebp, ecx
   744                                  	; 14/12/2024
   745 000005D2 29C2                    	sub	edx, eax
   746                                  
   747                                  	;mov	esi, temp_buffer
   748                                  	;mov	edi, audio_buffer
   749 000005D4 89C1                    	mov	ecx, eax   ; byte count
   750                                  
   751 000005D6 803D[19240000]08        	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   752 000005DD 751E                    	jne	short lff_6 ; 16 bit samples
   753                                  	; 8 bit samples
   754 000005DF FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
   755 000005E1 740E                    	jz	short lff_5 ; 8 bit, stereo
   756                                  lff_4:
   757                                  	; mono & 8 bit
   758 000005E3 AC                      	lodsb
   759 000005E4 2C80                    	sub	al, 80h ; 08/11/2023
   760 000005E6 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   761 000005E9 66AB                    	stosw	; left channel
   762 000005EB 66AB                    	stosw	; right channel
   763 000005ED E2F4                    	loop	lff_4
   764 000005EF EB16                    	jmp	short lff_8
   765                                  lff_5:
   766                                  	; stereo & 8 bit
   767 000005F1 AC                      	lodsb
   768 000005F2 2C80                    	sub	al, 80h ; 08/11/2023
   769 000005F4 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   770 000005F7 66AB                    	stosw
   771 000005F9 E2F6                    	loop	lff_5			
   772 000005FB EB0A                    	jmp	short lff_8
   773                                  lff_6:
   774 000005FD D1E9                    	shr	ecx, 1 ; word count
   775                                  lff_7:
   776 000005FF 66AD                    	lodsw
   777 00000601 66AB                    	stosw	; left channel
   778 00000603 66AB                    	stosw	; right channel
   779 00000605 E2F8                    	loop	lff_7
   780                                  lff_8:
   781                                  	; 27/11/2023
   782 00000607 F8                      	clc
   783                                  	; 14/12/2024
   784                                  	;mov	ecx, ebp
   785                                  	;jecxz	endLFF_retn
   786 00000608 09D2                    	or	edx, edx
   787 0000060A 741B                    	jz	short endLFF_retn
   788                                  	
   789                                  	; 14/12/2024
   790 0000060C B9[00300000]            	mov	ecx, audio_buffer
   791 00000611 030D[DA030000]          	add	ecx, [buffersize]
   792 00000617 29F9                    	sub	ecx, edi
   793                                  
   794                                  	; 14/12/2024
   795                                  lff_10:
   796 00000619 31C0                    	xor	eax, eax ; silence
   797                                  padfill:
   798 0000061B D1E9                    	shr	ecx, 1 
   799 0000061D F366AB                  	rep	stosw
   800                                  lff_9:
   801 00000620 800D[20240000]01                or	byte [flags], ENDOFFILE	; end of file flag
   802                                  endLFF_retn:
   803 00000627 C3                              retn
   804                                  
   805                                  lff_11:
   806                                  	; 16 bit stereo
   807                                  	; ecx = buffer size
   808                                  	; eax = read count
   809 00000628 29C1                    	sub	ecx, eax
   810 0000062A 76FB                    	jna	short endLFF_retn
   811 0000062C 01C7                    	add	edi, eax  ; audio_buffer + eax
   812 0000062E EBE9                    	jmp	short lff_10 ; padfill
   813                                  
   814                                  error_exit_2:
   815                                  	; 26/11/2023 - temporary
   816                                  	;sys	_msg, test_2, 255, 0Ch
   817                                  
   818 00000630 E9C2FDFFFF              	jmp	error_exit
   819                                  	
   820                                  	; 26/11/2023 - temporary
   821                                  ;test_1:
   822                                  ;	db 13, 10, 'Test 1', 13,10, 0
   823                                  ;test_2:
   824                                  ;	db 13, 10, 'Test 2', 13,10, 0
   825                                  	
   826                                  PlayWav:
   827                                  	; 26/11/2023
   828                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   829                                  	; 13/06/2017
   830                                  	; Convert 8 bit samples to 16 bit samples
   831                                  	; and convert mono samples to stereo samples
   832                                  
   833                                  	; 26/11/2023
   834                                  	; load 32768 bytes into audio buffer
   835                                  	;mov	edi, audio_buffer
   836                                  	;;mov	edx, BUFFERSIZE
   837                                  	; 26/11/2023
   838                                  	;mov	edx, [buffersize]
   839                                  	;call	loadFromFile
   840                                  	; 26/11/2023
   841 00000635 FF15[D2030000]          	call	dword [loadfromwavfile]
   842 0000063B 72F3                    	jc	short error_exit_2
   843 0000063D C605[21240000]01        	mov	byte [half_buff], 1 ; (DMA) Buffer 1
   844                                  
   845                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   846 00000644 F605[20240000]01        	test    byte [flags], ENDOFFILE  ; end of file
   847 0000064B 7512                    	jnz	short _6 ; yes
   848                                  			 ; bypass filling dma half buffer 2
   849                                  
   850                                  	; bh = 16 : update (current, first) dma half buffer
   851                                  	; bl = 0  : then switch to the next (second) half buffer
   852                                  	sys	_audio, 1000h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000064D BB00100000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000652 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000657 CD40                <1>  int 40h
   853                                  
   854                                  	; 18/08/2020
   855                                  	; [audio_flag] = 1 (in TRDOS 386 kernel)
   856                                  
   857                                  	; audio_buffer must be filled again after above system call 
   858                                  	; (Because audio interrupt will be generated by AC97 hardware
   859                                  	; at the end of the first half of dma buffer.. so, 
   860                                  	; the second half must be ready. 'sound_play' will use it.)
   861                                  
   862                                  	; 26/11/2023
   863                                  	;mov	edi, audio_buffer
   864                                  	;;mov	edx, BUFFERSIZE
   865                                  	; 26/11/2023
   866                                  	;mov	edx, [buffersize]
   867                                  	;call	loadFromFile
   868                                  	; 26/11/2023
   869 00000659 FF15[D2030000]          	call	dword [loadfromwavfile]
   870                                  	;jc	short p_return
   871                                  _6:
   872                                  	; Set Master Volume Level (BL=0 or 80h)
   873                                  	; 	for next playing (BL>=80h)
   874                                  	;sys	_audio, 0B80h, 1D1Dh
   875                                  	sys	_audio, 0B00h, 1D1Dh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000065F BB000B0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000664 B91D1D0000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000669 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000066E CD40                <1>  int 40h
   876                                  
   877                                  	; 18/08/2020
   878                                  	;mov	byte [volume_level], 1Dh
   879 00000670 880D[23240000]          	mov	[volume_level], cl
   880                                  
   881                                  	; Start	to play
   882 00000676 A0[19240000]            	mov	al, [bps]
   883 0000067B C0E804                  	shr	al, 4 ; 8 -> 0, 16 -> 1
   884 0000067E D0E0                    	shl	al, 1 ; 16 -> 2, 8 -> 0
   885 00000680 8A1D[18240000]          	mov	bl, [stmo]
   886 00000686 FECB                    	dec	bl
   887 00000688 08C3                    	or	bl, al
   888 0000068A 668B0D[1A240000]        	mov	cx, [sample_rate] 
   889 00000691 B704                    	mov	bh, 4 ; start to play
   890                                  	sys	_audio
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000693 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000698 CD40                <1>  int 40h
   891                                  
   892                                  	;mov	ebx, 0B8000h ; video display page address
   893                                  	;mov	ah, 4Eh
   894                                  	;mov	al, [half_buffer]
   895                                  	;mov	[ebx], ax ; show playing buffer (1, 2)
   896                                  
   897                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   898                                  	; Here..
   899                                  	; If byte [flags] <> ENDOFFILE ...
   900                                  	; user's audio_buffer has been copied to dma half buffer 2
   901                                  
   902                                  	; [audio_flag] = 0 (in TRDOS 386 kernel)
   903                                  
   904                                  	; audio_buffer must be filled again after above system call 
   905                                  	; (Because, audio interrupt will be generated by VT8237R
   906                                  	; at the end of the first half of dma buffer.. so, 
   907                                  	; the 2nd half of dma buffer is ready but the 1st half
   908                                  	; must be filled again.)
   909                                  
   910                                  ; 14/12/2024
   911                                  %if 0
   912                                  	; 18/08/2020
   913                                  	test    byte [flags], ENDOFFILE  ; end of file
   914                                  	jnz	short p_loop ; yes
   915                                  
   916                                  	; 18/08/2020
   917                                  	; load 32768 bytes into audio buffer
   918                                  	;; (for the second half of DMA buffer)
   919                                  	; 27/11/2023
   920                                  	; 20/05/2017
   921                                  	;mov	edi, audio_buffer
   922                                  	;mov	edx, BUFFERSIZE
   923                                  	; 26/11/2023
   924                                  	;mov	edx, [buffersize]
   925                                  	;call	loadFromFile
   926                                  	; 26/11/2023
   927                                  	call	dword [loadfromwavfile]
   928                                  	;jc	short p_return
   929                                  	;mov	byte [half_buff], 2 ; (DMA) Buffer 2
   930                                  %endif
   931                                  
   932                                  	; we need to wait for 'SRB' (audio interrupt)
   933                                  	; (we can not return from 'PlayWav' here 
   934                                  	;  even if we have got an error from file reading)
   935                                  	; ((!!current audio data must be played!!))
   936                                  
   937                                  	; 18/08/2020
   938                                  	;mov	byte [srb], 1
   939                                  
   940                                  p_loop:
   941                                  	;mov	ah, 1		; any key pressed?
   942                                  	;int	32h		; no, Loop.
   943                                  	;jz	short q_loop
   944                                  	;
   945                                  	;mov	ah, 0		; flush key buffer...
   946                                  	;int	32h
   947                                  
   948                                  	; 18/08/2020 (14/10/2017, 'wavplay2.s')
   949 0000069A 803D[22240000]00        	cmp	byte [srb], 0
   950 000006A1 7627                    	jna	short q_loop
   951 000006A3 C605[22240000]00        	mov	byte [srb], 0
   952                                  	; 13/12/2024
   953 000006AA 8035[21240000]03        	xor	byte [half_buff], 3 ; 2->1, 1->2
   954                                  
   955                                  	; 27/11/2023
   956                                  	;mov	edi, audio_buffer
   957                                  	;mov	edx, BUFFERSIZE
   958                                  	; 26/11/2023
   959                                  	;mov	edx, [buffersize]
   960                                  	;call	loadFromFile
   961                                  	; 26/11/2023
   962 000006B1 FF15[D2030000]          	call	dword [loadfromwavfile]
   963 000006B7 7223                    	jc	short p_return
   964                                  
   965                                  	; 14/12/2024
   966                                  	;;;
   967                                  	; bh = 16 : update (current, first) dma half buffer
   968                                  	; bl = 0  : then switch to the other half buffer
   969                                  	sys	_audio, 1000h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000006B9 BB00100000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000006BE B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000006C3 CD40                <1>  int 40h
   970                                  	;;;;
   971                                  
   972                                  	; 13/12/2024
   973 000006C5 E819000000              	call	tL0
   974                                  q_loop:
   975 000006CA B401                    	mov     ah, 1		; any key pressed?
   976 000006CC CD32                    	int     32h		; no, Loop.
   977 000006CE 74CA                    	jz	short p_loop
   978                                  
   979 000006D0 B400                    	mov     ah, 0		; flush key buffer...
   980 000006D2 CD32                    	int     32h
   981                                  	
   982 000006D4 3C2B                    	cmp	al, '+' ; increase sound volume
   983 000006D6 741D                    	je	short inc_volume_level
   984 000006D8 3C2D                    	cmp	al, '-'
   985 000006DA 743C                    	je	short dec_volume_level
   986                                  
   987                                  p_return:
   988 000006DC C605[21240000]00        	mov	byte [half_buff], 0
   989                                  	; 13/12/2024
   990                                  	;call	tL0
   991                                  	;retn
   992                                  
   993                                  	; 13/12/2024
   994                                  tL0:
   995 000006E3 A0[21240000]            	mov	al, [half_buff]
   996 000006E8 0430                    	add	al, '0'
   997 000006EA B44E                    	mov	ah, 4Eh
   998 000006EC BB00800B00              	mov	ebx, 0B8000h	; video display page address
   999 000006F1 668903                  	mov	[ebx], ax	; show playing buffer (1, 2)
  1000 000006F4 C3                      	retn
  1001                                  
  1002                                  	; 18/08/2020 (14/10/2017, 'wavplay2.s')
  1003                                  inc_volume_level:
  1004 000006F5 8A0D[23240000]          	mov	cl, [volume_level]
  1005 000006FB 80F91F                  	cmp	cl, 1Fh ; 31
  1006 000006FE 73CA                    	jnb	short q_loop
  1007 00000700 FEC1                    	inc	cl
  1008                                  change_volume_level:
  1009 00000702 880D[23240000]          	mov	[volume_level], cl
  1010 00000708 88CD                    	mov	ch, cl
  1011                                  	; Set Master Volume Level
  1012                                  	sys	_audio, 0B00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000070A BB000B0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000070F B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000714 CD40                <1>  int 40h
  1013 00000716 EB82                    	jmp	short p_loop
  1014                                  dec_volume_level:
  1015 00000718 8A0D[23240000]          	mov	cl, [volume_level]
  1016 0000071E 80F901                  	cmp	cl, 1 ; 1
  1017                                  	;jna	short p_loop
  1018                                  	; 14/12/2024
  1019 00000721 76A7                    	jna	short q_loop
  1020 00000723 FEC9                    	dec	cl
  1021 00000725 EBDB                    	jmp	short change_volume_level
  1022                                  
  1023                                  write_audio_dev_info:
  1024                                  	; EBX = Message address
  1025                                  	; ECX = Max. message length (or stop on ZERO character)
  1026                                  	;	(1 to 255)
  1027                                  	; DL  = Message color (07h = light gray, 0Fh = white) 
  1028                                       	sys 	_msg, msgAudioCardInfo, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000727 BB[91210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000072C B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000731 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000736 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000073B CD40                <1>  int 40h
  1029 0000073D C3                      	retn
  1030                                  
  1031                                  write_wav_file_info:
  1032                                  	; 01/05/2017
  1033                                  	sys	_msg, msgWavFileName, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000073E BB[A7220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000743 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000748 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000074D B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000752 CD40                <1>  int 40h
  1034                                  	sys	_msg, wav_file_name, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000754 BB[41240000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000759 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000075E BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000763 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000768 CD40                <1>  int 40h
  1035                                  
  1036                                  write_sample_rate:
  1037                                  	; 01/05/2017
  1038 0000076A 66A1[1A240000]          	mov	ax, [sample_rate]
  1039                                  	; ax = sample rate (hertz)
  1040 00000770 31D2                    	xor	edx, edx
  1041 00000772 66B90A00                	mov	cx, 10
  1042 00000776 66F7F1                  	div	cx
  1043 00000779 0015[CC220000]          	add	[msgHertz+4], dl
  1044 0000077F 29D2                    	sub	edx, edx
  1045 00000781 66F7F1                  	div	cx
  1046 00000784 0015[CB220000]          	add	[msgHertz+3], dl
  1047 0000078A 29D2                    	sub	edx, edx
  1048 0000078C 66F7F1                  	div	cx
  1049 0000078F 0015[CA220000]          	add	[msgHertz+2], dl
  1050 00000795 29D2                    	sub	edx, edx
  1051 00000797 66F7F1                  	div	cx
  1052 0000079A 0015[C9220000]          	add	[msgHertz+1], dl
  1053 000007A0 0005[C8220000]          	add	[msgHertz], al
  1054                                  	
  1055                                  	sys	_msg, msgSampleRate, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000007A6 BB[B9220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007AB B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000007B0 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000007B5 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000007BA CD40                <1>  int 40h
  1056                                  
  1057 000007BC BE[E3220000]            	mov	esi, msg16Bits
  1058 000007C1 803D[19240000]10        	cmp	byte [bps], 16
  1059 000007C8 7405                    	je	short wsr_1
  1060 000007CA BE[D3220000]            	mov	esi, msg8Bits
  1061                                  wsr_1:
  1062                                  	sys	_msg, esi, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000007CF 89F3                <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007D1 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000007D6 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000007DB B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000007E0 CD40                <1>  int 40h
  1063                                  
  1064 000007E2 BE[DC220000]            	mov	esi, msgMono
  1065 000007E7 803D[18240000]01        	cmp	byte [stmo], 1
  1066 000007EE 7405                    	je	short wsr_2
  1067 000007F0 BE[ED220000]            	mov	esi, msgStereo		
  1068                                  wsr_2:
  1069                                  	sys	_msg, esi, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000007F5 89F3                <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007F7 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000007FC BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000801 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000806 CD40                <1>  int 40h
  1070 00000808 C3                              retn
  1071                                  
  1072                                  write_ac97_pci_dev_info:
  1073                                  	; 06/06/2017
  1074                                  	; 03/06/2017
  1075                                  	; BUS/DEV/FN
  1076                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1077                                  	; DEV/VENDOR
  1078                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1079                                  
  1080 00000809 8B35[95240000]          	mov	esi, [dev_vendor]
  1081 0000080F 89F0                    	mov	eax, esi
  1082 00000811 0FB6D8                  	movzx	ebx, al
  1083 00000814 88DA                    	mov	dl, bl
  1084 00000816 80E30F                  	and	bl, 0Fh
  1085 00000819 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1086 0000081F A2[3B230000]            	mov	[msgVendorId+3], al
  1087 00000824 88D3                    	mov	bl, dl
  1088 00000826 C0EB04                  	shr	bl, 4
  1089 00000829 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1090 0000082F A2[3A230000]            	mov	[msgVendorId+2], al
  1091 00000834 88E3                    	mov	bl, ah
  1092 00000836 88DA                    	mov	dl, bl
  1093 00000838 80E30F                  	and	bl, 0Fh
  1094 0000083B 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1095 00000841 A2[39230000]            	mov	[msgVendorId+1], al
  1096 00000846 88D3                    	mov	bl, dl
  1097 00000848 C0EB04                  	shr	bl, 4
  1098 0000084B 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1099 00000851 A2[38230000]            	mov	[msgVendorId], al
  1100 00000856 C1E810                  	shr	eax, 16
  1101 00000859 88C3                    	mov	bl, al
  1102 0000085B 88DA                    	mov	dl, bl
  1103 0000085D 80E30F                  	and	bl, 0Fh
  1104 00000860 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1105 00000866 A2[4C230000]            	mov	[msgDevId+3], al
  1106 0000086B 88D3                    	mov	bl, dl
  1107 0000086D C0EB04                  	shr	bl, 4
  1108 00000870 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1109 00000876 A2[4B230000]            	mov	[msgDevId+2], al
  1110 0000087B 88E3                    	mov	bl, ah
  1111 0000087D 88DA                    	mov	dl, bl
  1112 0000087F 80E30F                  	and	bl, 0Fh
  1113 00000882 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1114 00000888 A2[4A230000]            	mov	[msgDevId+1], al
  1115 0000088D 88D3                    	mov	bl, dl
  1116 0000088F C0EB04                  	shr	bl, 4
  1117 00000892 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1118 00000898 A2[49230000]            	mov	[msgDevId], al
  1119                                  
  1120 0000089D 8B35[99240000]          	mov	esi, [bus_dev_fn]
  1121 000008A3 C1EE08                  	shr	esi, 8
  1122 000008A6 6689F0                  	mov	ax, si
  1123 000008A9 88C3                    	mov	bl, al
  1124 000008AB 88DA                    	mov	dl, bl
  1125 000008AD 80E307                  	and	bl, 7 ; bit 0,1,2
  1126 000008B0 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1127 000008B6 A2[70230000]            	mov	[msgFncNo+1], al
  1128 000008BB 88D3                    	mov	bl, dl
  1129 000008BD C0EB03                  	shr	bl, 3
  1130 000008C0 88DA                    	mov	dl, bl
  1131 000008C2 80E30F                  	and	bl, 0Fh
  1132 000008C5 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1133 000008CB A2[62230000]            	mov	[msgDevNo+1], al
  1134 000008D0 88D3                    	mov	bl, dl
  1135 000008D2 C0EB04                  	shr	bl, 4
  1136 000008D5 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1137 000008DB A2[61230000]            	mov	[msgDevNo], al
  1138 000008E0 88E3                    	mov	bl, ah
  1139 000008E2 88DA                    	mov	dl, bl
  1140 000008E4 80E30F                  	and	bl, 0Fh
  1141 000008E7 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1142 000008ED A2[56230000]            	mov	[msgBusNo+1], al
  1143 000008F2 88D3                    	mov	bl, dl
  1144 000008F4 C0EB04                  	shr	bl, 4
  1145 000008F7 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1146 000008FD A2[55230000]            	mov	[msgBusNo], al
  1147                                  
  1148 00000902 66A1[9D240000]          	mov	ax, [ac97_NamBar]
  1149 00000908 88C3                    	mov	bl, al
  1150 0000090A 88DA                    	mov	dl, bl
  1151 0000090C 80E30F                  	and	bl, 0Fh
  1152 0000090F 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1153 00000915 A2[7F230000]            	mov	[msgNamBar+3], al
  1154 0000091A 88D3                    	mov	bl, dl
  1155 0000091C C0EB04                  	shr	bl, 4
  1156 0000091F 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1157 00000925 A2[7E230000]            	mov	[msgNamBar+2], al
  1158 0000092A 88E3                    	mov	bl, ah
  1159 0000092C 88DA                    	mov	dl, bl
  1160 0000092E 80E30F                  	and	bl, 0Fh
  1161 00000931 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1162 00000937 A2[7D230000]            	mov	[msgNamBar+1], al
  1163 0000093C 88D3                    	mov	bl, dl
  1164 0000093E C0EB04                  	shr	bl, 4
  1165 00000941 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1166 00000947 A2[7C230000]            	mov	[msgNamBar], al
  1167                                  
  1168 0000094C 66A1[9F240000]          	mov	ax, [ac97_NabmBar]
  1169 00000952 88C3                    	mov	bl, al
  1170 00000954 88DA                    	mov	dl, bl
  1171 00000956 80E30F                  	and	bl, 0Fh
  1172 00000959 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1173 0000095F A2[8F230000]            	mov	[msgNabmBar+3], al
  1174 00000964 88D3                    	mov	bl, dl
  1175 00000966 C0EB04                  	shr	bl, 4
  1176 00000969 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1177 0000096F A2[8E230000]            	mov	[msgNabmBar+2], al
  1178 00000974 88E3                    	mov	bl, ah
  1179 00000976 88DA                    	mov	dl, bl
  1180 00000978 80E30F                  	and	bl, 0Fh
  1181 0000097B 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1182 00000981 A2[8D230000]            	mov	[msgNabmBar+1], al
  1183 00000986 88D3                    	mov	bl, dl
  1184 00000988 C0EB04                  	shr	bl, 4
  1185 0000098B 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1186 00000991 A2[8C230000]            	mov	[msgNabmBar], al
  1187                                  
  1188 00000996 30E4                    	xor	ah, ah
  1189 00000998 A0[93240000]            	mov	al, [ac97_int_ln_reg]
  1190 0000099D B10A                    	mov	cl, 10
  1191 0000099F F6F1                    	div	cl
  1192 000009A1 660105[98230000]        	add	[msgIRQ], ax
  1193 000009A8 20C0                    	and	al, al
  1194 000009AA 750D                    	jnz	short _w_ac97imsg_
  1195 000009AC A0[99230000]            	mov	al, [msgIRQ+1]
  1196 000009B1 B420                    	mov	ah, ' '
  1197 000009B3 66A3[98230000]          	mov	[msgIRQ], ax
  1198                                  _w_ac97imsg_:
  1199                                  	sys	_msg, msgAC97Info, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009B9 BB[07230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009BE B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009C3 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000009C8 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000009CD CD40                <1>  int 40h
  1200                                  
  1201 000009CF C3                              retn
  1202                                  
  1203                                  write_VRA_info:
  1204                                  	; 25/11/2023
  1205                                  	sys	_msg, msgVRAheader, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009D0 BB[D0230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009D5 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009DA BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000009DF B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000009E4 CD40                <1>  int 40h
  1206 000009E6 803D[24240000]00        	cmp	byte [VRA], 0
  1207 000009ED 7617                    	jna	short _w_VRAi_no
  1208                                  _w_VRAi_yes:
  1209                                  	sys	_msg, msgVRAyes, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009EF BB[DE230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009F4 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009F9 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000009FE B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000A03 CD40                <1>  int 40h
  1210 00000A05 C3                      	retn
  1211                                  _w_VRAi_no:
  1212                                  	sys	_msg, msgVRAno, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000A06 BB[E4230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000A0B B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000A10 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000A15 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000A1A CD40                <1>  int 40h
  1213 00000A1C C3                      	retn
  1214                                  
  1215                                  	; 06/06/2024
  1216                                  write_codec_info:
  1217 00000A1D 89DA                    	mov	edx, ebx
  1218 00000A1F 83E30F                  	and	ebx, 0Fh
  1219 00000A22 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1220 00000A28 A2[C9230000]            	mov	[msgCodecId2+3], al
  1221 00000A2D 88D3                    	mov	bl, dl
  1222 00000A2F C0EB04                  	shr	bl, 4
  1223 00000A32 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1224 00000A38 A2[C8230000]            	mov	[msgCodecId2+2], al
  1225 00000A3D 88F3                    	mov	bl, dh
  1226 00000A3F 80E30F                  	and	bl, 0Fh
  1227 00000A42 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1228 00000A48 A2[C7230000]            	mov	[msgCodecId2+1], al
  1229 00000A4D 88F3                    	mov	bl, dh
  1230 00000A4F C0EB04                  	shr	bl, 4
  1231 00000A52 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1232 00000A58 A2[C6230000]            	mov	[msgCodecId2], al
  1233 00000A5D C1EA10                  	shr	edx, 16
  1234 00000A60 88D3                    	mov	bl, dl
  1235 00000A62 80E30F                  	and	bl, 0Fh
  1236 00000A65 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1237 00000A6B A2[B6230000]            	mov	[msgCodecId1+3], al
  1238 00000A70 88D3                    	mov	bl, dl
  1239 00000A72 C0EB04                  	shr	bl, 4
  1240 00000A75 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1241 00000A7B A2[B5230000]            	mov	[msgCodecId1+2], al
  1242 00000A80 88F3                    	mov	bl, dh
  1243 00000A82 80E30F                  	and	bl, 0Fh
  1244 00000A85 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1245 00000A8B A2[B4230000]            	mov	[msgCodecId1+1], al
  1246 00000A90 88F3                    	mov	bl, dh
  1247 00000A92 C0EB04                  	shr	bl, 4
  1248 00000A95 8A83[F6220000]          	mov	al, [ebx+hex_chars]
  1249 00000A9B A2[B3230000]            	mov	[msgCodecId1], al
  1250                                  	;
  1251                                  	sys	_msg, msgCodec, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000AA0 BB[9D230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000AA5 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000AAA BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000AAF B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000AB4 CD40                <1>  int 40h
  1252 00000AB6 C3                      	retn
  1253                                  
  1254                                  ; 26/11/2023
  1255                                  ; 25/11/2023 - playwav6.s (32 bit registers, TRDOS 386 adaption)
  1256                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  1257                                  ; 14/11/2023
  1258                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1259                                  ; --------------------------------------------------------
  1260                                  
  1261                                  ;;Note:	At the end of every buffer load,
  1262                                  ;;	during buffer switch/swap, there will be discontinuity
  1263                                  ;;	between the last converted sample and the 1st sample
  1264                                  ;;	of the next buffer.
  1265                                  ;;	(like as a dot noises vaguely between normal sound samples)
  1266                                  ;;	-To avoid this defect, the 1st sample of
  1267                                  ;;	the next buffer may be read from the wav file but
  1268                                  ;;	the file pointer would need to be set to 1 sample back
  1269                                  ;;	again via seek system call. Time comsumption problem! -
  1270                                  ;;
  1271                                  ;;	Erdogan Tan - 15/11/2023
  1272                                  ;;
  1273                                  ;;	((If entire wav data would be loaded at once.. conversion
  1274                                  ;;	defect/noise would disappear.. but for DOS, to keep
  1275                                  ;;	64KB buffer limit is important also it is important
  1276                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1277                                  ;;	I have tested this program by using 2-30MB wav files.))
  1278                                  ;;
  1279                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1280                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1281                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1282                                  ;;			Realtek ALC850 codec.
  1283                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1284                                  
  1285                                  load_8khz_mono_8_bit:
  1286                                  	; 15/11/2023
  1287                                  	; 14/11/2023
  1288                                  	; 13/11/2023
  1289 00000AB7 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1290                                  					; last of the file?
  1291 00000ABE 7402                    	jz	short lff8m_0		; no
  1292 00000AC0 F9                      	stc
  1293 00000AC1 C3                      	retn
  1294                                  
  1295                                  lff8m_0:
  1296 00000AC2 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1297                                          ;mov	edx, [loadsize]
  1298                                  
  1299                                  	; esi = buffer address
  1300                                  	;; edx = buffer size
  1301                                  
  1302                                  	; load file into memory
  1303                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000AC7 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000ACD 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000ACF 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000AD5 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000ADA CD40                <1>  int 40h
  1304 00000ADC 7305                    	jnc	short lff8m_6
  1305 00000ADE E9AF000000              	jmp	lff8m_5  ; error !
  1306                                  
  1307                                  lff8m_6:
  1308 00000AE3 BF[00300000]            	mov	edi, audio_buffer
  1309 00000AE8 21C0                    	and	eax, eax
  1310 00000AEA 0F8499000000            	jz	lff8_eof
  1311                                  
  1312 00000AF0 89C1                    	mov	ecx, eax		; byte count
  1313                                  lff8m_1:
  1314 00000AF2 AC                      	lodsb
  1315 00000AF3 A2[DE200000]            	mov	[previous_val], al
  1316 00000AF8 2C80                    	sub	al, 80h
  1317 00000AFA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1318 00000AFE 66AB                    	stosw		; original sample (left channel)
  1319 00000B00 66AB                    	stosw		; original sample (right channel)
  1320                                  	;xor	eax, eax
  1321 00000B02 B080                    	mov	al, 80h
  1322 00000B04 49                      	dec	ecx
  1323 00000B05 7402                    	jz	short lff8m_2
  1324 00000B07 8A06                    	mov	al, [esi]
  1325                                  lff8m_2:
  1326                                  	;mov	[next_val], ax
  1327 00000B09 88C7                    	mov	bh, al	; [next_val]
  1328 00000B0B 8A25[DE200000]          	mov	ah, [previous_val]
  1329 00000B11 00E0                    	add	al, ah	; [previous_val]
  1330 00000B13 D0D8                    	rcr	al, 1
  1331 00000B15 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  1332 00000B17 00E0                    	add	al, ah	; [previous_val]
  1333 00000B19 D0D8                    	rcr	al, 1	
  1334 00000B1B 88C3                    	mov	bl, al 	; this is temporary interpolation value	
  1335 00000B1D 00E0                    	add	al, ah	; [previous_val]
  1336 00000B1F D0D8                    	rcr	al, 1
  1337 00000B21 2C80                    	sub	al, 80h
  1338 00000B23 66C1E008                	shl	ax, 8	
  1339 00000B27 66AB                    	stosw		; this is 1st interpolated sample (L)
  1340 00000B29 66AB                    	stosw		; this is 1st interpolated sample (R)
  1341 00000B2B 88D8                    	mov	al, bl
  1342 00000B2D 00D0                    	add	al, dl
  1343 00000B2F D0D8                    	rcr	al, 1
  1344 00000B31 2C80                    	sub	al, 80h
  1345 00000B33 66C1E008                	shl	ax, 8
  1346 00000B37 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1347 00000B39 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1348 00000B3B 88D0                    	mov	al, dl
  1349 00000B3D 2C80                    	sub	al, 80h
  1350 00000B3F 66C1E008                	shl	ax, 8
  1351 00000B43 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1352 00000B45 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1353                                  	;mov	al, [next_val]
  1354 00000B47 88F8                    	mov	al, bh
  1355 00000B49 00D0                    	add	al, dl
  1356 00000B4B D0D8                    	rcr	al, 1
  1357 00000B4D 88C3                    	mov	bl, al	; this is temporary interpolation value
  1358 00000B4F 00D0                    	add	al, dl
  1359 00000B51 D0D8                    	rcr	al, 1
  1360 00000B53 2C80                    	sub	al, 80h
  1361 00000B55 66C1E008                	shl	ax, 8
  1362 00000B59 66AB                    	stosw		; this is 4th interpolated sample (L)
  1363 00000B5B 66AB                    	stosw		; this is 4th interpolated sample (R)
  1364                                  	;mov	al, [next_val]
  1365 00000B5D 88F8                    	mov	al, bh
  1366 00000B5F 00D8                    	add	al, bl
  1367 00000B61 D0D8                    	rcr	al, 1
  1368 00000B63 2C80                    	sub	al, 80h
  1369 00000B65 66C1E008                	shl	ax, 8
  1370 00000B69 66AB                    	stosw		; this is 5th interpolated sample (L)
  1371 00000B6B 66AB                    	stosw		; this is 5th interpolated sample (R)
  1372                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1373 00000B6D 09C9                    	or	ecx, ecx
  1374 00000B6F 7581                    	jnz	short lff8m_1
  1375                                  
  1376                                  	; --------------
  1377                                  
  1378                                  lff8s_3:
  1379                                  lff8m_3:
  1380                                  lff8s2_3:
  1381                                  lff8m2_3:
  1382                                  lff16s_3:
  1383                                  lff16m_3:
  1384                                  lff16s2_3:
  1385                                  lff16m2_3:
  1386                                  lff24_3:
  1387                                  lff32_3:
  1388                                  lff44_3:
  1389                                  lff22_3:
  1390                                  lff11_3:
  1391                                  	; 08/12/2024 (BugFix)
  1392                                  	; 01/06/2024 (BugFix)
  1393 00000B71 8B0D[DA030000]          	mov	ecx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1394                                  	;shl	ecx, 1	; byte count ; Bug !
  1395                                  	; 08/12/2024
  1396 00000B77 81C1[00300000]          	add	ecx, audio_buffer
  1397 00000B7D 29F9                    	sub	ecx, edi
  1398 00000B7F 7607                    	jna	short lff8m_4
  1399                                  	;inc	ecx
  1400 00000B81 C1E902                  	shr	ecx, 2
  1401 00000B84 31C0                    	xor	eax, eax ; fill (remain part of) buffer with zeros
  1402 00000B86 F3AB                    	rep	stosd
  1403                                  lff8m_4:
  1404                                  	; 01/06/2024 (BugFix)
  1405                                  	; cf=1 ; Bug !
  1406                                  	; 08/12/2024
  1407                                  	;clc
  1408 00000B88 C3                      	retn
  1409                                  
  1410                                  lff8_eof:
  1411                                  lff16_eof:
  1412                                  lff24_eof:
  1413                                  lff32_eof:
  1414                                  lff44_eof:
  1415                                  lff22_eof:
  1416                                  lff11_eof:
  1417                                  	; 15/11/2023
  1418 00000B89 C605[20240000]01        	mov	byte [flags], ENDOFFILE
  1419 00000B90 EBDF                    	jmp	short lff8m_3
  1420                                  
  1421                                  lff8s_5:
  1422                                  lff8m_5:
  1423                                  lff8s2_5:
  1424                                  lff8m2_5:
  1425                                  lff16s_5:
  1426                                  lff16m_5:
  1427                                  lff16s2_5:
  1428                                  lff16m2_5:
  1429                                  lff24_5:
  1430                                  lff32_5:
  1431                                  lff44_5:
  1432                                  lff22_5:
  1433                                  lff11_5:
  1434 00000B92 B021                    	mov	al, '!'  ; error
  1435 00000B94 E84AFBFFFF              	call	tL0
  1436                                  	
  1437                                  	;jmp	short lff8m_3
  1438                                  	; 15/11/2023
  1439 00000B99 EBEE                    	jmp	lff8_eof
  1440                                  
  1441                                  	; --------------
  1442                                  
  1443                                  load_8khz_stereo_8_bit:
  1444                                  	; 15/11/2023
  1445                                  	; 14/11/2023
  1446                                  	; 13/11/2023
  1447 00000B9B F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1448                                  					; last of the file?
  1449 00000BA2 7402                    	jz	short lff8s_0		; no
  1450 00000BA4 F9                      	stc
  1451 00000BA5 C3                      	retn
  1452                                  
  1453                                  lff8s_0:
  1454 00000BA6 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1455                                          ;mov	edx, [loadsize]
  1456                                  
  1457                                  	; esi = buffer address
  1458                                  	;; edx = buffer size
  1459                                  
  1460                                  	; load file into memory
  1461                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000BAB 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000BB1 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000BB3 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000BB9 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000BBE CD40                <1>  int 40h
  1462 00000BC0 72D0                    	jc	short lff8s_5 ; error !
  1463                                  
  1464 00000BC2 BF[00300000]            	mov	edi, audio_buffer
  1465                                  	
  1466 00000BC7 D1E8                    	shr	eax, 1
  1467 00000BC9 74BE                    	jz	short lff8_eof
  1468                                  
  1469 00000BCB 89C1                    	mov	ecx, eax	; word count
  1470                                  lff8s_1:
  1471 00000BCD AC                      	lodsb
  1472 00000BCE A2[DE200000]            	mov	[previous_val_l], al
  1473 00000BD3 2C80                    	sub	al, 80h
  1474 00000BD5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1475 00000BD9 66AB                    	stosw		; original sample (L)
  1476 00000BDB AC                      	lodsb
  1477 00000BDC A2[E0200000]            	mov	[previous_val_r], al
  1478 00000BE1 2C80                    	sub	al, 80h
  1479 00000BE3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1480 00000BE7 66AB                    	stosw		; original sample (R)
  1481                                  
  1482                                  	;xor	eax, eax
  1483 00000BE9 66B88080                	mov	ax, 8080h
  1484 00000BED 49                      	dec	ecx
  1485 00000BEE 7403                    	jz	short lff8s_2
  1486                                  		; convert 8 bit sample to 16 bit sample
  1487 00000BF0 668B06                  	mov	ax, [esi]
  1488                                  lff8s_2:
  1489 00000BF3 A2[E2200000]            	mov	[next_val_l], al
  1490 00000BF8 8825[E4200000]          	mov	[next_val_r], ah
  1491 00000BFE 8A25[DE200000]          	mov	ah, [previous_val_l]
  1492 00000C04 00E0                    	add	al, ah
  1493 00000C06 D0D8                    	rcr	al, 1
  1494 00000C08 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1495 00000C0A 00E0                    	add	al, ah
  1496 00000C0C D0D8                    	rcr	al, 1	
  1497 00000C0E 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1498 00000C10 00E0                    	add	al, ah
  1499 00000C12 D0D8                    	rcr	al, 1
  1500 00000C14 2C80                    	sub	al, 80h
  1501 00000C16 66C1E008                	shl	ax, 8
  1502 00000C1A 66AB                    	stosw		; this is 1st interpolated sample (L)
  1503 00000C1C A0[E4200000]            	mov	al, [next_val_r]
  1504 00000C21 8A25[E0200000]          	mov	ah, [previous_val_r]
  1505 00000C27 00E0                    	add	al, ah
  1506 00000C29 D0D8                    	rcr	al, 1
  1507 00000C2B 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1508 00000C2D 00E0                    	add	al, ah
  1509 00000C2F D0D8                    	rcr	al, 1
  1510 00000C31 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1511 00000C33 00E0                    	add	al, ah
  1512 00000C35 D0D8                    	rcr	al, 1
  1513 00000C37 2C80                    	sub	al, 80h
  1514 00000C39 66C1E008                	shl	ax, 8
  1515 00000C3D 66AB                    	stosw		; this is 1st interpolated sample (R)
  1516 00000C3F 88D8                    	mov	al, bl
  1517 00000C41 00D0                    	add	al, dl
  1518 00000C43 D0D8                    	rcr	al, 1
  1519 00000C45 2C80                    	sub	al, 80h
  1520 00000C47 66C1E008                	shl	ax, 8
  1521 00000C4B 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1522 00000C4D 88F8                    	mov	al, bh
  1523 00000C4F 00F0                    	add	al, dh
  1524 00000C51 D0D8                    	rcr	al, 1
  1525 00000C53 2C80                    	sub	al, 80h
  1526 00000C55 66C1E008                	shl	ax, 8
  1527 00000C59 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1528 00000C5B 88D0                    	mov	al, dl
  1529 00000C5D 2C80                    	sub	al, 80h
  1530 00000C5F 66C1E008                	shl	ax, 8
  1531 00000C63 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1532 00000C65 88F0                    	mov	al, dh
  1533 00000C67 2C80                    	sub	al, 80h
  1534 00000C69 66C1E008                	shl	ax, 8
  1535 00000C6D 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1536 00000C6F A0[E2200000]            	mov	al, [next_val_l]
  1537 00000C74 00D0                    	add	al, dl
  1538 00000C76 D0D8                    	rcr	al, 1
  1539 00000C78 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1540 00000C7A 00D0                    	add	al, dl
  1541 00000C7C D0D8                    	rcr	al, 1
  1542 00000C7E 2C80                    	sub	al, 80h
  1543 00000C80 66C1E008                	shl	ax, 8
  1544 00000C84 66AB                    	stosw		; this is 4th interpolated sample (L)
  1545 00000C86 A0[E4200000]            	mov	al, [next_val_r]
  1546 00000C8B 00F0                    	add	al, dh
  1547 00000C8D D0D8                    	rcr	al, 1
  1548 00000C8F 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1549 00000C91 00F0                    	add	al, dh
  1550 00000C93 D0D8                    	rcr	al, 1
  1551 00000C95 2C80                    	sub	al, 80h
  1552 00000C97 66C1E008                	shl	ax, 8
  1553 00000C9B 66AB                    	stosw		; this is 4th interpolated sample (R)
  1554 00000C9D A0[E2200000]            	mov	al, [next_val_l]
  1555 00000CA2 00D8                    	add	al, bl
  1556 00000CA4 D0D8                    	rcr	al, 1
  1557 00000CA6 2C80                    	sub	al, 80h
  1558 00000CA8 66C1E008                	shl	ax, 8
  1559 00000CAC 66AB                    	stosw		; this is 5th interpolated sample (L)
  1560 00000CAE A0[E4200000]            	mov	al, [next_val_r]
  1561 00000CB3 00F8                    	add	al, bh
  1562 00000CB5 D0D8                    	rcr	al, 1
  1563 00000CB7 2C80                    	sub	al, 80h
  1564 00000CB9 66C1E008                	shl	ax, 8
  1565 00000CBD 66AB                    	stosw		; this is 5th interpolated sample (R)
  1566                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1567 00000CBF E305                    	jecxz	lff8s_6
  1568 00000CC1 E907FFFFFF              	jmp	lff8s_1
  1569                                  lff8s_6:
  1570 00000CC6 E9A6FEFFFF              	jmp	lff8s_3
  1571                                  
  1572                                  load_8khz_mono_16_bit:
  1573                                  	; 13/11/2023
  1574 00000CCB F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1575                                  					; last of the file?
  1576 00000CD2 7402                    	jz	short lff8m2_0		; no
  1577 00000CD4 F9                      	stc
  1578 00000CD5 C3                      	retn
  1579                                  
  1580                                  lff8m2_0:
  1581 00000CD6 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1582                                          ;mov	edx, [loadsize]
  1583                                  
  1584                                  	; esi = buffer address
  1585                                  	;; edx = buffer size
  1586                                  
  1587                                  	; load file into memory
  1588                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000CDB 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000CE1 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000CE3 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000CE9 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000CEE CD40                <1>  int 40h
  1589 00000CF0 0F82A0000000            	jc	lff8m2_7 ; error !
  1590                                  
  1591 00000CF6 BF[00300000]            	mov	edi, audio_buffer
  1592                                  	
  1593 00000CFB D1E8                    	shr	eax, 1
  1594 00000CFD 7505                    	jnz	short lff8m2_8
  1595 00000CFF E985FEFFFF              	jmp	lff8_eof
  1596                                  
  1597                                  lff8m2_8:
  1598 00000D04 89C1                    	mov	ecx, eax	; word count
  1599                                  lff8m2_1:
  1600 00000D06 66AD                    	lodsw
  1601 00000D08 66AB                    	stosw		; original sample (left channel)
  1602 00000D0A 66AB                    	stosw		; original sample (right channel)
  1603 00000D0C 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1604 00000D0F 66A3[DE200000]          	mov	[previous_val], ax
  1605 00000D15 31C0                    	xor	eax, eax
  1606 00000D17 49                      	dec	ecx
  1607 00000D18 7403                    	jz	short lff8m2_2
  1608 00000D1A 668B06                  	mov	ax, [esi]
  1609                                  lff8m2_2:
  1610 00000D1D 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  1611 00000D20 89C5                    	mov	ebp, eax	; [next_val]
  1612 00000D22 660305[DE200000]        	add	ax, [previous_val]
  1613 00000D29 66D1D8                  	rcr	ax, 1
  1614 00000D2C 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample
  1615 00000D2E 660305[DE200000]        	add	ax, [previous_val]
  1616 00000D35 66D1D8                  	rcr	ax, 1	; this is temporary interpolation value
  1617 00000D38 89C3                    	mov	ebx, eax 		
  1618 00000D3A 660305[DE200000]        	add	ax, [previous_val]
  1619 00000D41 66D1D8                  	rcr	ax, 1
  1620 00000D44 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1621 00000D47 66AB                    	stosw		; this is 1st interpolated sample (L)
  1622 00000D49 66AB                    	stosw		; this is 1st interpolated sample (R)
  1623 00000D4B 89D8                    	mov	eax, ebx
  1624 00000D4D 6601D0                  	add	ax, dx
  1625 00000D50 66D1D8                  	rcr	ax, 1
  1626 00000D53 80EC80                  	sub	ah, 80h
  1627 00000D56 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1628 00000D58 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1629 00000D5A 89D0                    	mov	eax, edx
  1630 00000D5C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1631 00000D5F 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1632 00000D61 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1633 00000D63 89E8                    	mov	eax, ebp
  1634 00000D65 6601D0                  	add	ax, dx
  1635 00000D68 66D1D8                  	rcr	ax, 1
  1636 00000D6B 89C3                    	mov	ebx, eax ; this is temporary interpolation value
  1637 00000D6D 6601D0                  	add	ax, dx
  1638 00000D70 66D1D8                  	rcr	ax, 1
  1639 00000D73 80EC80                  	sub	ah, 80h
  1640 00000D76 66AB                    	stosw		; this is 4th interpolated sample (L)
  1641 00000D78 66AB                    	stosw		; this is 4th interpolated sample (R)
  1642 00000D7A 89E8                    	mov	eax, ebp
  1643 00000D7C 6601D8                  	add	ax, bx
  1644 00000D7F 66D1D8                  	rcr	ax, 1
  1645 00000D82 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1646 00000D85 66AB                    	stosw		; this is 5th interpolated sample (L)
  1647 00000D87 66AB                    	stosw		; this is 5th interpolated sample (R)
  1648                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1649 00000D89 09C9                    	or	ecx, ecx
  1650 00000D8B 0F8575FFFFFF            	jnz	lff8m2_1
  1651 00000D91 E9DBFDFFFF              	jmp	lff8m2_3
  1652                                  
  1653                                  lff8m2_7:
  1654                                  lff8s2_7:
  1655 00000D96 E9F7FDFFFF              	jmp	lff8m2_5  ; error
  1656                                  
  1657                                  load_8khz_stereo_16_bit:
  1658                                  	; 16/11/2023
  1659                                  	; 15/11/2023
  1660                                  	; 13/11/2023
  1661 00000D9B F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1662                                  					; last of the file?
  1663 00000DA2 7402                    	jz	short lff8s2_0		; no
  1664 00000DA4 F9                      	stc
  1665 00000DA5 C3                      	retn
  1666                                  
  1667                                  lff8s2_0:
  1668 00000DA6 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1669                                          ;mov	edx, [loadsize]
  1670                                  
  1671                                  	; esi = buffer address
  1672                                  	;; edx = buffer size
  1673                                  
  1674                                  	; load file into memory
  1675                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000DAB 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000DB1 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000DB3 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000DB9 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000DBE CD40                <1>  int 40h
  1676 00000DC0 72D4                    	jc	short lff8s2_7 ; error !
  1677                                  
  1678 00000DC2 BF[00300000]            	mov	edi, audio_buffer
  1679                                  	
  1680 00000DC7 C1E802                  	shr	eax, 2
  1681 00000DCA 7505                    	jnz	short lff8s2_8
  1682 00000DCC E9B8FDFFFF              	jmp	lff8_eof
  1683                                  
  1684                                  lff8s2_8:
  1685 00000DD1 89C1                    	mov	ecx, eax ; dword count
  1686                                  lff8s2_1:
  1687 00000DD3 66AD                    	lodsw
  1688 00000DD5 66AB                    	stosw		; original sample (L)
  1689                                  	; 15/11/2023
  1690 00000DD7 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1691 00000DDA 66A3[DE200000]          	mov	[previous_val_l], ax
  1692 00000DE0 66AD                    	lodsw
  1693 00000DE2 66AB                    	stosw		; original sample (R)
  1694 00000DE4 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1695 00000DE7 66A3[E0200000]          	mov	[previous_val_r], ax
  1696 00000DED 31D2                    	xor	edx, edx
  1697 00000DEF 31C0                    	xor	eax, eax
  1698                                  	; 16/11/2023
  1699 00000DF1 49                      	dec	ecx
  1700 00000DF2 7407                    	jz	short lff8s2_2
  1701 00000DF4 668B06                  	mov	ax, [esi]
  1702 00000DF7 668B5602                	mov	dx, [esi+2]
  1703                                  lff8s2_2:
  1704 00000DFB 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1705 00000DFE 66A3[E2200000]          	mov	[next_val_l], ax
  1706 00000E04 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  1707 00000E07 668915[E4200000]        	mov	[next_val_r], dx
  1708 00000E0E 660305[DE200000]        	add	ax, [previous_val_l]
  1709 00000E15 66D1D8                  	rcr	ax, 1
  1710 00000E18 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample (L)
  1711 00000E1A 660305[DE200000]        	add	ax, [previous_val_l]
  1712 00000E21 66D1D8                  	rcr	ax, 1	
  1713 00000E24 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1714 00000E26 660305[DE200000]        	add	ax, [previous_val_l]
  1715 00000E2D 66D1D8                  	rcr	ax, 1
  1716 00000E30 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1717 00000E33 66AB                    	stosw		; this is 1st interpolated sample (L)
  1718 00000E35 66A1[E4200000]          	mov	ax, [next_val_r]
  1719 00000E3B 660305[E0200000]        	add	ax, [previous_val_r]
  1720 00000E42 66D1D8                  	rcr	ax, 1
  1721 00000E45 89C5                    	mov	ebp, eax ; this is interpolated middle (3th) sample (R)
  1722 00000E47 660305[E0200000]        	add	ax, [previous_val_r]
  1723 00000E4E 66D1D8                  	rcr	ax, 1
  1724 00000E51 50                      	push	eax ; *	; this is temporary interpolation value (R)
  1725 00000E52 660305[E0200000]        	add	ax, [previous_val_r]
  1726 00000E59 66D1D8                  	rcr	ax, 1
  1727 00000E5C 80EC80                  	sub	ah, 80h
  1728 00000E5F 66AB                    	stosw		; this is 1st interpolated sample (R)
  1729 00000E61 89D8                    	mov	eax, ebx
  1730 00000E63 6601D0                  	add	ax, dx
  1731 00000E66 66D1D8                  	rcr	ax, 1
  1732 00000E69 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1733 00000E6C 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1734 00000E6E 58                      	pop	eax ; *
  1735 00000E6F 6601E8                  	add	ax, bp
  1736 00000E72 66D1D8                  	rcr	ax, 1
  1737 00000E75 80EC80                  	sub	ah, 80h
  1738 00000E78 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1739 00000E7A 89D0                    	mov	eax, edx
  1740 00000E7C 80EC80                  	sub	ah, 80h
  1741 00000E7F 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1742 00000E81 89E8                    	mov	eax, ebp
  1743 00000E83 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1744 00000E86 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1745 00000E88 66A1[E2200000]          	mov	ax, [next_val_l]
  1746 00000E8E 6601D0                  	add	ax, dx
  1747 00000E91 66D1D8                  	rcr	ax, 1
  1748 00000E94 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1749 00000E96 6601D0                  	add	ax, dx
  1750 00000E99 66D1D8                  	rcr	ax, 1
  1751 00000E9C 80EC80                  	sub	ah, 80h
  1752 00000E9F 66AB                    	stosw		; this is 4th interpolated sample (L)
  1753 00000EA1 66A1[E4200000]          	mov	ax, [next_val_r]
  1754 00000EA7 6601E8                  	add	ax, bp
  1755 00000EAA 66D1D8                  	rcr	ax, 1
  1756 00000EAD 50                      	push	eax ; ** ; this is temporary interpolation value (R)
  1757 00000EAE 6601E8                  	add	ax, bp
  1758 00000EB1 66D1D8                  	rcr	ax, 1
  1759 00000EB4 80EC80                  	sub	ah, 80h
  1760 00000EB7 66AB                    	stosw		; this is 4th interpolated sample (R)
  1761 00000EB9 66A1[E2200000]          	mov	ax, [next_val_l]
  1762 00000EBF 6601D8                  	add	ax, bx
  1763 00000EC2 66D1D8                  	rcr	ax, 1
  1764 00000EC5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1765 00000EC8 66AB                    	stosw		; this is 5th interpolated sample (L)
  1766 00000ECA 58                      	pop	eax ; **
  1767 00000ECB 660305[E4200000]        	add	ax, [next_val_r]
  1768 00000ED2 66D1D8                  	rcr	ax, 1
  1769 00000ED5 80EC80                  	sub	ah, 80h
  1770 00000ED8 66AB                    	stosw		; this is 5th interpolated sample (R)
  1771                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1772 00000EDA E305                    	jecxz	lff8_s2_9
  1773 00000EDC E9F2FEFFFF              	jmp	lff8s2_1
  1774                                  lff8_s2_9:
  1775 00000EE1 E98BFCFFFF              	jmp	lff8s2_3
  1776                                  
  1777                                  ; .....................
  1778                                  
  1779                                  load_16khz_mono_8_bit:
  1780                                  	; 14/11/2023
  1781                                  	; 13/11/2023
  1782 00000EE6 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1783                                  					; last of the file?
  1784 00000EED 7402                    	jz	short lff16m_0		; no
  1785 00000EEF F9                      	stc
  1786 00000EF0 C3                      	retn
  1787                                  
  1788                                  lff16m_0:
  1789 00000EF1 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1790                                          ;mov	edx, [loadsize]
  1791                                  
  1792                                  	; esi = buffer address
  1793                                  	;; edx = buffer size
  1794                                  
  1795                                  	; load file into memory
  1796                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000EF6 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000EFC 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000EFE 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000F04 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000F09 CD40                <1>  int 40h
  1797 00000F0B 7253                    	jc	short lff16m_7 ; error !
  1798                                  
  1799 00000F0D BF[00300000]            	mov	edi, audio_buffer
  1800                                  	
  1801 00000F12 21C0                    	and	eax, eax
  1802 00000F14 7505                    	jnz	short lff16m_8
  1803 00000F16 E96EFCFFFF              	jmp	lff16_eof
  1804                                  
  1805                                  lff16m_8:
  1806 00000F1B 89C1                    	mov	ecx, eax		; byte count
  1807                                  lff16m_1:
  1808 00000F1D AC                      	lodsb
  1809                                  	;mov	[previous_val], al
  1810 00000F1E 88C3                    	mov	bl, al
  1811 00000F20 2C80                    	sub	al, 80h
  1812 00000F22 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1813 00000F26 66AB                    	stosw		; original sample (left channel)
  1814 00000F28 66AB                    	stosw		; original sample (right channel)
  1815                                  	;xor	ax, ax
  1816                                  	; 14/11/22023
  1817 00000F2A B080                    	mov	al, 80h
  1818 00000F2C 49                      	dec	ecx
  1819 00000F2D 7402                    	jz	short lff16m_2
  1820 00000F2F 8A06                    	mov	al, [esi]
  1821                                  lff16m_2:
  1822                                  	;mov	[next_val], al
  1823 00000F31 88C7                    	mov	bh, al
  1824                                  	;add	al, [previous_val]
  1825 00000F33 00D8                    	add	al, bl
  1826 00000F35 D0D8                    	rcr	al, 1
  1827 00000F37 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  1828                                  	;add	al, [previous_val]
  1829 00000F39 00D8                    	add	al, bl
  1830 00000F3B D0D8                    	rcr	al, 1
  1831 00000F3D 2C80                    	sub	al, 80h
  1832 00000F3F 66C1E008                	shl	ax, 8
  1833 00000F43 66AB                    	stosw		; this is 1st interpolated sample (L)
  1834 00000F45 66AB                    	stosw		; this is 1st interpolated sample (R)
  1835                                  	;mov	al, [next_val]
  1836 00000F47 88F8                    	mov	al, bh
  1837 00000F49 00D0                    	add	al, dl
  1838 00000F4B D0D8                    	rcr	al, 1
  1839 00000F4D 2C80                    	sub	al, 80h
  1840 00000F4F 66C1E008                	shl	ax, 8
  1841 00000F53 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1842 00000F55 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1843                                  	
  1844                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1845 00000F57 09C9                    	or	ecx, ecx
  1846 00000F59 75C2                    	jnz	short lff16m_1
  1847 00000F5B E911FCFFFF              	jmp	lff16m_3
  1848                                  
  1849                                  lff16m_7:
  1850                                  lff16s_7:
  1851 00000F60 E92DFCFFFF              	jmp	lff16m_5  ; error
  1852                                  
  1853                                  load_16khz_stereo_8_bit:
  1854                                  	; 14/11/2023
  1855                                  	; 13/11/2023
  1856 00000F65 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1857                                  					; last of the file?
  1858 00000F6C 7402                    	jz	short lff16s_0		; no
  1859 00000F6E F9                      	stc
  1860 00000F6F C3                      	retn
  1861                                  
  1862                                  lff16s_0:
  1863 00000F70 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1864                                          ;mov	edx, [loadsize]
  1865                                  
  1866                                  	; esi = buffer address
  1867                                  	;; edx = buffer size
  1868                                  
  1869                                  	; load file into memory
  1870                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000F75 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000F7B 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000F7D 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000F83 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000F88 CD40                <1>  int 40h
  1871 00000F8A 72D4                    	jc	short lff16s_7 ; error !
  1872                                  
  1873 00000F8C BF[00300000]            	mov	edi, audio_buffer
  1874                                  	
  1875 00000F91 D1E8                    	shr	eax, 1
  1876 00000F93 7505                    	jnz	short lff16s_8
  1877 00000F95 E9EFFBFFFF              	jmp	lff16_eof
  1878                                  
  1879                                  lff16s_8:
  1880 00000F9A 89C1                    	mov	ecx, eax	; word count
  1881                                  lff16s_1:
  1882 00000F9C AC                      	lodsb
  1883 00000F9D A2[DE200000]            	mov	[previous_val_l], al
  1884 00000FA2 2C80                    	sub	al, 80h
  1885 00000FA4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1886 00000FA8 66AB                    	stosw		; original sample (L)
  1887 00000FAA AC                      	lodsb
  1888 00000FAB A2[E0200000]            	mov	[previous_val_r], al
  1889 00000FB0 2C80                    	sub	al, 80h
  1890 00000FB2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1891 00000FB6 66AB                    	stosw		; original sample (R)
  1892                                  
  1893                                  	;xor	eax, eax
  1894 00000FB8 66B88080                	mov	ax, 8080h
  1895 00000FBC 49                      	dec	ecx
  1896 00000FBD 7403                    	jz	short lff16s_2
  1897                                  		; convert 8 bit sample to 16 bit sample
  1898 00000FBF 668B06                  	mov	ax, [esi]
  1899                                  lff16s_2:
  1900                                  	;mov	[next_val_l], al
  1901                                  	;mov	[next_val_r], ah
  1902 00000FC2 89C3                    	mov	ebx, eax
  1903 00000FC4 0205[DE200000]          	add	al, [previous_val_l]
  1904 00000FCA D0D8                    	rcr	al, 1
  1905 00000FCC 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  1906 00000FCE 0205[DE200000]          	add	al, [previous_val_l]
  1907 00000FD4 D0D8                    	rcr	al, 1
  1908 00000FD6 2C80                    	sub	al, 80h
  1909 00000FD8 66C1E008                	shl	ax, 8
  1910 00000FDC 66AB                    	stosw		; this is 1st interpolated sample (L)
  1911 00000FDE 88F8                    	mov	al, bh	; [next_val_r]
  1912 00000FE0 0205[E0200000]          	add	al, [previous_val_r]
  1913 00000FE6 D0D8                    	rcr	al, 1
  1914 00000FE8 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  1915 00000FEA 0205[E0200000]          	add	al, [previous_val_r]
  1916 00000FF0 D0D8                    	rcr	al, 1
  1917 00000FF2 2C80                    	sub	al, 80h
  1918 00000FF4 66C1E008                	shl	ax, 8
  1919 00000FF8 66AB                    	stosw		; this is 1st interpolated sample (R)
  1920 00000FFA 88D0                    	mov	al, dl
  1921 00000FFC 00D8                    	add	al, bl	; [next_val_l]
  1922 00000FFE D0D8                    	rcr	al, 1
  1923 00001000 2C80                    	sub	al, 80h
  1924 00001002 66C1E008                	shl	ax, 8
  1925 00001006 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1926 00001008 88F0                    	mov	al, dh
  1927 0000100A 00F8                    	add	al, bh	; [next_val_r]
  1928 0000100C D0D8                    	rcr	al, 1
  1929 0000100E 2C80                    	sub	al, 80h
  1930 00001010 66C1E008                	shl	ax, 8
  1931 00001014 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1932                                  	
  1933                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1934 00001016 09C9                    	or	ecx, ecx
  1935 00001018 7582                    	jnz	short lff16s_1
  1936 0000101A E952FBFFFF              	jmp	lff16s_3
  1937                                  
  1938                                  load_16khz_mono_16_bit:
  1939                                  	; 15/11/2023
  1940                                  	; 13/11/2023
  1941 0000101F F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1942                                  					; last of the file?
  1943 00001026 7402                    	jz	short lff16m2_0		; no
  1944 00001028 F9                      	stc
  1945 00001029 C3                      	retn
  1946                                  
  1947                                  lff16m2_0:
  1948 0000102A BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1949                                          ;mov	edx, [loadsize]
  1950                                  
  1951                                  	; esi = buffer address
  1952                                  	;; edx = buffer size
  1953                                  
  1954                                  	; load file into memory
  1955                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000102F 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001035 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001037 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000103D B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001042 CD40                <1>  int 40h
  1956 00001044 7255                    	jc	short lff16m2_7 ; error !
  1957                                  
  1958 00001046 BF[00300000]            	mov	edi, audio_buffer
  1959                                  	
  1960 0000104B D1E8                    	shr	eax, 1
  1961 0000104D 7505                    	jnz	short lff16m2_8
  1962 0000104F E935FBFFFF              	jmp	lff16_eof
  1963                                  
  1964                                  lff16m2_8:
  1965 00001054 89C1                    	mov	ecx, eax  ; word count
  1966                                  lff16m2_1:
  1967 00001056 66AD                    	lodsw
  1968 00001058 66AB                    	stosw		; original sample (left channel)
  1969 0000105A 66AB                    	stosw		; original sample (right channel)
  1970 0000105C 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  1971                                  	;mov	[previous_val], ax
  1972 0000105F 89C3                    	mov	ebx, eax	
  1973 00001061 31C0                    	xor	eax, eax
  1974 00001063 49                      	dec	ecx
  1975 00001064 7403                    	jz	short lff16m2_2
  1976 00001066 668B06                  	mov	ax, [esi]
  1977                                  lff16m2_2:
  1978 00001069 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  1979 0000106C 89C5                    	mov	ebp, eax	; [next_val]
  1980                                  	;add	ax, [previous_val]
  1981 0000106E 6601D8                  	add	ax, bx
  1982 00001071 66D1D8                  	rcr	ax, 1
  1983 00001074 89C2                    	mov	edx, eax ; this is temporary interpolation value
  1984                                  	;add	ax, [previous_val]
  1985 00001076 6601D8                  	add	ax, bx
  1986 00001079 66D1D8                  	rcr	ax, 1
  1987 0000107C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1988 0000107F 66AB                    	stosw		; this is 1st interpolated sample (L)
  1989 00001081 66AB                    	stosw		; this is 1st interpolated sample (R)
  1990 00001083 89E8                    	mov	eax, ebp 
  1991 00001085 6601D0                  	add	ax, dx
  1992 00001088 66D1D8                  	rcr	ax, 1
  1993 0000108B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1994 0000108E 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1995 00001090 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1996                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1997 00001092 09C9                    	or	ecx, ecx
  1998 00001094 75C0                    	jnz	short lff16m2_1
  1999 00001096 E9D6FAFFFF              	jmp	lff16m2_3
  2000                                  
  2001                                  lff16m2_7:
  2002                                  lff16s2_7:
  2003 0000109B E9F2FAFFFF              	jmp	lff16m2_5  ; error
  2004                                  
  2005                                  load_16khz_stereo_16_bit:
  2006                                  	; 16/11/2023
  2007                                  	; 15/11/2023
  2008                                  	; 13/11/2023
  2009 000010A0 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2010                                  					; last of the file?
  2011 000010A7 7402                    	jz	short lff16s2_0		; no
  2012 000010A9 F9                      	stc
  2013 000010AA C3                      	retn
  2014                                  
  2015                                  lff16s2_0:
  2016 000010AB BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2017                                          ;mov	edx, [loadsize]
  2018                                  
  2019                                  	; esi = buffer address
  2020                                  	;; edx = buffer size
  2021                                  
  2022                                  	; load file into memory
  2023                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000010B0 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000010B6 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000010B8 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000010BE B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000010C3 CD40                <1>  int 40h
  2024 000010C5 72D4                    	jc	short lff16s2_7 ; error !
  2025                                  
  2026 000010C7 BF[00300000]            	mov	edi, audio_buffer
  2027                                  	
  2028 000010CC C1E802                  	shr	eax, 2
  2029 000010CF 7505                    	jnz	short lff16s2_8
  2030 000010D1 E9B3FAFFFF              	jmp	lff16_eof
  2031                                  
  2032                                  lff16s2_8:
  2033 000010D6 89C1                    	mov	ecx, eax  ; dword count
  2034                                  lff16s2_1:
  2035 000010D8 66AD                    	lodsw
  2036 000010DA 66AB                    	stosw		; original sample (L)
  2037 000010DC 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2038 000010DF 66A3[DE200000]          	mov	[previous_val_l], ax
  2039 000010E5 66AD                    	lodsw
  2040 000010E7 66AB                    	stosw		; original sample (R)
  2041 000010E9 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2042 000010EC 66A3[E0200000]          	mov	[previous_val_r], ax
  2043 000010F2 31D2                    	xor	edx, edx
  2044 000010F4 31C0                    	xor	eax, eax
  2045                                  	; 16/11/2023
  2046 000010F6 49                      	dec	ecx
  2047 000010F7 7407                    	jz	short lff16s2_2
  2048 000010F9 668B06                  	mov	ax, [esi]
  2049 000010FC 668B5602                	mov	dx, [esi+2]
  2050                                  lff16s2_2:
  2051 00001100 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2052                                  	;mov	[next_val_l], ax
  2053 00001103 89C5                    	mov	ebp, eax
  2054 00001105 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2055 00001108 668915[E4200000]        	mov	[next_val_r], dx
  2056 0000110F 660305[DE200000]        	add	ax, [previous_val_l]
  2057 00001116 66D1D8                  	rcr	ax, 1
  2058 00001119 89C2                    	mov	edx, eax ; this is temporary interpolation value (L)
  2059 0000111B 660305[DE200000]        	add	ax, [previous_val_l]
  2060 00001122 66D1D8                  	rcr	ax, 1
  2061 00001125 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2062 00001128 66AB                    	stosw		; this is 1st interpolated sample (L)
  2063 0000112A 66A1[E4200000]          	mov	ax, [next_val_r]
  2064 00001130 660305[E0200000]        	add	ax, [previous_val_r]
  2065 00001137 66D1D8                  	rcr	ax, 1
  2066 0000113A 89C3                    	mov	ebx, eax ; this is temporary interpolation value (R)
  2067 0000113C 660305[E0200000]        	add	ax, [previous_val_r]
  2068 00001143 66D1D8                  	rcr	ax, 1
  2069 00001146 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2070 00001149 66AB                    	stosw		; this is 1st interpolated sample (R)
  2071                                  	;mov	ax, [next_val_l]
  2072 0000114B 89E8                    	mov	eax, ebp
  2073 0000114D 6601D0                  	add	ax, dx
  2074 00001150 66D1D8                  	rcr	ax, 1
  2075 00001153 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2076 00001156 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2077 00001158 66A1[E4200000]          	mov	ax, [next_val_r]
  2078 0000115E 6601D8                  	add	ax, bx
  2079 00001161 66D1D8                  	rcr	ax, 1
  2080 00001164 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2081 00001167 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  2082                                  	
  2083                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2084 00001169 09C9                    	or	ecx, ecx
  2085 0000116B 0F8567FFFFFF            	jnz	lff16s2_1
  2086 00001171 E9FBF9FFFF              	jmp	lff16s2_3
  2087                                  
  2088                                  ; .....................
  2089                                  
  2090                                  load_24khz_mono_8_bit:
  2091                                  	; 15/11/2023
  2092 00001176 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2093                                  					; last of the file?
  2094 0000117D 7402                    	jz	short lff24m_0		; no
  2095 0000117F F9                      	stc
  2096 00001180 C3                      	retn
  2097                                  
  2098                                  lff24m_0:
  2099 00001181 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2100                                          ;mov	edx, [loadsize]
  2101                                  
  2102                                  	; esi = buffer address
  2103                                  	;; edx = buffer size
  2104                                  
  2105                                  	; load file into memory
  2106                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001186 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000118C 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000118E 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001194 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001199 CD40                <1>  int 40h
  2107 0000119B 723B                    	jc	short lff24m_7 ; error !
  2108                                  
  2109 0000119D BF[00300000]            	mov	edi, audio_buffer
  2110                                  	
  2111 000011A2 21C0                    	and	eax, eax
  2112 000011A4 7505                    	jnz	short lff24m_8
  2113 000011A6 E9DEF9FFFF              	jmp	lff24_eof
  2114                                  
  2115                                  lff24m_8:
  2116 000011AB 89C1                    	mov	ecx, eax	; byte count
  2117                                  lff24m_1:
  2118 000011AD AC                      	lodsb
  2119                                  	;mov	[previous_val], al
  2120 000011AE 88C3                    	mov	bl, al
  2121 000011B0 2C80                    	sub	al, 80h
  2122 000011B2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2123 000011B6 66AB                    	stosw		; original sample (left channel)
  2124 000011B8 66AB                    	stosw		; original sample (right channel)
  2125                                  	;xor	eax, eax
  2126 000011BA B080                    	mov	al, 80h
  2127 000011BC 49                      	dec	ecx
  2128 000011BD 7402                    	jz	short lff24m_2
  2129 000011BF 8A06                    	mov	al, [esi]
  2130                                  lff24m_2:
  2131                                  	;;mov	[next_val], al
  2132                                  	;mov	bh, al
  2133                                  	;add	al, [previous_val]
  2134 000011C1 00D8                    	add	al, bl
  2135 000011C3 D0D8                    	rcr	al, 1
  2136 000011C5 2C80                    	sub	al, 80h
  2137 000011C7 66C1E008                	shl	ax, 8
  2138 000011CB 66AB                    	stosw		; this is interpolated sample (L)
  2139 000011CD 66AB                    	stosw		; this is interpolated sample (R)
  2140                                  	
  2141                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2142 000011CF 09C9                    	or	ecx, ecx
  2143 000011D1 75DA                    	jnz	short lff24m_1
  2144 000011D3 E999F9FFFF              	jmp	lff24_3
  2145                                  
  2146                                  lff24m_7:
  2147                                  lff24s_7:
  2148 000011D8 E9B5F9FFFF              	jmp	lff24_5  ; error
  2149                                  
  2150                                  load_24khz_stereo_8_bit:
  2151                                  	; 15/11/2023
  2152 000011DD F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2153                                  					; last of the file?
  2154 000011E4 7402                    	jz	short lff24s_0		; no
  2155 000011E6 F9                      	stc
  2156 000011E7 C3                      	retn
  2157                                  
  2158                                  lff24s_0:
  2159 000011E8 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2160                                          ;mov	edx, [loadsize]
  2161                                  
  2162                                  	; esi = buffer address
  2163                                  	;; edx = buffer size
  2164                                  
  2165                                  	; load file into memory
  2166                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000011ED 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000011F3 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000011F5 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000011FB B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001200 CD40                <1>  int 40h
  2167 00001202 72D4                    	jc	short lff24s_7 ; error !
  2168                                  
  2169 00001204 BF[00300000]            	mov	edi, audio_buffer
  2170                                  	
  2171 00001209 D1E8                    	shr	eax, 1
  2172 0000120B 7505                    	jnz	short lff24s_8
  2173 0000120D E977F9FFFF              	jmp	lff24_eof
  2174                                  
  2175                                  lff24s_8:
  2176 00001212 89C1                    	mov	ecx, eax  ; word count
  2177                                  lff24s_1:
  2178 00001214 AC                      	lodsb
  2179 00001215 A2[DE200000]            	mov	[previous_val_l], al
  2180 0000121A 2C80                    	sub	al, 80h
  2181 0000121C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2182 00001220 66AB                    	stosw		; original sample (L)
  2183 00001222 AC                      	lodsb
  2184 00001223 A2[E0200000]            	mov	[previous_val_r], al
  2185 00001228 2C80                    	sub	al, 80h
  2186 0000122A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2187 0000122E 66AB                    	stosw		; original sample (R)
  2188                                  
  2189                                  	;xor	eax, eax
  2190 00001230 66B88080                	mov	ax, 8080h
  2191 00001234 49                      	dec	ecx
  2192 00001235 7403                    	jz	short lff24s_2
  2193                                  		; convert 8 bit sample to 16 bit sample
  2194 00001237 668B06                  	mov	ax, [esi]
  2195                                  lff24s_2:
  2196                                  	;;mov	[next_val_l], al
  2197                                  	;;mov	[next_val_r], ah
  2198                                  	;mov	bx, ax
  2199 0000123A 88E7                    	mov	bh, ah
  2200 0000123C 0205[DE200000]          	add	al, [previous_val_l]
  2201 00001242 D0D8                    	rcr	al, 1
  2202                                  	;mov	dl, al
  2203 00001244 2C80                    	sub	al, 80h
  2204 00001246 66C1E008                	shl	ax, 8
  2205 0000124A 66AB                    	stosw		; this is interpolated sample (L)
  2206 0000124C 88F8                    	mov	al, bh	; [next_val_r]
  2207 0000124E 0205[E0200000]          	add	al, [previous_val_r]
  2208 00001254 D0D8                    	rcr	al, 1
  2209                                  	;mov	dh, al
  2210 00001256 2C80                    	sub	al, 80h
  2211 00001258 66C1E008                	shl	ax, 8
  2212 0000125C 66AB                    	stosw		; this is interpolated sample (R)
  2213                                  		
  2214                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2215 0000125E 09C9                    	or	ecx, ecx
  2216 00001260 75B2                    	jnz	short lff24s_1
  2217 00001262 E90AF9FFFF              	jmp	lff24_3
  2218                                  
  2219                                  load_24khz_mono_16_bit:
  2220                                  	; 15/11/2023
  2221 00001267 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2222                                  					; last of the file?
  2223 0000126E 7402                    	jz	short lff24m2_0		; no
  2224 00001270 F9                      	stc
  2225 00001271 C3                      	retn
  2226                                  
  2227                                  lff24m2_0:
  2228 00001272 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2229                                          ;mov	edx, [loadsize]
  2230                                  
  2231                                  	; esi = buffer address
  2232                                  	;; edx = buffer size
  2233                                  
  2234                                  	; load file into memory
  2235                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001277 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000127D 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000127F 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001285 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000128A CD40                <1>  int 40h
  2236 0000128C 7237                    	jc	short lff24m2_7 ; error !
  2237                                  
  2238 0000128E BF[00300000]            	mov	edi, audio_buffer
  2239                                  	
  2240 00001293 D1E8                    	shr	eax, 1
  2241 00001295 7505                    	jnz	short lff24m2_8
  2242 00001297 E9EDF8FFFF              	jmp	lff24_eof
  2243                                  
  2244                                  lff24m2_8:
  2245 0000129C 89C1                    	mov	ecx, eax  ; word count
  2246                                  lff24m2_1:
  2247 0000129E 66AD                    	lodsw
  2248 000012A0 66AB                    	stosw		; original sample (left channel)
  2249 000012A2 66AB                    	stosw		; original sample (right channel)
  2250 000012A4 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2251                                  	;mov	[previous_val], ax
  2252                                  	;mov	ebx, eax	
  2253                                  	;xor	eax, eax
  2254 000012A7 31DB                    	xor	ebx, ebx
  2255 000012A9 49                      	dec	ecx
  2256 000012AA 7403                    	jz	short lff24m2_2
  2257                                  	;mov	ax, [esi]
  2258 000012AC 668B1E                  	mov	bx, [esi]
  2259                                  lff24m2_2:
  2260                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2261                                  	;mov	ebp, eax	; [next_val]
  2262                                  	;add	ax, [previous_val]
  2263                                  	; ax = [previous_val]
  2264                                  	; bx = [next_val]
  2265 000012AF 6601D8                  	add	ax, bx
  2266 000012B2 66D1D8                  	rcr	ax, 1
  2267 000012B5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2268 000012B8 66AB                    	stosw		; this is interpolated sample (L)
  2269 000012BA 66AB                    	stosw		; this is interpolated sample (R)
  2270                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2271 000012BC 09C9                    	or	ecx, ecx
  2272 000012BE 75DE                    	jnz	short lff24m2_1
  2273 000012C0 E9ACF8FFFF              	jmp	lff24_3
  2274                                  
  2275                                  lff24m2_7:
  2276                                  lff24s2_7:
  2277 000012C5 E9C8F8FFFF              	jmp	lff24_5  ; error
  2278                                  
  2279                                  load_24khz_stereo_16_bit:
  2280                                  	; 16/11/2023
  2281                                  	; 15/11/2023
  2282 000012CA F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2283                                  					; last of the file?
  2284 000012D1 7402                    	jz	short lff24s2_0		; no
  2285 000012D3 F9                      	stc
  2286 000012D4 C3                      	retn
  2287                                  
  2288                                  lff24s2_0:
  2289 000012D5 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2290                                          ;mov	edx, [loadsize]
  2291                                  
  2292                                  	; esi = buffer address
  2293                                  	;; edx = buffer size
  2294                                  
  2295                                  	; load file into memory
  2296                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000012DA 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000012E0 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000012E2 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000012E8 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000012ED CD40                <1>  int 40h
  2297 000012EF 72D4                    	jc	short lff24s2_7 ; error !
  2298                                  
  2299 000012F1 BF[00300000]            	mov	edi, audio_buffer
  2300                                  	
  2301 000012F6 C1E802                  	shr	eax, 2
  2302 000012F9 7505                    	jnz	short lff24s2_8
  2303 000012FB E989F8FFFF              	jmp	lff24_eof
  2304                                  
  2305                                  lff24s2_8:
  2306 00001300 89C1                    	mov	ecx, eax  ; dword count
  2307                                  lff24s2_1:
  2308 00001302 66AD                    	lodsw
  2309 00001304 66AB                    	stosw		; original sample (L)
  2310 00001306 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2311 00001309 66A3[DE200000]          	mov	[previous_val_l], ax
  2312 0000130F 66AD                    	lodsw
  2313 00001311 66AB                    	stosw		; original sample (R)
  2314 00001313 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2315                                  	;mov	[previous_val_r], ax
  2316 00001316 89C3                    	mov	ebx, eax
  2317 00001318 31D2                    	xor	edx, edx
  2318 0000131A 31C0                    	xor	eax, eax
  2319                                  	; 16/11/2023
  2320 0000131C 49                      	dec	ecx
  2321 0000131D 7407                    	jz	short lff24s2_2
  2322 0000131F 668B06                  	mov	ax, [esi]
  2323 00001322 668B5602                	mov	dx, [esi+2]
  2324                                  lff24s2_2:
  2325 00001326 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2326                                  	;;mov	[next_val_l], ax
  2327                                  	;mov	ebp, eax
  2328 00001329 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2329                                  	;mov	[next_val_r], dx
  2330 0000132C 660305[DE200000]        	add	ax, [previous_val_l]
  2331 00001333 66D1D8                  	rcr	ax, 1
  2332 00001336 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2333 00001339 66AB                    	stosw		; this is interpolated sample (L)
  2334                                  	;mov	ax, [next_val_r]
  2335 0000133B 89D0                    	mov	eax, edx
  2336                                  	;add	ax, [previous_val_r]
  2337 0000133D 6601D8                  	add	ax, bx
  2338 00001340 66D1D8                  	rcr	ax, 1
  2339 00001343 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2340 00001346 66AB                    	stosw		; this is interpolated sample (R)
  2341                                  	
  2342                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2343 00001348 09C9                    	or	ecx, ecx
  2344 0000134A 75B6                    	jnz	short lff24s2_1
  2345 0000134C E920F8FFFF              	jmp	lff24_3
  2346                                  
  2347                                  ; .....................
  2348                                  
  2349                                  load_32khz_mono_8_bit:
  2350                                  	; 15/11/2023
  2351 00001351 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2352                                  					; last of the file?
  2353 00001358 7402                    	jz	short lff32m_0		; no
  2354 0000135A F9                      	stc
  2355 0000135B C3                      	retn
  2356                                  
  2357                                  lff32m_0:
  2358 0000135C BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2359                                          ;mov	edx, [loadsize]
  2360                                  
  2361                                  	; esi = buffer address
  2362                                  	;; edx = buffer size
  2363                                  
  2364                                  	; load file into memory
  2365                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001361 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001367 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001369 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000136F B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001374 CD40                <1>  int 40h
  2366 00001376 7247                    	jc	short lff32m_7 ; error !
  2367                                  
  2368 00001378 BF[00300000]            	mov	edi, audio_buffer
  2369                                  	
  2370 0000137D 21C0                    	and	eax, eax
  2371 0000137F 7505                    	jnz	short lff32m_8
  2372 00001381 E903F8FFFF              	jmp	lff32_eof
  2373                                  
  2374                                  lff32m_8:
  2375 00001386 89C1                    	mov	ecx, eax	; byte count
  2376                                  lff32m_1:
  2377 00001388 AC                      	lodsb
  2378                                  	;mov	[previous_val], al
  2379 00001389 88C3                    	mov	bl, al
  2380 0000138B 2C80                    	sub	al, 80h
  2381 0000138D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2382 00001391 66AB                    	stosw		; original sample (left channel)
  2383 00001393 66AB                    	stosw		; original sample (right channel)
  2384                                  	;xor	eax, eax
  2385 00001395 B080                    	mov	al, 80h
  2386 00001397 49                      	dec	ecx
  2387 00001398 7402                    	jz	short lff32m_2
  2388 0000139A 8A06                    	mov	al, [esi]
  2389                                  lff32m_2:
  2390                                  	;;mov	[next_val], al
  2391                                  	;mov	bh, al
  2392                                  	;add	al, [previous_val]
  2393 0000139C 00D8                    	add	al, bl
  2394 0000139E D0D8                    	rcr	al, 1
  2395 000013A0 2C80                    	sub	al, 80h
  2396 000013A2 66C1E008                	shl	ax, 8
  2397 000013A6 66AB                    	stosw		; this is interpolated sample (L)
  2398 000013A8 66AB                    	stosw		; this is interpolated sample (R)
  2399                                  	
  2400                                  	; different than 8-16-24 kHZ !
  2401                                  	; 'original-interpolated-original' trio samples 
  2402 000013AA E30E                    	jecxz	lff32m_3
  2403                                  
  2404 000013AC AC                      	lodsb
  2405 000013AD 2C80                    	sub	al, 80h
  2406 000013AF 66C1E008                	shl	ax, 8
  2407 000013B3 66AB                    	stosw		; original sample (left channel)
  2408 000013B5 66AB                    	stosw		; original sample (right channel)
  2409                                  
  2410                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2411 000013B7 49                      	dec	ecx
  2412 000013B8 75CE                    	jnz	short lff32m_1
  2413                                  lff32m_3:
  2414 000013BA E9B2F7FFFF              	jmp	lff32_3
  2415                                  
  2416                                  lff32m_7:
  2417                                  lff32s_7:
  2418 000013BF E9CEF7FFFF              	jmp	lff32_5  ; error
  2419                                  
  2420                                  load_32khz_stereo_8_bit:
  2421                                  	; 15/11/2023
  2422 000013C4 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2423                                  					; last of the file?
  2424 000013CB 7402                    	jz	short lff32s_0		; no
  2425 000013CD F9                      	stc
  2426 000013CE C3                      	retn
  2427                                  
  2428                                  lff32s_0:
  2429 000013CF BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2430                                          ;mov	edx, [loadsize]
  2431                                  
  2432                                  	; esi = buffer address
  2433                                  	;; edx = buffer size
  2434                                  
  2435                                  	; load file into memory
  2436                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000013D4 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000013DA 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000013DC 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000013E2 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000013E7 CD40                <1>  int 40h
  2437 000013E9 72D4                    	jc	short lff32s_7 ; error !
  2438                                  
  2439 000013EB BF[00300000]            	mov	edi, audio_buffer
  2440                                  	
  2441 000013F0 D1E8                    	shr	eax, 1
  2442 000013F2 7505                    	jnz	short lff32s_8
  2443 000013F4 E990F7FFFF              	jmp	lff32_eof
  2444                                  
  2445                                  lff32s_8:
  2446 000013F9 89C1                    	mov	ecx, eax  ; word count
  2447                                  lff32s_1:
  2448 000013FB AC                      	lodsb
  2449 000013FC A2[DE200000]            	mov	[previous_val_l], al
  2450 00001401 2C80                    	sub	al, 80h
  2451 00001403 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2452 00001407 66AB                    	stosw		; original sample (L)
  2453 00001409 AC                      	lodsb
  2454 0000140A A2[E0200000]            	mov	[previous_val_r], al
  2455 0000140F 2C80                    	sub	al, 80h
  2456 00001411 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2457 00001415 66AB                    	stosw		; original sample (R)
  2458                                  
  2459                                  	;xor	eax, eax
  2460 00001417 66B88080                	mov	ax, 8080h
  2461 0000141B 49                      	dec	ecx
  2462 0000141C 7403                    	jz	short lff32s_2
  2463                                  		; convert 8 bit sample to 16 bit sample
  2464 0000141E 668B06                  	mov	ax, [esi]
  2465                                  lff32s_2:
  2466                                  	;;mov	[next_val_l], al
  2467                                  	;;mov	[next_val_r], ah
  2468                                  	;mov	bx, ax
  2469 00001421 88E7                    	mov	bh, ah
  2470 00001423 0205[DE200000]          	add	al, [previous_val_l]
  2471 00001429 D0D8                    	rcr	al, 1
  2472                                  	;mov	dl, al
  2473 0000142B 2C80                    	sub	al, 80h
  2474 0000142D 66C1E008                	shl	ax, 8
  2475 00001431 66AB                    	stosw		; this is interpolated sample (L)
  2476 00001433 88F8                    	mov	al, bh	; [next_val_r]
  2477 00001435 0205[E0200000]          	add	al, [previous_val_r]
  2478 0000143B D0D8                    	rcr	al, 1
  2479                                  	;mov	dh, al
  2480 0000143D 2C80                    	sub	al, 80h
  2481 0000143F 66C1E008                	shl	ax, 8
  2482 00001443 66AB                    	stosw		; this is interpolated sample (R)
  2483                                  
  2484                                  	; different than 8-16-24 kHZ !
  2485                                  	; 'original-interpolated-original' trio samples 
  2486 00001445 E315                    	jecxz	lff32s_3
  2487                                  
  2488 00001447 AC                      	lodsb
  2489 00001448 2C80                    	sub	al, 80h
  2490 0000144A 66C1E008                	shl	ax, 8
  2491 0000144E 66AB                    	stosw		; original sample (left channel)
  2492                                  
  2493 00001450 AC                      	lodsb
  2494 00001451 2C80                    	sub	al, 80h
  2495 00001453 66C1E008                	shl	ax, 8
  2496 00001457 66AB                    	stosw		; original sample (right channel)
  2497                                  		
  2498                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2499 00001459 49                      	dec	ecx
  2500 0000145A 759F                    	jnz	short lff32s_1
  2501                                  lff32s_3:
  2502 0000145C E910F7FFFF              	jmp	lff32_3
  2503                                  
  2504                                  load_32khz_mono_16_bit:
  2505                                  	; 15/11/2023
  2506 00001461 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2507                                  					; last of the file?
  2508 00001468 7402                    	jz	short lff32m2_0		; no
  2509 0000146A F9                      	stc
  2510 0000146B C3                      	retn
  2511                                  
  2512                                  lff32m2_0:
  2513 0000146C BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2514                                          ;mov	edx, [loadsize]
  2515                                  
  2516                                  	; esi = buffer address
  2517                                  	;; edx = buffer size
  2518                                  
  2519                                  	; load file into memory
  2520                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001471 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001477 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001479 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000147F B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001484 CD40                <1>  int 40h
  2521 00001486 723E                    	jc	short lff32m2_7 ; error !
  2522                                  
  2523 00001488 BF[00300000]            	mov	edi, audio_buffer
  2524                                  	
  2525 0000148D D1E8                    	shr	eax, 1
  2526 0000148F 7505                    	jnz	short lff32m2_8
  2527 00001491 E9F3F6FFFF              	jmp	lff32_eof
  2528                                  
  2529                                  lff32m2_8:
  2530 00001496 89C1                    	mov	ecx, eax  ; word count
  2531                                  lff32m2_1:
  2532 00001498 66AD                    	lodsw
  2533 0000149A 66AB                    	stosw		; original sample (left channel)
  2534 0000149C 66AB                    	stosw		; original sample (right channel)
  2535 0000149E 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2536                                  	;mov	[previous_val], ax
  2537                                  	;mov	ebx, eax	
  2538                                  	;xor	eax, eax
  2539 000014A1 31DB                    	xor	ebx, ebx
  2540 000014A3 49                      	dec	ecx
  2541 000014A4 7403                    	jz	short lff32m2_2
  2542                                  	;mov	ax, [esi]
  2543 000014A6 668B1E                  	mov	bx, [esi]
  2544                                  lff32m2_2:
  2545                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2546                                  	;mov	ebp, eax	; [next_val]
  2547                                  	;add	ax, [previous_val]
  2548                                  	; ax = [previous_val]
  2549                                  	; bx = [next_val]
  2550 000014A9 6601D8                  	add	ax, bx
  2551 000014AC 66D1D8                  	rcr	ax, 1
  2552 000014AF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2553 000014B2 66AB                    	stosw		; this is interpolated sample (L)
  2554 000014B4 66AB                    	stosw		; this is interpolated sample (R)
  2555                                  
  2556                                  	; different than 8-16-24 kHZ !
  2557                                  	; 'original-interpolated-original' trio samples 
  2558 000014B6 E309                    	jecxz	lff32m2_3
  2559                                  
  2560 000014B8 66AD                    	lodsw
  2561 000014BA 66AB                    	stosw		; original sample (left channel)
  2562 000014BC 66AB                    	stosw		; original sample (right channel)
  2563                                  
  2564                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2565 000014BE 49                      	dec	ecx
  2566 000014BF 75D7                    	jnz	short lff32m2_1
  2567                                  lff32m2_3:
  2568 000014C1 E9ABF6FFFF              	jmp	lff32_3
  2569                                  
  2570                                  lff32m2_7:
  2571                                  lff32s2_7:
  2572 000014C6 E9C7F6FFFF              	jmp	lff32_5  ; error
  2573                                  
  2574                                  load_32khz_stereo_16_bit:
  2575                                  	; 16/11/2023
  2576                                  	; 15/11/2023
  2577 000014CB F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2578                                  					; last of the file?
  2579 000014D2 7402                    	jz	short lff32s2_0		; no
  2580 000014D4 F9                      	stc
  2581 000014D5 C3                      	retn
  2582                                  
  2583                                  lff32s2_0:
  2584 000014D6 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2585                                          ;mov	edx, [loadsize]
  2586                                  
  2587                                  	; esi = buffer address
  2588                                  	;; edx = buffer size
  2589                                  
  2590                                  	; load file into memory
  2591                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000014DB 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000014E1 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000014E3 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000014E9 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000014EE CD40                <1>  int 40h
  2592 000014F0 72D4                    	jc	short lff32s2_7 ; error !
  2593                                  
  2594 000014F2 BF[00300000]            	mov	edi, audio_buffer
  2595                                  	
  2596 000014F7 C1E802                  	shr	eax, 2
  2597 000014FA 7505                    	jnz	short lff32s2_8
  2598 000014FC E988F6FFFF              	jmp	lff32_eof
  2599                                  
  2600                                  lff32s2_8:
  2601 00001501 89C1                    	mov	ecx, eax ; dword count
  2602                                  lff32s2_1:
  2603 00001503 66AD                    	lodsw
  2604 00001505 66AB                    	stosw		; original sample (L)
  2605 00001507 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2606 0000150A 66A3[DE200000]          	mov	[previous_val_l], ax
  2607 00001510 66AD                    	lodsw
  2608 00001512 66AB                    	stosw		; original sample (R)
  2609 00001514 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2610                                  	;mov	[previous_val_r], ax
  2611 00001517 89C3                    	mov	ebx, eax
  2612 00001519 31D2                    	xor	edx, edx
  2613 0000151B 31C0                    	xor	eax, eax
  2614                                  	; 16/11/2023
  2615 0000151D 49                      	dec	ecx
  2616 0000151E 7407                    	jz	short lff32s2_2
  2617 00001520 668B06                  	mov	ax, [esi]
  2618 00001523 668B5602                	mov	dx, [esi+2]
  2619                                  lff32s2_2:
  2620 00001527 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2621                                  	;;mov	[next_val_l], ax
  2622                                  	;mov	ebp, eax
  2623 0000152A 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2624                                  	;mov	[next_val_r], dx
  2625 0000152D 660305[DE200000]        	add	ax, [previous_val_l]
  2626 00001534 66D1D8                  	rcr	ax, 1
  2627 00001537 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2628 0000153A 66AB                    	stosw		; this is interpolated sample (L)
  2629                                  	;mov	ax, [next_val_r]
  2630 0000153C 89D0                    	mov	eax, edx
  2631                                  	;add	ax, [previous_val_r]
  2632 0000153E 6601D8                  	add	ax, bx
  2633 00001541 66D1D8                  	rcr	ax, 1
  2634 00001544 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2635 00001547 66AB                    	stosw		; this is interpolated sample (R)
  2636                                  
  2637                                  	; different than 8-16-24 kHZ !
  2638                                  	; 'original-interpolated-original' trio samples 
  2639 00001549 E30B                    	jecxz	lff32s2_3
  2640                                  
  2641 0000154B 66AD                    	lodsw
  2642 0000154D 66AB                    	stosw	; original sample (L)
  2643 0000154F 66AD                    	lodsw
  2644 00001551 66AB                    	stosw	; original sample (R)
  2645                                  	
  2646                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2647 00001553 49                      	dec	ecx
  2648 00001554 75AD                    	jnz	short lff32s2_1
  2649                                  lff32s2_3:
  2650 00001556 E916F6FFFF              	jmp	lff32_3
  2651                                  
  2652                                  ; .....................
  2653                                  
  2654                                  load_22khz_mono_8_bit:
  2655                                  	; 16/11/2023
  2656 0000155B F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2657                                  					; last of the file?
  2658 00001562 7402                    	jz	short lff22m_0		; no
  2659 00001564 F9                      	stc
  2660 00001565 C3                      	retn
  2661                                  
  2662                                  lff22m_0:
  2663 00001566 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2664                                          ;mov	edx, [loadsize]
  2665                                  
  2666                                  	; esi = buffer address
  2667                                  	;; edx = buffer size
  2668                                  
  2669                                  	; load file into memory
  2670                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000156B 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001571 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001573 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001579 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000157E CD40                <1>  int 40h
  2671 00001580 725D                    	jc	short lff22m_7 ; error !
  2672                                  
  2673 00001582 BF[00300000]            	mov	edi, audio_buffer
  2674                                  	
  2675 00001587 21C0                    	and	eax, eax
  2676 00001589 7505                    	jnz	short lff22m_8
  2677 0000158B E9F9F5FFFF              	jmp	lff22_eof
  2678                                  
  2679                                  lff22m_8:
  2680 00001590 89C1                    	mov	ecx, eax	; byte count
  2681                                  lff22m_9:
  2682 00001592 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2683 00001597 C605[E6200000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2684                                  lff22m_1:
  2685                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2686 0000159E AC                      	lodsb
  2687 0000159F B280                    	mov	dl, 80h
  2688 000015A1 49                      	dec	ecx
  2689 000015A2 7402                    	jz	short lff22m_2_1
  2690 000015A4 8A16                    	mov	dl, [esi]
  2691                                  lff22m_2_1:	
  2692                                  	; al = [previous_val]
  2693                                  	; dl = [next_val]
  2694 000015A6 E8EF050000              	call	interpolating_3_8bit_mono ; 1 of 17
  2695 000015AB E32D                    	jecxz	lff22m_3
  2696                                  lff22m_2_2:
  2697 000015AD AC                      	lodsb
  2698 000015AE B280                    	mov	dl, 80h
  2699 000015B0 49                      	dec	ecx
  2700 000015B1 7402                    	jz	short lff22m_2_3
  2701 000015B3 8A16                    	mov	dl, [esi]
  2702                                  lff22m_2_3:
  2703 000015B5 E864060000               	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2704 000015BA E31E                    	jecxz	lff22m_3
  2705 000015BC 4D                      	dec	ebp
  2706 000015BD 75EE                    	jnz	short lff22m_2_2
  2707                                  
  2708 000015BF A0[E6200000]            	mov	al, [faz]
  2709 000015C4 FEC8                    	dec	al
  2710 000015C6 74CA                    	jz	short lff22m_9
  2711 000015C8 FE0D[E6200000]          	dec	byte [faz]
  2712 000015CE BD04000000              	mov	ebp, 4
  2713 000015D3 FEC8                    	dec	al
  2714 000015D5 75C7                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2715 000015D7 45                      	inc	ebp ; 5
  2716 000015D8 EBC4                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2717                                  
  2718                                  lff22m_3:
  2719                                  lff22s_3:
  2720 000015DA E992F5FFFF              	jmp	lff22_3	; padfill
  2721                                  		; (put zeros in the remain words of the buffer)
  2722                                  lff22m_7:
  2723                                  lff22s_7:
  2724 000015DF E9AEF5FFFF              	jmp	lff22_5  ; error
  2725                                  
  2726                                  load_22khz_stereo_8_bit:
  2727                                  	; 16/11/2023
  2728 000015E4 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2729                                  					; last of the file?
  2730 000015EB 7402                    	jz	short lff22s_0		; no
  2731 000015ED F9                      	stc
  2732 000015EE C3                      	retn
  2733                                  
  2734                                  lff22s_0:
  2735 000015EF BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2736                                          ;mov	edx, [loadsize]
  2737                                  
  2738                                  	; esi = buffer address
  2739                                  	;; edx = buffer size
  2740                                  
  2741                                  	; load file into memory
  2742                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000015F4 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000015FA 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000015FC 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001602 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001607 CD40                <1>  int 40h
  2743 00001609 72D4                    	jc	short lff22s_7 ; error !
  2744                                  
  2745 0000160B BF[00300000]            	mov	edi, audio_buffer
  2746                                  	
  2747 00001610 D1E8                    	shr	eax, 1
  2748 00001612 7505                    	jnz	short lff22s_8
  2749 00001614 E970F5FFFF              	jmp	lff22_eof
  2750                                  
  2751                                  lff22s_8:
  2752 00001619 89C1                    	mov	ecx, eax	; word count
  2753                                  lff22s_9:
  2754 0000161B BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2755 00001620 C605[E6200000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2756                                  lff22s_1:
  2757                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2758 00001627 66AD                    	lodsw
  2759 00001629 66BA8080                	mov	dx, 8080h
  2760 0000162D 49                      	dec	ecx
  2761 0000162E 7403                    	jz	short lff22s_2_1 
  2762 00001630 668B16                  	mov	dx, [esi]
  2763                                  lff22s_2_1:	
  2764                                  	; al = [previous_val_l]
  2765                                  	; ah = [previous_val_r]
  2766                                  	; dl = [next_val_l]
  2767                                  	; dh = [next_val_r]	
  2768 00001633 E893050000              	call	interpolating_3_8bit_stereo ; 1 of 17 
  2769 00001638 E3A0                    	jecxz	lff22s_3
  2770                                  lff22s_2_2:
  2771 0000163A 66AD                    	lodsw
  2772 0000163C 66BA8080                	mov	dx, 8080h
  2773 00001640 49                      	dec	ecx
  2774 00001641 7403                    	jz	short lff22s_2_3
  2775 00001643 668B16                  	mov	dx, [esi]
  2776                                  lff22s_2_3:
  2777 00001646 E8F0050000               	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2778 0000164B E38D                    	jecxz	lff22s_3
  2779 0000164D 4D                      	dec	ebp
  2780 0000164E 75EA                    	jnz	short lff22s_2_2
  2781                                  
  2782 00001650 A0[E6200000]            	mov	al, [faz]
  2783 00001655 FEC8                    	dec	al
  2784 00001657 74C2                    	jz	short lff22s_9
  2785 00001659 FE0D[E6200000]          	dec	byte [faz]
  2786 0000165F BD04000000              	mov	ebp, 4
  2787 00001664 FEC8                    	dec	al
  2788 00001666 75BF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2789 00001668 45                      	inc	ebp ; 5
  2790 00001669 EBBC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2791                                  
  2792                                  load_22khz_mono_16_bit:
  2793                                  	; 16/11/2023
  2794 0000166B F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2795                                  					; last of the file?
  2796 00001672 7402                    	jz	short lff22m2_0		; no
  2797 00001674 F9                      	stc
  2798 00001675 C3                      	retn
  2799                                  
  2800                                  lff22m2_0:
  2801 00001676 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2802                                          ;mov	edx, [loadsize]
  2803                                  
  2804                                  	; esi = buffer address
  2805                                  	;; edx = buffer size
  2806                                  
  2807                                  	; load file into memory
  2808                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000167B 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001681 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001683 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001689 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000168E CD40                <1>  int 40h
  2809 00001690 7261                    	jc	short lff22m2_7 ; error !
  2810                                  
  2811 00001692 BF[00300000]            	mov	edi, audio_buffer
  2812                                  	
  2813 00001697 D1E8                    	shr	eax, 1
  2814 00001699 7505                    	jnz	short lff22m2_8
  2815 0000169B E9E9F4FFFF              	jmp	lff22_eof
  2816                                  
  2817                                  lff22m2_8:
  2818 000016A0 89C1                    	mov	ecx, eax	; word count
  2819                                  lff22m2_9:
  2820 000016A2 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2821 000016A7 C605[E6200000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2822                                  lff22m2_1:
  2823                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2824 000016AE 66AD                    	lodsw
  2825 000016B0 31D2                    	xor	edx, edx
  2826 000016B2 49                      	dec	ecx
  2827 000016B3 7403                    	jz	short lff22m2_2_1
  2828 000016B5 668B16                  	mov	dx, [esi]
  2829                                  lff22m2_2_1:	
  2830                                  	; ax = [previous_val]
  2831                                  	; dx = [next_val]
  2832 000016B8 E8AF050000              	call	interpolating_3_16bit_mono ; 1 of 17
  2833 000016BD E32F                    	jecxz	lff22m2_3
  2834                                  lff22m2_2_2:
  2835 000016BF 66AD                    	lodsw
  2836 000016C1 31D2                    	xor	edx, edx
  2837 000016C3 49                      	dec	ecx
  2838 000016C4 7403                    	jz	short lff22m2_2_3
  2839 000016C6 668B16                  	mov	dx, [esi]
  2840                                  lff22m2_2_3:
  2841 000016C9 E831060000               	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2842 000016CE E31E                    	jecxz	lff22m2_3
  2843 000016D0 4D                      	dec	ebp
  2844 000016D1 75EC                    	jnz	short lff22m2_2_2
  2845                                  
  2846 000016D3 A0[E6200000]            	mov	al, [faz]
  2847 000016D8 FEC8                    	dec	al
  2848 000016DA 74C6                    	jz	short lff22m2_9
  2849 000016DC FE0D[E6200000]          	dec	byte [faz]
  2850 000016E2 BD04000000              	mov	ebp, 4
  2851 000016E7 FEC8                    	dec	al
  2852 000016E9 75C3                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2853 000016EB 45                      	inc	ebp ; 5
  2854 000016EC EBC0                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2855                                  
  2856                                  lff22m2_3:
  2857                                  lff22s2_3:
  2858 000016EE E97EF4FFFF              	jmp	lff22_3	; padfill
  2859                                  		; (put zeros in the remain words of the buffer)
  2860                                  lff22m2_7:
  2861                                  lff22s2_7:
  2862 000016F3 E99AF4FFFF              	jmp	lff22_5  ; error
  2863                                  
  2864                                  load_22khz_stereo_16_bit:
  2865                                  	; 16/11/2023
  2866 000016F8 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2867                                  					; last of the file?
  2868 000016FF 7402                    	jz	short lff22s2_0		; no
  2869 00001701 F9                      	stc
  2870 00001702 C3                      	retn
  2871                                  
  2872                                  lff22s2_0:
  2873 00001703 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2874                                          ;mov	edx, [loadsize]
  2875                                  
  2876                                  	; esi = buffer address
  2877                                  	;; edx = buffer size
  2878                                  
  2879                                  	; load file into memory
  2880                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001708 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000170E 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001710 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001716 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000171B CD40                <1>  int 40h
  2881 0000171D 72D4                    	jc	short lff22s2_7 ; error !
  2882                                  
  2883 0000171F BF[00300000]            	mov	edi, audio_buffer
  2884                                  	
  2885 00001724 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  2886 00001727 7505                    	jnz	short lff22s2_8
  2887 00001729 E95BF4FFFF              	jmp	lff22_eof
  2888                                  
  2889                                  lff22s2_8:
  2890 0000172E 89C1                    	mov	ecx, eax	; dword count
  2891                                  lff22s2_9:
  2892 00001730 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2893 00001735 C605[E6200000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2894                                  lff22s2_1:
  2895                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2896 0000173C 66AD                    	lodsw
  2897 0000173E 89C3                    	mov	ebx, eax
  2898 00001740 66AD                    	lodsw
  2899 00001742 8B16                    	mov	edx, [esi]
  2900 00001744 668915[E2200000]        	mov	[next_val_l], dx
  2901                                  	; 26/11/2023
  2902 0000174B C1EA10                  	shr	edx, 16
  2903 0000174E 49                      	dec	ecx
  2904 0000174F 7509                    	jnz	short lff22s2_2_1
  2905 00001751 31D2                    	xor	edx, edx ; 0
  2906 00001753 668915[E2200000]        	mov	[next_val_l], dx
  2907                                  lff22s2_2_1:
  2908                                  	; bx = [previous_val_l]
  2909                                  	; ax = [previous_val_r]
  2910                                  	; [next_val_l]
  2911                                  	; dx = [next_val_r]
  2912 0000175A E83D050000              	call	interpolating_3_16bit_stereo ; 1 of 17 
  2913 0000175F E38D                    	jecxz	lff22s2_3
  2914                                  lff22s2_2_2:
  2915 00001761 66AD                    	lodsw
  2916 00001763 89C3                    	mov	ebx, eax
  2917 00001765 66AD                    	lodsw
  2918 00001767 8B16                    	mov	edx, [esi]
  2919 00001769 668915[E2200000]        	mov	[next_val_l], dx
  2920                                  	; 26/11/2023
  2921 00001770 C1EA10                  	shr	edx, 16
  2922 00001773 49                      	dec	ecx
  2923 00001774 7509                    	jnz	short lff22s2_2_3
  2924 00001776 31D2                    	xor	edx, edx ; 0
  2925 00001778 668915[E2200000]        	mov	[next_val_l], dx
  2926                                  lff22s2_2_3:
  2927 0000177F E893050000               	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  2928 00001784 E31E                    	jecxz	lff22s2_2_4
  2929                                  
  2930 00001786 4D                      	dec	ebp
  2931 00001787 75D8                    	jnz	short lff22s2_2_2
  2932                                  
  2933 00001789 A0[E6200000]            	mov	al, [faz]
  2934 0000178E FEC8                    	dec	al
  2935 00001790 749E                    	jz	short lff22s2_9
  2936 00001792 FE0D[E6200000]          	dec	byte [faz]
  2937 00001798 BD04000000              	mov	ebp, 4
  2938 0000179D FEC8                    	dec	al
  2939 0000179F 759B                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2940 000017A1 45                      	inc	ebp ; 5
  2941 000017A2 EB98                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2942                                  
  2943                                  lff22s2_2_4:
  2944                                  	; 26/11/2023
  2945 000017A4 E9C8F3FFFF              	jmp	lff22_3	; padfill
  2946                                  
  2947                                  ; .....................
  2948                                  
  2949                                  load_11khz_mono_8_bit:
  2950                                  	; 18/11/2023
  2951 000017A9 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2952                                  					; last of the file?
  2953 000017B0 7402                    	jz	short lff11m_0		; no
  2954 000017B2 F9                      	stc
  2955 000017B3 C3                      	retn
  2956                                  
  2957                                  lff11m_0:
  2958 000017B4 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2959                                          ;mov	edx, [loadsize]
  2960                                  
  2961                                  	; esi = buffer address
  2962                                  	;; edx = buffer size
  2963                                  
  2964                                  	; load file into memory
  2965                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000017B9 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000017BF 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000017C1 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000017C7 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000017CC CD40                <1>  int 40h
  2966 000017CE 7247                    	jc	short lff11m_7 ; error !
  2967                                  
  2968 000017D0 BF[00300000]            	mov	edi, audio_buffer
  2969                                  	
  2970 000017D5 21C0                    	and	eax, eax
  2971 000017D7 7505                    	jnz	short lff11m_8
  2972 000017D9 E9ABF3FFFF              	jmp	lff11_eof
  2973                                  
  2974                                  lff11m_8:
  2975 000017DE 89C1                    	mov	ecx, eax		; byte count
  2976                                  lff11m_9:
  2977 000017E0 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  2978                                  lff11m_1:
  2979                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2980 000017E5 AC                      	lodsb
  2981 000017E6 B280                    	mov	dl, 80h
  2982 000017E8 49                      	dec	ecx
  2983 000017E9 7402                    	jz	short lff11m_2_1
  2984 000017EB 8A16                    	mov	dl, [esi]
  2985                                  lff11m_2_1:	
  2986                                  	; al = [previous_val]
  2987                                  	; dl = [next_val]
  2988 000017ED E854050000              	call	interpolating_5_8bit_mono
  2989 000017F2 E328                    	jecxz	lff11m_3
  2990                                  lff11m_2_2:
  2991 000017F4 AC                      	lodsb
  2992 000017F5 B280                    	mov	dl, 80h
  2993 000017F7 49                      	dec	ecx
  2994 000017F8 7402                    	jz	short lff11m_2_3
  2995 000017FA 8A16                    	mov	dl, [esi]
  2996                                  lff11m_2_3:
  2997 000017FC E851060000               	call	interpolating_4_8bit_mono
  2998 00001801 E319                    	jecxz	lff11m_3
  2999                                  
  3000 00001803 4D                      	dec	ebp
  3001 00001804 74DA                    	jz	short lff11m_9
  3002                                  
  3003 00001806 AC                      	lodsb
  3004 00001807 B280                    	mov	dl, 80h
  3005 00001809 49                      	dec	ecx
  3006 0000180A 7402                    	jz	short lff11m_2_4
  3007 0000180C 8A16                    	mov	dl, [esi]
  3008                                  lff11m_2_4:
  3009 0000180E E83F060000              	call	interpolating_4_8bit_mono
  3010 00001813 E307                    	jecxz	lff11m_3
  3011 00001815 EBCE                    	jmp	short lff11m_1
  3012                                  
  3013                                  lff11m_7:
  3014                                  lff11s_7:
  3015 00001817 E976F3FFFF              	jmp	lff11_5  ; error
  3016                                  
  3017                                  lff11m_3:
  3018                                  lff11s_3:
  3019 0000181C E950F3FFFF              	jmp	lff11_3	; padfill
  3020                                  		; (put zeros in the remain words of the buffer)
  3021                                  
  3022                                  load_11khz_stereo_8_bit:
  3023                                  	; 18/11/2023
  3024 00001821 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3025                                  					; last of the file?
  3026 00001828 7402                    	jz	short lff11s_0		; no
  3027 0000182A F9                      	stc
  3028 0000182B C3                      	retn
  3029                                  
  3030                                  lff11s_0:
  3031 0000182C BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3032                                          ;mov	edx, [loadsize]
  3033                                  
  3034                                  	; esi = buffer address
  3035                                  	;; edx = buffer size
  3036                                  
  3037                                  	; load file into memory
  3038                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001831 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001837 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001839 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000183F B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001844 CD40                <1>  int 40h
  3039 00001846 72CF                    	jc	short lff11s_7 ; error !
  3040                                  
  3041 00001848 BF[00300000]            	mov	edi, audio_buffer
  3042                                  	
  3043 0000184D D1E8                    	shr	eax, 1
  3044 0000184F 7505                    	jnz	short lff11s_8
  3045 00001851 E933F3FFFF              	jmp	lff11_eof
  3046                                  
  3047                                  lff11s_8:
  3048 00001856 89C1                    	mov	ecx, eax	; word count
  3049                                  lff11s_9:
  3050 00001858 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3051                                  lff11s_1:
  3052                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3053 0000185D 66AD                    	lodsw
  3054 0000185F 66BA8080                	mov	dx, 8080h
  3055 00001863 49                      	dec	ecx
  3056 00001864 7403                    	jz	short lff11s_2_1 
  3057 00001866 668B16                  	mov	dx, [esi]
  3058                                  lff11s_2_1:	
  3059                                  	; al = [previous_val_l]
  3060                                  	; ah = [previous_val_r]
  3061                                  	; dl = [next_val_l]
  3062                                  	; dh = [next_val_r]	
  3063 00001869 E837050000              	call	interpolating_5_8bit_stereo
  3064 0000186E E3AC                    	jecxz	lff11s_3
  3065                                  lff11s_2_2:
  3066 00001870 66AD                    	lodsw
  3067 00001872 66BA8080                	mov	dx, 8080h
  3068 00001876 49                      	dec	ecx
  3069 00001877 7403                    	jz	short lff11s_2_3
  3070 00001879 668B16                  	mov	dx, [esi]
  3071                                  lff11s_2_3:
  3072 0000187C E810060000               	call	interpolating_4_8bit_stereo
  3073 00001881 E399                    	jecxz	lff11s_3
  3074                                  	
  3075 00001883 4D                      	dec	ebp
  3076 00001884 74D2                    	jz	short lff11s_9
  3077                                  
  3078 00001886 66AD                    	lodsw
  3079 00001888 66BA8080                	mov	dx, 8080h
  3080 0000188C 49                      	dec	ecx
  3081 0000188D 7403                    	jz	short lff11s_2_4
  3082 0000188F 668B16                  	mov	dx, [esi]
  3083                                  lff11s_2_4:
  3084 00001892 E8FA050000              	call	interpolating_4_8bit_stereo
  3085 00001897 E383                    	jecxz	lff11s_3
  3086 00001899 EBC2                    	jmp	short lff11s_1
  3087                                  
  3088                                  load_11khz_mono_16_bit:
  3089                                  	; 18/11/2023
  3090 0000189B F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3091                                  					; last of the file?
  3092 000018A2 7402                    	jz	short lff11m2_0		; no
  3093 000018A4 F9                      	stc
  3094 000018A5 C3                      	retn
  3095                                  
  3096                                  lff11m2_0:
  3097 000018A6 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3098                                          ;mov	edx, [loadsize]
  3099                                  
  3100                                  	; esi = buffer address
  3101                                  	;; edx = buffer size
  3102                                  
  3103                                  	; load file into memory
  3104                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000018AB 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000018B1 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000018B3 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000018B9 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000018BE CD40                <1>  int 40h
  3105 000018C0 724D                    	jc	short lff11m2_7 ; error !
  3106                                  
  3107 000018C2 BF[00300000]            	mov	edi, audio_buffer
  3108                                  	
  3109 000018C7 D1E8                    	shr	eax, 1
  3110 000018C9 7505                    	jnz	short lff11m2_8
  3111 000018CB E9B9F2FFFF              	jmp	lff11_eof
  3112                                  
  3113                                  lff11m2_8:
  3114 000018D0 89C1                    	mov	ecx, eax	; word count
  3115                                  lff11m2_9:
  3116 000018D2 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3117                                  lff11m2_1:
  3118                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3119 000018D7 66AD                    	lodsw
  3120 000018D9 31D2                    	xor	edx, edx
  3121 000018DB 49                      	dec	ecx
  3122 000018DC 7403                    	jz	short lff11m2_2_1
  3123 000018DE 668B16                  	mov	dx, [esi]
  3124                                  lff11m2_2_1:	
  3125                                  	; ax = [previous_val]
  3126                                  	; dx = [next_val]
  3127 000018E1 E818060000              	call	interpolating_5_16bit_mono
  3128 000018E6 E362                    	jecxz	lff11m2_3
  3129                                  lff11m2_2_2:
  3130 000018E8 66AD                    	lodsw
  3131 000018EA 31D2                    	xor	edx, edx
  3132 000018EC 49                      	dec	ecx
  3133 000018ED 7403                    	jz	short lff11m2_2_3
  3134 000018EF 668B16                  	mov	dx, [esi]
  3135                                  lff11m2_2_3:
  3136 000018F2 E831070000               	call	interpolating_4_16bit_mono
  3137 000018F7 E351                    	jecxz	lff11m2_3
  3138                                  
  3139 000018F9 4D                      	dec	ebp
  3140 000018FA 74D6                    	jz	short lff11m2_9
  3141                                  
  3142 000018FC 66AD                    	lodsw
  3143 000018FE 31D2                    	xor	edx, edx
  3144 00001900 49                      	dec	ecx
  3145 00001901 7403                    	jz	short lff11m2_2_4
  3146 00001903 668B16                  	mov	dx, [esi]
  3147                                  lff11m2_2_4:
  3148 00001906 E81D070000               	call	interpolating_4_16bit_mono
  3149 0000190B E33D                    	jecxz	lff11m2_3
  3150 0000190D EBC8                    	jmp	short lff11m2_1
  3151                                  
  3152                                  lff11m2_7:
  3153                                  lff11s2_7:
  3154 0000190F E97EF2FFFF              	jmp	lff11_5  ; error
  3155                                  
  3156                                  load_11khz_stereo_16_bit:
  3157                                  	; 17/01/2025
  3158                                  	; 18/11/2023
  3159 00001914 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3160                                  					; last of the file?
  3161 0000191B 7402                    	jz	short lff11s2_0		; no
  3162 0000191D F9                      	stc
  3163 0000191E C3                      	retn
  3164                                  
  3165                                  lff11s2_0:
  3166 0000191F BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3167                                          ;mov	edx, [loadsize]
  3168                                  
  3169                                  	; esi = buffer address
  3170                                  	;; edx = buffer size
  3171                                  
  3172                                  	; load file into memory
  3173                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001924 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000192A 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000192C 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001932 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001937 CD40                <1>  int 40h
  3174 00001939 72D4                    	jc	short lff11s2_7 ; error !
  3175                                  
  3176 0000193B BF[00300000]            	mov	edi, audio_buffer
  3177                                  	
  3178 00001940 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3179 00001943 750A                    	jnz	short lff11s2_8
  3180 00001945 E93FF2FFFF              	jmp	lff11_eof
  3181                                  
  3182                                  lff11m2_3:
  3183                                  lff11s2_3:
  3184 0000194A E922F2FFFF              	jmp	lff11_3	; padfill
  3185                                  		; (put zeros in the remain words of the buffer)
  3186                                  
  3187                                  lff11s2_8:
  3188 0000194F 89C1                    	mov	ecx, eax	; dword count
  3189                                  lff11s2_9:
  3190 00001951 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3191                                  lff11s2_1:
  3192                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3193 00001956 66AD                    	lodsw
  3194 00001958 89C3                    	mov	ebx, eax
  3195 0000195A 66AD                    	lodsw
  3196 0000195C 8B16                    	mov	edx, [esi]
  3197                                  	; 17/01/2025
  3198                                  	;mov	[next_val_l], edx
  3199                                  	; 26/11/2023
  3200                                  	;shr	edx, 16
  3201                                  	;mov	[next_val_r], dx
  3202 0000195E 49                      	dec	ecx
  3203 0000195F 7502                    	jnz	short lff11s2_2_1
  3204 00001961 31D2                    	xor	edx, edx ; 0
  3205                                  	;mov	[next_val_l], dx
  3206                                  	;mov	[next_val_r], dx
  3207                                  lff11s2_2_1:
  3208                                  	; bx = [previous_val_l]
  3209                                  	; ax = [previous_val_r]
  3210                                  	; [next_val_l]
  3211                                  	; dx = [next_val_r]
  3212                                  	;;;
  3213                                  	; 17/01/2025 (BugFix)
  3214 00001963 8915[E2200000]          	mov	[next_val_l], edx
  3215                                  	;;;
  3216 00001969 E8EB050000              	call	interpolating_5_16bit_stereo
  3217 0000196E E3DA                    	jecxz	lff11s2_3
  3218                                  lff11s2_2_2:
  3219 00001970 66AD                    	lodsw
  3220 00001972 89C3                    	mov	ebx, eax
  3221 00001974 66AD                    	lodsw
  3222 00001976 8B16                    	mov	edx, [esi]
  3223                                  	; 17/01/2025
  3224                                  	;mov	[next_val_l], dx
  3225                                  	; 26/11/2023
  3226                                  	;shr	edx, 16
  3227                                  	;mov	[next_val_r], dx
  3228 00001978 49                      	dec	ecx
  3229 00001979 7502                    	jnz	short lff11s2_2_3
  3230 0000197B 31D2                    	xor	edx, edx ; 0
  3231                                  	;mov	[next_val_l], dx
  3232                                  	;mov	[next_val_r], dx
  3233                                  lff11s2_2_3:
  3234                                  	;;;
  3235                                  	; 17/01/2025 (BugFix)
  3236 0000197D 8915[E2200000]          	mov	[next_val_l], edx
  3237                                  	;;;
  3238 00001983 E8D9060000              	call	interpolating_4_16bit_stereo
  3239 00001988 E3C0                    	jecxz	lff11s2_3
  3240                                  	
  3241 0000198A 4D                      	dec	ebp
  3242 0000198B 74C4                    	jz	short lff11s2_9
  3243                                  
  3244 0000198D 66AD                    	lodsw
  3245 0000198F 89C3                    	mov	ebx, eax
  3246 00001991 66AD                    	lodsw
  3247 00001993 8B16                    	mov	edx, [esi]
  3248                                  	; 17/01/2025
  3249                                  	;mov	[next_val_l], dx
  3250                                  	; 26/11/2023
  3251                                  	;shr	edx, 16
  3252                                  	;mov	[next_val_r], dx
  3253 00001995 49                      	dec	ecx
  3254 00001996 7502                    	jnz	short lff11s2_2_4
  3255 00001998 31D2                    	xor	edx, edx ; 0
  3256                                  	;mov	[next_val_l], dx
  3257                                  	;mov	[next_val_r], dx
  3258                                  lff11s2_2_4:
  3259                                  	;;;
  3260                                  	; 17/01/2025 (BugFix)
  3261 0000199A 8915[E2200000]          	mov	[next_val_l], edx
  3262                                  	;;;
  3263 000019A0 E8BC060000               	call	interpolating_4_16bit_stereo
  3264 000019A5 E3A3                    	jecxz	lff11s2_3
  3265 000019A7 EBAD                    	jmp	short lff11s2_1
  3266                                  
  3267                                  ; .....................
  3268                                  
  3269                                  load_44khz_mono_8_bit:
  3270                                  	; 18/11/2023
  3271 000019A9 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3272                                  					; last of the file?
  3273 000019B0 7402                    	jz	short lff44m_0		; no
  3274 000019B2 F9                      	stc
  3275 000019B3 C3                      	retn
  3276                                  
  3277                                  lff44m_0:
  3278 000019B4 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3279                                          ;mov	edx, [loadsize]
  3280                                  
  3281                                  	; esi = buffer address
  3282                                  	;; edx = buffer size
  3283                                  
  3284                                  	; load file into memory
  3285                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000019B9 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000019BF 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000019C1 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000019C7 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000019CC CD40                <1>  int 40h
  3286 000019CE 7250                    	jc	short lff44m_7 ; error !
  3287                                  
  3288 000019D0 BF[00300000]            	mov	edi, audio_buffer
  3289                                  	
  3290 000019D5 21C0                    	and	eax, eax
  3291 000019D7 7505                    	jnz	short lff44m_8
  3292 000019D9 E9ABF1FFFF              	jmp	lff44_eof
  3293                                  
  3294                                  lff44m_8:
  3295 000019DE 89C1                    	mov	ecx, eax	; byte count
  3296                                  lff44m_9:
  3297 000019E0 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3298 000019E5 C605[E6200000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3299                                  lff44m_1:
  3300                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3301                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3302 000019EC AC                      	lodsb
  3303 000019ED B280                    	mov	dl, 80h
  3304 000019EF 49                      	dec	ecx
  3305 000019F0 7402                    	jz	short lff44m_2_1
  3306 000019F2 8A16                    	mov	dl, [esi]
  3307                                  lff44m_2_1:	
  3308                                  	; al = [previous_val]
  3309                                  	; dl = [next_val]
  3310 000019F4 E825020000              	call	interpolating_2_8bit_mono
  3311 000019F9 E320                    	jecxz	lff44m_3
  3312                                  lff44m_2_2:
  3313 000019FB AC                      	lodsb
  3314 000019FC 2C80                    	sub	al, 80h
  3315 000019FE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3316 00001A02 66AB                    	stosw		; (L)
  3317 00001A04 66AB                    	stosw		; (R)	
  3318                                  
  3319 00001A06 49                      	dec	ecx
  3320 00001A07 7412                    	jz	short lff44m_3	
  3321 00001A09 4D                      	dec	ebp
  3322 00001A0A 75EF                    	jnz	short lff44m_2_2
  3323                                  	
  3324 00001A0C FE0D[E6200000]          	dec	byte [faz]
  3325 00001A12 74CC                    	jz	short lff44m_9 
  3326 00001A14 BD0B000000              	mov	ebp, 11
  3327 00001A19 EBD1                    	jmp	short lff44m_1
  3328                                  
  3329                                  lff44m_3:
  3330                                  lff44s_3:
  3331 00001A1B E951F1FFFF              	jmp	lff44_3	; padfill
  3332                                  		; (put zeros in the remain words of the buffer)
  3333                                  lff44m_7:
  3334                                  lff44s_7:
  3335 00001A20 E96DF1FFFF              	jmp	lff44_5  ; error
  3336                                  
  3337                                  load_44khz_stereo_8_bit:
  3338                                  	; 16/11/2023
  3339 00001A25 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3340                                  					; last of the file?
  3341 00001A2C 7402                    	jz	short lff44s_0		; no
  3342 00001A2E F9                      	stc
  3343 00001A2F C3                      	retn
  3344                                  
  3345                                  lff44s_0:
  3346 00001A30 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3347                                          ;mov	edx, [loadsize]
  3348                                  
  3349                                  	; esi = buffer address
  3350                                  	;; edx = buffer size
  3351                                  
  3352                                  	; load file into memory
  3353                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001A35 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001A3B 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001A3D 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001A43 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001A48 CD40                <1>  int 40h
  3354 00001A4A 72D4                    	jc	short lff44s_7 ; error !
  3355                                  
  3356 00001A4C BF[00300000]            	mov	edi, audio_buffer
  3357                                  	
  3358 00001A51 D1E8                    	shr	eax, 1
  3359 00001A53 7505                    	jnz	short lff44s_8
  3360 00001A55 E92FF1FFFF              	jmp	lff44_eof
  3361                                  
  3362                                  lff44s_8:
  3363 00001A5A 89C1                    	mov	ecx, eax	; word count
  3364                                  lff44s_9:
  3365 00001A5C BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3366 00001A61 C605[E6200000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3367                                  lff44s_1:
  3368                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3369                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3370 00001A68 66AD                    	lodsw
  3371 00001A6A 66BA8080                	mov	dx, 8080h
  3372 00001A6E 49                      	dec	ecx
  3373 00001A6F 7403                    	jz	short lff44s_2_1 
  3374 00001A71 668B16                  	mov	dx, [esi]
  3375                                  lff44s_2_1:	
  3376                                  	; al = [previous_val_l]
  3377                                  	; ah = [previous_val_r]
  3378                                  	; dl = [next_val_l]
  3379                                  	; dh = [next_val_r]	
  3380 00001A74 E8C2010000              	call	interpolating_2_8bit_stereo
  3381 00001A79 E3A0                    	jecxz	lff44s_3
  3382                                  lff44s_2_2:
  3383 00001A7B AC                      	lodsb
  3384 00001A7C 2C80                    	sub	al, 80h
  3385 00001A7E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3386 00001A82 66AB                    	stosw		; (L)
  3387 00001A84 AC                      	lodsb
  3388 00001A85 2C80                    	sub	al, 80h
  3389 00001A87 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3390 00001A8B 66AB                    	stosw		; (R)
  3391                                  
  3392 00001A8D 49                      	dec	ecx
  3393 00001A8E 748B                    	jz	short lff44s_3	
  3394 00001A90 4D                      	dec	ebp
  3395 00001A91 75E8                    	jnz	short lff44s_2_2
  3396                                  	
  3397 00001A93 FE0D[E6200000]          	dec	byte [faz]
  3398 00001A99 74C1                    	jz	short lff44s_9 
  3399 00001A9B BD0B000000              	mov	ebp, 11
  3400 00001AA0 EBC6                    	jmp	short lff44s_1
  3401                                  
  3402                                  load_44khz_mono_16_bit:
  3403                                  	; 18/11/2023
  3404 00001AA2 F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3405                                  					; last of the file?
  3406 00001AA9 7402                    	jz	short lff44m2_0		; no
  3407 00001AAB F9                      	stc
  3408 00001AAC C3                      	retn
  3409                                  
  3410                                  lff44m2_0:
  3411 00001AAD BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3412                                          ;mov	edx, [loadsize]
  3413                                  
  3414                                  	; esi = buffer address
  3415                                  	;; edx = buffer size
  3416                                  
  3417                                  	; load file into memory
  3418                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001AB2 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001AB8 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001ABA 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001AC0 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001AC5 CD40                <1>  int 40h
  3419 00001AC7 724D                    	jc	short lff44m2_7 ; error !
  3420                                  
  3421 00001AC9 BF[00300000]            	mov	edi, audio_buffer
  3422                                  	
  3423 00001ACE D1E8                    	shr	eax, 1
  3424 00001AD0 7505                    	jnz	short lff44m2_8
  3425 00001AD2 E9B2F0FFFF              	jmp	lff44_eof
  3426                                  
  3427                                  lff44m2_8:
  3428 00001AD7 89C1                    	mov	ecx, eax	; word count
  3429                                  lff44m2_9:
  3430 00001AD9 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3431 00001ADE C605[E6200000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3432                                  lff44m2_1:
  3433                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3434                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3435 00001AE5 66AD                    	lodsw
  3436 00001AE7 31D2                    	xor	edx, edx
  3437 00001AE9 49                      	dec	ecx
  3438 00001AEA 7403                    	jz	short lff44m2_2_1
  3439 00001AEC 668B16                  	mov	dx, [esi]
  3440                                  lff44m2_2_1:	
  3441                                  	; ax = [previous_val]
  3442                                  	; dx = [next_val]
  3443 00001AEF E80B020000              	call	interpolating_2_16bit_mono
  3444 00001AF4 E31B                    	jecxz	lff44m2_3
  3445                                  lff44m2_2_2:
  3446 00001AF6 66AD                    	lodsw
  3447 00001AF8 66AB                    	stosw		; (L)eft Channel
  3448 00001AFA 66AB                    	stosw		; (R)ight Channel
  3449                                  
  3450 00001AFC 49                      	dec	ecx
  3451 00001AFD 7412                    	jz	short lff44m2_3	
  3452 00001AFF 4D                      	dec	ebp
  3453 00001B00 75F4                    	jnz	short lff44m2_2_2
  3454                                  	
  3455 00001B02 FE0D[E6200000]          	dec	byte [faz]
  3456 00001B08 74CF                    	jz	short lff44m2_9 
  3457 00001B0A BD0B000000              	mov	ebp, 11
  3458 00001B0F EBD4                    	jmp	short lff44m2_1
  3459                                  
  3460                                  lff44m2_3:
  3461                                  lff44s2_3:
  3462 00001B11 E95BF0FFFF              	jmp	lff44_3	; padfill
  3463                                  		; (put zeros in the remain words of the buffer)
  3464                                  lff44m2_7:
  3465                                  lff44s2_7:
  3466 00001B16 E977F0FFFF              	jmp	lff44_5  ; error
  3467                                  
  3468                                  load_44khz_stereo_16_bit:
  3469                                  	; 18/11/2023
  3470 00001B1B F605[20240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3471                                  					; last of the file?
  3472 00001B22 7402                    	jz	short lff44s2_0		; no
  3473 00001B24 F9                      	stc
  3474 00001B25 C3                      	retn
  3475                                  
  3476                                  lff44s2_0:
  3477 00001B26 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3478                                          ;mov	edx, [loadsize]
  3479                                  
  3480                                  	; esi = buffer address
  3481                                  	;; edx = buffer size
  3482                                  
  3483                                  	; load file into memory
  3484                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001B2B 8B1D[E7200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001B31 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001B33 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001B39 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001B3E CD40                <1>  int 40h
  3485 00001B40 72D4                    	jc	short lff44s2_7 ; error !
  3486                                  
  3487 00001B42 BF[00300000]            	mov	edi, audio_buffer
  3488                                  	
  3489 00001B47 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3490 00001B4A 7505                    	jnz	short lff44s2_8
  3491 00001B4C E938F0FFFF              	jmp	lff44_eof
  3492                                  
  3493                                  lff44s2_8:
  3494 00001B51 89C1                    	mov	ecx, eax	; dword count
  3495                                  lff44s2_9:
  3496 00001B53 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3497 00001B58 C605[E6200000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3498                                  lff44s2_1:
  3499                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3500                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3501 00001B5F 66AD                    	lodsw
  3502 00001B61 89C3                    	mov	ebx, eax
  3503 00001B63 66AD                    	lodsw
  3504                                  	;mov	dx, [esi]
  3505                                  	;mov	[next_val_l], dx
  3506                                  	;mov	dx, [esi+2]
  3507                                  	; 26/11/2023
  3508 00001B65 8B16                    	mov	edx, [esi]
  3509 00001B67 668915[E2200000]        	mov	[next_val_l], dx
  3510 00001B6E C1EA10                  	shr	edx, 16
  3511 00001B71 49                      	dec	ecx
  3512 00001B72 7509                    	jnz	short lff44s2_2_1
  3513 00001B74 31D2                    	xor	edx, edx ; 0
  3514 00001B76 668915[E2200000]        	mov	[next_val_l], dx
  3515                                  lff44s2_2_1:
  3516                                  	; bx = [previous_val_l]
  3517                                  	; ax = [previous_val_r]
  3518                                  	; [next_val_l]
  3519                                  	; dx = [next_val_r]
  3520 00001B7D E895010000              	call	interpolating_2_16bit_stereo
  3521 00001B82 E38D                    	jecxz	lff44s2_3
  3522                                  lff44s2_2_2:
  3523                                  	;movsw		; (L)eft Channel
  3524                                  	;movsw		; (R)ight Channel
  3525 00001B84 A5                      	movsd
  3526                                  
  3527 00001B85 49                      	dec	ecx
  3528 00001B86 7489                    	jz	short lff44s2_3	
  3529 00001B88 4D                      	dec	ebp
  3530 00001B89 75F9                    	jnz	short lff44s2_2_2
  3531                                  	
  3532 00001B8B FE0D[E6200000]          	dec	byte [faz]
  3533 00001B91 74C0                    	jz	short lff44s2_9 
  3534 00001B93 BD0B000000              	mov	ebp, 11
  3535 00001B98 EBC5                    	jmp	short lff44s2_1
  3536                                  
  3537                                  ; .....................
  3538                                  
  3539                                  interpolating_3_8bit_mono:
  3540                                  	; 16/11/2023
  3541                                  	; al = [previous_val]
  3542                                  	; dl = [next_val]
  3543                                  	; original-interpolated-interpolated
  3544 00001B9A 88C3                    	mov	bl, al
  3545 00001B9C 2C80                    	sub	al, 80h
  3546 00001B9E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3547 00001BA2 66AB                    	stosw		; original sample (L)
  3548 00001BA4 66AB                    	stosw		; original sample (R)
  3549 00001BA6 88D8                    	mov	al, bl
  3550 00001BA8 00D0                    	add	al, dl	
  3551 00001BAA D0D8                    	rcr	al, 1
  3552 00001BAC 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3553 00001BAE 00D8                    	add	al, bl
  3554 00001BB0 D0D8                    	rcr	al, 1
  3555 00001BB2 2C80                    	sub	al, 80h
  3556 00001BB4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3557 00001BB8 66AB                    	stosw		; interpolated sample 1 (L)
  3558 00001BBA 66AB                    	stosw		; interpolated sample 1 (R)
  3559 00001BBC 88F8                    	mov	al, bh
  3560 00001BBE 00D0                    	add	al, dl	; [next_val]
  3561 00001BC0 D0D8                    	rcr	al, 1
  3562 00001BC2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3563 00001BC6 66AB                    	stosw		; interpolated sample 2 (L)
  3564 00001BC8 66AB                    	stosw		; interpolated sample 2 (R)
  3565 00001BCA C3                      	retn
  3566                                  
  3567                                  interpolating_3_8bit_stereo:
  3568                                  	; 16/11/2023
  3569                                  	; al = [previous_val_l]
  3570                                  	; ah = [previous_val_r]
  3571                                  	; dl = [next_val_l]
  3572                                  	; dh = [next_val_r]	
  3573                                  	; original-interpolated-interpolated
  3574 00001BCB 89C3                    	mov	ebx, eax
  3575 00001BCD 2C80                    	sub	al, 80h
  3576 00001BCF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3577 00001BD3 66AB                    	stosw		; original sample (L)
  3578 00001BD5 88F8                    	mov	al, bh
  3579 00001BD7 2C80                    	sub	al, 80h
  3580 00001BD9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3581 00001BDD 66AB                    	stosw		; original sample (R)
  3582 00001BDF 88D8                    	mov	al, bl
  3583 00001BE1 00D0                    	add	al, dl	; [next_val_l]	
  3584 00001BE3 D0D8                    	rcr	al, 1
  3585 00001BE5 50                      	push	eax ; *	; al = interpolated middle (L) (temporary)
  3586 00001BE6 00D8                    	add	al, bl	; [previous_val_l]
  3587 00001BE8 D0D8                    	rcr	al, 1
  3588 00001BEA 2C80                    	sub	al, 80h
  3589 00001BEC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3590 00001BF0 66AB                    	stosw		; interpolated sample 1 (L)
  3591 00001BF2 88F8                    	mov	al, bh
  3592 00001BF4 00F0                    	add	al, dh	; [next_val_r]
  3593 00001BF6 D0D8                    	rcr	al, 1
  3594 00001BF8 50                      	push	eax ; ** ; al = interpolated middle (R) (temporary)
  3595 00001BF9 00F8                    	add	al, bh	; [previous_val_r]
  3596 00001BFB D0D8                    	rcr	al, 1
  3597 00001BFD 2C80                    	sub	al, 80h
  3598 00001BFF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3599 00001C03 66AB                    	stosw		; interpolated sample 1 (R)
  3600 00001C05 5B                      	pop	ebx ; **
  3601 00001C06 58                      	pop	eax ; *
  3602 00001C07 00D0                    	add	al, dl	; [next_val_l]
  3603 00001C09 D0D8                    	rcr	al, 1
  3604 00001C0B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3605 00001C0F 66AB                    	stosw		; interpolated sample 2 (L)
  3606 00001C11 88D8                    	mov	al, bl
  3607 00001C13 00F0                    	add	al, dh	; [next_val_r]
  3608 00001C15 D0D8                    	rcr	al, 1
  3609 00001C17 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3610 00001C1B 66AB                    	stosw		; interpolated sample 2 (R)
  3611 00001C1D C3                      	retn
  3612                                  
  3613                                  interpolating_2_8bit_mono:
  3614                                  	; 16/11/2023
  3615                                  	; al = [previous_val]
  3616                                  	; dl = [next_val]
  3617                                  	; original-interpolated
  3618 00001C1E 88C3                    	mov	bl, al
  3619 00001C20 2C80                    	sub	al, 80h
  3620 00001C22 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3621 00001C26 66AB                    	stosw		; original sample (L)
  3622 00001C28 66AB                    	stosw		; original sample (R)
  3623 00001C2A 88D8                    	mov	al, bl
  3624 00001C2C 00D0                    	add	al, dl	
  3625 00001C2E D0D8                    	rcr	al, 1
  3626 00001C30 2C80                    	sub	al, 80h
  3627 00001C32 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3628 00001C36 66AB                    	stosw		; interpolated sample (L)
  3629 00001C38 66AB                    	stosw		; interpolated sample (R)
  3630 00001C3A C3                      	retn
  3631                                  
  3632                                  interpolating_2_8bit_stereo:
  3633                                  	; 16/11/2023
  3634                                  	; al = [previous_val_l]
  3635                                  	; ah = [previous_val_r]
  3636                                  	; dl = [next_val_l]
  3637                                  	; dh = [next_val_r]	
  3638                                  	; original-interpolated
  3639 00001C3B 89C3                    	mov	ebx, eax
  3640 00001C3D 2C80                    	sub	al, 80h
  3641 00001C3F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3642 00001C43 66AB                    	stosw		; original sample (L)
  3643 00001C45 88F8                    	mov	al, bh
  3644 00001C47 2C80                    	sub	al, 80h
  3645 00001C49 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3646 00001C4D 66AB                    	stosw		; original sample (R)
  3647 00001C4F 88D8                    	mov	al, bl	; [previous_val_l]
  3648 00001C51 00D0                    	add	al, dl	; [next_val_l]	
  3649 00001C53 D0D8                    	rcr	al, 1
  3650 00001C55 2C80                    	sub	al, 80h
  3651 00001C57 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3652 00001C5B 66AB                    	stosw		; interpolated sample (L)
  3653 00001C5D 88F8                    	mov	al, bh
  3654 00001C5F 00F0                    	add	al, dh	; [next_val_r]
  3655 00001C61 D0D8                    	rcr	al, 1
  3656 00001C63 2C80                    	sub	al, 80h
  3657 00001C65 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3658 00001C69 66AB                    	stosw		; interpolated sample (R)
  3659 00001C6B C3                      	retn
  3660                                  
  3661                                  interpolating_3_16bit_mono:
  3662                                  	; 16/11/2023
  3663                                  	; ax = [previous_val]
  3664                                  	; dx = [next_val]
  3665                                  	; original-interpolated-interpolated
  3666                                  
  3667 00001C6C 66AB                    	stosw		; original sample (L)
  3668 00001C6E 66AB                    	stosw		; original sample (R)
  3669 00001C70 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3670 00001C73 50                      	push	eax ; *	; [previous_val]
  3671 00001C74 80C680                  	add	dh, 80h
  3672 00001C77 6601D0                  	add	ax, dx
  3673 00001C7A 66D1D8                  	rcr	ax, 1
  3674 00001C7D 5B                      	pop	ebx ; *		
  3675 00001C7E 93                      	xchg	ebx, eax ; bx  = interpolated middle (temporary)
  3676 00001C7F 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  3677 00001C82 66D1D8                  	rcr	ax, 1
  3678 00001C85 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3679 00001C88 66AB                    	stosw 		; interpolated sample 1 (L)
  3680 00001C8A 66AB                    	stosw		; interpolated sample 1 (R)
  3681 00001C8C 89D8                    	mov	eax, ebx
  3682 00001C8E 6601D0                  	add	ax, dx	 ;interpolated middle + [next_val]
  3683 00001C91 66D1D8                  	rcr	ax, 1
  3684 00001C94 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3685 00001C97 66AB                    	stosw		; interpolated sample 2 (L)
  3686 00001C99 66AB                    	stosw		; interpolated sample 2 (R)
  3687 00001C9B C3                      	retn
  3688                                  
  3689                                  interpolating_3_16bit_stereo:
  3690                                  	; 16/11/2023
  3691                                  	; bx = [previous_val_l]
  3692                                  	; ax = [previous_val_r]
  3693                                  	; [next_val_l]
  3694                                  	; dx = [next_val_r]
  3695                                  	; original-interpolated-interpolated
  3696                                  
  3697 00001C9C 93                      	xchg	eax, ebx
  3698 00001C9D 66AB                    	stosw		; original sample (L)
  3699 00001C9F 93                      	xchg	eax, ebx
  3700 00001CA0 66AB                    	stosw		; original sample (R)
  3701 00001CA2 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3702 00001CA5 50                      	push	eax ; *	; [previous_val_r]
  3703 00001CA6 80C780                  	add	bh, 80h
  3704 00001CA9 8005[E3200000]80        	add	byte [next_val_l+1], 80h
  3705 00001CB0 66A1[E2200000]          	mov	ax, [next_val_l]
  3706 00001CB6 6601D8                  	add	ax, bx	; [previous_val_l]
  3707 00001CB9 66D1D8                  	rcr	ax, 1
  3708 00001CBC 93                      	xchg	eax, ebx ; ax = [previous_val_l]
  3709 00001CBD 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  3710 00001CC0 66D1D8                  	rcr	ax, 1
  3711 00001CC3 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3712 00001CC6 66AB                    	stosw 		; interpolated sample 1 (L)
  3713 00001CC8 58                      	pop	eax  ; *
  3714 00001CC9 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  3715 00001CCC 52                      	push	edx  ; * ; [next_val_r]
  3716 00001CCD 92                      	xchg	eax, edx
  3717 00001CCE 6601D0                  	add	ax, dx	; [next_val_r] + [previous_val_r]
  3718 00001CD1 66D1D8                  	rcr	ax, 1	; / 2
  3719 00001CD4 50                      	push	eax ; ** ; interpolated middle (R)
  3720 00001CD5 6601D0                  	add	ax, dx	; + [previous_val_r]
  3721 00001CD8 66D1D8                  	rcr	ax, 1
  3722 00001CDB 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3723 00001CDE 66AB                    	stosw 		; interpolated sample 1 (R)
  3724 00001CE0 66A1[E2200000]          	mov	ax, [next_val_l]
  3725 00001CE6 6601D8                  	add	ax, bx	; + interpolated middle (L)
  3726 00001CE9 66D1D8                  	rcr	ax, 1
  3727 00001CEC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3728 00001CEF 66AB                    	stosw 		; interpolated sample 2 (L)
  3729 00001CF1 58                      	pop	eax ; **
  3730 00001CF2 5A                      	pop	edx ; *	
  3731 00001CF3 6601D0                  	add	ax, dx	; interpolated middle + [next_val_r]
  3732 00001CF6 66D1D8                  	rcr	ax, 1	; / 2
  3733 00001CF9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3734 00001CFC 66AB                    	stosw 		; interpolated sample 2 (L)
  3735 00001CFE C3                      	retn
  3736                                  
  3737                                  interpolating_2_16bit_mono:
  3738                                  	; 16/11/2023
  3739                                  	; ax = [previous_val]
  3740                                  	; dx = [next_val]
  3741                                  	; original-interpolated
  3742                                  
  3743 00001CFF 66AB                    	stosw		; original sample (L)
  3744 00001D01 66AB                    	stosw		; original sample (R)
  3745 00001D03 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3746 00001D06 80C680                  	add	dh, 80h
  3747 00001D09 6601D0                  	add	ax, dx
  3748 00001D0C 66D1D8                  	rcr	ax, 1
  3749 00001D0F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3750 00001D12 66AB                    	stosw		; interpolated sample (L)
  3751 00001D14 66AB                    	stosw		; interpolated sample (R)
  3752 00001D16 C3                      	retn
  3753                                  
  3754                                  interpolating_2_16bit_stereo:
  3755                                  	; 17/01/2025
  3756                                  	; 16/11/2023
  3757                                  	; bx = [previous_val_l]
  3758                                  	; ax = [previous_val_r]
  3759                                  	; [next_val_l]
  3760                                  	; dx = [next_val_r]
  3761                                  	; original-interpolated
  3762                                  
  3763 00001D17 93                      	xchg	eax, ebx
  3764 00001D18 66AB                    	stosw		; original sample (L)
  3765 00001D1A 93                      	xchg	eax, ebx
  3766 00001D1B 66AB                    	stosw		; original sample (R)
  3767 00001D1D 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3768 00001D20 80C680                  	add	dh, 80h
  3769 00001D23 6601D0                  	add	ax, dx	; [previous_val_r] + [next_val_r]
  3770 00001D26 66D1D8                  	rcr	ax, 1	; / 2
  3771                                  	; 17/01/2025
  3772 00001D29 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3773                                  	;push	eax ; *	; interpolated sample (R)
  3774                                  	; 17/01/2025
  3775 00001D2C C1E010                  	shl	eax, 16
  3776 00001D2F 66A1[E2200000]          	mov	ax, [next_val_l]
  3777 00001D35 80C480                  	add	ah, 80h
  3778 00001D38 80C780                  	add	bh, 80h
  3779 00001D3B 6601D8                  	add	ax, bx	; [next_val_l] + [previous_val_l]
  3780 00001D3E 66D1D8                  	rcr	ax, 1	; / 2
  3781 00001D41 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3782                                  	; 17/01/2025
  3783                                  	;stosw 		; interpolated sample (L)
  3784                                  	;pop	eax ; *
  3785                                  	;sub	ah, 80h	; -32768 to +32767 format again
  3786                                  	;stosw 		; interpolated sample (R)
  3787                                  	; 17/01/2025
  3788 00001D44 AB                      	stosd
  3789 00001D45 C3                      	retn
  3790                                  
  3791                                  interpolating_5_8bit_mono:
  3792                                  	; 17/11/2023
  3793                                  	; al = [previous_val]
  3794                                  	; dl = [next_val]
  3795                                  	; original-interpltd-interpltd-interpltd-interpltd
  3796 00001D46 88C3                    	mov	bl, al
  3797 00001D48 2C80                    	sub	al, 80h
  3798 00001D4A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3799 00001D4E 66AB                    	stosw		; original sample (L)
  3800 00001D50 66AB                    	stosw		; original sample (R)
  3801 00001D52 88D8                    	mov	al, bl
  3802 00001D54 00D0                    	add	al, dl	
  3803 00001D56 D0D8                    	rcr	al, 1
  3804 00001D58 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3805 00001D5A 00D8                    	add	al, bl  ; [previous_val]
  3806 00001D5C D0D8                    	rcr	al, 1 	
  3807 00001D5E 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  3808 00001D60 00D8                    	add	al, bl
  3809 00001D62 D0D8                    	rcr	al, 1
  3810 00001D64 2C80                    	sub	al, 80h
  3811 00001D66 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3812 00001D6A 66AB                    	stosw		; interpolated sample 1 (L)
  3813 00001D6C 66AB                    	stosw		; interpolated sample 1 (R)
  3814 00001D6E 88F8                    	mov	al, bh
  3815 00001D70 00F0                    	add	al, dh
  3816 00001D72 D0D8                    	rcr	al, 1
  3817 00001D74 2C80                    	sub	al, 80h
  3818 00001D76 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3819 00001D7A 66AB                    	stosw		; interpolated sample 2 (L)
  3820 00001D7C 66AB                    	stosw		; interpolated sample 2 (R)
  3821 00001D7E 88F8                    	mov	al, bh
  3822 00001D80 00D0                    	add	al, dl	; [next_val]
  3823 00001D82 D0D8                    	rcr	al, 1
  3824 00001D84 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  3825 00001D86 00F8                    	add	al, bh
  3826 00001D88 D0D8                    	rcr	al, 1
  3827 00001D8A 2C80                    	sub	al, 80h
  3828 00001D8C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3829 00001D90 66AB                    	stosw		; interpolated sample 3 (L)
  3830 00001D92 66AB                    	stosw		; interpolated sample 3 (R)
  3831 00001D94 88F0                    	mov	al, dh
  3832 00001D96 00D0                    	add	al, dl
  3833 00001D98 D0D8                    	rcr	al, 1
  3834 00001D9A 2C80                    	sub	al, 80h
  3835 00001D9C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3836 00001DA0 66AB                    	stosw		; interpolated sample 4 (L)
  3837 00001DA2 66AB                    	stosw		; interpolated sample 4 (R)
  3838 00001DA4 C3                      	retn
  3839                                  
  3840                                  interpolating_5_8bit_stereo:
  3841                                  	; 17/11/2023
  3842                                  	; al = [previous_val_l]
  3843                                  	; ah = [previous_val_r]
  3844                                  	; dl = [next_val_l]
  3845                                  	; dh = [next_val_r]	
  3846                                  	; original-interpltd-interpltd-interpltd-interpltd
  3847 00001DA5 89C3                    	mov	ebx, eax
  3848 00001DA7 2C80                    	sub	al, 80h
  3849 00001DA9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3850 00001DAD 66AB                    	stosw		; original sample (L)
  3851 00001DAF 88F8                    	mov	al, bh
  3852 00001DB1 2C80                    	sub	al, 80h
  3853 00001DB3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3854 00001DB7 66AB                    	stosw		; original sample (R)
  3855 00001DB9 52                      	push	edx ; *
  3856 00001DBA 88D8                    	mov	al, bl
  3857 00001DBC 00D0                    	add	al, dl	; [next_val_l]
  3858 00001DBE D0D8                    	rcr	al, 1
  3859 00001DC0 50                      	push	eax ; **	; al = interpolated middle (L) (temporary)
  3860 00001DC1 00D8                    	add	al, bl	; [previous_val_l]
  3861 00001DC3 D0D8                    	rcr	al, 1
  3862 00001DC5 86D8                    	xchg	al, bl	
  3863 00001DC7 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3864 00001DC9 D0D8                    	rcr	al, 1
  3865 00001DCB 2C80                    	sub	al, 80h
  3866 00001DCD 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3867 00001DD1 66AB                    	stosw		; interpolated sample 1 (L)
  3868 00001DD3 88F8                    	mov	al, bh
  3869 00001DD5 00F0                    	add	al, dh	; [next_val_r]
  3870 00001DD7 D0D8                    	rcr	al, 1
  3871 00001DD9 50                      	push	eax ; *** ; al = interpolated middle (R) (temporary)
  3872 00001DDA 00F8                    	add	al, bh	; [previous_val_r]
  3873 00001DDC D0D8                    	rcr	al, 1
  3874 00001DDE 86F8                    	xchg	al, bh	
  3875 00001DE0 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3876 00001DE2 D0D8                    	rcr	al, 1
  3877 00001DE4 2C80                    	sub	al, 80h
  3878 00001DE6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3879 00001DEA 66AB                    	stosw		; interpolated sample 1 (R)
  3880 00001DEC 5A                      	pop	edx ; ***
  3881 00001DED 58                      	pop	eax ; **	; al = interpolated middle (L) (temporary)
  3882 00001DEE 86D8                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3883 00001DF0 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  3884 00001DF2 D0D8                    	rcr	al, 1
  3885 00001DF4 2C80                    	sub	al, 80h
  3886 00001DF6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3887 00001DFA 66AB                    	stosw		; interpolated sample 2 (L)	
  3888 00001DFC 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  3889 00001DFE 86F8                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  3890 00001E00 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  3891 00001E02 D0D8                    	rcr	al, 1
  3892 00001E04 2C80                    	sub	al, 80h
  3893 00001E06 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3894 00001E0A 66AB                    	stosw		; interpolated sample 2 (R)
  3895 00001E0C 5A                      	pop	edx ; *
  3896 00001E0D 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  3897 00001E0F 00D0                    	add	al, dl	; [next_val_l]
  3898 00001E11 D0D8                    	rcr	al, 1
  3899 00001E13 86D8                    	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  3900 00001E15 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  3901 00001E17 D0D8                    	rcr	al, 1
  3902 00001E19 2C80                    	sub	al, 80h
  3903 00001E1B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3904 00001E1F 66AB                    	stosw		; interpolated sample 3 (L)
  3905 00001E21 88F8                    	mov	al, bh	
  3906 00001E23 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  3907 00001E25 D0D8                    	rcr	al, 1
  3908 00001E27 86F8                    	xchg	al, bh	; al = interpolated middle (R)
  3909 00001E29 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  3910 00001E2B D0D8                    	rcr	al, 1
  3911 00001E2D 2C80                    	sub	al, 80h
  3912 00001E2F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3913 00001E33 66AB                    	stosw		; interpolated sample 3 (R)
  3914 00001E35 88D8                    	mov	al, bl
  3915 00001E37 00D0                    	add	al, dl	; [next_val_l]
  3916 00001E39 D0D8                    	rcr	al, 1
  3917 00001E3B 2C80                    	sub	al, 80h
  3918 00001E3D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3919 00001E41 66AB                    	stosw		; interpolated sample 4 (L)
  3920 00001E43 88F8                    	mov	al, bh
  3921 00001E45 00F0                    	add	al, dh	; [next_val_r]
  3922 00001E47 D0D8                    	rcr	al, 1
  3923 00001E49 2C80                    	sub	al, 80h
  3924 00001E4B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3925 00001E4F 66AB                    	stosw		; interpolated sample 4 (R)
  3926 00001E51 C3                      	retn
  3927                                  
  3928                                  interpolating_4_8bit_mono:
  3929                                  	; 17/11/2023
  3930                                  	; al = [previous_val]
  3931                                  	; dl = [next_val]
  3932                                  	; original-interpolated-interpolated-interpolated
  3933 00001E52 88C3                    	mov	bl, al
  3934 00001E54 2C80                    	sub	al, 80h
  3935 00001E56 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3936 00001E5A 66AB                    	stosw		; original sample (L)
  3937 00001E5C 66AB                    	stosw		; original sample (R)
  3938 00001E5E 88D8                    	mov	al, bl
  3939 00001E60 00D0                    	add	al, dl	
  3940 00001E62 D0D8                    	rcr	al, 1
  3941 00001E64 86D8                    	xchg	al, bl  ; al = [previous_val]
  3942 00001E66 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  3943 00001E68 D0D8                    	rcr	al, 1 	
  3944 00001E6A 2C80                    	sub	al, 80h
  3945 00001E6C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3946 00001E70 66AB                    	stosw		; interpolated sample 1 (L)
  3947 00001E72 66AB                    	stosw		; interpolated sample 1 (R)
  3948 00001E74 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  3949 00001E76 2C80                    	sub	al, 80h
  3950 00001E78 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3951 00001E7C 66AB                    	stosw		; interpolated sample 2 (L)
  3952 00001E7E 66AB                    	stosw		; interpolated sample 2 (R)
  3953 00001E80 88D8                    	mov	al, bl
  3954 00001E82 00D0                    	add	al, dl	; [next_val]
  3955 00001E84 D0D8                    	rcr	al, 1
  3956 00001E86 2C80                    	sub	al, 80h
  3957 00001E88 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3958 00001E8C 66AB                    	stosw		; interpolated sample 3 (L)
  3959 00001E8E 66AB                    	stosw		; interpolated sample 3 (R)
  3960 00001E90 C3                      	retn
  3961                                  
  3962                                  interpolating_4_8bit_stereo:
  3963                                  	; 17/11/2023
  3964                                  	; al = [previous_val_l]
  3965                                  	; ah = [previous_val_r]
  3966                                  	; dl = [next_val_l]
  3967                                  	; dh = [next_val_r]	
  3968                                  	; original-interpolated-interpolated-interpolated
  3969 00001E91 89C3                    	mov	ebx, eax
  3970 00001E93 2C80                    	sub	al, 80h
  3971 00001E95 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3972 00001E99 66AB                    	stosw		; original sample (L)
  3973 00001E9B 88F8                    	mov	al, bh
  3974 00001E9D 2C80                    	sub	al, 80h
  3975 00001E9F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3976 00001EA3 66AB                    	stosw		; original sample (R)
  3977 00001EA5 88D8                    	mov	al, bl
  3978 00001EA7 00D0                    	add	al, dl	; [next_val_l]
  3979 00001EA9 D0D8                    	rcr	al, 1
  3980 00001EAB 86D8                    	xchg	al, bl	; al = [previous_val_l]
  3981 00001EAD 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  3982 00001EAF D0D8                    	rcr	al, 1
  3983 00001EB1 2C80                    	sub	al, 80h
  3984 00001EB3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3985 00001EB7 66AB                    	stosw		; interpolated sample 1 (L)
  3986 00001EB9 88F8                    	mov	al, bh
  3987 00001EBB 00F0                    	add	al, dh	; [next_val_r]
  3988 00001EBD D0D8                    	rcr	al, 1
  3989 00001EBF 86F8                    	xchg	al, bh	; al = [previous_val_h]
  3990 00001EC1 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  3991 00001EC3 D0D8                    	rcr	al, 1
  3992 00001EC5 2C80                    	sub	al, 80h
  3993 00001EC7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3994 00001ECB 66AB                    	stosw		; interpolated sample 1 (R)
  3995 00001ECD 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  3996 00001ECF 2C80                    	sub	al, 80h
  3997 00001ED1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3998 00001ED5 66AB                    	stosw		; interpolated sample 2 (L)
  3999 00001ED7 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  4000 00001ED9 2C80                    	sub	al, 80h
  4001 00001EDB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4002 00001EDF 66AB                    	stosw		; interpolated sample 2 (L)
  4003 00001EE1 88D8                    	mov	al, bl
  4004 00001EE3 00D0                    	add	al, dl	; [next_val_l]
  4005 00001EE5 D0D8                    	rcr	al, 1
  4006 00001EE7 2C80                    	sub	al, 80h
  4007 00001EE9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4008 00001EED 66AB                    	stosw		; interpolated sample 3 (L)
  4009 00001EEF 88F8                    	mov	al, bh
  4010 00001EF1 00F0                    	add	al, dh	; [next_val_r]
  4011 00001EF3 D0D8                    	rcr	al, 1
  4012 00001EF5 2C80                    	sub	al, 80h
  4013 00001EF7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4014 00001EFB 66AB                    	stosw		; interpolated sample 3 (R)
  4015 00001EFD C3                      	retn
  4016                                  
  4017                                  interpolating_5_16bit_mono:
  4018                                  	; 18/11/2023
  4019                                  	; ax = [previous_val]
  4020                                  	; dx = [next_val]
  4021                                  	; original-interpltd-interpltd-interpltd-interpltd
  4022 00001EFE 66AB                    	stosw		; original sample (L)
  4023 00001F00 66AB                    	stosw		; original sample (R)
  4024 00001F02 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4025 00001F05 89C3                    	mov	ebx, eax ; [previous_val]
  4026 00001F07 80C680                  	add	dh, 80h
  4027 00001F0A 6601D0                  	add	ax, dx
  4028 00001F0D 66D1D8                  	rcr	ax, 1
  4029 00001F10 50                      	push	eax ; *	; interpolated middle (temporary)
  4030 00001F11 6601D8                  	add	ax, bx	; interpolated middle + [previous_val] 
  4031 00001F14 66D1D8                  	rcr	ax, 1
  4032 00001F17 50                      	push	eax ; **	; interpolated 1st quarter (temporary)
  4033 00001F18 6601D8                  	add	ax, bx	; 1st quarter + [previous_val]
  4034 00001F1B 66D1D8                  	rcr	ax, 1	
  4035 00001F1E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4036 00001F21 66AB                    	stosw 		; interpolated sample 1 (L)
  4037 00001F23 66AB                    	stosw		; interpolated sample 1 (R)
  4038 00001F25 58                      	pop	eax ; **	
  4039 00001F26 5B                      	pop	ebx ; *
  4040 00001F27 6601D8                  	add	ax, bx	; 1st quarter + middle
  4041 00001F2A 66D1D8                  	rcr	ax, 1	; / 2
  4042 00001F2D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  4043 00001F30 66AB                    	stosw		; interpolated sample 2 (L)
  4044 00001F32 66AB                    	stosw		; interpolated sample 2 (R)		
  4045 00001F34 89D8                    	mov	eax, ebx
  4046 00001F36 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4047 00001F39 66D1D8                  	rcr	ax, 1
  4048 00001F3C 50                      	push	eax ; *	; interpolated 3rd quarter (temporary)
  4049 00001F3D 6601D8                  	add	ax, bx	; + interpolated middle
  4050 00001F40 66D1D8                  	rcr	ax, 1
  4051 00001F43 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4052 00001F46 66AB                    	stosw		; interpolated sample 3 (L)
  4053 00001F48 66AB                    	stosw		; interpolated sample 3 (R)
  4054 00001F4A 58                      	pop	eax ; *	
  4055 00001F4B 6601D0                  	add	ax, dx	; 3rd quarter + [next_val]
  4056 00001F4E 66D1D8                  	rcr	ax, 1	; / 2
  4057 00001F51 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4058 00001F54 66AB                    	stosw		; interpolated sample 4 (L)
  4059 00001F56 66AB                    	stosw		; interpolated sample 4 (R)
  4060 00001F58 C3                      	retn
  4061                                  
  4062                                  interpolating_5_16bit_stereo:
  4063                                  	; 18/11/2023
  4064                                  	; bx = [previous_val_l]
  4065                                  	; ax = [previous_val_r]
  4066                                  	; [next_val_l]
  4067                                  	; [next_val_r]
  4068                                  	; original-interpltd-interpltd-interpltd-interpltd
  4069 00001F59 51                      	push	ecx ; !
  4070 00001F5A 93                      	xchg	eax, ebx
  4071 00001F5B 66AB                    	stosw		; original sample (L)
  4072 00001F5D 93                      	xchg	eax, ebx
  4073 00001F5E 66AB                    	stosw		; original sample (R)
  4074 00001F60 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4075 00001F63 50                      	push	eax ; *	; [previous_val_r]
  4076 00001F64 80C780                  	add	bh, 80h
  4077 00001F67 8005[E3200000]80        	add	byte [next_val_l+1], 80h
  4078 00001F6E 66A1[E2200000]          	mov	ax, [next_val_l]
  4079 00001F74 6601D8                  	add	ax, bx	; [previous_val_l]
  4080 00001F77 66D1D8                  	rcr	ax, 1
  4081 00001F7A 89C1                    	mov	ecx, eax ; interpolated middle (L)
  4082 00001F7C 6601D8                  	add	ax, bx	
  4083 00001F7F 66D1D8                  	rcr	ax, 1
  4084 00001F82 89C2                    	mov	edx, eax ; interpolated 1st quarter (L)	
  4085 00001F84 6601D8                  	add	ax, bx	; [previous_val_l]
  4086 00001F87 66D1D8                  	rcr	ax, 1
  4087 00001F8A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4088 00001F8D 66AB                    	stosw 		; interpolated sample 1 (L)
  4089 00001F8F 89C8                    	mov	eax, ecx
  4090 00001F91 6601D0                  	add	ax, dx	; middle (L) + 1st quarter (L) 
  4091 00001F94 66D1D8                  	rcr	ax, 1	; / 2
  4092 00001F97 89C3                    	mov	ebx, eax  ; interpolated sample 2 (L)
  4093 00001F99 5A                      	pop	edx ; *	; [previous_val_r]
  4094 00001F9A 89D0                    	mov	eax, edx
  4095 00001F9C 8005[E5200000]80        	add	byte [next_val_r+1], 80h
  4096 00001FA3 660305[E4200000]        	add	ax, [next_val_r]
  4097 00001FAA 66D1D8                  	rcr	ax, 1
  4098 00001FAD 50                      	push	eax ; *	; interpolated middle (R)
  4099 00001FAE 6601D0                  	add	ax, dx
  4100 00001FB1 66D1D8                  	rcr	ax, 1
  4101 00001FB4 50                      	push	eax ; ** ; interpolated 1st quarter (R)
  4102 00001FB5 6601D0                  	add	ax, dx	; [previous_val_r]
  4103 00001FB8 66D1D8                  	rcr	ax, 1
  4104 00001FBB 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4105 00001FBE 66AB                    	stosw 		; interpolated sample 1 (R)
  4106 00001FC0 89D8                    	mov	eax, ebx
  4107 00001FC2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4108 00001FC5 66AB                    	stosw 		; interpolated sample 2 (L)
  4109 00001FC7 58                      	pop	eax ; **
  4110 00001FC8 5A                      	pop	edx ; *
  4111 00001FC9 6601D0                  	add	ax, dx	; 1st quarter (R) + middle (R)
  4112 00001FCC 66D1D8                  	rcr	ax, 1	; / 2
  4113 00001FCF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4114 00001FD2 66AB                    	stosw 		; interpolated sample 2 (R)
  4115 00001FD4 89C8                    	mov	eax, ecx
  4116 00001FD6 660305[E2200000]        	add	ax, [next_val_l]
  4117 00001FDD 66D1D8                  	rcr	ax, 1
  4118 00001FE0 50                      	push	eax ; * ; interpolated 3rd quarter (L)
  4119 00001FE1 6601C8                  	add	ax, cx	; interpolated middle (L)
  4120 00001FE4 66D1D8                  	rcr	ax, 1
  4121 00001FE7 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4122 00001FEA 66AB                    	stosw 		; interpolated sample 3 (L)
  4123 00001FEC 89D0                    	mov	eax, edx
  4124 00001FEE 660305[E4200000]        	add	ax, [next_val_r]
  4125 00001FF5 66D1D8                  	rcr	ax, 1
  4126 00001FF8 50                      	push	eax ; ** ; interpolated 3rd quarter (R)
  4127 00001FF9 6601D0                  	add	ax, dx	; interpolated middle (R)
  4128 00001FFC 66D1D8                  	rcr	ax, 1
  4129 00001FFF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4130 00002002 66AB                    	stosw 		; interpolated sample 3 (R)
  4131 00002004 5B                      	pop	ebx ; **
  4132 00002005 58                      	pop	eax ; *
  4133 00002006 660305[E2200000]        	add	ax, [next_val_l]
  4134 0000200D 66D1D8                  	rcr	ax, 1
  4135 00002010 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4136 00002013 66AB                    	stosw 		; interpolated sample 4 (L)
  4137 00002015 89D8                    	mov	eax, ebx	
  4138 00002017 660305[E4200000]        	add	ax, [next_val_r]
  4139 0000201E 66D1D8                  	rcr	ax, 1
  4140 00002021 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4141 00002024 66AB                    	stosw 		; interpolated sample 4 (R)
  4142 00002026 59                      	pop	ecx ; !
  4143 00002027 C3                      	retn
  4144                                  
  4145                                  interpolating_4_16bit_mono:
  4146                                  	; 18/11/2023
  4147                                  	; ax = [previous_val]
  4148                                  	; dx = [next_val]
  4149                                  	; original-interpolated
  4150                                  
  4151 00002028 66AB                    	stosw		; original sample (L)
  4152 0000202A 66AB                    	stosw		; original sample (R)
  4153 0000202C 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4154 0000202F 89C3                    	mov	ebx, eax ; [previous_val]
  4155 00002031 80C680                  	add	dh, 80h
  4156 00002034 6601D0                  	add	ax, dx	; [previous_val] + [next_val]
  4157 00002037 66D1D8                  	rcr	ax, 1
  4158 0000203A 93                      	xchg	eax, ebx	
  4159 0000203B 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  4160 0000203E 66D1D8                  	rcr	ax, 1
  4161 00002041 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4162 00002044 66AB                    	stosw 		; interpolated sample 1 (L)
  4163 00002046 66AB                    	stosw		; interpolated sample 1 (R)
  4164 00002048 89D8                    	mov	eax, ebx ; interpolated middle
  4165 0000204A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4166 0000204D 66AB                    	stosw 		; interpolated sample 2 (L)
  4167 0000204F 66AB                    	stosw		; interpolated sample 2 (R)
  4168 00002051 89D8                    	mov	eax, ebx
  4169 00002053 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4170 00002056 66D1D8                  	rcr	ax, 1
  4171 00002059 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4172 0000205C 66AB                    	stosw		; interpolated sample 3 (L)
  4173 0000205E 66AB                    	stosw		; interpolated sample 3 (R)
  4174 00002060 C3                      	retn
  4175                                  
  4176                                  interpolating_4_16bit_stereo:
  4177                                  	; 18/11/2023
  4178                                  	; bx = [previous_val_l]
  4179                                  	; ax = [previous_val_r]
  4180                                  	; [next_val_l]
  4181                                  	; [next_val_r]
  4182                                  	; original-interpolated-interpolated-interpolated
  4183 00002061 93                      	xchg	eax, ebx
  4184 00002062 66AB                    	stosw		; original sample (L)
  4185 00002064 93                      	xchg	eax, ebx
  4186 00002065 66AB                    	stosw		; original sample (R)
  4187 00002067 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4188 0000206A 89C2                    	mov	edx, eax ; [previous_val_r]
  4189 0000206C 80C780                  	add	bh, 80h
  4190 0000206F 8005[E3200000]80        	add	byte [next_val_l+1], 80h
  4191 00002076 66A1[E2200000]          	mov	ax, [next_val_l]
  4192 0000207C 6601D8                  	add	ax, bx	; [previous_val_l]
  4193 0000207F 66D1D8                  	rcr	ax, 1
  4194 00002082 93                      	xchg	eax, ebx	
  4195 00002083 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  4196 00002086 66D1D8                  	rcr	ax, 1
  4197 00002089 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4198 0000208C 66AB                    	stosw 		; interpolated sample 1 (L)
  4199 0000208E 8005[E5200000]80        	add	byte [next_val_r+1], 80h
  4200 00002095 89D0                    	mov	eax, edx ; [previous_val_r]
  4201 00002097 660305[E4200000]        	add	ax, [next_val_r]
  4202 0000209E 66D1D8                  	rcr	ax, 1
  4203 000020A1 92                      	xchg	eax, edx	
  4204 000020A2 6601D0                  	add	ax, dx	; dx = interpolated middle (R)
  4205 000020A5 66D1D8                  	rcr	ax, 1
  4206 000020A8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4207 000020AB 66AB                    	stosw 		; interpolated sample 1 (R)
  4208 000020AD 89D8                    	mov	eax, ebx
  4209 000020AF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4210 000020B2 66AB                    	stosw 		; interpolated sample 2 (L)
  4211 000020B4 89D0                    	mov	eax, edx
  4212 000020B6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4213 000020B9 66AB                    	stosw 		; interpolated sample 2 (R)
  4214 000020BB 89D8                    	mov	eax, ebx
  4215 000020BD 660305[E2200000]        	add	ax, [next_val_l]
  4216 000020C4 66D1D8                  	rcr	ax, 1
  4217 000020C7 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4218 000020CA 66AB                    	stosw 		; interpolated sample 3 (L)
  4219 000020CC 89D0                    	mov	eax, edx
  4220 000020CE 660305[E4200000]        	add	ax, [next_val_r]
  4221 000020D5 66D1D8                  	rcr	ax, 1
  4222 000020D8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4223 000020DB 66AB                    	stosw 		; interpolated sample 3 (R)
  4224 000020DD C3                      	retn
  4225                                  
  4226                                  ; 13/11/2023
  4227                                  previous_val:
  4228 000020DE 0000                    previous_val_l: dw 0
  4229 000020E0 0000                    previous_val_r: dw 0
  4230                                  next_val:
  4231 000020E2 0000                    next_val_l: dw 0
  4232 000020E4 0000                    next_val_r: dw 0
  4233                                  
  4234                                  ; 16/11/2023
  4235 000020E6 00                      faz:	db 0	
  4236                                  	
  4237                                  ; --------------------------------------------------------
  4238                                  
  4239                                  ; DATA
  4240                                  
  4241                                  FileHandle:	
  4242 000020E7 FFFFFFFF                	dd	-1
  4243                                  
  4244                                  Credits:
  4245 000020EB 54696E792057415620-     	db	'Tiny WAV Player for TRDOS 386 by Erdogan Tan. '
  4245 000020F4 506C6179657220666F-
  4245 000020FD 72205452444F532033-
  4245 00002106 383620627920457264-
  4245 0000210F 6F67616E2054616E2E-
  4245 00002118 20                 
  4246                                  	;;;;db	'August 2020.',10,13,0
  4247                                  	;;;db	'November 2023.',10,13,0
  4248                                  	;;db	'June 2024.', 10,13,0
  4249                                  	;db	'December 2024.', 10,13,0
  4250 00002119 4A616E756172792032-     	db	'January 2025.', 10,13,0
  4250 00002122 3032352E0A0D00     
  4251 00002129 31372F30362F323031-     	db	'17/06/2017', 10,13,0
  4251 00002132 370A0D00           
  4252 00002136 31382F30382F323032-     	db	'18/08/2020', 10,13,0
  4252 0000213F 300A0D00           
  4253 00002143 32372F31312F323032-     	db	'27/11/2023', 10,13,0
  4253 0000214C 330A0D00           
  4254 00002150 30312F30362F323032-     	db	'01/06/2024', 10,13,0
  4254 00002159 340A0D00           
  4255 0000215D 30362F30362F323032-     	db	'06/06/2024', 10,13,0
  4255 00002166 340A0D00           
  4256 0000216A 30382F31322F323032-     	db	'08/12/2024', 10,13,0
  4256 00002173 340A0D00           
  4257 00002177 31342F31322F323032-     	db	'14/12/2024', 10,13,0
  4257 00002180 340A0D00           
  4258 00002184 31372F30312F323032-     	db	'17/01/2025', 10,13,0
  4258 0000218D 350A0D00           
  4259                                  
  4260                                  msgAudioCardInfo:
  4261 00002191 666F7220496E74656C-     	db 	'for Intel AC97 (ICH) Audio Controller.', 10,13,0
  4261 0000219A 204143393720284943-
  4261 000021A3 482920417564696F20-
  4261 000021AC 436F6E74726F6C6C65-
  4261 000021B5 722E0A0D00         
  4262                                  
  4263                                  msg_usage:
  4264 000021BA 75736167653A20706C-     	db	'usage: playwav6 filename.wav',10,13,0
  4264 000021C3 617977617636206669-
  4264 000021CC 6C656E616D652E7761-
  4264 000021D5 760A0D00           
  4265                                  
  4266                                  noDevMsg:
  4267 000021D9 4572726F723A20556E-     	db	'Error: Unable to find AC97 audio device!'
  4267 000021E2 61626C6520746F2066-
  4267 000021EB 696E64204143393720-
  4267 000021F4 617564696F20646576-
  4267 000021FD 69636521           
  4268 00002201 0A0D00                  	db	10,13,0
  4269                                  
  4270                                  noFileErrMsg:
  4271 00002204 4572726F723A206669-     	db	'Error: file not found.',10,13,0
  4271 0000220D 6C65206E6F7420666F-
  4271 00002216 756E642E0A0D00     
  4272                                  
  4273                                  trdos386_err_msg:
  4274 0000221D 5452444F5320333836-     	db	'TRDOS 386 System call error !',10,13,0
  4274 00002226 2053797374656D2063-
  4274 0000222F 616C6C206572726F72-
  4274 00002238 20210A0D00         
  4275                                  
  4276                                  ; 01/06/2024
  4277                                  msg_init_err:
  4278 0000223D 0A0D                    	db	10,13
  4279 0000223F 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  4279 00002248 726F6C6C65722F436F-
  4279 00002251 64656320696E697469-
  4279 0000225A 616C697A6174696F6E-
  4279 00002263 206572726F722021   
  4280 0000226B 0A0D00                  	db	10,13,0
  4281                                  
  4282                                  ; 25/11/2023
  4283                                  msg_no_vra:
  4284 0000226E 0A0D                    	db	10,13
  4285 00002270 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  4285 00002279 70706F72742021204F-
  4285 00002282 6E6C79203438206B48-
  4285 0000228B 5A2073616D706C6520-
  4285 00002294 726174652073757070-
  4285 0000229D 6F727465642021     
  4286 000022A4 0A0D00                  	db	10,13,0
  4287                                  
  4288 000022A7 0D0A5741562046696C-     msgWavFileName:	db 0Dh, 0Ah, "WAV File Name: ",0
  4288 000022B0 65204E616D653A2000 
  4289 000022B9 0D0A53616D706C6520-     msgSampleRate:	db 0Dh, 0Ah, "Sample Rate: "
  4289 000022C2 526174653A20       
  4290 000022C8 303030303020487A2C-     msgHertz:	db "00000 Hz, ", 0 
  4290 000022D1 2000               
  4291 000022D3 3820626974732C2000      msg8Bits:	db "8 bits, ", 0 
  4292 000022DC 4D6F6E6F0D0A00          msgMono:	db "Mono", 0Dh, 0Ah, 0
  4293 000022E3 313620626974732C20-     msg16Bits:	db "16 bits, ", 0 
  4293 000022EC 00                 
  4294 000022ED 53746572656F            msgStereo:	db "Stereo"
  4295 000022F3 0D0A00                  nextline:	db 0Dh, 0Ah, 0
  4296                                  
  4297                                  ; 03/06/2017
  4298 000022F6 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  4298 000022FF 3941424344454600   
  4299 00002307 0D0A                    msgAC97Info	db 0Dh, 0Ah
  4300 00002309 414339372041756469-     		db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  4300 00002312 6F20436F6E74726F6C-
  4300 0000231B 6C6572202620436F64-
  4300 00002324 656320496E666F0D0A 
  4301 0000232D 56656E646F72204944-     		db "Vendor ID: "
  4301 00002336 3A20               
  4302 00002338 303030306820446576-     msgVendorId	db "0000h Device ID: "
  4302 00002341 6963652049443A20   
  4303 00002349 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  4304 00002350 4275733A20              		db "Bus: "
  4305 00002355 303068204465766963-     msgBusNo	db "00h Device: "
  4305 0000235E 653A20             
  4306 00002361 3030682046756E6374-     msgDevNo	db "00h Function: "
  4306 0000236A 696F6E3A20         
  4307 0000236F 303068                  msgFncNo	db "00h"
  4308 00002372 0D0A                    		db 0Dh, 0Ah
  4309 00002374 4E414D4241523A20        		db "NAMBAR: "
  4310 0000237C 30303030682020          msgNamBar	db "0000h  "
  4311 00002383 4E41424D4241523A20      		db "NABMBAR: "
  4312 0000238C 303030306820204952-     msgNabmBar	db "0000h  IRQ: "
  4312 00002395 513A20             
  4313 00002398 3030                    msgIRQ		dw 3030h
  4314 0000239A 0D0A00                  		db 0Dh, 0Ah, 0
  4315                                  ; 06/06/2024
  4316 0000239D 0D0A                    msgCodec	db 0Dh, 0Ah
  4317 0000239F 434F44454320            		db "CODEC "
  4318 000023A5 0D0A                    		db 0Dh, 0Ah
  4319 000023A7 56656E646F72204944-     		db "Vendor ID1: "
  4319 000023B0 313A20             
  4320 000023B3 30303030682020          msgCodecId1	db "0000h  "
  4321 000023BA 56656E646F72204944-     		db "Vendor ID2: "
  4321 000023C3 323A20             
  4322 000023C6 30303030682020          msgCodecId2	db "0000h  "  
  4323                                  ; 25/11/2023
  4324 000023CD 0D0A00                  		db 0Dh, 0Ah, 0
  4325 000023D0 56524120737570706F-     msgVRAheader:	db "VRA support: "
  4325 000023D9 72743A20           
  4326 000023DD 00                      		db 0	
  4327 000023DE 5945530D0A00            msgVRAyes:	db "YES", 0Dh, 0Ah, 0
  4328 000023E4 4E4F200D0A              msgVRAno:	db "NO ", 0Dh, 0Ah
  4329 000023E9 28496E746572706F6C-     		db "(Interpolated sample rate playing method)"
  4329 000023F2 617465642073616D70-
  4329 000023FB 6C6520726174652070-
  4329 00002404 6C6179696E67206D65-
  4329 0000240D 74686F6429         
  4330 00002412 0D0A00                  		db 0Dh, 0Ah, 0	
  4331                                  EOF: 
  4332                                  
  4333                                  ; BSS
  4334                                  
  4335                                  bss_start:
  4336                                  
  4337                                  ABSOLUTE bss_start
  4338                                  
  4339 00002415 ??????                  alignb 4
  4340                                  
  4341 00002418 ??                      stmo:		resb 1 ; stereo or mono (1=stereo) 
  4342 00002419 ??                      bps:		resb 1 ; bits per sample (8,16)
  4343 0000241A ????                    sample_rate:	resw 1 ; Sample Frequency (Hz)
  4344                                  
  4345                                  ; 25/11/2023
  4346 0000241C ????????                bufferSize:	resd 1
  4347                                  
  4348 00002420 ??                      flags:		resb 1
  4349                                  ;cbs_busy:	resb 1 
  4350 00002421 ??                      half_buff:	resb 1
  4351 00002422 ??                      srb:		resb 1
  4352                                  ; 18/08/2020
  4353 00002423 ??                      volume_level:	resb 1
  4354                                  ; 25/11/2023
  4355 00002424 ??                      VRA:		resb 1	; Variable Rate Audio Support Status
  4356                                  
  4357 00002425 <res 1Ch>               smpRBuff:	resw 14 
  4358                                  
  4359                                  wav_file_name:
  4360 00002441 <res 50h>               		resb 80 ; wave file, path name (<= 80 bytes)
  4361                                  
  4362 00002491 ????                    		resw 1
  4363 00002493 ??                      ac97_int_ln_reg: resb 1
  4364 00002494 ??                      fbs_shift:	resb 1 ; 26/11/2023
  4365 00002495 ????????                dev_vendor:	resd 1
  4366 00002499 ????????                bus_dev_fn:	resd 1
  4367 0000249D ????                    ac97_NamBar:	resw 1
  4368 0000249F ????                    ac97_NabmBar:	resw 1
  4369                                  
  4370                                  bss_end:
  4371 000024A1 <res B5Fh>              alignb 4096
  4372                                  ;audio_buffer:	resb BUFFERSIZE ; DMA Buffer Size / 2 (32768)
  4373                                  ; 26/11/2023
  4374 00003000 <res 10000h>            audio_buffer:	resb 65536
  4375                                  ; 13/06/2017
  4376                                  ;temp_buffer:	resb BUFFERSIZE
  4377                                  ; 26/11/2023
  4378 00013000 <res 10000h>            temp_buffer:	resb 65536
