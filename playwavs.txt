     1                                  ; ****************************************************************************
     2                                  ; playwav6.s (for TRDOS 386)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYWAV6.PRG ! AC'97 (ICH) .WAV PLAYER program by Erdogan TAN
     5                                  ;
     6                                  ; 25/11/2023
     7                                  ;
     8                                  ; [ Last Modification: 08/12/2024 ]
     9                                  ;
    10                                  ; Modified from PLAYWAV5.PRG .wav player program by Erdogan Tan, 18/08/2020
    11                                  ;
    12                                  ; Assembler: NASM version 2.15
    13                                  ;	     nasm playwav6.s -l playwav6.txt -o PLAYWAV6.PRG	
    14                                  ; ----------------------------------------------------------------------------
    15                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002
    16                                  
    17                                  ; previous version: playwav3.s (17/06/2017)
    18                                  
    19                                  ; CODE
    20                                  
    21                                  ; 14/07/2020
    22                                  ; 31/12/2017
    23                                  ; TRDOS 386 (v2.0) system calls
    24                                  _ver 	equ 0
    25                                  _exit 	equ 1
    26                                  _fork 	equ 2
    27                                  _read 	equ 3
    28                                  _write	equ 4
    29                                  _open	equ 5
    30                                  _close 	equ 6
    31                                  _wait 	equ 7
    32                                  _create	equ 8
    33                                  _rename	equ 9
    34                                  _delete	equ 10
    35                                  _exec	equ 11
    36                                  _chdir	equ 12
    37                                  _time 	equ 13
    38                                  _mkdir 	equ 14
    39                                  _chmod	equ 15
    40                                  _rmdir	equ 16
    41                                  _break	equ 17
    42                                  _drive	equ 18
    43                                  _seek	equ 19
    44                                  _tell 	equ 20
    45                                  _memory	equ 21
    46                                  _prompt	equ 22
    47                                  _path	equ 23
    48                                  _env	equ 24
    49                                  _stime	equ 25
    50                                  _quit	equ 26
    51                                  _intr	equ 27
    52                                  _dir	equ 28
    53                                  _emt 	equ 29
    54                                  _ldrvt 	equ 30
    55                                  _video 	equ 31
    56                                  _audio	equ 32
    57                                  _timer	equ 33
    58                                  _sleep	equ 34
    59                                  _msg    equ 35
    60                                  _geterr	equ 36
    61                                  _fpstat	equ 37
    62                                  _pri	equ 38
    63                                  _rele	equ 39
    64                                  _fff	equ 40
    65                                  _fnf	equ 41
    66                                  _alloc	equ 42
    67                                  _dalloc equ 43
    68                                  _calbac equ 44
    69                                  _dma	equ 45
    70                                  
    71                                  %macro sys 1-4
    72                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)	
    73                                      ; 03/09/2015	
    74                                      ; 13/04/2015
    75                                      ; Retro UNIX 386 v1 system call.	
    76                                      %if %0 >= 2   
    77                                          mov ebx, %2
    78                                          %if %0 >= 3    
    79                                              mov ecx, %3
    80                                              %if %0 = 4
    81                                                 mov edx, %4   
    82                                              %endif
    83                                          %endif
    84                                      %endif
    85                                      mov eax, %1
    86                                      ;int 30h
    87                                      int 40h ; TRDOS 386 (TRDOS v2.0)	   
    88                                  %endmacro
    89                                  
    90                                  ; TRDOS 386 (and Retro UNIX 386 v1) system call format:
    91                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
    92                                  
    93                                  BUFFERSIZE	equ	32768	; audio buffer size 
    94                                  ENDOFFILE       equ     1	; flag for knowing end of file
    95                                  
    96                                  [BITS 32]
    97                                  
    98                                  [ORG 0] 
    99                                  
   100                                  _STARTUP:
   101                                  	; Prints the Credits Text.
   102                                  	sys	_msg, Credits, 255, 0Bh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000000 BB[12210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000005 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000000A BA0B000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000000F B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000014 CD40                <1>  int 40h
   103                                  
   104                                  	; clear bss
   105 00000016 B9[AD240000]            	mov	ecx, bss_end
   106 0000001B BF[23240000]            	mov	edi, bss_start
   107 00000020 29F9                    	sub	ecx, edi
   108 00000022 D1E9                    	shr	ecx, 1
   109 00000024 31C0                    	xor	eax, eax
   110 00000026 F366AB                  	rep	stosw
   111                                  
   112                                  	; Detect (& Enable) AC'97 Audio Device
   113 00000029 E89B040000              	call	DetectAC97
   114 0000002E 731B                    	jnc     short GetFileName
   115                                  
   116                                  _dev_not_ready:
   117                                  ; couldn't find the audio device!
   118                                  	sys	_msg, noDevMsg, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000030 BB[E7210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000035 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000003A BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000003F B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000044 CD40                <1>  int 40h
   119 00000046 E958040000                      jmp     Exit
   120                                  
   121                                  GetFileName:  
   122 0000004B 89E6                    	mov	esi, esp
   123 0000004D AD                      	lodsd
   124 0000004E 83F802                  	cmp	eax, 2 ; two arguments 
   125                                  	       ; (program file name & mod file name)
   126 00000051 0F825A040000            	jb	pmsg_usage ; nothing to do
   127                                  
   128 00000057 AD                      	lodsd ; program file name address 
   129 00000058 AD                      	lodsd ; mod file name address (file to be read)
   130 00000059 89C6                    	mov	esi, eax
   131 0000005B BF[4D240000]            	mov	edi, wav_file_name
   132                                  ScanName:       
   133 00000060 AC                      	lodsb
   134 00000061 84C0                    	test	al, al
   135 00000063 0F8448040000            	je	pmsg_usage
   136 00000069 3C20                    	cmp	al, 20h
   137 0000006B 74F3                    	je	short ScanName	; scan start of name.
   138 0000006D AA                      	stosb
   139 0000006E B4FF                    	mov	ah, 0FFh
   140                                  a_0:	
   141 00000070 FEC4                    	inc	ah
   142                                  a_1:
   143 00000072 AC                      	lodsb
   144 00000073 AA                      	stosb
   145 00000074 3C2E                    	cmp	al, '.'
   146 00000076 74F8                    	je	short a_0	
   147 00000078 20C0                    	and	al, al
   148 0000007A 75F6                    	jnz	short a_1
   149                                  
   150 0000007C 08E4                    	or	ah, ah		; if period NOT found,
   151 0000007E 750B                    	jnz	short _1 	; then add a .WAV extension.
   152                                  SetExt:
   153 00000080 4F                      	dec	edi
   154 00000081 C7072E574156            	mov	dword [edi], '.WAV'
   155 00000087 C6470400                	mov	byte [edi+4], 0
   156                                  
   157                                  _1:
   158                                  
   159                                  ; 26/11/2023
   160                                  %if 0
   161                                  	; Allocate Audio Buffer (for user)
   162                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   163                                  	; 26/11/2023
   164                                  	sys	_audio, 0200h, [buffersize], audio_buffer
   165                                  	jnc	short _2
   166                                  error_exit:
   167                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
   168                                  	jmp	Exit
   169                                  _2:
   170                                  	; DIRECT CGA (TEXT MODE) MEMORY ACCESS
   171                                  	; bl = 0, bh = 4
   172                                  	; Direct access/map to CGA (Text) memory (0B8000h)
   173                                  
   174                                  	sys	_video, 0400h
   175                                  	cmp	eax, 0B8000h
   176                                  	jne	short error_exit
   177                                  
   178                                  	; Initialize Audio Device (bh = 3)
   179                                  	sys	_audio, 0301h, 0, audio_int_handler 
   180                                  ;	jc	short error_exit
   181                                  _3:
   182                                  
   183                                  %endif
   184 0000008B E89C060000              	call	write_audio_dev_info 
   185                                  
   186                                  ; open the file
   187                                          ; open existing file
   188 00000090 E841040000                      call    openFile ; no error? ok.
   189 00000095 731B                            jnc     short _gsr
   190                                  
   191                                  ; file not found!
   192                                  	sys	_msg, noFileErrMsg, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000097 BB[12220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000009C B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000000A1 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000000A6 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000000AB CD40                <1>  int 40h
   193                                  _exit_:
   194 000000AD E9F1030000                      jmp     Exit
   195                                  
   196                                  _gsr:  
   197 000000B2 E859040000                     	call    getSampleRate		; read the sample rate
   198                                                                          ; pass it onto codec.
   199                                  	;jc	Exit
   200                                  	; 25/11/2023
   201 000000B7 72F4                    	jc	short _exit_
   202                                  
   203 000000B9 66A3[26240000]          	mov	[sample_rate], ax
   204 000000BF 880D[24240000]          	mov	[stmo], cl
   205 000000C5 8815[25240000]          	mov	[bps], dl
   206                                  
   207                                  	; 26/11/2023
   208 000000CB C605[A0240000]00        	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   209 000000D2 FEC9                    	dec	cl
   210 000000D4 7506                    	jnz	short _gsr_1 ; stereo
   211 000000D6 FE05[A0240000]          	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   212                                  _gsr_1:	
   213 000000DC 80FA08                  	cmp	dl, 8 
   214 000000DF 7706                    	ja	short _gsr_2 ; 16 bit samples
   215 000000E1 FE05[A0240000]          	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   216                                  _gsr_2:	
   217                                  	; 06/06/2017
   218                                  	sys	_audio, 0E00h ; get audio controller info
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000000E7 BB000E0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000000EC B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000000F1 CD40                <1>  int 40h
   219 000000F3 0F82FE020000            	jc	error_exit ; 25/11/2023
   220                                  
   221                                  	;cmp	ah, 2 ; ICH ? (Intel AC'97 Audio Controller)
   222                                  	;jne	_dev_not_ready	
   223                                  
   224                                  	; EAX = IRQ Number in AL
   225                                  	;	Audio Device Number in AH 
   226                                  	; EBX = DEV/VENDOR ID
   227                                  	;       (DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV)
   228                                  	; ECX = BUS/DEV/FN 
   229                                  	;       (00000000BBBBBBBBDDDDDFFF00000000)
   230                                  	; EDX = NABMBAR/NAMBAR (for AC97)
   231                                  	;      (Low word, DX = NAMBAR address)
   232                                  	; EDX = Base IO Addr (DX) for SB16 & VT8233
   233                                  
   234 000000F9 A2[9F240000]            	mov	[ac97_int_ln_reg], al
   235 000000FE 891D[A1240000]          	mov	[dev_vendor], ebx
   236 00000104 890D[A5240000]          	mov	[bus_dev_fn], ecx
   237                                  	;mov	[ac97_NamBar], dx
   238                                  	;shr	dx, 16
   239                                  	;mov	[ac97_NabmBar], dx
   240 0000010A 8915[A9240000]          	mov	[ac97_NamBar], edx	
   241                                    
   242                                  	; 06/06/2024
   243                                  	;; 01/06/2024
   244                                  	;; Reset Audio Device (bh = 8)
   245                                  	;sys	_audio, 0800h
   246                                  	;;jc	error_exit	
   247                                  	;jc	short init_err
   248                                  
   249 00000110 E8F9060000              	call	write_ac97_pci_dev_info
   250                                  
   251                                  	; 01/06/2024
   252                                  	; 25/11/2023
   253                                  	; Get AC'97 Codec info
   254                                  	; (Function 14, sub function 1)
   255                                  	sys	_audio, 0E01h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000115 BB010E0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000011A B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000011F CD40                <1>  int 40h
   256                                  	; 06/06/2024
   257 00000121 7310                    	jnc	short _gsr_3
   258                                  
   259                                  	; 06/06/2024
   260                                  	; a 2nd attempt
   261                                  	sys	_audio, 0E01h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000123 BB010E0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000128 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000012D CD40                <1>  int 40h
   262 0000012F 7302                    	jnc	short _gsr_3
   263                                  
   264 00000131 D1E0                    	shl	eax, 1 ; clears AL BIT 0
   265                                  _gsr_3:
   266                                  	; Save Variable Rate Audio support bit
   267 00000133 2401                    	and	al, 1
   268 00000135 A2[30240000]            	mov	[VRA], al
   269                                  
   270                                  	; 06/06/2024
   271                                  	; ebx = codec vendor id1 & id2 (bx)
   272 0000013A E8E3080000              	call	write_codec_info
   273                                  
   274                                  	; 25/11/2023
   275 0000013F E891080000              	call	write_VRA_info
   276                                  
   277                                  	; 01/05/2017
   278 00000144 E8FA050000              	call	write_wav_file_info
   279                                  
   280                                  	; 25/11/2023
   281                                  	; ------------------------------------------
   282                                  
   283 00000149 803D[30240000]01        	cmp	byte [VRA], 1
   284 00000150 7220                    	jb	short chk_sample_rate
   285                                  
   286                                  playwav_48_khz:	
   287                                  	;mov	dword [loadfromwavfile], loadFromFile
   288                                  	;mov	dword [buffersize], 65536
   289 00000152 E987020000              	jmp	PlayNow
   290                                  
   291                                  	; 01/06/2024
   292                                  init_err:
   293                                  	sys	_msg, msg_init_err, 255, 0Eh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000157 BB[4B220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000015C B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000161 BA0E000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000166 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000016B CD40                <1>  int 40h
   294 0000016D E931030000              	jmp	Exit
   295                                  
   296                                  chk_sample_rate:
   297                                  	; set conversion parameters
   298                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   299 00000172 66A1[26240000]          	mov	ax, [sample_rate]
   300 00000178 663D80BB                	cmp	ax, 48000
   301 0000017C 74D4                    	je	short playwav_48_khz
   302                                  chk_22khz:
   303 0000017E 663D2256                	cmp	ax, 22050
   304 00000182 7545                    	jne	short chk_11khz
   305 00000184 803D[25240000]08        	cmp	byte [bps], 8
   306 0000018B 7615                    	jna	short chk_22khz_1
   307 0000018D BB[FD160000]            	mov	ebx, load_22khz_stereo_16_bit
   308 00000192 803D[24240000]01        	cmp	byte [stmo], 1 
   309 00000199 751A                    	jne	short chk_22khz_2
   310 0000019B BB[70160000]            	mov	ebx, load_22khz_mono_16_bit
   311 000001A0 EB13                    	jmp	short chk_22khz_2
   312                                  chk_22khz_1:
   313 000001A2 BB[E9150000]            	mov	ebx, load_22khz_stereo_8_bit
   314 000001A7 803D[24240000]01        	cmp	byte [stmo], 1 
   315 000001AE 7505                    	jne	short chk_22khz_2
   316 000001B0 BB[60150000]            	mov	ebx, load_22khz_mono_8_bit
   317                                  chk_22khz_2:
   318 000001B5 B85A1D0000              	mov	eax, 7514  ; (442*17)
   319 000001BA BA25000000              	mov	edx, 37
   320 000001BF B911000000              	mov	ecx, 17 
   321 000001C4 E9BA010000              	jmp	set_sizes	
   322                                  chk_11khz:
   323 000001C9 663D112B                	cmp	ax, 11025
   324 000001CD 7545                    	jne	short chk_44khz
   325 000001CF 803D[25240000]08        	cmp	byte [bps], 8
   326 000001D6 7615                    	jna	short chk_11khz_1
   327 000001D8 BB[19190000]            	mov	ebx, load_11khz_stereo_16_bit
   328 000001DD 803D[24240000]01        	cmp	byte [stmo], 1 
   329 000001E4 751A                    	jne	short chk_11khz_2
   330 000001E6 BB[A0180000]            	mov	ebx, load_11khz_mono_16_bit
   331 000001EB EB13                    	jmp	short chk_11khz_2
   332                                  chk_11khz_1:
   333 000001ED BB[26180000]            	mov	ebx, load_11khz_stereo_8_bit
   334 000001F2 803D[24240000]01        	cmp	byte [stmo], 1 
   335 000001F9 7505                    	jne	short chk_11khz_2
   336 000001FB BB[AE170000]            	mov	ebx, load_11khz_mono_8_bit
   337                                  chk_11khz_2:
   338 00000200 B8AD0E0000              	mov	eax, 3757  ; (221*17)
   339 00000205 BA4A000000              	mov	edx, 74
   340 0000020A B911000000              	mov	ecx, 17
   341 0000020F E96F010000              	jmp	set_sizes 
   342                                  chk_44khz:
   343 00000214 663D44AC                	cmp	ax, 44100
   344 00000218 7545                    	jne	short chk_16khz
   345 0000021A 803D[25240000]08        	cmp	byte [bps], 8
   346 00000221 7615                    	jna	short chk_44khz_1
   347 00000223 BB[401B0000]            	mov	ebx, load_44khz_stereo_16_bit
   348 00000228 803D[24240000]01        	cmp	byte [stmo], 1 
   349 0000022F 751A                    	jne	short chk_44khz_2
   350 00000231 BB[C71A0000]            	mov	ebx, load_44khz_mono_16_bit
   351 00000236 EB13                    	jmp	short chk_44khz_2
   352                                  chk_44khz_1:
   353 00000238 BB[4A1A0000]            	mov	ebx, load_44khz_stereo_8_bit
   354 0000023D 803D[24240000]01        	cmp	byte [stmo], 1 
   355 00000244 7505                    	jne	short chk_44khz_2
   356 00000246 BB[CE190000]            	mov	ebx, load_44khz_mono_8_bit
   357                                  chk_44khz_2:
   358 0000024B B8D93A0000              	mov	eax, 15065 ; (655*23)
   359 00000250 BA19000000              	mov	edx, 25
   360 00000255 B917000000              	mov	ecx, 23
   361 0000025A E924010000              	jmp	set_sizes 
   362                                  chk_16khz:
   363 0000025F 663D803E                	cmp	ax, 16000
   364 00000263 7545                    	jne	short chk_8khz
   365 00000265 803D[25240000]08        	cmp	byte [bps], 8
   366 0000026C 7615                    	jna	short chk_16khz_1
   367 0000026E BB[A5100000]            	mov	ebx, load_16khz_stereo_16_bit
   368 00000273 803D[24240000]01        	cmp	byte [stmo], 1 
   369 0000027A 751A                    	jne	short chk_16khz_2
   370 0000027C BB[24100000]            	mov	ebx, load_16khz_mono_16_bit
   371 00000281 EB13                    	jmp	short chk_16khz_2
   372                                  chk_16khz_1:
   373 00000283 BB[6A0F0000]            	mov	ebx, load_16khz_stereo_8_bit
   374 00000288 803D[24240000]01        	cmp	byte [stmo], 1 
   375 0000028F 7505                    	jne	short chk_16khz_2
   376 00000291 BB[EB0E0000]            	mov	ebx, load_16khz_mono_8_bit
   377                                  chk_16khz_2:
   378 00000296 B855150000              	mov	eax, 5461
   379 0000029B BA03000000              	mov	edx, 3
   380 000002A0 B901000000              	mov	ecx, 1
   381 000002A5 E9D9000000              	jmp	set_sizes 
   382                                  chk_8khz:
   383 000002AA 663D401F                	cmp	ax, 8000
   384 000002AE 7545                    	jne	short chk_24khz
   385 000002B0 803D[25240000]08        	cmp	byte [bps], 8
   386 000002B7 7615                    	jna	short chk_8khz_1
   387 000002B9 BB[A00D0000]            	mov	ebx, load_8khz_stereo_16_bit
   388 000002BE 803D[24240000]01        	cmp	byte [stmo], 1 
   389 000002C5 751A                    	jne	short chk_8khz_2
   390 000002C7 BB[D00C0000]            	mov	ebx, load_8khz_mono_16_bit
   391 000002CC EB13                    	jmp	short chk_8khz_2
   392                                  chk_8khz_1:
   393 000002CE BB[A00B0000]            	mov	ebx, load_8khz_stereo_8_bit
   394 000002D3 803D[24240000]01        	cmp	byte [stmo], 1 
   395 000002DA 7505                    	jne	short chk_8khz_2
   396 000002DC BB[BC0A0000]            	mov	ebx, load_8khz_mono_8_bit
   397                                  chk_8khz_2:
   398 000002E1 B8AA0A0000              	mov	eax, 2730
   399 000002E6 BA06000000              	mov	edx, 6
   400 000002EB B901000000              	mov	ecx, 1
   401 000002F0 E98E000000              	jmp	set_sizes 
   402                                  chk_24khz:
   403 000002F5 663DC05D                	cmp	ax, 24000
   404 000002F9 7542                    	jne	short chk_32khz
   405 000002FB 803D[25240000]08        	cmp	byte [bps], 8
   406 00000302 7615                    	jna	short chk_24khz_1
   407 00000304 BB[CF120000]            	mov	ebx, load_24khz_stereo_16_bit
   408 00000309 803D[24240000]01        	cmp	byte [stmo], 1 
   409 00000310 751A                    	jne	short chk_24khz_2
   410 00000312 BB[6C120000]            	mov	ebx, load_24khz_mono_16_bit
   411 00000317 EB13                    	jmp	short chk_24khz_2
   412                                  chk_24khz_1:
   413 00000319 BB[E2110000]            	mov	ebx, load_24khz_stereo_8_bit
   414 0000031E 803D[24240000]01        	cmp	byte [stmo], 1 
   415 00000325 7505                    	jne	short chk_24khz_2
   416 00000327 BB[7B110000]            	mov	ebx, load_24khz_mono_8_bit
   417                                  chk_24khz_2:
   418 0000032C B800200000              	mov	eax, 8192
   419 00000331 BA02000000              	mov	edx, 2
   420 00000336 B901000000              	mov	ecx, 1
   421 0000033B EB46                    	jmp	short set_sizes 
   422                                  chk_32khz:
   423 0000033D 663D007D                	cmp	ax, 32000
   424 00000341 7574                    	jne	short vra_needed
   425 00000343 803D[25240000]08        	cmp	byte [bps], 8
   426 0000034A 7615                    	jna	short chk_32khz_1
   427 0000034C BB[D0140000]            	mov	ebx, load_32khz_stereo_16_bit
   428 00000351 803D[24240000]01        	cmp	byte [stmo], 1 
   429 00000358 751A                    	jne	short chk_32khz_2
   430 0000035A BB[66140000]            	mov	ebx, load_32khz_mono_16_bit
   431 0000035F EB13                    	jmp	short chk_32khz_2
   432                                  chk_32khz_1:
   433 00000361 BB[C9130000]            	mov	ebx, load_32khz_stereo_8_bit
   434 00000366 803D[24240000]01        	cmp	byte [stmo], 1 
   435 0000036D 7505                    	jne	short chk_32khz_2
   436 0000036F BB[56130000]            	mov	ebx, load_32khz_mono_8_bit
   437                                  chk_32khz_2:
   438 00000374 B8AA2A0000              	mov	eax, 10922
   439 00000379 BA03000000              	mov	edx, 3
   440 0000037E B902000000              	mov	ecx, 2
   441                                  	;jmp	short set_sizes 
   442                                  set_sizes:
   443 00000383 803D[24240000]01        	cmp	byte [stmo], 1
   444 0000038A 7402                    	je	short ss_1
   445 0000038C D1E0                    	shl	eax, 1
   446                                  ss_1:
   447 0000038E 803D[25240000]08        	cmp	byte [bps], 8
   448 00000395 7602                    	jna	short ss_2
   449                                  	; 16 bit samples
   450 00000397 D1E0                    	shl	eax, 1
   451                                  ss_2:
   452 00000399 A3[D6030000]            	mov	[loadsize], eax
   453 0000039E F7E2                    	mul	edx
   454                                  	;cmp	ecx, 1
   455                                  	;je	short ss_3
   456                                  ;ss_3:
   457 000003A0 F7F1                    	div	ecx
   458 000003A2 8A0D[A0240000]          	mov	cl, [fbs_shift]
   459 000003A8 D3E0                    	shl	eax, cl
   460                                  	; 26/11/2023
   461                                  	;shr	eax, 1	; buffer size is 16 bit sample count
   462 000003AA A3[DA030000]            	mov	[buffersize], eax ; buffer size in bytes 
   463 000003AF 891D[D2030000]          	mov	[loadfromwavfile], ebx
   464 000003B5 EB27                    	jmp	short PlayNow
   465                                  
   466                                  vra_needed:
   467                                  	sys	_msg, msg_no_vra, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003B7 BB[7C220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003BC B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000003C1 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000003C6 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000003CB CD40                <1>  int 40h
   468 000003CD E9D1000000              	jmp	Exit
   469                                  
   470                                  	; 26/11/2023
   471                                  	; 13/11/2023
   472                                  loadfromwavfile:
   473 000003D2 [9F050000]              	dd	loadFromFile
   474                                  loadsize:	; read from wav file
   475 000003D6 00000000                	dd	0
   476                                  buffersize:	; write to DMA buffer
   477 000003DA 00000100                	dd	65536 ; bytes
   478                                  
   479                                  PlayNow: 
   480                                  
   481                                  ; 26/11/2023
   482                                  %if 1
   483                                  	; Allocate Audio Buffer (for user)
   484                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   485                                  	; 26/11/2023
   486                                  	sys	_audio, 0200h, [buffersize], audio_buffer
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003DE BB00020000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003E3 8B0D[DA030000]      <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000003E9 BA[00300000]        <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000003EE B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000003F3 CD40                <1>  int 40h
   487 000003F5 731B                    	jnc	short _2
   488                                  
   489                                  	; 26/11/2023 - temporary
   490                                  	;sys	_msg, test_1, 255, 0Ch
   491                                  
   492                                  error_exit:
   493                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003F7 BB[2B220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003FC B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000401 BA0E000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000406 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000040B CD40                <1>  int 40h
   494 0000040D E991000000              	jmp	Exit
   495                                  _2:
   496                                  	; DIRECT CGA (TEXT MODE) MEMORY ACCESS
   497                                  	; bl = 0, bh = 4
   498                                  	; Direct access/map to CGA (Text) memory (0B8000h)
   499                                  
   500                                  	sys	_video, 0400h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000412 BB00040000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000417 B81F000000          <1>  mov eax, %1
    86                              <1> 
    87 0000041C CD40                <1>  int 40h
   501 0000041E 3D00800B00              	cmp	eax, 0B8000h
   502 00000423 75D2                    	jne	short error_exit
   503                                  
   504                                  	; 01/06/2024
   505                                  	; Initialize Audio Device (bh = 3)
   506                                  	sys	_audio, 0301h, 0, audio_int_handler 
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000425 BB01030000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000042A B900000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000042F BA[6E050000]        <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000434 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000439 CD40                <1>  int 40h
   507                                  	;jc	short error_exit
   508 0000043B 0F8216FDFFFF            	jc	init_err
   509                                  _3:
   510                                  
   511                                  %endif
   512                                  
   513                                  ;
   514                                  ; position file pointer to start in actual wav data
   515                                  ; MUCH improvement should really be done here to check if sample size is
   516                                  ; supported, make sure there are 2 channels, etc.  
   517                                  ;
   518                                          ;mov     ah, 42h
   519                                          ;mov     al, 0	; from start of file
   520                                          ;mov     bx, [FileHandle]
   521                                          ;xor     cx, cx
   522                                          ;mov     dx, 44	; jump past .wav/riff header
   523                                          ;int     21h
   524                                  
   525                                  	sys	_seek, [FileHandle], 44, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000441 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000447 B92C000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000044C BA00000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000451 B813000000          <1>  mov eax, %1
    86                              <1> 
    87 00000456 CD40                <1>  int 40h
   526                                  
   527                                  	sys	_msg, nextline, 255, 07h ; 01/05/2017
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000458 BB[01230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000045D B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000462 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000467 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000046C CD40                <1>  int 40h
   528                                  
   529                                  ; play the .wav file. Most of the good stuff is in here.
   530                                  
   531 0000046E E8E1010000                      call    PlayWav
   532                                  
   533                                  ; close the .wav file and exit.
   534                                  
   535                                  StopPlaying:
   536                                  	; Stop Playing
   537                                  	sys	_audio, 0700h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000473 BB00070000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000478 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000047D CD40                <1>  int 40h
   538                                  	; Cancel callback service (for user)
   539                                  	sys	_audio, 0900h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000047F BB00090000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000484 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000489 CD40                <1>  int 40h
   540                                  	; Deallocate Audio Buffer (for user)
   541                                  	sys	_audio, 0A00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000048B BB000A0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000490 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000495 CD40                <1>  int 40h
   542                                  	; Disable Audio Device
   543                                  	sys	_audio, 0C00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000497 BB000C0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000049C B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000004A1 CD40                <1>  int 40h
   544                                  Exit:  
   545 000004A3 E847000000                      call    closeFile
   546                                           
   547                                  	sys	_exit	; Bye!
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004A8 B801000000          <1>  mov eax, %1
    86                              <1> 
    87 000004AD CD40                <1>  int 40h
   548                                  here:
   549 000004AF EBFE                    	jmp	short here
   550                                  
   551                                  pmsg_usage:
   552                                  	sys	_msg, msg_usage, 255, 0Bh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004B1 BB[C8210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000004B6 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000004BB BA0B000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004C0 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000004C5 CD40                <1>  int 40h
   553 000004C7 EBDA                    	jmp	short Exit
   554                                  
   555                                  	; 25/11/2023
   556                                  DetectAC97:
   557                                  	; Detect (BH=1) AC'97 (BL=2) Audio Device
   558                                          sys	_audio, 0102h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004C9 BB02010000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004CE B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000004D3 CD40                <1>  int 40h
   559                                  
   560                                  ; 01/06/2024
   561                                  %if 0
   562                                  	jc	short DetectAC97_retn
   563                                  
   564                                  	; 25/11/2023
   565                                  	; Get AC'97 Codec info
   566                                  	; (Function 14, sub function 1)
   567                                  	sys	_audio, 0E01h
   568                                  	; Save Variable Rate Audio support bit
   569                                  	and	al, 1
   570                                  	mov	[VRA], al
   571                                  %endif
   572                                  
   573                                  DetectAC97_retn:
   574 000004D5 C3                      	retn
   575                                  
   576                                  ;open or create file
   577                                  ;
   578                                  ;input: ds:dx-->filename (asciiz)
   579                                  ;       al=file Mode (create or open)
   580                                  ;output: none  cs:[FileHandle] filled
   581                                  ;
   582                                  openFile:
   583                                  	;mov	ah, 3Bh	; start with a mode
   584                                  	;add	ah, al	; add in create or open mode
   585                                  	;xor	ecx, ecx
   586                                  	;int	21h
   587                                  	;jc	short _of1
   588                                  	;;mov	[cs:FileHandle], ax
   589                                  
   590                                  	sys	_open, wav_file_name, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004D6 BB[4D240000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000004DB B900000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004E0 B805000000          <1>  mov eax, %1
    86                              <1> 
    87 000004E5 CD40                <1>  int 40h
   591 000004E7 7205                    	jc	short _of1
   592                                  
   593 000004E9 A3[0E210000]            	mov	[FileHandle], eax
   594                                  _of1:
   595 000004EE C3                      	retn
   596                                  
   597                                  ; close the currently open file
   598                                  ; input: none, uses cs:[FileHandle]
   599                                  closeFile:
   600 000004EF 833D[0E210000]FF        	cmp	dword [FileHandle], -1
   601 000004F6 7417                    	je	short _cf1
   602                                  	;mov    bx, [FileHandle]  
   603                                  	;mov    ax, 3E00h
   604                                          ;int    21h              ;close file
   605                                  
   606                                  	sys	_close, [FileHandle]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004F8 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004FE B806000000          <1>  mov eax, %1
    86                              <1> 
    87 00000503 CD40                <1>  int 40h
   607 00000505 C705[0E210000]FFFF-     	mov 	dword [FileHandle], -1
   607 0000050D FFFF               
   608                                  _cf1:
   609 0000050F C3                      	retn
   610                                  
   611                                  getSampleRate:
   612                                  	
   613                                  ; reads the sample rate from the .wav file.
   614                                  ; entry: none - assumes file is already open
   615                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   616                                  ;	cx = number of channels (mono=1, stereo=2)
   617                                  ;	dx = bits per sample (8, 16)
   618                                  
   619 00000510 53                      	push    ebx
   620                                  
   621                                          ;mov	ah, 42h
   622                                          ;mov	al, 0	; from start of file
   623                                          ;mov	bx, [FileHandle]
   624                                          ;xor	ecx, ecx
   625                                          ;mov	dx, 08h	; "WAVE"
   626                                          ;int	21h
   627                                  	
   628                                  	sys	_seek, [FileHandle], 8, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000511 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000517 B908000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000051C BA00000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000521 B813000000          <1>  mov eax, %1
    86                              <1> 
    87 00000526 CD40                <1>  int 40h
   629                                  
   630                                          ;mov	dx, smpRBuff
   631                                          ;mov	cx, 28	; 28 bytes
   632                                  	;mov	ah, 3fh
   633                                          ;int	21h
   634                                  
   635                                  	sys	_read, [FileHandle], smpRBuff, 28
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000528 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000052E B9[31240000]        <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000533 BA1C000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000538 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000053D CD40                <1>  int 40h
   636                                  
   637 0000053F 813D[31240000]5741-     	cmp	dword [smpRBuff], 'WAVE'
   637 00000547 5645               
   638 00000549 7520                    	jne	short gsr_stc
   639                                  
   640 0000054B 66833D[3D240000]01      	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   641 00000553 7516                    	jne	short gsr_stc
   642                                  
   643 00000555 668B0D[3F240000]        	mov	cx, [smpRBuff+14]	; return num of channels in CX
   644 0000055C 66A1[41240000]                  mov     ax, [smpRBuff+16]	; return sample rate in AX
   645 00000562 668B15[4B240000]        	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   646                                  gsr_retn:
   647 00000569 5B                              pop     ebx
   648 0000056A C3                              retn
   649                                  gsr_stc:
   650 0000056B F9                      	stc
   651 0000056C EBFB                    	jmp	short gsr_retn
   652                                  
   653                                  audio_int_handler:
   654                                  	; 18/08/2020 (14/10/2020, 'wavplay2.s')
   655                                  
   656                                  	;mov	byte [srb], 1 ; interrupt (or signal response byte)
   657                                  	
   658                                  	;cmp	byte [cbs_busy], 1
   659                                  	;jnb	short _callback_bsy_retn
   660                                  	
   661                                  	;mov	byte [cbs_busy], 1
   662                                  
   663 0000056E A0[2D240000]            	mov	al, [half_buff]
   664                                  
   665 00000573 3C01                    	cmp	al, 1
   666 00000575 721A                    	jb	short _callback_retn
   667                                  
   668                                  	; 18/08/2020
   669 00000577 C605[2E240000]01        	mov	byte [srb], 1
   670                                  
   671 0000057E 8035[2D240000]03        	xor	byte [half_buff], 3 ; 2->1, 1->2
   672                                  
   673 00000585 0430                    	add	al, '0'
   674                                  tL0:	; 26/11/2023
   675 00000587 B44E                    	mov	ah, 4Eh
   676 00000589 BB00800B00              	mov	ebx, 0B8000h ; video display page address
   677 0000058E 668903                  	mov	[ebx], ax ; show playing buffer (1, 2)
   678                                  _callback_retn:
   679                                  	;mov	byte [cbs_busy], 0
   680                                  _callback_bsy_retn:
   681                                  	sys	_rele ; return from callback service 
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000591 B827000000          <1>  mov eax, %1
    86                              <1> 
    87 00000596 CD40                <1>  int 40h
   682                                  	; we must not come here !
   683                                  	sys	_exit
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000598 B801000000          <1>  mov eax, %1
    86                              <1> 
    87 0000059D CD40                <1>  int 40h
   684                                  	
   685                                  loadFromFile:
   686                                  	; 26/11/2023
   687 0000059F F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
   688                                  					; last of the file?
   689 000005A6 7402                    	jz	short lff_0		; no
   690 000005A8 F9                      	stc
   691 000005A9 C3                      	retn
   692                                  lff_0:
   693                                  	; 13/06/2017
   694                                  	;mov	edx, BUFFERSIZE
   695                                  	; 26/11/2023
   696 000005AA BF[00300000]            	mov	edi, audio_buffer
   697 000005AF 8B15[DA030000]          	mov	edx, [buffersize]	; bytes
   698 000005B5 8A0D[A0240000]          	mov	cl, [fbs_shift]   
   699 000005BB 20C9                    	and	cl, cl
   700 000005BD 7409                    	jz	short lff_1 ; stereo, 16 bit
   701                                  
   702                                  	; fbs_shift =
   703                                  	;	2 for mono and 8 bit sample (multiplier = 4)
   704                                  	;	1 for mono or 8 bit sample (multiplier = 2)
   705 000005BF D3EA                    	shr	edx, cl
   706                                  	;inc	edx
   707                                  
   708 000005C1 BE[00300100]            	mov     esi, temp_buffer
   709 000005C6 EB02                    	jmp	short lff_2
   710                                  lff_1:
   711                                  	;mov	esi, audio_buffer
   712 000005C8 89FE                    	mov	esi, edi ; audio_buffer
   713                                  lff_2:
   714                                  	; 17/03/2017
   715                                  	; esi = buffer address
   716                                  	; edx = buffer size
   717                                   
   718                                  	; 26/11/2023
   719                                  	; load file into memory
   720                                  	sys 	_read, [FileHandle], esi
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000005CA 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000005D0 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000005D2 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000005D7 CD40                <1>  int 40h
   721 000005D9 89D1                    	mov	ecx, edx
   722 000005DB 724A                    	jc	short padfill ; error !
   723                                  
   724 000005DD 21C0                    	and	eax, eax
   725 000005DF 7446                    	jz	short padfill
   726                                  lff_3:
   727                                  	; 26/11/2023
   728 000005E1 8A1D[A0240000]          	mov	bl, [fbs_shift]
   729 000005E7 20DB                    	and	bl, bl
   730 000005E9 745C                    	jz	short lff_11
   731                                  
   732 000005EB 29C1                    	sub	ecx, eax
   733 000005ED 89CD                    	mov	ebp, ecx
   734                                  
   735                                  	;mov	esi, temp_buffer
   736                                  	;mov	edi, audio_buffer
   737 000005EF 89C1                    	mov	ecx, eax   ; byte count
   738                                  
   739 000005F1 803D[25240000]08        	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   740 000005F8 751E                    	jne	short lff_6 ; 16 bit samples
   741                                  	; 8 bit samples
   742 000005FA FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
   743 000005FC 740E                    	jz	short lff_5 ; 8 bit, stereo
   744                                  lff_4:
   745                                  	; mono & 8 bit
   746 000005FE AC                      	lodsb
   747 000005FF 2C80                    	sub	al, 80h ; 08/11/2023
   748 00000601 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   749 00000604 66AB                    	stosw	; left channel
   750 00000606 66AB                    	stosw	; right channel
   751 00000608 E2F4                    	loop	lff_4
   752 0000060A EB16                    	jmp	short lff_8
   753                                  lff_5:
   754                                  	; stereo & 8 bit
   755 0000060C AC                      	lodsb
   756 0000060D 2C80                    	sub	al, 80h ; 08/11/2023
   757 0000060F C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   758 00000612 66AB                    	stosw
   759 00000614 E2F6                    	loop	lff_5			
   760 00000616 EB0A                    	jmp	short lff_8
   761                                  lff_6:
   762 00000618 D1E9                    	shr	ecx, 1 ; word count
   763                                  lff_7:
   764 0000061A 66AD                    	lodsw
   765 0000061C 66AB                    	stosw	; left channel
   766 0000061E 66AB                    	stosw	; right channel
   767 00000620 E2F8                    	loop	lff_7
   768                                  lff_8:
   769                                  	; 27/11/2023
   770 00000622 F8                      	clc
   771 00000623 89E9                    	mov	ecx, ebp
   772 00000625 E314                    	jecxz	endLFF_retn
   773                                  	
   774                                  padfill:
   775 00000627 803D[25240000]10        	cmp 	byte [bps], 16
   776 0000062E 740C                    	je	short lff_10
   777                                  	; Minimum Value = 0
   778 00000630 30C0                            xor     al, al
   779 00000632 F3AA                    	rep	stosb
   780                                  lff_9:
   781 00000634 800D[2C240000]01                or	byte [flags], ENDOFFILE	; end of file flag
   782                                  endLFF_retn:
   783 0000063B C3                              retn
   784                                  lff_10:
   785 0000063C 31C0                    	xor	eax, eax
   786                                  	; Minimum value = 8000h (-32768)
   787 0000063E D1E9                    	shr	ecx, 1 
   788 00000640 B480                    	mov	ah, 80h ; ax = -32768
   789 00000642 F366AB                  	rep	stosw
   790 00000645 EBED                    	jmp	short lff_9
   791                                  
   792                                  lff_11:
   793                                  	; 16 bit stereo
   794                                  	; ecx = buffer size
   795                                  	; eax = read count
   796 00000647 29C1                    	sub	ecx, eax
   797 00000649 76F0                    	jna	short endLFF_retn
   798 0000064B 01C7                    	add	edi, eax  ; audio_buffer + eax
   799 0000064D EBED                    	jmp	short lff_10 ; padfill
   800                                  
   801                                  error_exit_2:
   802                                  	; 26/11/2023 - temporary
   803                                  	;sys	_msg, test_2, 255, 0Ch
   804                                  
   805 0000064F E9A3FDFFFF              	jmp	error_exit
   806                                  	
   807                                  	; 26/11/2023 - temporary
   808                                  ;test_1:
   809                                  ;	db 13, 10, 'Test 1', 13,10, 0
   810                                  ;test_2:
   811                                  ;	db 13, 10, 'Test 2', 13,10, 0
   812                                  	
   813                                  PlayWav:
   814                                  	; 26/11/2023
   815                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   816                                  	; 13/06/2017
   817                                  	; Convert 8 bit samples to 16 bit samples
   818                                  	; and convert mono samples to stereo samples
   819                                  
   820                                  	; 26/11/2023
   821                                  	; load 32768 bytes into audio buffer
   822                                  	;mov	edi, audio_buffer
   823                                  	;;mov	edx, BUFFERSIZE
   824                                  	; 26/11/2023
   825                                  	;mov	edx, [buffersize]
   826                                  	;call	loadFromFile
   827                                  	; 26/11/2023
   828 00000654 FF15[D2030000]          	call	dword [loadfromwavfile]
   829 0000065A 72F3                    	jc	short error_exit_2
   830 0000065C C605[2D240000]01        	mov	byte [half_buff], 1 ; (DMA) Buffer 1
   831                                  
   832                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   833 00000663 F605[2C240000]01        	test    byte [flags], ENDOFFILE  ; end of file
   834 0000066A 7512                    	jnz	short _6 ; yes
   835                                  			 ; bypass filling dma half buffer 2
   836                                  
   837                                  	; bh = 16 : update (current, first) dma half buffer
   838                                  	; bl = 0  : then switch to the next (second) half buffer
   839                                  	sys	_audio, 1000h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000066C BB00100000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000671 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000676 CD40                <1>  int 40h
   840                                  
   841                                  	; 18/08/2020
   842                                  	; [audio_flag] = 1 (in TRDOS 386 kernel)
   843                                  
   844                                  	; audio_buffer must be filled again after above system call 
   845                                  	; (Because audio interrupt will be generated by AC97 hardware
   846                                  	; at the end of the first half of dma buffer.. so, 
   847                                  	; the second half must be ready. 'sound_play' will use it.)
   848                                  
   849                                  	; 26/11/2023
   850                                  	;mov	edi, audio_buffer
   851                                  	;;mov	edx, BUFFERSIZE
   852                                  	; 26/11/2023
   853                                  	;mov	edx, [buffersize]
   854                                  	;call	loadFromFile
   855                                  	; 26/11/2023
   856 00000678 FF15[D2030000]          	call	dword [loadfromwavfile]
   857                                  	;jc	short p_return
   858                                  _6:
   859                                  	; Set Master Volume Level (BL=0 or 80h)
   860                                  	; 	for next playing (BL>=80h)
   861                                  	;sys	_audio, 0B80h, 1D1Dh
   862                                  	sys	_audio, 0B00h, 1D1Dh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000067E BB000B0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000683 B91D1D0000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000688 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000068D CD40                <1>  int 40h
   863                                  
   864                                  	; 18/08/2020
   865                                  	;mov	byte [volume_level], 1Dh
   866 0000068F 880D[2F240000]          	mov	[volume_level], cl
   867                                  
   868                                  	; Start	to play
   869 00000695 A0[25240000]            	mov	al, [bps]
   870 0000069A C0E804                  	shr	al, 4 ; 8 -> 0, 16 -> 1
   871 0000069D D0E0                    	shl	al, 1 ; 16 -> 2, 8 -> 0
   872 0000069F 8A1D[24240000]          	mov	bl, [stmo]
   873 000006A5 FECB                    	dec	bl
   874 000006A7 08C3                    	or	bl, al
   875 000006A9 668B0D[26240000]        	mov	cx, [sample_rate] 
   876 000006B0 B704                    	mov	bh, 4 ; start to play
   877                                  	sys	_audio
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000006B2 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000006B7 CD40                <1>  int 40h
   878                                  
   879                                  	;mov	ebx, 0B8000h ; video display page address
   880                                  	;mov	ah, 4Eh
   881                                  	;mov	al, [half_buffer]
   882                                  	;mov	[ebx], ax ; show playing buffer (1, 2)
   883                                  
   884                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   885                                  	; Here..
   886                                  	; If byte [flags] <> ENDOFFILE ...
   887                                  	; user's audio_buffer has been copied to dma half buffer 2
   888                                  
   889                                  	; [audio_flag] = 0 (in TRDOS 386 kernel)
   890                                  
   891                                  	; audio_buffer must be filled again after above system call 
   892                                  	; (Because, audio interrupt will be generated by VT8237R
   893                                  	; at the end of the first half of dma buffer.. so, 
   894                                  	; the 2nd half of dma buffer is ready but the 1st half
   895                                  	; must be filled again.)
   896                                  
   897                                  	; 18/08/2020
   898 000006B9 F605[2C240000]01        	test    byte [flags], ENDOFFILE  ; end of file
   899 000006C0 7506                    	jnz	short p_loop ; yes
   900                                  
   901                                  	; 18/08/2020
   902                                  	; load 32768 bytes into audio buffer
   903                                  	;; (for the second half of DMA buffer)
   904                                  	; 27/11/2023
   905                                  	; 20/05/2017
   906                                  	;mov	edi, audio_buffer
   907                                  	;mov	edx, BUFFERSIZE
   908                                  	; 26/11/2023
   909                                  	;mov	edx, [buffersize]
   910                                  	;call	loadFromFile
   911                                  	; 26/11/2023
   912 000006C2 FF15[D2030000]          	call	dword [loadfromwavfile]
   913                                  	;jc	short p_return
   914                                  	;mov	byte [half_buff], 2 ; (DMA) Buffer 2
   915                                  
   916                                  	; we need to wait for 'SRB' (audio interrupt)
   917                                  	; (we can not return from 'PlayWav' here 
   918                                  	;  even if we have got an error from file reading)
   919                                  	; ((!!current audio data must be played!!))
   920                                  
   921                                  	; 18/08/2020
   922                                  	;mov	byte [srb], 1
   923                                  
   924                                  p_loop:
   925                                  	;mov	ah, 1		; any key pressed?
   926                                  	;int	32h		; no, Loop.
   927                                  	;jz	short q_loop
   928                                  	;
   929                                  	;mov	ah, 0		; flush key buffer...
   930                                  	;int	32h
   931                                  
   932                                  	; 18/08/2020 (14/10/2017, 'wavplay2.s')
   933 000006C8 803D[2E240000]00        	cmp	byte [srb], 0
   934 000006CF 760F                    	jna	short q_loop
   935 000006D1 C605[2E240000]00        	mov	byte [srb], 0
   936                                  	; 27/11/2023
   937                                  	;mov	edi, audio_buffer
   938                                  	;mov	edx, BUFFERSIZE
   939                                  	; 26/11/2023
   940                                  	;mov	edx, [buffersize]
   941                                  	;call	loadFromFile
   942                                  	; 26/11/2023
   943 000006D8 FF15[D2030000]          	call	dword [loadfromwavfile]
   944 000006DE 7212                    	jc	short p_return
   945                                  q_loop:
   946 000006E0 B401                    	mov     ah, 1		; any key pressed?
   947 000006E2 CD32                    	int     32h		; no, Loop.
   948 000006E4 74E2                    	jz	short p_loop
   949                                  
   950 000006E6 B400                    	mov     ah, 0		; flush key buffer...
   951 000006E8 CD32                    	int     32h
   952                                  	
   953 000006EA 3C2B                    	cmp	al, '+' ; increase sound volume
   954 000006EC 740C                    	je	short inc_volume_level
   955 000006EE 3C2D                    	cmp	al, '-'
   956 000006F0 742B                    	je	short dec_volume_level
   957                                  
   958                                  p_return:
   959 000006F2 C605[2D240000]00        	mov	byte [half_buff], 0
   960 000006F9 C3                      	retn
   961                                  
   962                                  	; 18/08/2020 (14/10/2017, 'wavplay2.s')
   963                                  inc_volume_level:
   964 000006FA 8A0D[2F240000]          	mov	cl, [volume_level]
   965 00000700 80F91F                  	cmp	cl, 1Fh ; 31
   966 00000703 73DB                    	jnb	short q_loop
   967 00000705 FEC1                    	inc	cl
   968                                  change_volume_level:
   969 00000707 880D[2F240000]          	mov	[volume_level], cl
   970 0000070D 88CD                    	mov	ch, cl
   971                                  	; Set Master Volume Level
   972                                  	sys	_audio, 0B00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000070F BB000B0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000714 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000719 CD40                <1>  int 40h
   973 0000071B EBAB                    	jmp	short p_loop
   974                                  dec_volume_level:
   975 0000071D 8A0D[2F240000]          	mov	cl, [volume_level]
   976 00000723 80F901                  	cmp	cl, 1 ; 1
   977 00000726 76A0                    	jna	short p_loop
   978 00000728 FEC9                    	dec	cl
   979 0000072A EBDB                    	jmp	short change_volume_level
   980                                  
   981                                  write_audio_dev_info:
   982                                  	; EBX = Message address
   983                                  	; ECX = Max. message length (or stop on ZERO character)
   984                                  	;	(1 to 255)
   985                                  	; DL  = Message color (07h = light gray, 0Fh = white) 
   986                                       	sys 	_msg, msgAudioCardInfo, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000072C BB[9F210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000731 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000736 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000073B B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000740 CD40                <1>  int 40h
   987 00000742 C3                      	retn
   988                                  
   989                                  write_wav_file_info:
   990                                  	; 01/05/2017
   991                                  	sys	_msg, msgWavFileName, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000743 BB[B5220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000748 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000074D BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000752 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000757 CD40                <1>  int 40h
   992                                  	sys	_msg, wav_file_name, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000759 BB[4D240000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000075E B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000763 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000768 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000076D CD40                <1>  int 40h
   993                                  
   994                                  write_sample_rate:
   995                                  	; 01/05/2017
   996 0000076F 66A1[26240000]          	mov	ax, [sample_rate]
   997                                  	; ax = sample rate (hertz)
   998 00000775 31D2                    	xor	edx, edx
   999 00000777 66B90A00                	mov	cx, 10
  1000 0000077B 66F7F1                  	div	cx
  1001 0000077E 0015[DA220000]          	add	[msgHertz+4], dl
  1002 00000784 29D2                    	sub	edx, edx
  1003 00000786 66F7F1                  	div	cx
  1004 00000789 0015[D9220000]          	add	[msgHertz+3], dl
  1005 0000078F 29D2                    	sub	edx, edx
  1006 00000791 66F7F1                  	div	cx
  1007 00000794 0015[D8220000]          	add	[msgHertz+2], dl
  1008 0000079A 29D2                    	sub	edx, edx
  1009 0000079C 66F7F1                  	div	cx
  1010 0000079F 0015[D7220000]          	add	[msgHertz+1], dl
  1011 000007A5 0005[D6220000]          	add	[msgHertz], al
  1012                                  	
  1013                                  	sys	_msg, msgSampleRate, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000007AB BB[C7220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007B0 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000007B5 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000007BA B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000007BF CD40                <1>  int 40h
  1014                                  
  1015 000007C1 BE[F1220000]            	mov	esi, msg16Bits
  1016 000007C6 803D[25240000]10        	cmp	byte [bps], 16
  1017 000007CD 7405                    	je	short wsr_1
  1018 000007CF BE[E1220000]            	mov	esi, msg8Bits
  1019                                  wsr_1:
  1020                                  	sys	_msg, esi, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000007D4 89F3                <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007D6 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000007DB BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000007E0 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000007E5 CD40                <1>  int 40h
  1021                                  
  1022 000007E7 BE[EA220000]            	mov	esi, msgMono
  1023 000007EC 803D[24240000]01        	cmp	byte [stmo], 1
  1024 000007F3 7405                    	je	short wsr_2
  1025 000007F5 BE[FB220000]            	mov	esi, msgStereo		
  1026                                  wsr_2:
  1027                                  	sys	_msg, esi, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000007FA 89F3                <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007FC B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000801 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000806 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000080B CD40                <1>  int 40h
  1028 0000080D C3                              retn
  1029                                  
  1030                                  write_ac97_pci_dev_info:
  1031                                  	; 06/06/2017
  1032                                  	; 03/06/2017
  1033                                  	; BUS/DEV/FN
  1034                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1035                                  	; DEV/VENDOR
  1036                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1037                                  
  1038 0000080E 8B35[A1240000]          	mov	esi, [dev_vendor]
  1039 00000814 89F0                    	mov	eax, esi
  1040 00000816 0FB6D8                  	movzx	ebx, al
  1041 00000819 88DA                    	mov	dl, bl
  1042 0000081B 80E30F                  	and	bl, 0Fh
  1043 0000081E 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1044 00000824 A2[49230000]            	mov	[msgVendorId+3], al
  1045 00000829 88D3                    	mov	bl, dl
  1046 0000082B C0EB04                  	shr	bl, 4
  1047 0000082E 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1048 00000834 A2[48230000]            	mov	[msgVendorId+2], al
  1049 00000839 88E3                    	mov	bl, ah
  1050 0000083B 88DA                    	mov	dl, bl
  1051 0000083D 80E30F                  	and	bl, 0Fh
  1052 00000840 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1053 00000846 A2[47230000]            	mov	[msgVendorId+1], al
  1054 0000084B 88D3                    	mov	bl, dl
  1055 0000084D C0EB04                  	shr	bl, 4
  1056 00000850 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1057 00000856 A2[46230000]            	mov	[msgVendorId], al
  1058 0000085B C1E810                  	shr	eax, 16
  1059 0000085E 88C3                    	mov	bl, al
  1060 00000860 88DA                    	mov	dl, bl
  1061 00000862 80E30F                  	and	bl, 0Fh
  1062 00000865 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1063 0000086B A2[5A230000]            	mov	[msgDevId+3], al
  1064 00000870 88D3                    	mov	bl, dl
  1065 00000872 C0EB04                  	shr	bl, 4
  1066 00000875 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1067 0000087B A2[59230000]            	mov	[msgDevId+2], al
  1068 00000880 88E3                    	mov	bl, ah
  1069 00000882 88DA                    	mov	dl, bl
  1070 00000884 80E30F                  	and	bl, 0Fh
  1071 00000887 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1072 0000088D A2[58230000]            	mov	[msgDevId+1], al
  1073 00000892 88D3                    	mov	bl, dl
  1074 00000894 C0EB04                  	shr	bl, 4
  1075 00000897 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1076 0000089D A2[57230000]            	mov	[msgDevId], al
  1077                                  
  1078 000008A2 8B35[A5240000]          	mov	esi, [bus_dev_fn]
  1079 000008A8 C1EE08                  	shr	esi, 8
  1080 000008AB 6689F0                  	mov	ax, si
  1081 000008AE 88C3                    	mov	bl, al
  1082 000008B0 88DA                    	mov	dl, bl
  1083 000008B2 80E307                  	and	bl, 7 ; bit 0,1,2
  1084 000008B5 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1085 000008BB A2[7E230000]            	mov	[msgFncNo+1], al
  1086 000008C0 88D3                    	mov	bl, dl
  1087 000008C2 C0EB03                  	shr	bl, 3
  1088 000008C5 88DA                    	mov	dl, bl
  1089 000008C7 80E30F                  	and	bl, 0Fh
  1090 000008CA 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1091 000008D0 A2[70230000]            	mov	[msgDevNo+1], al
  1092 000008D5 88D3                    	mov	bl, dl
  1093 000008D7 C0EB04                  	shr	bl, 4
  1094 000008DA 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1095 000008E0 A2[6F230000]            	mov	[msgDevNo], al
  1096 000008E5 88E3                    	mov	bl, ah
  1097 000008E7 88DA                    	mov	dl, bl
  1098 000008E9 80E30F                  	and	bl, 0Fh
  1099 000008EC 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1100 000008F2 A2[64230000]            	mov	[msgBusNo+1], al
  1101 000008F7 88D3                    	mov	bl, dl
  1102 000008F9 C0EB04                  	shr	bl, 4
  1103 000008FC 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1104 00000902 A2[63230000]            	mov	[msgBusNo], al
  1105                                  
  1106 00000907 66A1[A9240000]          	mov	ax, [ac97_NamBar]
  1107 0000090D 88C3                    	mov	bl, al
  1108 0000090F 88DA                    	mov	dl, bl
  1109 00000911 80E30F                  	and	bl, 0Fh
  1110 00000914 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1111 0000091A A2[8D230000]            	mov	[msgNamBar+3], al
  1112 0000091F 88D3                    	mov	bl, dl
  1113 00000921 C0EB04                  	shr	bl, 4
  1114 00000924 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1115 0000092A A2[8C230000]            	mov	[msgNamBar+2], al
  1116 0000092F 88E3                    	mov	bl, ah
  1117 00000931 88DA                    	mov	dl, bl
  1118 00000933 80E30F                  	and	bl, 0Fh
  1119 00000936 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1120 0000093C A2[8B230000]            	mov	[msgNamBar+1], al
  1121 00000941 88D3                    	mov	bl, dl
  1122 00000943 C0EB04                  	shr	bl, 4
  1123 00000946 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1124 0000094C A2[8A230000]            	mov	[msgNamBar], al
  1125                                  
  1126 00000951 66A1[AB240000]          	mov	ax, [ac97_NabmBar]
  1127 00000957 88C3                    	mov	bl, al
  1128 00000959 88DA                    	mov	dl, bl
  1129 0000095B 80E30F                  	and	bl, 0Fh
  1130 0000095E 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1131 00000964 A2[9D230000]            	mov	[msgNabmBar+3], al
  1132 00000969 88D3                    	mov	bl, dl
  1133 0000096B C0EB04                  	shr	bl, 4
  1134 0000096E 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1135 00000974 A2[9C230000]            	mov	[msgNabmBar+2], al
  1136 00000979 88E3                    	mov	bl, ah
  1137 0000097B 88DA                    	mov	dl, bl
  1138 0000097D 80E30F                  	and	bl, 0Fh
  1139 00000980 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1140 00000986 A2[9B230000]            	mov	[msgNabmBar+1], al
  1141 0000098B 88D3                    	mov	bl, dl
  1142 0000098D C0EB04                  	shr	bl, 4
  1143 00000990 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1144 00000996 A2[9A230000]            	mov	[msgNabmBar], al
  1145                                  
  1146 0000099B 30E4                    	xor	ah, ah
  1147 0000099D A0[9F240000]            	mov	al, [ac97_int_ln_reg]
  1148 000009A2 B10A                    	mov	cl, 10
  1149 000009A4 F6F1                    	div	cl
  1150 000009A6 660105[A6230000]        	add	[msgIRQ], ax
  1151 000009AD 20C0                    	and	al, al
  1152 000009AF 750D                    	jnz	short _w_ac97imsg_
  1153 000009B1 A0[A7230000]            	mov	al, [msgIRQ+1]
  1154 000009B6 B420                    	mov	ah, ' '
  1155 000009B8 66A3[A6230000]          	mov	[msgIRQ], ax
  1156                                  _w_ac97imsg_:
  1157                                  	sys	_msg, msgAC97Info, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009BE BB[15230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009C3 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009C8 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000009CD B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000009D2 CD40                <1>  int 40h
  1158                                  
  1159 000009D4 C3                              retn
  1160                                  
  1161                                  write_VRA_info:
  1162                                  	; 25/11/2023
  1163                                  	sys	_msg, msgVRAheader, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009D5 BB[DE230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009DA B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009DF BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000009E4 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000009E9 CD40                <1>  int 40h
  1164 000009EB 803D[30240000]00        	cmp	byte [VRA], 0
  1165 000009F2 7617                    	jna	short _w_VRAi_no
  1166                                  _w_VRAi_yes:
  1167                                  	sys	_msg, msgVRAyes, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009F4 BB[EC230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009F9 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009FE BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000A03 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000A08 CD40                <1>  int 40h
  1168 00000A0A C3                      	retn
  1169                                  _w_VRAi_no:
  1170                                  	sys	_msg, msgVRAno, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000A0B BB[F2230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000A10 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000A15 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000A1A B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000A1F CD40                <1>  int 40h
  1171 00000A21 C3                      	retn
  1172                                  
  1173                                  	; 06/06/2024
  1174                                  write_codec_info:
  1175 00000A22 89DA                    	mov	edx, ebx
  1176 00000A24 83E30F                  	and	ebx, 0Fh
  1177 00000A27 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1178 00000A2D A2[D7230000]            	mov	[msgCodecId2+3], al
  1179 00000A32 88D3                    	mov	bl, dl
  1180 00000A34 C0EB04                  	shr	bl, 4
  1181 00000A37 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1182 00000A3D A2[D6230000]            	mov	[msgCodecId2+2], al
  1183 00000A42 88F3                    	mov	bl, dh
  1184 00000A44 80E30F                  	and	bl, 0Fh
  1185 00000A47 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1186 00000A4D A2[D5230000]            	mov	[msgCodecId2+1], al
  1187 00000A52 88F3                    	mov	bl, dh
  1188 00000A54 C0EB04                  	shr	bl, 4
  1189 00000A57 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1190 00000A5D A2[D4230000]            	mov	[msgCodecId2], al
  1191 00000A62 C1EA10                  	shr	edx, 16
  1192 00000A65 88D3                    	mov	bl, dl
  1193 00000A67 80E30F                  	and	bl, 0Fh
  1194 00000A6A 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1195 00000A70 A2[C4230000]            	mov	[msgCodecId1+3], al
  1196 00000A75 88D3                    	mov	bl, dl
  1197 00000A77 C0EB04                  	shr	bl, 4
  1198 00000A7A 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1199 00000A80 A2[C3230000]            	mov	[msgCodecId1+2], al
  1200 00000A85 88F3                    	mov	bl, dh
  1201 00000A87 80E30F                  	and	bl, 0Fh
  1202 00000A8A 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1203 00000A90 A2[C2230000]            	mov	[msgCodecId1+1], al
  1204 00000A95 88F3                    	mov	bl, dh
  1205 00000A97 C0EB04                  	shr	bl, 4
  1206 00000A9A 8A83[04230000]          	mov	al, [ebx+hex_chars]
  1207 00000AA0 A2[C1230000]            	mov	[msgCodecId1], al
  1208                                  	;
  1209                                  	sys	_msg, msgCodec, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000AA5 BB[AB230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000AAA B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000AAF BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000AB4 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000AB9 CD40                <1>  int 40h
  1210 00000ABB C3                      	retn
  1211                                  
  1212                                  ; 26/11/2023
  1213                                  ; 25/11/2023 - playwav6.s (32 bit registers, TRDOS 386 adaption)
  1214                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  1215                                  ; 14/11/2023
  1216                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1217                                  ; --------------------------------------------------------
  1218                                  
  1219                                  ;;Note:	At the end of every buffer load,
  1220                                  ;;	during buffer switch/swap, there will be discontinuity
  1221                                  ;;	between the last converted sample and the 1st sample
  1222                                  ;;	of the next buffer.
  1223                                  ;;	(like as a dot noises vaguely between normal sound samples)
  1224                                  ;;	-To avoid this defect, the 1st sample of
  1225                                  ;;	the next buffer may be read from the wav file but
  1226                                  ;;	the file pointer would need to be set to 1 sample back
  1227                                  ;;	again via seek system call. Time comsumption problem! -
  1228                                  ;;
  1229                                  ;;	Erdogan Tan - 15/11/2023
  1230                                  ;;
  1231                                  ;;	((If entire wav data would be loaded at once.. conversion
  1232                                  ;;	defect/noise would disappear.. but for DOS, to keep
  1233                                  ;;	64KB buffer limit is important also it is important
  1234                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1235                                  ;;	I have tested this program by using 2-30MB wav files.))
  1236                                  ;;
  1237                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1238                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1239                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1240                                  ;;			Realtek ALC850 codec.
  1241                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1242                                  
  1243                                  load_8khz_mono_8_bit:
  1244                                  	; 15/11/2023
  1245                                  	; 14/11/2023
  1246                                  	; 13/11/2023
  1247 00000ABC F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1248                                  					; last of the file?
  1249 00000AC3 7402                    	jz	short lff8m_0		; no
  1250 00000AC5 F9                      	stc
  1251 00000AC6 C3                      	retn
  1252                                  
  1253                                  lff8m_0:
  1254 00000AC7 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1255                                          ;mov	edx, [loadsize]
  1256                                  
  1257                                  	; esi = buffer address
  1258                                  	;; edx = buffer size
  1259                                  
  1260                                  	; load file into memory
  1261                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000ACC 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000AD2 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000AD4 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000ADA B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000ADF CD40                <1>  int 40h
  1262 00000AE1 7305                    	jnc	short lff8m_6
  1263 00000AE3 E9AF000000              	jmp	lff8m_5  ; error !
  1264                                  
  1265                                  lff8m_6:
  1266 00000AE8 BF[00300000]            	mov	edi, audio_buffer
  1267 00000AED 21C0                    	and	eax, eax
  1268 00000AEF 0F8499000000            	jz	lff8_eof
  1269                                  
  1270 00000AF5 89C1                    	mov	ecx, eax		; byte count
  1271                                  lff8m_1:
  1272 00000AF7 AC                      	lodsb
  1273 00000AF8 A2[05210000]            	mov	[previous_val], al
  1274 00000AFD 2C80                    	sub	al, 80h
  1275 00000AFF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1276 00000B03 66AB                    	stosw		; original sample (left channel)
  1277 00000B05 66AB                    	stosw		; original sample (right channel)
  1278                                  	;xor	eax, eax
  1279 00000B07 B080                    	mov	al, 80h
  1280 00000B09 49                      	dec	ecx
  1281 00000B0A 7402                    	jz	short lff8m_2
  1282 00000B0C 8A06                    	mov	al, [esi]
  1283                                  lff8m_2:
  1284                                  	;mov	[next_val], ax
  1285 00000B0E 88C7                    	mov	bh, al	; [next_val]
  1286 00000B10 8A25[05210000]          	mov	ah, [previous_val]
  1287 00000B16 00E0                    	add	al, ah	; [previous_val]
  1288 00000B18 D0D8                    	rcr	al, 1
  1289 00000B1A 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  1290 00000B1C 00E0                    	add	al, ah	; [previous_val]
  1291 00000B1E D0D8                    	rcr	al, 1	
  1292 00000B20 88C3                    	mov	bl, al 	; this is temporary interpolation value	
  1293 00000B22 00E0                    	add	al, ah	; [previous_val]
  1294 00000B24 D0D8                    	rcr	al, 1
  1295 00000B26 2C80                    	sub	al, 80h
  1296 00000B28 66C1E008                	shl	ax, 8	
  1297 00000B2C 66AB                    	stosw		; this is 1st interpolated sample (L)
  1298 00000B2E 66AB                    	stosw		; this is 1st interpolated sample (R)
  1299 00000B30 88D8                    	mov	al, bl
  1300 00000B32 00D0                    	add	al, dl
  1301 00000B34 D0D8                    	rcr	al, 1
  1302 00000B36 2C80                    	sub	al, 80h
  1303 00000B38 66C1E008                	shl	ax, 8
  1304 00000B3C 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1305 00000B3E 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1306 00000B40 88D0                    	mov	al, dl
  1307 00000B42 2C80                    	sub	al, 80h
  1308 00000B44 66C1E008                	shl	ax, 8
  1309 00000B48 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1310 00000B4A 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1311                                  	;mov	al, [next_val]
  1312 00000B4C 88F8                    	mov	al, bh
  1313 00000B4E 00D0                    	add	al, dl
  1314 00000B50 D0D8                    	rcr	al, 1
  1315 00000B52 88C3                    	mov	bl, al	; this is temporary interpolation value
  1316 00000B54 00D0                    	add	al, dl
  1317 00000B56 D0D8                    	rcr	al, 1
  1318 00000B58 2C80                    	sub	al, 80h
  1319 00000B5A 66C1E008                	shl	ax, 8
  1320 00000B5E 66AB                    	stosw		; this is 4th interpolated sample (L)
  1321 00000B60 66AB                    	stosw		; this is 4th interpolated sample (R)
  1322                                  	;mov	al, [next_val]
  1323 00000B62 88F8                    	mov	al, bh
  1324 00000B64 00D8                    	add	al, bl
  1325 00000B66 D0D8                    	rcr	al, 1
  1326 00000B68 2C80                    	sub	al, 80h
  1327 00000B6A 66C1E008                	shl	ax, 8
  1328 00000B6E 66AB                    	stosw		; this is 5th interpolated sample (L)
  1329 00000B70 66AB                    	stosw		; this is 5th interpolated sample (R)
  1330                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1331 00000B72 09C9                    	or	ecx, ecx
  1332 00000B74 7581                    	jnz	short lff8m_1
  1333                                  
  1334                                  	; --------------
  1335                                  
  1336                                  lff8s_3:
  1337                                  lff8m_3:
  1338                                  lff8s2_3:
  1339                                  lff8m2_3:
  1340                                  lff16s_3:
  1341                                  lff16m_3:
  1342                                  lff16s2_3:
  1343                                  lff16m2_3:
  1344                                  lff24_3:
  1345                                  lff32_3:
  1346                                  lff44_3:
  1347                                  lff22_3:
  1348                                  lff11_3:
  1349                                  	; 08/12/2024 (BugFix)
  1350                                  	; 01/06/2024 (BugFix)
  1351 00000B76 8B0D[DA030000]          	mov	ecx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1352                                  	;shl	ecx, 1	; byte count ; Bug !
  1353                                  	; 08/12/2024
  1354 00000B7C 81C1[00300000]          	add	ecx, audio_buffer
  1355 00000B82 29F9                    	sub	ecx, edi
  1356 00000B84 7607                    	jna	short lff8m_4
  1357                                  	;inc	ecx
  1358 00000B86 C1E902                  	shr	ecx, 2
  1359 00000B89 31C0                    	xor	eax, eax ; fill (remain part of) buffer with zeros	
  1360 00000B8B F3AB                    	rep	stosd
  1361                                  lff8m_4:
  1362                                  	; 01/06/2024 (BugFix)
  1363                                  	; cf=1 ; Bug !
  1364                                  	; 08/12/2024
  1365                                  	;clc
  1366 00000B8D C3                      	retn
  1367                                  
  1368                                  lff8_eof:
  1369                                  lff16_eof:
  1370                                  lff24_eof:
  1371                                  lff32_eof:
  1372                                  lff44_eof:
  1373                                  lff22_eof:
  1374                                  lff11_eof:
  1375                                  	; 15/11/2023
  1376 00000B8E C605[2C240000]01        	mov	byte [flags], ENDOFFILE
  1377 00000B95 EBDF                    	jmp	short lff8m_3
  1378                                  
  1379                                  lff8s_5:
  1380                                  lff8m_5:
  1381                                  lff8s2_5:
  1382                                  lff8m2_5:
  1383                                  lff16s_5:
  1384                                  lff16m_5:
  1385                                  lff16s2_5:
  1386                                  lff16m2_5:
  1387                                  lff24_5:
  1388                                  lff32_5:
  1389                                  lff44_5:
  1390                                  lff22_5:
  1391                                  lff11_5:
  1392 00000B97 B021                    	mov	al, '!'  ; error
  1393 00000B99 E8E9F9FFFF              	call	tL0
  1394                                  	
  1395                                  	;jmp	short lff8m_3
  1396                                  	; 15/11/2023
  1397 00000B9E EBEE                    	jmp	lff8_eof
  1398                                  
  1399                                  	; --------------
  1400                                  
  1401                                  load_8khz_stereo_8_bit:
  1402                                  	; 15/11/2023
  1403                                  	; 14/11/2023
  1404                                  	; 13/11/2023
  1405 00000BA0 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1406                                  					; last of the file?
  1407 00000BA7 7402                    	jz	short lff8s_0		; no
  1408 00000BA9 F9                      	stc
  1409 00000BAA C3                      	retn
  1410                                  
  1411                                  lff8s_0:
  1412 00000BAB BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1413                                          ;mov	edx, [loadsize]
  1414                                  
  1415                                  	; esi = buffer address
  1416                                  	;; edx = buffer size
  1417                                  
  1418                                  	; load file into memory
  1419                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000BB0 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000BB6 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000BB8 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000BBE B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000BC3 CD40                <1>  int 40h
  1420 00000BC5 72D0                    	jc	short lff8s_5 ; error !
  1421                                  
  1422 00000BC7 BF[00300000]            	mov	edi, audio_buffer
  1423                                  	
  1424 00000BCC D1E8                    	shr	eax, 1
  1425 00000BCE 74BE                    	jz	short lff8_eof
  1426                                  
  1427 00000BD0 89C1                    	mov	ecx, eax	; word count
  1428                                  lff8s_1:
  1429 00000BD2 AC                      	lodsb
  1430 00000BD3 A2[05210000]            	mov	[previous_val_l], al
  1431 00000BD8 2C80                    	sub	al, 80h
  1432 00000BDA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1433 00000BDE 66AB                    	stosw		; original sample (L)
  1434 00000BE0 AC                      	lodsb
  1435 00000BE1 A2[07210000]            	mov	[previous_val_r], al
  1436 00000BE6 2C80                    	sub	al, 80h
  1437 00000BE8 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1438 00000BEC 66AB                    	stosw		; original sample (R)
  1439                                  
  1440                                  	;xor	eax, eax
  1441 00000BEE 66B88080                	mov	ax, 8080h
  1442 00000BF2 49                      	dec	ecx
  1443 00000BF3 7403                    	jz	short lff8s_2
  1444                                  		; convert 8 bit sample to 16 bit sample
  1445 00000BF5 668B06                  	mov	ax, [esi]
  1446                                  lff8s_2:
  1447 00000BF8 A2[09210000]            	mov	[next_val_l], al
  1448 00000BFD 8825[0B210000]          	mov	[next_val_r], ah
  1449 00000C03 8A25[05210000]          	mov	ah, [previous_val_l]
  1450 00000C09 00E0                    	add	al, ah
  1451 00000C0B D0D8                    	rcr	al, 1
  1452 00000C0D 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1453 00000C0F 00E0                    	add	al, ah
  1454 00000C11 D0D8                    	rcr	al, 1	
  1455 00000C13 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1456 00000C15 00E0                    	add	al, ah
  1457 00000C17 D0D8                    	rcr	al, 1
  1458 00000C19 2C80                    	sub	al, 80h
  1459 00000C1B 66C1E008                	shl	ax, 8
  1460 00000C1F 66AB                    	stosw		; this is 1st interpolated sample (L)
  1461 00000C21 A0[0B210000]            	mov	al, [next_val_r]
  1462 00000C26 8A25[07210000]          	mov	ah, [previous_val_r]
  1463 00000C2C 00E0                    	add	al, ah
  1464 00000C2E D0D8                    	rcr	al, 1
  1465 00000C30 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1466 00000C32 00E0                    	add	al, ah
  1467 00000C34 D0D8                    	rcr	al, 1
  1468 00000C36 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1469 00000C38 00E0                    	add	al, ah
  1470 00000C3A D0D8                    	rcr	al, 1
  1471 00000C3C 2C80                    	sub	al, 80h
  1472 00000C3E 66C1E008                	shl	ax, 8
  1473 00000C42 66AB                    	stosw		; this is 1st interpolated sample (R)
  1474 00000C44 88D8                    	mov	al, bl
  1475 00000C46 00D0                    	add	al, dl
  1476 00000C48 D0D8                    	rcr	al, 1
  1477 00000C4A 2C80                    	sub	al, 80h
  1478 00000C4C 66C1E008                	shl	ax, 8
  1479 00000C50 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1480 00000C52 88F8                    	mov	al, bh
  1481 00000C54 00F0                    	add	al, dh
  1482 00000C56 D0D8                    	rcr	al, 1
  1483 00000C58 2C80                    	sub	al, 80h
  1484 00000C5A 66C1E008                	shl	ax, 8
  1485 00000C5E 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1486 00000C60 88D0                    	mov	al, dl
  1487 00000C62 2C80                    	sub	al, 80h
  1488 00000C64 66C1E008                	shl	ax, 8
  1489 00000C68 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1490 00000C6A 88F0                    	mov	al, dh
  1491 00000C6C 2C80                    	sub	al, 80h
  1492 00000C6E 66C1E008                	shl	ax, 8
  1493 00000C72 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1494 00000C74 A0[09210000]            	mov	al, [next_val_l]
  1495 00000C79 00D0                    	add	al, dl
  1496 00000C7B D0D8                    	rcr	al, 1
  1497 00000C7D 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1498 00000C7F 00D0                    	add	al, dl
  1499 00000C81 D0D8                    	rcr	al, 1
  1500 00000C83 2C80                    	sub	al, 80h
  1501 00000C85 66C1E008                	shl	ax, 8
  1502 00000C89 66AB                    	stosw		; this is 4th interpolated sample (L)
  1503 00000C8B A0[0B210000]            	mov	al, [next_val_r]
  1504 00000C90 00F0                    	add	al, dh
  1505 00000C92 D0D8                    	rcr	al, 1
  1506 00000C94 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1507 00000C96 00F0                    	add	al, dh
  1508 00000C98 D0D8                    	rcr	al, 1
  1509 00000C9A 2C80                    	sub	al, 80h
  1510 00000C9C 66C1E008                	shl	ax, 8
  1511 00000CA0 66AB                    	stosw		; this is 4th interpolated sample (R)
  1512 00000CA2 A0[09210000]            	mov	al, [next_val_l]
  1513 00000CA7 00D8                    	add	al, bl
  1514 00000CA9 D0D8                    	rcr	al, 1
  1515 00000CAB 2C80                    	sub	al, 80h
  1516 00000CAD 66C1E008                	shl	ax, 8
  1517 00000CB1 66AB                    	stosw		; this is 5th interpolated sample (L)
  1518 00000CB3 A0[0B210000]            	mov	al, [next_val_r]
  1519 00000CB8 00F8                    	add	al, bh
  1520 00000CBA D0D8                    	rcr	al, 1
  1521 00000CBC 2C80                    	sub	al, 80h
  1522 00000CBE 66C1E008                	shl	ax, 8
  1523 00000CC2 66AB                    	stosw		; this is 5th interpolated sample (R)
  1524                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1525 00000CC4 E305                    	jecxz	lff8s_6
  1526 00000CC6 E907FFFFFF              	jmp	lff8s_1
  1527                                  lff8s_6:
  1528 00000CCB E9A6FEFFFF              	jmp	lff8s_3
  1529                                  
  1530                                  load_8khz_mono_16_bit:
  1531                                  	; 13/11/2023
  1532 00000CD0 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1533                                  					; last of the file?
  1534 00000CD7 7402                    	jz	short lff8m2_0		; no
  1535 00000CD9 F9                      	stc
  1536 00000CDA C3                      	retn
  1537                                  
  1538                                  lff8m2_0:
  1539 00000CDB BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1540                                          ;mov	edx, [loadsize]
  1541                                  
  1542                                  	; esi = buffer address
  1543                                  	;; edx = buffer size
  1544                                  
  1545                                  	; load file into memory
  1546                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000CE0 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000CE6 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000CE8 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000CEE B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000CF3 CD40                <1>  int 40h
  1547 00000CF5 0F82A0000000            	jc	lff8m2_7 ; error !
  1548                                  
  1549 00000CFB BF[00300000]            	mov	edi, audio_buffer
  1550                                  	
  1551 00000D00 D1E8                    	shr	eax, 1
  1552 00000D02 7505                    	jnz	short lff8m2_8
  1553 00000D04 E985FEFFFF              	jmp	lff8_eof
  1554                                  
  1555                                  lff8m2_8:
  1556 00000D09 89C1                    	mov	ecx, eax	; word count
  1557                                  lff8m2_1:
  1558 00000D0B 66AD                    	lodsw
  1559 00000D0D 66AB                    	stosw		; original sample (left channel)
  1560 00000D0F 66AB                    	stosw		; original sample (right channel)
  1561 00000D11 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1562 00000D14 66A3[05210000]          	mov	[previous_val], ax
  1563 00000D1A 31C0                    	xor	eax, eax
  1564 00000D1C 49                      	dec	ecx
  1565 00000D1D 7403                    	jz	short lff8m2_2
  1566 00000D1F 668B06                  	mov	ax, [esi]
  1567                                  lff8m2_2:
  1568 00000D22 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  1569 00000D25 89C5                    	mov	ebp, eax	; [next_val]
  1570 00000D27 660305[05210000]        	add	ax, [previous_val]
  1571 00000D2E 66D1D8                  	rcr	ax, 1
  1572 00000D31 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample
  1573 00000D33 660305[05210000]        	add	ax, [previous_val]
  1574 00000D3A 66D1D8                  	rcr	ax, 1	; this is temporary interpolation value
  1575 00000D3D 89C3                    	mov	ebx, eax 		
  1576 00000D3F 660305[05210000]        	add	ax, [previous_val]
  1577 00000D46 66D1D8                  	rcr	ax, 1
  1578 00000D49 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1579 00000D4C 66AB                    	stosw		; this is 1st interpolated sample (L)
  1580 00000D4E 66AB                    	stosw		; this is 1st interpolated sample (R)
  1581 00000D50 89D8                    	mov	eax, ebx
  1582 00000D52 6601D0                  	add	ax, dx
  1583 00000D55 66D1D8                  	rcr	ax, 1
  1584 00000D58 80EC80                  	sub	ah, 80h
  1585 00000D5B 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1586 00000D5D 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1587 00000D5F 89D0                    	mov	eax, edx
  1588 00000D61 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1589 00000D64 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1590 00000D66 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1591 00000D68 89E8                    	mov	eax, ebp
  1592 00000D6A 6601D0                  	add	ax, dx
  1593 00000D6D 66D1D8                  	rcr	ax, 1
  1594 00000D70 89C3                    	mov	ebx, eax ; this is temporary interpolation value
  1595 00000D72 6601D0                  	add	ax, dx
  1596 00000D75 66D1D8                  	rcr	ax, 1
  1597 00000D78 80EC80                  	sub	ah, 80h
  1598 00000D7B 66AB                    	stosw		; this is 4th interpolated sample (L)
  1599 00000D7D 66AB                    	stosw		; this is 4th interpolated sample (R)
  1600 00000D7F 89E8                    	mov	eax, ebp
  1601 00000D81 6601D8                  	add	ax, bx
  1602 00000D84 66D1D8                  	rcr	ax, 1
  1603 00000D87 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1604 00000D8A 66AB                    	stosw		; this is 5th interpolated sample (L)
  1605 00000D8C 66AB                    	stosw		; this is 5th interpolated sample (R)
  1606                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1607 00000D8E 09C9                    	or	ecx, ecx
  1608 00000D90 0F8575FFFFFF            	jnz	lff8m2_1
  1609 00000D96 E9DBFDFFFF              	jmp	lff8m2_3
  1610                                  
  1611                                  lff8m2_7:
  1612                                  lff8s2_7:
  1613 00000D9B E9F7FDFFFF              	jmp	lff8m2_5  ; error
  1614                                  
  1615                                  load_8khz_stereo_16_bit:
  1616                                  	; 16/11/2023
  1617                                  	; 15/11/2023
  1618                                  	; 13/11/2023
  1619 00000DA0 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1620                                  					; last of the file?
  1621 00000DA7 7402                    	jz	short lff8s2_0		; no
  1622 00000DA9 F9                      	stc
  1623 00000DAA C3                      	retn
  1624                                  
  1625                                  lff8s2_0:
  1626 00000DAB BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1627                                          ;mov	edx, [loadsize]
  1628                                  
  1629                                  	; esi = buffer address
  1630                                  	;; edx = buffer size
  1631                                  
  1632                                  	; load file into memory
  1633                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000DB0 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000DB6 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000DB8 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000DBE B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000DC3 CD40                <1>  int 40h
  1634 00000DC5 72D4                    	jc	short lff8s2_7 ; error !
  1635                                  
  1636 00000DC7 BF[00300000]            	mov	edi, audio_buffer
  1637                                  	
  1638 00000DCC C1E802                  	shr	eax, 2
  1639 00000DCF 7505                    	jnz	short lff8s2_8
  1640 00000DD1 E9B8FDFFFF              	jmp	lff8_eof
  1641                                  
  1642                                  lff8s2_8:
  1643 00000DD6 89C1                    	mov	ecx, eax ; dword count
  1644                                  lff8s2_1:
  1645 00000DD8 66AD                    	lodsw
  1646 00000DDA 66AB                    	stosw		; original sample (L)
  1647                                  	; 15/11/2023
  1648 00000DDC 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1649 00000DDF 66A3[05210000]          	mov	[previous_val_l], ax
  1650 00000DE5 66AD                    	lodsw
  1651 00000DE7 66AB                    	stosw		; original sample (R)
  1652 00000DE9 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1653 00000DEC 66A3[07210000]          	mov	[previous_val_r], ax
  1654 00000DF2 31D2                    	xor	edx, edx
  1655 00000DF4 31C0                    	xor	eax, eax
  1656                                  	; 16/11/2023
  1657 00000DF6 49                      	dec	ecx
  1658 00000DF7 7407                    	jz	short lff8s2_2
  1659 00000DF9 668B06                  	mov	ax, [esi]
  1660 00000DFC 668B5602                	mov	dx, [esi+2]
  1661                                  lff8s2_2:
  1662 00000E00 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1663 00000E03 66A3[09210000]          	mov	[next_val_l], ax
  1664 00000E09 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  1665 00000E0C 668915[0B210000]        	mov	[next_val_r], dx
  1666 00000E13 660305[05210000]        	add	ax, [previous_val_l]
  1667 00000E1A 66D1D8                  	rcr	ax, 1
  1668 00000E1D 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample (L)
  1669 00000E1F 660305[05210000]        	add	ax, [previous_val_l]
  1670 00000E26 66D1D8                  	rcr	ax, 1	
  1671 00000E29 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1672 00000E2B 660305[05210000]        	add	ax, [previous_val_l]
  1673 00000E32 66D1D8                  	rcr	ax, 1
  1674 00000E35 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1675 00000E38 66AB                    	stosw		; this is 1st interpolated sample (L)
  1676 00000E3A 66A1[0B210000]          	mov	ax, [next_val_r]
  1677 00000E40 660305[07210000]        	add	ax, [previous_val_r]
  1678 00000E47 66D1D8                  	rcr	ax, 1
  1679 00000E4A 89C5                    	mov	ebp, eax ; this is interpolated middle (3th) sample (R)
  1680 00000E4C 660305[07210000]        	add	ax, [previous_val_r]
  1681 00000E53 66D1D8                  	rcr	ax, 1
  1682 00000E56 50                      	push	eax ; *	; this is temporary interpolation value (R)
  1683 00000E57 660305[07210000]        	add	ax, [previous_val_r]
  1684 00000E5E 66D1D8                  	rcr	ax, 1
  1685 00000E61 80EC80                  	sub	ah, 80h
  1686 00000E64 66AB                    	stosw		; this is 1st interpolated sample (R)
  1687 00000E66 89D8                    	mov	eax, ebx
  1688 00000E68 6601D0                  	add	ax, dx
  1689 00000E6B 66D1D8                  	rcr	ax, 1
  1690 00000E6E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1691 00000E71 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1692 00000E73 58                      	pop	eax ; *
  1693 00000E74 6601E8                  	add	ax, bp
  1694 00000E77 66D1D8                  	rcr	ax, 1
  1695 00000E7A 80EC80                  	sub	ah, 80h
  1696 00000E7D 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1697 00000E7F 89D0                    	mov	eax, edx
  1698 00000E81 80EC80                  	sub	ah, 80h
  1699 00000E84 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1700 00000E86 89E8                    	mov	eax, ebp
  1701 00000E88 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1702 00000E8B 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1703 00000E8D 66A1[09210000]          	mov	ax, [next_val_l]
  1704 00000E93 6601D0                  	add	ax, dx
  1705 00000E96 66D1D8                  	rcr	ax, 1
  1706 00000E99 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1707 00000E9B 6601D0                  	add	ax, dx
  1708 00000E9E 66D1D8                  	rcr	ax, 1
  1709 00000EA1 80EC80                  	sub	ah, 80h
  1710 00000EA4 66AB                    	stosw		; this is 4th interpolated sample (L)
  1711 00000EA6 66A1[0B210000]          	mov	ax, [next_val_r]
  1712 00000EAC 6601E8                  	add	ax, bp
  1713 00000EAF 66D1D8                  	rcr	ax, 1
  1714 00000EB2 50                      	push	eax ; ** ; this is temporary interpolation value (R)
  1715 00000EB3 6601E8                  	add	ax, bp
  1716 00000EB6 66D1D8                  	rcr	ax, 1
  1717 00000EB9 80EC80                  	sub	ah, 80h
  1718 00000EBC 66AB                    	stosw		; this is 4th interpolated sample (R)
  1719 00000EBE 66A1[09210000]          	mov	ax, [next_val_l]
  1720 00000EC4 6601D8                  	add	ax, bx
  1721 00000EC7 66D1D8                  	rcr	ax, 1
  1722 00000ECA 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1723 00000ECD 66AB                    	stosw		; this is 5th interpolated sample (L)
  1724 00000ECF 58                      	pop	eax ; **
  1725 00000ED0 660305[0B210000]        	add	ax, [next_val_r]
  1726 00000ED7 66D1D8                  	rcr	ax, 1
  1727 00000EDA 80EC80                  	sub	ah, 80h
  1728 00000EDD 66AB                    	stosw		; this is 5th interpolated sample (R)
  1729                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1730 00000EDF E305                    	jecxz	lff8_s2_9
  1731 00000EE1 E9F2FEFFFF              	jmp	lff8s2_1
  1732                                  lff8_s2_9:
  1733 00000EE6 E98BFCFFFF              	jmp	lff8s2_3
  1734                                  
  1735                                  ; .....................
  1736                                  
  1737                                  load_16khz_mono_8_bit:
  1738                                  	; 14/11/2023
  1739                                  	; 13/11/2023
  1740 00000EEB F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1741                                  					; last of the file?
  1742 00000EF2 7402                    	jz	short lff16m_0		; no
  1743 00000EF4 F9                      	stc
  1744 00000EF5 C3                      	retn
  1745                                  
  1746                                  lff16m_0:
  1747 00000EF6 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1748                                          ;mov	edx, [loadsize]
  1749                                  
  1750                                  	; esi = buffer address
  1751                                  	;; edx = buffer size
  1752                                  
  1753                                  	; load file into memory
  1754                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000EFB 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000F01 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000F03 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000F09 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000F0E CD40                <1>  int 40h
  1755 00000F10 7253                    	jc	short lff16m_7 ; error !
  1756                                  
  1757 00000F12 BF[00300000]            	mov	edi, audio_buffer
  1758                                  	
  1759 00000F17 21C0                    	and	eax, eax
  1760 00000F19 7505                    	jnz	short lff16m_8
  1761 00000F1B E96EFCFFFF              	jmp	lff16_eof
  1762                                  
  1763                                  lff16m_8:
  1764 00000F20 89C1                    	mov	ecx, eax		; byte count
  1765                                  lff16m_1:
  1766 00000F22 AC                      	lodsb
  1767                                  	;mov	[previous_val], al
  1768 00000F23 88C3                    	mov	bl, al
  1769 00000F25 2C80                    	sub	al, 80h
  1770 00000F27 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1771 00000F2B 66AB                    	stosw		; original sample (left channel)
  1772 00000F2D 66AB                    	stosw		; original sample (right channel)
  1773                                  	;xor	ax, ax
  1774                                  	; 14/11/22023
  1775 00000F2F B080                    	mov	al, 80h
  1776 00000F31 49                      	dec	ecx
  1777 00000F32 7402                    	jz	short lff16m_2
  1778 00000F34 8A06                    	mov	al, [esi]
  1779                                  lff16m_2:
  1780                                  	;mov	[next_val], al
  1781 00000F36 88C7                    	mov	bh, al
  1782                                  	;add	al, [previous_val]
  1783 00000F38 00D8                    	add	al, bl
  1784 00000F3A D0D8                    	rcr	al, 1
  1785 00000F3C 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  1786                                  	;add	al, [previous_val]
  1787 00000F3E 00D8                    	add	al, bl
  1788 00000F40 D0D8                    	rcr	al, 1
  1789 00000F42 2C80                    	sub	al, 80h
  1790 00000F44 66C1E008                	shl	ax, 8
  1791 00000F48 66AB                    	stosw		; this is 1st interpolated sample (L)
  1792 00000F4A 66AB                    	stosw		; this is 1st interpolated sample (R)
  1793                                  	;mov	al, [next_val]
  1794 00000F4C 88F8                    	mov	al, bh
  1795 00000F4E 00D0                    	add	al, dl
  1796 00000F50 D0D8                    	rcr	al, 1
  1797 00000F52 2C80                    	sub	al, 80h
  1798 00000F54 66C1E008                	shl	ax, 8
  1799 00000F58 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1800 00000F5A 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1801                                  	
  1802                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1803 00000F5C 09C9                    	or	ecx, ecx
  1804 00000F5E 75C2                    	jnz	short lff16m_1
  1805 00000F60 E911FCFFFF              	jmp	lff16m_3
  1806                                  
  1807                                  lff16m_7:
  1808                                  lff16s_7:
  1809 00000F65 E92DFCFFFF              	jmp	lff16m_5  ; error
  1810                                  
  1811                                  load_16khz_stereo_8_bit:
  1812                                  	; 14/11/2023
  1813                                  	; 13/11/2023
  1814 00000F6A F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1815                                  					; last of the file?
  1816 00000F71 7402                    	jz	short lff16s_0		; no
  1817 00000F73 F9                      	stc
  1818 00000F74 C3                      	retn
  1819                                  
  1820                                  lff16s_0:
  1821 00000F75 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1822                                          ;mov	edx, [loadsize]
  1823                                  
  1824                                  	; esi = buffer address
  1825                                  	;; edx = buffer size
  1826                                  
  1827                                  	; load file into memory
  1828                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000F7A 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000F80 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000F82 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000F88 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000F8D CD40                <1>  int 40h
  1829 00000F8F 72D4                    	jc	short lff16s_7 ; error !
  1830                                  
  1831 00000F91 BF[00300000]            	mov	edi, audio_buffer
  1832                                  	
  1833 00000F96 D1E8                    	shr	eax, 1
  1834 00000F98 7505                    	jnz	short lff16s_8
  1835 00000F9A E9EFFBFFFF              	jmp	lff16_eof
  1836                                  
  1837                                  lff16s_8:
  1838 00000F9F 89C1                    	mov	ecx, eax	; word count
  1839                                  lff16s_1:
  1840 00000FA1 AC                      	lodsb
  1841 00000FA2 A2[05210000]            	mov	[previous_val_l], al
  1842 00000FA7 2C80                    	sub	al, 80h
  1843 00000FA9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1844 00000FAD 66AB                    	stosw		; original sample (L)
  1845 00000FAF AC                      	lodsb
  1846 00000FB0 A2[07210000]            	mov	[previous_val_r], al
  1847 00000FB5 2C80                    	sub	al, 80h
  1848 00000FB7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1849 00000FBB 66AB                    	stosw		; original sample (R)
  1850                                  
  1851                                  	;xor	eax, eax
  1852 00000FBD 66B88080                	mov	ax, 8080h
  1853 00000FC1 49                      	dec	ecx
  1854 00000FC2 7403                    	jz	short lff16s_2
  1855                                  		; convert 8 bit sample to 16 bit sample
  1856 00000FC4 668B06                  	mov	ax, [esi]
  1857                                  lff16s_2:
  1858                                  	;mov	[next_val_l], al
  1859                                  	;mov	[next_val_r], ah
  1860 00000FC7 89C3                    	mov	ebx, eax
  1861 00000FC9 0205[05210000]          	add	al, [previous_val_l]
  1862 00000FCF D0D8                    	rcr	al, 1
  1863 00000FD1 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  1864 00000FD3 0205[05210000]          	add	al, [previous_val_l]
  1865 00000FD9 D0D8                    	rcr	al, 1
  1866 00000FDB 2C80                    	sub	al, 80h
  1867 00000FDD 66C1E008                	shl	ax, 8
  1868 00000FE1 66AB                    	stosw		; this is 1st interpolated sample (L)
  1869 00000FE3 88F8                    	mov	al, bh	; [next_val_r]
  1870 00000FE5 0205[07210000]          	add	al, [previous_val_r]
  1871 00000FEB D0D8                    	rcr	al, 1
  1872 00000FED 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  1873 00000FEF 0205[07210000]          	add	al, [previous_val_r]
  1874 00000FF5 D0D8                    	rcr	al, 1
  1875 00000FF7 2C80                    	sub	al, 80h
  1876 00000FF9 66C1E008                	shl	ax, 8
  1877 00000FFD 66AB                    	stosw		; this is 1st interpolated sample (R)
  1878 00000FFF 88D0                    	mov	al, dl
  1879 00001001 00D8                    	add	al, bl	; [next_val_l]
  1880 00001003 D0D8                    	rcr	al, 1
  1881 00001005 2C80                    	sub	al, 80h
  1882 00001007 66C1E008                	shl	ax, 8
  1883 0000100B 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1884 0000100D 88F0                    	mov	al, dh
  1885 0000100F 00F8                    	add	al, bh	; [next_val_r]
  1886 00001011 D0D8                    	rcr	al, 1
  1887 00001013 2C80                    	sub	al, 80h
  1888 00001015 66C1E008                	shl	ax, 8
  1889 00001019 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1890                                  	
  1891                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1892 0000101B 09C9                    	or	ecx, ecx
  1893 0000101D 7582                    	jnz	short lff16s_1
  1894 0000101F E952FBFFFF              	jmp	lff16s_3
  1895                                  
  1896                                  load_16khz_mono_16_bit:
  1897                                  	; 15/11/2023
  1898                                  	; 13/11/2023
  1899 00001024 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1900                                  					; last of the file?
  1901 0000102B 7402                    	jz	short lff16m2_0		; no
  1902 0000102D F9                      	stc
  1903 0000102E C3                      	retn
  1904                                  
  1905                                  lff16m2_0:
  1906 0000102F BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1907                                          ;mov	edx, [loadsize]
  1908                                  
  1909                                  	; esi = buffer address
  1910                                  	;; edx = buffer size
  1911                                  
  1912                                  	; load file into memory
  1913                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001034 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000103A 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000103C 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001042 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001047 CD40                <1>  int 40h
  1914 00001049 7255                    	jc	short lff16m2_7 ; error !
  1915                                  
  1916 0000104B BF[00300000]            	mov	edi, audio_buffer
  1917                                  	
  1918 00001050 D1E8                    	shr	eax, 1
  1919 00001052 7505                    	jnz	short lff16m2_8
  1920 00001054 E935FBFFFF              	jmp	lff16_eof
  1921                                  
  1922                                  lff16m2_8:
  1923 00001059 89C1                    	mov	ecx, eax  ; word count
  1924                                  lff16m2_1:
  1925 0000105B 66AD                    	lodsw
  1926 0000105D 66AB                    	stosw		; original sample (left channel)
  1927 0000105F 66AB                    	stosw		; original sample (right channel)
  1928 00001061 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  1929                                  	;mov	[previous_val], ax
  1930 00001064 89C3                    	mov	ebx, eax	
  1931 00001066 31C0                    	xor	eax, eax
  1932 00001068 49                      	dec	ecx
  1933 00001069 7403                    	jz	short lff16m2_2
  1934 0000106B 668B06                  	mov	ax, [esi]
  1935                                  lff16m2_2:
  1936 0000106E 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  1937 00001071 89C5                    	mov	ebp, eax	; [next_val]
  1938                                  	;add	ax, [previous_val]
  1939 00001073 6601D8                  	add	ax, bx
  1940 00001076 66D1D8                  	rcr	ax, 1
  1941 00001079 89C2                    	mov	edx, eax ; this is temporary interpolation value
  1942                                  	;add	ax, [previous_val]
  1943 0000107B 6601D8                  	add	ax, bx
  1944 0000107E 66D1D8                  	rcr	ax, 1
  1945 00001081 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1946 00001084 66AB                    	stosw		; this is 1st interpolated sample (L)
  1947 00001086 66AB                    	stosw		; this is 1st interpolated sample (R)
  1948 00001088 89E8                    	mov	eax, ebp 
  1949 0000108A 6601D0                  	add	ax, dx
  1950 0000108D 66D1D8                  	rcr	ax, 1
  1951 00001090 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1952 00001093 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1953 00001095 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1954                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1955 00001097 09C9                    	or	ecx, ecx
  1956 00001099 75C0                    	jnz	short lff16m2_1
  1957 0000109B E9D6FAFFFF              	jmp	lff16m2_3
  1958                                  
  1959                                  lff16m2_7:
  1960                                  lff16s2_7:
  1961 000010A0 E9F2FAFFFF              	jmp	lff16m2_5  ; error
  1962                                  
  1963                                  load_16khz_stereo_16_bit:
  1964                                  	; 16/11/2023
  1965                                  	; 15/11/2023
  1966                                  	; 13/11/2023
  1967 000010A5 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1968                                  					; last of the file?
  1969 000010AC 7402                    	jz	short lff16s2_0		; no
  1970 000010AE F9                      	stc
  1971 000010AF C3                      	retn
  1972                                  
  1973                                  lff16s2_0:
  1974 000010B0 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1975                                          ;mov	edx, [loadsize]
  1976                                  
  1977                                  	; esi = buffer address
  1978                                  	;; edx = buffer size
  1979                                  
  1980                                  	; load file into memory
  1981                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000010B5 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000010BB 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000010BD 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000010C3 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000010C8 CD40                <1>  int 40h
  1982 000010CA 72D4                    	jc	short lff16s2_7 ; error !
  1983                                  
  1984 000010CC BF[00300000]            	mov	edi, audio_buffer
  1985                                  	
  1986 000010D1 C1E802                  	shr	eax, 2
  1987 000010D4 7505                    	jnz	short lff16s2_8
  1988 000010D6 E9B3FAFFFF              	jmp	lff16_eof
  1989                                  
  1990                                  lff16s2_8:
  1991 000010DB 89C1                    	mov	ecx, eax  ; dword count
  1992                                  lff16s2_1:
  1993 000010DD 66AD                    	lodsw
  1994 000010DF 66AB                    	stosw		; original sample (L)
  1995 000010E1 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  1996 000010E4 66A3[05210000]          	mov	[previous_val_l], ax
  1997 000010EA 66AD                    	lodsw
  1998 000010EC 66AB                    	stosw		; original sample (R)
  1999 000010EE 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2000 000010F1 66A3[07210000]          	mov	[previous_val_r], ax
  2001 000010F7 31D2                    	xor	edx, edx
  2002 000010F9 31C0                    	xor	eax, eax
  2003                                  	; 16/11/2023
  2004 000010FB 49                      	dec	ecx
  2005 000010FC 7407                    	jz	short lff16s2_2
  2006 000010FE 668B06                  	mov	ax, [esi]
  2007 00001101 668B5602                	mov	dx, [esi+2]
  2008                                  lff16s2_2:
  2009 00001105 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2010                                  	;mov	[next_val_l], ax
  2011 00001108 89C5                    	mov	ebp, eax
  2012 0000110A 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2013 0000110D 668915[0B210000]        	mov	[next_val_r], dx
  2014 00001114 660305[05210000]        	add	ax, [previous_val_l]
  2015 0000111B 66D1D8                  	rcr	ax, 1
  2016 0000111E 89C2                    	mov	edx, eax ; this is temporary interpolation value (L)
  2017 00001120 660305[05210000]        	add	ax, [previous_val_l]
  2018 00001127 66D1D8                  	rcr	ax, 1
  2019 0000112A 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2020 0000112D 66AB                    	stosw		; this is 1st interpolated sample (L)
  2021 0000112F 66A1[0B210000]          	mov	ax, [next_val_r]
  2022 00001135 660305[07210000]        	add	ax, [previous_val_r]
  2023 0000113C 66D1D8                  	rcr	ax, 1
  2024 0000113F 89C3                    	mov	ebx, eax ; this is temporary interpolation value (R)
  2025 00001141 660305[07210000]        	add	ax, [previous_val_r]
  2026 00001148 66D1D8                  	rcr	ax, 1
  2027 0000114B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2028 0000114E 66AB                    	stosw		; this is 1st interpolated sample (R)
  2029                                  	;mov	ax, [next_val_l]
  2030 00001150 89E8                    	mov	eax, ebp
  2031 00001152 6601D0                  	add	ax, dx
  2032 00001155 66D1D8                  	rcr	ax, 1
  2033 00001158 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2034 0000115B 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2035 0000115D 66A1[0B210000]          	mov	ax, [next_val_r]
  2036 00001163 6601D8                  	add	ax, bx
  2037 00001166 66D1D8                  	rcr	ax, 1
  2038 00001169 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2039 0000116C 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  2040                                  	
  2041                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2042 0000116E 09C9                    	or	ecx, ecx
  2043 00001170 0F8567FFFFFF            	jnz	lff16s2_1
  2044 00001176 E9FBF9FFFF              	jmp	lff16s2_3
  2045                                  
  2046                                  ; .....................
  2047                                  
  2048                                  load_24khz_mono_8_bit:
  2049                                  	; 15/11/2023
  2050 0000117B F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2051                                  					; last of the file?
  2052 00001182 7402                    	jz	short lff24m_0		; no
  2053 00001184 F9                      	stc
  2054 00001185 C3                      	retn
  2055                                  
  2056                                  lff24m_0:
  2057 00001186 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2058                                          ;mov	edx, [loadsize]
  2059                                  
  2060                                  	; esi = buffer address
  2061                                  	;; edx = buffer size
  2062                                  
  2063                                  	; load file into memory
  2064                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000118B 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001191 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001193 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001199 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000119E CD40                <1>  int 40h
  2065 000011A0 723B                    	jc	short lff24m_7 ; error !
  2066                                  
  2067 000011A2 BF[00300000]            	mov	edi, audio_buffer
  2068                                  	
  2069 000011A7 21C0                    	and	eax, eax
  2070 000011A9 7505                    	jnz	short lff24m_8
  2071 000011AB E9DEF9FFFF              	jmp	lff24_eof
  2072                                  
  2073                                  lff24m_8:
  2074 000011B0 89C1                    	mov	ecx, eax	; byte count
  2075                                  lff24m_1:
  2076 000011B2 AC                      	lodsb
  2077                                  	;mov	[previous_val], al
  2078 000011B3 88C3                    	mov	bl, al
  2079 000011B5 2C80                    	sub	al, 80h
  2080 000011B7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2081 000011BB 66AB                    	stosw		; original sample (left channel)
  2082 000011BD 66AB                    	stosw		; original sample (right channel)
  2083                                  	;xor	eax, eax
  2084 000011BF B080                    	mov	al, 80h
  2085 000011C1 49                      	dec	ecx
  2086 000011C2 7402                    	jz	short lff24m_2
  2087 000011C4 8A06                    	mov	al, [esi]
  2088                                  lff24m_2:
  2089                                  	;;mov	[next_val], al
  2090                                  	;mov	bh, al
  2091                                  	;add	al, [previous_val]
  2092 000011C6 00D8                    	add	al, bl
  2093 000011C8 D0D8                    	rcr	al, 1
  2094 000011CA 2C80                    	sub	al, 80h
  2095 000011CC 66C1E008                	shl	ax, 8
  2096 000011D0 66AB                    	stosw		; this is interpolated sample (L)
  2097 000011D2 66AB                    	stosw		; this is interpolated sample (R)
  2098                                  	
  2099                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2100 000011D4 09C9                    	or	ecx, ecx
  2101 000011D6 75DA                    	jnz	short lff24m_1
  2102 000011D8 E999F9FFFF              	jmp	lff24_3
  2103                                  
  2104                                  lff24m_7:
  2105                                  lff24s_7:
  2106 000011DD E9B5F9FFFF              	jmp	lff24_5  ; error
  2107                                  
  2108                                  load_24khz_stereo_8_bit:
  2109                                  	; 15/11/2023
  2110 000011E2 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2111                                  					; last of the file?
  2112 000011E9 7402                    	jz	short lff24s_0		; no
  2113 000011EB F9                      	stc
  2114 000011EC C3                      	retn
  2115                                  
  2116                                  lff24s_0:
  2117 000011ED BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2118                                          ;mov	edx, [loadsize]
  2119                                  
  2120                                  	; esi = buffer address
  2121                                  	;; edx = buffer size
  2122                                  
  2123                                  	; load file into memory
  2124                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000011F2 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000011F8 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000011FA 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001200 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001205 CD40                <1>  int 40h
  2125 00001207 72D4                    	jc	short lff24s_7 ; error !
  2126                                  
  2127 00001209 BF[00300000]            	mov	edi, audio_buffer
  2128                                  	
  2129 0000120E D1E8                    	shr	eax, 1
  2130 00001210 7505                    	jnz	short lff24s_8
  2131 00001212 E977F9FFFF              	jmp	lff24_eof
  2132                                  
  2133                                  lff24s_8:
  2134 00001217 89C1                    	mov	ecx, eax  ; word count
  2135                                  lff24s_1:
  2136 00001219 AC                      	lodsb
  2137 0000121A A2[05210000]            	mov	[previous_val_l], al
  2138 0000121F 2C80                    	sub	al, 80h
  2139 00001221 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2140 00001225 66AB                    	stosw		; original sample (L)
  2141 00001227 AC                      	lodsb
  2142 00001228 A2[07210000]            	mov	[previous_val_r], al
  2143 0000122D 2C80                    	sub	al, 80h
  2144 0000122F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2145 00001233 66AB                    	stosw		; original sample (R)
  2146                                  
  2147                                  	;xor	eax, eax
  2148 00001235 66B88080                	mov	ax, 8080h
  2149 00001239 49                      	dec	ecx
  2150 0000123A 7403                    	jz	short lff24s_2
  2151                                  		; convert 8 bit sample to 16 bit sample
  2152 0000123C 668B06                  	mov	ax, [esi]
  2153                                  lff24s_2:
  2154                                  	;;mov	[next_val_l], al
  2155                                  	;;mov	[next_val_r], ah
  2156                                  	;mov	bx, ax
  2157 0000123F 88E7                    	mov	bh, ah
  2158 00001241 0205[05210000]          	add	al, [previous_val_l]
  2159 00001247 D0D8                    	rcr	al, 1
  2160                                  	;mov	dl, al
  2161 00001249 2C80                    	sub	al, 80h
  2162 0000124B 66C1E008                	shl	ax, 8
  2163 0000124F 66AB                    	stosw		; this is interpolated sample (L)
  2164 00001251 88F8                    	mov	al, bh	; [next_val_r]
  2165 00001253 0205[07210000]          	add	al, [previous_val_r]
  2166 00001259 D0D8                    	rcr	al, 1
  2167                                  	;mov	dh, al
  2168 0000125B 2C80                    	sub	al, 80h
  2169 0000125D 66C1E008                	shl	ax, 8
  2170 00001261 66AB                    	stosw		; this is interpolated sample (R)
  2171                                  		
  2172                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2173 00001263 09C9                    	or	ecx, ecx
  2174 00001265 75B2                    	jnz	short lff24s_1
  2175 00001267 E90AF9FFFF              	jmp	lff24_3
  2176                                  
  2177                                  load_24khz_mono_16_bit:
  2178                                  	; 15/11/2023
  2179 0000126C F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2180                                  					; last of the file?
  2181 00001273 7402                    	jz	short lff24m2_0		; no
  2182 00001275 F9                      	stc
  2183 00001276 C3                      	retn
  2184                                  
  2185                                  lff24m2_0:
  2186 00001277 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2187                                          ;mov	edx, [loadsize]
  2188                                  
  2189                                  	; esi = buffer address
  2190                                  	;; edx = buffer size
  2191                                  
  2192                                  	; load file into memory
  2193                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000127C 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001282 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001284 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000128A B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000128F CD40                <1>  int 40h
  2194 00001291 7237                    	jc	short lff24m2_7 ; error !
  2195                                  
  2196 00001293 BF[00300000]            	mov	edi, audio_buffer
  2197                                  	
  2198 00001298 D1E8                    	shr	eax, 1
  2199 0000129A 7505                    	jnz	short lff24m2_8
  2200 0000129C E9EDF8FFFF              	jmp	lff24_eof
  2201                                  
  2202                                  lff24m2_8:
  2203 000012A1 89C1                    	mov	ecx, eax  ; word count
  2204                                  lff24m2_1:
  2205 000012A3 66AD                    	lodsw
  2206 000012A5 66AB                    	stosw		; original sample (left channel)
  2207 000012A7 66AB                    	stosw		; original sample (right channel)
  2208 000012A9 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2209                                  	;mov	[previous_val], ax
  2210                                  	;mov	ebx, eax	
  2211                                  	;xor	eax, eax
  2212 000012AC 31DB                    	xor	ebx, ebx
  2213 000012AE 49                      	dec	ecx
  2214 000012AF 7403                    	jz	short lff24m2_2
  2215                                  	;mov	ax, [esi]
  2216 000012B1 668B1E                  	mov	bx, [esi]
  2217                                  lff24m2_2:
  2218                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2219                                  	;mov	ebp, eax	; [next_val]
  2220                                  	;add	ax, [previous_val]
  2221                                  	; ax = [previous_val]
  2222                                  	; bx = [next_val]
  2223 000012B4 6601D8                  	add	ax, bx
  2224 000012B7 66D1D8                  	rcr	ax, 1
  2225 000012BA 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2226 000012BD 66AB                    	stosw		; this is interpolated sample (L)
  2227 000012BF 66AB                    	stosw		; this is interpolated sample (R)
  2228                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2229 000012C1 09C9                    	or	ecx, ecx
  2230 000012C3 75DE                    	jnz	short lff24m2_1
  2231 000012C5 E9ACF8FFFF              	jmp	lff24_3
  2232                                  
  2233                                  lff24m2_7:
  2234                                  lff24s2_7:
  2235 000012CA E9C8F8FFFF              	jmp	lff24_5  ; error
  2236                                  
  2237                                  load_24khz_stereo_16_bit:
  2238                                  	; 16/11/2023
  2239                                  	; 15/11/2023
  2240 000012CF F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2241                                  					; last of the file?
  2242 000012D6 7402                    	jz	short lff24s2_0		; no
  2243 000012D8 F9                      	stc
  2244 000012D9 C3                      	retn
  2245                                  
  2246                                  lff24s2_0:
  2247 000012DA BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2248                                          ;mov	edx, [loadsize]
  2249                                  
  2250                                  	; esi = buffer address
  2251                                  	;; edx = buffer size
  2252                                  
  2253                                  	; load file into memory
  2254                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000012DF 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000012E5 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000012E7 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000012ED B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000012F2 CD40                <1>  int 40h
  2255 000012F4 72D4                    	jc	short lff24s2_7 ; error !
  2256                                  
  2257 000012F6 BF[00300000]            	mov	edi, audio_buffer
  2258                                  	
  2259 000012FB C1E802                  	shr	eax, 2
  2260 000012FE 7505                    	jnz	short lff24s2_8
  2261 00001300 E989F8FFFF              	jmp	lff24_eof
  2262                                  
  2263                                  lff24s2_8:
  2264 00001305 89C1                    	mov	ecx, eax  ; dword count
  2265                                  lff24s2_1:
  2266 00001307 66AD                    	lodsw
  2267 00001309 66AB                    	stosw		; original sample (L)
  2268 0000130B 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2269 0000130E 66A3[05210000]          	mov	[previous_val_l], ax
  2270 00001314 66AD                    	lodsw
  2271 00001316 66AB                    	stosw		; original sample (R)
  2272 00001318 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2273                                  	;mov	[previous_val_r], ax
  2274 0000131B 89C3                    	mov	ebx, eax
  2275 0000131D 31D2                    	xor	edx, edx
  2276 0000131F 31C0                    	xor	eax, eax
  2277                                  	; 16/11/2023
  2278 00001321 49                      	dec	ecx
  2279 00001322 7407                    	jz	short lff24s2_2
  2280 00001324 668B06                  	mov	ax, [esi]
  2281 00001327 668B5602                	mov	dx, [esi+2]
  2282                                  lff24s2_2:
  2283 0000132B 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2284                                  	;;mov	[next_val_l], ax
  2285                                  	;mov	ebp, eax
  2286 0000132E 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2287                                  	;mov	[next_val_r], dx
  2288 00001331 660305[05210000]        	add	ax, [previous_val_l]
  2289 00001338 66D1D8                  	rcr	ax, 1
  2290 0000133B 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2291 0000133E 66AB                    	stosw		; this is interpolated sample (L)
  2292                                  	;mov	ax, [next_val_r]
  2293 00001340 89D0                    	mov	eax, edx
  2294                                  	;add	ax, [previous_val_r]
  2295 00001342 6601D8                  	add	ax, bx
  2296 00001345 66D1D8                  	rcr	ax, 1
  2297 00001348 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2298 0000134B 66AB                    	stosw		; this is interpolated sample (R)
  2299                                  	
  2300                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2301 0000134D 09C9                    	or	ecx, ecx
  2302 0000134F 75B6                    	jnz	short lff24s2_1
  2303 00001351 E920F8FFFF              	jmp	lff24_3
  2304                                  
  2305                                  ; .....................
  2306                                  
  2307                                  load_32khz_mono_8_bit:
  2308                                  	; 15/11/2023
  2309 00001356 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2310                                  					; last of the file?
  2311 0000135D 7402                    	jz	short lff32m_0		; no
  2312 0000135F F9                      	stc
  2313 00001360 C3                      	retn
  2314                                  
  2315                                  lff32m_0:
  2316 00001361 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2317                                          ;mov	edx, [loadsize]
  2318                                  
  2319                                  	; esi = buffer address
  2320                                  	;; edx = buffer size
  2321                                  
  2322                                  	; load file into memory
  2323                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001366 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000136C 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000136E 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001374 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001379 CD40                <1>  int 40h
  2324 0000137B 7247                    	jc	short lff32m_7 ; error !
  2325                                  
  2326 0000137D BF[00300000]            	mov	edi, audio_buffer
  2327                                  	
  2328 00001382 21C0                    	and	eax, eax
  2329 00001384 7505                    	jnz	short lff32m_8
  2330 00001386 E903F8FFFF              	jmp	lff32_eof
  2331                                  
  2332                                  lff32m_8:
  2333 0000138B 89C1                    	mov	ecx, eax	; byte count
  2334                                  lff32m_1:
  2335 0000138D AC                      	lodsb
  2336                                  	;mov	[previous_val], al
  2337 0000138E 88C3                    	mov	bl, al
  2338 00001390 2C80                    	sub	al, 80h
  2339 00001392 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2340 00001396 66AB                    	stosw		; original sample (left channel)
  2341 00001398 66AB                    	stosw		; original sample (right channel)
  2342                                  	;xor	eax, eax
  2343 0000139A B080                    	mov	al, 80h
  2344 0000139C 49                      	dec	ecx
  2345 0000139D 7402                    	jz	short lff32m_2
  2346 0000139F 8A06                    	mov	al, [esi]
  2347                                  lff32m_2:
  2348                                  	;;mov	[next_val], al
  2349                                  	;mov	bh, al
  2350                                  	;add	al, [previous_val]
  2351 000013A1 00D8                    	add	al, bl
  2352 000013A3 D0D8                    	rcr	al, 1
  2353 000013A5 2C80                    	sub	al, 80h
  2354 000013A7 66C1E008                	shl	ax, 8
  2355 000013AB 66AB                    	stosw		; this is interpolated sample (L)
  2356 000013AD 66AB                    	stosw		; this is interpolated sample (R)
  2357                                  	
  2358                                  	; different than 8-16-24 kHZ !
  2359                                  	; 'original-interpolated-original' trio samples 
  2360 000013AF E30E                    	jecxz	lff32m_3
  2361                                  
  2362 000013B1 AC                      	lodsb
  2363 000013B2 2C80                    	sub	al, 80h
  2364 000013B4 66C1E008                	shl	ax, 8
  2365 000013B8 66AB                    	stosw		; original sample (left channel)
  2366 000013BA 66AB                    	stosw		; original sample (right channel)
  2367                                  
  2368                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2369 000013BC 49                      	dec	ecx
  2370 000013BD 75CE                    	jnz	short lff32m_1
  2371                                  lff32m_3:
  2372 000013BF E9B2F7FFFF              	jmp	lff32_3
  2373                                  
  2374                                  lff32m_7:
  2375                                  lff32s_7:
  2376 000013C4 E9CEF7FFFF              	jmp	lff32_5  ; error
  2377                                  
  2378                                  load_32khz_stereo_8_bit:
  2379                                  	; 15/11/2023
  2380 000013C9 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2381                                  					; last of the file?
  2382 000013D0 7402                    	jz	short lff32s_0		; no
  2383 000013D2 F9                      	stc
  2384 000013D3 C3                      	retn
  2385                                  
  2386                                  lff32s_0:
  2387 000013D4 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2388                                          ;mov	edx, [loadsize]
  2389                                  
  2390                                  	; esi = buffer address
  2391                                  	;; edx = buffer size
  2392                                  
  2393                                  	; load file into memory
  2394                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000013D9 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000013DF 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000013E1 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000013E7 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000013EC CD40                <1>  int 40h
  2395 000013EE 72D4                    	jc	short lff32s_7 ; error !
  2396                                  
  2397 000013F0 BF[00300000]            	mov	edi, audio_buffer
  2398                                  	
  2399 000013F5 D1E8                    	shr	eax, 1
  2400 000013F7 7505                    	jnz	short lff32s_8
  2401 000013F9 E990F7FFFF              	jmp	lff32_eof
  2402                                  
  2403                                  lff32s_8:
  2404 000013FE 89C1                    	mov	ecx, eax  ; word count
  2405                                  lff32s_1:
  2406 00001400 AC                      	lodsb
  2407 00001401 A2[05210000]            	mov	[previous_val_l], al
  2408 00001406 2C80                    	sub	al, 80h
  2409 00001408 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2410 0000140C 66AB                    	stosw		; original sample (L)
  2411 0000140E AC                      	lodsb
  2412 0000140F A2[07210000]            	mov	[previous_val_r], al
  2413 00001414 2C80                    	sub	al, 80h
  2414 00001416 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2415 0000141A 66AB                    	stosw		; original sample (R)
  2416                                  
  2417                                  	;xor	eax, eax
  2418 0000141C 66B88080                	mov	ax, 8080h
  2419 00001420 49                      	dec	ecx
  2420 00001421 7403                    	jz	short lff32s_2
  2421                                  		; convert 8 bit sample to 16 bit sample
  2422 00001423 668B06                  	mov	ax, [esi]
  2423                                  lff32s_2:
  2424                                  	;;mov	[next_val_l], al
  2425                                  	;;mov	[next_val_r], ah
  2426                                  	;mov	bx, ax
  2427 00001426 88E7                    	mov	bh, ah
  2428 00001428 0205[05210000]          	add	al, [previous_val_l]
  2429 0000142E D0D8                    	rcr	al, 1
  2430                                  	;mov	dl, al
  2431 00001430 2C80                    	sub	al, 80h
  2432 00001432 66C1E008                	shl	ax, 8
  2433 00001436 66AB                    	stosw		; this is interpolated sample (L)
  2434 00001438 88F8                    	mov	al, bh	; [next_val_r]
  2435 0000143A 0205[07210000]          	add	al, [previous_val_r]
  2436 00001440 D0D8                    	rcr	al, 1
  2437                                  	;mov	dh, al
  2438 00001442 2C80                    	sub	al, 80h
  2439 00001444 66C1E008                	shl	ax, 8
  2440 00001448 66AB                    	stosw		; this is interpolated sample (R)
  2441                                  
  2442                                  	; different than 8-16-24 kHZ !
  2443                                  	; 'original-interpolated-original' trio samples 
  2444 0000144A E315                    	jecxz	lff32s_3
  2445                                  
  2446 0000144C AC                      	lodsb
  2447 0000144D 2C80                    	sub	al, 80h
  2448 0000144F 66C1E008                	shl	ax, 8
  2449 00001453 66AB                    	stosw		; original sample (left channel)
  2450                                  
  2451 00001455 AC                      	lodsb
  2452 00001456 2C80                    	sub	al, 80h
  2453 00001458 66C1E008                	shl	ax, 8
  2454 0000145C 66AB                    	stosw		; original sample (right channel)
  2455                                  		
  2456                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2457 0000145E 49                      	dec	ecx
  2458 0000145F 759F                    	jnz	short lff32s_1
  2459                                  lff32s_3:
  2460 00001461 E910F7FFFF              	jmp	lff32_3
  2461                                  
  2462                                  load_32khz_mono_16_bit:
  2463                                  	; 15/11/2023
  2464 00001466 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2465                                  					; last of the file?
  2466 0000146D 7402                    	jz	short lff32m2_0		; no
  2467 0000146F F9                      	stc
  2468 00001470 C3                      	retn
  2469                                  
  2470                                  lff32m2_0:
  2471 00001471 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2472                                          ;mov	edx, [loadsize]
  2473                                  
  2474                                  	; esi = buffer address
  2475                                  	;; edx = buffer size
  2476                                  
  2477                                  	; load file into memory
  2478                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001476 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000147C 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000147E 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001484 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001489 CD40                <1>  int 40h
  2479 0000148B 723E                    	jc	short lff32m2_7 ; error !
  2480                                  
  2481 0000148D BF[00300000]            	mov	edi, audio_buffer
  2482                                  	
  2483 00001492 D1E8                    	shr	eax, 1
  2484 00001494 7505                    	jnz	short lff32m2_8
  2485 00001496 E9F3F6FFFF              	jmp	lff32_eof
  2486                                  
  2487                                  lff32m2_8:
  2488 0000149B 89C1                    	mov	ecx, eax  ; word count
  2489                                  lff32m2_1:
  2490 0000149D 66AD                    	lodsw
  2491 0000149F 66AB                    	stosw		; original sample (left channel)
  2492 000014A1 66AB                    	stosw		; original sample (right channel)
  2493 000014A3 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2494                                  	;mov	[previous_val], ax
  2495                                  	;mov	ebx, eax	
  2496                                  	;xor	eax, eax
  2497 000014A6 31DB                    	xor	ebx, ebx
  2498 000014A8 49                      	dec	ecx
  2499 000014A9 7403                    	jz	short lff32m2_2
  2500                                  	;mov	ax, [esi]
  2501 000014AB 668B1E                  	mov	bx, [esi]
  2502                                  lff32m2_2:
  2503                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2504                                  	;mov	ebp, eax	; [next_val]
  2505                                  	;add	ax, [previous_val]
  2506                                  	; ax = [previous_val]
  2507                                  	; bx = [next_val]
  2508 000014AE 6601D8                  	add	ax, bx
  2509 000014B1 66D1D8                  	rcr	ax, 1
  2510 000014B4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2511 000014B7 66AB                    	stosw		; this is interpolated sample (L)
  2512 000014B9 66AB                    	stosw		; this is interpolated sample (R)
  2513                                  
  2514                                  	; different than 8-16-24 kHZ !
  2515                                  	; 'original-interpolated-original' trio samples 
  2516 000014BB E309                    	jecxz	lff32m2_3
  2517                                  
  2518 000014BD 66AD                    	lodsw
  2519 000014BF 66AB                    	stosw		; original sample (left channel)
  2520 000014C1 66AB                    	stosw		; original sample (right channel)
  2521                                  
  2522                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2523 000014C3 49                      	dec	ecx
  2524 000014C4 75D7                    	jnz	short lff32m2_1
  2525                                  lff32m2_3:
  2526 000014C6 E9ABF6FFFF              	jmp	lff32_3
  2527                                  
  2528                                  lff32m2_7:
  2529                                  lff32s2_7:
  2530 000014CB E9C7F6FFFF              	jmp	lff32_5  ; error
  2531                                  
  2532                                  load_32khz_stereo_16_bit:
  2533                                  	; 16/11/2023
  2534                                  	; 15/11/2023
  2535 000014D0 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2536                                  					; last of the file?
  2537 000014D7 7402                    	jz	short lff32s2_0		; no
  2538 000014D9 F9                      	stc
  2539 000014DA C3                      	retn
  2540                                  
  2541                                  lff32s2_0:
  2542 000014DB BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2543                                          ;mov	edx, [loadsize]
  2544                                  
  2545                                  	; esi = buffer address
  2546                                  	;; edx = buffer size
  2547                                  
  2548                                  	; load file into memory
  2549                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000014E0 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000014E6 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000014E8 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000014EE B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000014F3 CD40                <1>  int 40h
  2550 000014F5 72D4                    	jc	short lff32s2_7 ; error !
  2551                                  
  2552 000014F7 BF[00300000]            	mov	edi, audio_buffer
  2553                                  	
  2554 000014FC C1E802                  	shr	eax, 2
  2555 000014FF 7505                    	jnz	short lff32s2_8
  2556 00001501 E988F6FFFF              	jmp	lff32_eof
  2557                                  
  2558                                  lff32s2_8:
  2559 00001506 89C1                    	mov	ecx, eax ; dword count
  2560                                  lff32s2_1:
  2561 00001508 66AD                    	lodsw
  2562 0000150A 66AB                    	stosw		; original sample (L)
  2563 0000150C 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2564 0000150F 66A3[05210000]          	mov	[previous_val_l], ax
  2565 00001515 66AD                    	lodsw
  2566 00001517 66AB                    	stosw		; original sample (R)
  2567 00001519 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2568                                  	;mov	[previous_val_r], ax
  2569 0000151C 89C3                    	mov	ebx, eax
  2570 0000151E 31D2                    	xor	edx, edx
  2571 00001520 31C0                    	xor	eax, eax
  2572                                  	; 16/11/2023
  2573 00001522 49                      	dec	ecx
  2574 00001523 7407                    	jz	short lff32s2_2
  2575 00001525 668B06                  	mov	ax, [esi]
  2576 00001528 668B5602                	mov	dx, [esi+2]
  2577                                  lff32s2_2:
  2578 0000152C 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2579                                  	;;mov	[next_val_l], ax
  2580                                  	;mov	ebp, eax
  2581 0000152F 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2582                                  	;mov	[next_val_r], dx
  2583 00001532 660305[05210000]        	add	ax, [previous_val_l]
  2584 00001539 66D1D8                  	rcr	ax, 1
  2585 0000153C 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2586 0000153F 66AB                    	stosw		; this is interpolated sample (L)
  2587                                  	;mov	ax, [next_val_r]
  2588 00001541 89D0                    	mov	eax, edx
  2589                                  	;add	ax, [previous_val_r]
  2590 00001543 6601D8                  	add	ax, bx
  2591 00001546 66D1D8                  	rcr	ax, 1
  2592 00001549 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2593 0000154C 66AB                    	stosw		; this is interpolated sample (R)
  2594                                  
  2595                                  	; different than 8-16-24 kHZ !
  2596                                  	; 'original-interpolated-original' trio samples 
  2597 0000154E E30B                    	jecxz	lff32s2_3
  2598                                  
  2599 00001550 66AD                    	lodsw
  2600 00001552 66AB                    	stosw	; original sample (L)
  2601 00001554 66AD                    	lodsw
  2602 00001556 66AB                    	stosw	; original sample (R)
  2603                                  	
  2604                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2605 00001558 49                      	dec	ecx
  2606 00001559 75AD                    	jnz	short lff32s2_1
  2607                                  lff32s2_3:
  2608 0000155B E916F6FFFF              	jmp	lff32_3
  2609                                  
  2610                                  ; .....................
  2611                                  
  2612                                  load_22khz_mono_8_bit:
  2613                                  	; 16/11/2023
  2614 00001560 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2615                                  					; last of the file?
  2616 00001567 7402                    	jz	short lff22m_0		; no
  2617 00001569 F9                      	stc
  2618 0000156A C3                      	retn
  2619                                  
  2620                                  lff22m_0:
  2621 0000156B BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2622                                          ;mov	edx, [loadsize]
  2623                                  
  2624                                  	; esi = buffer address
  2625                                  	;; edx = buffer size
  2626                                  
  2627                                  	; load file into memory
  2628                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001570 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001576 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001578 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000157E B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001583 CD40                <1>  int 40h
  2629 00001585 725D                    	jc	short lff22m_7 ; error !
  2630                                  
  2631 00001587 BF[00300000]            	mov	edi, audio_buffer
  2632                                  	
  2633 0000158C 21C0                    	and	eax, eax
  2634 0000158E 7505                    	jnz	short lff22m_8
  2635 00001590 E9F9F5FFFF              	jmp	lff22_eof
  2636                                  
  2637                                  lff22m_8:
  2638 00001595 89C1                    	mov	ecx, eax	; byte count
  2639                                  lff22m_9:
  2640 00001597 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2641 0000159C C605[0D210000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2642                                  lff22m_1:
  2643                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2644 000015A3 AC                      	lodsb
  2645 000015A4 B280                    	mov	dl, 80h
  2646 000015A6 49                      	dec	ecx
  2647 000015A7 7402                    	jz	short lff22m_2_1
  2648 000015A9 8A16                    	mov	dl, [esi]
  2649                                  lff22m_2_1:	
  2650                                  	; al = [previous_val]
  2651                                  	; dl = [next_val]
  2652 000015AB E80F060000              	call	interpolating_3_8bit_mono ; 1 of 17
  2653 000015B0 E32D                    	jecxz	lff22m_3
  2654                                  lff22m_2_2:
  2655 000015B2 AC                      	lodsb
  2656 000015B3 B280                    	mov	dl, 80h
  2657 000015B5 49                      	dec	ecx
  2658 000015B6 7402                    	jz	short lff22m_2_3
  2659 000015B8 8A16                    	mov	dl, [esi]
  2660                                  lff22m_2_3:
  2661 000015BA E884060000               	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2662 000015BF E31E                    	jecxz	lff22m_3
  2663 000015C1 4D                      	dec	ebp
  2664 000015C2 75EE                    	jnz	short lff22m_2_2
  2665                                  
  2666 000015C4 A0[0D210000]            	mov	al, [faz]
  2667 000015C9 FEC8                    	dec	al
  2668 000015CB 74CA                    	jz	short lff22m_9
  2669 000015CD FE0D[0D210000]          	dec	byte [faz]
  2670 000015D3 BD04000000              	mov	ebp, 4
  2671 000015D8 FEC8                    	dec	al
  2672 000015DA 75C7                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2673 000015DC 45                      	inc	ebp ; 5
  2674 000015DD EBC4                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2675                                  
  2676                                  lff22m_3:
  2677                                  lff22s_3:
  2678 000015DF E992F5FFFF              	jmp	lff22_3	; padfill
  2679                                  		; (put zeros in the remain words of the buffer)
  2680                                  lff22m_7:
  2681                                  lff22s_7:
  2682 000015E4 E9AEF5FFFF              	jmp	lff22_5  ; error
  2683                                  
  2684                                  load_22khz_stereo_8_bit:
  2685                                  	; 16/11/2023
  2686 000015E9 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2687                                  					; last of the file?
  2688 000015F0 7402                    	jz	short lff22s_0		; no
  2689 000015F2 F9                      	stc
  2690 000015F3 C3                      	retn
  2691                                  
  2692                                  lff22s_0:
  2693 000015F4 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2694                                          ;mov	edx, [loadsize]
  2695                                  
  2696                                  	; esi = buffer address
  2697                                  	;; edx = buffer size
  2698                                  
  2699                                  	; load file into memory
  2700                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000015F9 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000015FF 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001601 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001607 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000160C CD40                <1>  int 40h
  2701 0000160E 72D4                    	jc	short lff22s_7 ; error !
  2702                                  
  2703 00001610 BF[00300000]            	mov	edi, audio_buffer
  2704                                  	
  2705 00001615 D1E8                    	shr	eax, 1
  2706 00001617 7505                    	jnz	short lff22s_8
  2707 00001619 E970F5FFFF              	jmp	lff22_eof
  2708                                  
  2709                                  lff22s_8:
  2710 0000161E 89C1                    	mov	ecx, eax	; word count
  2711                                  lff22s_9:
  2712 00001620 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2713 00001625 C605[0D210000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2714                                  lff22s_1:
  2715                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2716 0000162C 66AD                    	lodsw
  2717 0000162E 66BA8080                	mov	dx, 8080h
  2718 00001632 49                      	dec	ecx
  2719 00001633 7403                    	jz	short lff22s_2_1 
  2720 00001635 668B16                  	mov	dx, [esi]
  2721                                  lff22s_2_1:	
  2722                                  	; al = [previous_val_l]
  2723                                  	; ah = [previous_val_r]
  2724                                  	; dl = [next_val_l]
  2725                                  	; dh = [next_val_r]	
  2726 00001638 E8B3050000              	call	interpolating_3_8bit_stereo ; 1 of 17 
  2727 0000163D E3A0                    	jecxz	lff22s_3
  2728                                  lff22s_2_2:
  2729 0000163F 66AD                    	lodsw
  2730 00001641 66BA8080                	mov	dx, 8080h
  2731 00001645 49                      	dec	ecx
  2732 00001646 7403                    	jz	short lff22s_2_3
  2733 00001648 668B16                  	mov	dx, [esi]
  2734                                  lff22s_2_3:
  2735 0000164B E810060000               	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2736 00001650 E38D                    	jecxz	lff22s_3
  2737 00001652 4D                      	dec	ebp
  2738 00001653 75EA                    	jnz	short lff22s_2_2
  2739                                  
  2740 00001655 A0[0D210000]            	mov	al, [faz]
  2741 0000165A FEC8                    	dec	al
  2742 0000165C 74C2                    	jz	short lff22s_9
  2743 0000165E FE0D[0D210000]          	dec	byte [faz]
  2744 00001664 BD04000000              	mov	ebp, 4
  2745 00001669 FEC8                    	dec	al
  2746 0000166B 75BF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2747 0000166D 45                      	inc	ebp ; 5
  2748 0000166E EBBC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2749                                  
  2750                                  load_22khz_mono_16_bit:
  2751                                  	; 16/11/2023
  2752 00001670 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2753                                  					; last of the file?
  2754 00001677 7402                    	jz	short lff22m2_0		; no
  2755 00001679 F9                      	stc
  2756 0000167A C3                      	retn
  2757                                  
  2758                                  lff22m2_0:
  2759 0000167B BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2760                                          ;mov	edx, [loadsize]
  2761                                  
  2762                                  	; esi = buffer address
  2763                                  	;; edx = buffer size
  2764                                  
  2765                                  	; load file into memory
  2766                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001680 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001686 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001688 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000168E B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001693 CD40                <1>  int 40h
  2767 00001695 7261                    	jc	short lff22m2_7 ; error !
  2768                                  
  2769 00001697 BF[00300000]            	mov	edi, audio_buffer
  2770                                  	
  2771 0000169C D1E8                    	shr	eax, 1
  2772 0000169E 7505                    	jnz	short lff22m2_8
  2773 000016A0 E9E9F4FFFF              	jmp	lff22_eof
  2774                                  
  2775                                  lff22m2_8:
  2776 000016A5 89C1                    	mov	ecx, eax	; word count
  2777                                  lff22m2_9:
  2778 000016A7 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2779 000016AC C605[0D210000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2780                                  lff22m2_1:
  2781                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2782 000016B3 66AD                    	lodsw
  2783 000016B5 31D2                    	xor	edx, edx
  2784 000016B7 49                      	dec	ecx
  2785 000016B8 7403                    	jz	short lff22m2_2_1
  2786 000016BA 668B16                  	mov	dx, [esi]
  2787                                  lff22m2_2_1:	
  2788                                  	; ax = [previous_val]
  2789                                  	; dx = [next_val]
  2790 000016BD E8CF050000              	call	interpolating_3_16bit_mono ; 1 of 17
  2791 000016C2 E32F                    	jecxz	lff22m2_3
  2792                                  lff22m2_2_2:
  2793 000016C4 66AD                    	lodsw
  2794 000016C6 31D2                    	xor	edx, edx
  2795 000016C8 49                      	dec	ecx
  2796 000016C9 7403                    	jz	short lff22m2_2_3
  2797 000016CB 668B16                  	mov	dx, [esi]
  2798                                  lff22m2_2_3:
  2799 000016CE E851060000               	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2800 000016D3 E31E                    	jecxz	lff22m2_3
  2801 000016D5 4D                      	dec	ebp
  2802 000016D6 75EC                    	jnz	short lff22m2_2_2
  2803                                  
  2804 000016D8 A0[0D210000]            	mov	al, [faz]
  2805 000016DD FEC8                    	dec	al
  2806 000016DF 74C6                    	jz	short lff22m2_9
  2807 000016E1 FE0D[0D210000]          	dec	byte [faz]
  2808 000016E7 BD04000000              	mov	ebp, 4
  2809 000016EC FEC8                    	dec	al
  2810 000016EE 75C3                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2811 000016F0 45                      	inc	ebp ; 5
  2812 000016F1 EBC0                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2813                                  
  2814                                  lff22m2_3:
  2815                                  lff22s2_3:
  2816 000016F3 E97EF4FFFF              	jmp	lff22_3	; padfill
  2817                                  		; (put zeros in the remain words of the buffer)
  2818                                  lff22m2_7:
  2819                                  lff22s2_7:
  2820 000016F8 E99AF4FFFF              	jmp	lff22_5  ; error
  2821                                  
  2822                                  load_22khz_stereo_16_bit:
  2823                                  	; 16/11/2023
  2824 000016FD F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2825                                  					; last of the file?
  2826 00001704 7402                    	jz	short lff22s2_0		; no
  2827 00001706 F9                      	stc
  2828 00001707 C3                      	retn
  2829                                  
  2830                                  lff22s2_0:
  2831 00001708 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2832                                          ;mov	edx, [loadsize]
  2833                                  
  2834                                  	; esi = buffer address
  2835                                  	;; edx = buffer size
  2836                                  
  2837                                  	; load file into memory
  2838                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000170D 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001713 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001715 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000171B B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001720 CD40                <1>  int 40h
  2839 00001722 72D4                    	jc	short lff22s2_7 ; error !
  2840                                  
  2841 00001724 BF[00300000]            	mov	edi, audio_buffer
  2842                                  	
  2843 00001729 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  2844 0000172C 7505                    	jnz	short lff22s2_8
  2845 0000172E E95BF4FFFF              	jmp	lff22_eof
  2846                                  
  2847                                  lff22s2_8:
  2848 00001733 89C1                    	mov	ecx, eax	; dword count
  2849                                  lff22s2_9:
  2850 00001735 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2851 0000173A C605[0D210000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2852                                  lff22s2_1:
  2853                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2854 00001741 66AD                    	lodsw
  2855 00001743 89C3                    	mov	ebx, eax
  2856 00001745 66AD                    	lodsw
  2857 00001747 8B16                    	mov	edx, [esi]
  2858 00001749 668915[09210000]        	mov	[next_val_l], dx
  2859                                  	; 26/11/2023
  2860 00001750 C1EA10                  	shr	edx, 16
  2861 00001753 49                      	dec	ecx
  2862 00001754 7509                    	jnz	short lff22s2_2_1
  2863 00001756 31D2                    	xor	edx, edx ; 0
  2864 00001758 668915[09210000]        	mov	[next_val_l], dx
  2865                                  lff22s2_2_1:
  2866                                  	; bx = [previous_val_l]
  2867                                  	; ax = [previous_val_r]
  2868                                  	; [next_val_l]
  2869                                  	; dx = [next_val_r]
  2870 0000175F E85D050000              	call	interpolating_3_16bit_stereo ; 1 of 17 
  2871 00001764 E38D                    	jecxz	lff22s2_3
  2872                                  lff22s2_2_2:
  2873 00001766 66AD                    	lodsw
  2874 00001768 89C3                    	mov	ebx, eax
  2875 0000176A 66AD                    	lodsw
  2876 0000176C 8B16                    	mov	edx, [esi]
  2877 0000176E 668915[09210000]        	mov	[next_val_l], dx
  2878                                  	; 26/11/2023
  2879 00001775 C1EA10                  	shr	edx, 16
  2880 00001778 49                      	dec	ecx
  2881 00001779 7509                    	jnz	short lff22s2_2_3
  2882 0000177B 31D2                    	xor	edx, edx ; 0
  2883 0000177D 668915[09210000]        	mov	[next_val_l], dx
  2884                                  lff22s2_2_3:
  2885 00001784 E8B3050000               	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  2886 00001789 E31E                    	jecxz	lff22s2_2_4
  2887                                  
  2888 0000178B 4D                      	dec	ebp
  2889 0000178C 75D8                    	jnz	short lff22s2_2_2
  2890                                  
  2891 0000178E A0[0D210000]            	mov	al, [faz]
  2892 00001793 FEC8                    	dec	al
  2893 00001795 749E                    	jz	short lff22s2_9
  2894 00001797 FE0D[0D210000]          	dec	byte [faz]
  2895 0000179D BD04000000              	mov	ebp, 4
  2896 000017A2 FEC8                    	dec	al
  2897 000017A4 759B                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2898 000017A6 45                      	inc	ebp ; 5
  2899 000017A7 EB98                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2900                                  
  2901                                  lff22s2_2_4:
  2902                                  	; 26/11/2023
  2903 000017A9 E9C8F3FFFF              	jmp	lff22_3	; padfill
  2904                                  
  2905                                  ; .....................
  2906                                  
  2907                                  load_11khz_mono_8_bit:
  2908                                  	; 18/11/2023
  2909 000017AE F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2910                                  					; last of the file?
  2911 000017B5 7402                    	jz	short lff11m_0		; no
  2912 000017B7 F9                      	stc
  2913 000017B8 C3                      	retn
  2914                                  
  2915                                  lff11m_0:
  2916 000017B9 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2917                                          ;mov	edx, [loadsize]
  2918                                  
  2919                                  	; esi = buffer address
  2920                                  	;; edx = buffer size
  2921                                  
  2922                                  	; load file into memory
  2923                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000017BE 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000017C4 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000017C6 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000017CC B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000017D1 CD40                <1>  int 40h
  2924 000017D3 7247                    	jc	short lff11m_7 ; error !
  2925                                  
  2926 000017D5 BF[00300000]            	mov	edi, audio_buffer
  2927                                  	
  2928 000017DA 21C0                    	and	eax, eax
  2929 000017DC 7505                    	jnz	short lff11m_8
  2930 000017DE E9ABF3FFFF              	jmp	lff11_eof
  2931                                  
  2932                                  lff11m_8:
  2933 000017E3 89C1                    	mov	ecx, eax		; byte count
  2934                                  lff11m_9:
  2935 000017E5 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  2936                                  lff11m_1:
  2937                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2938 000017EA AC                      	lodsb
  2939 000017EB B280                    	mov	dl, 80h
  2940 000017ED 49                      	dec	ecx
  2941 000017EE 7402                    	jz	short lff11m_2_1
  2942 000017F0 8A16                    	mov	dl, [esi]
  2943                                  lff11m_2_1:	
  2944                                  	; al = [previous_val]
  2945                                  	; dl = [next_val]
  2946 000017F2 E876050000              	call	interpolating_5_8bit_mono
  2947 000017F7 E328                    	jecxz	lff11m_3
  2948                                  lff11m_2_2:
  2949 000017F9 AC                      	lodsb
  2950 000017FA B280                    	mov	dl, 80h
  2951 000017FC 49                      	dec	ecx
  2952 000017FD 7402                    	jz	short lff11m_2_3
  2953 000017FF 8A16                    	mov	dl, [esi]
  2954                                  lff11m_2_3:
  2955 00001801 E873060000               	call	interpolating_4_8bit_mono
  2956 00001806 E319                    	jecxz	lff11m_3
  2957                                  
  2958 00001808 4D                      	dec	ebp
  2959 00001809 74DA                    	jz	short lff11m_9
  2960                                  
  2961 0000180B AC                      	lodsb
  2962 0000180C B280                    	mov	dl, 80h
  2963 0000180E 49                      	dec	ecx
  2964 0000180F 7402                    	jz	short lff11m_2_4
  2965 00001811 8A16                    	mov	dl, [esi]
  2966                                  lff11m_2_4:
  2967 00001813 E861060000              	call	interpolating_4_8bit_mono
  2968 00001818 E307                    	jecxz	lff11m_3
  2969 0000181A EBCE                    	jmp	short lff11m_1
  2970                                  
  2971                                  lff11m_7:
  2972                                  lff11s_7:
  2973 0000181C E976F3FFFF              	jmp	lff11_5  ; error
  2974                                  
  2975                                  lff11m_3:
  2976                                  lff11s_3:
  2977 00001821 E950F3FFFF              	jmp	lff11_3	; padfill
  2978                                  		; (put zeros in the remain words of the buffer)
  2979                                  
  2980                                  load_11khz_stereo_8_bit:
  2981                                  	; 18/11/2023
  2982 00001826 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2983                                  					; last of the file?
  2984 0000182D 7402                    	jz	short lff11s_0		; no
  2985 0000182F F9                      	stc
  2986 00001830 C3                      	retn
  2987                                  
  2988                                  lff11s_0:
  2989 00001831 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2990                                          ;mov	edx, [loadsize]
  2991                                  
  2992                                  	; esi = buffer address
  2993                                  	;; edx = buffer size
  2994                                  
  2995                                  	; load file into memory
  2996                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001836 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000183C 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000183E 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001844 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001849 CD40                <1>  int 40h
  2997 0000184B 72CF                    	jc	short lff11s_7 ; error !
  2998                                  
  2999 0000184D BF[00300000]            	mov	edi, audio_buffer
  3000                                  	
  3001 00001852 D1E8                    	shr	eax, 1
  3002 00001854 7505                    	jnz	short lff11s_8
  3003 00001856 E933F3FFFF              	jmp	lff11_eof
  3004                                  
  3005                                  lff11s_8:
  3006 0000185B 89C1                    	mov	ecx, eax	; word count
  3007                                  lff11s_9:
  3008 0000185D BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3009                                  lff11s_1:
  3010                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3011 00001862 66AD                    	lodsw
  3012 00001864 66BA8080                	mov	dx, 8080h
  3013 00001868 49                      	dec	ecx
  3014 00001869 7403                    	jz	short lff11s_2_1 
  3015 0000186B 668B16                  	mov	dx, [esi]
  3016                                  lff11s_2_1:	
  3017                                  	; al = [previous_val_l]
  3018                                  	; ah = [previous_val_r]
  3019                                  	; dl = [next_val_l]
  3020                                  	; dh = [next_val_r]	
  3021 0000186E E859050000              	call	interpolating_5_8bit_stereo
  3022 00001873 E3AC                    	jecxz	lff11s_3
  3023                                  lff11s_2_2:
  3024 00001875 66AD                    	lodsw
  3025 00001877 66BA8080                	mov	dx, 8080h
  3026 0000187B 49                      	dec	ecx
  3027 0000187C 7403                    	jz	short lff11s_2_3
  3028 0000187E 668B16                  	mov	dx, [esi]
  3029                                  lff11s_2_3:
  3030 00001881 E832060000               	call	interpolating_4_8bit_stereo
  3031 00001886 E399                    	jecxz	lff11s_3
  3032                                  	
  3033 00001888 4D                      	dec	ebp
  3034 00001889 74D2                    	jz	short lff11s_9
  3035                                  
  3036 0000188B 66AD                    	lodsw
  3037 0000188D 66BA8080                	mov	dx, 8080h
  3038 00001891 49                      	dec	ecx
  3039 00001892 7403                    	jz	short lff11s_2_4
  3040 00001894 668B16                  	mov	dx, [esi]
  3041                                  lff11s_2_4:
  3042 00001897 E81C060000              	call	interpolating_4_8bit_stereo
  3043 0000189C E383                    	jecxz	lff11s_3
  3044 0000189E EBC2                    	jmp	short lff11s_1
  3045                                  
  3046                                  load_11khz_mono_16_bit:
  3047                                  	; 18/11/2023
  3048 000018A0 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3049                                  					; last of the file?
  3050 000018A7 7402                    	jz	short lff11m2_0		; no
  3051 000018A9 F9                      	stc
  3052 000018AA C3                      	retn
  3053                                  
  3054                                  lff11m2_0:
  3055 000018AB BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3056                                          ;mov	edx, [loadsize]
  3057                                  
  3058                                  	; esi = buffer address
  3059                                  	;; edx = buffer size
  3060                                  
  3061                                  	; load file into memory
  3062                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000018B0 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000018B6 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000018B8 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000018BE B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000018C3 CD40                <1>  int 40h
  3063 000018C5 724D                    	jc	short lff11m2_7 ; error !
  3064                                  
  3065 000018C7 BF[00300000]            	mov	edi, audio_buffer
  3066                                  	
  3067 000018CC D1E8                    	shr	eax, 1
  3068 000018CE 7505                    	jnz	short lff11m2_8
  3069 000018D0 E9B9F2FFFF              	jmp	lff11_eof
  3070                                  
  3071                                  lff11m2_8:
  3072 000018D5 89C1                    	mov	ecx, eax	; word count
  3073                                  lff11m2_9:
  3074 000018D7 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3075                                  lff11m2_1:
  3076                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3077 000018DC 66AD                    	lodsw
  3078 000018DE 31D2                    	xor	edx, edx
  3079 000018E0 49                      	dec	ecx
  3080 000018E1 7403                    	jz	short lff11m2_2_1
  3081 000018E3 668B16                  	mov	dx, [esi]
  3082                                  lff11m2_2_1:	
  3083                                  	; ax = [previous_val]
  3084                                  	; dx = [next_val]
  3085 000018E6 E83A060000              	call	interpolating_5_16bit_mono
  3086 000018EB E362                    	jecxz	lff11m2_3
  3087                                  lff11m2_2_2:
  3088 000018ED 66AD                    	lodsw
  3089 000018EF 31D2                    	xor	edx, edx
  3090 000018F1 49                      	dec	ecx
  3091 000018F2 7403                    	jz	short lff11m2_2_3
  3092 000018F4 668B16                  	mov	dx, [esi]
  3093                                  lff11m2_2_3:
  3094 000018F7 E853070000               	call	interpolating_4_16bit_mono
  3095 000018FC E351                    	jecxz	lff11m2_3
  3096                                  
  3097 000018FE 4D                      	dec	ebp
  3098 000018FF 74D6                    	jz	short lff11m2_9
  3099                                  
  3100 00001901 66AD                    	lodsw
  3101 00001903 31D2                    	xor	edx, edx
  3102 00001905 49                      	dec	ecx
  3103 00001906 7403                    	jz	short lff11m2_2_4
  3104 00001908 668B16                  	mov	dx, [esi]
  3105                                  lff11m2_2_4:
  3106 0000190B E83F070000               	call	interpolating_4_16bit_mono
  3107 00001910 E33D                    	jecxz	lff11m2_3
  3108 00001912 EBC8                    	jmp	short lff11m2_1
  3109                                  
  3110                                  lff11m2_7:
  3111                                  lff11s2_7:
  3112 00001914 E97EF2FFFF              	jmp	lff11_5  ; error
  3113                                  
  3114                                  load_11khz_stereo_16_bit:
  3115                                  	; 18/11/2023
  3116 00001919 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3117                                  					; last of the file?
  3118 00001920 7402                    	jz	short lff11s2_0		; no
  3119 00001922 F9                      	stc
  3120 00001923 C3                      	retn
  3121                                  
  3122                                  lff11s2_0:
  3123 00001924 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3124                                          ;mov	edx, [loadsize]
  3125                                  
  3126                                  	; esi = buffer address
  3127                                  	;; edx = buffer size
  3128                                  
  3129                                  	; load file into memory
  3130                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001929 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000192F 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001931 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001937 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000193C CD40                <1>  int 40h
  3131 0000193E 72D4                    	jc	short lff11s2_7 ; error !
  3132                                  
  3133 00001940 BF[00300000]            	mov	edi, audio_buffer
  3134                                  	
  3135 00001945 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3136 00001948 750A                    	jnz	short lff11s2_8
  3137 0000194A E93FF2FFFF              	jmp	lff11_eof
  3138                                  
  3139                                  lff11m2_3:
  3140                                  lff11s2_3:
  3141 0000194F E922F2FFFF              	jmp	lff11_3	; padfill
  3142                                  		; (put zeros in the remain words of the buffer)
  3143                                  
  3144                                  lff11s2_8:
  3145 00001954 89C1                    	mov	ecx, eax	; dword count
  3146                                  lff11s2_9:
  3147 00001956 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3148                                  lff11s2_1:
  3149                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3150 0000195B 66AD                    	lodsw
  3151 0000195D 89C3                    	mov	ebx, eax
  3152 0000195F 66AD                    	lodsw
  3153 00001961 8B16                    	mov	edx, [esi]
  3154 00001963 8915[09210000]          	mov	[next_val_l], edx
  3155                                  	; 26/11/2023
  3156 00001969 C1EA10                  	shr	edx, 16
  3157                                  	;mov	[next_val_r], dx
  3158 0000196C 49                      	dec	ecx
  3159 0000196D 7509                    	jnz	short lff11s2_2_1
  3160 0000196F 31D2                    	xor	edx, edx ; 0
  3161 00001971 668915[09210000]        	mov	[next_val_l], dx
  3162                                  	;mov	[next_val_r], dx
  3163                                  lff11s2_2_1:
  3164                                  	; bx = [previous_val_l]
  3165                                  	; ax = [previous_val_r]
  3166                                  	; [next_val_l]
  3167                                  	; dx = [next_val_r]
  3168 00001978 E803060000              	call	interpolating_5_16bit_stereo
  3169 0000197D E3D0                    	jecxz	lff11s2_3
  3170                                  lff11s2_2_2:
  3171 0000197F 66AD                    	lodsw
  3172 00001981 89C3                    	mov	ebx, eax
  3173 00001983 66AD                    	lodsw
  3174 00001985 8B16                    	mov	edx, [esi]
  3175 00001987 668915[09210000]        	mov	[next_val_l], dx
  3176                                  	; 26/11/2023
  3177 0000198E C1EA10                  	shr	edx, 16
  3178                                  	;mov	[next_val_r], dx
  3179 00001991 49                      	dec	ecx
  3180 00001992 7509                    	jnz	short lff11s2_2_3
  3181 00001994 31D2                    	xor	edx, edx ; 0
  3182 00001996 668915[09210000]        	mov	[next_val_l], dx
  3183                                  	;mov	[next_val_r], dx
  3184                                  lff11s2_2_3:
  3185 0000199D E8E6060000               	call	interpolating_4_16bit_stereo
  3186 000019A2 E3AB                    	jecxz	lff11s2_3
  3187                                  	
  3188 000019A4 4D                      	dec	ebp
  3189 000019A5 74AF                    	jz	short lff11s2_9
  3190                                  
  3191 000019A7 66AD                    	lodsw
  3192 000019A9 89C3                    	mov	ebx, eax
  3193 000019AB 66AD                    	lodsw
  3194 000019AD 8B16                    	mov	edx, [esi]
  3195 000019AF 668915[09210000]        	mov	[next_val_l], dx
  3196                                  	; 26/11/2023
  3197 000019B6 C1EA10                  	shr	edx, 16
  3198                                  	;mov	[next_val_r], dx
  3199 000019B9 49                      	dec	ecx
  3200 000019BA 7509                    	jnz	short lff11s2_2_4
  3201 000019BC 31D2                    	xor	edx, edx ; 0
  3202 000019BE 668915[09210000]        	mov	[next_val_l], dx
  3203                                  	;mov	[next_val_r], dx
  3204                                  lff11s2_2_4:
  3205 000019C5 E8BE060000               	call	interpolating_4_16bit_stereo
  3206 000019CA E383                    	jecxz	lff11s2_3
  3207 000019CC EB8D                    	jmp	short lff11s2_1
  3208                                  
  3209                                  ; .....................
  3210                                  
  3211                                  load_44khz_mono_8_bit:
  3212                                  	; 18/11/2023
  3213 000019CE F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3214                                  					; last of the file?
  3215 000019D5 7402                    	jz	short lff44m_0		; no
  3216 000019D7 F9                      	stc
  3217 000019D8 C3                      	retn
  3218                                  
  3219                                  lff44m_0:
  3220 000019D9 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3221                                          ;mov	edx, [loadsize]
  3222                                  
  3223                                  	; esi = buffer address
  3224                                  	;; edx = buffer size
  3225                                  
  3226                                  	; load file into memory
  3227                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000019DE 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000019E4 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000019E6 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000019EC B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000019F1 CD40                <1>  int 40h
  3228 000019F3 7250                    	jc	short lff44m_7 ; error !
  3229                                  
  3230 000019F5 BF[00300000]            	mov	edi, audio_buffer
  3231                                  	
  3232 000019FA 21C0                    	and	eax, eax
  3233 000019FC 7505                    	jnz	short lff44m_8
  3234 000019FE E98BF1FFFF              	jmp	lff44_eof
  3235                                  
  3236                                  lff44m_8:
  3237 00001A03 89C1                    	mov	ecx, eax	; byte count
  3238                                  lff44m_9:
  3239 00001A05 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3240 00001A0A C605[0D210000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3241                                  lff44m_1:
  3242                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3243                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3244 00001A11 AC                      	lodsb
  3245 00001A12 B280                    	mov	dl, 80h
  3246 00001A14 49                      	dec	ecx
  3247 00001A15 7402                    	jz	short lff44m_2_1
  3248 00001A17 8A16                    	mov	dl, [esi]
  3249                                  lff44m_2_1:	
  3250                                  	; al = [previous_val]
  3251                                  	; dl = [next_val]
  3252 00001A19 E825020000              	call	interpolating_2_8bit_mono
  3253 00001A1E E320                    	jecxz	lff44m_3
  3254                                  lff44m_2_2:
  3255 00001A20 AC                      	lodsb
  3256 00001A21 2C80                    	sub	al, 80h
  3257 00001A23 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3258 00001A27 66AB                    	stosw		; (L)
  3259 00001A29 66AB                    	stosw		; (R)	
  3260                                  
  3261 00001A2B 49                      	dec	ecx
  3262 00001A2C 7412                    	jz	short lff44m_3	
  3263 00001A2E 4D                      	dec	ebp
  3264 00001A2F 75EF                    	jnz	short lff44m_2_2
  3265                                  	
  3266 00001A31 FE0D[0D210000]          	dec	byte [faz]
  3267 00001A37 74CC                    	jz	short lff44m_9 
  3268 00001A39 BD0B000000              	mov	ebp, 11
  3269 00001A3E EBD1                    	jmp	short lff44m_1
  3270                                  
  3271                                  lff44m_3:
  3272                                  lff44s_3:
  3273 00001A40 E931F1FFFF              	jmp	lff44_3	; padfill
  3274                                  		; (put zeros in the remain words of the buffer)
  3275                                  lff44m_7:
  3276                                  lff44s_7:
  3277 00001A45 E94DF1FFFF              	jmp	lff44_5  ; error
  3278                                  
  3279                                  load_44khz_stereo_8_bit:
  3280                                  	; 16/11/2023
  3281 00001A4A F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3282                                  					; last of the file?
  3283 00001A51 7402                    	jz	short lff44s_0		; no
  3284 00001A53 F9                      	stc
  3285 00001A54 C3                      	retn
  3286                                  
  3287                                  lff44s_0:
  3288 00001A55 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3289                                          ;mov	edx, [loadsize]
  3290                                  
  3291                                  	; esi = buffer address
  3292                                  	;; edx = buffer size
  3293                                  
  3294                                  	; load file into memory
  3295                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001A5A 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001A60 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001A62 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001A68 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001A6D CD40                <1>  int 40h
  3296 00001A6F 72D4                    	jc	short lff44s_7 ; error !
  3297                                  
  3298 00001A71 BF[00300000]            	mov	edi, audio_buffer
  3299                                  	
  3300 00001A76 D1E8                    	shr	eax, 1
  3301 00001A78 7505                    	jnz	short lff44s_8
  3302 00001A7A E90FF1FFFF              	jmp	lff44_eof
  3303                                  
  3304                                  lff44s_8:
  3305 00001A7F 89C1                    	mov	ecx, eax	; word count
  3306                                  lff44s_9:
  3307 00001A81 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3308 00001A86 C605[0D210000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3309                                  lff44s_1:
  3310                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3311                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3312 00001A8D 66AD                    	lodsw
  3313 00001A8F 66BA8080                	mov	dx, 8080h
  3314 00001A93 49                      	dec	ecx
  3315 00001A94 7403                    	jz	short lff44s_2_1 
  3316 00001A96 668B16                  	mov	dx, [esi]
  3317                                  lff44s_2_1:	
  3318                                  	; al = [previous_val_l]
  3319                                  	; ah = [previous_val_r]
  3320                                  	; dl = [next_val_l]
  3321                                  	; dh = [next_val_r]	
  3322 00001A99 E8C2010000              	call	interpolating_2_8bit_stereo
  3323 00001A9E E3A0                    	jecxz	lff44s_3
  3324                                  lff44s_2_2:
  3325 00001AA0 AC                      	lodsb
  3326 00001AA1 2C80                    	sub	al, 80h
  3327 00001AA3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3328 00001AA7 66AB                    	stosw		; (L)
  3329 00001AA9 AC                      	lodsb
  3330 00001AAA 2C80                    	sub	al, 80h
  3331 00001AAC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3332 00001AB0 66AB                    	stosw		; (R)
  3333                                  
  3334 00001AB2 49                      	dec	ecx
  3335 00001AB3 748B                    	jz	short lff44s_3	
  3336 00001AB5 4D                      	dec	ebp
  3337 00001AB6 75E8                    	jnz	short lff44s_2_2
  3338                                  	
  3339 00001AB8 FE0D[0D210000]          	dec	byte [faz]
  3340 00001ABE 74C1                    	jz	short lff44s_9 
  3341 00001AC0 BD0B000000              	mov	ebp, 11
  3342 00001AC5 EBC6                    	jmp	short lff44s_1
  3343                                  
  3344                                  load_44khz_mono_16_bit:
  3345                                  	; 18/11/2023
  3346 00001AC7 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3347                                  					; last of the file?
  3348 00001ACE 7402                    	jz	short lff44m2_0		; no
  3349 00001AD0 F9                      	stc
  3350 00001AD1 C3                      	retn
  3351                                  
  3352                                  lff44m2_0:
  3353 00001AD2 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3354                                          ;mov	edx, [loadsize]
  3355                                  
  3356                                  	; esi = buffer address
  3357                                  	;; edx = buffer size
  3358                                  
  3359                                  	; load file into memory
  3360                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001AD7 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001ADD 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001ADF 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001AE5 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001AEA CD40                <1>  int 40h
  3361 00001AEC 724D                    	jc	short lff44m2_7 ; error !
  3362                                  
  3363 00001AEE BF[00300000]            	mov	edi, audio_buffer
  3364                                  	
  3365 00001AF3 D1E8                    	shr	eax, 1
  3366 00001AF5 7505                    	jnz	short lff44m2_8
  3367 00001AF7 E992F0FFFF              	jmp	lff44_eof
  3368                                  
  3369                                  lff44m2_8:
  3370 00001AFC 89C1                    	mov	ecx, eax	; word count
  3371                                  lff44m2_9:
  3372 00001AFE BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3373 00001B03 C605[0D210000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3374                                  lff44m2_1:
  3375                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3376                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3377 00001B0A 66AD                    	lodsw
  3378 00001B0C 31D2                    	xor	edx, edx
  3379 00001B0E 49                      	dec	ecx
  3380 00001B0F 7403                    	jz	short lff44m2_2_1
  3381 00001B11 668B16                  	mov	dx, [esi]
  3382                                  lff44m2_2_1:	
  3383                                  	; ax = [previous_val]
  3384                                  	; dx = [next_val]
  3385 00001B14 E80B020000              	call	interpolating_2_16bit_mono
  3386 00001B19 E31B                    	jecxz	lff44m2_3
  3387                                  lff44m2_2_2:
  3388 00001B1B 66AD                    	lodsw
  3389 00001B1D 66AB                    	stosw		; (L)eft Channel
  3390 00001B1F 66AB                    	stosw		; (R)ight Channel
  3391                                  
  3392 00001B21 49                      	dec	ecx
  3393 00001B22 7412                    	jz	short lff44m2_3	
  3394 00001B24 4D                      	dec	ebp
  3395 00001B25 75F4                    	jnz	short lff44m2_2_2
  3396                                  	
  3397 00001B27 FE0D[0D210000]          	dec	byte [faz]
  3398 00001B2D 74CF                    	jz	short lff44m2_9 
  3399 00001B2F BD0B000000              	mov	ebp, 11
  3400 00001B34 EBD4                    	jmp	short lff44m2_1
  3401                                  
  3402                                  lff44m2_3:
  3403                                  lff44s2_3:
  3404 00001B36 E93BF0FFFF              	jmp	lff44_3	; padfill
  3405                                  		; (put zeros in the remain words of the buffer)
  3406                                  lff44m2_7:
  3407                                  lff44s2_7:
  3408 00001B3B E957F0FFFF              	jmp	lff44_5  ; error
  3409                                  
  3410                                  load_44khz_stereo_16_bit:
  3411                                  	; 18/11/2023
  3412 00001B40 F605[2C240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3413                                  					; last of the file?
  3414 00001B47 7402                    	jz	short lff44s2_0		; no
  3415 00001B49 F9                      	stc
  3416 00001B4A C3                      	retn
  3417                                  
  3418                                  lff44s2_0:
  3419 00001B4B BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3420                                          ;mov	edx, [loadsize]
  3421                                  
  3422                                  	; esi = buffer address
  3423                                  	;; edx = buffer size
  3424                                  
  3425                                  	; load file into memory
  3426                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001B50 8B1D[0E210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001B56 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001B58 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001B5E B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001B63 CD40                <1>  int 40h
  3427 00001B65 72D4                    	jc	short lff44s2_7 ; error !
  3428                                  
  3429 00001B67 BF[00300000]            	mov	edi, audio_buffer
  3430                                  	
  3431 00001B6C C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3432 00001B6F 7505                    	jnz	short lff44s2_8
  3433 00001B71 E918F0FFFF              	jmp	lff44_eof
  3434                                  
  3435                                  lff44s2_8:
  3436 00001B76 89C1                    	mov	ecx, eax	; dword count
  3437                                  lff44s2_9:
  3438 00001B78 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3439 00001B7D C605[0D210000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3440                                  lff44s2_1:
  3441                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3442                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3443 00001B84 66AD                    	lodsw
  3444 00001B86 89C3                    	mov	ebx, eax
  3445 00001B88 66AD                    	lodsw
  3446                                  	;mov	dx, [esi]
  3447                                  	;mov	[next_val_l], dx
  3448                                  	;mov	dx, [esi+2]
  3449                                  	; 26/11/2023
  3450 00001B8A 8B16                    	mov	edx, [esi]
  3451 00001B8C 668915[09210000]        	mov	[next_val_l], dx
  3452 00001B93 C1EA10                  	shr	edx, 16
  3453 00001B96 49                      	dec	ecx
  3454 00001B97 7509                    	jnz	short lff44s2_2_1
  3455 00001B99 31D2                    	xor	edx, edx ; 0
  3456 00001B9B 668915[09210000]        	mov	[next_val_l], dx
  3457                                  lff44s2_2_1:
  3458                                  	; bx = [previous_val_l]
  3459                                  	; ax = [previous_val_r]
  3460                                  	; [next_val_l]
  3461                                  	; dx = [next_val_r]
  3462 00001BA2 E895010000              	call	interpolating_2_16bit_stereo
  3463 00001BA7 E38D                    	jecxz	lff44s2_3
  3464                                  lff44s2_2_2:
  3465                                  	;movsw		; (L)eft Channel
  3466                                  	;movsw		; (R)ight Channel
  3467 00001BA9 A5                      	movsd
  3468                                  
  3469 00001BAA 49                      	dec	ecx
  3470 00001BAB 7489                    	jz	short lff44s2_3	
  3471 00001BAD 4D                      	dec	ebp
  3472 00001BAE 75F9                    	jnz	short lff44s2_2_2
  3473                                  	
  3474 00001BB0 FE0D[0D210000]          	dec	byte [faz]
  3475 00001BB6 74C0                    	jz	short lff44s2_9 
  3476 00001BB8 BD0B000000              	mov	ebp, 11
  3477 00001BBD EBC5                    	jmp	short lff44s2_1
  3478                                  
  3479                                  ; .....................
  3480                                  
  3481                                  interpolating_3_8bit_mono:
  3482                                  	; 16/11/2023
  3483                                  	; al = [previous_val]
  3484                                  	; dl = [next_val]
  3485                                  	; original-interpolated-interpolated
  3486 00001BBF 88C3                    	mov	bl, al
  3487 00001BC1 2C80                    	sub	al, 80h
  3488 00001BC3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3489 00001BC7 66AB                    	stosw		; original sample (L)
  3490 00001BC9 66AB                    	stosw		; original sample (R)
  3491 00001BCB 88D8                    	mov	al, bl
  3492 00001BCD 00D0                    	add	al, dl	
  3493 00001BCF D0D8                    	rcr	al, 1
  3494 00001BD1 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3495 00001BD3 00D8                    	add	al, bl
  3496 00001BD5 D0D8                    	rcr	al, 1
  3497 00001BD7 2C80                    	sub	al, 80h
  3498 00001BD9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3499 00001BDD 66AB                    	stosw		; interpolated sample 1 (L)
  3500 00001BDF 66AB                    	stosw		; interpolated sample 1 (R)
  3501 00001BE1 88F8                    	mov	al, bh
  3502 00001BE3 00D0                    	add	al, dl	; [next_val]
  3503 00001BE5 D0D8                    	rcr	al, 1
  3504 00001BE7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3505 00001BEB 66AB                    	stosw		; interpolated sample 2 (L)
  3506 00001BED 66AB                    	stosw		; interpolated sample 2 (R)
  3507 00001BEF C3                      	retn
  3508                                  
  3509                                  interpolating_3_8bit_stereo:
  3510                                  	; 16/11/2023
  3511                                  	; al = [previous_val_l]
  3512                                  	; ah = [previous_val_r]
  3513                                  	; dl = [next_val_l]
  3514                                  	; dh = [next_val_r]	
  3515                                  	; original-interpolated-interpolated
  3516 00001BF0 89C3                    	mov	ebx, eax
  3517 00001BF2 2C80                    	sub	al, 80h
  3518 00001BF4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3519 00001BF8 66AB                    	stosw		; original sample (L)
  3520 00001BFA 88F8                    	mov	al, bh
  3521 00001BFC 2C80                    	sub	al, 80h
  3522 00001BFE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3523 00001C02 66AB                    	stosw		; original sample (R)
  3524 00001C04 88D8                    	mov	al, bl
  3525 00001C06 00D0                    	add	al, dl	; [next_val_l]	
  3526 00001C08 D0D8                    	rcr	al, 1
  3527 00001C0A 50                      	push	eax ; *	; al = interpolated middle (L) (temporary)
  3528 00001C0B 00D8                    	add	al, bl	; [previous_val_l]
  3529 00001C0D D0D8                    	rcr	al, 1
  3530 00001C0F 2C80                    	sub	al, 80h
  3531 00001C11 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3532 00001C15 66AB                    	stosw		; interpolated sample 1 (L)
  3533 00001C17 88F8                    	mov	al, bh
  3534 00001C19 00F0                    	add	al, dh	; [next_val_r]
  3535 00001C1B D0D8                    	rcr	al, 1
  3536 00001C1D 50                      	push	eax ; ** ; al = interpolated middle (R) (temporary)
  3537 00001C1E 00F8                    	add	al, bh	; [previous_val_r]
  3538 00001C20 D0D8                    	rcr	al, 1
  3539 00001C22 2C80                    	sub	al, 80h
  3540 00001C24 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3541 00001C28 66AB                    	stosw		; interpolated sample 1 (R)
  3542 00001C2A 5B                      	pop	ebx ; **
  3543 00001C2B 58                      	pop	eax ; *
  3544 00001C2C 00D0                    	add	al, dl	; [next_val_l]
  3545 00001C2E D0D8                    	rcr	al, 1
  3546 00001C30 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3547 00001C34 66AB                    	stosw		; interpolated sample 2 (L)
  3548 00001C36 88D8                    	mov	al, bl
  3549 00001C38 00F0                    	add	al, dh	; [next_val_r]
  3550 00001C3A D0D8                    	rcr	al, 1
  3551 00001C3C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3552 00001C40 66AB                    	stosw		; interpolated sample 2 (R)
  3553 00001C42 C3                      	retn
  3554                                  
  3555                                  interpolating_2_8bit_mono:
  3556                                  	; 16/11/2023
  3557                                  	; al = [previous_val]
  3558                                  	; dl = [next_val]
  3559                                  	; original-interpolated
  3560 00001C43 88C3                    	mov	bl, al
  3561 00001C45 2C80                    	sub	al, 80h
  3562 00001C47 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3563 00001C4B 66AB                    	stosw		; original sample (L)
  3564 00001C4D 66AB                    	stosw		; original sample (R)
  3565 00001C4F 88D8                    	mov	al, bl
  3566 00001C51 00D0                    	add	al, dl	
  3567 00001C53 D0D8                    	rcr	al, 1
  3568 00001C55 2C80                    	sub	al, 80h
  3569 00001C57 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3570 00001C5B 66AB                    	stosw		; interpolated sample (L)
  3571 00001C5D 66AB                    	stosw		; interpolated sample (R)
  3572 00001C5F C3                      	retn
  3573                                  
  3574                                  interpolating_2_8bit_stereo:
  3575                                  	; 16/11/2023
  3576                                  	; al = [previous_val_l]
  3577                                  	; ah = [previous_val_r]
  3578                                  	; dl = [next_val_l]
  3579                                  	; dh = [next_val_r]	
  3580                                  	; original-interpolated
  3581 00001C60 89C3                    	mov	ebx, eax
  3582 00001C62 2C80                    	sub	al, 80h
  3583 00001C64 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3584 00001C68 66AB                    	stosw		; original sample (L)
  3585 00001C6A 88F8                    	mov	al, bh
  3586 00001C6C 2C80                    	sub	al, 80h
  3587 00001C6E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3588 00001C72 66AB                    	stosw		; original sample (R)
  3589 00001C74 88D8                    	mov	al, bl	; [previous_val_l]
  3590 00001C76 00D0                    	add	al, dl	; [next_val_l]	
  3591 00001C78 D0D8                    	rcr	al, 1
  3592 00001C7A 2C80                    	sub	al, 80h
  3593 00001C7C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3594 00001C80 66AB                    	stosw		; interpolated sample (L)
  3595 00001C82 88F8                    	mov	al, bh
  3596 00001C84 00F0                    	add	al, dh	; [next_val_r]
  3597 00001C86 D0D8                    	rcr	al, 1
  3598 00001C88 2C80                    	sub	al, 80h
  3599 00001C8A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3600 00001C8E 66AB                    	stosw		; interpolated sample (R)
  3601 00001C90 C3                      	retn
  3602                                  
  3603                                  interpolating_3_16bit_mono:
  3604                                  	; 16/11/2023
  3605                                  	; ax = [previous_val]
  3606                                  	; dx = [next_val]
  3607                                  	; original-interpolated-interpolated
  3608                                  
  3609 00001C91 66AB                    	stosw		; original sample (L)
  3610 00001C93 66AB                    	stosw		; original sample (R)
  3611 00001C95 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3612 00001C98 50                      	push	eax ; *	; [previous_val]
  3613 00001C99 80C680                  	add	dh, 80h
  3614 00001C9C 6601D0                  	add	ax, dx
  3615 00001C9F 66D1D8                  	rcr	ax, 1
  3616 00001CA2 5B                      	pop	ebx ; *		
  3617 00001CA3 93                      	xchg	ebx, eax ; bx  = interpolated middle (temporary)
  3618 00001CA4 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  3619 00001CA7 66D1D8                  	rcr	ax, 1
  3620 00001CAA 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3621 00001CAD 66AB                    	stosw 		; interpolated sample 1 (L)
  3622 00001CAF 66AB                    	stosw		; interpolated sample 1 (R)
  3623 00001CB1 89D8                    	mov	eax, ebx
  3624 00001CB3 6601D0                  	add	ax, dx	 ;interpolated middle + [next_val]
  3625 00001CB6 66D1D8                  	rcr	ax, 1
  3626 00001CB9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3627 00001CBC 66AB                    	stosw		; interpolated sample 2 (L)
  3628 00001CBE 66AB                    	stosw		; interpolated sample 2 (R)
  3629 00001CC0 C3                      	retn
  3630                                  
  3631                                  interpolating_3_16bit_stereo:
  3632                                  	; 16/11/2023
  3633                                  	; bx = [previous_val_l]
  3634                                  	; ax = [previous_val_r]
  3635                                  	; [next_val_l]
  3636                                  	; dx = [next_val_r]
  3637                                  	; original-interpolated-interpolated
  3638                                  
  3639 00001CC1 93                      	xchg	eax, ebx
  3640 00001CC2 66AB                    	stosw		; original sample (L)
  3641 00001CC4 93                      	xchg	eax, ebx
  3642 00001CC5 66AB                    	stosw		; original sample (R)
  3643 00001CC7 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3644 00001CCA 50                      	push	eax ; *	; [previous_val_r]
  3645 00001CCB 80C780                  	add	bh, 80h
  3646 00001CCE 8005[0A210000]80        	add	byte [next_val_l+1], 80h
  3647 00001CD5 66A1[09210000]          	mov	ax, [next_val_l]
  3648 00001CDB 6601D8                  	add	ax, bx	; [previous_val_l]
  3649 00001CDE 66D1D8                  	rcr	ax, 1
  3650 00001CE1 93                      	xchg	eax, ebx ; ax = [previous_val_l]
  3651 00001CE2 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  3652 00001CE5 66D1D8                  	rcr	ax, 1
  3653 00001CE8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3654 00001CEB 66AB                    	stosw 		; interpolated sample 1 (L)
  3655 00001CED 58                      	pop	eax  ; *
  3656 00001CEE 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  3657 00001CF1 52                      	push	edx  ; * ; [next_val_r]
  3658 00001CF2 92                      	xchg	eax, edx
  3659 00001CF3 6601D0                  	add	ax, dx	; [next_val_r] + [previous_val_r]
  3660 00001CF6 66D1D8                  	rcr	ax, 1	; / 2
  3661 00001CF9 50                      	push	eax ; ** ; interpolated middle (R)
  3662 00001CFA 6601D0                  	add	ax, dx	; + [previous_val_r]
  3663 00001CFD 66D1D8                  	rcr	ax, 1
  3664 00001D00 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3665 00001D03 66AB                    	stosw 		; interpolated sample 1 (R)
  3666 00001D05 66A1[09210000]          	mov	ax, [next_val_l]
  3667 00001D0B 6601D8                  	add	ax, bx	; + interpolated middle (L)
  3668 00001D0E 66D1D8                  	rcr	ax, 1
  3669 00001D11 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3670 00001D14 66AB                    	stosw 		; interpolated sample 2 (L)
  3671 00001D16 58                      	pop	eax ; **
  3672 00001D17 5A                      	pop	edx ; *	
  3673 00001D18 6601D0                  	add	ax, dx	; interpolated middle + [next_val_r]
  3674 00001D1B 66D1D8                  	rcr	ax, 1	; / 2
  3675 00001D1E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3676 00001D21 66AB                    	stosw 		; interpolated sample 2 (L)
  3677 00001D23 C3                      	retn
  3678                                  
  3679                                  interpolating_2_16bit_mono:
  3680                                  	; 16/11/2023
  3681                                  	; ax = [previous_val]
  3682                                  	; dx = [next_val]
  3683                                  	; original-interpolated
  3684                                  
  3685 00001D24 66AB                    	stosw		; original sample (L)
  3686 00001D26 66AB                    	stosw		; original sample (R)
  3687 00001D28 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3688 00001D2B 80C680                  	add	dh, 80h
  3689 00001D2E 6601D0                  	add	ax, dx
  3690 00001D31 66D1D8                  	rcr	ax, 1
  3691 00001D34 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3692 00001D37 66AB                    	stosw		; interpolated sample (L)
  3693 00001D39 66AB                    	stosw		; interpolated sample (R)
  3694 00001D3B C3                      	retn
  3695                                  
  3696                                  interpolating_2_16bit_stereo:
  3697                                  	; 16/11/2023
  3698                                  	; bx = [previous_val_l]
  3699                                  	; ax = [previous_val_r]
  3700                                  	; [next_val_l]
  3701                                  	; dx = [next_val_r]
  3702                                  	; original-interpolated
  3703                                  
  3704 00001D3C 93                      	xchg	eax, ebx
  3705 00001D3D 66AB                    	stosw		; original sample (L)
  3706 00001D3F 93                      	xchg	eax, ebx
  3707 00001D40 66AB                    	stosw		; original sample (R)
  3708 00001D42 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3709 00001D45 80C680                  	add	dh, 80h
  3710 00001D48 6601D0                  	add	ax, dx	; [previous_val_r] + [next_val_r]
  3711 00001D4B 66D1D8                  	rcr	ax, 1	; / 2
  3712 00001D4E 50                      	push	eax ; *	; interpolated sample (R)
  3713 00001D4F 66A1[09210000]          	mov	ax, [next_val_l]
  3714 00001D55 80C480                  	add	ah, 80h
  3715 00001D58 80C780                  	add	bh, 80h
  3716 00001D5B 6601D8                  	add	ax, bx	; [next_val_l] + [previous_val_l]
  3717 00001D5E 66D1D8                  	rcr	ax, 1	; / 2		
  3718 00001D61 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3719 00001D64 66AB                    	stosw 		; interpolated sample (L)
  3720 00001D66 58                      	pop	eax ; *	
  3721 00001D67 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3722 00001D6A 66AB                    	stosw 		; interpolated sample (R)
  3723 00001D6C C3                      	retn
  3724                                  
  3725                                  interpolating_5_8bit_mono:
  3726                                  	; 17/11/2023
  3727                                  	; al = [previous_val]
  3728                                  	; dl = [next_val]
  3729                                  	; original-interpltd-interpltd-interpltd-interpltd
  3730 00001D6D 88C3                    	mov	bl, al
  3731 00001D6F 2C80                    	sub	al, 80h
  3732 00001D71 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3733 00001D75 66AB                    	stosw		; original sample (L)
  3734 00001D77 66AB                    	stosw		; original sample (R)
  3735 00001D79 88D8                    	mov	al, bl
  3736 00001D7B 00D0                    	add	al, dl	
  3737 00001D7D D0D8                    	rcr	al, 1
  3738 00001D7F 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3739 00001D81 00D8                    	add	al, bl  ; [previous_val]
  3740 00001D83 D0D8                    	rcr	al, 1 	
  3741 00001D85 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  3742 00001D87 00D8                    	add	al, bl
  3743 00001D89 D0D8                    	rcr	al, 1
  3744 00001D8B 2C80                    	sub	al, 80h
  3745 00001D8D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3746 00001D91 66AB                    	stosw		; interpolated sample 1 (L)
  3747 00001D93 66AB                    	stosw		; interpolated sample 1 (R)
  3748 00001D95 88F8                    	mov	al, bh
  3749 00001D97 00F0                    	add	al, dh
  3750 00001D99 D0D8                    	rcr	al, 1
  3751 00001D9B 2C80                    	sub	al, 80h
  3752 00001D9D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3753 00001DA1 66AB                    	stosw		; interpolated sample 2 (L)
  3754 00001DA3 66AB                    	stosw		; interpolated sample 2 (R)
  3755 00001DA5 88F8                    	mov	al, bh
  3756 00001DA7 00D0                    	add	al, dl	; [next_val]
  3757 00001DA9 D0D8                    	rcr	al, 1
  3758 00001DAB 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  3759 00001DAD 00F8                    	add	al, bh
  3760 00001DAF D0D8                    	rcr	al, 1
  3761 00001DB1 2C80                    	sub	al, 80h
  3762 00001DB3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3763 00001DB7 66AB                    	stosw		; interpolated sample 3 (L)
  3764 00001DB9 66AB                    	stosw		; interpolated sample 3 (R)
  3765 00001DBB 88F0                    	mov	al, dh
  3766 00001DBD 00D0                    	add	al, dl
  3767 00001DBF D0D8                    	rcr	al, 1
  3768 00001DC1 2C80                    	sub	al, 80h
  3769 00001DC3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3770 00001DC7 66AB                    	stosw		; interpolated sample 4 (L)
  3771 00001DC9 66AB                    	stosw		; interpolated sample 4 (R)
  3772 00001DCB C3                      	retn
  3773                                  
  3774                                  interpolating_5_8bit_stereo:
  3775                                  	; 17/11/2023
  3776                                  	; al = [previous_val_l]
  3777                                  	; ah = [previous_val_r]
  3778                                  	; dl = [next_val_l]
  3779                                  	; dh = [next_val_r]	
  3780                                  	; original-interpltd-interpltd-interpltd-interpltd
  3781 00001DCC 89C3                    	mov	ebx, eax
  3782 00001DCE 2C80                    	sub	al, 80h
  3783 00001DD0 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3784 00001DD4 66AB                    	stosw		; original sample (L)
  3785 00001DD6 88F8                    	mov	al, bh
  3786 00001DD8 2C80                    	sub	al, 80h
  3787 00001DDA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3788 00001DDE 66AB                    	stosw		; original sample (R)
  3789 00001DE0 52                      	push	edx ; *
  3790 00001DE1 88D8                    	mov	al, bl
  3791 00001DE3 00D0                    	add	al, dl	; [next_val_l]
  3792 00001DE5 D0D8                    	rcr	al, 1
  3793 00001DE7 50                      	push	eax ; **	; al = interpolated middle (L) (temporary)
  3794 00001DE8 00D8                    	add	al, bl	; [previous_val_l]
  3795 00001DEA D0D8                    	rcr	al, 1
  3796 00001DEC 86D8                    	xchg	al, bl	
  3797 00001DEE 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3798 00001DF0 D0D8                    	rcr	al, 1
  3799 00001DF2 2C80                    	sub	al, 80h
  3800 00001DF4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3801 00001DF8 66AB                    	stosw		; interpolated sample 1 (L)
  3802 00001DFA 88F8                    	mov	al, bh
  3803 00001DFC 00F0                    	add	al, dh	; [next_val_r]
  3804 00001DFE D0D8                    	rcr	al, 1
  3805 00001E00 50                      	push	eax ; *** ; al = interpolated middle (R) (temporary)
  3806 00001E01 00F8                    	add	al, bh	; [previous_val_r]
  3807 00001E03 D0D8                    	rcr	al, 1
  3808 00001E05 86F8                    	xchg	al, bh	
  3809 00001E07 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3810 00001E09 D0D8                    	rcr	al, 1
  3811 00001E0B 2C80                    	sub	al, 80h
  3812 00001E0D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3813 00001E11 66AB                    	stosw		; interpolated sample 1 (R)
  3814 00001E13 5A                      	pop	edx ; ***
  3815 00001E14 58                      	pop	eax ; **	; al = interpolated middle (L) (temporary)
  3816 00001E15 86D8                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3817 00001E17 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  3818 00001E19 D0D8                    	rcr	al, 1
  3819 00001E1B 2C80                    	sub	al, 80h
  3820 00001E1D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3821 00001E21 66AB                    	stosw		; interpolated sample 2 (L)	
  3822 00001E23 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  3823 00001E25 86F8                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  3824 00001E27 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  3825 00001E29 D0D8                    	rcr	al, 1
  3826 00001E2B 2C80                    	sub	al, 80h
  3827 00001E2D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3828 00001E31 66AB                    	stosw		; interpolated sample 2 (R)
  3829 00001E33 5A                      	pop	edx ; *
  3830 00001E34 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  3831 00001E36 00D0                    	add	al, dl	; [next_val_l]
  3832 00001E38 D0D8                    	rcr	al, 1
  3833 00001E3A 86D8                    	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  3834 00001E3C 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  3835 00001E3E D0D8                    	rcr	al, 1
  3836 00001E40 2C80                    	sub	al, 80h
  3837 00001E42 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3838 00001E46 66AB                    	stosw		; interpolated sample 3 (L)
  3839 00001E48 88F8                    	mov	al, bh	
  3840 00001E4A 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  3841 00001E4C D0D8                    	rcr	al, 1
  3842 00001E4E 86F8                    	xchg	al, bh	; al = interpolated middle (R)
  3843 00001E50 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  3844 00001E52 D0D8                    	rcr	al, 1
  3845 00001E54 2C80                    	sub	al, 80h
  3846 00001E56 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3847 00001E5A 66AB                    	stosw		; interpolated sample 3 (R)
  3848 00001E5C 88D8                    	mov	al, bl
  3849 00001E5E 00D0                    	add	al, dl	; [next_val_l]
  3850 00001E60 D0D8                    	rcr	al, 1
  3851 00001E62 2C80                    	sub	al, 80h
  3852 00001E64 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3853 00001E68 66AB                    	stosw		; interpolated sample 4 (L)
  3854 00001E6A 88F8                    	mov	al, bh
  3855 00001E6C 00F0                    	add	al, dh	; [next_val_r]
  3856 00001E6E D0D8                    	rcr	al, 1
  3857 00001E70 2C80                    	sub	al, 80h
  3858 00001E72 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3859 00001E76 66AB                    	stosw		; interpolated sample 4 (R)
  3860 00001E78 C3                      	retn
  3861                                  
  3862                                  interpolating_4_8bit_mono:
  3863                                  	; 17/11/2023
  3864                                  	; al = [previous_val]
  3865                                  	; dl = [next_val]
  3866                                  	; original-interpolated-interpolated-interpolated
  3867 00001E79 88C3                    	mov	bl, al
  3868 00001E7B 2C80                    	sub	al, 80h
  3869 00001E7D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3870 00001E81 66AB                    	stosw		; original sample (L)
  3871 00001E83 66AB                    	stosw		; original sample (R)
  3872 00001E85 88D8                    	mov	al, bl
  3873 00001E87 00D0                    	add	al, dl	
  3874 00001E89 D0D8                    	rcr	al, 1
  3875 00001E8B 86D8                    	xchg	al, bl  ; al = [previous_val]
  3876 00001E8D 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  3877 00001E8F D0D8                    	rcr	al, 1 	
  3878 00001E91 2C80                    	sub	al, 80h
  3879 00001E93 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3880 00001E97 66AB                    	stosw		; interpolated sample 1 (L)
  3881 00001E99 66AB                    	stosw		; interpolated sample 1 (R)
  3882 00001E9B 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  3883 00001E9D 2C80                    	sub	al, 80h
  3884 00001E9F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3885 00001EA3 66AB                    	stosw		; interpolated sample 2 (L)
  3886 00001EA5 66AB                    	stosw		; interpolated sample 2 (R)
  3887 00001EA7 88D8                    	mov	al, bl
  3888 00001EA9 00D0                    	add	al, dl	; [next_val]
  3889 00001EAB D0D8                    	rcr	al, 1
  3890 00001EAD 2C80                    	sub	al, 80h
  3891 00001EAF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3892 00001EB3 66AB                    	stosw		; interpolated sample 3 (L)
  3893 00001EB5 66AB                    	stosw		; interpolated sample 3 (R)
  3894 00001EB7 C3                      	retn
  3895                                  
  3896                                  interpolating_4_8bit_stereo:
  3897                                  	; 17/11/2023
  3898                                  	; al = [previous_val_l]
  3899                                  	; ah = [previous_val_r]
  3900                                  	; dl = [next_val_l]
  3901                                  	; dh = [next_val_r]	
  3902                                  	; original-interpolated-interpolated-interpolated
  3903 00001EB8 89C3                    	mov	ebx, eax
  3904 00001EBA 2C80                    	sub	al, 80h
  3905 00001EBC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3906 00001EC0 66AB                    	stosw		; original sample (L)
  3907 00001EC2 88F8                    	mov	al, bh
  3908 00001EC4 2C80                    	sub	al, 80h
  3909 00001EC6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3910 00001ECA 66AB                    	stosw		; original sample (R)
  3911 00001ECC 88D8                    	mov	al, bl
  3912 00001ECE 00D0                    	add	al, dl	; [next_val_l]
  3913 00001ED0 D0D8                    	rcr	al, 1
  3914 00001ED2 86D8                    	xchg	al, bl	; al = [previous_val_l]
  3915 00001ED4 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  3916 00001ED6 D0D8                    	rcr	al, 1
  3917 00001ED8 2C80                    	sub	al, 80h
  3918 00001EDA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3919 00001EDE 66AB                    	stosw		; interpolated sample 1 (L)
  3920 00001EE0 88F8                    	mov	al, bh
  3921 00001EE2 00F0                    	add	al, dh	; [next_val_r]
  3922 00001EE4 D0D8                    	rcr	al, 1
  3923 00001EE6 86F8                    	xchg	al, bh	; al = [previous_val_h]
  3924 00001EE8 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  3925 00001EEA D0D8                    	rcr	al, 1
  3926 00001EEC 2C80                    	sub	al, 80h
  3927 00001EEE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3928 00001EF2 66AB                    	stosw		; interpolated sample 1 (R)
  3929 00001EF4 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  3930 00001EF6 2C80                    	sub	al, 80h
  3931 00001EF8 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3932 00001EFC 66AB                    	stosw		; interpolated sample 2 (L)
  3933 00001EFE 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  3934 00001F00 2C80                    	sub	al, 80h
  3935 00001F02 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3936 00001F06 66AB                    	stosw		; interpolated sample 2 (L)
  3937 00001F08 88D8                    	mov	al, bl
  3938 00001F0A 00D0                    	add	al, dl	; [next_val_l]
  3939 00001F0C D0D8                    	rcr	al, 1
  3940 00001F0E 2C80                    	sub	al, 80h
  3941 00001F10 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3942 00001F14 66AB                    	stosw		; interpolated sample 3 (L)
  3943 00001F16 88F8                    	mov	al, bh
  3944 00001F18 00F0                    	add	al, dh	; [next_val_r]
  3945 00001F1A D0D8                    	rcr	al, 1
  3946 00001F1C 2C80                    	sub	al, 80h
  3947 00001F1E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3948 00001F22 66AB                    	stosw		; interpolated sample 3 (R)
  3949 00001F24 C3                      	retn
  3950                                  
  3951                                  interpolating_5_16bit_mono:
  3952                                  	; 18/11/2023
  3953                                  	; ax = [previous_val]
  3954                                  	; dx = [next_val]
  3955                                  	; original-interpltd-interpltd-interpltd-interpltd
  3956 00001F25 66AB                    	stosw		; original sample (L)
  3957 00001F27 66AB                    	stosw		; original sample (R)
  3958 00001F29 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3959 00001F2C 89C3                    	mov	ebx, eax ; [previous_val]
  3960 00001F2E 80C680                  	add	dh, 80h
  3961 00001F31 6601D0                  	add	ax, dx
  3962 00001F34 66D1D8                  	rcr	ax, 1
  3963 00001F37 50                      	push	eax ; *	; interpolated middle (temporary)
  3964 00001F38 6601D8                  	add	ax, bx	; interpolated middle + [previous_val] 
  3965 00001F3B 66D1D8                  	rcr	ax, 1
  3966 00001F3E 50                      	push	eax ; **	; interpolated 1st quarter (temporary)
  3967 00001F3F 6601D8                  	add	ax, bx	; 1st quarter + [previous_val]
  3968 00001F42 66D1D8                  	rcr	ax, 1	
  3969 00001F45 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3970 00001F48 66AB                    	stosw 		; interpolated sample 1 (L)
  3971 00001F4A 66AB                    	stosw		; interpolated sample 1 (R)
  3972 00001F4C 58                      	pop	eax ; **	
  3973 00001F4D 5B                      	pop	ebx ; *
  3974 00001F4E 6601D8                  	add	ax, bx	; 1st quarter + middle
  3975 00001F51 66D1D8                  	rcr	ax, 1	; / 2
  3976 00001F54 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  3977 00001F57 66AB                    	stosw		; interpolated sample 2 (L)
  3978 00001F59 66AB                    	stosw		; interpolated sample 2 (R)		
  3979 00001F5B 89D8                    	mov	eax, ebx
  3980 00001F5D 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  3981 00001F60 66D1D8                  	rcr	ax, 1
  3982 00001F63 50                      	push	eax ; *	; interpolated 3rd quarter (temporary)
  3983 00001F64 6601D8                  	add	ax, bx	; + interpolated middle
  3984 00001F67 66D1D8                  	rcr	ax, 1
  3985 00001F6A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3986 00001F6D 66AB                    	stosw		; interpolated sample 3 (L)
  3987 00001F6F 66AB                    	stosw		; interpolated sample 3 (R)
  3988 00001F71 58                      	pop	eax ; *	
  3989 00001F72 6601D0                  	add	ax, dx	; 3rd quarter + [next_val]
  3990 00001F75 66D1D8                  	rcr	ax, 1	; / 2
  3991 00001F78 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3992 00001F7B 66AB                    	stosw		; interpolated sample 4 (L)
  3993 00001F7D 66AB                    	stosw		; interpolated sample 4 (R)
  3994 00001F7F C3                      	retn
  3995                                  
  3996                                  interpolating_5_16bit_stereo:
  3997                                  	; 18/11/2023
  3998                                  	; bx = [previous_val_l]
  3999                                  	; ax = [previous_val_r]
  4000                                  	; [next_val_l]
  4001                                  	; [next_val_r]
  4002                                  	; original-interpltd-interpltd-interpltd-interpltd
  4003 00001F80 51                      	push	ecx ; !
  4004 00001F81 93                      	xchg	eax, ebx
  4005 00001F82 66AB                    	stosw		; original sample (L)
  4006 00001F84 93                      	xchg	eax, ebx
  4007 00001F85 66AB                    	stosw		; original sample (R)
  4008 00001F87 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4009 00001F8A 50                      	push	eax ; *	; [previous_val_r]
  4010 00001F8B 80C780                  	add	bh, 80h
  4011 00001F8E 8005[0A210000]80        	add	byte [next_val_l+1], 80h
  4012 00001F95 66A1[09210000]          	mov	ax, [next_val_l]
  4013 00001F9B 6601D8                  	add	ax, bx	; [previous_val_l]
  4014 00001F9E 66D1D8                  	rcr	ax, 1
  4015 00001FA1 89C1                    	mov	ecx, eax ; interpolated middle (L)
  4016 00001FA3 6601D8                  	add	ax, bx	
  4017 00001FA6 66D1D8                  	rcr	ax, 1
  4018 00001FA9 89C2                    	mov	edx, eax ; interpolated 1st quarter (L)	
  4019 00001FAB 6601D8                  	add	ax, bx	; [previous_val_l]
  4020 00001FAE 66D1D8                  	rcr	ax, 1
  4021 00001FB1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4022 00001FB4 66AB                    	stosw 		; interpolated sample 1 (L)
  4023 00001FB6 89C8                    	mov	eax, ecx
  4024 00001FB8 6601D0                  	add	ax, dx	; middle (L) + 1st quarter (L) 
  4025 00001FBB 66D1D8                  	rcr	ax, 1	; / 2
  4026 00001FBE 89C3                    	mov	ebx, eax  ; interpolated sample 2 (L)
  4027 00001FC0 5A                      	pop	edx ; *	; [previous_val_r]
  4028 00001FC1 89D0                    	mov	eax, edx
  4029 00001FC3 8005[0C210000]80        	add	byte [next_val_r+1], 80h
  4030 00001FCA 660305[0B210000]        	add	ax, [next_val_r]
  4031 00001FD1 66D1D8                  	rcr	ax, 1
  4032 00001FD4 50                      	push	eax ; *	; interpolated middle (R)
  4033 00001FD5 6601D0                  	add	ax, dx
  4034 00001FD8 66D1D8                  	rcr	ax, 1
  4035 00001FDB 50                      	push	eax ; ** ; interpolated 1st quarter (R)
  4036 00001FDC 6601D0                  	add	ax, dx	; [previous_val_r]
  4037 00001FDF 66D1D8                  	rcr	ax, 1
  4038 00001FE2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4039 00001FE5 66AB                    	stosw 		; interpolated sample 1 (R)
  4040 00001FE7 89D8                    	mov	eax, ebx
  4041 00001FE9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4042 00001FEC 66AB                    	stosw 		; interpolated sample 2 (L)
  4043 00001FEE 58                      	pop	eax ; **
  4044 00001FEF 5A                      	pop	edx ; *
  4045 00001FF0 6601D0                  	add	ax, dx	; 1st quarter (R) + middle (R)
  4046 00001FF3 66D1D8                  	rcr	ax, 1	; / 2
  4047 00001FF6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4048 00001FF9 66AB                    	stosw 		; interpolated sample 2 (R)
  4049 00001FFB 89C8                    	mov	eax, ecx
  4050 00001FFD 660305[09210000]        	add	ax, [next_val_l]
  4051 00002004 66D1D8                  	rcr	ax, 1
  4052 00002007 50                      	push	eax ; * ; interpolated 3rd quarter (L)
  4053 00002008 6601C8                  	add	ax, cx	; interpolated middle (L)
  4054 0000200B 66D1D8                  	rcr	ax, 1
  4055 0000200E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4056 00002011 66AB                    	stosw 		; interpolated sample 3 (L)
  4057 00002013 89D0                    	mov	eax, edx
  4058 00002015 660305[0B210000]        	add	ax, [next_val_r]
  4059 0000201C 66D1D8                  	rcr	ax, 1
  4060 0000201F 50                      	push	eax ; ** ; interpolated 3rd quarter (R)
  4061 00002020 6601D0                  	add	ax, dx	; interpolated middle (R)
  4062 00002023 66D1D8                  	rcr	ax, 1
  4063 00002026 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4064 00002029 66AB                    	stosw 		; interpolated sample 3 (R)
  4065 0000202B 5B                      	pop	ebx ; **
  4066 0000202C 58                      	pop	eax ; *
  4067 0000202D 660305[09210000]        	add	ax, [next_val_l]
  4068 00002034 66D1D8                  	rcr	ax, 1
  4069 00002037 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4070 0000203A 66AB                    	stosw 		; interpolated sample 4 (L)
  4071 0000203C 89D8                    	mov	eax, ebx	
  4072 0000203E 660305[0B210000]        	add	ax, [next_val_r]
  4073 00002045 66D1D8                  	rcr	ax, 1
  4074 00002048 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4075 0000204B 66AB                    	stosw 		; interpolated sample 4 (R)
  4076 0000204D 59                      	pop	ecx ; !
  4077 0000204E C3                      	retn
  4078                                  
  4079                                  interpolating_4_16bit_mono:
  4080                                  	; 18/11/2023
  4081                                  	; ax = [previous_val]
  4082                                  	; dx = [next_val]
  4083                                  	; original-interpolated
  4084                                  
  4085 0000204F 66AB                    	stosw		; original sample (L)
  4086 00002051 66AB                    	stosw		; original sample (R)
  4087 00002053 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4088 00002056 89C3                    	mov	ebx, eax ; [previous_val]
  4089 00002058 80C680                  	add	dh, 80h
  4090 0000205B 6601D0                  	add	ax, dx	; [previous_val] + [next_val]
  4091 0000205E 66D1D8                  	rcr	ax, 1
  4092 00002061 93                      	xchg	eax, ebx	
  4093 00002062 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  4094 00002065 66D1D8                  	rcr	ax, 1
  4095 00002068 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4096 0000206B 66AB                    	stosw 		; interpolated sample 1 (L)
  4097 0000206D 66AB                    	stosw		; interpolated sample 1 (R)
  4098 0000206F 89D8                    	mov	eax, ebx ; interpolated middle
  4099 00002071 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4100 00002074 66AB                    	stosw 		; interpolated sample 2 (L)
  4101 00002076 66AB                    	stosw		; interpolated sample 2 (R)
  4102 00002078 89D8                    	mov	eax, ebx
  4103 0000207A 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4104 0000207D 66D1D8                  	rcr	ax, 1
  4105 00002080 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4106 00002083 66AB                    	stosw		; interpolated sample 3 (L)
  4107 00002085 66AB                    	stosw		; interpolated sample 3 (R)
  4108 00002087 C3                      	retn
  4109                                  
  4110                                  interpolating_4_16bit_stereo:
  4111                                  	; 18/11/2023
  4112                                  	; bx = [previous_val_l]
  4113                                  	; ax = [previous_val_r]
  4114                                  	; [next_val_l]
  4115                                  	; [next_val_r]
  4116                                  	; original-interpolated-interpolated-interpolated
  4117 00002088 93                      	xchg	eax, ebx
  4118 00002089 66AB                    	stosw		; original sample (L)
  4119 0000208B 93                      	xchg	eax, ebx
  4120 0000208C 66AB                    	stosw		; original sample (R)
  4121 0000208E 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4122 00002091 89C2                    	mov	edx, eax ; [previous_val_r]
  4123 00002093 80C780                  	add	bh, 80h
  4124 00002096 8005[0A210000]80        	add	byte [next_val_l+1], 80h
  4125 0000209D 66A1[09210000]          	mov	ax, [next_val_l]
  4126 000020A3 6601D8                  	add	ax, bx	; [previous_val_l]
  4127 000020A6 66D1D8                  	rcr	ax, 1
  4128 000020A9 93                      	xchg	eax, ebx	
  4129 000020AA 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  4130 000020AD 66D1D8                  	rcr	ax, 1
  4131 000020B0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4132 000020B3 66AB                    	stosw 		; interpolated sample 1 (L)
  4133 000020B5 8005[0C210000]80        	add	byte [next_val_r+1], 80h
  4134 000020BC 89D0                    	mov	eax, edx ; [previous_val_r]
  4135 000020BE 660305[0B210000]        	add	ax, [next_val_r]
  4136 000020C5 66D1D8                  	rcr	ax, 1
  4137 000020C8 92                      	xchg	eax, edx	
  4138 000020C9 6601D0                  	add	ax, dx	; dx = interpolated middle (R)
  4139 000020CC 66D1D8                  	rcr	ax, 1
  4140 000020CF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4141 000020D2 66AB                    	stosw 		; interpolated sample 1 (R)
  4142 000020D4 89D8                    	mov	eax, ebx
  4143 000020D6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4144 000020D9 66AB                    	stosw 		; interpolated sample 2 (L)
  4145 000020DB 89D0                    	mov	eax, edx
  4146 000020DD 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4147 000020E0 66AB                    	stosw 		; interpolated sample 2 (R)
  4148 000020E2 89D8                    	mov	eax, ebx
  4149 000020E4 660305[09210000]        	add	ax, [next_val_l]
  4150 000020EB 66D1D8                  	rcr	ax, 1
  4151 000020EE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4152 000020F1 66AB                    	stosw 		; interpolated sample 3 (L)
  4153 000020F3 89D0                    	mov	eax, edx
  4154 000020F5 660305[0B210000]        	add	ax, [next_val_r]
  4155 000020FC 66D1D8                  	rcr	ax, 1
  4156 000020FF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4157 00002102 66AB                    	stosw 		; interpolated sample 3 (R)
  4158 00002104 C3                      	retn
  4159                                  
  4160                                  ; 13/11/2023
  4161                                  previous_val:
  4162 00002105 0000                    previous_val_l: dw 0
  4163 00002107 0000                    previous_val_r: dw 0
  4164                                  next_val:
  4165 00002109 0000                    next_val_l: dw 0
  4166 0000210B 0000                    next_val_r: dw 0
  4167                                  
  4168                                  ; 16/11/2023
  4169 0000210D 00                      faz:	db 0	
  4170                                  	
  4171                                  ; --------------------------------------------------------
  4172                                  
  4173                                  ; DATA
  4174                                  
  4175                                  FileHandle:	
  4176 0000210E FFFFFFFF                	dd	-1
  4177                                  
  4178                                  Credits:
  4179 00002112 54696E792057415620-     	db	'Tiny WAV Player for TRDOS 386 by Erdogan Tan. '
  4179 0000211B 506C6179657220666F-
  4179 00002124 72205452444F532033-
  4179 0000212D 383620627920457264-
  4179 00002136 6F67616E2054616E2E-
  4179 0000213F 20                 
  4180                                  	;;;db	'August 2020.',10,13,0
  4181                                  	;;db	'November 2023.',10,13,0
  4182                                  	;db	'June 2024.', 10,13,0
  4183 00002140 446563656D62657220-     	db	'December 2024.', 10,13,0
  4183 00002149 323032342E0A0D00   
  4184 00002151 31372F30362F323031-     	db	'17/06/2017', 10,13,0
  4184 0000215A 370A0D00           
  4185 0000215E 31382F30382F323032-     	db	'18/08/2020', 10,13,0
  4185 00002167 300A0D00           
  4186 0000216B 32372F31312F323032-     	db	'27/11/2023', 10,13,0
  4186 00002174 330A0D00           
  4187 00002178 30312F30362F323032-     	db	'01/06/2024', 10,13,0
  4187 00002181 340A0D00           
  4188 00002185 30362F30362F323032-     	db	'06/06/2024', 10,13,0
  4188 0000218E 340A0D00           
  4189 00002192 30382F31322F323032-     	db	'08/12/2024', 10,13,0
  4189 0000219B 340A0D00           
  4190                                  
  4191                                  msgAudioCardInfo:
  4192 0000219F 666F7220496E74656C-     	db 	'for Intel AC97 (ICH) Audio Controller.', 10,13,0
  4192 000021A8 204143393720284943-
  4192 000021B1 482920417564696F20-
  4192 000021BA 436F6E74726F6C6C65-
  4192 000021C3 722E0A0D00         
  4193                                  
  4194                                  msg_usage:
  4195 000021C8 75736167653A20706C-     	db	'usage: playwav6 filename.wav',10,13,0
  4195 000021D1 617977617636206669-
  4195 000021DA 6C656E616D652E7761-
  4195 000021E3 760A0D00           
  4196                                  
  4197                                  noDevMsg:
  4198 000021E7 4572726F723A20556E-     	db	'Error: Unable to find AC97 audio device!'
  4198 000021F0 61626C6520746F2066-
  4198 000021F9 696E64204143393720-
  4198 00002202 617564696F20646576-
  4198 0000220B 69636521           
  4199 0000220F 0A0D00                  	db	10,13,0
  4200                                  
  4201                                  noFileErrMsg:
  4202 00002212 4572726F723A206669-     	db	'Error: file not found.',10,13,0
  4202 0000221B 6C65206E6F7420666F-
  4202 00002224 756E642E0A0D00     
  4203                                  
  4204                                  trdos386_err_msg:
  4205 0000222B 5452444F5320333836-     	db	'TRDOS 386 System call error !',10,13,0
  4205 00002234 2053797374656D2063-
  4205 0000223D 616C6C206572726F72-
  4205 00002246 20210A0D00         
  4206                                  
  4207                                  ; 01/06/2024
  4208                                  msg_init_err:
  4209 0000224B 0A0D                    	db	10,13
  4210 0000224D 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  4210 00002256 726F6C6C65722F436F-
  4210 0000225F 64656320696E697469-
  4210 00002268 616C697A6174696F6E-
  4210 00002271 206572726F722021   
  4211 00002279 0A0D00                  	db	10,13,0
  4212                                  
  4213                                  ; 25/11/2023
  4214                                  msg_no_vra:
  4215 0000227C 0A0D                    	db	10,13
  4216 0000227E 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  4216 00002287 70706F72742021204F-
  4216 00002290 6E6C79203438206B48-
  4216 00002299 5A2073616D706C6520-
  4216 000022A2 726174652073757070-
  4216 000022AB 6F727465642021     
  4217 000022B2 0A0D00                  	db	10,13,0
  4218                                  
  4219 000022B5 0D0A5741562046696C-     msgWavFileName:	db 0Dh, 0Ah, "WAV File Name: ",0
  4219 000022BE 65204E616D653A2000 
  4220 000022C7 0D0A53616D706C6520-     msgSampleRate:	db 0Dh, 0Ah, "Sample Rate: "
  4220 000022D0 526174653A20       
  4221 000022D6 303030303020487A2C-     msgHertz:	db "00000 Hz, ", 0 
  4221 000022DF 2000               
  4222 000022E1 3820626974732C2000      msg8Bits:	db "8 bits, ", 0 
  4223 000022EA 4D6F6E6F0D0A00          msgMono:	db "Mono", 0Dh, 0Ah, 0
  4224 000022F1 313620626974732C20-     msg16Bits:	db "16 bits, ", 0 
  4224 000022FA 00                 
  4225 000022FB 53746572656F            msgStereo:	db "Stereo"
  4226 00002301 0D0A00                  nextline:	db 0Dh, 0Ah, 0
  4227                                  
  4228                                  ; 03/06/2017
  4229 00002304 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  4229 0000230D 3941424344454600   
  4230 00002315 0D0A                    msgAC97Info	db 0Dh, 0Ah
  4231 00002317 414339372041756469-     		db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  4231 00002320 6F20436F6E74726F6C-
  4231 00002329 6C6572202620436F64-
  4231 00002332 656320496E666F0D0A 
  4232 0000233B 56656E646F72204944-     		db "Vendor ID: "
  4232 00002344 3A20               
  4233 00002346 303030306820446576-     msgVendorId	db "0000h Device ID: "
  4233 0000234F 6963652049443A20   
  4234 00002357 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  4235 0000235E 4275733A20              		db "Bus: "
  4236 00002363 303068204465766963-     msgBusNo	db "00h Device: "
  4236 0000236C 653A20             
  4237 0000236F 3030682046756E6374-     msgDevNo	db "00h Function: "
  4237 00002378 696F6E3A20         
  4238 0000237D 303068                  msgFncNo	db "00h"
  4239 00002380 0D0A                    		db 0Dh, 0Ah
  4240 00002382 4E414D4241523A20        		db "NAMBAR: "
  4241 0000238A 30303030682020          msgNamBar	db "0000h  "
  4242 00002391 4E41424D4241523A20      		db "NABMBAR: "
  4243 0000239A 303030306820204952-     msgNabmBar	db "0000h  IRQ: "
  4243 000023A3 513A20             
  4244 000023A6 3030                    msgIRQ		dw 3030h
  4245 000023A8 0D0A00                  		db 0Dh, 0Ah, 0
  4246                                  ; 06/06/2024
  4247 000023AB 0D0A                    msgCodec	db 0Dh, 0Ah
  4248 000023AD 434F44454320            		db "CODEC "
  4249 000023B3 0D0A                    		db 0Dh, 0Ah
  4250 000023B5 56656E646F72204944-     		db "Vendor ID1: "
  4250 000023BE 313A20             
  4251 000023C1 30303030682020          msgCodecId1	db "0000h  "
  4252 000023C8 56656E646F72204944-     		db "Vendor ID2: "
  4252 000023D1 323A20             
  4253 000023D4 30303030682020          msgCodecId2	db "0000h  "  
  4254                                  ; 25/11/2023
  4255 000023DB 0D0A00                  		db 0Dh, 0Ah, 0
  4256 000023DE 56524120737570706F-     msgVRAheader:	db "VRA support: "
  4256 000023E7 72743A20           
  4257 000023EB 00                      		db 0	
  4258 000023EC 5945530D0A00            msgVRAyes:	db "YES", 0Dh, 0Ah, 0
  4259 000023F2 4E4F200D0A              msgVRAno:	db "NO ", 0Dh, 0Ah
  4260 000023F7 28496E746572706F6C-     		db "(Interpolated sample rate playing method)"
  4260 00002400 617465642073616D70-
  4260 00002409 6C6520726174652070-
  4260 00002412 6C6179696E67206D65-
  4260 0000241B 74686F6429         
  4261 00002420 0D0A00                  		db 0Dh, 0Ah, 0	
  4262                                  EOF: 
  4263                                  
  4264                                  ; BSS
  4265                                  
  4266                                  bss_start:
  4267                                  
  4268                                  ABSOLUTE bss_start
  4269                                  
  4270 00002423 ??                      alignb 4
  4271                                  
  4272 00002424 ??                      stmo:		resb 1 ; stereo or mono (1=stereo) 
  4273 00002425 ??                      bps:		resb 1 ; bits per sample (8,16)
  4274 00002426 ????                    sample_rate:	resw 1 ; Sample Frequency (Hz)
  4275                                  
  4276                                  ; 25/11/2023
  4277 00002428 ????????                bufferSize:	resd 1
  4278                                  
  4279 0000242C ??                      flags:		resb 1
  4280                                  ;cbs_busy:	resb 1 
  4281 0000242D ??                      half_buff:	resb 1
  4282 0000242E ??                      srb:		resb 1
  4283                                  ; 18/08/2020
  4284 0000242F ??                      volume_level:	resb 1
  4285                                  ; 25/11/2023
  4286 00002430 ??                      VRA:		resb 1	; Variable Rate Audio Support Status
  4287                                  
  4288 00002431 <res 1Ch>               smpRBuff:	resw 14 
  4289                                  
  4290                                  wav_file_name:
  4291 0000244D <res 50h>               		resb 80 ; wave file, path name (<= 80 bytes)
  4292                                  
  4293 0000249D ????                    		resw 1
  4294 0000249F ??                      ac97_int_ln_reg: resb 1
  4295 000024A0 ??                      fbs_shift:	resb 1 ; 26/11/2023
  4296 000024A1 ????????                dev_vendor:	resd 1
  4297 000024A5 ????????                bus_dev_fn:	resd 1
  4298 000024A9 ????                    ac97_NamBar:	resw 1
  4299 000024AB ????                    ac97_NabmBar:	resw 1
  4300                                  
  4301                                  bss_end:
  4302 000024AD <res B53h>              alignb 4096
  4303                                  ;audio_buffer:	resb BUFFERSIZE ; DMA Buffer Size / 2 (32768)
  4304                                  ; 26/11/2023
  4305 00003000 <res 10000h>            audio_buffer:	resb 65536
  4306                                  ; 13/06/2017
  4307                                  ;temp_buffer:	resb BUFFERSIZE
  4308                                  ; 26/11/2023
  4309 00013000 <res 10000h>            temp_buffer:	resb 65536
