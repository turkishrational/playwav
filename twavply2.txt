     1                                  ; ****************************************************************************
     2                                  ; twavply2.s (for TRDOS 386)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; TWAVPLY2.PRG ! AC'97 (ICH) WAV PLAYER & VGA DEMO program by Erdogan TAN
     5                                  ;
     6                                  ; 09/12/2023
     7                                  ;
     8                                  ; [ Last Modification: 08/12/2024 ]
     9                                  ;
    10                                  ; Modified from: twavplay.s (VIA VT8237R WAV PLAYER & VGA DEMO) program
    11                                  ;	         by Erdogan Tan (24/08/2020) 
    12                                  ;
    13                                  ; Modified from: 'playwav6.s' (AC'97 WAV player) source code
    14                                  ;		 by Erdogan Tan (27/11/2023)
    15                                  ; 
    16                                  ; Assembler: NASM 2.15
    17                                  ; ----------------------------------------------------------------------------
    18                                  ;	   nasm  twavplay.s -l twavplay.txt -o TWAVPLAY.PRG	
    19                                  ; ****************************************************************************
    20                                  
    21                                  ; 09/12/2023
    22                                  ; Modified from: twavplay.s (VIA VT8237R WAV PLAYER & VGA DEMO) program
    23                                  ;	         by Erdogan Tan (24/08/2020)
    24                                  
    25                                  ; 14/07/2020
    26                                  ; 31/12/2017
    27                                  ; TRDOS 386 (v2.0) system calls
    28                                  _ver 	equ 0
    29                                  _exit 	equ 1
    30                                  _fork 	equ 2
    31                                  _read 	equ 3
    32                                  _write	equ 4
    33                                  _open	equ 5
    34                                  _close 	equ 6
    35                                  _wait 	equ 7
    36                                  _create	equ 8
    37                                  _rename	equ 9
    38                                  _delete	equ 10
    39                                  _exec	equ 11
    40                                  _chdir	equ 12
    41                                  _time 	equ 13
    42                                  _mkdir 	equ 14
    43                                  _chmod	equ 15
    44                                  _rmdir	equ 16
    45                                  _break	equ 17
    46                                  _drive	equ 18
    47                                  _seek	equ 19
    48                                  _tell 	equ 20
    49                                  _memory	equ 21
    50                                  _prompt	equ 22
    51                                  _path	equ 23
    52                                  _env	equ 24
    53                                  _stime	equ 25
    54                                  _quit	equ 26
    55                                  _intr	equ 27
    56                                  _dir	equ 28
    57                                  _emt 	equ 29
    58                                  _ldrvt 	equ 30
    59                                  _video 	equ 31
    60                                  _audio	equ 32
    61                                  _timer	equ 33
    62                                  _sleep	equ 34
    63                                  _msg    equ 35
    64                                  _geterr	equ 36
    65                                  _fpstat	equ 37
    66                                  _pri	equ 38
    67                                  _rele	equ 39
    68                                  _fff	equ 40
    69                                  _fnf	equ 41
    70                                  _alloc	equ 42
    71                                  _dalloc equ 43
    72                                  _calbac equ 44
    73                                  _dma	equ 45		
    74                                  
    75                                  %macro sys 1-4
    76                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)	
    77                                      ; 03/09/2015	
    78                                      ; 13/04/2015
    79                                      ; Retro UNIX 386 v1 system call.	
    80                                      %if %0 >= 2   
    81                                          mov ebx, %2
    82                                          %if %0 >= 3    
    83                                              mov ecx, %3
    84                                              %if %0 = 4
    85                                                 mov edx, %4   
    86                                              %endif
    87                                          %endif
    88                                      %endif
    89                                      mov eax, %1
    90                                      ;int 30h
    91                                      int 40h ; TRDOS 386 (TRDOS v2.0)	   
    92                                  %endmacro
    93                                  
    94                                  ; TRDOS 386 (and Retro UNIX 386 v1) system call format:
    95                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
    96                                  
    97                                  ; 19/06/2017
    98                                  BUFFERSIZE equ 32768
    99                                  ; 23/08/2020
   100                                  ENDOFFILE equ 1	; flag for knowing end of file
   101                                  
   102                                  ; ----------------------------------------------------------------------------
   103                                  ; Tiny MOD Player v0.1b by Carlos Hasan.
   104                                  ;	July 14th, 1993.
   105                                  
   106                                  ;=============================================================================
   107                                  ;  
   108                                  ;=============================================================================
   109                                  
   110                                  [BITS 32]
   111                                  [org 0]
   112                                  
   113                                  Start:
   114                                  	; clear bss
   115 00000000 B9[00000500]            	mov	ecx, EOF
   116 00000005 BF[16680000]            	mov	edi, bss_start
   117 0000000A 29F9                    	sub	ecx, edi
   118 0000000C D1E9                    	shr	ecx, 1
   119 0000000E 31C0                    	xor	eax, eax
   120 00000010 F366AB                  	rep	stosw
   121                                  
   122                                  	; 09/12/2023
   123                                  	; Detect (& Enable) AC'97 Audio Device
   124 00000013 E8D1040000              	call	DetectAC97
   125 00000018 731B                    	jnc     short GetFileName
   126                                  
   127                                  _dev_not_ready:
   128                                  ; couldn't find the audio device!
   129                                  	sys	_msg, noDevMsg, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000001A BB[3E660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000001F B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000024 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000029 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 0000002E CD40                <1>  int 40h
   130 00000030 E98E040000                      jmp     Exit
   131                                  
   132                                  GetFileName:
   133 00000035 89E6                    	mov	esi, esp
   134 00000037 AD                      	lodsd
   135 00000038 83F802                  	cmp	eax, 2 ; two arguments 
   136                                  		; (program file name & mod file name)
   137                                  	;jb	pmsg_usage ; nothing to do
   138                                  	; 09/12/2023
   139 0000003B 7305                    	jnb	short _x
   140 0000003D E98F040000              	jmp	pmsg_usage
   141                                  
   142                                  _x:
   143 00000042 AD                      	lodsd ; program file name address 
   144 00000043 AD                      	lodsd ; wav file name address (file to be read)
   145 00000044 89C6                    	mov	esi, eax
   146 00000046 BF[4C680000]            	mov	edi, wav_file_name
   147                                  ScanName:       
   148 0000004B AC                      	lodsb
   149 0000004C 84C0                    	test	al, al
   150                                  	;jz	pmsg_usage
   151                                  	; 09/12/2023
   152 0000004E 7505                    	jnz	short _y
   153 00000050 E97C040000              	jmp	pmsg_usage
   154                                  _y:
   155 00000055 3C20                    	cmp	al, 20h
   156 00000057 74F2                    	je	short ScanName	; scan start of name.
   157 00000059 AA                      	stosb
   158 0000005A B4FF                    	mov	ah, 0FFh
   159                                  a_0:	
   160 0000005C FEC4                    	inc	ah
   161                                  a_1:
   162 0000005E AC                      	lodsb
   163 0000005F AA                      	stosb
   164 00000060 3C2E                    	cmp	al, '.'
   165 00000062 74F8                    	je	short a_0	
   166 00000064 20C0                    	and	al, al
   167 00000066 75F6                    	jnz	short a_1
   168                                  
   169 00000068 08E4                    	or	ah, ah		 ; if period NOT found,
   170 0000006A 750B                    	jnz	short PrintPMesg ; then add a .MOD extension.
   171                                  SetExt:
   172 0000006C 4F                      	dec	edi
   173 0000006D C7072E574156            	mov	dword [edi], '.WAV'
   174 00000073 C6470400                	mov	byte [edi+4], 0
   175                                  PrintPMesg: 
   176                                  	; 23/08/2020
   177 00000077 C605[F6650000]00        	mov	byte [credits_zero], 0
   178                                       
   179                                  	; Prints the Credits Text.
   180                                  	sys	_msg, Credits, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000007E BB[90650000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000083 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000088 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000008D B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000092 CD40                <1>  int 40h
   181                                  _1:
   182                                  	; 19/06/2017
   183                                  	; Allocate Audio Buffer (for user)
   184                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   185                                  	; 09/12/2023
   186                                  	sys	_audio, 0200h, [buffersize], audio_buffer
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000094 BB00020000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000099 8B0D[E1030000]      <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000009F BA[00800000]        <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000A4 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000000A9 CD40                <1>  int 40h
   187 000000AB 7218                    	jc	short error_exit
   188                                  _2:
   189                                  	; 23/08/2020
   190                                  	; Initialize Audio Device (bl = 1 -> Interrupt method)
   191                                  	;sys	_audio, 0301h, 0, audio_int_handler 
   192                                  	;jc	short error_exit
   193                                  	
   194                                  	; 24/08/2020
   195                                  
   196                                  	; 20/10/2017
   197                                  	; Initialize Audio Device (bl = 0 -> SRB method)
   198                                  	sys	_audio, 0300h, 1, srb
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000000AD BB00030000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000000B2 B901000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000000B7 BA[AD680000]        <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000BC B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000000C1 CD40                <1>  int 40h
   199                                  	;jc	short error_exit
   200                                  	; 09/12/2023
   201 000000C3 731B                    	jnc	short open_wav_file
   202                                  
   203                                  error_exit:
   204                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000000C5 BB[82660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000000CA B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000000CF BA0E000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000D4 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000000D9 CD40                <1>  int 40h
   205 000000DB E9E3030000              	jmp	Exit
   206                                  
   207                                  	; 09/12/2023
   208                                  open_wav_file:
   209                                  	; 23/08/2020
   210                                  
   211                                  ; open the wav file
   212                                          ; open existing file
   213 000000E0 E826040000                      call    openFile ; no error? ok.
   214 000000E5 731B                            jnc     short _3
   215                                  
   216                                  ; file not found!
   217                                  	sys	_msg, noFileErrMsg, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000000E7 BB[69660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000000EC B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000000F1 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000F6 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000000FB CD40                <1>  int 40h
   218                                  _z:
   219 000000FD E9C1030000                      jmp	Exit
   220                                  
   221                                  _3:
   222 00000102 E83E040000                     	call    getSampleRate	; read the sample rate
   223                                                               	; pass it onto codec.
   224                                  	;jc	Exit
   225                                  	; 09/12/2023
   226 00000107 72F4                    	jc	short _z
   227                                  
   228 00000109 66A3[2A680000]          	mov	[sample_rate], ax
   229 0000010F 880D[28680000]          	mov	[stmo], cl
   230 00000115 8815[29680000]          	mov	[bps], dl
   231                                  
   232                                  	; 09/12/2023
   233                                  	; 'playwav6.s (27/11/2023)
   234                                  	
   235                                  	; 26/11/2023
   236 0000011B C605[9F680000]00        	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit
   237 00000122 FEC9                    	dec	cl
   238 00000124 7506                    	jnz	short _gsr_1 ; stereo
   239 00000126 FE05[9F680000]          	inc	byte [fbs_shift] ; 1 = mono or 8 bit
   240                                  _gsr_1:	
   241 0000012C 80FA08                  	cmp	dl, 8 
   242 0000012F 7706                    	ja	short _gsr_2 ; 16 bit samples
   243 00000131 FE05[9F680000]          	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   244                                  _gsr_2:
   245                                  
   246                                  	; 10/06/2017
   247                                  	sys	_audio, 0E00h ; get audio controller info
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000137 BB000E0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000013C B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000141 CD40                <1>  int 40h
   248                                  	;jc	error_exit
   249                                  	; 09/12/2023
   250 00000143 7280                    	jc	short error_exit
   251                                  
   252                                  	; 09/12/2023
   253                                  	;cmp	ah, 2 ; ICH ? (Intel AC'97 Audio Controller)
   254                                  	;jne	_dev_not_ready		
   255                                  
   256                                  	; EAX = IRQ Number in AL
   257                                  	;	Audio Device Number in AH 
   258                                  	; EBX = DEV/VENDOR ID
   259                                  	;       (DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV)
   260                                  	; ECX = BUS/DEV/FN 
   261                                  	;       (00000000BBBBBBBBDDDDDFFF00000000)
   262                                  	; EDX = Base IO Addr (DX) for SB16 & VT8233
   263                                  	; EDX = NABMBAR/NAMBAR (for AC97)
   264                                  	;      (Low word, DX = NAMBAR address)
   265                                  
   266                                  	; 09/12/2023
   267 00000145 A2[9E680000]            	mov	[ac97_int_ln_reg], al
   268 0000014A 891D[A0680000]          	mov	[dev_vendor], ebx
   269 00000150 890D[A4680000]          	mov	[bus_dev_fn], ecx
   270                                  	;mov	[ac97_NamBar], dx
   271                                  	;shr	dx, 16
   272                                  	;mov	[ac97_NabmBar], dx
   273 00000156 8915[A8680000]          	mov	[ac97_NamBar], edx	
   274                                  
   275                                  	; 09/12/2023  
   276 0000015C E806070000              	call	write_ac97_pci_dev_info
   277                                  	; 09/12/2023
   278 00000161 E8C8080000              	call	write_VRA_info
   279                                  
   280                                  	; 24/08/2020
   281 00000166 E831060000              	call	write_wav_file_info
   282                                  
   283                                  ; 09/12/2023
   284                                  ; -----------------------------------
   285                                  ; 'playwav6.s' (27/11/2023)
   286                                  
   287 0000016B 803D[B0680000]01        	cmp	byte [VRA], 1
   288 00000172 7205                    	jb	short chk_sample_rate
   289                                  
   290                                  playwav_48_khz:	
   291                                  	;mov	dword [loadfromwavfile], loadFromFile
   292                                  	;mov	dword [buffersize], 65536
   293 00000174 E96C020000              	jmp	PlayNow
   294                                  
   295                                  chk_sample_rate:
   296                                  	; set conversion parameters
   297                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   298 00000179 66A1[2A680000]          	mov	ax, [sample_rate]
   299 0000017F 663D80BB                	cmp	ax, 48000
   300 00000183 74EF                    	je	short playwav_48_khz
   301                                  chk_22khz:
   302 00000185 663D2256                	cmp	ax, 22050
   303 00000189 7545                    	jne	short chk_11khz
   304 0000018B 803D[29680000]08        	cmp	byte [bps], 8
   305 00000192 7615                    	jna	short chk_22khz_1
   306 00000194 BB[B5160000]            	mov	ebx, load_22khz_stereo_16_bit
   307 00000199 803D[28680000]01        	cmp	byte [stmo], 1 
   308 000001A0 751A                    	jne	short chk_22khz_2
   309 000001A2 BB[28160000]            	mov	ebx, load_22khz_mono_16_bit
   310 000001A7 EB13                    	jmp	short chk_22khz_2
   311                                  chk_22khz_1:
   312 000001A9 BB[A1150000]            	mov	ebx, load_22khz_stereo_8_bit
   313 000001AE 803D[28680000]01        	cmp	byte [stmo], 1 
   314 000001B5 7505                    	jne	short chk_22khz_2
   315 000001B7 BB[18150000]            	mov	ebx, load_22khz_mono_8_bit
   316                                  chk_22khz_2:
   317 000001BC B85A1D0000              	mov	eax, 7514  ; (442*17)
   318 000001C1 BA25000000              	mov	edx, 37
   319 000001C6 B911000000              	mov	ecx, 17 
   320 000001CB E9BA010000              	jmp	set_sizes	
   321                                  chk_11khz:
   322 000001D0 663D112B                	cmp	ax, 11025
   323 000001D4 7545                    	jne	short chk_44khz
   324 000001D6 803D[29680000]08        	cmp	byte [bps], 8
   325 000001DD 7615                    	jna	short chk_11khz_1
   326 000001DF BB[D1180000]            	mov	ebx, load_11khz_stereo_16_bit
   327 000001E4 803D[28680000]01        	cmp	byte [stmo], 1 
   328 000001EB 751A                    	jne	short chk_11khz_2
   329 000001ED BB[58180000]            	mov	ebx, load_11khz_mono_16_bit
   330 000001F2 EB13                    	jmp	short chk_11khz_2
   331                                  chk_11khz_1:
   332 000001F4 BB[DE170000]            	mov	ebx, load_11khz_stereo_8_bit
   333 000001F9 803D[28680000]01        	cmp	byte [stmo], 1 
   334 00000200 7505                    	jne	short chk_11khz_2
   335 00000202 BB[66170000]            	mov	ebx, load_11khz_mono_8_bit
   336                                  chk_11khz_2:
   337 00000207 B8AD0E0000              	mov	eax, 3757  ; (221*17)
   338 0000020C BA4A000000              	mov	edx, 74
   339 00000211 B911000000              	mov	ecx, 17
   340 00000216 E96F010000              	jmp	set_sizes 
   341                                  chk_44khz:
   342 0000021B 663D44AC                	cmp	ax, 44100
   343 0000021F 7545                    	jne	short chk_16khz
   344 00000221 803D[29680000]08        	cmp	byte [bps], 8
   345 00000228 7615                    	jna	short chk_44khz_1
   346 0000022A BB[F81A0000]            	mov	ebx, load_44khz_stereo_16_bit
   347 0000022F 803D[28680000]01        	cmp	byte [stmo], 1 
   348 00000236 751A                    	jne	short chk_44khz_2
   349 00000238 BB[7F1A0000]            	mov	ebx, load_44khz_mono_16_bit
   350 0000023D EB13                    	jmp	short chk_44khz_2
   351                                  chk_44khz_1:
   352 0000023F BB[021A0000]            	mov	ebx, load_44khz_stereo_8_bit
   353 00000244 803D[28680000]01        	cmp	byte [stmo], 1 
   354 0000024B 7505                    	jne	short chk_44khz_2
   355 0000024D BB[86190000]            	mov	ebx, load_44khz_mono_8_bit
   356                                  chk_44khz_2:
   357 00000252 B8D93A0000              	mov	eax, 15065 ; (655*23)
   358 00000257 BA19000000              	mov	edx, 25
   359 0000025C B917000000              	mov	ecx, 23
   360 00000261 E924010000              	jmp	set_sizes 
   361                                  chk_16khz:
   362 00000266 663D803E                	cmp	ax, 16000
   363 0000026A 7545                    	jne	short chk_8khz
   364 0000026C 803D[29680000]08        	cmp	byte [bps], 8
   365 00000273 7615                    	jna	short chk_16khz_1
   366 00000275 BB[5D100000]            	mov	ebx, load_16khz_stereo_16_bit
   367 0000027A 803D[28680000]01        	cmp	byte [stmo], 1 
   368 00000281 751A                    	jne	short chk_16khz_2
   369 00000283 BB[DC0F0000]            	mov	ebx, load_16khz_mono_16_bit
   370 00000288 EB13                    	jmp	short chk_16khz_2
   371                                  chk_16khz_1:
   372 0000028A BB[220F0000]            	mov	ebx, load_16khz_stereo_8_bit
   373 0000028F 803D[28680000]01        	cmp	byte [stmo], 1 
   374 00000296 7505                    	jne	short chk_16khz_2
   375 00000298 BB[A30E0000]            	mov	ebx, load_16khz_mono_8_bit
   376                                  chk_16khz_2:
   377 0000029D B855150000              	mov	eax, 5461
   378 000002A2 BA03000000              	mov	edx, 3
   379 000002A7 B901000000              	mov	ecx, 1
   380 000002AC E9D9000000              	jmp	set_sizes 
   381                                  chk_8khz:
   382 000002B1 663D401F                	cmp	ax, 8000
   383 000002B5 7545                    	jne	short chk_24khz
   384 000002B7 803D[29680000]08        	cmp	byte [bps], 8
   385 000002BE 7615                    	jna	short chk_8khz_1
   386 000002C0 BB[580D0000]            	mov	ebx, load_8khz_stereo_16_bit
   387 000002C5 803D[28680000]01        	cmp	byte [stmo], 1 
   388 000002CC 751A                    	jne	short chk_8khz_2
   389 000002CE BB[880C0000]            	mov	ebx, load_8khz_mono_16_bit
   390 000002D3 EB13                    	jmp	short chk_8khz_2
   391                                  chk_8khz_1:
   392 000002D5 BB[580B0000]            	mov	ebx, load_8khz_stereo_8_bit
   393 000002DA 803D[28680000]01        	cmp	byte [stmo], 1 
   394 000002E1 7505                    	jne	short chk_8khz_2
   395 000002E3 BB[7B0A0000]            	mov	ebx, load_8khz_mono_8_bit
   396                                  chk_8khz_2:
   397 000002E8 B8AA0A0000              	mov	eax, 2730
   398 000002ED BA06000000              	mov	edx, 6
   399 000002F2 B901000000              	mov	ecx, 1
   400 000002F7 E98E000000              	jmp	set_sizes 
   401                                  chk_24khz:
   402 000002FC 663DC05D                	cmp	ax, 24000
   403 00000300 7542                    	jne	short chk_32khz
   404 00000302 803D[29680000]08        	cmp	byte [bps], 8
   405 00000309 7615                    	jna	short chk_24khz_1
   406 0000030B BB[87120000]            	mov	ebx, load_24khz_stereo_16_bit
   407 00000310 803D[28680000]01        	cmp	byte [stmo], 1 
   408 00000317 751A                    	jne	short chk_24khz_2
   409 00000319 BB[24120000]            	mov	ebx, load_24khz_mono_16_bit
   410 0000031E EB13                    	jmp	short chk_24khz_2
   411                                  chk_24khz_1:
   412 00000320 BB[9A110000]            	mov	ebx, load_24khz_stereo_8_bit
   413 00000325 803D[28680000]01        	cmp	byte [stmo], 1 
   414 0000032C 7505                    	jne	short chk_24khz_2
   415 0000032E BB[33110000]            	mov	ebx, load_24khz_mono_8_bit
   416                                  chk_24khz_2:
   417 00000333 B800200000              	mov	eax, 8192
   418 00000338 BA02000000              	mov	edx, 2
   419 0000033D B901000000              	mov	ecx, 1
   420 00000342 EB46                    	jmp	short set_sizes 
   421                                  chk_32khz:
   422 00000344 663D007D                	cmp	ax, 32000
   423 00000348 7574                    	jne	short vra_needed
   424 0000034A 803D[29680000]08        	cmp	byte [bps], 8
   425 00000351 7615                    	jna	short chk_32khz_1
   426 00000353 BB[88140000]            	mov	ebx, load_32khz_stereo_16_bit
   427 00000358 803D[28680000]01        	cmp	byte [stmo], 1 
   428 0000035F 751A                    	jne	short chk_32khz_2
   429 00000361 BB[1E140000]            	mov	ebx, load_32khz_mono_16_bit
   430 00000366 EB13                    	jmp	short chk_32khz_2
   431                                  chk_32khz_1:
   432 00000368 BB[81130000]            	mov	ebx, load_32khz_stereo_8_bit
   433 0000036D 803D[28680000]01        	cmp	byte [stmo], 1 
   434 00000374 7505                    	jne	short chk_32khz_2
   435 00000376 BB[0E130000]            	mov	ebx, load_32khz_mono_8_bit
   436                                  chk_32khz_2:
   437 0000037B B8AA2A0000              	mov	eax, 10922
   438 00000380 BA03000000              	mov	edx, 3
   439 00000385 B902000000              	mov	ecx, 2
   440                                  	;jmp	short set_sizes 
   441                                  set_sizes:
   442 0000038A 803D[28680000]01        	cmp	byte [stmo], 1
   443 00000391 7402                    	je	short ss_1
   444 00000393 D1E0                    	shl	eax, 1
   445                                  ss_1:
   446 00000395 803D[29680000]08        	cmp	byte [bps], 8
   447 0000039C 7602                    	jna	short ss_2
   448                                  	; 16 bit samples
   449 0000039E D1E0                    	shl	eax, 1
   450                                  ss_2:
   451 000003A0 A3[DD030000]            	mov	[loadsize], eax
   452 000003A5 F7E2                    	mul	edx
   453                                  	;cmp	ecx, 1
   454                                  	;je	short ss_3
   455                                  ;ss_3:
   456 000003A7 F7F1                    	div	ecx
   457 000003A9 8A0D[9F680000]          	mov	cl, [fbs_shift]
   458 000003AF D3E0                    	shl	eax, cl
   459                                  	; 26/11/2023
   460                                  	;shr	eax, 1	; buffer size is 16 bit sample count
   461 000003B1 A3[E1030000]            	mov	[buffersize], eax ; buffer size in bytes 
   462 000003B6 891D[D9030000]          	mov	[loadfromwavfile], ebx
   463 000003BC EB27                    	jmp	short PlayNow
   464                                  
   465                                  vra_needed:
   466                                  	sys	_msg, msg_no_vra, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000003BE BB[A2660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000003C3 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000003C8 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000003CD B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000003D2 CD40                <1>  int 40h
   467 000003D4 E9EA000000              	jmp	Exit
   468                                  
   469                                  	; 26/11/2023
   470                                  	; 13/11/2023
   471                                  loadfromwavfile:
   472 000003D9 [A3050000]              	dd	loadFromFile
   473                                  loadsize:	; read from wav file
   474 000003DD 00000000                	dd	0
   475                                  buffersize:	; write to DMA buffer
   476 000003E1 00000100                	dd	65536 ; bytes
   477                                  
   478                                  ; -----------------------------------
   479                                  
   480                                  	; 23/08/2020
   481                                  PlayNow: 
   482                                  	; 27/10/2017
   483 000003E5 66B90001                	mov	cx, 256
   484 000003E9 31DB                    	xor	ebx, ebx
   485 000003EB BF[C0680000]            	mov	edi, RowOfs
   486                                  MakeOfs:
   487                                  	; 29/10/2017
   488                                  	;mov	ax, 128
   489                                  	;mul	bx
   490                                  	;mov	al, ah
   491                                  	;mov	ah, 80
   492                                  	;mul	ah
   493 000003F0 89D8                    	mov	eax, ebx
   494 000003F2 66C1E007                	shl	ax, 7 ; * 128
   495 000003F6 B050                    	mov	al, 80
   496 000003F8 F6E4                    	mul	ah
   497 000003FA 66AB                    	stosw
   498 000003FC 43                      	inc	ebx
   499 000003FD E2F1                    	loop	MakeOfs
   500                                  
   501                                  	; 23/08/2020
   502                                  
   503                                  	; DIRECT VGA MEMORY ACCESS
   504                                  	; bl = 0, bh = 5
   505                                  	; Direct access/map to VGA memory (0A0000h)
   506                                  
   507                                  	sys	_video, 0500h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000003FF BB00050000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000404 B81F000000          <1>  mov eax, %1
    90                              <1> 
    91 00000409 CD40                <1>  int 40h
   508 0000040B 3D00000A00              	cmp	eax, 0A0000h
   509 00000410 7405                    	je	short _4
   510                                  	; 09/12/2023
   511 00000412 E9AEFCFFFF              	jmp	error_exit
   512                                  
   513                                  
   514                                  ; Note: Normally IRQ 0 calls the ModPlay Polling at 18.2Hz thru
   515                                  ;       the software interrupt 1Ch. If the IRQ 0 is disabled, then
   516                                  ;       the INT 1Ch MUST BE CALLED at least MixSpeed/1024 times per
   517                                  ;       second, or the module will sound "looped".
   518                                  ;       Because we need better sync with the ModPlayer to draw the scope,
   519                                  ;       the polling is called from my routine, and then the irq 0 must be
   520                                  ;       disabled. The [DmaBuffer] points to the current buffer of 8-bit
   521                                  ;       samples played by the Sound Blaster. Note that some samples are
   522                                  ;       discarded in the next code, just for fun!
   523                                  
   524                                  _4:
   525                                  	;mov     ax, 0013h	; Set Mode 320x200x256
   526                                  	;int     31h
   527                                  
   528                                  	; 21/10/2017
   529                                  	;mov	ax, 0012h	; Set Mode 640x480x16
   530                                  	;int	31h
   531                                  
   532                                  	; 22/10/2017
   533 00000417 E8AA1C0000              	call	setgraphmode	; Set video mode to 640*480x16
   534                                  
   535                                  	; 22/10/2017
   536                                  	;call	loadlbm
   537                                  	;jc	short loadlbm_err
   538                                  
   539 0000041C BE[F2220000]            	mov	esi, LOGO_ADDRESS
   540 00000421 E8921D0000              	call	putlbm
   541                                  	;jnc	short loadlbm_ok
   542 00000426 731D                    	jnc	short _5 ; 
   543                                  
   544                                  	;mov	byte [error_color], 0Eh ; Yellow
   545                                  
   546                                  loadlbm_err:
   547                                  	; 21/10/2017
   548                                  	;mov	ax, 0003h	; Set Text Mode 80x25x16
   549                                  	;int	31h
   550                                  	; 22/10/2017
   551 00000428 E8B61C0000              	call	settextmode
   552                                  
   553                                  	sys	_msg, LOGO_ERROR_MSG, 255, 0Ch
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000042D BB[C6220000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000432 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000437 BA0C000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000043C B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000441 CD40                <1>  int 40h
   554 00000443 EB7E                    	jmp	short Exit
   555                                  
   556                                  loadlbm_ok: 
   557                                  	; 21/10/2017
   558                                  _5:
   559                                  	; 09/10/2017 (2*BUFFERSIZE, 64K)
   560                                  	; 23/06/2017
   561                                  	; Map DMA buffer to user's memory space
   562                                  	;sys	_audio, 0D00h, 2*BUFFERSIZE, DMA_Buffer
   563                                  	; 09/12/2023
   564 00000445 A1[E1030000]            	mov	eax, [buffersize]
   565 0000044A D1E0                    	shl	eax, 1 ; *2
   566                                  	; round up to page boundary (may not be necessary)
   567 0000044C 05FF0F0000              	add	eax, 4095
   568 00000451 2500F0FFFF              	and	eax, ~4095
   569 00000456 A3[C0720000]            	mov	[DMA_buffer_size], eax
   570                                  	;sys	_audio, 0D00h, 131072, DMA_Buffer
   571                                  	sys	_audio, 0D00h, [DMA_buffer_size], DMA_Buffer
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000045B BB000D0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000460 8B0D[C0720000]      <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000466 BA[00000200]        <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000046B B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000470 CD40                <1>  int 40h
   572                                  	;jc	error_exit
   573                                  
   574                                  	; 23/08/2020
   575                                  
   576                                  ; position file pointer to start in actual wav data
   577                                  ; MUCH improvement should really be done here to check if sample size is
   578                                  ; supported, make sure there are 2 channels, etc.  
   579                                  ;
   580                                          ;mov     ah, 42h
   581                                          ;mov     al, 0	; from start of file
   582                                          ;mov     bx, [FileHandle]
   583                                          ;xor     cx, cx
   584                                          ;mov     dx, 44	; jump past .wav/riff header
   585                                          ;int     21h
   586                                  
   587                                  	sys	_seek, [FileHandle], 44, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000472 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000478 B92C000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000047D BA00000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000482 B813000000          <1>  mov eax, %1
    90                              <1> 
    91 00000487 CD40                <1>  int 40h
   588                                  
   589                                  ; play the .wav file. Most of the good stuff is in here.
   590                                  
   591 00000489 E8CA010000                      call    PlayWav
   592                                  
   593                                  ; close the .wav file and exit.
   594                                  
   595                                  StopPlaying:
   596                                  	; Stop Playing
   597                                  	sys	_audio, 0700h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000048E BB00070000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000493 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000498 CD40                <1>  int 40h
   598                                  	; Cancel callback service (for user)
   599                                  	sys	_audio, 0900h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000049A BB00090000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000049F B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004A4 CD40                <1>  int 40h
   600                                  	; Deallocate Audio Buffer (for user)
   601                                  	sys	_audio, 0A00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004A6 BB000A0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004AB B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004B0 CD40                <1>  int 40h
   602                                  	; Disable Audio Device
   603                                  	sys	_audio, 0C00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004B2 BB000C0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004B7 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004BC CD40                <1>  int 40h
   604                                  
   605                                  	; 23/08/2020
   606 000004BE E8201C0000              	call	settextmode
   607                                  Exit:  
   608 000004C3 E85C000000                      call    closeFile
   609                                           
   610                                  	sys	_exit	; Bye!
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81                              <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004C8 B801000000          <1>  mov eax, %1
    90                              <1> 
    91 000004CD CD40                <1>  int 40h
   611                                  here:
   612 000004CF EBFE                    	jmp	short here
   613                                  
   614                                  pmsg_usage:
   615                                  	sys	_msg, msg_usage, 255, 0Bh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004D1 BB[90650000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000004D6 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000004DB BA0B000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004E0 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000004E5 CD40                <1>  int 40h
   616 000004E7 EBDA                    	jmp	short Exit
   617                                  
   618                                  DetectAC97:
   619                                  	; 09/12/2023
   620                                  	; Detect (BH=1) AC'97 (BL=2) Audio Device
   621                                          sys	_audio, 0102h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004E9 BB02010000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004EE B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004F3 CD40                <1>  int 40h
   622 000004F5 7213                    	jc	short DetectAC97_retn
   623                                  
   624                                  	; Get AC'97 Codec info
   625                                  	; (Function 14, sub function 1)
   626                                  	sys	_audio, 0E01h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004F7 BB010E0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004FC B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000501 CD40                <1>  int 40h
   627                                  	; Save Variable Rate Audio support bit
   628 00000503 2401                    	and	al, 1
   629 00000505 A2[B0680000]            	mov	[VRA], al
   630                                  
   631                                  DetectAC97_retn:
   632 0000050A C3                      	retn
   633                                  	
   634                                  	; 23/08/2020
   635                                  
   636                                  ;open or create file
   637                                  ;
   638                                  ;input: ds:dx-->filename (asciiz)
   639                                  ;       al=file Mode (create or open)
   640                                  ;output: none  cs:[FileHandle] filled
   641                                  ;
   642                                  openFile:
   643                                  	;mov	ah, 3Bh	; start with a mode
   644                                  	;add	ah, al	; add in create or open mode
   645                                  	;xor	cx, cx
   646                                  	;int	21h
   647                                  	;jc	short _of1
   648                                  	;;mov	[cs:FileHandle], ax
   649                                  
   650                                  	sys	_open, wav_file_name, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000050B BB[4C680000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000510 B900000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000515 B805000000          <1>  mov eax, %1
    90                              <1> 
    91 0000051A CD40                <1>  int 40h
   651 0000051C 7205                    	jc	short _of1
   652                                  
   653 0000051E A3[8B650000]            	mov	[FileHandle], eax
   654                                  _of1:
   655 00000523 C3                      	retn
   656                                  
   657                                  ; close the currently open file
   658                                  ; input: none, uses cs:[FileHandle]
   659                                  closeFile:
   660 00000524 833D[8B650000]FF        	cmp	dword [FileHandle], -1
   661 0000052B 7417                    	je	short _cf1
   662                                  	;mov    bx, [FileHandle]  
   663                                  	;mov    ax, 3E00h
   664                                          ;int    21h              ;close file
   665                                  
   666                                  	sys	_close, [FileHandle]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000052D 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000533 B806000000          <1>  mov eax, %1
    90                              <1> 
    91 00000538 CD40                <1>  int 40h
   667 0000053A C705[8B650000]FFFF-     	mov 	dword [FileHandle], -1
   667 00000542 FFFF               
   668                                  _cf1:
   669 00000544 C3                      	retn
   670                                  
   671                                  getSampleRate:
   672                                  	
   673                                  ; reads the sample rate from the .wav file.
   674                                  ; entry: none - assumes file is already open
   675                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   676                                  ;	cx = number of channels (mono=1, stereo=2)
   677                                  ;	dx = bits per sample (8, 16)
   678                                  
   679 00000545 53                      	push    ebx
   680                                  
   681                                          ;mov	ah, 42h
   682                                          ;mov	al, 0	; from start of file
   683                                          ;mov	bx, [FileHandle]
   684                                          ;xor	cx, cx
   685                                          ;mov	dx, 08h	; "WAVE"
   686                                          ;int	21h
   687                                  	
   688                                  	sys	_seek, [FileHandle], 8, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000546 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000054C B908000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000551 BA00000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000556 B813000000          <1>  mov eax, %1
    90                              <1> 
    91 0000055B CD40                <1>  int 40h
   689                                  
   690                                          ;mov	dx, smpRBuff
   691                                          ;mov	cx, 28	; 28 bytes
   692                                  	;mov	ah, 3fh
   693                                          ;int	21h
   694                                  
   695                                  	sys	_read, [FileHandle], smpRBuff, 28
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000055D 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000563 B9[30680000]        <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000568 BA1C000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000056D B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000572 CD40                <1>  int 40h
   696                                  
   697 00000574 813D[30680000]5741-     	cmp	dword [smpRBuff], 'WAVE'
   697 0000057C 5645               
   698 0000057E 7520                    	jne	short gsr_stc
   699                                  
   700 00000580 66833D[3C680000]01      	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   701 00000588 7516                    	jne	short gsr_stc
   702                                  
   703 0000058A 668B0D[3E680000]        	mov	cx, [smpRBuff+14]	; return num of channels in CX
   704 00000591 66A1[40680000]                  mov     ax, [smpRBuff+16]	; return sample rate in AX
   705 00000597 668B15[4A680000]        	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   706                                  gsr_retn:
   707 0000059E 5B                              pop     ebx
   708 0000059F C3                              retn
   709                                  gsr_stc:
   710 000005A0 F9                      	stc
   711 000005A1 EBFB                    	jmp	short gsr_retn
   712                                  
   713                                  ;=============================================================================
   714                                  
   715                                  ; 09/12/2023	
   716                                  %if 0
   717                                  	; 'playwav6.s'  (27/11/2023)
   718                                  
   719                                  audio_int_handler:
   720                                  	; 18/08/2020 (14/10/2020, 'wavplay2.s')
   721                                  
   722                                  	;mov	byte [srb], 1 ; interrupt (or signal response byte)
   723                                  	
   724                                  	;cmp	byte [cbs_busy], 1
   725                                  	;jnb	short _callback_bsy_retn
   726                                  	
   727                                  	;mov	byte [cbs_busy], 1
   728                                  
   729                                  	mov	al, [half_buff]
   730                                  
   731                                  	cmp	al, 1
   732                                  	jb	short _callback_retn
   733                                  
   734                                  	; 18/08/2020
   735                                  	mov	byte [srb], 1
   736                                  
   737                                  	xor	byte [half_buff], 3 ; 2->1, 1->2
   738                                  
   739                                  	add	al, '0'
   740                                  tL0:	; 26/11/2023
   741                                  	mov	ah, 4Eh
   742                                  	mov	ebx, 0B8000h ; video display page address
   743                                  	mov	[ebx], ax ; show playing buffer (1, 2)
   744                                  _callback_retn:
   745                                  	;mov	byte [cbs_busy], 0
   746                                  _callback_bsy_retn:
   747                                  	sys	_rele ; return from callback service 
   748                                  	; we must not come here !
   749                                  	sys	_exit
   750                                  
   751                                  %endif
   752                                  
   753                                  ;=============================================================================
   754                                  
   755                                  ; 09/12/2023
   756                                  ; 'playwav6.s' (27/11/2023)
   757                                  
   758                                  loadFromFile:
   759                                  	; 26/11/2023
   760 000005A3 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
   761                                  					; last of the file?
   762 000005AA 7402                    	jz	short lff_0		; no
   763 000005AC F9                      	stc
   764 000005AD C3                      	retn
   765                                  lff_0:
   766                                  	; 13/06/2017
   767                                  	;mov	edx, BUFFERSIZE
   768                                  	; 26/11/2023
   769 000005AE BF[00800000]            	mov	edi, audio_buffer
   770 000005B3 8B15[E1030000]          	mov	edx, [buffersize]	; bytes
   771 000005B9 8A0D[9F680000]          	mov	cl, [fbs_shift]
   772 000005BF 20C9                    	and	cl, cl
   773 000005C1 7409                    	jz	short lff_1 ; stereo, 16 bit
   774                                  
   775                                  	; fbs_shift =
   776                                  	;	2 for mono and 8 bit sample (multiplier = 4)
   777                                  	;	1 for mono or 8 bit sample (multiplier = 2)
   778 000005C3 D3EA                    	shr	edx, cl
   779                                  	;inc	edx
   780                                  
   781 000005C5 BE[00000400]            	mov     esi, temp_buffer
   782 000005CA EB02                    	jmp	short lff_2
   783                                  lff_1:
   784                                  	;mov	esi, audio_buffer
   785 000005CC 89FE                    	mov	esi, edi ; audio_buffer
   786                                  lff_2:
   787                                  	; 17/03/2017
   788                                  	; esi = buffer address
   789                                  	; edx = buffer size
   790                                   
   791                                  	; 26/11/2023
   792                                  	; load file into memory
   793                                  	sys 	_read, [FileHandle], esi
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000005CE 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000005D4 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000005D6 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000005DB CD40                <1>  int 40h
   794 000005DD 89D1                    	mov	ecx, edx
   795 000005DF 724A                    	jc	short padfill ; error !
   796                                  
   797 000005E1 21C0                    	and	eax, eax
   798 000005E3 7446                    	jz	short padfill
   799                                  lff_3:
   800                                  	; 26/11/2023
   801 000005E5 8A1D[9F680000]          	mov	bl, [fbs_shift]
   802 000005EB 20DB                    	and	bl, bl
   803 000005ED 745C                    	jz	short lff_11
   804                                  
   805 000005EF 29C1                    	sub	ecx, eax
   806 000005F1 89CD                    	mov	ebp, ecx
   807                                  
   808                                  	;mov	esi, temp_buffer
   809                                  	;mov	edi, audio_buffer
   810 000005F3 89C1                    	mov	ecx, eax   ; byte count
   811                                  
   812 000005F5 803D[29680000]08        	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   813 000005FC 751E                    	jne	short lff_6 ; 16 bit samples
   814                                  	; 8 bit samples
   815 000005FE FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
   816 00000600 740E                    	jz	short lff_5 ; 8 bit, stereo
   817                                  lff_4:
   818                                  	; mono & 8 bit
   819 00000602 AC                      	lodsb
   820 00000603 2C80                    	sub	al, 80h ; 08/11/2023
   821 00000605 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   822 00000608 66AB                    	stosw	; left channel
   823 0000060A 66AB                    	stosw	; right channel
   824 0000060C E2F4                    	loop	lff_4
   825 0000060E EB16                    	jmp	short lff_8
   826                                  lff_5:
   827                                  	; stereo & 8 bit
   828 00000610 AC                      	lodsb
   829 00000611 2C80                    	sub	al, 80h ; 08/11/2023
   830 00000613 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   831 00000616 66AB                    	stosw
   832 00000618 E2F6                    	loop	lff_5
   833 0000061A EB0A                    	jmp	short lff_8
   834                                  lff_6:
   835 0000061C D1E9                    	shr	ecx, 1 ; word count
   836                                  lff_7:
   837 0000061E 66AD                    	lodsw
   838 00000620 66AB                    	stosw	; left channel
   839 00000622 66AB                    	stosw	; right channel
   840 00000624 E2F8                    	loop	lff_7
   841                                  lff_8:
   842                                  	; 27/11/2023
   843 00000626 F8                      	clc
   844 00000627 89E9                    	mov	ecx, ebp
   845 00000629 E314                    	jecxz	endLFF_retn
   846                                  	
   847                                  padfill:
   848 0000062B 803D[29680000]10        	cmp 	byte [bps], 16
   849 00000632 740C                    	je	short lff_10
   850                                  	; Minimum Value = 0
   851 00000634 30C0                            xor     al, al
   852 00000636 F3AA                    	rep	stosb
   853                                  lff_9:
   854 00000638 800D[AC680000]01                or	byte [flags], ENDOFFILE	; end of file flag
   855                                  endLFF_retn:
   856 0000063F C3                              retn
   857                                  lff_10:
   858 00000640 31C0                    	xor	eax, eax
   859                                  	; Minimum value = 8000h (-32768)
   860 00000642 D1E9                    	shr	ecx, 1 
   861 00000644 B480                    	mov	ah, 80h ; ax = -32768
   862 00000646 F366AB                  	rep	stosw
   863 00000649 EBED                    	jmp	short lff_9
   864                                  
   865                                  lff_11:
   866                                  	; 16 bit stereo
   867                                  	; ecx = buffer size
   868                                  	; eax = read count
   869 0000064B 29C1                    	sub	ecx, eax
   870 0000064D 76F0                    	jna	short endLFF_retn
   871 0000064F 01C7                    	add	edi, eax  ; audio_buffer + eax
   872 00000651 EBED                    	jmp	short lff_10 ; padfill
   873                                  
   874                                  error_exit_2:
   875                                  	; 26/11/2023 - temporary
   876                                  	;sys	_msg, test_2, 255, 0Ch
   877 00000653 E96DFAFFFF              	jmp	error_exit
   878                                  
   879                                  ;=============================================================================
   880                                  ;      
   881                                  ;=============================================================================
   882                                  
   883                                  PlayWav:
   884                                  	; 09/12/2023
   885                                  	;; 23/08/2020
   886                                  	;; load 32768 bytes into audio buffer
   887                                  	;;mov	edi, audio_buffer
   888                                  	;;mov	edx, BUFFERSIZE
   889                                  	;call	loadFromFile
   890                                  	; 09/12/2023
   891 00000658 FF15[D9030000]          	call	dword [loadfromwavfile]
   892 0000065E 72F3                    	jc	short error_exit_2
   893                                  
   894                                  	;mov	byte [half_buff], 1 ; (DMA) Buffer 1
   895                                  
   896                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   897 00000660 F605[AC680000]01        	test    byte [flags], ENDOFFILE  ; end of file
   898 00000667 7512                    	jnz	short _6 ; yes
   899                                  			 ; bypass filling dma half buffer 2
   900                                  
   901                                  	; bh = 16 : update (current, first) dma half buffer
   902                                  	; bl = 0  : then switch to the next (second) half buffer
   903                                  	sys	_audio, 1000h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000669 BB00100000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000066E B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000673 CD40                <1>  int 40h
   904                                  
   905                                  	; 27/07/2020
   906                                  	; [audio_flag] = 1  (in TRDOS 386 kernel)
   907                                  
   908                                  	; audio_buffer must be filled again after above system call 
   909                                  	; (Because audio interrupt will be generated by VT8237R
   910                                  	; at the end of the first half of dma buffer.. so, 
   911                                  	; the second half must be ready. 'sound_play' will use it.)
   912                                  
   913                                  	; 09/12/2023
   914                                  	;; 13/10/2017
   915                                  	;;mov	edi, audio_buffer
   916                                  	;;mov	edx, BUFFERSIZE
   917                                  	;call    loadFromFile
   918                                  	; 09/12/2023
   919 00000675 FF15[D9030000]          	call	dword [loadfromwavfile]
   920                                  	;jc	short p_return
   921                                  
   922                                  _6:
   923                                  	; Set Master Volume Level
   924                                  	sys	_audio, 0B00h, 1D1Dh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000067B BB000B0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000680 B91D1D0000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000685 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000068A CD40                <1>  int 40h
   925                                  	; 24/06/2017
   926                                  	;mov	byte [volume_level], 1Dh
   927 0000068C 880D[AF680000]          	mov	[volume_level], cl	
   928                                  
   929                                  	;mov	byte [srb], 0
   930                                  
   931                                  	; Start	to play
   932 00000692 A0[29680000]            	mov	al, [bps]
   933 00000697 C0E804                  	shr	al, 4 ; 8 -> 0, 16 -> 1
   934 0000069A D0E0                    	shl	al, 1 ; 16 -> 2, 8 -> 0
   935 0000069C 8A1D[28680000]          	mov	bl, [stmo]
   936 000006A2 FECB                    	dec	bl
   937 000006A4 08C3                    	or	bl, al
   938 000006A6 668B0D[2A680000]        	mov	cx, [sample_rate] 
   939 000006AD B704                    	mov	bh, 4 ; start to play	
   940                                  	sys	_audio
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81                              <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000006AF B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000006B4 CD40                <1>  int 40h
   941                                  
   942                                  	; 27/07/2020
   943                                  	; Here..
   944                                  	; If byte [flags] <> ENDOFFILE ...
   945                                  	; user's audio_buffer has been copied to dma half buffer 2
   946                                  
   947                                  	; [audio_flag] = 0  (in TRDOS 386 kernel)
   948                                  
   949                                  	; audio_buffer must be filled again after above system call 
   950                                  	; (Because, audio interrupt will be generated by VT8237R
   951                                  	; at the end of the first half of dma buffer.. so, 
   952                                  	; the 2nd half of dma buffer is ready but the 1st half
   953                                  	; must be filled again.)
   954                                  
   955                                  	; 27/07/2020
   956 000006B6 F605[AC680000]01        	test    byte [flags], ENDOFFILE  ; end of file
   957 000006BD 750C                    	jnz	short p_loop ; yes
   958                                  
   959                                  	; 13/10/2017
   960                                  	;mov	edi, audio_buffer
   961                                  	;mov	edx, BUFFERSIZE
   962                                  	; 09/12/2023
   963                                  	;mov	edx, [buffersize]
   964                                  	;call	loadFromFile
   965 000006BF FF15[D9030000]          	call	dword [loadfromwavfile]
   966                                  	;jc	short p_return
   967                                  	;mov	byte [half_buff], 2 ; (DMA) Buffer 2
   968                                  
   969                                  	; we need to wait for 'SRB' (audio interrupt)
   970                                  	; (we can not return from 'PlayWav' here 
   971                                  	;  even if we have got an error from file reading)
   972                                  	; ((!!current audio data must be played!!))
   973                                  
   974                                  	;mov	ebx, 0B8000h ; video display page address
   975                                  	;mov	ah, 4Eh
   976                                  	;add	al, [half_buffer]
   977                                  	;mov	[ebx], ax ; show playing buffer (1, 2)
   978                                  
   979                                  	;; load 32768 bytes into audio buffer
   980                                  	;; (for the second half of DMA buffer)
   981                                  	;; 20/05/2017
   982                                  	;mov	edi, audio_buffer
   983                                  	;mov	edx, BUFFERSIZE
   984                                  	;call	loadFromFile
   985                                  	;jc	short p_return
   986                                  	;mov	byte [half_buff], 2 ; (DMA) Buffer 2
   987                                  
   988                                  	; 23/08/2020
   989                                  
   990                                  	; 27/10/2017
   991                                  	
   992                                  	; 03/08/2020
   993                                       	;jmp	short modp_gs ; 23/06/2017
   994                                  
   995                                  	; 24/08/2020
   996 000006C5 FE05[AE680000]          	inc	byte [counter]
   997                                  p_loop:
   998 000006CB 803D[AD680000]00        	cmp	byte [srb], 0
   999 000006D2 7611                    	jna	short q_loop
  1000                                  
  1001 000006D4 C605[AD680000]00        	mov	byte [srb], 0
  1002                                  modp_gs:
  1003                                  	; 24/08/2020
  1004                                  	;mov	edi, audio_buffer
  1005                                  	;mov	edx, BUFFERSIZE
  1006                                  	; 09/12/2023
  1007                                  	;call	loadFromFile
  1008                                  	;mov	edx, [buffersize]
  1009 000006DB FF15[D9030000]          	call	dword [loadfromwavfile]
  1010 000006E1 723A                    	jc	short q_return
  1011                                  
  1012                                  	; 23/08/2020
  1013 000006E3 EB6B                    	jmp	r_loop
  1014                                  q_loop:
  1015                                  	; 24/08/2020
  1016 000006E5 F605[AE680000]3F        	test	byte [counter], 63
  1017 000006EC 7562                    	jnz	short r_loop
  1018                                  k_loop:
  1019 000006EE B401                    	mov     ah, 1		; any key pressed?
  1020 000006F0 CD32                    	int     32h		; no, Loop.
  1021 000006F2 745C                    	jz	short r_loop
  1022                                  
  1023 000006F4 B400                    	mov     ah, 0		; flush key buffer...
  1024 000006F6 CD32                    	int     32h
  1025                                  
  1026                                  	; 19/10/2017 (modplay6.s)
  1027 000006F8 3C20                    	cmp	al, 20h
  1028 000006FA 740E                    	je	short change_pan
  1029                                  	; 09/10/2017 (playmod5.s)
  1030 000006FC 3C2B                    	cmp	al, '+' ; increase sound volume
  1031 000006FE 741E                    	je	short inc_volume_level
  1032 00000700 3C2D                    	cmp	al, '-'
  1033 00000702 743D                    	je	short dec_volume_level
  1034                                  
  1035                                  	; 19/10/2017 (modplay6.s)
  1036 00000704 24DF                    	and	al, 0DFh
  1037 00000706 3C50                    	cmp	al, 'P'
  1038 00000708 7513                    	jne	short q_return
  1039                                  
  1040                                  change_pan:
  1041                                  	; 19/10/2017 (modplay6.s)
  1042 0000070A 8A0D[B1680000]          	mov	cl, [pan_shift]
  1043 00000710 FEC1                    	inc	cl
  1044 00000712 80E103                  	and	cl, 3
  1045 00000715 880D[B1680000]          	mov	[pan_shift], cl
  1046 0000071B EB33                    	jmp	short r_loop
  1047                                  
  1048                                  q_return:
  1049 0000071D C3                      	retn
  1050                                  
  1051                                  	; 09/10/2017 (playmod5.s)
  1052                                  	; 24/06/2017 (wavplay2.s)
  1053                                  inc_volume_level:
  1054 0000071E 8A0D[AF680000]          	mov	cl, [volume_level]
  1055 00000724 80F91F                  	cmp	cl, 1Fh ; 31
  1056                                  	;jnb	short r_loop
  1057                                  	; 09/12/2023
  1058 00000727 73C5                    	jnb	short k_loop
  1059 00000729 FEC1                    	inc	cl
  1060                                  change_volume_level:
  1061 0000072B 880D[AF680000]          	mov	[volume_level], cl
  1062 00000731 88CD                    	mov	ch, cl
  1063                                  	; Set Master Volume Level
  1064                                  	sys	_audio, 0B00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000733 BB000B0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000738 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000073D CD40                <1>  int 40h
  1065 0000073F EB0F                    	jmp	short r_loop
  1066                                  dec_volume_level:
  1067 00000741 8A0D[AF680000]          	mov	cl, [volume_level]
  1068 00000747 80F901                  	cmp	cl, 1 ; 1
  1069                                  	;jna	short r_loop
  1070                                  	; 09/12/2023
  1071 0000074A 76A2                    	jna	short k_loop
  1072 0000074C FEC9                    	dec	cl
  1073 0000074E EBDB                    	jmp	short change_volume_level
  1074                                  
  1075                                  r_loop:
  1076                                  	; 24/08/2020
  1077 00000750 FE05[AE680000]          	inc	byte [counter]
  1078                                  	; 09/12/2023
  1079                                  	;jnz	short q_loop
  1080                                  	;test	byte [counter], 0Fh
  1081 00000756 758D                    	jnz	short q_loop
  1082                                  _10:
  1083                                  	; 09/12/2023
  1084 00000758 F605[9F680000]FF        	test	byte [fbs_shift], 0FFh
  1085 0000075F 7405                    	jz	short _9
  1086                                  
  1087                                  	; 23/08/2020
  1088                                  	;test	byte [stmo], 2
  1089                                  	;;jz	p_loop
  1090                                  	;; 09/12/2023
  1091                                  	;jz	short _8
  1092                                  	;cmp	byte [bps], 16
  1093                                  	;;jne	p_loop
  1094                                  	;; 09/12/2023
  1095                                  	;je	short _9
  1096                                  _8:
  1097 00000761 E965FFFFFF              	jmp	p_loop
  1098                                  
  1099                                  _9:
  1100                                  	; 27/10/2017
  1101                                  	; Get Current DMA buffer Pointer 
  1102                                  	; 23/06/2017 ('modplay6.s')
  1103                                  	; bh = 15, get current pointer (DMA buffer offset)
  1104                                  	; bl = 0, for PCM OUT
  1105                                  	; ecx = 0
  1106                                  	;
  1107                                  	sys	_audio, 0F00h, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000766 BB000F0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000076B B900000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000770 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000775 CD40                <1>  int 40h
  1108                                  
  1109                                  	; 28/10/2017
  1110 00000777 24FC                    	and	al, 0FCh  ; dword alignment (stereo, 16 bit)	
  1111                                  	; 23/06/2017
  1112 00000779 BE[00000200]            	mov     esi, DMA_Buffer
  1113 0000077E 01C6                    	add     esi, eax	; add offset value
  1114                                  
  1115                                  	; 24/06/2017
  1116                                  	;mov	ecx, DMA_Buffer + (65536 - (256*4))
  1117                                  	; 09/12/2023
  1118 00000780 8B0D[C0720000]          	mov	ecx, [DMA_buffer_size]
  1119 00000786 81C1[00FC0100]          	add	ecx, DMA_Buffer - (256*4)
  1120                                  
  1121 0000078C 39CE                    	cmp	esi, ecx 
  1122 0000078E 7602                    	jna	short _7
  1123 00000790 89CE                    	mov	esi, ecx
  1124                                  _7:
  1125                                  	; 23/10/2017 ('tmodplay.s')
  1126 00000792 E853190000              	call	drawscopes
  1127                                  
  1128 00000797 E92FFFFFFF              	jmp	p_loop
  1129                                  
  1130                                  ;=============================================================================
  1131                                  ; 
  1132                                  ;=============================================================================
  1133                                  
  1134                                  ;dword2str:
  1135                                  ;	; 13/11/2016 - Erdogan Tan 
  1136                                  ;	; eax = dword value
  1137                                  ;	;
  1138                                  ;	call	dwordtohex
  1139                                  ;	mov	[dword_str], edx
  1140                                  ;	mov	[dword_str+4], eax
  1141                                  ;	mov	si, dword_str
  1142                                  ;	retn
  1143                                  
  1144                                  	; 05/03/2017 (TRDOS 386)
  1145                                  	; trdos386.s (unix386.s) - 10/05/2015
  1146                                  	; Convert binary number to hexadecimal string
  1147                                  
  1148                                  ;bytetohex:
  1149                                  ;	; INPUT ->
  1150                                  ;	; 	AL = byte (binary number)
  1151                                  ;	; OUTPUT ->
  1152                                  ;	;	AX = hexadecimal string
  1153                                  ;	;
  1154                                  ;	push	ebx
  1155                                  ;	movzx	ebx, al
  1156                                  ;	shr	bl, 4
  1157                                  ;	mov	bl, [ebx+hex_chars] 	 	
  1158                                  ;	xchg	bl, al
  1159                                  ;	and	bl, 0Fh
  1160                                  ;	mov	ah, [ebx+hex_chars] 
  1161                                  ;	pop	ebx	
  1162                                  ;	retn
  1163                                  
  1164                                  ;wordtohex:
  1165                                  ;	; INPUT ->
  1166                                  ;	; 	AX = word (binary number)
  1167                                  ;	; OUTPUT ->
  1168                                  ;	;	EAX = hexadecimal string
  1169                                  ;	;
  1170                                  ;	push	ebx
  1171                                  ;	xor	ebx, ebx
  1172                                  ;	xchg	ah, al
  1173                                  ;	push	eax
  1174                                  ;	mov	bl, ah
  1175                                  ;	shr	bl, 4
  1176                                  ;	mov	al, [ebx+hex_chars] 	 	
  1177                                  ;	mov	bl, ah
  1178                                  ;	and	bl, 0Fh
  1179                                  ;	mov	ah, [ebx+hex_chars]
  1180                                  ;	shl	eax, 16
  1181                                  ;	pop	eax
  1182                                  ;	pop	ebx
  1183                                  ;	jmp	short bytetohex
  1184                                  
  1185                                  ;dwordtohex:
  1186                                  ;	; INPUT ->
  1187                                  ;	; 	EAX = dword (binary number)
  1188                                  ;	; OUTPUT ->
  1189                                  ;	;	EDX:EAX = hexadecimal string
  1190                                  ;	;
  1191                                  ;	push	eax
  1192                                  ;	shr	eax, 16
  1193                                  ;	call	wordtohex
  1194                                  ;	mov	edx, eax
  1195                                  ;	pop	eax
  1196                                  ;	call	wordtohex
  1197                                  ;	retn
  1198                                  
  1199                                  ; 09/12/2023
  1200                                  ; 'playwav6.s' (27/11/2023)
  1201                                  
  1202                                  write_wav_file_info:
  1203                                  	; 01/05/2017
  1204                                  	sys	_msg, msgWavFileName, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000079C BB[82670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000007A1 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000007A6 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000007AB B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000007B0 CD40                <1>  int 40h
  1205                                  	sys	_msg, wav_file_name, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000007B2 BB[4C680000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000007B7 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000007BC BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000007C1 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000007C6 CD40                <1>  int 40h
  1206                                  
  1207                                  write_sample_rate:
  1208                                  	; 01/05/2017
  1209 000007C8 66A1[2A680000]          	mov	ax, [sample_rate]
  1210                                  	; ax = sample rate (hertz)
  1211 000007CE 31D2                    	xor	edx, edx
  1212 000007D0 66B90A00                	mov	cx, 10
  1213 000007D4 66F7F1                  	div	cx
  1214 000007D7 0015[A7670000]          	add	[msgHertz+4], dl
  1215 000007DD 29D2                    	sub	edx, edx
  1216 000007DF 66F7F1                  	div	cx
  1217 000007E2 0015[A6670000]          	add	[msgHertz+3], dl
  1218 000007E8 29D2                    	sub	edx, edx
  1219 000007EA 66F7F1                  	div	cx
  1220 000007ED 0015[A5670000]          	add	[msgHertz+2], dl
  1221 000007F3 29D2                    	sub	edx, edx
  1222 000007F5 66F7F1                  	div	cx
  1223 000007F8 0015[A4670000]          	add	[msgHertz+1], dl
  1224 000007FE 0005[A3670000]          	add	[msgHertz], al
  1225                                  	
  1226                                  	sys	_msg, msgSampleRate, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000804 BB[94670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000809 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000080E BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000813 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000818 CD40                <1>  int 40h
  1227                                  
  1228 0000081A BE[BE670000]            	mov	esi, msg16Bits
  1229 0000081F 803D[29680000]10        	cmp	byte [bps], 16
  1230 00000826 7405                    	je	short wsr_1
  1231 00000828 BE[AE670000]            	mov	esi, msg8Bits
  1232                                  wsr_1:
  1233                                  	sys	_msg, esi, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000082D 89F3                <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000082F B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000834 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000839 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 0000083E CD40                <1>  int 40h
  1234                                  
  1235 00000840 BE[B7670000]            	mov	esi, msgMono
  1236 00000845 803D[28680000]01        	cmp	byte [stmo], 1
  1237 0000084C 7405                    	je	short wsr_2
  1238 0000084E BE[C8670000]            	mov	esi, msgStereo		
  1239                                  wsr_2:
  1240                                  	sys	_msg, esi, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000853 89F3                <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000855 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000085A BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000085F B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000864 CD40                <1>  int 40h
  1241 00000866 C3                              retn
  1242                                  
  1243                                  write_ac97_pci_dev_info:
  1244                                  	; 06/06/2017
  1245                                  	; 03/06/2017
  1246                                  	; BUS/DEV/FN
  1247                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1248                                  	; DEV/VENDOR
  1249                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1250                                  
  1251 00000867 8B35[A0680000]          	mov	esi, [dev_vendor]
  1252 0000086D 89F0                    	mov	eax, esi
  1253 0000086F 0FB6D8                  	movzx	ebx, al
  1254 00000872 88DA                    	mov	dl, bl
  1255 00000874 80E30F                  	and	bl, 0Fh
  1256 00000877 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1257 0000087D A2[20670000]            	mov	[msgVendorId+3], al
  1258 00000882 88D3                    	mov	bl, dl
  1259 00000884 C0EB04                  	shr	bl, 4
  1260 00000887 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1261 0000088D A2[1F670000]            	mov	[msgVendorId+2], al
  1262 00000892 88E3                    	mov	bl, ah
  1263 00000894 88DA                    	mov	dl, bl
  1264 00000896 80E30F                  	and	bl, 0Fh
  1265 00000899 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1266 0000089F A2[1E670000]            	mov	[msgVendorId+1], al
  1267 000008A4 88D3                    	mov	bl, dl
  1268 000008A6 C0EB04                  	shr	bl, 4
  1269 000008A9 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1270 000008AF A2[1D670000]            	mov	[msgVendorId], al
  1271 000008B4 C1E810                  	shr	eax, 16
  1272 000008B7 88C3                    	mov	bl, al
  1273 000008B9 88DA                    	mov	dl, bl
  1274 000008BB 80E30F                  	and	bl, 0Fh
  1275 000008BE 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1276 000008C4 A2[31670000]            	mov	[msgDevId+3], al
  1277 000008C9 88D3                    	mov	bl, dl
  1278 000008CB C0EB04                  	shr	bl, 4
  1279 000008CE 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1280 000008D4 A2[30670000]            	mov	[msgDevId+2], al
  1281 000008D9 88E3                    	mov	bl, ah
  1282 000008DB 88DA                    	mov	dl, bl
  1283 000008DD 80E30F                  	and	bl, 0Fh
  1284 000008E0 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1285 000008E6 A2[2F670000]            	mov	[msgDevId+1], al
  1286 000008EB 88D3                    	mov	bl, dl
  1287 000008ED C0EB04                  	shr	bl, 4
  1288 000008F0 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1289 000008F6 A2[2E670000]            	mov	[msgDevId], al
  1290                                  
  1291 000008FB 8B35[A4680000]          	mov	esi, [bus_dev_fn]
  1292 00000901 C1EE08                  	shr	esi, 8
  1293 00000904 6689F0                  	mov	ax, si
  1294 00000907 88C3                    	mov	bl, al
  1295 00000909 88DA                    	mov	dl, bl
  1296 0000090B 80E307                  	and	bl, 7 ; bit 0,1,2
  1297 0000090E 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1298 00000914 A2[55670000]            	mov	[msgFncNo+1], al
  1299 00000919 88D3                    	mov	bl, dl
  1300 0000091B C0EB03                  	shr	bl, 3
  1301 0000091E 88DA                    	mov	dl, bl
  1302 00000920 80E30F                  	and	bl, 0Fh
  1303 00000923 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1304 00000929 A2[47670000]            	mov	[msgDevNo+1], al
  1305 0000092E 88D3                    	mov	bl, dl
  1306 00000930 C0EB04                  	shr	bl, 4
  1307 00000933 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1308 00000939 A2[46670000]            	mov	[msgDevNo], al
  1309 0000093E 88E3                    	mov	bl, ah
  1310 00000940 88DA                    	mov	dl, bl
  1311 00000942 80E30F                  	and	bl, 0Fh
  1312 00000945 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1313 0000094B A2[3B670000]            	mov	[msgBusNo+1], al
  1314 00000950 88D3                    	mov	bl, dl
  1315 00000952 C0EB04                  	shr	bl, 4
  1316 00000955 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1317 0000095B A2[3A670000]            	mov	[msgBusNo], al
  1318                                  
  1319 00000960 66A1[A8680000]          	mov	ax, [ac97_NamBar]
  1320 00000966 88C3                    	mov	bl, al
  1321 00000968 88DA                    	mov	dl, bl
  1322 0000096A 80E30F                  	and	bl, 0Fh
  1323 0000096D 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1324 00000973 A2[64670000]            	mov	[msgNamBar+3], al
  1325 00000978 88D3                    	mov	bl, dl
  1326 0000097A C0EB04                  	shr	bl, 4
  1327 0000097D 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1328 00000983 A2[63670000]            	mov	[msgNamBar+2], al
  1329 00000988 88E3                    	mov	bl, ah
  1330 0000098A 88DA                    	mov	dl, bl
  1331 0000098C 80E30F                  	and	bl, 0Fh
  1332 0000098F 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1333 00000995 A2[62670000]            	mov	[msgNamBar+1], al
  1334 0000099A 88D3                    	mov	bl, dl
  1335 0000099C C0EB04                  	shr	bl, 4
  1336 0000099F 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1337 000009A5 A2[61670000]            	mov	[msgNamBar], al
  1338                                  
  1339 000009AA 66A1[AA680000]          	mov	ax, [ac97_NabmBar]
  1340 000009B0 88C3                    	mov	bl, al
  1341 000009B2 88DA                    	mov	dl, bl
  1342 000009B4 80E30F                  	and	bl, 0Fh
  1343 000009B7 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1344 000009BD A2[74670000]            	mov	[msgNabmBar+3], al
  1345 000009C2 88D3                    	mov	bl, dl
  1346 000009C4 C0EB04                  	shr	bl, 4
  1347 000009C7 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1348 000009CD A2[73670000]            	mov	[msgNabmBar+2], al
  1349 000009D2 88E3                    	mov	bl, ah
  1350 000009D4 88DA                    	mov	dl, bl
  1351 000009D6 80E30F                  	and	bl, 0Fh
  1352 000009D9 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1353 000009DF A2[72670000]            	mov	[msgNabmBar+1], al
  1354 000009E4 88D3                    	mov	bl, dl
  1355 000009E6 C0EB04                  	shr	bl, 4
  1356 000009E9 8A83[DB660000]          	mov	al, [ebx+hex_chars]
  1357 000009EF A2[71670000]            	mov	[msgNabmBar], al
  1358                                  
  1359 000009F4 30E4                    	xor	ah, ah
  1360 000009F6 A0[9E680000]            	mov	al, [ac97_int_ln_reg]
  1361 000009FB B10A                    	mov	cl, 10
  1362 000009FD F6F1                    	div	cl
  1363 000009FF 660105[7D670000]        	add	[msgIRQ], ax
  1364 00000A06 20C0                    	and	al, al
  1365 00000A08 750D                    	jnz	short _w_ac97imsg_
  1366 00000A0A A0[7E670000]            	mov	al, [msgIRQ+1]
  1367 00000A0F B420                    	mov	ah, ' '
  1368 00000A11 66A3[7D670000]          	mov	[msgIRQ], ax
  1369                                  _w_ac97imsg_:
  1370                                  	sys	_msg, msgAC97Info, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A17 BB[EC660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A1C B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A21 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A26 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A2B CD40                <1>  int 40h
  1371                                  
  1372 00000A2D C3                              retn
  1373                                  
  1374                                  write_VRA_info:
  1375                                  	; 25/11/2023
  1376                                  	sys	_msg, msgVRAheader, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A2E BB[D1670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A33 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A38 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A3D B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A42 CD40                <1>  int 40h
  1377 00000A44 803D[B0680000]00        	cmp	byte [VRA], 0
  1378 00000A4B 7617                    	jna	short _w_VRAi_no
  1379                                  _w_VRAi_yes:
  1380                                  	sys	_msg, msgVRAyes, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A4D BB[DF670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A52 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A57 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A5C B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A61 CD40                <1>  int 40h
  1381 00000A63 C3                      	retn
  1382                                  _w_VRAi_no:
  1383                                  	sys	_msg, msgVRAno, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A64 BB[E5670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A69 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A6E BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A73 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A78 CD40                <1>  int 40h
  1384 00000A7A C3                      	retn
  1385                                  
  1386                                  ; 09/12/2023
  1387                                  ; --------------------------------------------------------
  1388                                  ; 'playwav6.s' (27/11/2023)
  1389                                  
  1390                                  ; 26/11/2023
  1391                                  ; 25/11/2023 - playwav6.s (32 bit registers, TRDOS 386 adaption)
  1392                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  1393                                  ; 14/11/2023
  1394                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1395                                  ; --------------------------------------------------------
  1396                                  
  1397                                  ;;Note:	At the end of every buffer load,
  1398                                  ;;	during buffer switch/swap, there will be discontinuity
  1399                                  ;;	between the last converted sample and the 1st sample
  1400                                  ;;	of the next buffer.
  1401                                  ;;	(like as a dot noises vaguely between normal sound samples)
  1402                                  ;;	-To avoid this defect, the 1st sample of
  1403                                  ;;	the next buffer may be read from the wav file but
  1404                                  ;;	the file pointer would need to be set to 1 sample back
  1405                                  ;;	again via seek system call. Time comsumption problem! -
  1406                                  ;;
  1407                                  ;;	Erdogan Tan - 15/11/2023
  1408                                  ;;
  1409                                  ;;	((If entire wav data would be loaded at once.. conversion
  1410                                  ;;	defect/noise would disappear.. but for DOS, to keep
  1411                                  ;;	64KB buffer limit is important also it is important
  1412                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1413                                  ;;	I have tested this program by using 2-30MB wav files.))
  1414                                  ;;
  1415                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1416                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1417                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1418                                  ;;			Realtek ALC850 codec.
  1419                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1420                                  
  1421                                  load_8khz_mono_8_bit:
  1422                                  	; 15/11/2023
  1423                                  	; 14/11/2023
  1424                                  	; 13/11/2023
  1425 00000A7B F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1426                                  					; last of the file?
  1427 00000A82 7402                    	jz	short lff8m_0		; no
  1428 00000A84 F9                      	stc
  1429 00000A85 C3                      	retn
  1430                                  
  1431                                  lff8m_0:
  1432 00000A86 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1433                                          ;mov	edx, [loadsize]
  1434                                  
  1435                                  	; esi = buffer address
  1436                                  	;; edx = buffer size
  1437                                  
  1438                                  	; load file into memory
  1439                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A8B 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A91 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A93 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A99 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A9E CD40                <1>  int 40h
  1440 00000AA0 7305                    	jnc	short lff8m_6
  1441 00000AA2 E9AF000000              	jmp	lff8m_5  ; error !
  1442                                  
  1443                                  lff8m_6:
  1444 00000AA7 BF[00800000]            	mov	edi, audio_buffer
  1445 00000AAC 21C0                    	and	eax, eax
  1446 00000AAE 0F8499000000            	jz	lff8_eof
  1447                                  
  1448 00000AB4 89C1                    	mov	ecx, eax		; byte count
  1449                                  lff8m_1:
  1450 00000AB6 AC                      	lodsb
  1451 00000AB7 A2[BD200000]            	mov	[previous_val], al
  1452 00000ABC 2C80                    	sub	al, 80h
  1453 00000ABE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1454 00000AC2 66AB                    	stosw		; original sample (left channel)
  1455 00000AC4 66AB                    	stosw		; original sample (right channel)
  1456                                  	;xor	eax, eax
  1457 00000AC6 B080                    	mov	al, 80h
  1458 00000AC8 49                      	dec	ecx
  1459 00000AC9 7402                    	jz	short lff8m_2
  1460 00000ACB 8A06                    	mov	al, [esi]
  1461                                  lff8m_2:
  1462                                  	;mov	[next_val], ax
  1463 00000ACD 88C7                    	mov	bh, al	; [next_val]
  1464 00000ACF 8A25[BD200000]          	mov	ah, [previous_val]
  1465 00000AD5 00E0                    	add	al, ah	; [previous_val]
  1466 00000AD7 D0D8                    	rcr	al, 1
  1467 00000AD9 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  1468 00000ADB 00E0                    	add	al, ah	; [previous_val]
  1469 00000ADD D0D8                    	rcr	al, 1	
  1470 00000ADF 88C3                    	mov	bl, al 	; this is temporary interpolation value	
  1471 00000AE1 00E0                    	add	al, ah	; [previous_val]
  1472 00000AE3 D0D8                    	rcr	al, 1
  1473 00000AE5 2C80                    	sub	al, 80h
  1474 00000AE7 66C1E008                	shl	ax, 8	
  1475 00000AEB 66AB                    	stosw		; this is 1st interpolated sample (L)
  1476 00000AED 66AB                    	stosw		; this is 1st interpolated sample (R)
  1477 00000AEF 88D8                    	mov	al, bl
  1478 00000AF1 00D0                    	add	al, dl
  1479 00000AF3 D0D8                    	rcr	al, 1
  1480 00000AF5 2C80                    	sub	al, 80h
  1481 00000AF7 66C1E008                	shl	ax, 8
  1482 00000AFB 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1483 00000AFD 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1484 00000AFF 88D0                    	mov	al, dl
  1485 00000B01 2C80                    	sub	al, 80h
  1486 00000B03 66C1E008                	shl	ax, 8
  1487 00000B07 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1488 00000B09 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1489                                  	;mov	al, [next_val]
  1490 00000B0B 88F8                    	mov	al, bh
  1491 00000B0D 00D0                    	add	al, dl
  1492 00000B0F D0D8                    	rcr	al, 1
  1493 00000B11 88C3                    	mov	bl, al	; this is temporary interpolation value
  1494 00000B13 00D0                    	add	al, dl
  1495 00000B15 D0D8                    	rcr	al, 1
  1496 00000B17 2C80                    	sub	al, 80h
  1497 00000B19 66C1E008                	shl	ax, 8
  1498 00000B1D 66AB                    	stosw		; this is 4th interpolated sample (L)
  1499 00000B1F 66AB                    	stosw		; this is 4th interpolated sample (R)
  1500                                  	;mov	al, [next_val]
  1501 00000B21 88F8                    	mov	al, bh
  1502 00000B23 00D8                    	add	al, bl
  1503 00000B25 D0D8                    	rcr	al, 1
  1504 00000B27 2C80                    	sub	al, 80h
  1505 00000B29 66C1E008                	shl	ax, 8
  1506 00000B2D 66AB                    	stosw		; this is 5th interpolated sample (L)
  1507 00000B2F 66AB                    	stosw		; this is 5th interpolated sample (R)
  1508                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1509 00000B31 09C9                    	or	ecx, ecx
  1510 00000B33 7581                    	jnz	short lff8m_1
  1511                                  
  1512                                  	; --------------
  1513                                  
  1514                                  lff8s_3:
  1515                                  lff8m_3:
  1516                                  lff8s2_3:
  1517                                  lff8m2_3:
  1518                                  lff16s_3:
  1519                                  lff16m_3:
  1520                                  lff16s2_3:
  1521                                  lff16m2_3:
  1522                                  lff24_3:
  1523                                  lff32_3:
  1524                                  lff44_3:
  1525                                  lff22_3:
  1526                                  lff11_3:
  1527                                  	; 08/12/2024 (BugFix)
  1528 00000B35 8B0D[E1030000]          	mov	ecx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1529                                  	;shl	ecx, 1	; byte count ; Bug !
  1530                                  	; 08/12/2024
  1531 00000B3B 81C1[00800000]          	add	ecx, audio_buffer
  1532 00000B41 29F9                    	sub	ecx, edi
  1533 00000B43 7607                    	jna	short lff8m_4
  1534                                  	;inc	ecx
  1535 00000B45 C1E902                  	shr	ecx, 2
  1536 00000B48 31C0                    	xor	eax, eax ; fill (remain part of) buffer with zeros
  1537 00000B4A F3AB                    	rep	stosd
  1538                                  lff8m_4:
  1539                                  	; 08/12/2024 (BugFix)
  1540                                  	; cf=1 ; Bug !
  1541                                  	;clc
  1542 00000B4C C3                      	retn
  1543                                  
  1544                                  lff8_eof:
  1545                                  lff16_eof:
  1546                                  lff24_eof:
  1547                                  lff32_eof:
  1548                                  lff44_eof:
  1549                                  lff22_eof:
  1550                                  lff11_eof:
  1551                                  	; 15/11/2023
  1552 00000B4D C605[AC680000]01        	mov	byte [flags], ENDOFFILE
  1553 00000B54 EBDF                    	jmp	short lff8m_3
  1554                                  
  1555                                  lff8s_5:
  1556                                  lff8m_5:
  1557                                  lff8s2_5:
  1558                                  lff8m2_5:
  1559                                  lff16s_5:
  1560                                  lff16m_5:
  1561                                  lff16s2_5:
  1562                                  lff16m2_5:
  1563                                  lff24_5:
  1564                                  lff32_5:
  1565                                  lff44_5:
  1566                                  lff22_5:
  1567                                  lff11_5:
  1568                                  	; 09/12/2023	
  1569                                  	;mov	al, '!'  ; error
  1570                                  	;call	tL0
  1571                                  	
  1572                                  	;jmp	short lff8m_3
  1573                                  	; 15/11/2023
  1574 00000B56 EBF5                    	jmp	lff8_eof
  1575                                  
  1576                                  	; --------------
  1577                                  
  1578                                  load_8khz_stereo_8_bit:
  1579                                  	; 15/11/2023
  1580                                  	; 14/11/2023
  1581                                  	; 13/11/2023
  1582 00000B58 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1583                                  					; last of the file?
  1584 00000B5F 7402                    	jz	short lff8s_0		; no
  1585 00000B61 F9                      	stc
  1586 00000B62 C3                      	retn
  1587                                  
  1588                                  lff8s_0:
  1589 00000B63 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1590                                          ;mov	edx, [loadsize]
  1591                                  
  1592                                  	; esi = buffer address
  1593                                  	;; edx = buffer size
  1594                                  
  1595                                  	; load file into memory
  1596                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000B68 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000B6E 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000B70 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000B76 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000B7B CD40                <1>  int 40h
  1597 00000B7D 72D7                    	jc	short lff8s_5 ; error !
  1598                                  
  1599 00000B7F BF[00800000]            	mov	edi, audio_buffer
  1600                                  	
  1601 00000B84 D1E8                    	shr	eax, 1
  1602 00000B86 74C5                    	jz	short lff8_eof
  1603                                  
  1604 00000B88 89C1                    	mov	ecx, eax	; word count
  1605                                  lff8s_1:
  1606 00000B8A AC                      	lodsb
  1607 00000B8B A2[BD200000]            	mov	[previous_val_l], al
  1608 00000B90 2C80                    	sub	al, 80h
  1609 00000B92 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1610 00000B96 66AB                    	stosw		; original sample (L)
  1611 00000B98 AC                      	lodsb
  1612 00000B99 A2[BF200000]            	mov	[previous_val_r], al
  1613 00000B9E 2C80                    	sub	al, 80h
  1614 00000BA0 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1615 00000BA4 66AB                    	stosw		; original sample (R)
  1616                                  
  1617                                  	;xor	eax, eax
  1618 00000BA6 66B88080                	mov	ax, 8080h
  1619 00000BAA 49                      	dec	ecx
  1620 00000BAB 7403                    	jz	short lff8s_2
  1621                                  		; convert 8 bit sample to 16 bit sample
  1622 00000BAD 668B06                  	mov	ax, [esi]
  1623                                  lff8s_2:
  1624 00000BB0 A2[C1200000]            	mov	[next_val_l], al
  1625 00000BB5 8825[C3200000]          	mov	[next_val_r], ah
  1626 00000BBB 8A25[BD200000]          	mov	ah, [previous_val_l]
  1627 00000BC1 00E0                    	add	al, ah
  1628 00000BC3 D0D8                    	rcr	al, 1
  1629 00000BC5 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1630 00000BC7 00E0                    	add	al, ah
  1631 00000BC9 D0D8                    	rcr	al, 1	
  1632 00000BCB 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1633 00000BCD 00E0                    	add	al, ah
  1634 00000BCF D0D8                    	rcr	al, 1
  1635 00000BD1 2C80                    	sub	al, 80h
  1636 00000BD3 66C1E008                	shl	ax, 8
  1637 00000BD7 66AB                    	stosw		; this is 1st interpolated sample (L)
  1638 00000BD9 A0[C3200000]            	mov	al, [next_val_r]
  1639 00000BDE 8A25[BF200000]          	mov	ah, [previous_val_r]
  1640 00000BE4 00E0                    	add	al, ah
  1641 00000BE6 D0D8                    	rcr	al, 1
  1642 00000BE8 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1643 00000BEA 00E0                    	add	al, ah
  1644 00000BEC D0D8                    	rcr	al, 1
  1645 00000BEE 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1646 00000BF0 00E0                    	add	al, ah
  1647 00000BF2 D0D8                    	rcr	al, 1
  1648 00000BF4 2C80                    	sub	al, 80h
  1649 00000BF6 66C1E008                	shl	ax, 8
  1650 00000BFA 66AB                    	stosw		; this is 1st interpolated sample (R)
  1651 00000BFC 88D8                    	mov	al, bl
  1652 00000BFE 00D0                    	add	al, dl
  1653 00000C00 D0D8                    	rcr	al, 1
  1654 00000C02 2C80                    	sub	al, 80h
  1655 00000C04 66C1E008                	shl	ax, 8
  1656 00000C08 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1657 00000C0A 88F8                    	mov	al, bh
  1658 00000C0C 00F0                    	add	al, dh
  1659 00000C0E D0D8                    	rcr	al, 1
  1660 00000C10 2C80                    	sub	al, 80h
  1661 00000C12 66C1E008                	shl	ax, 8
  1662 00000C16 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1663 00000C18 88D0                    	mov	al, dl
  1664 00000C1A 2C80                    	sub	al, 80h
  1665 00000C1C 66C1E008                	shl	ax, 8
  1666 00000C20 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1667 00000C22 88F0                    	mov	al, dh
  1668 00000C24 2C80                    	sub	al, 80h
  1669 00000C26 66C1E008                	shl	ax, 8
  1670 00000C2A 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1671 00000C2C A0[C1200000]            	mov	al, [next_val_l]
  1672 00000C31 00D0                    	add	al, dl
  1673 00000C33 D0D8                    	rcr	al, 1
  1674 00000C35 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1675 00000C37 00D0                    	add	al, dl
  1676 00000C39 D0D8                    	rcr	al, 1
  1677 00000C3B 2C80                    	sub	al, 80h
  1678 00000C3D 66C1E008                	shl	ax, 8
  1679 00000C41 66AB                    	stosw		; this is 4th interpolated sample (L)
  1680 00000C43 A0[C3200000]            	mov	al, [next_val_r]
  1681 00000C48 00F0                    	add	al, dh
  1682 00000C4A D0D8                    	rcr	al, 1
  1683 00000C4C 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1684 00000C4E 00F0                    	add	al, dh
  1685 00000C50 D0D8                    	rcr	al, 1
  1686 00000C52 2C80                    	sub	al, 80h
  1687 00000C54 66C1E008                	shl	ax, 8
  1688 00000C58 66AB                    	stosw		; this is 4th interpolated sample (R)
  1689 00000C5A A0[C1200000]            	mov	al, [next_val_l]
  1690 00000C5F 00D8                    	add	al, bl
  1691 00000C61 D0D8                    	rcr	al, 1
  1692 00000C63 2C80                    	sub	al, 80h
  1693 00000C65 66C1E008                	shl	ax, 8
  1694 00000C69 66AB                    	stosw		; this is 5th interpolated sample (L)
  1695 00000C6B A0[C3200000]            	mov	al, [next_val_r]
  1696 00000C70 00F8                    	add	al, bh
  1697 00000C72 D0D8                    	rcr	al, 1
  1698 00000C74 2C80                    	sub	al, 80h
  1699 00000C76 66C1E008                	shl	ax, 8
  1700 00000C7A 66AB                    	stosw		; this is 5th interpolated sample (R)
  1701                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1702 00000C7C E305                    	jecxz	lff8s_6
  1703 00000C7E E907FFFFFF              	jmp	lff8s_1
  1704                                  lff8s_6:
  1705 00000C83 E9ADFEFFFF              	jmp	lff8s_3
  1706                                  
  1707                                  load_8khz_mono_16_bit:
  1708                                  	; 13/11/2023
  1709 00000C88 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1710                                  					; last of the file?
  1711 00000C8F 7402                    	jz	short lff8m2_0		; no
  1712 00000C91 F9                      	stc
  1713 00000C92 C3                      	retn
  1714                                  
  1715                                  lff8m2_0:
  1716 00000C93 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1717                                          ;mov	edx, [loadsize]
  1718                                  
  1719                                  	; esi = buffer address
  1720                                  	;; edx = buffer size
  1721                                  
  1722                                  	; load file into memory
  1723                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000C98 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000C9E 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000CA0 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000CA6 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000CAB CD40                <1>  int 40h
  1724 00000CAD 0F82A0000000            	jc	lff8m2_7 ; error !
  1725                                  
  1726 00000CB3 BF[00800000]            	mov	edi, audio_buffer
  1727                                  	
  1728 00000CB8 D1E8                    	shr	eax, 1
  1729 00000CBA 7505                    	jnz	short lff8m2_8
  1730 00000CBC E98CFEFFFF              	jmp	lff8_eof
  1731                                  
  1732                                  lff8m2_8:
  1733 00000CC1 89C1                    	mov	ecx, eax	; word count
  1734                                  lff8m2_1:
  1735 00000CC3 66AD                    	lodsw
  1736 00000CC5 66AB                    	stosw		; original sample (left channel)
  1737 00000CC7 66AB                    	stosw		; original sample (right channel)
  1738 00000CC9 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1739 00000CCC 66A3[BD200000]          	mov	[previous_val], ax
  1740 00000CD2 31C0                    	xor	eax, eax
  1741 00000CD4 49                      	dec	ecx
  1742 00000CD5 7403                    	jz	short lff8m2_2
  1743 00000CD7 668B06                  	mov	ax, [esi]
  1744                                  lff8m2_2:
  1745 00000CDA 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  1746 00000CDD 89C5                    	mov	ebp, eax	; [next_val]
  1747 00000CDF 660305[BD200000]        	add	ax, [previous_val]
  1748 00000CE6 66D1D8                  	rcr	ax, 1
  1749 00000CE9 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample
  1750 00000CEB 660305[BD200000]        	add	ax, [previous_val]
  1751 00000CF2 66D1D8                  	rcr	ax, 1	; this is temporary interpolation value
  1752 00000CF5 89C3                    	mov	ebx, eax 		
  1753 00000CF7 660305[BD200000]        	add	ax, [previous_val]
  1754 00000CFE 66D1D8                  	rcr	ax, 1
  1755 00000D01 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1756 00000D04 66AB                    	stosw		; this is 1st interpolated sample (L)
  1757 00000D06 66AB                    	stosw		; this is 1st interpolated sample (R)
  1758 00000D08 89D8                    	mov	eax, ebx
  1759 00000D0A 6601D0                  	add	ax, dx
  1760 00000D0D 66D1D8                  	rcr	ax, 1
  1761 00000D10 80EC80                  	sub	ah, 80h
  1762 00000D13 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1763 00000D15 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1764 00000D17 89D0                    	mov	eax, edx
  1765 00000D19 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1766 00000D1C 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1767 00000D1E 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1768 00000D20 89E8                    	mov	eax, ebp
  1769 00000D22 6601D0                  	add	ax, dx
  1770 00000D25 66D1D8                  	rcr	ax, 1
  1771 00000D28 89C3                    	mov	ebx, eax ; this is temporary interpolation value
  1772 00000D2A 6601D0                  	add	ax, dx
  1773 00000D2D 66D1D8                  	rcr	ax, 1
  1774 00000D30 80EC80                  	sub	ah, 80h
  1775 00000D33 66AB                    	stosw		; this is 4th interpolated sample (L)
  1776 00000D35 66AB                    	stosw		; this is 4th interpolated sample (R)
  1777 00000D37 89E8                    	mov	eax, ebp
  1778 00000D39 6601D8                  	add	ax, bx
  1779 00000D3C 66D1D8                  	rcr	ax, 1
  1780 00000D3F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1781 00000D42 66AB                    	stosw		; this is 5th interpolated sample (L)
  1782 00000D44 66AB                    	stosw		; this is 5th interpolated sample (R)
  1783                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1784 00000D46 09C9                    	or	ecx, ecx
  1785 00000D48 0F8575FFFFFF            	jnz	lff8m2_1
  1786 00000D4E E9E2FDFFFF              	jmp	lff8m2_3
  1787                                  
  1788                                  lff8m2_7:
  1789                                  lff8s2_7:
  1790 00000D53 E9FEFDFFFF              	jmp	lff8m2_5  ; error
  1791                                  
  1792                                  load_8khz_stereo_16_bit:
  1793                                  	; 16/11/2023
  1794                                  	; 15/11/2023
  1795                                  	; 13/11/2023
  1796 00000D58 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1797                                  					; last of the file?
  1798 00000D5F 7402                    	jz	short lff8s2_0		; no
  1799 00000D61 F9                      	stc
  1800 00000D62 C3                      	retn
  1801                                  
  1802                                  lff8s2_0:
  1803 00000D63 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1804                                          ;mov	edx, [loadsize]
  1805                                  
  1806                                  	; esi = buffer address
  1807                                  	;; edx = buffer size
  1808                                  
  1809                                  	; load file into memory
  1810                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000D68 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000D6E 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000D70 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000D76 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000D7B CD40                <1>  int 40h
  1811 00000D7D 72D4                    	jc	short lff8s2_7 ; error !
  1812                                  
  1813 00000D7F BF[00800000]            	mov	edi, audio_buffer
  1814                                  	
  1815 00000D84 C1E802                  	shr	eax, 2
  1816 00000D87 7505                    	jnz	short lff8s2_8
  1817 00000D89 E9BFFDFFFF              	jmp	lff8_eof
  1818                                  
  1819                                  lff8s2_8:
  1820 00000D8E 89C1                    	mov	ecx, eax ; dword count
  1821                                  lff8s2_1:
  1822 00000D90 66AD                    	lodsw
  1823 00000D92 66AB                    	stosw		; original sample (L)
  1824                                  	; 15/11/2023
  1825 00000D94 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1826 00000D97 66A3[BD200000]          	mov	[previous_val_l], ax
  1827 00000D9D 66AD                    	lodsw
  1828 00000D9F 66AB                    	stosw		; original sample (R)
  1829 00000DA1 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1830 00000DA4 66A3[BF200000]          	mov	[previous_val_r], ax
  1831 00000DAA 31D2                    	xor	edx, edx
  1832 00000DAC 31C0                    	xor	eax, eax
  1833                                  	; 16/11/2023
  1834 00000DAE 49                      	dec	ecx
  1835 00000DAF 7407                    	jz	short lff8s2_2
  1836 00000DB1 668B06                  	mov	ax, [esi]
  1837 00000DB4 668B5602                	mov	dx, [esi+2]
  1838                                  lff8s2_2:
  1839 00000DB8 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1840 00000DBB 66A3[C1200000]          	mov	[next_val_l], ax
  1841 00000DC1 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  1842 00000DC4 668915[C3200000]        	mov	[next_val_r], dx
  1843 00000DCB 660305[BD200000]        	add	ax, [previous_val_l]
  1844 00000DD2 66D1D8                  	rcr	ax, 1
  1845 00000DD5 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample (L)
  1846 00000DD7 660305[BD200000]        	add	ax, [previous_val_l]
  1847 00000DDE 66D1D8                  	rcr	ax, 1	
  1848 00000DE1 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1849 00000DE3 660305[BD200000]        	add	ax, [previous_val_l]
  1850 00000DEA 66D1D8                  	rcr	ax, 1
  1851 00000DED 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1852 00000DF0 66AB                    	stosw		; this is 1st interpolated sample (L)
  1853 00000DF2 66A1[C3200000]          	mov	ax, [next_val_r]
  1854 00000DF8 660305[BF200000]        	add	ax, [previous_val_r]
  1855 00000DFF 66D1D8                  	rcr	ax, 1
  1856 00000E02 89C5                    	mov	ebp, eax ; this is interpolated middle (3th) sample (R)
  1857 00000E04 660305[BF200000]        	add	ax, [previous_val_r]
  1858 00000E0B 66D1D8                  	rcr	ax, 1
  1859 00000E0E 50                      	push	eax ; *	; this is temporary interpolation value (R)
  1860 00000E0F 660305[BF200000]        	add	ax, [previous_val_r]
  1861 00000E16 66D1D8                  	rcr	ax, 1
  1862 00000E19 80EC80                  	sub	ah, 80h
  1863 00000E1C 66AB                    	stosw		; this is 1st interpolated sample (R)
  1864 00000E1E 89D8                    	mov	eax, ebx
  1865 00000E20 6601D0                  	add	ax, dx
  1866 00000E23 66D1D8                  	rcr	ax, 1
  1867 00000E26 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1868 00000E29 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1869 00000E2B 58                      	pop	eax ; *
  1870 00000E2C 6601E8                  	add	ax, bp
  1871 00000E2F 66D1D8                  	rcr	ax, 1
  1872 00000E32 80EC80                  	sub	ah, 80h
  1873 00000E35 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1874 00000E37 89D0                    	mov	eax, edx
  1875 00000E39 80EC80                  	sub	ah, 80h
  1876 00000E3C 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1877 00000E3E 89E8                    	mov	eax, ebp
  1878 00000E40 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1879 00000E43 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1880 00000E45 66A1[C1200000]          	mov	ax, [next_val_l]
  1881 00000E4B 6601D0                  	add	ax, dx
  1882 00000E4E 66D1D8                  	rcr	ax, 1
  1883 00000E51 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1884 00000E53 6601D0                  	add	ax, dx
  1885 00000E56 66D1D8                  	rcr	ax, 1
  1886 00000E59 80EC80                  	sub	ah, 80h
  1887 00000E5C 66AB                    	stosw		; this is 4th interpolated sample (L)
  1888 00000E5E 66A1[C3200000]          	mov	ax, [next_val_r]
  1889 00000E64 6601E8                  	add	ax, bp
  1890 00000E67 66D1D8                  	rcr	ax, 1
  1891 00000E6A 50                      	push	eax ; ** ; this is temporary interpolation value (R)
  1892 00000E6B 6601E8                  	add	ax, bp
  1893 00000E6E 66D1D8                  	rcr	ax, 1
  1894 00000E71 80EC80                  	sub	ah, 80h
  1895 00000E74 66AB                    	stosw		; this is 4th interpolated sample (R)
  1896 00000E76 66A1[C1200000]          	mov	ax, [next_val_l]
  1897 00000E7C 6601D8                  	add	ax, bx
  1898 00000E7F 66D1D8                  	rcr	ax, 1
  1899 00000E82 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1900 00000E85 66AB                    	stosw		; this is 5th interpolated sample (L)
  1901 00000E87 58                      	pop	eax ; **
  1902 00000E88 660305[C3200000]        	add	ax, [next_val_r]
  1903 00000E8F 66D1D8                  	rcr	ax, 1
  1904 00000E92 80EC80                  	sub	ah, 80h
  1905 00000E95 66AB                    	stosw		; this is 5th interpolated sample (R)
  1906                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1907 00000E97 E305                    	jecxz	lff8_s2_9
  1908 00000E99 E9F2FEFFFF              	jmp	lff8s2_1
  1909                                  lff8_s2_9:
  1910 00000E9E E992FCFFFF              	jmp	lff8s2_3
  1911                                  
  1912                                  ; .....................
  1913                                  
  1914                                  load_16khz_mono_8_bit:
  1915                                  	; 14/11/2023
  1916                                  	; 13/11/2023
  1917 00000EA3 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1918                                  					; last of the file?
  1919 00000EAA 7402                    	jz	short lff16m_0		; no
  1920 00000EAC F9                      	stc
  1921 00000EAD C3                      	retn
  1922                                  
  1923                                  lff16m_0:
  1924 00000EAE BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1925                                          ;mov	edx, [loadsize]
  1926                                  
  1927                                  	; esi = buffer address
  1928                                  	;; edx = buffer size
  1929                                  
  1930                                  	; load file into memory
  1931                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000EB3 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000EB9 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000EBB 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000EC1 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000EC6 CD40                <1>  int 40h
  1932 00000EC8 7253                    	jc	short lff16m_7 ; error !
  1933                                  
  1934 00000ECA BF[00800000]            	mov	edi, audio_buffer
  1935                                  	
  1936 00000ECF 21C0                    	and	eax, eax
  1937 00000ED1 7505                    	jnz	short lff16m_8
  1938 00000ED3 E975FCFFFF              	jmp	lff16_eof
  1939                                  
  1940                                  lff16m_8:
  1941 00000ED8 89C1                    	mov	ecx, eax		; byte count
  1942                                  lff16m_1:
  1943 00000EDA AC                      	lodsb
  1944                                  	;mov	[previous_val], al
  1945 00000EDB 88C3                    	mov	bl, al
  1946 00000EDD 2C80                    	sub	al, 80h
  1947 00000EDF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1948 00000EE3 66AB                    	stosw		; original sample (left channel)
  1949 00000EE5 66AB                    	stosw		; original sample (right channel)
  1950                                  	;xor	ax, ax
  1951                                  	; 14/11/22023
  1952 00000EE7 B080                    	mov	al, 80h
  1953 00000EE9 49                      	dec	ecx
  1954 00000EEA 7402                    	jz	short lff16m_2
  1955 00000EEC 8A06                    	mov	al, [esi]
  1956                                  lff16m_2:
  1957                                  	;mov	[next_val], al
  1958 00000EEE 88C7                    	mov	bh, al
  1959                                  	;add	al, [previous_val]
  1960 00000EF0 00D8                    	add	al, bl
  1961 00000EF2 D0D8                    	rcr	al, 1
  1962 00000EF4 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  1963                                  	;add	al, [previous_val]
  1964 00000EF6 00D8                    	add	al, bl
  1965 00000EF8 D0D8                    	rcr	al, 1
  1966 00000EFA 2C80                    	sub	al, 80h
  1967 00000EFC 66C1E008                	shl	ax, 8
  1968 00000F00 66AB                    	stosw		; this is 1st interpolated sample (L)
  1969 00000F02 66AB                    	stosw		; this is 1st interpolated sample (R)
  1970                                  	;mov	al, [next_val]
  1971 00000F04 88F8                    	mov	al, bh
  1972 00000F06 00D0                    	add	al, dl
  1973 00000F08 D0D8                    	rcr	al, 1
  1974 00000F0A 2C80                    	sub	al, 80h
  1975 00000F0C 66C1E008                	shl	ax, 8
  1976 00000F10 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1977 00000F12 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1978                                  	
  1979                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1980 00000F14 09C9                    	or	ecx, ecx
  1981 00000F16 75C2                    	jnz	short lff16m_1
  1982 00000F18 E918FCFFFF              	jmp	lff16m_3
  1983                                  
  1984                                  lff16m_7:
  1985                                  lff16s_7:
  1986 00000F1D E934FCFFFF              	jmp	lff16m_5  ; error
  1987                                  
  1988                                  load_16khz_stereo_8_bit:
  1989                                  	; 14/11/2023
  1990                                  	; 13/11/2023
  1991 00000F22 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1992                                  					; last of the file?
  1993 00000F29 7402                    	jz	short lff16s_0		; no
  1994 00000F2B F9                      	stc
  1995 00000F2C C3                      	retn
  1996                                  
  1997                                  lff16s_0:
  1998 00000F2D BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1999                                          ;mov	edx, [loadsize]
  2000                                  
  2001                                  	; esi = buffer address
  2002                                  	;; edx = buffer size
  2003                                  
  2004                                  	; load file into memory
  2005                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000F32 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000F38 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000F3A 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000F40 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000F45 CD40                <1>  int 40h
  2006 00000F47 72D4                    	jc	short lff16s_7 ; error !
  2007                                  
  2008 00000F49 BF[00800000]            	mov	edi, audio_buffer
  2009                                  	
  2010 00000F4E D1E8                    	shr	eax, 1
  2011 00000F50 7505                    	jnz	short lff16s_8
  2012 00000F52 E9F6FBFFFF              	jmp	lff16_eof
  2013                                  
  2014                                  lff16s_8:
  2015 00000F57 89C1                    	mov	ecx, eax	; word count
  2016                                  lff16s_1:
  2017 00000F59 AC                      	lodsb
  2018 00000F5A A2[BD200000]            	mov	[previous_val_l], al
  2019 00000F5F 2C80                    	sub	al, 80h
  2020 00000F61 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2021 00000F65 66AB                    	stosw		; original sample (L)
  2022 00000F67 AC                      	lodsb
  2023 00000F68 A2[BF200000]            	mov	[previous_val_r], al
  2024 00000F6D 2C80                    	sub	al, 80h
  2025 00000F6F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2026 00000F73 66AB                    	stosw		; original sample (R)
  2027                                  
  2028                                  	;xor	eax, eax
  2029 00000F75 66B88080                	mov	ax, 8080h
  2030 00000F79 49                      	dec	ecx
  2031 00000F7A 7403                    	jz	short lff16s_2
  2032                                  		; convert 8 bit sample to 16 bit sample
  2033 00000F7C 668B06                  	mov	ax, [esi]
  2034                                  lff16s_2:
  2035                                  	;mov	[next_val_l], al
  2036                                  	;mov	[next_val_r], ah
  2037 00000F7F 89C3                    	mov	ebx, eax
  2038 00000F81 0205[BD200000]          	add	al, [previous_val_l]
  2039 00000F87 D0D8                    	rcr	al, 1
  2040 00000F89 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  2041 00000F8B 0205[BD200000]          	add	al, [previous_val_l]
  2042 00000F91 D0D8                    	rcr	al, 1
  2043 00000F93 2C80                    	sub	al, 80h
  2044 00000F95 66C1E008                	shl	ax, 8
  2045 00000F99 66AB                    	stosw		; this is 1st interpolated sample (L)
  2046 00000F9B 88F8                    	mov	al, bh	; [next_val_r]
  2047 00000F9D 0205[BF200000]          	add	al, [previous_val_r]
  2048 00000FA3 D0D8                    	rcr	al, 1
  2049 00000FA5 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  2050 00000FA7 0205[BF200000]          	add	al, [previous_val_r]
  2051 00000FAD D0D8                    	rcr	al, 1
  2052 00000FAF 2C80                    	sub	al, 80h
  2053 00000FB1 66C1E008                	shl	ax, 8
  2054 00000FB5 66AB                    	stosw		; this is 1st interpolated sample (R)
  2055 00000FB7 88D0                    	mov	al, dl
  2056 00000FB9 00D8                    	add	al, bl	; [next_val_l]
  2057 00000FBB D0D8                    	rcr	al, 1
  2058 00000FBD 2C80                    	sub	al, 80h
  2059 00000FBF 66C1E008                	shl	ax, 8
  2060 00000FC3 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2061 00000FC5 88F0                    	mov	al, dh
  2062 00000FC7 00F8                    	add	al, bh	; [next_val_r]
  2063 00000FC9 D0D8                    	rcr	al, 1
  2064 00000FCB 2C80                    	sub	al, 80h
  2065 00000FCD 66C1E008                	shl	ax, 8
  2066 00000FD1 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  2067                                  	
  2068                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2069 00000FD3 09C9                    	or	ecx, ecx
  2070 00000FD5 7582                    	jnz	short lff16s_1
  2071 00000FD7 E959FBFFFF              	jmp	lff16s_3
  2072                                  
  2073                                  load_16khz_mono_16_bit:
  2074                                  	; 15/11/2023
  2075                                  	; 13/11/2023
  2076 00000FDC F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2077                                  					; last of the file?
  2078 00000FE3 7402                    	jz	short lff16m2_0		; no
  2079 00000FE5 F9                      	stc
  2080 00000FE6 C3                      	retn
  2081                                  
  2082                                  lff16m2_0:
  2083 00000FE7 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2084                                          ;mov	edx, [loadsize]
  2085                                  
  2086                                  	; esi = buffer address
  2087                                  	;; edx = buffer size
  2088                                  
  2089                                  	; load file into memory
  2090                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000FEC 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000FF2 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000FF4 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000FFA B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000FFF CD40                <1>  int 40h
  2091 00001001 7255                    	jc	short lff16m2_7 ; error !
  2092                                  
  2093 00001003 BF[00800000]            	mov	edi, audio_buffer
  2094                                  	
  2095 00001008 D1E8                    	shr	eax, 1
  2096 0000100A 7505                    	jnz	short lff16m2_8
  2097 0000100C E93CFBFFFF              	jmp	lff16_eof
  2098                                  
  2099                                  lff16m2_8:
  2100 00001011 89C1                    	mov	ecx, eax  ; word count
  2101                                  lff16m2_1:
  2102 00001013 66AD                    	lodsw
  2103 00001015 66AB                    	stosw		; original sample (left channel)
  2104 00001017 66AB                    	stosw		; original sample (right channel)
  2105 00001019 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2106                                  	;mov	[previous_val], ax
  2107 0000101C 89C3                    	mov	ebx, eax	
  2108 0000101E 31C0                    	xor	eax, eax
  2109 00001020 49                      	dec	ecx
  2110 00001021 7403                    	jz	short lff16m2_2
  2111 00001023 668B06                  	mov	ax, [esi]
  2112                                  lff16m2_2:
  2113 00001026 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2114 00001029 89C5                    	mov	ebp, eax	; [next_val]
  2115                                  	;add	ax, [previous_val]
  2116 0000102B 6601D8                  	add	ax, bx
  2117 0000102E 66D1D8                  	rcr	ax, 1
  2118 00001031 89C2                    	mov	edx, eax ; this is temporary interpolation value
  2119                                  	;add	ax, [previous_val]
  2120 00001033 6601D8                  	add	ax, bx
  2121 00001036 66D1D8                  	rcr	ax, 1
  2122 00001039 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2123 0000103C 66AB                    	stosw		; this is 1st interpolated sample (L)
  2124 0000103E 66AB                    	stosw		; this is 1st interpolated sample (R)
  2125 00001040 89E8                    	mov	eax, ebp 
  2126 00001042 6601D0                  	add	ax, dx
  2127 00001045 66D1D8                  	rcr	ax, 1
  2128 00001048 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2129 0000104B 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2130 0000104D 66AB                    	stosw		; this is 2nd interpolated sample (R)
  2131                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2132 0000104F 09C9                    	or	ecx, ecx
  2133 00001051 75C0                    	jnz	short lff16m2_1
  2134 00001053 E9DDFAFFFF              	jmp	lff16m2_3
  2135                                  
  2136                                  lff16m2_7:
  2137                                  lff16s2_7:
  2138 00001058 E9F9FAFFFF              	jmp	lff16m2_5  ; error
  2139                                  
  2140                                  load_16khz_stereo_16_bit:
  2141                                  	; 16/11/2023
  2142                                  	; 15/11/2023
  2143                                  	; 13/11/2023
  2144 0000105D F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2145                                  					; last of the file?
  2146 00001064 7402                    	jz	short lff16s2_0		; no
  2147 00001066 F9                      	stc
  2148 00001067 C3                      	retn
  2149                                  
  2150                                  lff16s2_0:
  2151 00001068 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2152                                          ;mov	edx, [loadsize]
  2153                                  
  2154                                  	; esi = buffer address
  2155                                  	;; edx = buffer size
  2156                                  
  2157                                  	; load file into memory
  2158                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000106D 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001073 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001075 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000107B B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001080 CD40                <1>  int 40h
  2159 00001082 72D4                    	jc	short lff16s2_7 ; error !
  2160                                  
  2161 00001084 BF[00800000]            	mov	edi, audio_buffer
  2162                                  	
  2163 00001089 C1E802                  	shr	eax, 2
  2164 0000108C 7505                    	jnz	short lff16s2_8
  2165 0000108E E9BAFAFFFF              	jmp	lff16_eof
  2166                                  
  2167                                  lff16s2_8:
  2168 00001093 89C1                    	mov	ecx, eax  ; dword count
  2169                                  lff16s2_1:
  2170 00001095 66AD                    	lodsw
  2171 00001097 66AB                    	stosw		; original sample (L)
  2172 00001099 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2173 0000109C 66A3[BD200000]          	mov	[previous_val_l], ax
  2174 000010A2 66AD                    	lodsw
  2175 000010A4 66AB                    	stosw		; original sample (R)
  2176 000010A6 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2177 000010A9 66A3[BF200000]          	mov	[previous_val_r], ax
  2178 000010AF 31D2                    	xor	edx, edx
  2179 000010B1 31C0                    	xor	eax, eax
  2180                                  	; 16/11/2023
  2181 000010B3 49                      	dec	ecx
  2182 000010B4 7407                    	jz	short lff16s2_2
  2183 000010B6 668B06                  	mov	ax, [esi]
  2184 000010B9 668B5602                	mov	dx, [esi+2]
  2185                                  lff16s2_2:
  2186 000010BD 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2187                                  	;mov	[next_val_l], ax
  2188 000010C0 89C5                    	mov	ebp, eax
  2189 000010C2 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2190 000010C5 668915[C3200000]        	mov	[next_val_r], dx
  2191 000010CC 660305[BD200000]        	add	ax, [previous_val_l]
  2192 000010D3 66D1D8                  	rcr	ax, 1
  2193 000010D6 89C2                    	mov	edx, eax ; this is temporary interpolation value (L)
  2194 000010D8 660305[BD200000]        	add	ax, [previous_val_l]
  2195 000010DF 66D1D8                  	rcr	ax, 1
  2196 000010E2 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2197 000010E5 66AB                    	stosw		; this is 1st interpolated sample (L)
  2198 000010E7 66A1[C3200000]          	mov	ax, [next_val_r]
  2199 000010ED 660305[BF200000]        	add	ax, [previous_val_r]
  2200 000010F4 66D1D8                  	rcr	ax, 1
  2201 000010F7 89C3                    	mov	ebx, eax ; this is temporary interpolation value (R)
  2202 000010F9 660305[BF200000]        	add	ax, [previous_val_r]
  2203 00001100 66D1D8                  	rcr	ax, 1
  2204 00001103 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2205 00001106 66AB                    	stosw		; this is 1st interpolated sample (R)
  2206                                  	;mov	ax, [next_val_l]
  2207 00001108 89E8                    	mov	eax, ebp
  2208 0000110A 6601D0                  	add	ax, dx
  2209 0000110D 66D1D8                  	rcr	ax, 1
  2210 00001110 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2211 00001113 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2212 00001115 66A1[C3200000]          	mov	ax, [next_val_r]
  2213 0000111B 6601D8                  	add	ax, bx
  2214 0000111E 66D1D8                  	rcr	ax, 1
  2215 00001121 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2216 00001124 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  2217                                  	
  2218                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2219 00001126 09C9                    	or	ecx, ecx
  2220 00001128 0F8567FFFFFF            	jnz	lff16s2_1
  2221 0000112E E902FAFFFF              	jmp	lff16s2_3
  2222                                  
  2223                                  ; .....................
  2224                                  
  2225                                  load_24khz_mono_8_bit:
  2226                                  	; 15/11/2023
  2227 00001133 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2228                                  					; last of the file?
  2229 0000113A 7402                    	jz	short lff24m_0		; no
  2230 0000113C F9                      	stc
  2231 0000113D C3                      	retn
  2232                                  
  2233                                  lff24m_0:
  2234 0000113E BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2235                                          ;mov	edx, [loadsize]
  2236                                  
  2237                                  	; esi = buffer address
  2238                                  	;; edx = buffer size
  2239                                  
  2240                                  	; load file into memory
  2241                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001143 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001149 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000114B 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001151 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001156 CD40                <1>  int 40h
  2242 00001158 723B                    	jc	short lff24m_7 ; error !
  2243                                  
  2244 0000115A BF[00800000]            	mov	edi, audio_buffer
  2245                                  	
  2246 0000115F 21C0                    	and	eax, eax
  2247 00001161 7505                    	jnz	short lff24m_8
  2248 00001163 E9E5F9FFFF              	jmp	lff24_eof
  2249                                  
  2250                                  lff24m_8:
  2251 00001168 89C1                    	mov	ecx, eax	; byte count
  2252                                  lff24m_1:
  2253 0000116A AC                      	lodsb
  2254                                  	;mov	[previous_val], al
  2255 0000116B 88C3                    	mov	bl, al
  2256 0000116D 2C80                    	sub	al, 80h
  2257 0000116F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2258 00001173 66AB                    	stosw		; original sample (left channel)
  2259 00001175 66AB                    	stosw		; original sample (right channel)
  2260                                  	;xor	eax, eax
  2261 00001177 B080                    	mov	al, 80h
  2262 00001179 49                      	dec	ecx
  2263 0000117A 7402                    	jz	short lff24m_2
  2264 0000117C 8A06                    	mov	al, [esi]
  2265                                  lff24m_2:
  2266                                  	;;mov	[next_val], al
  2267                                  	;mov	bh, al
  2268                                  	;add	al, [previous_val]
  2269 0000117E 00D8                    	add	al, bl
  2270 00001180 D0D8                    	rcr	al, 1
  2271 00001182 2C80                    	sub	al, 80h
  2272 00001184 66C1E008                	shl	ax, 8
  2273 00001188 66AB                    	stosw		; this is interpolated sample (L)
  2274 0000118A 66AB                    	stosw		; this is interpolated sample (R)
  2275                                  	
  2276                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2277 0000118C 09C9                    	or	ecx, ecx
  2278 0000118E 75DA                    	jnz	short lff24m_1
  2279 00001190 E9A0F9FFFF              	jmp	lff24_3
  2280                                  
  2281                                  lff24m_7:
  2282                                  lff24s_7:
  2283 00001195 E9BCF9FFFF              	jmp	lff24_5  ; error
  2284                                  
  2285                                  load_24khz_stereo_8_bit:
  2286                                  	; 15/11/2023
  2287 0000119A F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2288                                  					; last of the file?
  2289 000011A1 7402                    	jz	short lff24s_0		; no
  2290 000011A3 F9                      	stc
  2291 000011A4 C3                      	retn
  2292                                  
  2293                                  lff24s_0:
  2294 000011A5 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2295                                          ;mov	edx, [loadsize]
  2296                                  
  2297                                  	; esi = buffer address
  2298                                  	;; edx = buffer size
  2299                                  
  2300                                  	; load file into memory
  2301                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000011AA 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000011B0 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000011B2 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000011B8 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000011BD CD40                <1>  int 40h
  2302 000011BF 72D4                    	jc	short lff24s_7 ; error !
  2303                                  
  2304 000011C1 BF[00800000]            	mov	edi, audio_buffer
  2305                                  	
  2306 000011C6 D1E8                    	shr	eax, 1
  2307 000011C8 7505                    	jnz	short lff24s_8
  2308 000011CA E97EF9FFFF              	jmp	lff24_eof
  2309                                  
  2310                                  lff24s_8:
  2311 000011CF 89C1                    	mov	ecx, eax  ; word count
  2312                                  lff24s_1:
  2313 000011D1 AC                      	lodsb
  2314 000011D2 A2[BD200000]            	mov	[previous_val_l], al
  2315 000011D7 2C80                    	sub	al, 80h
  2316 000011D9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2317 000011DD 66AB                    	stosw		; original sample (L)
  2318 000011DF AC                      	lodsb
  2319 000011E0 A2[BF200000]            	mov	[previous_val_r], al
  2320 000011E5 2C80                    	sub	al, 80h
  2321 000011E7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2322 000011EB 66AB                    	stosw		; original sample (R)
  2323                                  
  2324                                  	;xor	eax, eax
  2325 000011ED 66B88080                	mov	ax, 8080h
  2326 000011F1 49                      	dec	ecx
  2327 000011F2 7403                    	jz	short lff24s_2
  2328                                  		; convert 8 bit sample to 16 bit sample
  2329 000011F4 668B06                  	mov	ax, [esi]
  2330                                  lff24s_2:
  2331                                  	;;mov	[next_val_l], al
  2332                                  	;;mov	[next_val_r], ah
  2333                                  	;mov	bx, ax
  2334 000011F7 88E7                    	mov	bh, ah
  2335 000011F9 0205[BD200000]          	add	al, [previous_val_l]
  2336 000011FF D0D8                    	rcr	al, 1
  2337                                  	;mov	dl, al
  2338 00001201 2C80                    	sub	al, 80h
  2339 00001203 66C1E008                	shl	ax, 8
  2340 00001207 66AB                    	stosw		; this is interpolated sample (L)
  2341 00001209 88F8                    	mov	al, bh	; [next_val_r]
  2342 0000120B 0205[BF200000]          	add	al, [previous_val_r]
  2343 00001211 D0D8                    	rcr	al, 1
  2344                                  	;mov	dh, al
  2345 00001213 2C80                    	sub	al, 80h
  2346 00001215 66C1E008                	shl	ax, 8
  2347 00001219 66AB                    	stosw		; this is interpolated sample (R)
  2348                                  		
  2349                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2350 0000121B 09C9                    	or	ecx, ecx
  2351 0000121D 75B2                    	jnz	short lff24s_1
  2352 0000121F E911F9FFFF              	jmp	lff24_3
  2353                                  
  2354                                  load_24khz_mono_16_bit:
  2355                                  	; 15/11/2023
  2356 00001224 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2357                                  					; last of the file?
  2358 0000122B 7402                    	jz	short lff24m2_0		; no
  2359 0000122D F9                      	stc
  2360 0000122E C3                      	retn
  2361                                  
  2362                                  lff24m2_0:
  2363 0000122F BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2364                                          ;mov	edx, [loadsize]
  2365                                  
  2366                                  	; esi = buffer address
  2367                                  	;; edx = buffer size
  2368                                  
  2369                                  	; load file into memory
  2370                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001234 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000123A 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000123C 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001242 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001247 CD40                <1>  int 40h
  2371 00001249 7237                    	jc	short lff24m2_7 ; error !
  2372                                  
  2373 0000124B BF[00800000]            	mov	edi, audio_buffer
  2374                                  	
  2375 00001250 D1E8                    	shr	eax, 1
  2376 00001252 7505                    	jnz	short lff24m2_8
  2377 00001254 E9F4F8FFFF              	jmp	lff24_eof
  2378                                  
  2379                                  lff24m2_8:
  2380 00001259 89C1                    	mov	ecx, eax  ; word count
  2381                                  lff24m2_1:
  2382 0000125B 66AD                    	lodsw
  2383 0000125D 66AB                    	stosw		; original sample (left channel)
  2384 0000125F 66AB                    	stosw		; original sample (right channel)
  2385 00001261 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2386                                  	;mov	[previous_val], ax
  2387                                  	;mov	ebx, eax	
  2388                                  	;xor	eax, eax
  2389 00001264 31DB                    	xor	ebx, ebx
  2390 00001266 49                      	dec	ecx
  2391 00001267 7403                    	jz	short lff24m2_2
  2392                                  	;mov	ax, [esi]
  2393 00001269 668B1E                  	mov	bx, [esi]
  2394                                  lff24m2_2:
  2395                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2396                                  	;mov	ebp, eax	; [next_val]
  2397                                  	;add	ax, [previous_val]
  2398                                  	; ax = [previous_val]
  2399                                  	; bx = [next_val]
  2400 0000126C 6601D8                  	add	ax, bx
  2401 0000126F 66D1D8                  	rcr	ax, 1
  2402 00001272 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2403 00001275 66AB                    	stosw		; this is interpolated sample (L)
  2404 00001277 66AB                    	stosw		; this is interpolated sample (R)
  2405                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2406 00001279 09C9                    	or	ecx, ecx
  2407 0000127B 75DE                    	jnz	short lff24m2_1
  2408 0000127D E9B3F8FFFF              	jmp	lff24_3
  2409                                  
  2410                                  lff24m2_7:
  2411                                  lff24s2_7:
  2412 00001282 E9CFF8FFFF              	jmp	lff24_5  ; error
  2413                                  
  2414                                  load_24khz_stereo_16_bit:
  2415                                  	; 16/11/2023
  2416                                  	; 15/11/2023
  2417 00001287 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2418                                  					; last of the file?
  2419 0000128E 7402                    	jz	short lff24s2_0		; no
  2420 00001290 F9                      	stc
  2421 00001291 C3                      	retn
  2422                                  
  2423                                  lff24s2_0:
  2424 00001292 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2425                                          ;mov	edx, [loadsize]
  2426                                  
  2427                                  	; esi = buffer address
  2428                                  	;; edx = buffer size
  2429                                  
  2430                                  	; load file into memory
  2431                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001297 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000129D 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000129F 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000012A5 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000012AA CD40                <1>  int 40h
  2432 000012AC 72D4                    	jc	short lff24s2_7 ; error !
  2433                                  
  2434 000012AE BF[00800000]            	mov	edi, audio_buffer
  2435                                  	
  2436 000012B3 C1E802                  	shr	eax, 2
  2437 000012B6 7505                    	jnz	short lff24s2_8
  2438 000012B8 E990F8FFFF              	jmp	lff24_eof
  2439                                  
  2440                                  lff24s2_8:
  2441 000012BD 89C1                    	mov	ecx, eax  ; dword count
  2442                                  lff24s2_1:
  2443 000012BF 66AD                    	lodsw
  2444 000012C1 66AB                    	stosw		; original sample (L)
  2445 000012C3 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2446 000012C6 66A3[BD200000]          	mov	[previous_val_l], ax
  2447 000012CC 66AD                    	lodsw
  2448 000012CE 66AB                    	stosw		; original sample (R)
  2449 000012D0 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2450                                  	;mov	[previous_val_r], ax
  2451 000012D3 89C3                    	mov	ebx, eax
  2452 000012D5 31D2                    	xor	edx, edx
  2453 000012D7 31C0                    	xor	eax, eax
  2454                                  	; 16/11/2023
  2455 000012D9 49                      	dec	ecx
  2456 000012DA 7407                    	jz	short lff24s2_2
  2457 000012DC 668B06                  	mov	ax, [esi]
  2458 000012DF 668B5602                	mov	dx, [esi+2]
  2459                                  lff24s2_2:
  2460 000012E3 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2461                                  	;;mov	[next_val_l], ax
  2462                                  	;mov	ebp, eax
  2463 000012E6 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2464                                  	;mov	[next_val_r], dx
  2465 000012E9 660305[BD200000]        	add	ax, [previous_val_l]
  2466 000012F0 66D1D8                  	rcr	ax, 1
  2467 000012F3 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2468 000012F6 66AB                    	stosw		; this is interpolated sample (L)
  2469                                  	;mov	ax, [next_val_r]
  2470 000012F8 89D0                    	mov	eax, edx
  2471                                  	;add	ax, [previous_val_r]
  2472 000012FA 6601D8                  	add	ax, bx
  2473 000012FD 66D1D8                  	rcr	ax, 1
  2474 00001300 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2475 00001303 66AB                    	stosw		; this is interpolated sample (R)
  2476                                  	
  2477                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2478 00001305 09C9                    	or	ecx, ecx
  2479 00001307 75B6                    	jnz	short lff24s2_1
  2480 00001309 E927F8FFFF              	jmp	lff24_3
  2481                                  
  2482                                  ; .....................
  2483                                  
  2484                                  load_32khz_mono_8_bit:
  2485                                  	; 15/11/2023
  2486 0000130E F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2487                                  					; last of the file?
  2488 00001315 7402                    	jz	short lff32m_0		; no
  2489 00001317 F9                      	stc
  2490 00001318 C3                      	retn
  2491                                  
  2492                                  lff32m_0:
  2493 00001319 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2494                                          ;mov	edx, [loadsize]
  2495                                  
  2496                                  	; esi = buffer address
  2497                                  	;; edx = buffer size
  2498                                  
  2499                                  	; load file into memory
  2500                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000131E 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001324 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001326 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000132C B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001331 CD40                <1>  int 40h
  2501 00001333 7247                    	jc	short lff32m_7 ; error !
  2502                                  
  2503 00001335 BF[00800000]            	mov	edi, audio_buffer
  2504                                  	
  2505 0000133A 21C0                    	and	eax, eax
  2506 0000133C 7505                    	jnz	short lff32m_8
  2507 0000133E E90AF8FFFF              	jmp	lff32_eof
  2508                                  
  2509                                  lff32m_8:
  2510 00001343 89C1                    	mov	ecx, eax	; byte count
  2511                                  lff32m_1:
  2512 00001345 AC                      	lodsb
  2513                                  	;mov	[previous_val], al
  2514 00001346 88C3                    	mov	bl, al
  2515 00001348 2C80                    	sub	al, 80h
  2516 0000134A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2517 0000134E 66AB                    	stosw		; original sample (left channel)
  2518 00001350 66AB                    	stosw		; original sample (right channel)
  2519                                  	;xor	eax, eax
  2520 00001352 B080                    	mov	al, 80h
  2521 00001354 49                      	dec	ecx
  2522 00001355 7402                    	jz	short lff32m_2
  2523 00001357 8A06                    	mov	al, [esi]
  2524                                  lff32m_2:
  2525                                  	;;mov	[next_val], al
  2526                                  	;mov	bh, al
  2527                                  	;add	al, [previous_val]
  2528 00001359 00D8                    	add	al, bl
  2529 0000135B D0D8                    	rcr	al, 1
  2530 0000135D 2C80                    	sub	al, 80h
  2531 0000135F 66C1E008                	shl	ax, 8
  2532 00001363 66AB                    	stosw		; this is interpolated sample (L)
  2533 00001365 66AB                    	stosw		; this is interpolated sample (R)
  2534                                  	
  2535                                  	; different than 8-16-24 kHZ !
  2536                                  	; 'original-interpolated-original' trio samples 
  2537 00001367 E30E                    	jecxz	lff32m_3
  2538                                  
  2539 00001369 AC                      	lodsb
  2540 0000136A 2C80                    	sub	al, 80h
  2541 0000136C 66C1E008                	shl	ax, 8
  2542 00001370 66AB                    	stosw		; original sample (left channel)
  2543 00001372 66AB                    	stosw		; original sample (right channel)
  2544                                  
  2545                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2546 00001374 49                      	dec	ecx
  2547 00001375 75CE                    	jnz	short lff32m_1
  2548                                  lff32m_3:
  2549 00001377 E9B9F7FFFF              	jmp	lff32_3
  2550                                  
  2551                                  lff32m_7:
  2552                                  lff32s_7:
  2553 0000137C E9D5F7FFFF              	jmp	lff32_5  ; error
  2554                                  
  2555                                  load_32khz_stereo_8_bit:
  2556                                  	; 15/11/2023
  2557 00001381 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2558                                  					; last of the file?
  2559 00001388 7402                    	jz	short lff32s_0		; no
  2560 0000138A F9                      	stc
  2561 0000138B C3                      	retn
  2562                                  
  2563                                  lff32s_0:
  2564 0000138C BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2565                                          ;mov	edx, [loadsize]
  2566                                  
  2567                                  	; esi = buffer address
  2568                                  	;; edx = buffer size
  2569                                  
  2570                                  	; load file into memory
  2571                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001391 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001397 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001399 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000139F B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000013A4 CD40                <1>  int 40h
  2572 000013A6 72D4                    	jc	short lff32s_7 ; error !
  2573                                  
  2574 000013A8 BF[00800000]            	mov	edi, audio_buffer
  2575                                  	
  2576 000013AD D1E8                    	shr	eax, 1
  2577 000013AF 7505                    	jnz	short lff32s_8
  2578 000013B1 E997F7FFFF              	jmp	lff32_eof
  2579                                  
  2580                                  lff32s_8:
  2581 000013B6 89C1                    	mov	ecx, eax  ; word count
  2582                                  lff32s_1:
  2583 000013B8 AC                      	lodsb
  2584 000013B9 A2[BD200000]            	mov	[previous_val_l], al
  2585 000013BE 2C80                    	sub	al, 80h
  2586 000013C0 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2587 000013C4 66AB                    	stosw		; original sample (L)
  2588 000013C6 AC                      	lodsb
  2589 000013C7 A2[BF200000]            	mov	[previous_val_r], al
  2590 000013CC 2C80                    	sub	al, 80h
  2591 000013CE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2592 000013D2 66AB                    	stosw		; original sample (R)
  2593                                  
  2594                                  	;xor	eax, eax
  2595 000013D4 66B88080                	mov	ax, 8080h
  2596 000013D8 49                      	dec	ecx
  2597 000013D9 7403                    	jz	short lff32s_2
  2598                                  		; convert 8 bit sample to 16 bit sample
  2599 000013DB 668B06                  	mov	ax, [esi]
  2600                                  lff32s_2:
  2601                                  	;;mov	[next_val_l], al
  2602                                  	;;mov	[next_val_r], ah
  2603                                  	;mov	bx, ax
  2604 000013DE 88E7                    	mov	bh, ah
  2605 000013E0 0205[BD200000]          	add	al, [previous_val_l]
  2606 000013E6 D0D8                    	rcr	al, 1
  2607                                  	;mov	dl, al
  2608 000013E8 2C80                    	sub	al, 80h
  2609 000013EA 66C1E008                	shl	ax, 8
  2610 000013EE 66AB                    	stosw		; this is interpolated sample (L)
  2611 000013F0 88F8                    	mov	al, bh	; [next_val_r]
  2612 000013F2 0205[BF200000]          	add	al, [previous_val_r]
  2613 000013F8 D0D8                    	rcr	al, 1
  2614                                  	;mov	dh, al
  2615 000013FA 2C80                    	sub	al, 80h
  2616 000013FC 66C1E008                	shl	ax, 8
  2617 00001400 66AB                    	stosw		; this is interpolated sample (R)
  2618                                  
  2619                                  	; different than 8-16-24 kHZ !
  2620                                  	; 'original-interpolated-original' trio samples 
  2621 00001402 E315                    	jecxz	lff32s_3
  2622                                  
  2623 00001404 AC                      	lodsb
  2624 00001405 2C80                    	sub	al, 80h
  2625 00001407 66C1E008                	shl	ax, 8
  2626 0000140B 66AB                    	stosw		; original sample (left channel)
  2627                                  
  2628 0000140D AC                      	lodsb
  2629 0000140E 2C80                    	sub	al, 80h
  2630 00001410 66C1E008                	shl	ax, 8
  2631 00001414 66AB                    	stosw		; original sample (right channel)
  2632                                  		
  2633                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2634 00001416 49                      	dec	ecx
  2635 00001417 759F                    	jnz	short lff32s_1
  2636                                  lff32s_3:
  2637 00001419 E917F7FFFF              	jmp	lff32_3
  2638                                  
  2639                                  load_32khz_mono_16_bit:
  2640                                  	; 15/11/2023
  2641 0000141E F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2642                                  					; last of the file?
  2643 00001425 7402                    	jz	short lff32m2_0		; no
  2644 00001427 F9                      	stc
  2645 00001428 C3                      	retn
  2646                                  
  2647                                  lff32m2_0:
  2648 00001429 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2649                                          ;mov	edx, [loadsize]
  2650                                  
  2651                                  	; esi = buffer address
  2652                                  	;; edx = buffer size
  2653                                  
  2654                                  	; load file into memory
  2655                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000142E 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001434 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001436 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000143C B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001441 CD40                <1>  int 40h
  2656 00001443 723E                    	jc	short lff32m2_7 ; error !
  2657                                  
  2658 00001445 BF[00800000]            	mov	edi, audio_buffer
  2659                                  	
  2660 0000144A D1E8                    	shr	eax, 1
  2661 0000144C 7505                    	jnz	short lff32m2_8
  2662 0000144E E9FAF6FFFF              	jmp	lff32_eof
  2663                                  
  2664                                  lff32m2_8:
  2665 00001453 89C1                    	mov	ecx, eax  ; word count
  2666                                  lff32m2_1:
  2667 00001455 66AD                    	lodsw
  2668 00001457 66AB                    	stosw		; original sample (left channel)
  2669 00001459 66AB                    	stosw		; original sample (right channel)
  2670 0000145B 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2671                                  	;mov	[previous_val], ax
  2672                                  	;mov	ebx, eax	
  2673                                  	;xor	eax, eax
  2674 0000145E 31DB                    	xor	ebx, ebx
  2675 00001460 49                      	dec	ecx
  2676 00001461 7403                    	jz	short lff32m2_2
  2677                                  	;mov	ax, [esi]
  2678 00001463 668B1E                  	mov	bx, [esi]
  2679                                  lff32m2_2:
  2680                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2681                                  	;mov	ebp, eax	; [next_val]
  2682                                  	;add	ax, [previous_val]
  2683                                  	; ax = [previous_val]
  2684                                  	; bx = [next_val]
  2685 00001466 6601D8                  	add	ax, bx
  2686 00001469 66D1D8                  	rcr	ax, 1
  2687 0000146C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2688 0000146F 66AB                    	stosw		; this is interpolated sample (L)
  2689 00001471 66AB                    	stosw		; this is interpolated sample (R)
  2690                                  
  2691                                  	; different than 8-16-24 kHZ !
  2692                                  	; 'original-interpolated-original' trio samples 
  2693 00001473 E309                    	jecxz	lff32m2_3
  2694                                  
  2695 00001475 66AD                    	lodsw
  2696 00001477 66AB                    	stosw		; original sample (left channel)
  2697 00001479 66AB                    	stosw		; original sample (right channel)
  2698                                  
  2699                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2700 0000147B 49                      	dec	ecx
  2701 0000147C 75D7                    	jnz	short lff32m2_1
  2702                                  lff32m2_3:
  2703 0000147E E9B2F6FFFF              	jmp	lff32_3
  2704                                  
  2705                                  lff32m2_7:
  2706                                  lff32s2_7:
  2707 00001483 E9CEF6FFFF              	jmp	lff32_5  ; error
  2708                                  
  2709                                  load_32khz_stereo_16_bit:
  2710                                  	; 16/11/2023
  2711                                  	; 15/11/2023
  2712 00001488 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2713                                  					; last of the file?
  2714 0000148F 7402                    	jz	short lff32s2_0		; no
  2715 00001491 F9                      	stc
  2716 00001492 C3                      	retn
  2717                                  
  2718                                  lff32s2_0:
  2719 00001493 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2720                                          ;mov	edx, [loadsize]
  2721                                  
  2722                                  	; esi = buffer address
  2723                                  	;; edx = buffer size
  2724                                  
  2725                                  	; load file into memory
  2726                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001498 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000149E 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000014A0 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000014A6 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000014AB CD40                <1>  int 40h
  2727 000014AD 72D4                    	jc	short lff32s2_7 ; error !
  2728                                  
  2729 000014AF BF[00800000]            	mov	edi, audio_buffer
  2730                                  	
  2731 000014B4 C1E802                  	shr	eax, 2
  2732 000014B7 7505                    	jnz	short lff32s2_8
  2733 000014B9 E98FF6FFFF              	jmp	lff32_eof
  2734                                  
  2735                                  lff32s2_8:
  2736 000014BE 89C1                    	mov	ecx, eax ; dword count
  2737                                  lff32s2_1:
  2738 000014C0 66AD                    	lodsw
  2739 000014C2 66AB                    	stosw		; original sample (L)
  2740 000014C4 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2741 000014C7 66A3[BD200000]          	mov	[previous_val_l], ax
  2742 000014CD 66AD                    	lodsw
  2743 000014CF 66AB                    	stosw		; original sample (R)
  2744 000014D1 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2745                                  	;mov	[previous_val_r], ax
  2746 000014D4 89C3                    	mov	ebx, eax
  2747 000014D6 31D2                    	xor	edx, edx
  2748 000014D8 31C0                    	xor	eax, eax
  2749                                  	; 16/11/2023
  2750 000014DA 49                      	dec	ecx
  2751 000014DB 7407                    	jz	short lff32s2_2
  2752 000014DD 668B06                  	mov	ax, [esi]
  2753 000014E0 668B5602                	mov	dx, [esi+2]
  2754                                  lff32s2_2:
  2755 000014E4 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2756                                  	;;mov	[next_val_l], ax
  2757                                  	;mov	ebp, eax
  2758 000014E7 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2759                                  	;mov	[next_val_r], dx
  2760 000014EA 660305[BD200000]        	add	ax, [previous_val_l]
  2761 000014F1 66D1D8                  	rcr	ax, 1
  2762 000014F4 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2763 000014F7 66AB                    	stosw		; this is interpolated sample (L)
  2764                                  	;mov	ax, [next_val_r]
  2765 000014F9 89D0                    	mov	eax, edx
  2766                                  	;add	ax, [previous_val_r]
  2767 000014FB 6601D8                  	add	ax, bx
  2768 000014FE 66D1D8                  	rcr	ax, 1
  2769 00001501 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2770 00001504 66AB                    	stosw		; this is interpolated sample (R)
  2771                                  
  2772                                  	; different than 8-16-24 kHZ !
  2773                                  	; 'original-interpolated-original' trio samples 
  2774 00001506 E30B                    	jecxz	lff32s2_3
  2775                                  
  2776 00001508 66AD                    	lodsw
  2777 0000150A 66AB                    	stosw	; original sample (L)
  2778 0000150C 66AD                    	lodsw
  2779 0000150E 66AB                    	stosw	; original sample (R)
  2780                                  	
  2781                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2782 00001510 49                      	dec	ecx
  2783 00001511 75AD                    	jnz	short lff32s2_1
  2784                                  lff32s2_3:
  2785 00001513 E91DF6FFFF              	jmp	lff32_3
  2786                                  
  2787                                  ; .....................
  2788                                  
  2789                                  load_22khz_mono_8_bit:
  2790                                  	; 16/11/2023
  2791 00001518 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2792                                  					; last of the file?
  2793 0000151F 7402                    	jz	short lff22m_0		; no
  2794 00001521 F9                      	stc
  2795 00001522 C3                      	retn
  2796                                  
  2797                                  lff22m_0:
  2798 00001523 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2799                                          ;mov	edx, [loadsize]
  2800                                  
  2801                                  	; esi = buffer address
  2802                                  	;; edx = buffer size
  2803                                  
  2804                                  	; load file into memory
  2805                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001528 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000152E 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001530 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001536 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000153B CD40                <1>  int 40h
  2806 0000153D 725D                    	jc	short lff22m_7 ; error !
  2807                                  
  2808 0000153F BF[00800000]            	mov	edi, audio_buffer
  2809                                  	
  2810 00001544 21C0                    	and	eax, eax
  2811 00001546 7505                    	jnz	short lff22m_8
  2812 00001548 E900F6FFFF              	jmp	lff22_eof
  2813                                  
  2814                                  lff22m_8:
  2815 0000154D 89C1                    	mov	ecx, eax	; byte count
  2816                                  lff22m_9:
  2817 0000154F BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2818 00001554 C605[C5200000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2819                                  lff22m_1:
  2820                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2821 0000155B AC                      	lodsb
  2822 0000155C B280                    	mov	dl, 80h
  2823 0000155E 49                      	dec	ecx
  2824 0000155F 7402                    	jz	short lff22m_2_1
  2825 00001561 8A16                    	mov	dl, [esi]
  2826                                  lff22m_2_1:	
  2827                                  	; al = [previous_val]
  2828                                  	; dl = [next_val]
  2829 00001563 E80F060000              	call	interpolating_3_8bit_mono ; 1 of 17
  2830 00001568 E32D                    	jecxz	lff22m_3
  2831                                  lff22m_2_2:
  2832 0000156A AC                      	lodsb
  2833 0000156B B280                    	mov	dl, 80h
  2834 0000156D 49                      	dec	ecx
  2835 0000156E 7402                    	jz	short lff22m_2_3
  2836 00001570 8A16                    	mov	dl, [esi]
  2837                                  lff22m_2_3:
  2838 00001572 E884060000               	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2839 00001577 E31E                    	jecxz	lff22m_3
  2840 00001579 4D                      	dec	ebp
  2841 0000157A 75EE                    	jnz	short lff22m_2_2
  2842                                  
  2843 0000157C A0[C5200000]            	mov	al, [faz]
  2844 00001581 FEC8                    	dec	al
  2845 00001583 74CA                    	jz	short lff22m_9
  2846 00001585 FE0D[C5200000]          	dec	byte [faz]
  2847 0000158B BD04000000              	mov	ebp, 4
  2848 00001590 FEC8                    	dec	al
  2849 00001592 75C7                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2850 00001594 45                      	inc	ebp ; 5
  2851 00001595 EBC4                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2852                                  
  2853                                  lff22m_3:
  2854                                  lff22s_3:
  2855 00001597 E999F5FFFF              	jmp	lff22_3	; padfill
  2856                                  		; (put zeros in the remain words of the buffer)
  2857                                  lff22m_7:
  2858                                  lff22s_7:
  2859 0000159C E9B5F5FFFF              	jmp	lff22_5  ; error
  2860                                  
  2861                                  load_22khz_stereo_8_bit:
  2862                                  	; 16/11/2023
  2863 000015A1 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2864                                  					; last of the file?
  2865 000015A8 7402                    	jz	short lff22s_0		; no
  2866 000015AA F9                      	stc
  2867 000015AB C3                      	retn
  2868                                  
  2869                                  lff22s_0:
  2870 000015AC BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2871                                          ;mov	edx, [loadsize]
  2872                                  
  2873                                  	; esi = buffer address
  2874                                  	;; edx = buffer size
  2875                                  
  2876                                  	; load file into memory
  2877                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000015B1 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000015B7 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000015B9 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000015BF B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000015C4 CD40                <1>  int 40h
  2878 000015C6 72D4                    	jc	short lff22s_7 ; error !
  2879                                  
  2880 000015C8 BF[00800000]            	mov	edi, audio_buffer
  2881                                  	
  2882 000015CD D1E8                    	shr	eax, 1
  2883 000015CF 7505                    	jnz	short lff22s_8
  2884 000015D1 E977F5FFFF              	jmp	lff22_eof
  2885                                  
  2886                                  lff22s_8:
  2887 000015D6 89C1                    	mov	ecx, eax	; word count
  2888                                  lff22s_9:
  2889 000015D8 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2890 000015DD C605[C5200000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2891                                  lff22s_1:
  2892                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2893 000015E4 66AD                    	lodsw
  2894 000015E6 66BA8080                	mov	dx, 8080h
  2895 000015EA 49                      	dec	ecx
  2896 000015EB 7403                    	jz	short lff22s_2_1 
  2897 000015ED 668B16                  	mov	dx, [esi]
  2898                                  lff22s_2_1:	
  2899                                  	; al = [previous_val_l]
  2900                                  	; ah = [previous_val_r]
  2901                                  	; dl = [next_val_l]
  2902                                  	; dh = [next_val_r]	
  2903 000015F0 E8B3050000              	call	interpolating_3_8bit_stereo ; 1 of 17 
  2904 000015F5 E3A0                    	jecxz	lff22s_3
  2905                                  lff22s_2_2:
  2906 000015F7 66AD                    	lodsw
  2907 000015F9 66BA8080                	mov	dx, 8080h
  2908 000015FD 49                      	dec	ecx
  2909 000015FE 7403                    	jz	short lff22s_2_3
  2910 00001600 668B16                  	mov	dx, [esi]
  2911                                  lff22s_2_3:
  2912 00001603 E810060000               	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2913 00001608 E38D                    	jecxz	lff22s_3
  2914 0000160A 4D                      	dec	ebp
  2915 0000160B 75EA                    	jnz	short lff22s_2_2
  2916                                  
  2917 0000160D A0[C5200000]            	mov	al, [faz]
  2918 00001612 FEC8                    	dec	al
  2919 00001614 74C2                    	jz	short lff22s_9
  2920 00001616 FE0D[C5200000]          	dec	byte [faz]
  2921 0000161C BD04000000              	mov	ebp, 4
  2922 00001621 FEC8                    	dec	al
  2923 00001623 75BF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2924 00001625 45                      	inc	ebp ; 5
  2925 00001626 EBBC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2926                                  
  2927                                  load_22khz_mono_16_bit:
  2928                                  	; 16/11/2023
  2929 00001628 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2930                                  					; last of the file?
  2931 0000162F 7402                    	jz	short lff22m2_0		; no
  2932 00001631 F9                      	stc
  2933 00001632 C3                      	retn
  2934                                  
  2935                                  lff22m2_0:
  2936 00001633 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2937                                          ;mov	edx, [loadsize]
  2938                                  
  2939                                  	; esi = buffer address
  2940                                  	;; edx = buffer size
  2941                                  
  2942                                  	; load file into memory
  2943                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001638 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000163E 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001640 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001646 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000164B CD40                <1>  int 40h
  2944 0000164D 7261                    	jc	short lff22m2_7 ; error !
  2945                                  
  2946 0000164F BF[00800000]            	mov	edi, audio_buffer
  2947                                  	
  2948 00001654 D1E8                    	shr	eax, 1
  2949 00001656 7505                    	jnz	short lff22m2_8
  2950 00001658 E9F0F4FFFF              	jmp	lff22_eof
  2951                                  
  2952                                  lff22m2_8:
  2953 0000165D 89C1                    	mov	ecx, eax	; word count
  2954                                  lff22m2_9:
  2955 0000165F BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2956 00001664 C605[C5200000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2957                                  lff22m2_1:
  2958                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2959 0000166B 66AD                    	lodsw
  2960 0000166D 31D2                    	xor	edx, edx
  2961 0000166F 49                      	dec	ecx
  2962 00001670 7403                    	jz	short lff22m2_2_1
  2963 00001672 668B16                  	mov	dx, [esi]
  2964                                  lff22m2_2_1:	
  2965                                  	; ax = [previous_val]
  2966                                  	; dx = [next_val]
  2967 00001675 E8CF050000              	call	interpolating_3_16bit_mono ; 1 of 17
  2968 0000167A E32F                    	jecxz	lff22m2_3
  2969                                  lff22m2_2_2:
  2970 0000167C 66AD                    	lodsw
  2971 0000167E 31D2                    	xor	edx, edx
  2972 00001680 49                      	dec	ecx
  2973 00001681 7403                    	jz	short lff22m2_2_3
  2974 00001683 668B16                  	mov	dx, [esi]
  2975                                  lff22m2_2_3:
  2976 00001686 E851060000               	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2977 0000168B E31E                    	jecxz	lff22m2_3
  2978 0000168D 4D                      	dec	ebp
  2979 0000168E 75EC                    	jnz	short lff22m2_2_2
  2980                                  
  2981 00001690 A0[C5200000]            	mov	al, [faz]
  2982 00001695 FEC8                    	dec	al
  2983 00001697 74C6                    	jz	short lff22m2_9
  2984 00001699 FE0D[C5200000]          	dec	byte [faz]
  2985 0000169F BD04000000              	mov	ebp, 4
  2986 000016A4 FEC8                    	dec	al
  2987 000016A6 75C3                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2988 000016A8 45                      	inc	ebp ; 5
  2989 000016A9 EBC0                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2990                                  
  2991                                  lff22m2_3:
  2992                                  lff22s2_3:
  2993 000016AB E985F4FFFF              	jmp	lff22_3	; padfill
  2994                                  		; (put zeros in the remain words of the buffer)
  2995                                  lff22m2_7:
  2996                                  lff22s2_7:
  2997 000016B0 E9A1F4FFFF              	jmp	lff22_5  ; error
  2998                                  
  2999                                  load_22khz_stereo_16_bit:
  3000                                  	; 16/11/2023
  3001 000016B5 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3002                                  					; last of the file?
  3003 000016BC 7402                    	jz	short lff22s2_0		; no
  3004 000016BE F9                      	stc
  3005 000016BF C3                      	retn
  3006                                  
  3007                                  lff22s2_0:
  3008 000016C0 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3009                                          ;mov	edx, [loadsize]
  3010                                  
  3011                                  	; esi = buffer address
  3012                                  	;; edx = buffer size
  3013                                  
  3014                                  	; load file into memory
  3015                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000016C5 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000016CB 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000016CD 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000016D3 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000016D8 CD40                <1>  int 40h
  3016 000016DA 72D4                    	jc	short lff22s2_7 ; error !
  3017                                  
  3018 000016DC BF[00800000]            	mov	edi, audio_buffer
  3019                                  	
  3020 000016E1 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3021 000016E4 7505                    	jnz	short lff22s2_8
  3022 000016E6 E962F4FFFF              	jmp	lff22_eof
  3023                                  
  3024                                  lff22s2_8:
  3025 000016EB 89C1                    	mov	ecx, eax	; dword count
  3026                                  lff22s2_9:
  3027 000016ED BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  3028 000016F2 C605[C5200000]03        	mov	byte [faz], 3  ; 3 steps/phase
  3029                                  lff22s2_1:
  3030                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  3031 000016F9 66AD                    	lodsw
  3032 000016FB 89C3                    	mov	ebx, eax
  3033 000016FD 66AD                    	lodsw
  3034 000016FF 8B16                    	mov	edx, [esi]
  3035 00001701 668915[C1200000]        	mov	[next_val_l], dx
  3036                                  	; 26/11/2023
  3037 00001708 C1EA10                  	shr	edx, 16
  3038 0000170B 49                      	dec	ecx
  3039 0000170C 7509                    	jnz	short lff22s2_2_1
  3040 0000170E 31D2                    	xor	edx, edx ; 0
  3041 00001710 668915[C1200000]        	mov	[next_val_l], dx
  3042                                  lff22s2_2_1:
  3043                                  	; bx = [previous_val_l]
  3044                                  	; ax = [previous_val_r]
  3045                                  	; [next_val_l]
  3046                                  	; dx = [next_val_r]
  3047 00001717 E85D050000              	call	interpolating_3_16bit_stereo ; 1 of 17 
  3048 0000171C E38D                    	jecxz	lff22s2_3
  3049                                  lff22s2_2_2:
  3050 0000171E 66AD                    	lodsw
  3051 00001720 89C3                    	mov	ebx, eax
  3052 00001722 66AD                    	lodsw
  3053 00001724 8B16                    	mov	edx, [esi]
  3054 00001726 668915[C1200000]        	mov	[next_val_l], dx
  3055                                  	; 26/11/2023
  3056 0000172D C1EA10                  	shr	edx, 16
  3057 00001730 49                      	dec	ecx
  3058 00001731 7509                    	jnz	short lff22s2_2_3
  3059 00001733 31D2                    	xor	edx, edx ; 0
  3060 00001735 668915[C1200000]        	mov	[next_val_l], dx
  3061                                  lff22s2_2_3:
  3062 0000173C E8B3050000               	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  3063 00001741 E31E                    	jecxz	lff22s2_2_4
  3064                                  
  3065 00001743 4D                      	dec	ebp
  3066 00001744 75D8                    	jnz	short lff22s2_2_2
  3067                                  
  3068 00001746 A0[C5200000]            	mov	al, [faz]
  3069 0000174B FEC8                    	dec	al
  3070 0000174D 749E                    	jz	short lff22s2_9
  3071 0000174F FE0D[C5200000]          	dec	byte [faz]
  3072 00001755 BD04000000              	mov	ebp, 4
  3073 0000175A FEC8                    	dec	al
  3074 0000175C 759B                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  3075 0000175E 45                      	inc	ebp ; 5
  3076 0000175F EB98                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  3077                                  
  3078                                  lff22s2_2_4:
  3079                                  	; 26/11/2023
  3080 00001761 E9CFF3FFFF              	jmp	lff22_3	; padfill
  3081                                  
  3082                                  ; .....................
  3083                                  
  3084                                  load_11khz_mono_8_bit:
  3085                                  	; 18/11/2023
  3086 00001766 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3087                                  					; last of the file?
  3088 0000176D 7402                    	jz	short lff11m_0		; no
  3089 0000176F F9                      	stc
  3090 00001770 C3                      	retn
  3091                                  
  3092                                  lff11m_0:
  3093 00001771 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3094                                          ;mov	edx, [loadsize]
  3095                                  
  3096                                  	; esi = buffer address
  3097                                  	;; edx = buffer size
  3098                                  
  3099                                  	; load file into memory
  3100                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001776 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000177C 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000177E 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001784 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001789 CD40                <1>  int 40h
  3101 0000178B 7247                    	jc	short lff11m_7 ; error !
  3102                                  
  3103 0000178D BF[00800000]            	mov	edi, audio_buffer
  3104                                  	
  3105 00001792 21C0                    	and	eax, eax
  3106 00001794 7505                    	jnz	short lff11m_8
  3107 00001796 E9B2F3FFFF              	jmp	lff11_eof
  3108                                  
  3109                                  lff11m_8:
  3110 0000179B 89C1                    	mov	ecx, eax		; byte count
  3111                                  lff11m_9:
  3112 0000179D BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3113                                  lff11m_1:
  3114                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3115 000017A2 AC                      	lodsb
  3116 000017A3 B280                    	mov	dl, 80h
  3117 000017A5 49                      	dec	ecx
  3118 000017A6 7402                    	jz	short lff11m_2_1
  3119 000017A8 8A16                    	mov	dl, [esi]
  3120                                  lff11m_2_1:	
  3121                                  	; al = [previous_val]
  3122                                  	; dl = [next_val]
  3123 000017AA E876050000              	call	interpolating_5_8bit_mono
  3124 000017AF E328                    	jecxz	lff11m_3
  3125                                  lff11m_2_2:
  3126 000017B1 AC                      	lodsb
  3127 000017B2 B280                    	mov	dl, 80h
  3128 000017B4 49                      	dec	ecx
  3129 000017B5 7402                    	jz	short lff11m_2_3
  3130 000017B7 8A16                    	mov	dl, [esi]
  3131                                  lff11m_2_3:
  3132 000017B9 E873060000               	call	interpolating_4_8bit_mono
  3133 000017BE E319                    	jecxz	lff11m_3
  3134                                  
  3135 000017C0 4D                      	dec	ebp
  3136 000017C1 74DA                    	jz	short lff11m_9
  3137                                  
  3138 000017C3 AC                      	lodsb
  3139 000017C4 B280                    	mov	dl, 80h
  3140 000017C6 49                      	dec	ecx
  3141 000017C7 7402                    	jz	short lff11m_2_4
  3142 000017C9 8A16                    	mov	dl, [esi]
  3143                                  lff11m_2_4:
  3144 000017CB E861060000              	call	interpolating_4_8bit_mono
  3145 000017D0 E307                    	jecxz	lff11m_3
  3146 000017D2 EBCE                    	jmp	short lff11m_1
  3147                                  
  3148                                  lff11m_7:
  3149                                  lff11s_7:
  3150 000017D4 E97DF3FFFF              	jmp	lff11_5  ; error
  3151                                  
  3152                                  lff11m_3:
  3153                                  lff11s_3:
  3154 000017D9 E957F3FFFF              	jmp	lff11_3	; padfill
  3155                                  		; (put zeros in the remain words of the buffer)
  3156                                  
  3157                                  load_11khz_stereo_8_bit:
  3158                                  	; 18/11/2023
  3159 000017DE F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3160                                  					; last of the file?
  3161 000017E5 7402                    	jz	short lff11s_0		; no
  3162 000017E7 F9                      	stc
  3163 000017E8 C3                      	retn
  3164                                  
  3165                                  lff11s_0:
  3166 000017E9 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3167                                          ;mov	edx, [loadsize]
  3168                                  
  3169                                  	; esi = buffer address
  3170                                  	;; edx = buffer size
  3171                                  
  3172                                  	; load file into memory
  3173                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000017EE 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000017F4 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000017F6 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000017FC B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001801 CD40                <1>  int 40h
  3174 00001803 72CF                    	jc	short lff11s_7 ; error !
  3175                                  
  3176 00001805 BF[00800000]            	mov	edi, audio_buffer
  3177                                  	
  3178 0000180A D1E8                    	shr	eax, 1
  3179 0000180C 7505                    	jnz	short lff11s_8
  3180 0000180E E93AF3FFFF              	jmp	lff11_eof
  3181                                  
  3182                                  lff11s_8:
  3183 00001813 89C1                    	mov	ecx, eax	; word count
  3184                                  lff11s_9:
  3185 00001815 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3186                                  lff11s_1:
  3187                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3188 0000181A 66AD                    	lodsw
  3189 0000181C 66BA8080                	mov	dx, 8080h
  3190 00001820 49                      	dec	ecx
  3191 00001821 7403                    	jz	short lff11s_2_1 
  3192 00001823 668B16                  	mov	dx, [esi]
  3193                                  lff11s_2_1:	
  3194                                  	; al = [previous_val_l]
  3195                                  	; ah = [previous_val_r]
  3196                                  	; dl = [next_val_l]
  3197                                  	; dh = [next_val_r]	
  3198 00001826 E859050000              	call	interpolating_5_8bit_stereo
  3199 0000182B E3AC                    	jecxz	lff11s_3
  3200                                  lff11s_2_2:
  3201 0000182D 66AD                    	lodsw
  3202 0000182F 66BA8080                	mov	dx, 8080h
  3203 00001833 49                      	dec	ecx
  3204 00001834 7403                    	jz	short lff11s_2_3
  3205 00001836 668B16                  	mov	dx, [esi]
  3206                                  lff11s_2_3:
  3207 00001839 E832060000               	call	interpolating_4_8bit_stereo
  3208 0000183E E399                    	jecxz	lff11s_3
  3209                                  	
  3210 00001840 4D                      	dec	ebp
  3211 00001841 74D2                    	jz	short lff11s_9
  3212                                  
  3213 00001843 66AD                    	lodsw
  3214 00001845 66BA8080                	mov	dx, 8080h
  3215 00001849 49                      	dec	ecx
  3216 0000184A 7403                    	jz	short lff11s_2_4
  3217 0000184C 668B16                  	mov	dx, [esi]
  3218                                  lff11s_2_4:
  3219 0000184F E81C060000              	call	interpolating_4_8bit_stereo
  3220 00001854 E383                    	jecxz	lff11s_3
  3221 00001856 EBC2                    	jmp	short lff11s_1
  3222                                  
  3223                                  load_11khz_mono_16_bit:
  3224                                  	; 18/11/2023
  3225 00001858 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3226                                  					; last of the file?
  3227 0000185F 7402                    	jz	short lff11m2_0		; no
  3228 00001861 F9                      	stc
  3229 00001862 C3                      	retn
  3230                                  
  3231                                  lff11m2_0:
  3232 00001863 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3233                                          ;mov	edx, [loadsize]
  3234                                  
  3235                                  	; esi = buffer address
  3236                                  	;; edx = buffer size
  3237                                  
  3238                                  	; load file into memory
  3239                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001868 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000186E 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001870 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001876 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000187B CD40                <1>  int 40h
  3240 0000187D 724D                    	jc	short lff11m2_7 ; error !
  3241                                  
  3242 0000187F BF[00800000]            	mov	edi, audio_buffer
  3243                                  	
  3244 00001884 D1E8                    	shr	eax, 1
  3245 00001886 7505                    	jnz	short lff11m2_8
  3246 00001888 E9C0F2FFFF              	jmp	lff11_eof
  3247                                  
  3248                                  lff11m2_8:
  3249 0000188D 89C1                    	mov	ecx, eax	; word count
  3250                                  lff11m2_9:
  3251 0000188F BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3252                                  lff11m2_1:
  3253                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3254 00001894 66AD                    	lodsw
  3255 00001896 31D2                    	xor	edx, edx
  3256 00001898 49                      	dec	ecx
  3257 00001899 7403                    	jz	short lff11m2_2_1
  3258 0000189B 668B16                  	mov	dx, [esi]
  3259                                  lff11m2_2_1:	
  3260                                  	; ax = [previous_val]
  3261                                  	; dx = [next_val]
  3262 0000189E E83A060000              	call	interpolating_5_16bit_mono
  3263 000018A3 E362                    	jecxz	lff11m2_3
  3264                                  lff11m2_2_2:
  3265 000018A5 66AD                    	lodsw
  3266 000018A7 31D2                    	xor	edx, edx
  3267 000018A9 49                      	dec	ecx
  3268 000018AA 7403                    	jz	short lff11m2_2_3
  3269 000018AC 668B16                  	mov	dx, [esi]
  3270                                  lff11m2_2_3:
  3271 000018AF E853070000               	call	interpolating_4_16bit_mono
  3272 000018B4 E351                    	jecxz	lff11m2_3
  3273                                  
  3274 000018B6 4D                      	dec	ebp
  3275 000018B7 74D6                    	jz	short lff11m2_9
  3276                                  
  3277 000018B9 66AD                    	lodsw
  3278 000018BB 31D2                    	xor	edx, edx
  3279 000018BD 49                      	dec	ecx
  3280 000018BE 7403                    	jz	short lff11m2_2_4
  3281 000018C0 668B16                  	mov	dx, [esi]
  3282                                  lff11m2_2_4:
  3283 000018C3 E83F070000               	call	interpolating_4_16bit_mono
  3284 000018C8 E33D                    	jecxz	lff11m2_3
  3285 000018CA EBC8                    	jmp	short lff11m2_1
  3286                                  
  3287                                  lff11m2_7:
  3288                                  lff11s2_7:
  3289 000018CC E985F2FFFF              	jmp	lff11_5  ; error
  3290                                  
  3291                                  load_11khz_stereo_16_bit:
  3292                                  	; 18/11/2023
  3293 000018D1 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3294                                  					; last of the file?
  3295 000018D8 7402                    	jz	short lff11s2_0		; no
  3296 000018DA F9                      	stc
  3297 000018DB C3                      	retn
  3298                                  
  3299                                  lff11s2_0:
  3300 000018DC BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3301                                          ;mov	edx, [loadsize]
  3302                                  
  3303                                  	; esi = buffer address
  3304                                  	;; edx = buffer size
  3305                                  
  3306                                  	; load file into memory
  3307                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000018E1 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000018E7 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000018E9 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000018EF B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000018F4 CD40                <1>  int 40h
  3308 000018F6 72D4                    	jc	short lff11s2_7 ; error !
  3309                                  
  3310 000018F8 BF[00800000]            	mov	edi, audio_buffer
  3311                                  	
  3312 000018FD C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3313 00001900 750A                    	jnz	short lff11s2_8
  3314 00001902 E946F2FFFF              	jmp	lff11_eof
  3315                                  
  3316                                  lff11m2_3:
  3317                                  lff11s2_3:
  3318 00001907 E929F2FFFF              	jmp	lff11_3	; padfill
  3319                                  		; (put zeros in the remain words of the buffer)
  3320                                  
  3321                                  lff11s2_8:
  3322 0000190C 89C1                    	mov	ecx, eax	; dword count
  3323                                  lff11s2_9:
  3324 0000190E BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3325                                  lff11s2_1:
  3326                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3327 00001913 66AD                    	lodsw
  3328 00001915 89C3                    	mov	ebx, eax
  3329 00001917 66AD                    	lodsw
  3330 00001919 8B16                    	mov	edx, [esi]
  3331 0000191B 8915[C1200000]          	mov	[next_val_l], edx
  3332                                  	; 26/11/2023
  3333 00001921 C1EA10                  	shr	edx, 16
  3334                                  	;mov	[next_val_r], dx
  3335 00001924 49                      	dec	ecx
  3336 00001925 7509                    	jnz	short lff11s2_2_1
  3337 00001927 31D2                    	xor	edx, edx ; 0
  3338 00001929 668915[C1200000]        	mov	[next_val_l], dx
  3339                                  	;mov	[next_val_r], dx
  3340                                  lff11s2_2_1:
  3341                                  	; bx = [previous_val_l]
  3342                                  	; ax = [previous_val_r]
  3343                                  	; [next_val_l]
  3344                                  	; dx = [next_val_r]
  3345 00001930 E803060000              	call	interpolating_5_16bit_stereo
  3346 00001935 E3D0                    	jecxz	lff11s2_3
  3347                                  lff11s2_2_2:
  3348 00001937 66AD                    	lodsw
  3349 00001939 89C3                    	mov	ebx, eax
  3350 0000193B 66AD                    	lodsw
  3351 0000193D 8B16                    	mov	edx, [esi]
  3352 0000193F 668915[C1200000]        	mov	[next_val_l], dx
  3353                                  	; 26/11/2023
  3354 00001946 C1EA10                  	shr	edx, 16
  3355                                  	;mov	[next_val_r], dx
  3356 00001949 49                      	dec	ecx
  3357 0000194A 7509                    	jnz	short lff11s2_2_3
  3358 0000194C 31D2                    	xor	edx, edx ; 0
  3359 0000194E 668915[C1200000]        	mov	[next_val_l], dx
  3360                                  	;mov	[next_val_r], dx
  3361                                  lff11s2_2_3:
  3362 00001955 E8E6060000               	call	interpolating_4_16bit_stereo
  3363 0000195A E3AB                    	jecxz	lff11s2_3
  3364                                  	
  3365 0000195C 4D                      	dec	ebp
  3366 0000195D 74AF                    	jz	short lff11s2_9
  3367                                  
  3368 0000195F 66AD                    	lodsw
  3369 00001961 89C3                    	mov	ebx, eax
  3370 00001963 66AD                    	lodsw
  3371 00001965 8B16                    	mov	edx, [esi]
  3372 00001967 668915[C1200000]        	mov	[next_val_l], dx
  3373                                  	; 26/11/2023
  3374 0000196E C1EA10                  	shr	edx, 16
  3375                                  	;mov	[next_val_r], dx
  3376 00001971 49                      	dec	ecx
  3377 00001972 7509                    	jnz	short lff11s2_2_4
  3378 00001974 31D2                    	xor	edx, edx ; 0
  3379 00001976 668915[C1200000]        	mov	[next_val_l], dx
  3380                                  	;mov	[next_val_r], dx
  3381                                  lff11s2_2_4:
  3382 0000197D E8BE060000               	call	interpolating_4_16bit_stereo
  3383 00001982 E383                    	jecxz	lff11s2_3
  3384 00001984 EB8D                    	jmp	short lff11s2_1
  3385                                  
  3386                                  ; .....................
  3387                                  
  3388                                  load_44khz_mono_8_bit:
  3389                                  	; 18/11/2023
  3390 00001986 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3391                                  					; last of the file?
  3392 0000198D 7402                    	jz	short lff44m_0		; no
  3393 0000198F F9                      	stc
  3394 00001990 C3                      	retn
  3395                                  
  3396                                  lff44m_0:
  3397 00001991 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3398                                          ;mov	edx, [loadsize]
  3399                                  
  3400                                  	; esi = buffer address
  3401                                  	;; edx = buffer size
  3402                                  
  3403                                  	; load file into memory
  3404                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001996 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000199C 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000199E 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000019A4 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000019A9 CD40                <1>  int 40h
  3405 000019AB 7250                    	jc	short lff44m_7 ; error !
  3406                                  
  3407 000019AD BF[00800000]            	mov	edi, audio_buffer
  3408                                  	
  3409 000019B2 21C0                    	and	eax, eax
  3410 000019B4 7505                    	jnz	short lff44m_8
  3411 000019B6 E992F1FFFF              	jmp	lff44_eof
  3412                                  
  3413                                  lff44m_8:
  3414 000019BB 89C1                    	mov	ecx, eax	; byte count
  3415                                  lff44m_9:
  3416 000019BD BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3417 000019C2 C605[C5200000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3418                                  lff44m_1:
  3419                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3420                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3421 000019C9 AC                      	lodsb
  3422 000019CA B280                    	mov	dl, 80h
  3423 000019CC 49                      	dec	ecx
  3424 000019CD 7402                    	jz	short lff44m_2_1
  3425 000019CF 8A16                    	mov	dl, [esi]
  3426                                  lff44m_2_1:	
  3427                                  	; al = [previous_val]
  3428                                  	; dl = [next_val]
  3429 000019D1 E825020000              	call	interpolating_2_8bit_mono
  3430 000019D6 E320                    	jecxz	lff44m_3
  3431                                  lff44m_2_2:
  3432 000019D8 AC                      	lodsb
  3433 000019D9 2C80                    	sub	al, 80h
  3434 000019DB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3435 000019DF 66AB                    	stosw		; (L)
  3436 000019E1 66AB                    	stosw		; (R)	
  3437                                  
  3438 000019E3 49                      	dec	ecx
  3439 000019E4 7412                    	jz	short lff44m_3	
  3440 000019E6 4D                      	dec	ebp
  3441 000019E7 75EF                    	jnz	short lff44m_2_2
  3442                                  	
  3443 000019E9 FE0D[C5200000]          	dec	byte [faz]
  3444 000019EF 74CC                    	jz	short lff44m_9 
  3445 000019F1 BD0B000000              	mov	ebp, 11
  3446 000019F6 EBD1                    	jmp	short lff44m_1
  3447                                  
  3448                                  lff44m_3:
  3449                                  lff44s_3:
  3450 000019F8 E938F1FFFF              	jmp	lff44_3	; padfill
  3451                                  		; (put zeros in the remain words of the buffer)
  3452                                  lff44m_7:
  3453                                  lff44s_7:
  3454 000019FD E954F1FFFF              	jmp	lff44_5  ; error
  3455                                  
  3456                                  load_44khz_stereo_8_bit:
  3457                                  	; 16/11/2023
  3458 00001A02 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3459                                  					; last of the file?
  3460 00001A09 7402                    	jz	short lff44s_0		; no
  3461 00001A0B F9                      	stc
  3462 00001A0C C3                      	retn
  3463                                  
  3464                                  lff44s_0:
  3465 00001A0D BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3466                                          ;mov	edx, [loadsize]
  3467                                  
  3468                                  	; esi = buffer address
  3469                                  	;; edx = buffer size
  3470                                  
  3471                                  	; load file into memory
  3472                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001A12 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001A18 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001A1A 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001A20 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001A25 CD40                <1>  int 40h
  3473 00001A27 72D4                    	jc	short lff44s_7 ; error !
  3474                                  
  3475 00001A29 BF[00800000]            	mov	edi, audio_buffer
  3476                                  	
  3477 00001A2E D1E8                    	shr	eax, 1
  3478 00001A30 7505                    	jnz	short lff44s_8
  3479 00001A32 E916F1FFFF              	jmp	lff44_eof
  3480                                  
  3481                                  lff44s_8:
  3482 00001A37 89C1                    	mov	ecx, eax	; word count
  3483                                  lff44s_9:
  3484 00001A39 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3485 00001A3E C605[C5200000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3486                                  lff44s_1:
  3487                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3488                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3489 00001A45 66AD                    	lodsw
  3490 00001A47 66BA8080                	mov	dx, 8080h
  3491 00001A4B 49                      	dec	ecx
  3492 00001A4C 7403                    	jz	short lff44s_2_1 
  3493 00001A4E 668B16                  	mov	dx, [esi]
  3494                                  lff44s_2_1:	
  3495                                  	; al = [previous_val_l]
  3496                                  	; ah = [previous_val_r]
  3497                                  	; dl = [next_val_l]
  3498                                  	; dh = [next_val_r]	
  3499 00001A51 E8C2010000              	call	interpolating_2_8bit_stereo
  3500 00001A56 E3A0                    	jecxz	lff44s_3
  3501                                  lff44s_2_2:
  3502 00001A58 AC                      	lodsb
  3503 00001A59 2C80                    	sub	al, 80h
  3504 00001A5B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3505 00001A5F 66AB                    	stosw		; (L)
  3506 00001A61 AC                      	lodsb
  3507 00001A62 2C80                    	sub	al, 80h
  3508 00001A64 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3509 00001A68 66AB                    	stosw		; (R)
  3510                                  
  3511 00001A6A 49                      	dec	ecx
  3512 00001A6B 748B                    	jz	short lff44s_3	
  3513 00001A6D 4D                      	dec	ebp
  3514 00001A6E 75E8                    	jnz	short lff44s_2_2
  3515                                  	
  3516 00001A70 FE0D[C5200000]          	dec	byte [faz]
  3517 00001A76 74C1                    	jz	short lff44s_9 
  3518 00001A78 BD0B000000              	mov	ebp, 11
  3519 00001A7D EBC6                    	jmp	short lff44s_1
  3520                                  
  3521                                  load_44khz_mono_16_bit:
  3522                                  	; 18/11/2023
  3523 00001A7F F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3524                                  					; last of the file?
  3525 00001A86 7402                    	jz	short lff44m2_0		; no
  3526 00001A88 F9                      	stc
  3527 00001A89 C3                      	retn
  3528                                  
  3529                                  lff44m2_0:
  3530 00001A8A BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3531                                          ;mov	edx, [loadsize]
  3532                                  
  3533                                  	; esi = buffer address
  3534                                  	;; edx = buffer size
  3535                                  
  3536                                  	; load file into memory
  3537                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001A8F 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001A95 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001A97 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001A9D B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001AA2 CD40                <1>  int 40h
  3538 00001AA4 724D                    	jc	short lff44m2_7 ; error !
  3539                                  
  3540 00001AA6 BF[00800000]            	mov	edi, audio_buffer
  3541                                  	
  3542 00001AAB D1E8                    	shr	eax, 1
  3543 00001AAD 7505                    	jnz	short lff44m2_8
  3544 00001AAF E999F0FFFF              	jmp	lff44_eof
  3545                                  
  3546                                  lff44m2_8:
  3547 00001AB4 89C1                    	mov	ecx, eax	; word count
  3548                                  lff44m2_9:
  3549 00001AB6 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3550 00001ABB C605[C5200000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3551                                  lff44m2_1:
  3552                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3553                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3554 00001AC2 66AD                    	lodsw
  3555 00001AC4 31D2                    	xor	edx, edx
  3556 00001AC6 49                      	dec	ecx
  3557 00001AC7 7403                    	jz	short lff44m2_2_1
  3558 00001AC9 668B16                  	mov	dx, [esi]
  3559                                  lff44m2_2_1:	
  3560                                  	; ax = [previous_val]
  3561                                  	; dx = [next_val]
  3562 00001ACC E80B020000              	call	interpolating_2_16bit_mono
  3563 00001AD1 E31B                    	jecxz	lff44m2_3
  3564                                  lff44m2_2_2:
  3565 00001AD3 66AD                    	lodsw
  3566 00001AD5 66AB                    	stosw		; (L)eft Channel
  3567 00001AD7 66AB                    	stosw		; (R)ight Channel
  3568                                  
  3569 00001AD9 49                      	dec	ecx
  3570 00001ADA 7412                    	jz	short lff44m2_3	
  3571 00001ADC 4D                      	dec	ebp
  3572 00001ADD 75F4                    	jnz	short lff44m2_2_2
  3573                                  	
  3574 00001ADF FE0D[C5200000]          	dec	byte [faz]
  3575 00001AE5 74CF                    	jz	short lff44m2_9 
  3576 00001AE7 BD0B000000              	mov	ebp, 11
  3577 00001AEC EBD4                    	jmp	short lff44m2_1
  3578                                  
  3579                                  lff44m2_3:
  3580                                  lff44s2_3:
  3581 00001AEE E942F0FFFF              	jmp	lff44_3	; padfill
  3582                                  		; (put zeros in the remain words of the buffer)
  3583                                  lff44m2_7:
  3584                                  lff44s2_7:
  3585 00001AF3 E95EF0FFFF              	jmp	lff44_5  ; error
  3586                                  
  3587                                  load_44khz_stereo_16_bit:
  3588                                  	; 18/11/2023
  3589 00001AF8 F605[AC680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3590                                  					; last of the file?
  3591 00001AFF 7402                    	jz	short lff44s2_0		; no
  3592 00001B01 F9                      	stc
  3593 00001B02 C3                      	retn
  3594                                  
  3595                                  lff44s2_0:
  3596 00001B03 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3597                                          ;mov	edx, [loadsize]
  3598                                  
  3599                                  	; esi = buffer address
  3600                                  	;; edx = buffer size
  3601                                  
  3602                                  	; load file into memory
  3603                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001B08 8B1D[8B650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001B0E 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001B10 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001B16 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001B1B CD40                <1>  int 40h
  3604 00001B1D 72D4                    	jc	short lff44s2_7 ; error !
  3605                                  
  3606 00001B1F BF[00800000]            	mov	edi, audio_buffer
  3607                                  	
  3608 00001B24 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3609 00001B27 7505                    	jnz	short lff44s2_8
  3610 00001B29 E91FF0FFFF              	jmp	lff44_eof
  3611                                  
  3612                                  lff44s2_8:
  3613 00001B2E 89C1                    	mov	ecx, eax	; dword count
  3614                                  lff44s2_9:
  3615 00001B30 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3616 00001B35 C605[C5200000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3617                                  lff44s2_1:
  3618                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3619                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3620 00001B3C 66AD                    	lodsw
  3621 00001B3E 89C3                    	mov	ebx, eax
  3622 00001B40 66AD                    	lodsw
  3623                                  	;mov	dx, [esi]
  3624                                  	;mov	[next_val_l], dx
  3625                                  	;mov	dx, [esi+2]
  3626                                  	; 26/11/2023
  3627 00001B42 8B16                    	mov	edx, [esi]
  3628 00001B44 668915[C1200000]        	mov	[next_val_l], dx
  3629 00001B4B C1EA10                  	shr	edx, 16
  3630 00001B4E 49                      	dec	ecx
  3631 00001B4F 7509                    	jnz	short lff44s2_2_1
  3632 00001B51 31D2                    	xor	edx, edx ; 0
  3633 00001B53 668915[C1200000]        	mov	[next_val_l], dx
  3634                                  lff44s2_2_1:
  3635                                  	; bx = [previous_val_l]
  3636                                  	; ax = [previous_val_r]
  3637                                  	; [next_val_l]
  3638                                  	; dx = [next_val_r]
  3639 00001B5A E895010000              	call	interpolating_2_16bit_stereo
  3640 00001B5F E38D                    	jecxz	lff44s2_3
  3641                                  lff44s2_2_2:
  3642                                  	;movsw		; (L)eft Channel
  3643                                  	;movsw		; (R)ight Channel
  3644 00001B61 A5                      	movsd
  3645                                  
  3646 00001B62 49                      	dec	ecx
  3647 00001B63 7489                    	jz	short lff44s2_3	
  3648 00001B65 4D                      	dec	ebp
  3649 00001B66 75F9                    	jnz	short lff44s2_2_2
  3650                                  	
  3651 00001B68 FE0D[C5200000]          	dec	byte [faz]
  3652 00001B6E 74C0                    	jz	short lff44s2_9 
  3653 00001B70 BD0B000000              	mov	ebp, 11
  3654 00001B75 EBC5                    	jmp	short lff44s2_1
  3655                                  
  3656                                  ; .....................
  3657                                  
  3658                                  interpolating_3_8bit_mono:
  3659                                  	; 16/11/2023
  3660                                  	; al = [previous_val]
  3661                                  	; dl = [next_val]
  3662                                  	; original-interpolated-interpolated
  3663 00001B77 88C3                    	mov	bl, al
  3664 00001B79 2C80                    	sub	al, 80h
  3665 00001B7B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3666 00001B7F 66AB                    	stosw		; original sample (L)
  3667 00001B81 66AB                    	stosw		; original sample (R)
  3668 00001B83 88D8                    	mov	al, bl
  3669 00001B85 00D0                    	add	al, dl	
  3670 00001B87 D0D8                    	rcr	al, 1
  3671 00001B89 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3672 00001B8B 00D8                    	add	al, bl
  3673 00001B8D D0D8                    	rcr	al, 1
  3674 00001B8F 2C80                    	sub	al, 80h
  3675 00001B91 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3676 00001B95 66AB                    	stosw		; interpolated sample 1 (L)
  3677 00001B97 66AB                    	stosw		; interpolated sample 1 (R)
  3678 00001B99 88F8                    	mov	al, bh
  3679 00001B9B 00D0                    	add	al, dl	; [next_val]
  3680 00001B9D D0D8                    	rcr	al, 1
  3681 00001B9F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3682 00001BA3 66AB                    	stosw		; interpolated sample 2 (L)
  3683 00001BA5 66AB                    	stosw		; interpolated sample 2 (R)
  3684 00001BA7 C3                      	retn
  3685                                  
  3686                                  interpolating_3_8bit_stereo:
  3687                                  	; 16/11/2023
  3688                                  	; al = [previous_val_l]
  3689                                  	; ah = [previous_val_r]
  3690                                  	; dl = [next_val_l]
  3691                                  	; dh = [next_val_r]	
  3692                                  	; original-interpolated-interpolated
  3693 00001BA8 89C3                    	mov	ebx, eax
  3694 00001BAA 2C80                    	sub	al, 80h
  3695 00001BAC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3696 00001BB0 66AB                    	stosw		; original sample (L)
  3697 00001BB2 88F8                    	mov	al, bh
  3698 00001BB4 2C80                    	sub	al, 80h
  3699 00001BB6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3700 00001BBA 66AB                    	stosw		; original sample (R)
  3701 00001BBC 88D8                    	mov	al, bl
  3702 00001BBE 00D0                    	add	al, dl	; [next_val_l]	
  3703 00001BC0 D0D8                    	rcr	al, 1
  3704 00001BC2 50                      	push	eax ; *	; al = interpolated middle (L) (temporary)
  3705 00001BC3 00D8                    	add	al, bl	; [previous_val_l]
  3706 00001BC5 D0D8                    	rcr	al, 1
  3707 00001BC7 2C80                    	sub	al, 80h
  3708 00001BC9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3709 00001BCD 66AB                    	stosw		; interpolated sample 1 (L)
  3710 00001BCF 88F8                    	mov	al, bh
  3711 00001BD1 00F0                    	add	al, dh	; [next_val_r]
  3712 00001BD3 D0D8                    	rcr	al, 1
  3713 00001BD5 50                      	push	eax ; ** ; al = interpolated middle (R) (temporary)
  3714 00001BD6 00F8                    	add	al, bh	; [previous_val_r]
  3715 00001BD8 D0D8                    	rcr	al, 1
  3716 00001BDA 2C80                    	sub	al, 80h
  3717 00001BDC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3718 00001BE0 66AB                    	stosw		; interpolated sample 1 (R)
  3719 00001BE2 5B                      	pop	ebx ; **
  3720 00001BE3 58                      	pop	eax ; *
  3721 00001BE4 00D0                    	add	al, dl	; [next_val_l]
  3722 00001BE6 D0D8                    	rcr	al, 1
  3723 00001BE8 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3724 00001BEC 66AB                    	stosw		; interpolated sample 2 (L)
  3725 00001BEE 88D8                    	mov	al, bl
  3726 00001BF0 00F0                    	add	al, dh	; [next_val_r]
  3727 00001BF2 D0D8                    	rcr	al, 1
  3728 00001BF4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3729 00001BF8 66AB                    	stosw		; interpolated sample 2 (R)
  3730 00001BFA C3                      	retn
  3731                                  
  3732                                  interpolating_2_8bit_mono:
  3733                                  	; 16/11/2023
  3734                                  	; al = [previous_val]
  3735                                  	; dl = [next_val]
  3736                                  	; original-interpolated
  3737 00001BFB 88C3                    	mov	bl, al
  3738 00001BFD 2C80                    	sub	al, 80h
  3739 00001BFF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3740 00001C03 66AB                    	stosw		; original sample (L)
  3741 00001C05 66AB                    	stosw		; original sample (R)
  3742 00001C07 88D8                    	mov	al, bl
  3743 00001C09 00D0                    	add	al, dl	
  3744 00001C0B D0D8                    	rcr	al, 1
  3745 00001C0D 2C80                    	sub	al, 80h
  3746 00001C0F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3747 00001C13 66AB                    	stosw		; interpolated sample (L)
  3748 00001C15 66AB                    	stosw		; interpolated sample (R)
  3749 00001C17 C3                      	retn
  3750                                  
  3751                                  interpolating_2_8bit_stereo:
  3752                                  	; 16/11/2023
  3753                                  	; al = [previous_val_l]
  3754                                  	; ah = [previous_val_r]
  3755                                  	; dl = [next_val_l]
  3756                                  	; dh = [next_val_r]	
  3757                                  	; original-interpolated
  3758 00001C18 89C3                    	mov	ebx, eax
  3759 00001C1A 2C80                    	sub	al, 80h
  3760 00001C1C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3761 00001C20 66AB                    	stosw		; original sample (L)
  3762 00001C22 88F8                    	mov	al, bh
  3763 00001C24 2C80                    	sub	al, 80h
  3764 00001C26 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3765 00001C2A 66AB                    	stosw		; original sample (R)
  3766 00001C2C 88D8                    	mov	al, bl	; [previous_val_l]
  3767 00001C2E 00D0                    	add	al, dl	; [next_val_l]	
  3768 00001C30 D0D8                    	rcr	al, 1
  3769 00001C32 2C80                    	sub	al, 80h
  3770 00001C34 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3771 00001C38 66AB                    	stosw		; interpolated sample (L)
  3772 00001C3A 88F8                    	mov	al, bh
  3773 00001C3C 00F0                    	add	al, dh	; [next_val_r]
  3774 00001C3E D0D8                    	rcr	al, 1
  3775 00001C40 2C80                    	sub	al, 80h
  3776 00001C42 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3777 00001C46 66AB                    	stosw		; interpolated sample (R)
  3778 00001C48 C3                      	retn
  3779                                  
  3780                                  interpolating_3_16bit_mono:
  3781                                  	; 16/11/2023
  3782                                  	; ax = [previous_val]
  3783                                  	; dx = [next_val]
  3784                                  	; original-interpolated-interpolated
  3785                                  
  3786 00001C49 66AB                    	stosw		; original sample (L)
  3787 00001C4B 66AB                    	stosw		; original sample (R)
  3788 00001C4D 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3789 00001C50 50                      	push	eax ; *	; [previous_val]
  3790 00001C51 80C680                  	add	dh, 80h
  3791 00001C54 6601D0                  	add	ax, dx
  3792 00001C57 66D1D8                  	rcr	ax, 1
  3793 00001C5A 5B                      	pop	ebx ; *		
  3794 00001C5B 93                      	xchg	ebx, eax ; bx  = interpolated middle (temporary)
  3795 00001C5C 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  3796 00001C5F 66D1D8                  	rcr	ax, 1
  3797 00001C62 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3798 00001C65 66AB                    	stosw 		; interpolated sample 1 (L)
  3799 00001C67 66AB                    	stosw		; interpolated sample 1 (R)
  3800 00001C69 89D8                    	mov	eax, ebx
  3801 00001C6B 6601D0                  	add	ax, dx	 ;interpolated middle + [next_val]
  3802 00001C6E 66D1D8                  	rcr	ax, 1
  3803 00001C71 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3804 00001C74 66AB                    	stosw		; interpolated sample 2 (L)
  3805 00001C76 66AB                    	stosw		; interpolated sample 2 (R)
  3806 00001C78 C3                      	retn
  3807                                  
  3808                                  interpolating_3_16bit_stereo:
  3809                                  	; 16/11/2023
  3810                                  	; bx = [previous_val_l]
  3811                                  	; ax = [previous_val_r]
  3812                                  	; [next_val_l]
  3813                                  	; dx = [next_val_r]
  3814                                  	; original-interpolated-interpolated
  3815                                  
  3816 00001C79 93                      	xchg	eax, ebx
  3817 00001C7A 66AB                    	stosw		; original sample (L)
  3818 00001C7C 93                      	xchg	eax, ebx
  3819 00001C7D 66AB                    	stosw		; original sample (R)
  3820 00001C7F 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3821 00001C82 50                      	push	eax ; *	; [previous_val_r]
  3822 00001C83 80C780                  	add	bh, 80h
  3823 00001C86 8005[C2200000]80        	add	byte [next_val_l+1], 80h
  3824 00001C8D 66A1[C1200000]          	mov	ax, [next_val_l]
  3825 00001C93 6601D8                  	add	ax, bx	; [previous_val_l]
  3826 00001C96 66D1D8                  	rcr	ax, 1
  3827 00001C99 93                      	xchg	eax, ebx ; ax = [previous_val_l]	
  3828 00001C9A 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  3829 00001C9D 66D1D8                  	rcr	ax, 1
  3830 00001CA0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3831 00001CA3 66AB                    	stosw 		; interpolated sample 1 (L)
  3832 00001CA5 58                      	pop	eax  ; *
  3833 00001CA6 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  3834 00001CA9 52                      	push	edx  ; * ; [next_val_r]
  3835 00001CAA 92                      	xchg	eax, edx
  3836 00001CAB 6601D0                  	add	ax, dx	; [next_val_r] + [previous_val_r]
  3837 00001CAE 66D1D8                  	rcr	ax, 1	; / 2
  3838 00001CB1 50                      	push	eax ; ** ; interpolated middle (R)
  3839 00001CB2 6601D0                  	add	ax, dx	; + [previous_val_r]
  3840 00001CB5 66D1D8                  	rcr	ax, 1
  3841 00001CB8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3842 00001CBB 66AB                    	stosw 		; interpolated sample 1 (R)
  3843 00001CBD 66A1[C1200000]          	mov	ax, [next_val_l]
  3844 00001CC3 6601D8                  	add	ax, bx	; + interpolated middle (L)
  3845 00001CC6 66D1D8                  	rcr	ax, 1
  3846 00001CC9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3847 00001CCC 66AB                    	stosw 		; interpolated sample 2 (L)
  3848 00001CCE 58                      	pop	eax ; **
  3849 00001CCF 5A                      	pop	edx ; *	
  3850 00001CD0 6601D0                  	add	ax, dx	; interpolated middle + [next_val_r]
  3851 00001CD3 66D1D8                  	rcr	ax, 1	; / 2
  3852 00001CD6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3853 00001CD9 66AB                    	stosw 		; interpolated sample 2 (L)
  3854 00001CDB C3                      	retn
  3855                                  
  3856                                  interpolating_2_16bit_mono:
  3857                                  	; 16/11/2023
  3858                                  	; ax = [previous_val]
  3859                                  	; dx = [next_val]
  3860                                  	; original-interpolated
  3861                                  
  3862 00001CDC 66AB                    	stosw		; original sample (L)
  3863 00001CDE 66AB                    	stosw		; original sample (R)
  3864 00001CE0 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3865 00001CE3 80C680                  	add	dh, 80h
  3866 00001CE6 6601D0                  	add	ax, dx
  3867 00001CE9 66D1D8                  	rcr	ax, 1
  3868 00001CEC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3869 00001CEF 66AB                    	stosw		; interpolated sample (L)
  3870 00001CF1 66AB                    	stosw		; interpolated sample (R)
  3871 00001CF3 C3                      	retn
  3872                                  
  3873                                  interpolating_2_16bit_stereo:
  3874                                  	; 16/11/2023
  3875                                  	; bx = [previous_val_l]
  3876                                  	; ax = [previous_val_r]
  3877                                  	; [next_val_l]
  3878                                  	; dx = [next_val_r]
  3879                                  	; original-interpolated
  3880                                  
  3881 00001CF4 93                      	xchg	eax, ebx
  3882 00001CF5 66AB                    	stosw		; original sample (L)
  3883 00001CF7 93                      	xchg	eax, ebx
  3884 00001CF8 66AB                    	stosw		; original sample (R)
  3885 00001CFA 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3886 00001CFD 80C680                  	add	dh, 80h
  3887 00001D00 6601D0                  	add	ax, dx	; [previous_val_r] + [next_val_r]
  3888 00001D03 66D1D8                  	rcr	ax, 1	; / 2
  3889 00001D06 50                      	push	eax ; *	; interpolated sample (R)
  3890 00001D07 66A1[C1200000]          	mov	ax, [next_val_l]
  3891 00001D0D 80C480                  	add	ah, 80h
  3892 00001D10 80C780                  	add	bh, 80h
  3893 00001D13 6601D8                  	add	ax, bx	; [next_val_l] + [previous_val_l]
  3894 00001D16 66D1D8                  	rcr	ax, 1	; / 2		
  3895 00001D19 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3896 00001D1C 66AB                    	stosw 		; interpolated sample (L)
  3897 00001D1E 58                      	pop	eax ; *	
  3898 00001D1F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3899 00001D22 66AB                    	stosw 		; interpolated sample (R)
  3900 00001D24 C3                      	retn
  3901                                  
  3902                                  interpolating_5_8bit_mono:
  3903                                  	; 17/11/2023
  3904                                  	; al = [previous_val]
  3905                                  	; dl = [next_val]
  3906                                  	; original-interpltd-interpltd-interpltd-interpltd
  3907 00001D25 88C3                    	mov	bl, al
  3908 00001D27 2C80                    	sub	al, 80h
  3909 00001D29 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3910 00001D2D 66AB                    	stosw		; original sample (L)
  3911 00001D2F 66AB                    	stosw		; original sample (R)
  3912 00001D31 88D8                    	mov	al, bl
  3913 00001D33 00D0                    	add	al, dl	
  3914 00001D35 D0D8                    	rcr	al, 1
  3915 00001D37 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3916 00001D39 00D8                    	add	al, bl  ; [previous_val]
  3917 00001D3B D0D8                    	rcr	al, 1 	
  3918 00001D3D 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  3919 00001D3F 00D8                    	add	al, bl
  3920 00001D41 D0D8                    	rcr	al, 1
  3921 00001D43 2C80                    	sub	al, 80h
  3922 00001D45 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3923 00001D49 66AB                    	stosw		; interpolated sample 1 (L)
  3924 00001D4B 66AB                    	stosw		; interpolated sample 1 (R)
  3925 00001D4D 88F8                    	mov	al, bh
  3926 00001D4F 00F0                    	add	al, dh
  3927 00001D51 D0D8                    	rcr	al, 1
  3928 00001D53 2C80                    	sub	al, 80h
  3929 00001D55 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3930 00001D59 66AB                    	stosw		; interpolated sample 2 (L)
  3931 00001D5B 66AB                    	stosw		; interpolated sample 2 (R)
  3932 00001D5D 88F8                    	mov	al, bh
  3933 00001D5F 00D0                    	add	al, dl	; [next_val]
  3934 00001D61 D0D8                    	rcr	al, 1
  3935 00001D63 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  3936 00001D65 00F8                    	add	al, bh
  3937 00001D67 D0D8                    	rcr	al, 1
  3938 00001D69 2C80                    	sub	al, 80h
  3939 00001D6B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3940 00001D6F 66AB                    	stosw		; interpolated sample 3 (L)
  3941 00001D71 66AB                    	stosw		; interpolated sample 3 (R)
  3942 00001D73 88F0                    	mov	al, dh
  3943 00001D75 00D0                    	add	al, dl
  3944 00001D77 D0D8                    	rcr	al, 1
  3945 00001D79 2C80                    	sub	al, 80h
  3946 00001D7B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3947 00001D7F 66AB                    	stosw		; interpolated sample 4 (L)
  3948 00001D81 66AB                    	stosw		; interpolated sample 4 (R)
  3949 00001D83 C3                      	retn
  3950                                  
  3951                                  interpolating_5_8bit_stereo:
  3952                                  	; 17/11/2023
  3953                                  	; al = [previous_val_l]
  3954                                  	; ah = [previous_val_r]
  3955                                  	; dl = [next_val_l]
  3956                                  	; dh = [next_val_r]	
  3957                                  	; original-interpltd-interpltd-interpltd-interpltd
  3958 00001D84 89C3                    	mov	ebx, eax
  3959 00001D86 2C80                    	sub	al, 80h
  3960 00001D88 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3961 00001D8C 66AB                    	stosw		; original sample (L)
  3962 00001D8E 88F8                    	mov	al, bh
  3963 00001D90 2C80                    	sub	al, 80h
  3964 00001D92 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3965 00001D96 66AB                    	stosw		; original sample (R)
  3966 00001D98 52                      	push	edx ; *
  3967 00001D99 88D8                    	mov	al, bl
  3968 00001D9B 00D0                    	add	al, dl	; [next_val_l]
  3969 00001D9D D0D8                    	rcr	al, 1
  3970 00001D9F 50                      	push	eax ; **	; al = interpolated middle (L) (temporary)
  3971 00001DA0 00D8                    	add	al, bl	; [previous_val_l]
  3972 00001DA2 D0D8                    	rcr	al, 1
  3973 00001DA4 86D8                    	xchg	al, bl	
  3974 00001DA6 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3975 00001DA8 D0D8                    	rcr	al, 1
  3976 00001DAA 2C80                    	sub	al, 80h
  3977 00001DAC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3978 00001DB0 66AB                    	stosw		; interpolated sample 1 (L)
  3979 00001DB2 88F8                    	mov	al, bh
  3980 00001DB4 00F0                    	add	al, dh	; [next_val_r]
  3981 00001DB6 D0D8                    	rcr	al, 1
  3982 00001DB8 50                      	push	eax ; *** ; al = interpolated middle (R) (temporary)
  3983 00001DB9 00F8                    	add	al, bh	; [previous_val_r]
  3984 00001DBB D0D8                    	rcr	al, 1
  3985 00001DBD 86F8                    	xchg	al, bh	
  3986 00001DBF 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3987 00001DC1 D0D8                    	rcr	al, 1
  3988 00001DC3 2C80                    	sub	al, 80h
  3989 00001DC5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3990 00001DC9 66AB                    	stosw		; interpolated sample 1 (R)
  3991 00001DCB 5A                      	pop	edx ; ***
  3992 00001DCC 58                      	pop	eax ; **	; al = interpolated middle (L) (temporary)
  3993 00001DCD 86D8                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3994 00001DCF 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  3995 00001DD1 D0D8                    	rcr	al, 1
  3996 00001DD3 2C80                    	sub	al, 80h
  3997 00001DD5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3998 00001DD9 66AB                    	stosw		; interpolated sample 2 (L)	
  3999 00001DDB 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  4000 00001DDD 86F8                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  4001 00001DDF 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  4002 00001DE1 D0D8                    	rcr	al, 1
  4003 00001DE3 2C80                    	sub	al, 80h
  4004 00001DE5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4005 00001DE9 66AB                    	stosw		; interpolated sample 2 (R)
  4006 00001DEB 5A                      	pop	edx ; *
  4007 00001DEC 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  4008 00001DEE 00D0                    	add	al, dl	; [next_val_l]
  4009 00001DF0 D0D8                    	rcr	al, 1
  4010 00001DF2 86D8                    	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  4011 00001DF4 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  4012 00001DF6 D0D8                    	rcr	al, 1
  4013 00001DF8 2C80                    	sub	al, 80h
  4014 00001DFA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4015 00001DFE 66AB                    	stosw		; interpolated sample 3 (L)
  4016 00001E00 88F8                    	mov	al, bh	
  4017 00001E02 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  4018 00001E04 D0D8                    	rcr	al, 1
  4019 00001E06 86F8                    	xchg	al, bh	; al = interpolated middle (R)
  4020 00001E08 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  4021 00001E0A D0D8                    	rcr	al, 1
  4022 00001E0C 2C80                    	sub	al, 80h
  4023 00001E0E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4024 00001E12 66AB                    	stosw		; interpolated sample 3 (R)
  4025 00001E14 88D8                    	mov	al, bl
  4026 00001E16 00D0                    	add	al, dl	; [next_val_l]
  4027 00001E18 D0D8                    	rcr	al, 1
  4028 00001E1A 2C80                    	sub	al, 80h
  4029 00001E1C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4030 00001E20 66AB                    	stosw		; interpolated sample 4 (L)
  4031 00001E22 88F8                    	mov	al, bh
  4032 00001E24 00F0                    	add	al, dh	; [next_val_r]
  4033 00001E26 D0D8                    	rcr	al, 1
  4034 00001E28 2C80                    	sub	al, 80h
  4035 00001E2A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4036 00001E2E 66AB                    	stosw		; interpolated sample 4 (R)
  4037 00001E30 C3                      	retn
  4038                                  
  4039                                  interpolating_4_8bit_mono:
  4040                                  	; 17/11/2023
  4041                                  	; al = [previous_val]
  4042                                  	; dl = [next_val]
  4043                                  	; original-interpolated-interpolated-interpolated
  4044 00001E31 88C3                    	mov	bl, al
  4045 00001E33 2C80                    	sub	al, 80h
  4046 00001E35 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4047 00001E39 66AB                    	stosw		; original sample (L)
  4048 00001E3B 66AB                    	stosw		; original sample (R)
  4049 00001E3D 88D8                    	mov	al, bl
  4050 00001E3F 00D0                    	add	al, dl	
  4051 00001E41 D0D8                    	rcr	al, 1
  4052 00001E43 86D8                    	xchg	al, bl  ; al = [previous_val]
  4053 00001E45 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  4054 00001E47 D0D8                    	rcr	al, 1 	
  4055 00001E49 2C80                    	sub	al, 80h
  4056 00001E4B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4057 00001E4F 66AB                    	stosw		; interpolated sample 1 (L)
  4058 00001E51 66AB                    	stosw		; interpolated sample 1 (R)
  4059 00001E53 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  4060 00001E55 2C80                    	sub	al, 80h
  4061 00001E57 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4062 00001E5B 66AB                    	stosw		; interpolated sample 2 (L)
  4063 00001E5D 66AB                    	stosw		; interpolated sample 2 (R)
  4064 00001E5F 88D8                    	mov	al, bl
  4065 00001E61 00D0                    	add	al, dl	; [next_val]
  4066 00001E63 D0D8                    	rcr	al, 1
  4067 00001E65 2C80                    	sub	al, 80h
  4068 00001E67 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4069 00001E6B 66AB                    	stosw		; interpolated sample 3 (L)
  4070 00001E6D 66AB                    	stosw		; interpolated sample 3 (R)
  4071 00001E6F C3                      	retn
  4072                                  
  4073                                  interpolating_4_8bit_stereo:
  4074                                  	; 17/11/2023
  4075                                  	; al = [previous_val_l]
  4076                                  	; ah = [previous_val_r]
  4077                                  	; dl = [next_val_l]
  4078                                  	; dh = [next_val_r]	
  4079                                  	; original-interpolated-interpolated-interpolated
  4080 00001E70 89C3                    	mov	ebx, eax
  4081 00001E72 2C80                    	sub	al, 80h
  4082 00001E74 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4083 00001E78 66AB                    	stosw		; original sample (L)
  4084 00001E7A 88F8                    	mov	al, bh
  4085 00001E7C 2C80                    	sub	al, 80h
  4086 00001E7E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4087 00001E82 66AB                    	stosw		; original sample (R)
  4088 00001E84 88D8                    	mov	al, bl
  4089 00001E86 00D0                    	add	al, dl	; [next_val_l]
  4090 00001E88 D0D8                    	rcr	al, 1
  4091 00001E8A 86D8                    	xchg	al, bl	; al = [previous_val_l]
  4092 00001E8C 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  4093 00001E8E D0D8                    	rcr	al, 1
  4094 00001E90 2C80                    	sub	al, 80h
  4095 00001E92 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4096 00001E96 66AB                    	stosw		; interpolated sample 1 (L)
  4097 00001E98 88F8                    	mov	al, bh
  4098 00001E9A 00F0                    	add	al, dh	; [next_val_r]
  4099 00001E9C D0D8                    	rcr	al, 1
  4100 00001E9E 86F8                    	xchg	al, bh	; al = [previous_val_h]
  4101 00001EA0 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  4102 00001EA2 D0D8                    	rcr	al, 1
  4103 00001EA4 2C80                    	sub	al, 80h
  4104 00001EA6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4105 00001EAA 66AB                    	stosw		; interpolated sample 1 (R)
  4106 00001EAC 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  4107 00001EAE 2C80                    	sub	al, 80h
  4108 00001EB0 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4109 00001EB4 66AB                    	stosw		; interpolated sample 2 (L)
  4110 00001EB6 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  4111 00001EB8 2C80                    	sub	al, 80h
  4112 00001EBA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4113 00001EBE 66AB                    	stosw		; interpolated sample 2 (L)
  4114 00001EC0 88D8                    	mov	al, bl
  4115 00001EC2 00D0                    	add	al, dl	; [next_val_l]
  4116 00001EC4 D0D8                    	rcr	al, 1
  4117 00001EC6 2C80                    	sub	al, 80h
  4118 00001EC8 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4119 00001ECC 66AB                    	stosw		; interpolated sample 3 (L)
  4120 00001ECE 88F8                    	mov	al, bh
  4121 00001ED0 00F0                    	add	al, dh	; [next_val_r]
  4122 00001ED2 D0D8                    	rcr	al, 1
  4123 00001ED4 2C80                    	sub	al, 80h
  4124 00001ED6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4125 00001EDA 66AB                    	stosw		; interpolated sample 3 (R)
  4126 00001EDC C3                      	retn
  4127                                  
  4128                                  interpolating_5_16bit_mono:
  4129                                  	; 18/11/2023
  4130                                  	; ax = [previous_val]
  4131                                  	; dx = [next_val]
  4132                                  	; original-interpltd-interpltd-interpltd-interpltd
  4133 00001EDD 66AB                    	stosw		; original sample (L)
  4134 00001EDF 66AB                    	stosw		; original sample (R)
  4135 00001EE1 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4136 00001EE4 89C3                    	mov	ebx, eax ; [previous_val]
  4137 00001EE6 80C680                  	add	dh, 80h
  4138 00001EE9 6601D0                  	add	ax, dx
  4139 00001EEC 66D1D8                  	rcr	ax, 1
  4140 00001EEF 50                      	push	eax ; *	; interpolated middle (temporary)
  4141 00001EF0 6601D8                  	add	ax, bx	; interpolated middle + [previous_val] 
  4142 00001EF3 66D1D8                  	rcr	ax, 1
  4143 00001EF6 50                      	push	eax ; **	; interpolated 1st quarter (temporary)
  4144 00001EF7 6601D8                  	add	ax, bx	; 1st quarter + [previous_val]
  4145 00001EFA 66D1D8                  	rcr	ax, 1	
  4146 00001EFD 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4147 00001F00 66AB                    	stosw 		; interpolated sample 1 (L)
  4148 00001F02 66AB                    	stosw		; interpolated sample 1 (R)
  4149 00001F04 58                      	pop	eax ; **	
  4150 00001F05 5B                      	pop	ebx ; *
  4151 00001F06 6601D8                  	add	ax, bx	; 1st quarter + middle
  4152 00001F09 66D1D8                  	rcr	ax, 1	; / 2
  4153 00001F0C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  4154 00001F0F 66AB                    	stosw		; interpolated sample 2 (L)
  4155 00001F11 66AB                    	stosw		; interpolated sample 2 (R)		
  4156 00001F13 89D8                    	mov	eax, ebx
  4157 00001F15 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4158 00001F18 66D1D8                  	rcr	ax, 1
  4159 00001F1B 50                      	push	eax ; *	; interpolated 3rd quarter (temporary)
  4160 00001F1C 6601D8                  	add	ax, bx	; + interpolated middle
  4161 00001F1F 66D1D8                  	rcr	ax, 1
  4162 00001F22 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4163 00001F25 66AB                    	stosw		; interpolated sample 3 (L)
  4164 00001F27 66AB                    	stosw		; interpolated sample 3 (R)
  4165 00001F29 58                      	pop	eax ; *	
  4166 00001F2A 6601D0                  	add	ax, dx	; 3rd quarter + [next_val]
  4167 00001F2D 66D1D8                  	rcr	ax, 1	; / 2
  4168 00001F30 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4169 00001F33 66AB                    	stosw		; interpolated sample 4 (L)
  4170 00001F35 66AB                    	stosw		; interpolated sample 4 (R)
  4171 00001F37 C3                      	retn
  4172                                  
  4173                                  interpolating_5_16bit_stereo:
  4174                                  	; 18/11/2023
  4175                                  	; bx = [previous_val_l]
  4176                                  	; ax = [previous_val_r]
  4177                                  	; [next_val_l]
  4178                                  	; [next_val_r]
  4179                                  	; original-interpltd-interpltd-interpltd-interpltd
  4180 00001F38 51                      	push	ecx ; !
  4181 00001F39 93                      	xchg	eax, ebx
  4182 00001F3A 66AB                    	stosw		; original sample (L)
  4183 00001F3C 93                      	xchg	eax, ebx
  4184 00001F3D 66AB                    	stosw		; original sample (R)
  4185 00001F3F 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4186 00001F42 50                      	push	eax ; *	; [previous_val_r]
  4187 00001F43 80C780                  	add	bh, 80h
  4188 00001F46 8005[C2200000]80        	add	byte [next_val_l+1], 80h
  4189 00001F4D 66A1[C1200000]          	mov	ax, [next_val_l]
  4190 00001F53 6601D8                  	add	ax, bx	; [previous_val_l]
  4191 00001F56 66D1D8                  	rcr	ax, 1
  4192 00001F59 89C1                    	mov	ecx, eax ; interpolated middle (L)
  4193 00001F5B 6601D8                  	add	ax, bx	
  4194 00001F5E 66D1D8                  	rcr	ax, 1
  4195 00001F61 89C2                    	mov	edx, eax ; interpolated 1st quarter (L)	
  4196 00001F63 6601D8                  	add	ax, bx	; [previous_val_l]
  4197 00001F66 66D1D8                  	rcr	ax, 1
  4198 00001F69 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4199 00001F6C 66AB                    	stosw 		; interpolated sample 1 (L)
  4200 00001F6E 89C8                    	mov	eax, ecx
  4201 00001F70 6601D0                  	add	ax, dx	; middle (L) + 1st quarter (L) 
  4202 00001F73 66D1D8                  	rcr	ax, 1	; / 2
  4203 00001F76 89C3                    	mov	ebx, eax  ; interpolated sample 2 (L)
  4204 00001F78 5A                      	pop	edx ; *	; [previous_val_r]
  4205 00001F79 89D0                    	mov	eax, edx
  4206 00001F7B 8005[C4200000]80        	add	byte [next_val_r+1], 80h
  4207 00001F82 660305[C3200000]        	add	ax, [next_val_r]
  4208 00001F89 66D1D8                  	rcr	ax, 1
  4209 00001F8C 50                      	push	eax ; *	; interpolated middle (R)
  4210 00001F8D 6601D0                  	add	ax, dx
  4211 00001F90 66D1D8                  	rcr	ax, 1
  4212 00001F93 50                      	push	eax ; ** ; interpolated 1st quarter (R)
  4213 00001F94 6601D0                  	add	ax, dx	; [previous_val_r]
  4214 00001F97 66D1D8                  	rcr	ax, 1
  4215 00001F9A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4216 00001F9D 66AB                    	stosw 		; interpolated sample 1 (R)
  4217 00001F9F 89D8                    	mov	eax, ebx
  4218 00001FA1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4219 00001FA4 66AB                    	stosw 		; interpolated sample 2 (L)
  4220 00001FA6 58                      	pop	eax ; **
  4221 00001FA7 5A                      	pop	edx ; *
  4222 00001FA8 6601D0                  	add	ax, dx	; 1st quarter (R) + middle (R)
  4223 00001FAB 66D1D8                  	rcr	ax, 1	; / 2
  4224 00001FAE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4225 00001FB1 66AB                    	stosw 		; interpolated sample 2 (R)
  4226 00001FB3 89C8                    	mov	eax, ecx
  4227 00001FB5 660305[C1200000]        	add	ax, [next_val_l]
  4228 00001FBC 66D1D8                  	rcr	ax, 1
  4229 00001FBF 50                      	push	eax ; * ; interpolated 3rd quarter (L)
  4230 00001FC0 6601C8                  	add	ax, cx	; interpolated middle (L)
  4231 00001FC3 66D1D8                  	rcr	ax, 1
  4232 00001FC6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4233 00001FC9 66AB                    	stosw 		; interpolated sample 3 (L)
  4234 00001FCB 89D0                    	mov	eax, edx
  4235 00001FCD 660305[C3200000]        	add	ax, [next_val_r]
  4236 00001FD4 66D1D8                  	rcr	ax, 1
  4237 00001FD7 50                      	push	eax ; ** ; interpolated 3rd quarter (R)
  4238 00001FD8 6601D0                  	add	ax, dx	; interpolated middle (R)
  4239 00001FDB 66D1D8                  	rcr	ax, 1
  4240 00001FDE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4241 00001FE1 66AB                    	stosw 		; interpolated sample 3 (R)
  4242 00001FE3 5B                      	pop	ebx ; **
  4243 00001FE4 58                      	pop	eax ; *
  4244 00001FE5 660305[C1200000]        	add	ax, [next_val_l]
  4245 00001FEC 66D1D8                  	rcr	ax, 1
  4246 00001FEF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4247 00001FF2 66AB                    	stosw 		; interpolated sample 4 (L)
  4248 00001FF4 89D8                    	mov	eax, ebx	
  4249 00001FF6 660305[C3200000]        	add	ax, [next_val_r]
  4250 00001FFD 66D1D8                  	rcr	ax, 1
  4251 00002000 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4252 00002003 66AB                    	stosw 		; interpolated sample 4 (R)
  4253 00002005 59                      	pop	ecx ; !
  4254 00002006 C3                      	retn
  4255                                  
  4256                                  interpolating_4_16bit_mono:
  4257                                  	; 18/11/2023
  4258                                  	; ax = [previous_val]
  4259                                  	; dx = [next_val]
  4260                                  	; original-interpolated
  4261                                  
  4262 00002007 66AB                    	stosw		; original sample (L)
  4263 00002009 66AB                    	stosw		; original sample (R)
  4264 0000200B 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4265 0000200E 89C3                    	mov	ebx, eax ; [previous_val]
  4266 00002010 80C680                  	add	dh, 80h
  4267 00002013 6601D0                  	add	ax, dx	; [previous_val] + [next_val]
  4268 00002016 66D1D8                  	rcr	ax, 1
  4269 00002019 93                      	xchg	eax, ebx	
  4270 0000201A 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  4271 0000201D 66D1D8                  	rcr	ax, 1
  4272 00002020 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4273 00002023 66AB                    	stosw 		; interpolated sample 1 (L)
  4274 00002025 66AB                    	stosw		; interpolated sample 1 (R)
  4275 00002027 89D8                    	mov	eax, ebx ; interpolated middle
  4276 00002029 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4277 0000202C 66AB                    	stosw 		; interpolated sample 2 (L)
  4278 0000202E 66AB                    	stosw		; interpolated sample 2 (R)
  4279 00002030 89D8                    	mov	eax, ebx
  4280 00002032 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4281 00002035 66D1D8                  	rcr	ax, 1
  4282 00002038 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4283 0000203B 66AB                    	stosw		; interpolated sample 3 (L)
  4284 0000203D 66AB                    	stosw		; interpolated sample 3 (R)
  4285 0000203F C3                      	retn
  4286                                  
  4287                                  interpolating_4_16bit_stereo:
  4288                                  	; 18/11/2023
  4289                                  	; bx = [previous_val_l]
  4290                                  	; ax = [previous_val_r]
  4291                                  	; [next_val_l]
  4292                                  	; [next_val_r]
  4293                                  	; original-interpolated-interpolated-interpolated
  4294 00002040 93                      	xchg	eax, ebx
  4295 00002041 66AB                    	stosw		; original sample (L)
  4296 00002043 93                      	xchg	eax, ebx
  4297 00002044 66AB                    	stosw		; original sample (R)
  4298 00002046 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4299 00002049 89C2                    	mov	edx, eax ; [previous_val_r]
  4300 0000204B 80C780                  	add	bh, 80h
  4301 0000204E 8005[C2200000]80        	add	byte [next_val_l+1], 80h
  4302 00002055 66A1[C1200000]          	mov	ax, [next_val_l]
  4303 0000205B 6601D8                  	add	ax, bx	; [previous_val_l]
  4304 0000205E 66D1D8                  	rcr	ax, 1
  4305 00002061 93                      	xchg	eax, ebx	
  4306 00002062 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  4307 00002065 66D1D8                  	rcr	ax, 1
  4308 00002068 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4309 0000206B 66AB                    	stosw 		; interpolated sample 1 (L)
  4310 0000206D 8005[C4200000]80        	add	byte [next_val_r+1], 80h
  4311 00002074 89D0                    	mov	eax, edx ; [previous_val_r]
  4312 00002076 660305[C3200000]        	add	ax, [next_val_r]
  4313 0000207D 66D1D8                  	rcr	ax, 1
  4314 00002080 92                      	xchg	eax, edx	
  4315 00002081 6601D0                  	add	ax, dx	; dx = interpolated middle (R)
  4316 00002084 66D1D8                  	rcr	ax, 1
  4317 00002087 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4318 0000208A 66AB                    	stosw 		; interpolated sample 1 (R)
  4319 0000208C 89D8                    	mov	eax, ebx
  4320 0000208E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4321 00002091 66AB                    	stosw 		; interpolated sample 2 (L)
  4322 00002093 89D0                    	mov	eax, edx
  4323 00002095 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4324 00002098 66AB                    	stosw 		; interpolated sample 2 (R)
  4325 0000209A 89D8                    	mov	eax, ebx
  4326 0000209C 660305[C1200000]        	add	ax, [next_val_l]
  4327 000020A3 66D1D8                  	rcr	ax, 1
  4328 000020A6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4329 000020A9 66AB                    	stosw 		; interpolated sample 3 (L)
  4330 000020AB 89D0                    	mov	eax, edx
  4331 000020AD 660305[C3200000]        	add	ax, [next_val_r]
  4332 000020B4 66D1D8                  	rcr	ax, 1
  4333 000020B7 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4334 000020BA 66AB                    	stosw 		; interpolated sample 3 (R)
  4335 000020BC C3                      	retn
  4336                                  
  4337                                  ; 13/11/2023
  4338                                  previous_val:
  4339 000020BD 0000                    previous_val_l: dw 0
  4340 000020BF 0000                    previous_val_r: dw 0
  4341                                  next_val:
  4342 000020C1 0000                    next_val_l: dw 0
  4343 000020C3 0000                    next_val_r: dw 0
  4344                                  
  4345                                  ; 16/11/2023
  4346 000020C5 00                      faz:	db 0	
  4347                                  	
  4348                                  ;=============================================================================
  4349                                  ;	gfx.asm - draw scopes in VGA 640x480x16 mode      
  4350                                  ;=============================================================================
  4351                                  
  4352                                  ; EX1A.ASM (21/6/1994, Carlos Hasan; MSDOS, 'RUNME.EXE', 'TNYPL211')
  4353                                  
  4354                                  ;-----------------------------------------------------------------------------
  4355                                  ; setgraphmode - setup the VGA 640x480x16 graphics mode
  4356                                  ;-----------------------------------------------------------------------------
  4357                                  	; 22/10/2017
  4358                                  setgraphmode:
  4359                                  	;pushad
  4360 000020C6 66B81200                	mov	ax,0012h
  4361                                  	;int	10h
  4362 000020CA CD31                    	int 	31h
  4363 000020CC 66BAC003                	mov	dx,3C0h
  4364 000020D0 30C0                    	xor	al,al
  4365                                  setgraphmodel0:
  4366                                  	;out	dx,al
  4367 000020D2 B401                    	mov	ah, 1 ; outb
  4368 000020D4 CD34                    	int	34h
  4369                                  	;out	dx, al
  4370                                  	;mov	ah, 1
  4371 000020D6 CD34                    	int	34h
  4372 000020D8 FEC0                    	inc	al
  4373 000020DA 3C10                    	cmp	al, 10h
  4374 000020DC 72F4                    	jb	short setgraphmodel0
  4375 000020DE B020                    	mov	al, 20h
  4376                                  	;out	dx, al
  4377                                  	;mov	ah, 1
  4378 000020E0 CD34                    	int	34h
  4379                                  	;popad
  4380 000020E2 C3                      	retn
  4381                                  
  4382                                  ;-----------------------------------------------------------------------------
  4383                                  ; settextmode - restore the VGA 80x25x16 text mode
  4384                                  ;-----------------------------------------------------------------------------
  4385                                  	; 22/10/2017
  4386                                  settextmode:
  4387                                  	;pushad
  4388 000020E3 66B80300                	mov	ax, 0003h
  4389                                  	;int	10h
  4390 000020E7 CD31                    	int	31h
  4391                                  	;popad
  4392 000020E9 C3                      	retn
  4393                                  
  4394                                  ;-----------------------------------------------------------------------------
  4395                                  ; drawscopes - draw the track voices sample scopes
  4396                                  ; In:
  4397                                  ;  ESI = (current) sample buffer
  4398                                  ;-----------------------------------------------------------------------------
  4399                                  	; 29/10/2017
  4400                                  	; 28/10/2017
  4401                                  	; (ESI = Current DMA buffer offset)
  4402                                  	; 27/10/2017
  4403                                  	; 26/10/2017
  4404                                  	; 23/10/2017
  4405                                  drawscopes:
  4406                                  	;pushad
  4407                                    	;mov	esi, g_buff
  4408                                  	;mov	esi, edx
  4409 000020EA 31C9                    	xor     ecx, ecx	
  4410 000020EC 31D2                    	xor     edx, edx
  4411 000020EE 31FF                    	xor	edi, edi
  4412                                  drawscope0:
  4413 000020F0 66AD                    	lodsw
  4414 000020F2 80F480                  	xor	ah, 80h
  4415 000020F5 0FB6DC                  	movzx	ebx, ah  ; Left Channel
  4416 000020F8 66D1E3                  	shl	bx, 1
  4417 000020FB 668B83[C0680000]        	mov	ax, [RowOfs+ebx]
  4418 00002102 668987[C06A0000]        	mov	[NewScope_L+edi], ax
  4419 00002109 30FF                    	xor	bh, bh
  4420 0000210B 66AD                    	lodsw
  4421 0000210D 80F480                  	xor	ah, 80h
  4422 00002110 88E3                    	mov	bl, ah	; Right Channel
  4423 00002112 66D1E3                  	shl	bx, 1
  4424 00002115 668B83[C0680000]        	mov	ax, [RowOfs+ebx]
  4425 0000211C 668987[C06C0000]        	mov	[NewScope_R+edi], ax
  4426 00002123 6683C702                	add	di, 2
  4427 00002127 FEC1                    	inc	cl
  4428 00002129 75C5                    	jnz	short drawscope0	
  4429                                  
  4430 0000212B 66BAC403                        mov	dx, 3C4h
  4431                                          ;mov	ax, 0802h
  4432                                          ;out	dx, ax
  4433 0000212F 66BB0208                        mov	bx, 0802h
  4434 00002133 B403                    	mov	ah, 3 ; outw
  4435 00002135 CD34                    	int	34h
  4436 00002137 66BACE03                	mov	dx, 3CEh
  4437 0000213B B008                            mov	al, 08h
  4438                                         ;out	dx, al
  4439 0000213D B401                            mov	ah, 1 ; outb
  4440 0000213F CD34                    	int	34h
  4441 00002141 6642                    	inc	dx
  4442                                  
  4443                                  	; 26/10/2017
  4444 00002143 31F6                            xor	esi, esi
  4445                                         ;xor	edi, edi
  4446 00002145 BB45060A00                      mov     ebx, 0A0645h
  4447                                  drawscopel4:
  4448 0000214A B080                            mov     al, 80h
  4449                                  drawscopel2:
  4450 0000214C 50                              push    eax ; *
  4451 0000214D 52                              push    edx ; **
  4452                                  	;out	dx, al
  4453 0000214E B401                    	mov	ah, 1 ; outb
  4454 00002150 CD34                    	int	34h
  4455                                  
  4456 00002152 B4FF                            mov	ah, 0FFh
  4457                                          ;mov	ecx, 32
  4458 00002154 B120                    	mov	cl, 32
  4459 00002156 28C0                    	sub     al, al
  4460                                  drawscopel3:
  4461                                  	; 23/10/2017
  4462 00002158 668B96[C06E0000]                mov	dx, [OldScope_L+esi]
  4463 0000215F 663B96[C06A0000]                cmp	dx, [NewScope_L+esi]
  4464 00002166 7414                            je	short drawscopef3
  4465 00002168 88041A                          mov	[edx+ebx], al ; L
  4466 0000216B 668B96[C06A0000]                mov     dx, [NewScope_L+esi]
  4467 00002172 88241A                  	mov	[edx+ebx], ah ; L
  4468 00002175 668996[C06E0000]                mov     [OldScope_L+esi], dx
  4469                                  drawscopef3:
  4470                                  	; 27/10/2017
  4471 0000217C 668B96[C0700000]                mov	dx, [OldScope_R+esi]
  4472 00002183 663B96[C06C0000]                cmp	dx, [NewScope_R+esi]
  4473 0000218A 7416                            je	short drawscopef4
  4474 0000218C 88441A26                	mov	[edx+ebx+38], al ; R
  4475 00002190 668B96[C06C0000]                mov     dx, [NewScope_R+esi]
  4476 00002197 88641A26                        mov	[edx+ebx+38], ah ; R
  4477 0000219B 668996[C0700000]                mov     [OldScope_R+esi], dx
  4478                                  drawscopef4:
  4479 000021A2 83C610                  	add	esi, 2*8
  4480 000021A5 43                      	inc	ebx
  4481 000021A6 E2B0                    	loop    drawscopel3
  4482                                  
  4483 000021A8 5A                              pop     edx ; **
  4484 000021A9 58                              pop     eax ; *
  4485 000021AA 81EEFE010000            	sub	esi, 2*256-2
  4486 000021B0 83EB20                  	sub	ebx, 32
  4487 000021B3 D0E8                            shr     al, 1
  4488 000021B5 7595                            jnz	short drawscopel2
  4489                                  	;popad
  4490 000021B7 C3                              retn
  4491                                  
  4492                                  ;=============================================================================
  4493                                  ;	Load IFF/ILBM files for VGA 640x480x16 graphics mode       
  4494                                  ;=============================================================================
  4495                                  
  4496                                  ; EX1B.ASM (21/6/1994, Carlos Hasan; MSDOS, 'RUNME.EXE', 'TNYPL211')
  4497                                  
  4498                                  ; 21/10/2017 (TRDOS 386, 'tmodplay.s', Erdogan Tan, NASM syntax)
  4499                                  
  4500                                  ;-----------------------------------------------------------------------------
  4501                                  ; EQUATES AND STRUCTURES
  4502                                  ;-----------------------------------------------------------------------------
  4503                                  
  4504                                  ID_FORM equ 4D524F46h		; IFF/ILBM chunk IDs
  4505                                  ID_ILBM equ 4D424C49h
  4506                                  ID_BMHD equ 44484D42h
  4507                                  ID_CMAP equ 50414D43h
  4508                                  ID_BODY equ 59444F42h
  4509                                  
  4510                                  struc Form			; IFF/ILBM header file format
  4511 00000000 ????????                  .ID:		resd 1
  4512 00000004 ????????                  .Length:	resd 1
  4513 00000008 ????????                  .Type:	resd 1
  4514                                    .size:
  4515                                  endstruc
  4516                                  
  4517                                  struc Chunk			; IFF/ILBM header chunk format
  4518 00000000 ????????                  .ID:		resd 1
  4519 00000004 ????????                  .Length:	resd 1
  4520                                    .size:	
  4521                                  endstruc
  4522                                  
  4523                                  struc BMHD			; IFF/ILBM BMHD chunk format
  4524 00000000 ????                      .Width: 	resw 1
  4525 00000002 ????                      .Height:	resw 1
  4526 00000004 ????                      .PosX:	resw 1
  4527 00000006 ????                      .PosY:	resw 1
  4528 00000008 ??                        .Planes:	resb 1
  4529 00000009 ??                        .Masking:	resb 1
  4530 0000000A ??                        .Compression:	resb 1
  4531 0000000B ??                        .Pad:		resb 1
  4532 0000000C ????                      .Transparent:	resw 1
  4533 0000000E ??                        .AspectX	resb 1
  4534 0000000F ??                        .AspectY:	resb 1
  4535 00000010 ????                      .PageWidth:	resw 1
  4536 00000012 ????                      .PageHeight:	resw 1
  4537                                    .size:	
  4538                                  endstruc
  4539                                  
  4540                                  struc CMAP			; IFF/ILBM CMAP chunk format
  4541 00000000 <res 300h>                .Colors:	resb 768
  4542                                    .size:	
  4543                                  endstruc
  4544                                  
  4545                                  ;LOGO_ADDRESS	equ 100000h	; virtual address at the end of the 1st 1MB
  4546                                  
  4547                                  ;------------------------------------------------------------------------------
  4548                                  ; bswap - macro to reverse the byte order of a 32-bit register, converting
  4549                                  ;         a value in little/big endian form to big/little endian form.
  4550                                  ;------------------------------------------------------------------------------
  4551                                  %macro	bswap   1
  4552                                          xchg    al, ah
  4553                                          rol     eax, 16
  4554                                          xchg    al, ah
  4555                                  %endmacro
  4556                                  
  4557                                  ;------------------------------------------------------------------------------
  4558                                  ; putlbm - draw the IFF/ILBM picture on VGA 640x480x16 graphics mode
  4559                                  ; In:
  4560                                  ;  ESI = IFF/ILBM image file address
  4561                                  ;------------------------------------------------------------------------------
  4562                                  putlbm:
  4563 000021B8 60                              pushad
  4564                                  
  4565                                  ; check if this is a valid IFF/ILBM Deluxe Paint file
  4566                                  
  4567 000021B9 813E464F524D                    cmp     dword [esi+Form.ID], ID_FORM
  4568 000021BF 7551                            jne     short putlbmd0
  4569 000021C1 817E08494C424D                  cmp     dword [esi+Form.Type], ID_ILBM
  4570 000021C8 7548                            jne     short putlbmd0
  4571                                  
  4572                                  ; get the IFF/ILBM file length in bytes
  4573                                  
  4574 000021CA 8B4604                          mov     eax, [esi+Form.Length]
  4575                                          bswap   eax
  4552 000021CD 86E0                <1>  xchg al, ah
  4553 000021CF C1C010              <1>  rol eax, 16
  4554 000021D2 86E0                <1>  xchg al, ah
  4576 000021D4 89C1                            mov     ecx, eax
  4577                                  
  4578                                  ; decrease the file length and update the file pointer
  4579                                  
  4580 000021D6 83E904                          sub     ecx, 4
  4581 000021D9 83C60C                          add     esi, Form.size
  4582                                  
  4583                                  ; IFF/ILBM main parser body loop
  4584                                  
  4585                                  putlbml0:
  4586 000021DC 85C9                            test    ecx, ecx
  4587 000021DE 7E64                            jle     short putlbmd1
  4588                                  
  4589                                  ; get the next chunk ID and length in bytes
  4590                                  
  4591 000021E0 8B1E                            mov     ebx, [esi+Chunk.ID]
  4592 000021E2 8B4604                          mov     eax, [esi+Chunk.Length]
  4593                                          bswap   eax
  4552 000021E5 86E0                <1>  xchg al, ah
  4553 000021E7 C1C010              <1>  rol eax, 16
  4554 000021EA 86E0                <1>  xchg al, ah
  4594 000021EC 93                              xchg    ebx, eax
  4595 000021ED 83C608                          add     esi, Chunk.size
  4596                                  
  4597                                  ; word align the chunk length and decrease the file length counter
  4598                                  
  4599 000021F0 43                              inc     ebx
  4600 000021F1 80E3FE                          and     bl, 0FEh ; ~1
  4601 000021F4 83E908                          sub     ecx, Chunk.size
  4602 000021F7 29D9                            sub     ecx, ebx
  4603                                  
  4604                                  ; check for the BMHD/CMAP/BODY chunk headers
  4605                                  
  4606 000021F9 3D424D4844                      cmp     eax, ID_BMHD
  4607 000021FE 7415                            je      short putlbmf0
  4608 00002200 3D434D4150                      cmp     eax, ID_CMAP
  4609 00002205 7440                            je      short putlbmf1
  4610 00002207 3D424F4459                      cmp     eax, ID_BODY
  4611 0000220C 7455                            je      short putlbmf2
  4612                                  
  4613                                  ; advance to the next IFF/ILBM chunk structure
  4614                                  
  4615                                  putlbmc0:
  4616 0000220E 01DE                            add     esi, ebx
  4617 00002210 EBCA                            jmp     short putlbml0
  4618                                  
  4619                                  putlbmd0:
  4620 00002212 F9                              stc
  4621 00002213 61                              popad
  4622 00002214 C3                              retn
  4623                                  
  4624                                  ; process the BMHD bitmap header chunk
  4625                                  
  4626                                  putlbmf0:
  4627 00002215 807E0804                        cmp     byte [esi+BMHD.Planes], 4
  4628 00002219 75F7                            jne     short putlbmd0
  4629 0000221B 807E0A01                        cmp     byte [esi+BMHD.Compression], 1
  4630 0000221F 75F1                            jne     short putlbmd0
  4631 00002221 807E0B00                        cmp     byte [esi+BMHD.Pad], 0
  4632 00002225 75EB                            jne     short putlbmd0
  4633 00002227 0FB706                          movzx   eax, word [esi+BMHD.Width]
  4634 0000222A 86E0                            xchg    al, ah
  4635 0000222C 83C007                          add     eax, 7
  4636 0000222F C1E803                          shr     eax, 3
  4637 00002232 A3[20680000]                    mov     [picture.width], eax
  4638 00002237 0FB74602                        movzx   eax, word [esi+BMHD.Height]
  4639 0000223B 86E0                            xchg    al, ah
  4640 0000223D A3[24680000]                    mov     [picture.height], eax
  4641 00002242 EBCA                            jmp     short putlbmc0
  4642                                  
  4643                                  putlbmd1:
  4644 00002244 F8                              clc
  4645 00002245 61                              popad
  4646 00002246 C3                              retn
  4647                                  
  4648                                  ; process the CMAP colormap chunk
  4649                                  
  4650                                  putlbmf1:
  4651 00002247 66BAC803                        mov     dx, 3C8h
  4652 0000224B 30C0                            xor     al, al
  4653                                          ;out	dx, al
  4654 0000224D B401                    	mov	ah, 1 ; outb
  4655 0000224F CD34                    	int	34h
  4656 00002251 6642                            inc     dx
  4657                                  putlbml1:
  4658 00002253 8A06                            mov     al, [esi]
  4659 00002255 C0E802                          shr     al, 2
  4660                                          ;out	dx, al
  4661                                  	;mov	ah, 1 ; outb
  4662 00002258 CD34                    	int	34h ; IOCTL interrupt (IN/OUT)
  4663 0000225A 46                              inc     esi
  4664 0000225B 4B                              dec     ebx
  4665 0000225C 7FF5                            jg      short putlbml1
  4666 0000225E E979FFFFFF                      jmp     putlbml0
  4667                                  
  4668                                  ; process the BODY bitmap body chunk
  4669                                  
  4670                                  putlbmf2:
  4671 00002263 60                              pushad
  4672 00002264 BF00000A00                      mov     edi, 0A0000h
  4673                                          ;cld
  4674 00002269 66BACE03                        mov     dx, 3CEh
  4675                                          ;mov	ax, 0FF08h
  4676                                          ;out	dx, ax
  4677 0000226D 66BB08FF                	mov	bx, 0FF08h
  4678 00002271 B403                    	mov	ah, 3 ; outw
  4679 00002273 CD34                    	int	34h ; IOCTL interrupt (IN/OUT)
  4680 00002275 66BAC403                        mov     dx, 3C4h
  4681 00002279 B002                            mov     al, 02h
  4682                                          ;out	dx, al
  4683 0000227B B401                    	mov	ah, 1 ; outb
  4684 0000227D CD34                    	int	34h ; IOCTL interrupt (IN/OUT)
  4685 0000227F 6642                            inc     dx
  4686 00002281 8B0D[24680000]                  mov     ecx, [picture.height]
  4687                                  putlbml2:
  4688 00002287 51                              push    ecx
  4689 00002288 B011                            mov     al, 11h
  4690                                  putlbml3:
  4691 0000228A 50                              push    eax
  4692 0000228B 57                              push    edi
  4693                                          ;out	dx, al
  4694 0000228C B401                    	mov	ah, 1 ; outb
  4695 0000228E CD34                    	int	34h ; IOCTL interrupt (IN/OUT)
  4696 00002290 8B1D[20680000]                  mov     ebx, [picture.width]
  4697                                  putlbml4:
  4698 00002296 AC                              lodsb
  4699 00002297 84C0                            test    al, al
  4700 00002299 7C0A                            jl      short putlbmf3
  4701 0000229B 0FB6C8                          movzx   ecx, al
  4702 0000229E 41                              inc     ecx
  4703 0000229F 29CB                            sub     ebx, ecx
  4704 000022A1 F3A4                            rep     movsb
  4705 000022A3 EB0B                            jmp     short putlbmc4
  4706                                  putlbmf3:
  4707 000022A5 F6D8                            neg     al
  4708 000022A7 0FB6C8                          movzx   ecx, al
  4709 000022AA 41                              inc     ecx
  4710 000022AB 29CB                            sub     ebx, ecx
  4711 000022AD AC                              lodsb
  4712 000022AE F3AA                            rep     stosb
  4713                                  putlbmc4:
  4714 000022B0 85DB                            test    ebx, ebx
  4715 000022B2 7FE2                            jg      short putlbml4
  4716 000022B4 5F                              pop     edi
  4717 000022B5 58                              pop     eax
  4718 000022B6 00C0                            add     al, al
  4719 000022B8 73D0                            jnc     short putlbml3
  4720 000022BA 83C750                          add     edi, 80
  4721 000022BD 59                              pop     ecx
  4722 000022BE E2C7                            loop    putlbml2
  4723 000022C0 61                      	popad
  4724 000022C1 E948FFFFFF                      jmp	putlbmc0
  4725                                  
  4726                                  ; EX1.C (Carlos Hasan, 21/06/1994)
  4727                                  ;------------------------------------------------------------------------------
  4728                                  ; loadlbm - load the IFF/ILBM image file ("LOGO.LBM") at memory
  4729                                  ;  ESI = IFF/ILBM image file address
  4730                                  ;------------------------------------------------------------------------------
  4731                                  
  4732                                  ;if ((Logo = loadlbm("LOGO.LBM")) == NULL) {
  4733                                  ;       printf("Error loading the IFF/ILBM logo picture\n");
  4734                                  ;       MODStopModule();
  4735                                  ;       MODFreeModule(Song);
  4736                                  ;       return;
  4737                                  ;   }
  4738                                  ;   setgraphmode();
  4739                                  ;   putlbm(Logo);
  4740                                  ;   while (!kbhit())
  4741                                  ;       drawscopes(Song->NumTracks);
  4742                                  ;   settextmode();
  4743                                  ;   free(Logo);
  4744                                  ;   MODStopModule();
  4745                                  ;   MODFreeModule(Song);
  4746                                  
  4747                                  ;loadlbm:
  4748                                  ;	; ebx = ASCIIZ file name address
  4749                                  ;	; ecx = open mode (0 = open for read)	
  4750                                  ;	sys	_open, LOGO_FILE_NAME, 0 ; open for reading
  4751                                  ;	jc	short loadlbm_retn
  4752                                  ;
  4753                                  ;	mov     [LBM_FileHandle], eax
  4754                                  ;
  4755                                  ;	; get file size by moving file pointer to the end of file
  4756                                  ;	; ebx = file handle/number
  4757                                  ;	; ecx : offset = 0
  4758                                  ;	; edx : switch = 2 (move fp to end of file + offset)
  4759                                  ;	sys	_seek, eax, 0, 2
  4760                                  ;	jc	short loadlbm_cf
  4761                                  ;
  4762                                  ;	mov	[LBM_FileSize], eax
  4763                                  ;
  4764                                  ;	; move file pointer to the beginning of the file
  4765                                  ;	; ecx = 0
  4766                                  ;	; edx = 0
  4767                                  ;	;xor	ecx, ecx
  4768                                  ; 	xor	dl, dl
  4769                                  ;	; ebx = [LBM_FileHandle]
  4770                                  ;	sys	_seek
  4771                                  ;	;jc	short loadlbm_cf
  4772                                  ;
  4773                                  ;	; ebx = File handle
  4774                                  ;	; ecx = Buffer address
  4775                                  ;	; edx = Byte count
  4776                                  ;	;sys	_read, [LBM_FileHandle], LOGO_ADDRESS, [LBM_FileSize]
  4777                                  ;	mov	ecx, LOGO_ADDRESS
  4778                                  ;	mov	edx, [LBM_FileSize]
  4779                                  ;	sys	_read
  4780                                  ;	jc	short loadlbm_cf
  4781                                  ;
  4782                                  ;	cmp	eax, edx  ; read count = file size ?
  4783                                  ;	;jb	short loadlbm_cf		 
  4784                                  ;loadlbm_cf:
  4785                                  ;	pushf
  4786                                  ;	sys	_close, [LBM_FileHandle]	
  4787                                  ;	popf
  4788                                  ;loadlbm_retn:
  4789                                  ;	retn	
  4790                                  ;
  4791                                  ;LOGO_FILE_NAME:
  4792                                  ;	db	"LOGO.LBM", 0
  4793                                  
  4794                                  LOGO_ERROR_MSG:
  4795 000022C6 4572726F72206C6F61-     	db	"Error loading the IFF/ILBM logo picture !", 0Dh, 0Ah, 0 
  4795 000022CF 64696E672074686520-
  4795 000022D8 4946462F494C424D20-
  4795 000022E1 6C6F676F2070696374-
  4795 000022EA 75726520210D0A00   
  4796                                  
  4797                                  align 2
  4798                                  ; 22/10/2017
  4799                                  LOGO_ADDRESS:
  4800                                  ;incbin "LOGO.LBM"	  	 
  4801                                  ; 27/10/2017
  4802 000022F2 <bin 4298h>             incbin "TINYPLAY.LBM"
  4803                                  
  4804                                  ;=============================================================================
  4805                                  ;               preinitialized data
  4806                                  ;=============================================================================
  4807                                  	
  4808 0000658A 00                      	db	0
  4809                                  	; 23/08/2020
  4810                                  FileHandle:	
  4811 0000658B FFFFFFFF                	dd	-1
  4812 0000658F 00                      	db	0
  4813                                  Credits:
  4814                                  msg_usage:
  4815                                  	; 09/12/2023
  4816 00006590 54696E792057415620-     	db	'Tiny WAV Player for TRDOS 386 by Erdogan Tan',10,13
  4816 00006599 506C6179657220666F-
  4816 000065A2 72205452444F532033-
  4816 000065AB 383620627920457264-
  4816 000065B4 6F67616E2054616E0A-
  4816 000065BD 0D                 
  4817 000065BE 666F7220496E74656C-     	db 	'for Intel AC97 (ICH) Audio Controller.',10,13
  4817 000065C7 204143393720284943-
  4817 000065D0 482920417564696F20-
  4817 000065D9 436F6E74726F6C6C65-
  4817 000065E2 722E0A0D           
  4818                                  	;db	'December 2023.',10,13
  4819 000065E6 446563656D62657220-     	db	'December 2024.',10,13
  4819 000065EF 323032342E0A0D     
  4820                                  credits_zero:
  4821 000065F6 0A0D                    	db	10,13
  4822 000065F8 75736167653A207477-     	db	'usage: twavplay filename.wav',10,13,0
  4822 00006601 6176706C6179206669-
  4822 0000660A 6C656E616D652E7761-
  4822 00006613 760A0D00           
  4823 00006617 32342F30382F323032-     	db	'24/08/2020',10,13,0
  4823 00006620 300A0D00           
  4824 00006624 30392F31322F323032-     	db	'09/12/2023',10,13,0
  4824 0000662D 330A0D00           
  4825 00006631 30382F31322F323032-     	db	'08/12/2024',10,13,0
  4825 0000663A 340A0D00           
  4826                                  
  4827                                  noDevMsg:
  4828                                  	; 09/12/2023
  4829 0000663E 4572726F723A20556E-     	db	'Error: Unable to find AC97 audio device!'
  4829 00006647 61626C6520746F2066-
  4829 00006650 696E64204143393720-
  4829 00006659 617564696F20646576-
  4829 00006662 69636521           
  4830 00006666 0A0D00                  	db	10,13,0
  4831                                  
  4832                                  noFileErrMsg:
  4833 00006669 4572726F723A206669-     	db	'Error: file not found.',10,13,0
  4833 00006672 6C65206E6F7420666F-
  4833 0000667B 756E642E0A0D00     
  4834                                  
  4835                                  trdos386_err_msg:
  4836 00006682 5452444F5320333836-     	db	'TRDOS 386 System call error !',10,13,0
  4836 0000668B 2053797374656D2063-
  4836 00006694 616C6C206572726F72-
  4836 0000669D 20210A0D00         
  4837                                  
  4838                                  ; 09/12/2023
  4839                                  msg_no_vra:
  4840 000066A2 0A0D                    	db	10,13
  4841 000066A4 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  4841 000066AD 70706F72742021204F-
  4841 000066B6 6E6C79203438206B48-
  4841 000066BF 5A2073616D706C6520-
  4841 000066C8 726174652073757070-
  4841 000066D1 6F727465642021     
  4842 000066D8 0A0D00                  	db	10,13,0
  4843                                  
  4844                                  ; 13/11/2016
  4845 000066DB 303132333435363738-     hex_chars:	db "0123456789ABCDEF", 0
  4845 000066E4 3941424344454600   
  4846                                  ;
  4847                                  msgAC97Info:	
  4848 000066EC 0D0A                    		db 0Dh, 0Ah
  4849 000066EE 414339372041756469-     		db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  4849 000066F7 6F20436F6E74726F6C-
  4849 00006700 6C6572202620436F64-
  4849 00006709 656320496E666F0D0A 
  4850 00006712 56656E646F72204944-     		db "Vendor ID: "
  4850 0000671B 3A20               
  4851 0000671D 303030306820446576-     msgVendorId:	db "0000h Device ID: "
  4851 00006726 6963652049443A20   
  4852 0000672E 30303030680D0A          msgDevId:	db "0000h", 0Dh, 0Ah
  4853 00006735 4275733A20              		db "Bus: "
  4854 0000673A 303068204465766963-     msgBusNo	db "00h Device: "
  4854 00006743 653A20             
  4855 00006746 3030682046756E6374-     msgDevNo	db "00h Function: "
  4855 0000674F 696F6E3A20         
  4856 00006754 303068                  msgFncNo	db "00h"
  4857 00006757 0D0A                    		db 0Dh, 0Ah
  4858                                  ; 09/12/2023
  4859 00006759 4E414D4241523A20        		db "NAMBAR: "
  4860 00006761 30303030682020          msgNamBar	db "0000h  "
  4861 00006768 4E41424D4241523A20      		db "NABMBAR: "
  4862 00006771 303030306820204952-     msgNabmBar	db "0000h  IRQ: "
  4862 0000677A 513A20             
  4863 0000677D 3030                    msgIRQ		dw 3030h
  4864 0000677F 0D0A00                  		db 0Dh, 0Ah, 0
  4865                                  
  4866 00006782 0D0A5741562046696C-     msgWavFileName:	db 0Dh, 0Ah, "WAV File Name: ",0
  4866 0000678B 65204E616D653A2000 
  4867 00006794 0D0A53616D706C6520-     msgSampleRate:	db 0Dh, 0Ah, "Sample Rate: "
  4867 0000679D 526174653A20       
  4868 000067A3 303030303020487A2C-     msgHertz:	db "00000 Hz, ", 0 
  4868 000067AC 2000               
  4869 000067AE 3820626974732C2000      msg8Bits:	db "8 bits, ", 0 
  4870 000067B7 4D6F6E6F0D0A00          msgMono:	db "Mono", 0Dh, 0Ah, 0
  4871 000067BE 313620626974732C20-     msg16Bits:	db "16 bits, ", 0 
  4871 000067C7 00                 
  4872 000067C8 53746572656F            msgStereo:	db "Stereo"
  4873 000067CE 0D0A00                  nextline:	db 0Dh, 0Ah, 0
  4874                                  
  4875                                  ; 09/12/2023
  4876 000067D1 56524120737570706F-     msgVRAheader:	db "VRA support: "
  4876 000067DA 72743A20           
  4877 000067DE 00                      		db 0	
  4878 000067DF 5945530D0A00            msgVRAyes:	db "YES", 0Dh, 0Ah, 0
  4879 000067E5 4E4F200D0A              msgVRAno:	db "NO ", 0Dh, 0Ah
  4880 000067EA 28496E746572706F6C-     		db "(Interpolated sample rate playing method)"
  4880 000067F3 617465642073616D70-
  4880 000067FC 6C6520726174652070-
  4880 00006805 6C6179696E67206D65-
  4880 0000680E 74686F6429         
  4881 00006813 0D0A00                  		db 0Dh, 0Ah, 0
  4882                                  
  4883                                  ;=============================================================================
  4884                                  ;		uninitialized data
  4885                                  ;=============================================================================
  4886                                  
  4887                                  ; 23/08/2020
  4888                                  
  4889                                  ; BSS
  4890                                  
  4891                                  bss_start:
  4892                                  
  4893                                  ABSOLUTE bss_start
  4894                                  
  4895 00006816 ????                    alignb 4
  4896                                  
  4897                                  ;------------------------------------------------------------------------------
  4898                                  ; IFF/ILBM DATA
  4899                                  ;------------------------------------------------------------------------------
  4900                                  
  4901 00006818 ????????                LBM_FileHandle:	resd 1
  4902 0000681C ????????                LBM_FileSize:	resd 1
  4903                                  ;
  4904 00006820 ????????                picture.width:	resd 1 		; current picture width and height
  4905 00006824 ????????                picture.height:	resd 1
  4906                                  
  4907                                  ;------------------------------------------------------------------------------
  4908                                  
  4909                                  ;alignb 4
  4910                                  
  4911 00006828 ??                      stmo:		resb 1 ; stereo or mono (1=stereo) 
  4912 00006829 ??                      bps:		resb 1 ; bits per sample (8,16)
  4913 0000682A ????                    sample_rate:	resw 1 ; Sample Frequency (Hz)
  4914                                  
  4915                                  ; 09/12/2023
  4916                                  ; 'playwav6.s' (27/11/2023)
  4917                                  ; .......
  4918                                  ; 25/11/2023
  4919 0000682C ????????                bufferSize:	resd 1
  4920                                  
  4921 00006830 <res 1Ch>               smpRBuff:	resw 14 
  4922                                  
  4923                                  wav_file_name:
  4924 0000684C <res 50h>               		resb 80 ; wave file, path name (<= 80 bytes)
  4925                                  ;alignb 4
  4926 0000689C ????                    		resw 1
  4927                                  
  4928 0000689E ??                      ac97_int_ln_reg: resb 1
  4929 0000689F ??                      fbs_shift:	resb 1 ; 26/11/2023
  4930                                  
  4931 000068A0 ????????                dev_vendor:	resd 1
  4932 000068A4 ????????                bus_dev_fn:	resd 1
  4933 000068A8 ????                    ac97_NamBar:	resw 1
  4934 000068AA ????                    ac97_NabmBar:	resw 1
  4935                                  
  4936 000068AC ??                      flags:		resb 1
  4937                                  ;half_buff:	resb 1
  4938 000068AD ??                      srb:		resb 1
  4939                                  ; 23/08/2020
  4940 000068AE ??                      counter:	resb 1
  4941                                  ; 18/08/2020
  4942 000068AF ??                      volume_level:	resb 1
  4943                                  ; 25/11/2023
  4944 000068B0 ??                      VRA:		resb 1	; Variable Rate Audio Support Status
  4945                                  ; 09/12/2023
  4946 000068B1 ??                      pan_shift:	resb 1
  4947                                  ; .......
  4948                                  
  4949 000068B2 <res Eh>                alignb 16
  4950                                  
  4951                                  ; PLAY.ASM
  4952                                  ;Scope:		resw 320
  4953 000068C0 <res 200h>              RowOfs:		resw 256
  4954                                  
  4955                                  ; 23/10/2017
  4956 00006AC0 <res 200h>              NewScope_L:	resw 256
  4957 00006CC0 <res 200h>              NewScope_R:	resw 256
  4958 00006EC0 <res 200h>              OldScope_L:	resw 256
  4959 000070C0 <res 200h>              OldScope_R:	resw 256
  4960                                  
  4961                                  ; 20/10/2017 (modplay7.s, SB16)
  4962                                  ; 19/10/2017 (modplay6.s, AC97)
  4963                                  ;pan_shift:	resb 1
  4964                                  ;volume_level:	resb 1
  4965                                  
  4966                                  ; 09/12/2023
  4967 000072C0 ????????                DMA_buffer_size: resd 1	
  4968                                  
  4969 000072C4 <res D3Ch>              alignb 4096
  4970                                  
  4971                                  ;audio_buffer:	resb BUFFERSIZE ; DMA Buffer Size / 2  (32768)
  4972                                  ; 09/12/2023
  4973 00008000 <res 10000h>            audio_buffer:	resb 65536
  4974                                  
  4975 00018000 <res 8000h>             alignb 65536
  4976                                  
  4977                                  ;DMA_Buffer:	resb 2*BUFFERSIZE  ; 65536 ; 09/10/2017
  4978                                  ; 09/12/2023
  4979 00020000 <res 20000h>            DMA_Buffer:	resb 2*65536
  4980                                   
  4981                                  ; 13/06/2017
  4982                                  ;temp_buffer:	resb BUFFERSIZE
  4983                                  ; 26/11/2023
  4984 00040000 <res 10000h>            temp_buffer:	resb 65536
  4985                                  
  4986                                  EOF:
