     1                                  ; ****************************************************************************
     2                                  ; twavply2.s (for TRDOS 386)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; TWAVPLY2.PRG ! AC'97 (ICH) WAV PLAYER & VGA DEMO program by Erdogan TAN
     5                                  ;
     6                                  ; 09/12/2023
     7                                  ;
     8                                  ; [ Last Modification: 27/12/2024 ]
     9                                  ;
    10                                  ; Modified from: twavplay.s (VIA VT8237R WAV PLAYER & VGA DEMO) program
    11                                  ;	         by Erdogan Tan (24/08/2020) 
    12                                  ;
    13                                  ; Modified from: 'playwav6.s' (AC'97 WAV player) source code
    14                                  ;		 by Erdogan Tan (27/11/2023)
    15                                  ; 
    16                                  ; Assembler: NASM 2.15
    17                                  ; ----------------------------------------------------------------------------
    18                                  ;	   nasm  twavplay.s -l twavplay.txt -o TWAVPLAY.PRG	
    19                                  ; ****************************************************************************
    20                                  
    21                                  ; 09/12/2023
    22                                  ; Modified from: twavplay.s (VIA VT8237R WAV PLAYER & VGA DEMO) program
    23                                  ;	         by Erdogan Tan (24/08/2020)
    24                                  
    25                                  ; 14/07/2020
    26                                  ; 31/12/2017
    27                                  ; TRDOS 386 (v2.0) system calls
    28                                  _ver 	equ 0
    29                                  _exit 	equ 1
    30                                  _fork 	equ 2
    31                                  _read 	equ 3
    32                                  _write	equ 4
    33                                  _open	equ 5
    34                                  _close 	equ 6
    35                                  _wait 	equ 7
    36                                  _create	equ 8
    37                                  _rename	equ 9
    38                                  _delete	equ 10
    39                                  _exec	equ 11
    40                                  _chdir	equ 12
    41                                  _time 	equ 13
    42                                  _mkdir 	equ 14
    43                                  _chmod	equ 15
    44                                  _rmdir	equ 16
    45                                  _break	equ 17
    46                                  _drive	equ 18
    47                                  _seek	equ 19
    48                                  _tell 	equ 20
    49                                  _memory	equ 21
    50                                  _prompt	equ 22
    51                                  _path	equ 23
    52                                  _env	equ 24
    53                                  _stime	equ 25
    54                                  _quit	equ 26
    55                                  _intr	equ 27
    56                                  _dir	equ 28
    57                                  _emt 	equ 29
    58                                  _ldrvt 	equ 30
    59                                  _video 	equ 31
    60                                  _audio	equ 32
    61                                  _timer	equ 33
    62                                  _sleep	equ 34
    63                                  _msg    equ 35
    64                                  _geterr	equ 36
    65                                  _fpstat	equ 37
    66                                  _pri	equ 38
    67                                  _rele	equ 39
    68                                  _fff	equ 40
    69                                  _fnf	equ 41
    70                                  _alloc	equ 42
    71                                  _dalloc equ 43
    72                                  _calbac equ 44
    73                                  _dma	equ 45		
    74                                  
    75                                  %macro sys 1-4
    76                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)	
    77                                      ; 03/09/2015	
    78                                      ; 13/04/2015
    79                                      ; Retro UNIX 386 v1 system call.	
    80                                      %if %0 >= 2   
    81                                          mov ebx, %2
    82                                          %if %0 >= 3    
    83                                              mov ecx, %3
    84                                              %if %0 = 4
    85                                                 mov edx, %4   
    86                                              %endif
    87                                          %endif
    88                                      %endif
    89                                      mov eax, %1
    90                                      ;int 30h
    91                                      int 40h ; TRDOS 386 (TRDOS v2.0)	   
    92                                  %endmacro
    93                                  
    94                                  ; TRDOS 386 (and Retro UNIX 386 v1) system call format:
    95                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
    96                                  
    97                                  ; 19/06/2017
    98                                  BUFFERSIZE equ 32768
    99                                  ; 23/08/2020
   100                                  ENDOFFILE equ 1	; flag for knowing end of file
   101                                  
   102                                  ; ----------------------------------------------------------------------------
   103                                  ; Tiny MOD Player v0.1b by Carlos Hasan.
   104                                  ;	July 14th, 1993.
   105                                  
   106                                  ;=============================================================================
   107                                  ;  
   108                                  ;=============================================================================
   109                                  
   110                                  [BITS 32]
   111                                  [org 0]
   112                                  
   113                                  Start:
   114                                  	; clear bss
   115 00000000 B9[00000500]            	mov	ecx, EOF
   116 00000005 BF[00680000]            	mov	edi, bss_start
   117 0000000A 29F9                    	sub	ecx, edi
   118 0000000C D1E9                    	shr	ecx, 1
   119 0000000E 31C0                    	xor	eax, eax
   120 00000010 F366AB                  	rep	stosw
   121                                  
   122                                  	; 09/12/2023
   123                                  	; Detect (& Enable) AC'97 Audio Device
   124 00000013 E8CE040000              	call	DetectAC97
   125 00000018 731B                    	jnc     short GetFileName
   126                                  
   127                                  _dev_not_ready:
   128                                  ; couldn't find the audio device!
   129                                  	sys	_msg, noDevMsg, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000001A BB[28660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000001F B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000024 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000029 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 0000002E CD40                <1>  int 40h
   130 00000030 E98B040000                      jmp     Exit
   131                                  
   132                                  GetFileName:
   133 00000035 89E6                    	mov	esi, esp
   134 00000037 AD                      	lodsd
   135 00000038 83F802                  	cmp	eax, 2 ; two arguments 
   136                                  		; (program file name & mod file name)
   137                                  	;jb	pmsg_usage ; nothing to do
   138                                  	; 09/12/2023
   139 0000003B 7305                    	jnb	short _x
   140 0000003D E98C040000              	jmp	pmsg_usage
   141                                  
   142                                  _x:
   143 00000042 AD                      	lodsd ; program file name address 
   144 00000043 AD                      	lodsd ; wav file name address (file to be read)
   145 00000044 89C6                    	mov	esi, eax
   146 00000046 BF[34680000]            	mov	edi, wav_file_name
   147                                  ScanName:       
   148 0000004B AC                      	lodsb
   149 0000004C 84C0                    	test	al, al
   150                                  	;jz	pmsg_usage
   151                                  	; 09/12/2023
   152 0000004E 7505                    	jnz	short _y
   153 00000050 E979040000              	jmp	pmsg_usage
   154                                  _y:
   155 00000055 3C20                    	cmp	al, 20h
   156 00000057 74F2                    	je	short ScanName	; scan start of name.
   157 00000059 AA                      	stosb
   158 0000005A B4FF                    	mov	ah, 0FFh
   159                                  a_0:	
   160 0000005C FEC4                    	inc	ah
   161                                  a_1:
   162 0000005E AC                      	lodsb
   163 0000005F AA                      	stosb
   164 00000060 3C2E                    	cmp	al, '.'
   165 00000062 74F8                    	je	short a_0	
   166 00000064 20C0                    	and	al, al
   167 00000066 75F6                    	jnz	short a_1
   168                                  
   169 00000068 08E4                    	or	ah, ah		 ; if period NOT found,
   170 0000006A 750B                    	jnz	short PrintPMesg ; then add a .MOD extension.
   171                                  SetExt:
   172 0000006C 4F                      	dec	edi
   173 0000006D C7072E574156            	mov	dword [edi], '.WAV'
   174 00000073 C6470400                	mov	byte [edi+4], 0
   175                                  PrintPMesg: 
   176                                  	; 23/08/2020
   177 00000077 C605[E0650000]00        	mov	byte [credits_zero], 0
   178                                       
   179                                  	; Prints the Credits Text.
   180                                  	sys	_msg, Credits, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000007E BB[7A650000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000083 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000088 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000008D B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000092 CD40                <1>  int 40h
   181                                  _1:
   182                                  	; 19/06/2017
   183                                  	; Allocate Audio Buffer (for user)
   184                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   185                                  	; 09/12/2023
   186                                  	sys	_audio, 0200h, [buffersize], audio_buffer
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000094 BB00020000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000099 8B0D[E1030000]      <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000009F BA[00800000]        <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000A4 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000000A9 CD40                <1>  int 40h
   187 000000AB 7218                    	jc	short error_exit
   188                                  _2:
   189                                  	; 23/08/2020
   190                                  	; Initialize Audio Device (bl = 1 -> Interrupt method)
   191                                  	;sys	_audio, 0301h, 0, audio_int_handler 
   192                                  	;jc	short error_exit
   193                                  	
   194                                  	; 24/08/2020
   195                                  
   196                                  	; 20/10/2017
   197                                  	; Initialize Audio Device (bl = 0 -> SRB method)
   198                                  	sys	_audio, 0300h, 1, srb
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000000AD BB00030000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000000B2 B901000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000000B7 BA[95680000]        <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000BC B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000000C1 CD40                <1>  int 40h
   199                                  	;jc	short error_exit
   200                                  	; 09/12/2023
   201 000000C3 731B                    	jnc	short open_wav_file
   202                                  
   203                                  error_exit:
   204                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000000C5 BB[6C660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000000CA B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000000CF BA0E000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000D4 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000000D9 CD40                <1>  int 40h
   205 000000DB E9E0030000              	jmp	Exit
   206                                  
   207                                  	; 09/12/2023
   208                                  open_wav_file:
   209                                  	; 23/08/2020
   210                                  
   211                                  ; open the wav file
   212                                          ; open existing file
   213 000000E0 E823040000                      call    openFile ; no error? ok.
   214 000000E5 731B                            jnc     short _3
   215                                  
   216                                  ; file not found!
   217                                  	sys	_msg, noFileErrMsg, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000000E7 BB[53660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000000EC B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000000F1 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000F6 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000000FB CD40                <1>  int 40h
   218                                  _z:
   219 000000FD E9BE030000                      jmp	Exit
   220                                  
   221                                  _3:
   222 00000102 E83B040000                     	call    getSampleRate	; read the sample rate
   223                                                               	; pass it onto codec.
   224                                  	;jc	Exit
   225                                  	; 09/12/2023
   226 00000107 72F4                    	jc	short _z
   227                                  
   228 00000109 66A3[12680000]          	mov	[sample_rate], ax
   229 0000010F 880D[10680000]          	mov	[stmo], cl
   230 00000115 8815[11680000]          	mov	[bps], dl
   231                                  
   232                                  	; 09/12/2023
   233                                  	; 'playwav6.s (27/11/2023)
   234                                  	
   235                                  	; 26/11/2023
   236 0000011B C605[87680000]00        	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit
   237 00000122 FEC9                    	dec	cl
   238 00000124 7506                    	jnz	short _gsr_1 ; stereo
   239 00000126 FE05[87680000]          	inc	byte [fbs_shift] ; 1 = mono or 8 bit
   240                                  _gsr_1:	
   241 0000012C 80FA08                  	cmp	dl, 8 
   242 0000012F 7706                    	ja	short _gsr_2 ; 16 bit samples
   243 00000131 FE05[87680000]          	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   244                                  _gsr_2:
   245                                  
   246                                  	; 10/06/2017
   247                                  	sys	_audio, 0E00h ; get audio controller info
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000137 BB000E0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000013C B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000141 CD40                <1>  int 40h
   248                                  	;jc	error_exit
   249                                  	; 09/12/2023
   250 00000143 7280                    	jc	short error_exit
   251                                  
   252                                  	; 09/12/2023
   253                                  	;cmp	ah, 2 ; ICH ? (Intel AC'97 Audio Controller)
   254                                  	;jne	_dev_not_ready		
   255                                  
   256                                  	; EAX = IRQ Number in AL
   257                                  	;	Audio Device Number in AH 
   258                                  	; EBX = DEV/VENDOR ID
   259                                  	;       (DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV)
   260                                  	; ECX = BUS/DEV/FN 
   261                                  	;       (00000000BBBBBBBBDDDDDFFF00000000)
   262                                  	; EDX = Base IO Addr (DX) for SB16 & VT8233
   263                                  	; EDX = NABMBAR/NAMBAR (for AC97)
   264                                  	;      (Low word, DX = NAMBAR address)
   265                                  
   266                                  	; 09/12/2023
   267 00000145 A2[86680000]            	mov	[ac97_int_ln_reg], al
   268 0000014A 891D[88680000]          	mov	[dev_vendor], ebx
   269 00000150 890D[8C680000]          	mov	[bus_dev_fn], ecx
   270                                  	;mov	[ac97_NamBar], dx
   271                                  	;shr	dx, 16
   272                                  	;mov	[ac97_NabmBar], dx
   273 00000156 8915[90680000]          	mov	[ac97_NamBar], edx	
   274                                  
   275                                  	; 09/12/2023  
   276 0000015C E800070000              	call	write_ac97_pci_dev_info
   277                                  	; 09/12/2023
   278 00000161 E8BB080000              	call	write_VRA_info
   279                                  
   280                                  	; 24/08/2020
   281 00000166 E82B060000              	call	write_wav_file_info
   282                                  
   283                                  ; 09/12/2023
   284                                  ; -----------------------------------
   285                                  ; 'playwav6.s' (27/11/2023)
   286                                  
   287 0000016B 803D[97680000]01        	cmp	byte [VRA], 1
   288 00000172 7205                    	jb	short chk_sample_rate
   289                                  
   290                                  playwav_48_khz:	
   291                                  	;mov	dword [loadfromwavfile], loadFromFile
   292                                  	;mov	dword [buffersize], 65536
   293 00000174 E96C020000              	jmp	PlayNow
   294                                  
   295                                  chk_sample_rate:
   296                                  	; set conversion parameters
   297                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   298 00000179 66A1[12680000]          	mov	ax, [sample_rate]
   299 0000017F 663D80BB                	cmp	ax, 48000
   300 00000183 74EF                    	je	short playwav_48_khz
   301                                  chk_22khz:
   302 00000185 663D2256                	cmp	ax, 22050
   303 00000189 7545                    	jne	short chk_11khz
   304 0000018B 803D[11680000]08        	cmp	byte [bps], 8
   305 00000192 7615                    	jna	short chk_22khz_1
   306 00000194 BB[A8160000]            	mov	ebx, load_22khz_stereo_16_bit
   307 00000199 803D[10680000]01        	cmp	byte [stmo], 1 
   308 000001A0 751A                    	jne	short chk_22khz_2
   309 000001A2 BB[1B160000]            	mov	ebx, load_22khz_mono_16_bit
   310 000001A7 EB13                    	jmp	short chk_22khz_2
   311                                  chk_22khz_1:
   312 000001A9 BB[94150000]            	mov	ebx, load_22khz_stereo_8_bit
   313 000001AE 803D[10680000]01        	cmp	byte [stmo], 1 
   314 000001B5 7505                    	jne	short chk_22khz_2
   315 000001B7 BB[0B150000]            	mov	ebx, load_22khz_mono_8_bit
   316                                  chk_22khz_2:
   317 000001BC B85A1D0000              	mov	eax, 7514  ; (442*17)
   318 000001C1 BA25000000              	mov	edx, 37
   319 000001C6 B911000000              	mov	ecx, 17 
   320 000001CB E9BA010000              	jmp	set_sizes	
   321                                  chk_11khz:
   322 000001D0 663D112B                	cmp	ax, 11025
   323 000001D4 7545                    	jne	short chk_44khz
   324 000001D6 803D[11680000]08        	cmp	byte [bps], 8
   325 000001DD 7615                    	jna	short chk_11khz_1
   326 000001DF BB[C4180000]            	mov	ebx, load_11khz_stereo_16_bit
   327 000001E4 803D[10680000]01        	cmp	byte [stmo], 1 
   328 000001EB 751A                    	jne	short chk_11khz_2
   329 000001ED BB[4B180000]            	mov	ebx, load_11khz_mono_16_bit
   330 000001F2 EB13                    	jmp	short chk_11khz_2
   331                                  chk_11khz_1:
   332 000001F4 BB[D1170000]            	mov	ebx, load_11khz_stereo_8_bit
   333 000001F9 803D[10680000]01        	cmp	byte [stmo], 1 
   334 00000200 7505                    	jne	short chk_11khz_2
   335 00000202 BB[59170000]            	mov	ebx, load_11khz_mono_8_bit
   336                                  chk_11khz_2:
   337 00000207 B8AD0E0000              	mov	eax, 3757  ; (221*17)
   338 0000020C BA4A000000              	mov	edx, 74
   339 00000211 B911000000              	mov	ecx, 17
   340 00000216 E96F010000              	jmp	set_sizes 
   341                                  chk_44khz:
   342 0000021B 663D44AC                	cmp	ax, 44100
   343 0000021F 7545                    	jne	short chk_16khz
   344 00000221 803D[11680000]08        	cmp	byte [bps], 8
   345 00000228 7615                    	jna	short chk_44khz_1
   346 0000022A BB[EB1A0000]            	mov	ebx, load_44khz_stereo_16_bit
   347 0000022F 803D[10680000]01        	cmp	byte [stmo], 1 
   348 00000236 751A                    	jne	short chk_44khz_2
   349 00000238 BB[721A0000]            	mov	ebx, load_44khz_mono_16_bit
   350 0000023D EB13                    	jmp	short chk_44khz_2
   351                                  chk_44khz_1:
   352 0000023F BB[F5190000]            	mov	ebx, load_44khz_stereo_8_bit
   353 00000244 803D[10680000]01        	cmp	byte [stmo], 1 
   354 0000024B 7505                    	jne	short chk_44khz_2
   355 0000024D BB[79190000]            	mov	ebx, load_44khz_mono_8_bit
   356                                  chk_44khz_2:
   357 00000252 B8D93A0000              	mov	eax, 15065 ; (655*23)
   358 00000257 BA19000000              	mov	edx, 25
   359 0000025C B917000000              	mov	ecx, 23
   360 00000261 E924010000              	jmp	set_sizes 
   361                                  chk_16khz:
   362 00000266 663D803E                	cmp	ax, 16000
   363 0000026A 7545                    	jne	short chk_8khz
   364 0000026C 803D[11680000]08        	cmp	byte [bps], 8
   365 00000273 7615                    	jna	short chk_16khz_1
   366 00000275 BB[50100000]            	mov	ebx, load_16khz_stereo_16_bit
   367 0000027A 803D[10680000]01        	cmp	byte [stmo], 1 
   368 00000281 751A                    	jne	short chk_16khz_2
   369 00000283 BB[CF0F0000]            	mov	ebx, load_16khz_mono_16_bit
   370 00000288 EB13                    	jmp	short chk_16khz_2
   371                                  chk_16khz_1:
   372 0000028A BB[150F0000]            	mov	ebx, load_16khz_stereo_8_bit
   373 0000028F 803D[10680000]01        	cmp	byte [stmo], 1 
   374 00000296 7505                    	jne	short chk_16khz_2
   375 00000298 BB[960E0000]            	mov	ebx, load_16khz_mono_8_bit
   376                                  chk_16khz_2:
   377 0000029D B855150000              	mov	eax, 5461
   378 000002A2 BA03000000              	mov	edx, 3
   379 000002A7 B901000000              	mov	ecx, 1
   380 000002AC E9D9000000              	jmp	set_sizes 
   381                                  chk_8khz:
   382 000002B1 663D401F                	cmp	ax, 8000
   383 000002B5 7545                    	jne	short chk_24khz
   384 000002B7 803D[11680000]08        	cmp	byte [bps], 8
   385 000002BE 7615                    	jna	short chk_8khz_1
   386 000002C0 BB[4B0D0000]            	mov	ebx, load_8khz_stereo_16_bit
   387 000002C5 803D[10680000]01        	cmp	byte [stmo], 1 
   388 000002CC 751A                    	jne	short chk_8khz_2
   389 000002CE BB[7B0C0000]            	mov	ebx, load_8khz_mono_16_bit
   390 000002D3 EB13                    	jmp	short chk_8khz_2
   391                                  chk_8khz_1:
   392 000002D5 BB[4B0B0000]            	mov	ebx, load_8khz_stereo_8_bit
   393 000002DA 803D[10680000]01        	cmp	byte [stmo], 1 
   394 000002E1 7505                    	jne	short chk_8khz_2
   395 000002E3 BB[6E0A0000]            	mov	ebx, load_8khz_mono_8_bit
   396                                  chk_8khz_2:
   397 000002E8 B8AA0A0000              	mov	eax, 2730
   398 000002ED BA06000000              	mov	edx, 6
   399 000002F2 B901000000              	mov	ecx, 1
   400 000002F7 E98E000000              	jmp	set_sizes 
   401                                  chk_24khz:
   402 000002FC 663DC05D                	cmp	ax, 24000
   403 00000300 7542                    	jne	short chk_32khz
   404 00000302 803D[11680000]08        	cmp	byte [bps], 8
   405 00000309 7615                    	jna	short chk_24khz_1
   406 0000030B BB[7A120000]            	mov	ebx, load_24khz_stereo_16_bit
   407 00000310 803D[10680000]01        	cmp	byte [stmo], 1 
   408 00000317 751A                    	jne	short chk_24khz_2
   409 00000319 BB[17120000]            	mov	ebx, load_24khz_mono_16_bit
   410 0000031E EB13                    	jmp	short chk_24khz_2
   411                                  chk_24khz_1:
   412 00000320 BB[8D110000]            	mov	ebx, load_24khz_stereo_8_bit
   413 00000325 803D[10680000]01        	cmp	byte [stmo], 1 
   414 0000032C 7505                    	jne	short chk_24khz_2
   415 0000032E BB[26110000]            	mov	ebx, load_24khz_mono_8_bit
   416                                  chk_24khz_2:
   417 00000333 B800200000              	mov	eax, 8192
   418 00000338 BA02000000              	mov	edx, 2
   419 0000033D B901000000              	mov	ecx, 1
   420 00000342 EB46                    	jmp	short set_sizes 
   421                                  chk_32khz:
   422 00000344 663D007D                	cmp	ax, 32000
   423 00000348 7574                    	jne	short vra_needed
   424 0000034A 803D[11680000]08        	cmp	byte [bps], 8
   425 00000351 7615                    	jna	short chk_32khz_1
   426 00000353 BB[7B140000]            	mov	ebx, load_32khz_stereo_16_bit
   427 00000358 803D[10680000]01        	cmp	byte [stmo], 1 
   428 0000035F 751A                    	jne	short chk_32khz_2
   429 00000361 BB[11140000]            	mov	ebx, load_32khz_mono_16_bit
   430 00000366 EB13                    	jmp	short chk_32khz_2
   431                                  chk_32khz_1:
   432 00000368 BB[74130000]            	mov	ebx, load_32khz_stereo_8_bit
   433 0000036D 803D[10680000]01        	cmp	byte [stmo], 1 
   434 00000374 7505                    	jne	short chk_32khz_2
   435 00000376 BB[01130000]            	mov	ebx, load_32khz_mono_8_bit
   436                                  chk_32khz_2:
   437 0000037B B8AA2A0000              	mov	eax, 10922
   438 00000380 BA03000000              	mov	edx, 3
   439 00000385 B902000000              	mov	ecx, 2
   440                                  	;jmp	short set_sizes 
   441                                  set_sizes:
   442 0000038A 803D[10680000]01        	cmp	byte [stmo], 1
   443 00000391 7402                    	je	short ss_1
   444 00000393 D1E0                    	shl	eax, 1
   445                                  ss_1:
   446 00000395 803D[11680000]08        	cmp	byte [bps], 8
   447 0000039C 7602                    	jna	short ss_2
   448                                  	; 16 bit samples
   449 0000039E D1E0                    	shl	eax, 1
   450                                  ss_2:
   451 000003A0 A3[DD030000]            	mov	[loadsize], eax
   452 000003A5 F7E2                    	mul	edx
   453                                  	;cmp	ecx, 1
   454                                  	;je	short ss_3
   455                                  ;ss_3:
   456 000003A7 F7F1                    	div	ecx
   457 000003A9 8A0D[87680000]          	mov	cl, [fbs_shift]
   458 000003AF D3E0                    	shl	eax, cl
   459                                  	; 26/11/2023
   460                                  	;shr	eax, 1	; buffer size is 16 bit sample count
   461 000003B1 A3[E1030000]            	mov	[buffersize], eax ; buffer size in bytes
   462 000003B6 891D[D9030000]          	mov	[loadfromwavfile], ebx
   463 000003BC EB27                    	jmp	short PlayNow
   464                                  
   465                                  vra_needed:
   466                                  	sys	_msg, msg_no_vra, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000003BE BB[8C660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000003C3 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000003C8 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000003CD B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000003D2 CD40                <1>  int 40h
   467 000003D4 E9E7000000              	jmp	Exit
   468                                  
   469                                  	; 26/11/2023
   470                                  	; 13/11/2023
   471                                  loadfromwavfile:
   472 000003D9 [A0050000]              	dd	loadFromFile
   473                                  loadsize:	; read from wav file
   474 000003DD 00000000                	dd	0
   475                                  buffersize:	; write to DMA buffer
   476 000003E1 00000100                	dd	65536 ; bytes
   477                                  
   478                                  ; -----------------------------------
   479                                  
   480                                  	; 23/08/2020
   481                                  PlayNow: 
   482                                  	; 27/10/2017
   483                                  	;mov	cx, 256
   484                                  	; 27/12/2024
   485 000003E5 B900010000              	mov	ecx, 256
   486 000003EA 31DB                    	xor	ebx, ebx
   487 000003EC BF[A0680000]            	mov	edi, RowOfs
   488                                  MakeOfs:
   489                                  	; 29/10/2017
   490                                  	;mov	ax, 128
   491                                  	;mul	bx
   492                                  	;mov	al, ah
   493                                  	;mov	ah, 80
   494                                  	;mul	ah
   495 000003F1 89D8                    	mov	eax, ebx
   496 000003F3 66C1E007                	shl	ax, 7 ; * 128
   497 000003F7 B050                    	mov	al, 80
   498 000003F9 F6E4                    	mul	ah
   499 000003FB 66AB                    	stosw
   500 000003FD 43                      	inc	ebx
   501 000003FE E2F1                    	loop	MakeOfs
   502                                  
   503                                  	; 23/08/2020
   504                                  
   505                                  	; DIRECT VGA MEMORY ACCESS
   506                                  	; bl = 0, bh = 5
   507                                  	; Direct access/map to VGA memory (0A0000h)
   508                                  
   509                                  	sys	_video, 0500h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000400 BB00050000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000405 B81F000000          <1>  mov eax, %1
    90                              <1> 
    91 0000040A CD40                <1>  int 40h
   510 0000040C 3D00000A00              	cmp	eax, 0A0000h
   511 00000411 7405                    	je	short _4
   512                                  	; 09/12/2023
   513 00000413 E9ADFCFFFF              	jmp	error_exit
   514                                  
   515                                  
   516                                  ; Note: Normally IRQ 0 calls the ModPlay Polling at 18.2Hz thru
   517                                  ;       the software interrupt 1Ch. If the IRQ 0 is disabled, then
   518                                  ;       the INT 1Ch MUST BE CALLED at least MixSpeed/1024 times per
   519                                  ;       second, or the module will sound "looped".
   520                                  ;       Because we need better sync with the ModPlayer to draw the scope,
   521                                  ;       the polling is called from my routine, and then the irq 0 must be
   522                                  ;       disabled. The [DmaBuffer] points to the current buffer of 8-bit
   523                                  ;       samples played by the Sound Blaster. Note that some samples are
   524                                  ;       discarded in the next code, just for fun!
   525                                  
   526                                  _4:
   527                                  	;mov     ax, 0013h	; Set Mode 320x200x256
   528                                  	;int     31h
   529                                  
   530                                  	; 21/10/2017
   531                                  	;mov	ax, 0012h	; Set Mode 640x480x16
   532                                  	;int	31h
   533                                  
   534                                  	; 22/10/2017
   535 00000418 E89C1C0000              	call	setgraphmode	; Set video mode to 640*480x16
   536                                  
   537                                  	; 22/10/2017
   538                                  	;call	loadlbm
   539                                  	;jc	short loadlbm_err
   540                                  
   541 0000041D BE[DC220000]            	mov	esi, LOGO_ADDRESS
   542 00000422 E87F1D0000              	call	putlbm
   543                                  	;jnc	short loadlbm_ok
   544 00000427 731D                    	jnc	short _5 ; 
   545                                  
   546                                  	;mov	byte [error_color], 0Eh ; Yellow
   547                                  
   548                                  loadlbm_err:
   549                                  	; 21/10/2017
   550                                  	;mov	ax, 0003h	; Set Text Mode 80x25x16
   551                                  	;int	31h
   552                                  	; 22/10/2017
   553 00000429 E8A81C0000              	call	settextmode
   554                                  
   555                                  	sys	_msg, LOGO_ERROR_MSG, 255, 0Ch
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000042E BB[B0220000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000433 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000438 BA0C000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000043D B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000442 CD40                <1>  int 40h
   556 00000444 EB7A                    	jmp	short Exit
   557                                  
   558                                  loadlbm_ok: 
   559                                  	; 21/10/2017
   560                                  _5:
   561                                  	; 09/10/2017 (2*BUFFERSIZE, 64K)
   562                                  	; 23/06/2017
   563                                  	; Map DMA buffer to user's memory space
   564                                  	;sys	_audio, 0D00h, 2*BUFFERSIZE, DMA_Buffer
   565                                  	; 09/12/2023
   566 00000446 A1[E1030000]            	mov	eax, [buffersize]
   567 0000044B D1E0                    	shl	eax, 1 ; *2
   568                                  	; round up to page boundary (may not be necessary)
   569 0000044D 05FF0F0000              	add	eax, 4095
   570 00000452 2500F0FFFF              	and	eax, ~4095
   571 00000457 A3[A4720000]            	mov	[DMA_buffer_size], eax
   572                                  	;;sys	_audio, 0D00h, 131072, DMA_Buffer
   573                                  	;sys	_audio, 0D00h, [DMA_buffer_size], DMA_Buffer
   574                                  	; 27/12/2024
   575                                  	sys	_audio, 0D00h, eax, DMA_Buffer
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000045C BB000D0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000461 89C1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000463 BA[00000200]        <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000468 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000046D CD40                <1>  int 40h
   576                                  	;jc	error_exit
   577                                  
   578                                  	; 23/08/2020
   579                                  
   580                                  ; position file pointer to start in actual wav data
   581                                  ; MUCH improvement should really be done here to check if sample size is
   582                                  ; supported, make sure there are 2 channels, etc.  
   583                                  ;
   584                                          ;mov     ah, 42h
   585                                          ;mov     al, 0	; from start of file
   586                                          ;mov     bx, [FileHandle]
   587                                          ;xor     cx, cx
   588                                          ;mov     dx, 44	; jump past .wav/riff header
   589                                          ;int     21h
   590                                  
   591                                  	sys	_seek, [FileHandle], 44, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000046F 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000475 B92C000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000047A BA00000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000047F B813000000          <1>  mov eax, %1
    90                              <1> 
    91 00000484 CD40                <1>  int 40h
   592                                  
   593                                  ; play the .wav file. Most of the good stuff is in here.
   594                                  
   595 00000486 E8C8010000                      call    PlayWav
   596                                  
   597                                  ; close the .wav file and exit.
   598                                  
   599                                  StopPlaying:
   600                                  	; Stop Playing
   601                                  	sys	_audio, 0700h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000048B BB00070000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000490 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000495 CD40                <1>  int 40h
   602                                  	; Cancel callback service (for user)
   603                                  	sys	_audio, 0900h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000497 BB00090000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000049C B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004A1 CD40                <1>  int 40h
   604                                  	; Deallocate Audio Buffer (for user)
   605                                  	sys	_audio, 0A00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004A3 BB000A0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004A8 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004AD CD40                <1>  int 40h
   606                                  	; Disable Audio Device
   607                                  	sys	_audio, 0C00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004AF BB000C0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004B4 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004B9 CD40                <1>  int 40h
   608                                  
   609                                  	; 23/08/2020
   610 000004BB E8161C0000              	call	settextmode
   611                                  Exit:  
   612 000004C0 E85C000000                      call    closeFile
   613                                           
   614                                  	sys	_exit	; Bye!
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81                              <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004C5 B801000000          <1>  mov eax, %1
    90                              <1> 
    91 000004CA CD40                <1>  int 40h
   615                                  here:
   616 000004CC EBFE                    	jmp	short here
   617                                  
   618                                  pmsg_usage:
   619                                  	sys	_msg, msg_usage, 255, 0Bh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004CE BB[7A650000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000004D3 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000004D8 BA0B000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004DD B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000004E2 CD40                <1>  int 40h
   620 000004E4 EBDA                    	jmp	short Exit
   621                                  
   622                                  DetectAC97:
   623                                  	; 09/12/2023
   624                                  	; Detect (BH=1) AC'97 (BL=2) Audio Device
   625                                          sys	_audio, 0102h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004E6 BB02010000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004EB B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004F0 CD40                <1>  int 40h
   626 000004F2 7213                    	jc	short DetectAC97_retn
   627                                  
   628                                  	; Get AC'97 Codec info
   629                                  	; (Function 14, sub function 1)
   630                                  	sys	_audio, 0E01h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004F4 BB010E0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004F9 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004FE CD40                <1>  int 40h
   631                                  	; Save Variable Rate Audio support bit
   632 00000500 2401                    	and	al, 1
   633 00000502 A2[97680000]            	mov	[VRA], al
   634                                  
   635                                  DetectAC97_retn:
   636 00000507 C3                      	retn
   637                                  	
   638                                  	; 23/08/2020
   639                                  
   640                                  ;open or create file
   641                                  ;
   642                                  ;input: ds:dx-->filename (asciiz)
   643                                  ;       al=file Mode (create or open)
   644                                  ;output: none  cs:[FileHandle] filled
   645                                  ;
   646                                  openFile:
   647                                  	;mov	ah, 3Bh	; start with a mode
   648                                  	;add	ah, al	; add in create or open mode
   649                                  	;xor	cx, cx
   650                                  	;int	21h
   651                                  	;jc	short _of1
   652                                  	;;mov	[cs:FileHandle], ax
   653                                  
   654                                  	sys	_open, wav_file_name, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000508 BB[34680000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000050D B900000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000512 B805000000          <1>  mov eax, %1
    90                              <1> 
    91 00000517 CD40                <1>  int 40h
   655 00000519 7205                    	jc	short _of1
   656                                  
   657 0000051B A3[75650000]            	mov	[FileHandle], eax
   658                                  _of1:
   659 00000520 C3                      	retn
   660                                  
   661                                  ; close the currently open file
   662                                  ; input: none, uses cs:[FileHandle]
   663                                  closeFile:
   664 00000521 833D[75650000]FF        	cmp	dword [FileHandle], -1
   665 00000528 7417                    	je	short _cf1
   666                                  	;mov    bx, [FileHandle]  
   667                                  	;mov    ax, 3E00h
   668                                          ;int    21h              ;close file
   669                                  
   670                                  	sys	_close, [FileHandle]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000052A 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000530 B806000000          <1>  mov eax, %1
    90                              <1> 
    91 00000535 CD40                <1>  int 40h
   671 00000537 C705[75650000]FFFF-     	mov 	dword [FileHandle], -1
   671 0000053F FFFF               
   672                                  _cf1:
   673 00000541 C3                      	retn
   674                                  
   675                                  getSampleRate:
   676                                  	
   677                                  ; reads the sample rate from the .wav file.
   678                                  ; entry: none - assumes file is already open
   679                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   680                                  ;	cx = number of channels (mono=1, stereo=2)
   681                                  ;	dx = bits per sample (8, 16)
   682                                  
   683 00000542 53                      	push    ebx
   684                                  
   685                                          ;mov	ah, 42h
   686                                          ;mov	al, 0	; from start of file
   687                                          ;mov	bx, [FileHandle]
   688                                          ;xor	cx, cx
   689                                          ;mov	dx, 08h	; "WAVE"
   690                                          ;int	21h
   691                                  	
   692                                  	sys	_seek, [FileHandle], 8, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000543 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000549 B908000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000054E BA00000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000553 B813000000          <1>  mov eax, %1
    90                              <1> 
    91 00000558 CD40                <1>  int 40h
   693                                  
   694                                          ;mov	dx, smpRBuff
   695                                          ;mov	cx, 28	; 28 bytes
   696                                  	;mov	ah, 3fh
   697                                          ;int	21h
   698                                  
   699                                  	sys	_read, [FileHandle], smpRBuff, 28
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000055A 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000560 B9[18680000]        <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000565 BA1C000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000056A B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000056F CD40                <1>  int 40h
   700                                  
   701 00000571 813D[18680000]5741-     	cmp	dword [smpRBuff], 'WAVE'
   701 00000579 5645               
   702 0000057B 7520                    	jne	short gsr_stc
   703                                  
   704 0000057D 66833D[24680000]01      	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   705 00000585 7516                    	jne	short gsr_stc
   706                                  
   707 00000587 668B0D[26680000]        	mov	cx, [smpRBuff+14]	; return num of channels in CX
   708 0000058E 66A1[28680000]                  mov     ax, [smpRBuff+16]	; return sample rate in AX
   709 00000594 668B15[32680000]        	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   710                                  gsr_retn:
   711 0000059B 5B                              pop     ebx
   712 0000059C C3                              retn
   713                                  gsr_stc:
   714 0000059D F9                      	stc
   715 0000059E EBFB                    	jmp	short gsr_retn
   716                                  
   717                                  ;=============================================================================
   718                                  
   719                                  ; 09/12/2023	
   720                                  %if 0
   721                                  	; 'playwav6.s'  (27/11/2023)
   722                                  
   723                                  audio_int_handler:
   724                                  	; 18/08/2020 (14/10/2020, 'wavplay2.s')
   725                                  
   726                                  	;mov	byte [srb], 1 ; interrupt (or signal response byte)
   727                                  	
   728                                  	;cmp	byte [cbs_busy], 1
   729                                  	;jnb	short _callback_bsy_retn
   730                                  	
   731                                  	;mov	byte [cbs_busy], 1
   732                                  
   733                                  	mov	al, [half_buff]
   734                                  
   735                                  	cmp	al, 1
   736                                  	jb	short _callback_retn
   737                                  
   738                                  	; 18/08/2020
   739                                  	mov	byte [srb], 1
   740                                  
   741                                  	xor	byte [half_buff], 3 ; 2->1, 1->2
   742                                  
   743                                  	add	al, '0'
   744                                  tL0:	; 26/11/2023
   745                                  	mov	ah, 4Eh
   746                                  	mov	ebx, 0B8000h ; video display page address
   747                                  	mov	[ebx], ax ; show playing buffer (1, 2)
   748                                  _callback_retn:
   749                                  	;mov	byte [cbs_busy], 0
   750                                  _callback_bsy_retn:
   751                                  	sys	_rele ; return from callback service 
   752                                  	; we must not come here !
   753                                  	sys	_exit
   754                                  
   755                                  %endif
   756                                  
   757                                  ;=============================================================================
   758                                  
   759                                  ; 09/12/2023
   760                                  ; 'playwav6.s' (27/11/2023)
   761                                  
   762                                  loadFromFile:
   763                                  	; 26/11/2023
   764 000005A0 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
   765                                  					; last of the file?
   766 000005A7 7402                    	jz	short lff_0		; no
   767 000005A9 F9                      	stc
   768 000005AA C3                      	retn
   769                                  lff_0:
   770                                  	; 13/06/2017
   771                                  	;mov	edx, BUFFERSIZE
   772                                  	; 26/11/2023
   773 000005AB BF[00800000]            	mov	edi, audio_buffer
   774 000005B0 8B15[E1030000]          	mov	edx, [buffersize]	; bytes
   775 000005B6 8A0D[87680000]          	mov	cl, [fbs_shift]
   776 000005BC 20C9                    	and	cl, cl
   777 000005BE 7409                    	jz	short lff_1 ; stereo, 16 bit
   778                                  
   779                                  	; fbs_shift =
   780                                  	;	2 for mono and 8 bit sample (multiplier = 4)
   781                                  	;	1 for mono or 8 bit sample (multiplier = 2)
   782 000005C0 D3EA                    	shr	edx, cl
   783                                  	;inc	edx
   784                                  
   785 000005C2 BE[00000400]            	mov     esi, temp_buffer
   786 000005C7 EB02                    	jmp	short lff_2
   787                                  lff_1:
   788                                  	;mov	esi, audio_buffer
   789 000005C9 89FE                    	mov	esi, edi ; audio_buffer
   790                                  lff_2:
   791                                  	; 17/03/2017
   792                                  	; esi = buffer address
   793                                  	; edx = buffer size
   794                                   
   795                                  	; 26/11/2023
   796                                  	; load file into memory
   797                                  	sys 	_read, [FileHandle], esi
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000005CB 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000005D1 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000005D3 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000005D8 CD40                <1>  int 40h
   798                                  	; 14/12/2024
   799 000005DA 8B0D[E1030000]          	mov	ecx, [buffersize]
   800                                  	;jc	short padfill ; error !
   801                                  	; 14/12/2024
   802 000005E0 7255                    	jc	short lff_10
   803                                  
   804 000005E2 21C0                    	and	eax, eax
   805 000005E4 7453                    	jz	short padfill
   806                                  lff_3:
   807                                  	; 26/11/2023
   808 000005E6 8A1D[87680000]          	mov	bl, [fbs_shift]
   809 000005EC 20DB                    	and	bl, bl
   810 000005EE 7456                    	jz	short lff_11
   811                                  
   812                                  	; 14/12/2024
   813                                  	;sub	ecx, eax
   814                                  	;mov	ebp, ecx
   815                                  	; 14/12/2024
   816 000005F0 29C2                    	sub	edx, eax
   817                                  
   818                                  	;mov	esi, temp_buffer
   819                                  	;mov	edi, audio_buffer
   820 000005F2 89C1                    	mov	ecx, eax   ; byte count
   821                                  
   822 000005F4 803D[11680000]08        	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   823 000005FB 751E                    	jne	short lff_6 ; 16 bit samples
   824                                  	; 8 bit samples
   825 000005FD FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
   826 000005FF 740E                    	jz	short lff_5 ; 8 bit, stereo
   827                                  lff_4:
   828                                  	; mono & 8 bit
   829 00000601 AC                      	lodsb
   830 00000602 2C80                    	sub	al, 80h ; 08/11/2023
   831 00000604 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   832 00000607 66AB                    	stosw	; left channel
   833 00000609 66AB                    	stosw	; right channel
   834 0000060B E2F4                    	loop	lff_4
   835 0000060D EB16                    	jmp	short lff_8
   836                                  lff_5:
   837                                  	; stereo & 8 bit
   838 0000060F AC                      	lodsb
   839 00000610 2C80                    	sub	al, 80h ; 08/11/2023
   840 00000612 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   841 00000615 66AB                    	stosw
   842 00000617 E2F6                    	loop	lff_5
   843 00000619 EB0A                    	jmp	short lff_8
   844                                  lff_6:
   845 0000061B D1E9                    	shr	ecx, 1 ; word count
   846                                  lff_7:
   847 0000061D 66AD                    	lodsw
   848 0000061F 66AB                    	stosw	; left channel
   849 00000621 66AB                    	stosw	; right channel
   850 00000623 E2F8                    	loop	lff_7
   851                                  lff_8:
   852                                  	; 27/11/2023
   853 00000625 F8                      	clc
   854                                  	; 14/12/2024
   855                                  	;mov	ecx, ebp
   856                                  	;jecxz	endLFF_retn
   857 00000626 09D2                    	or	edx, edx
   858 00000628 741B                    	jz	short endLFF_retn
   859                                  
   860                                  	; 14/12/2024
   861 0000062A B9[00800000]            	mov	ecx, audio_buffer
   862 0000062F 030D[E1030000]          	add	ecx, [buffersize]
   863 00000635 29F9                    	sub	ecx, edi
   864                                  
   865                                  	; 14/12/2024
   866                                  lff_10:
   867 00000637 31C0                    	xor	eax, eax ; silence
   868                                  padfill:
   869 00000639 D1E9                    	shr	ecx, 1
   870 0000063B F366AB                  	rep	stosw
   871                                  lff_9:
   872 0000063E 800D[94680000]01                or	byte [flags], ENDOFFILE	; end of file flag
   873                                  endLFF_retn:
   874 00000645 C3                              retn
   875                                  
   876                                  lff_11:
   877                                  	; 16 bit stereo
   878                                  	; ecx = buffer size
   879                                  	; eax = read count
   880 00000646 29C1                    	sub	ecx, eax
   881 00000648 76FB                    	jna	short endLFF_retn
   882 0000064A 01C7                    	add	edi, eax  ; audio_buffer + eax
   883 0000064C EBE9                    	jmp	short lff_10 ; padfill
   884                                  
   885                                  error_exit_2:
   886                                  	; 26/11/2023 - temporary
   887                                  	;sys	_msg, test_2, 255, 0Ch
   888 0000064E E972FAFFFF              	jmp	error_exit
   889                                  
   890                                  ;=============================================================================
   891                                  ;      
   892                                  ;=============================================================================
   893                                  
   894                                  PlayWav:
   895                                  	; 09/12/2023
   896                                  	;; 23/08/2020
   897                                  	;; load 32768 bytes into audio buffer
   898                                  	;;mov	edi, audio_buffer
   899                                  	;;mov	edx, BUFFERSIZE
   900                                  	;call	loadFromFile
   901                                  	; 09/12/2023
   902 00000653 FF15[D9030000]          	call	dword [loadfromwavfile]
   903 00000659 72F3                    	jc	short error_exit_2
   904                                  
   905                                  	;mov	byte [half_buff], 1 ; (DMA) Buffer 1
   906                                  
   907                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   908 0000065B F605[94680000]01        	test    byte [flags], ENDOFFILE  ; end of file
   909 00000662 7512                    	jnz	short _6 ; yes
   910                                  			 ; bypass filling dma half buffer 2
   911                                  
   912                                  	; bh = 16 : update (current, first) dma half buffer
   913                                  	; bl = 0  : then switch to the next (second) half buffer
   914                                  	sys	_audio, 1000h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000664 BB00100000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000669 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000066E CD40                <1>  int 40h
   915                                  
   916                                  	; 27/07/2020
   917                                  	; [audio_flag] = 1 (in TRDOS 386 kernel)
   918                                  
   919                                  	; audio_buffer must be filled again after above system call 
   920                                  	; (Because audio interrupt will be generated by VT8237R
   921                                  	; at the end of the first half of dma buffer.. so, 
   922                                  	; the second half must be ready. 'sound_play' will use it.)
   923                                  
   924                                  	; 09/12/2023
   925                                  	;; 13/10/2017
   926                                  	;;mov	edi, audio_buffer
   927                                  	;;mov	edx, BUFFERSIZE
   928                                  	;call    loadFromFile
   929                                  	; 09/12/2023
   930 00000670 FF15[D9030000]          	call	dword [loadfromwavfile]
   931                                  	;jc	short p_return
   932                                  
   933                                  _6:
   934                                  	; Set Master Volume Level
   935                                  	sys	_audio, 0B00h, 1D1Dh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000676 BB000B0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000067B B91D1D0000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000680 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000685 CD40                <1>  int 40h
   936                                  	; 24/06/2017
   937                                  	;mov	byte [volume_level], 1Dh
   938 00000687 880D[96680000]          	mov	[volume_level], cl	
   939                                  
   940                                  	;mov	byte [srb], 0
   941                                  
   942                                  	; Start	to play
   943 0000068D A0[11680000]            	mov	al, [bps]
   944 00000692 C0E804                  	shr	al, 4 ; 8 -> 0, 16 -> 1
   945 00000695 D0E0                    	shl	al, 1 ; 16 -> 2, 8 -> 0
   946 00000697 8A1D[10680000]          	mov	bl, [stmo]
   947 0000069D FECB                    	dec	bl
   948 0000069F 08C3                    	or	bl, al
   949 000006A1 668B0D[12680000]        	mov	cx, [sample_rate] 
   950 000006A8 B704                    	mov	bh, 4 ; start to play	
   951                                  	sys	_audio
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81                              <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000006AA B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000006AF CD40                <1>  int 40h
   952                                  
   953                                  	; 27/07/2020
   954                                  	; Here..
   955                                  	; If byte [flags] <> ENDOFFILE ...
   956                                  	; user's audio_buffer has been copied to dma half buffer 2
   957                                  
   958                                  	; [audio_flag] = 0  (in TRDOS 386 kernel)
   959                                  
   960                                  	; audio_buffer must be filled again after above system call 
   961                                  	; (Because, audio interrupt will be generated by VT8237R
   962                                  	; at the end of the first half of dma buffer.. so, 
   963                                  	; the 2nd half of dma buffer is ready but the 1st half
   964                                  	; must be filled again.)
   965                                  
   966                                  ; 14/12/2024
   967                                  %if 0
   968                                  	; 18/08/2020
   969                                  	test    byte [flags], ENDOFFILE  ; end of file
   970                                  	jnz	short p_loop ; yes
   971                                  
   972                                  	; 18/08/2020
   973                                  	; load 32768 bytes into audio buffer
   974                                  	;; (for the second half of DMA buffer)
   975                                  	; 27/11/2023
   976                                  	; 20/05/2017
   977                                  	;mov	edi, audio_buffer
   978                                  	;mov	edx, BUFFERSIZE
   979                                  	; 26/11/2023
   980                                  	;mov	edx, [buffersize]
   981                                  	;call	loadFromFile
   982                                  	; 26/11/2023
   983                                  	call	dword [loadfromwavfile]
   984                                  	;jc	short p_return
   985                                  	;mov	byte [half_buff], 2 ; (DMA) Buffer 2
   986                                  %endif
   987                                  
   988                                  	; we need to wait for 'SRB' (audio interrupt)
   989                                  	; (we can not return from 'PlayWav' here 
   990                                  	;  even if we have got an error from file reading)
   991                                  	; ((!!current audio data must be played!!))
   992                                  
   993                                  	;mov	ebx, 0B8000h ; video display page address
   994                                  	;mov	ah, 4Eh
   995                                  	;add	al, [half_buffer]
   996                                  	;mov	[ebx], ax ; show playing buffer (1, 2)
   997                                  
   998                                  	;; load 32768 bytes into audio buffer
   999                                  	;; (for the second half of DMA buffer)
  1000                                  	;; 20/05/2017
  1001                                  	;mov	edi, audio_buffer
  1002                                  	;mov	edx, BUFFERSIZE
  1003                                  	;call	loadFromFile
  1004                                  	;jc	short p_return
  1005                                  	;mov	byte [half_buff], 2 ; (DMA) Buffer 2
  1006                                  
  1007                                  	; 23/08/2020
  1008                                  
  1009                                  	; 27/10/2017
  1010                                  	
  1011                                  	; 03/08/2020
  1012                                       	;jmp	short modp_gs ; 23/06/2017
  1013                                  
  1014                                  	; 27/12/2024
  1015                                  	; 24/08/2020
  1016                                  	;inc	byte [counter]
  1017                                  p_loop:
  1018 000006B1 803D[95680000]00        	cmp	byte [srb], 0
  1019 000006B8 761D                    	jna	short q_loop
  1020                                  
  1021 000006BA C605[95680000]00        	mov	byte [srb], 0
  1022                                  modp_gs:
  1023                                  	; 24/08/2020
  1024                                  	;mov	edi, audio_buffer
  1025                                  	;mov	edx, BUFFERSIZE
  1026                                  	; 09/12/2023
  1027                                  	;call	loadFromFile
  1028                                  	;mov	edx, [buffersize]
  1029 000006C1 FF15[D9030000]          	call	dword [loadfromwavfile]
  1030 000006C7 723D                    	jc	short q_return
  1031                                  
  1032                                  	; 14/12/2024
  1033                                  	;;;
  1034                                  	; bh = 16 : update (current, first) dma half buffer
  1035                                  	; bl = 0  : then switch to the other half buffer
  1036                                  	sys	_audio, 1000h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000006C9 BB00100000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000006CE B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000006D3 CD40                <1>  int 40h
  1037                                  	;;;
  1038                                  
  1039                                  	; 23/08/2020
  1040 000006D5 EB62                    	jmp	short r_loop
  1041                                  q_loop:
  1042                                  	; 27/12/2024
  1043                                  	; 24/08/2020
  1044                                  	;test	byte [counter], 63
  1045                                  	;jnz	short r_loop
  1046                                  k_loop:
  1047 000006D7 B401                    	mov     ah, 1		; any key pressed?
  1048 000006D9 CD32                    	int     32h		; no, Loop.
  1049 000006DB 745C                    	jz	short r_loop
  1050                                  
  1051 000006DD B400                    	mov     ah, 0		; flush key buffer...
  1052 000006DF CD32                    	int     32h
  1053                                  
  1054                                  	; 19/10/2017 (modplay6.s)
  1055 000006E1 3C20                    	cmp	al, 20h
  1056 000006E3 740E                    	je	short change_pan
  1057                                  	; 09/10/2017 (playmod5.s)
  1058 000006E5 3C2B                    	cmp	al, '+' ; increase sound volume
  1059 000006E7 741E                    	je	short inc_volume_level
  1060 000006E9 3C2D                    	cmp	al, '-'
  1061 000006EB 743D                    	je	short dec_volume_level
  1062                                  
  1063                                  	; 19/10/2017 (modplay6.s)
  1064 000006ED 24DF                    	and	al, 0DFh
  1065 000006EF 3C50                    	cmp	al, 'P'
  1066 000006F1 7513                    	jne	short q_return
  1067                                  
  1068                                  change_pan:
  1069                                  	; 19/10/2017 (modplay6.s)
  1070 000006F3 8A0D[98680000]          	mov	cl, [pan_shift]
  1071 000006F9 FEC1                    	inc	cl
  1072 000006FB 80E103                  	and	cl, 3
  1073 000006FE 880D[98680000]          	mov	[pan_shift], cl
  1074 00000704 EB33                    	jmp	short r_loop
  1075                                  
  1076                                  q_return:
  1077 00000706 C3                      	retn
  1078                                  
  1079                                  	; 09/10/2017 (playmod5.s)
  1080                                  	; 24/06/2017 (wavplay2.s)
  1081                                  inc_volume_level:
  1082 00000707 8A0D[96680000]          	mov	cl, [volume_level]
  1083 0000070D 80F91F                  	cmp	cl, 1Fh ; 31
  1084                                  	;jnb	short r_loop
  1085                                  	; 09/12/2023
  1086 00000710 73C5                    	jnb	short k_loop
  1087 00000712 FEC1                    	inc	cl
  1088                                  change_volume_level:
  1089 00000714 880D[96680000]          	mov	[volume_level], cl
  1090 0000071A 88CD                    	mov	ch, cl
  1091                                  	; Set Master Volume Level
  1092                                  	sys	_audio, 0B00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000071C BB000B0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000721 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000726 CD40                <1>  int 40h
  1093 00000728 EB0F                    	jmp	short r_loop
  1094                                  dec_volume_level:
  1095 0000072A 8A0D[96680000]          	mov	cl, [volume_level]
  1096 00000730 80F901                  	cmp	cl, 1 ; 1
  1097                                  	;jna	short r_loop
  1098                                  	; 09/12/2023
  1099 00000733 76A2                    	jna	short k_loop
  1100 00000735 FEC9                    	dec	cl
  1101 00000737 EBDB                    	jmp	short change_volume_level
  1102                                  
  1103                                  r_loop:
  1104                                  	; 27/12/2024
  1105                                  	; 24/08/2020
  1106                                  	;inc	byte [counter]
  1107                                  	;; 09/12/2023
  1108                                  	;;jnz	short q_loop
  1109                                  	;;test	byte [counter], 0Fh
  1110                                  	;jnz	short q_loop
  1111                                  _10:
  1112                                  	; 09/12/2023
  1113 00000739 F605[87680000]FF        	test	byte [fbs_shift], 0FFh
  1114 00000740 7405                    	jz	short _9
  1115                                  
  1116                                  	; 23/08/2020
  1117                                  	;test	byte [stmo], 2
  1118                                  	;;jz	p_loop
  1119                                  	;; 09/12/2023
  1120                                  	;jz	short _8
  1121                                  	;cmp	byte [bps], 16
  1122                                  	;;jne	p_loop
  1123                                  	;; 09/12/2023
  1124                                  	;je	short _9
  1125                                  _8:
  1126 00000742 E96AFFFFFF              	jmp	p_loop
  1127                                  _9:
  1128                                  	;;;
  1129                                  	; 27/12/2024
  1130                                  	sys	_time, 4 ; get timer ticks (18.2 ticks/second)
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000747 BB04000000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000074C B80D000000          <1>  mov eax, %1
    90                              <1> 
    91 00000751 CD40                <1>  int 40h
  1131 00000753 3B05[A0720000]          	cmp	eax, [timerticks]
  1132 00000759 74E7                    	je	short _8
  1133 0000075B A3[A0720000]            	mov	[timerticks], eax
  1134                                  	;;;
  1135                                  
  1136                                  	; 27/10/2017
  1137                                  	; Get Current DMA buffer Pointer 
  1138                                  	; 23/06/2017 ('modplay6.s')
  1139                                  	; bh = 15, get current pointer (DMA buffer offset)
  1140                                  	; bl = 0, for PCM OUT
  1141                                  	; ecx = 0
  1142                                  	;
  1143                                  	sys	_audio, 0F00h, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000760 BB000F0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000765 B900000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000076A B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000076F CD40                <1>  int 40h
  1144                                  
  1145                                  	; 28/10/2017
  1146 00000771 24FC                    	and	al, 0FCh  ; dword alignment (stereo, 16 bit)	
  1147                                  	; 23/06/2017
  1148 00000773 BE[00000200]            	mov     esi, DMA_Buffer
  1149 00000778 01C6                    	add     esi, eax	; add offset value
  1150                                  
  1151                                  	; 24/06/2017
  1152                                  	;mov	ecx, DMA_Buffer + (65536 - (256*4))
  1153                                  	; 09/12/2023
  1154 0000077A 8B0D[A4720000]          	mov	ecx, [DMA_buffer_size]
  1155 00000780 81C1[00FC0100]          	add	ecx, DMA_Buffer - (256*4)
  1156                                  
  1157 00000786 39CE                    	cmp	esi, ecx 
  1158 00000788 7602                    	jna	short _7
  1159 0000078A 89CE                    	mov	esi, ecx
  1160                                  _7:
  1161                                  	; 23/10/2017 ('tmodplay.s')
  1162 0000078C E84C190000              	call	drawscopes
  1163                                  
  1164 00000791 E91BFFFFFF              	jmp	p_loop
  1165                                  
  1166                                  ;=============================================================================
  1167                                  ; 
  1168                                  ;=============================================================================
  1169                                  
  1170                                  ;dword2str:
  1171                                  ;	; 13/11/2016 - Erdogan Tan 
  1172                                  ;	; eax = dword value
  1173                                  ;	;
  1174                                  ;	call	dwordtohex
  1175                                  ;	mov	[dword_str], edx
  1176                                  ;	mov	[dword_str+4], eax
  1177                                  ;	mov	si, dword_str
  1178                                  ;	retn
  1179                                  
  1180                                  	; 05/03/2017 (TRDOS 386)
  1181                                  	; trdos386.s (unix386.s) - 10/05/2015
  1182                                  	; Convert binary number to hexadecimal string
  1183                                  
  1184                                  ;bytetohex:
  1185                                  ;	; INPUT ->
  1186                                  ;	; 	AL = byte (binary number)
  1187                                  ;	; OUTPUT ->
  1188                                  ;	;	AX = hexadecimal string
  1189                                  ;	;
  1190                                  ;	push	ebx
  1191                                  ;	movzx	ebx, al
  1192                                  ;	shr	bl, 4
  1193                                  ;	mov	bl, [ebx+hex_chars] 	 	
  1194                                  ;	xchg	bl, al
  1195                                  ;	and	bl, 0Fh
  1196                                  ;	mov	ah, [ebx+hex_chars] 
  1197                                  ;	pop	ebx	
  1198                                  ;	retn
  1199                                  
  1200                                  ;wordtohex:
  1201                                  ;	; INPUT ->
  1202                                  ;	; 	AX = word (binary number)
  1203                                  ;	; OUTPUT ->
  1204                                  ;	;	EAX = hexadecimal string
  1205                                  ;	;
  1206                                  ;	push	ebx
  1207                                  ;	xor	ebx, ebx
  1208                                  ;	xchg	ah, al
  1209                                  ;	push	eax
  1210                                  ;	mov	bl, ah
  1211                                  ;	shr	bl, 4
  1212                                  ;	mov	al, [ebx+hex_chars] 	 	
  1213                                  ;	mov	bl, ah
  1214                                  ;	and	bl, 0Fh
  1215                                  ;	mov	ah, [ebx+hex_chars]
  1216                                  ;	shl	eax, 16
  1217                                  ;	pop	eax
  1218                                  ;	pop	ebx
  1219                                  ;	jmp	short bytetohex
  1220                                  
  1221                                  ;dwordtohex:
  1222                                  ;	; INPUT ->
  1223                                  ;	; 	EAX = dword (binary number)
  1224                                  ;	; OUTPUT ->
  1225                                  ;	;	EDX:EAX = hexadecimal string
  1226                                  ;	;
  1227                                  ;	push	eax
  1228                                  ;	shr	eax, 16
  1229                                  ;	call	wordtohex
  1230                                  ;	mov	edx, eax
  1231                                  ;	pop	eax
  1232                                  ;	call	wordtohex
  1233                                  ;	retn
  1234                                  
  1235                                  ; 09/12/2023
  1236                                  ; 'playwav6.s' (27/11/2023)
  1237                                  
  1238                                  write_wav_file_info:
  1239                                  	; 01/05/2017
  1240                                  	sys	_msg, msgWavFileName, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000796 BB[6C670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000079B B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000007A0 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000007A5 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000007AA CD40                <1>  int 40h
  1241                                  	sys	_msg, wav_file_name, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000007AC BB[34680000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000007B1 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000007B6 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000007BB B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000007C0 CD40                <1>  int 40h
  1242                                  
  1243                                  write_sample_rate:
  1244                                  	; 01/05/2017
  1245 000007C2 66A1[12680000]          	mov	ax, [sample_rate]
  1246                                  	; ax = sample rate (hertz)
  1247 000007C8 31D2                    	xor	edx, edx
  1248 000007CA 66B90A00                	mov	cx, 10
  1249 000007CE 66F7F1                  	div	cx
  1250 000007D1 0015[91670000]          	add	[msgHertz+4], dl
  1251 000007D7 29D2                    	sub	edx, edx
  1252 000007D9 66F7F1                  	div	cx
  1253 000007DC 0015[90670000]          	add	[msgHertz+3], dl
  1254 000007E2 29D2                    	sub	edx, edx
  1255 000007E4 66F7F1                  	div	cx
  1256 000007E7 0015[8F670000]          	add	[msgHertz+2], dl
  1257 000007ED 29D2                    	sub	edx, edx
  1258 000007EF 66F7F1                  	div	cx
  1259 000007F2 0015[8E670000]          	add	[msgHertz+1], dl
  1260 000007F8 0005[8D670000]          	add	[msgHertz], al
  1261                                  	
  1262                                  	sys	_msg, msgSampleRate, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000007FE BB[7E670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000803 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000808 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000080D B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000812 CD40                <1>  int 40h
  1263                                  
  1264 00000814 BE[A8670000]            	mov	esi, msg16Bits
  1265 00000819 803D[11680000]10        	cmp	byte [bps], 16
  1266 00000820 7405                    	je	short wsr_1
  1267 00000822 BE[98670000]            	mov	esi, msg8Bits
  1268                                  wsr_1:
  1269                                  	sys	_msg, esi, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000827 89F3                <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000829 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000082E BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000833 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000838 CD40                <1>  int 40h
  1270                                  
  1271 0000083A BE[A1670000]            	mov	esi, msgMono
  1272 0000083F 803D[10680000]01        	cmp	byte [stmo], 1
  1273 00000846 7405                    	je	short wsr_2
  1274 00000848 BE[B2670000]            	mov	esi, msgStereo		
  1275                                  wsr_2:
  1276                                  	sys	_msg, esi, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000084D 89F3                <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000084F B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000854 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000859 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 0000085E CD40                <1>  int 40h
  1277 00000860 C3                              retn
  1278                                  
  1279                                  write_ac97_pci_dev_info:
  1280                                  	; 27/12/2024
  1281                                  	; 06/06/2017
  1282                                  	; 03/06/2017
  1283                                  	; BUS/DEV/FN
  1284                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1285                                  	; DEV/VENDOR
  1286                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1287                                  
  1288                                  
  1289                                  	;mov	esi, [dev_vendor]
  1290                                  	; 27/12/2024
  1291 00000861 A1[88680000]            	mov	eax, [dev_vendor]
  1292 00000866 0FB6D8                  	movzx	ebx, al
  1293 00000869 88DA                    	mov	dl, bl
  1294 0000086B 80E30F                  	and	bl, 0Fh
  1295 0000086E 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1296 00000874 A2[0A670000]            	mov	[msgVendorId+3], al
  1297 00000879 88D3                    	mov	bl, dl
  1298 0000087B C0EB04                  	shr	bl, 4
  1299 0000087E 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1300 00000884 A2[09670000]            	mov	[msgVendorId+2], al
  1301 00000889 88E3                    	mov	bl, ah
  1302 0000088B 88DA                    	mov	dl, bl
  1303 0000088D 80E30F                  	and	bl, 0Fh
  1304 00000890 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1305 00000896 A2[08670000]            	mov	[msgVendorId+1], al
  1306 0000089B 88D3                    	mov	bl, dl
  1307 0000089D C0EB04                  	shr	bl, 4
  1308 000008A0 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1309 000008A6 A2[07670000]            	mov	[msgVendorId], al
  1310                                  	;shr	esi, 16
  1311                                  	; 27/12/2024
  1312 000008AB C1E810                  	shr	eax, 16
  1313 000008AE 88C3                    	mov	bl, al
  1314 000008B0 88DA                    	mov	dl, bl
  1315 000008B2 80E30F                  	and	bl, 0Fh
  1316 000008B5 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1317 000008BB A2[1B670000]            	mov	[msgDevId+3], al
  1318 000008C0 88D3                    	mov	bl, dl
  1319 000008C2 C0EB04                  	shr	bl, 4
  1320 000008C5 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1321 000008CB A2[1A670000]            	mov	[msgDevId+2], al
  1322 000008D0 88E3                    	mov	bl, ah
  1323 000008D2 88DA                    	mov	dl, bl
  1324 000008D4 80E30F                  	and	bl, 0Fh
  1325 000008D7 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1326 000008DD A2[19670000]            	mov	[msgDevId+1], al
  1327 000008E2 88D3                    	mov	bl, dl
  1328 000008E4 C0EB04                  	shr	bl, 4
  1329 000008E7 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1330 000008ED A2[18670000]            	mov	[msgDevId], al
  1331                                  
  1332                                  	;mov	esi, [bus_dev_fn]
  1333                                  	;shr	esi, 8
  1334                                  	;mov	ax, si
  1335                                  	; 27/12/2024
  1336 000008F2 A1[8C680000]            	mov	eax, [bus_dev_fn]
  1337 000008F7 C1E808                  	shr	eax, 8
  1338 000008FA 88C3                    	mov	bl, al
  1339 000008FC 88DA                    	mov	dl, bl
  1340 000008FE 80E307                  	and	bl, 7 ; bit 0,1,2
  1341 00000901 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1342 00000907 A2[3F670000]            	mov	[msgFncNo+1], al
  1343 0000090C 88D3                    	mov	bl, dl
  1344 0000090E C0EB03                  	shr	bl, 3
  1345 00000911 88DA                    	mov	dl, bl
  1346 00000913 80E30F                  	and	bl, 0Fh
  1347 00000916 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1348 0000091C A2[31670000]            	mov	[msgDevNo+1], al
  1349 00000921 88D3                    	mov	bl, dl
  1350 00000923 C0EB04                  	shr	bl, 4
  1351 00000926 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1352 0000092C A2[30670000]            	mov	[msgDevNo], al
  1353 00000931 88E3                    	mov	bl, ah
  1354 00000933 88DA                    	mov	dl, bl
  1355 00000935 80E30F                  	and	bl, 0Fh
  1356 00000938 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1357 0000093E A2[25670000]            	mov	[msgBusNo+1], al
  1358 00000943 88D3                    	mov	bl, dl
  1359 00000945 C0EB04                  	shr	bl, 4
  1360 00000948 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1361 0000094E A2[24670000]            	mov	[msgBusNo], al
  1362                                  
  1363 00000953 66A1[90680000]          	mov	ax, [ac97_NamBar]
  1364 00000959 88C3                    	mov	bl, al
  1365 0000095B 88DA                    	mov	dl, bl
  1366 0000095D 80E30F                  	and	bl, 0Fh
  1367 00000960 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1368 00000966 A2[4E670000]            	mov	[msgNamBar+3], al
  1369 0000096B 88D3                    	mov	bl, dl
  1370 0000096D C0EB04                  	shr	bl, 4
  1371 00000970 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1372 00000976 A2[4D670000]            	mov	[msgNamBar+2], al
  1373 0000097B 88E3                    	mov	bl, ah
  1374 0000097D 88DA                    	mov	dl, bl
  1375 0000097F 80E30F                  	and	bl, 0Fh
  1376 00000982 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1377 00000988 A2[4C670000]            	mov	[msgNamBar+1], al
  1378 0000098D 88D3                    	mov	bl, dl
  1379 0000098F C0EB04                  	shr	bl, 4
  1380 00000992 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1381 00000998 A2[4B670000]            	mov	[msgNamBar], al
  1382                                  
  1383 0000099D 66A1[92680000]          	mov	ax, [ac97_NabmBar]
  1384 000009A3 88C3                    	mov	bl, al
  1385 000009A5 88DA                    	mov	dl, bl
  1386 000009A7 80E30F                  	and	bl, 0Fh
  1387 000009AA 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1388 000009B0 A2[5E670000]            	mov	[msgNabmBar+3], al
  1389 000009B5 88D3                    	mov	bl, dl
  1390 000009B7 C0EB04                  	shr	bl, 4
  1391 000009BA 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1392 000009C0 A2[5D670000]            	mov	[msgNabmBar+2], al
  1393 000009C5 88E3                    	mov	bl, ah
  1394 000009C7 88DA                    	mov	dl, bl
  1395 000009C9 80E30F                  	and	bl, 0Fh
  1396 000009CC 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1397 000009D2 A2[5C670000]            	mov	[msgNabmBar+1], al
  1398 000009D7 88D3                    	mov	bl, dl
  1399 000009D9 C0EB04                  	shr	bl, 4
  1400 000009DC 8A83[C5660000]          	mov	al, [ebx+hex_chars]
  1401 000009E2 A2[5B670000]            	mov	[msgNabmBar], al
  1402                                  
  1403 000009E7 30E4                    	xor	ah, ah
  1404 000009E9 A0[86680000]            	mov	al, [ac97_int_ln_reg]
  1405 000009EE B10A                    	mov	cl, 10
  1406 000009F0 F6F1                    	div	cl
  1407 000009F2 660105[67670000]        	add	[msgIRQ], ax
  1408 000009F9 20C0                    	and	al, al
  1409 000009FB 750D                    	jnz	short _w_ac97imsg_
  1410 000009FD A0[68670000]            	mov	al, [msgIRQ+1]
  1411 00000A02 B420                    	mov	ah, ' '
  1412 00000A04 66A3[67670000]          	mov	[msgIRQ], ax
  1413                                  _w_ac97imsg_:
  1414                                  	sys	_msg, msgAC97Info, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A0A BB[D6660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A0F B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A14 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A19 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A1E CD40                <1>  int 40h
  1415                                  
  1416 00000A20 C3                              retn
  1417                                  
  1418                                  write_VRA_info:
  1419                                  	; 25/11/2023
  1420                                  	sys	_msg, msgVRAheader, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A21 BB[BB670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A26 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A2B BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A30 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A35 CD40                <1>  int 40h
  1421 00000A37 803D[97680000]00        	cmp	byte [VRA], 0
  1422 00000A3E 7617                    	jna	short _w_VRAi_no
  1423                                  _w_VRAi_yes:
  1424                                  	sys	_msg, msgVRAyes, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A40 BB[C9670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A45 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A4A BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A4F B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A54 CD40                <1>  int 40h
  1425 00000A56 C3                      	retn
  1426                                  _w_VRAi_no:
  1427                                  	sys	_msg, msgVRAno, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A57 BB[CF670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A5C B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A61 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A66 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A6B CD40                <1>  int 40h
  1428 00000A6D C3                      	retn
  1429                                  
  1430                                  ; 09/12/2023
  1431                                  ; --------------------------------------------------------
  1432                                  ; 'playwav6.s' (27/11/2023)
  1433                                  
  1434                                  ; 26/11/2023
  1435                                  ; 25/11/2023 - playwav6.s (32 bit registers, TRDOS 386 adaption)
  1436                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  1437                                  ; 14/11/2023
  1438                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1439                                  ; --------------------------------------------------------
  1440                                  
  1441                                  ;;Note:	At the end of every buffer load,
  1442                                  ;;	during buffer switch/swap, there will be discontinuity
  1443                                  ;;	between the last converted sample and the 1st sample
  1444                                  ;;	of the next buffer.
  1445                                  ;;	(like as a dot noises vaguely between normal sound samples)
  1446                                  ;;	-To avoid this defect, the 1st sample of
  1447                                  ;;	the next buffer may be read from the wav file but
  1448                                  ;;	the file pointer would need to be set to 1 sample back
  1449                                  ;;	again via seek system call. Time comsumption problem! -
  1450                                  ;;
  1451                                  ;;	Erdogan Tan - 15/11/2023
  1452                                  ;;
  1453                                  ;;	((If entire wav data would be loaded at once.. conversion
  1454                                  ;;	defect/noise would disappear.. but for DOS, to keep
  1455                                  ;;	64KB buffer limit is important also it is important
  1456                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1457                                  ;;	I have tested this program by using 2-30MB wav files.))
  1458                                  ;;
  1459                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1460                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1461                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1462                                  ;;			Realtek ALC850 codec.
  1463                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1464                                  
  1465                                  load_8khz_mono_8_bit:
  1466                                  	; 15/11/2023
  1467                                  	; 14/11/2023
  1468                                  	; 13/11/2023
  1469 00000A6E F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1470                                  					; last of the file?
  1471 00000A75 7402                    	jz	short lff8m_0		; no
  1472 00000A77 F9                      	stc
  1473 00000A78 C3                      	retn
  1474                                  
  1475                                  lff8m_0:
  1476 00000A79 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1477                                          ;mov	edx, [loadsize]
  1478                                  
  1479                                  	; esi = buffer address
  1480                                  	;; edx = buffer size
  1481                                  
  1482                                  	; load file into memory
  1483                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A7E 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A84 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A86 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A8C B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A91 CD40                <1>  int 40h
  1484 00000A93 7305                    	jnc	short lff8m_6
  1485 00000A95 E9AF000000              	jmp	lff8m_5  ; error !
  1486                                  
  1487                                  lff8m_6:
  1488 00000A9A BF[00800000]            	mov	edi, audio_buffer
  1489 00000A9F 21C0                    	and	eax, eax
  1490 00000AA1 0F8499000000            	jz	lff8_eof
  1491                                  
  1492 00000AA7 89C1                    	mov	ecx, eax		; byte count
  1493                                  lff8m_1:
  1494 00000AA9 AC                      	lodsb
  1495 00000AAA A2[B0200000]            	mov	[previous_val], al
  1496 00000AAF 2C80                    	sub	al, 80h
  1497 00000AB1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1498 00000AB5 66AB                    	stosw		; original sample (left channel)
  1499 00000AB7 66AB                    	stosw		; original sample (right channel)
  1500                                  	;xor	eax, eax
  1501 00000AB9 B080                    	mov	al, 80h
  1502 00000ABB 49                      	dec	ecx
  1503 00000ABC 7402                    	jz	short lff8m_2
  1504 00000ABE 8A06                    	mov	al, [esi]
  1505                                  lff8m_2:
  1506                                  	;mov	[next_val], ax
  1507 00000AC0 88C7                    	mov	bh, al	; [next_val]
  1508 00000AC2 8A25[B0200000]          	mov	ah, [previous_val]
  1509 00000AC8 00E0                    	add	al, ah	; [previous_val]
  1510 00000ACA D0D8                    	rcr	al, 1
  1511 00000ACC 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  1512 00000ACE 00E0                    	add	al, ah	; [previous_val]
  1513 00000AD0 D0D8                    	rcr	al, 1	
  1514 00000AD2 88C3                    	mov	bl, al 	; this is temporary interpolation value	
  1515 00000AD4 00E0                    	add	al, ah	; [previous_val]
  1516 00000AD6 D0D8                    	rcr	al, 1
  1517 00000AD8 2C80                    	sub	al, 80h
  1518 00000ADA 66C1E008                	shl	ax, 8	
  1519 00000ADE 66AB                    	stosw		; this is 1st interpolated sample (L)
  1520 00000AE0 66AB                    	stosw		; this is 1st interpolated sample (R)
  1521 00000AE2 88D8                    	mov	al, bl
  1522 00000AE4 00D0                    	add	al, dl
  1523 00000AE6 D0D8                    	rcr	al, 1
  1524 00000AE8 2C80                    	sub	al, 80h
  1525 00000AEA 66C1E008                	shl	ax, 8
  1526 00000AEE 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1527 00000AF0 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1528 00000AF2 88D0                    	mov	al, dl
  1529 00000AF4 2C80                    	sub	al, 80h
  1530 00000AF6 66C1E008                	shl	ax, 8
  1531 00000AFA 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1532 00000AFC 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1533                                  	;mov	al, [next_val]
  1534 00000AFE 88F8                    	mov	al, bh
  1535 00000B00 00D0                    	add	al, dl
  1536 00000B02 D0D8                    	rcr	al, 1
  1537 00000B04 88C3                    	mov	bl, al	; this is temporary interpolation value
  1538 00000B06 00D0                    	add	al, dl
  1539 00000B08 D0D8                    	rcr	al, 1
  1540 00000B0A 2C80                    	sub	al, 80h
  1541 00000B0C 66C1E008                	shl	ax, 8
  1542 00000B10 66AB                    	stosw		; this is 4th interpolated sample (L)
  1543 00000B12 66AB                    	stosw		; this is 4th interpolated sample (R)
  1544                                  	;mov	al, [next_val]
  1545 00000B14 88F8                    	mov	al, bh
  1546 00000B16 00D8                    	add	al, bl
  1547 00000B18 D0D8                    	rcr	al, 1
  1548 00000B1A 2C80                    	sub	al, 80h
  1549 00000B1C 66C1E008                	shl	ax, 8
  1550 00000B20 66AB                    	stosw		; this is 5th interpolated sample (L)
  1551 00000B22 66AB                    	stosw		; this is 5th interpolated sample (R)
  1552                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1553 00000B24 09C9                    	or	ecx, ecx
  1554 00000B26 7581                    	jnz	short lff8m_1
  1555                                  
  1556                                  	; --------------
  1557                                  
  1558                                  lff8s_3:
  1559                                  lff8m_3:
  1560                                  lff8s2_3:
  1561                                  lff8m2_3:
  1562                                  lff16s_3:
  1563                                  lff16m_3:
  1564                                  lff16s2_3:
  1565                                  lff16m2_3:
  1566                                  lff24_3:
  1567                                  lff32_3:
  1568                                  lff44_3:
  1569                                  lff22_3:
  1570                                  lff11_3:
  1571                                  	; 08/12/2024 (BugFix)
  1572                                  	; 01/06/2024 (BugFix)
  1573 00000B28 8B0D[E1030000]          	mov	ecx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1574                                  	;shl	ecx, 1	; byte count ; Bug !
  1575                                  	; 08/12/2024
  1576 00000B2E 81C1[00800000]          	add	ecx, audio_buffer
  1577 00000B34 29F9                    	sub	ecx, edi
  1578 00000B36 7607                    	jna	short lff8m_4
  1579                                  	;inc	ecx
  1580 00000B38 C1E902                  	shr	ecx, 2
  1581 00000B3B 31C0                    	xor	eax, eax ; fill (remain part of) buffer with zeros
  1582 00000B3D F3AB                    	rep	stosd
  1583                                  lff8m_4:
  1584                                  	; 01/06/2024 (BugFix)
  1585                                  	; cf=1 ; Bug !
  1586                                  	; 08/12/2024
  1587                                  	;clc
  1588 00000B3F C3                      	retn
  1589                                  
  1590                                  lff8_eof:
  1591                                  lff16_eof:
  1592                                  lff24_eof:
  1593                                  lff32_eof:
  1594                                  lff44_eof:
  1595                                  lff22_eof:
  1596                                  lff11_eof:
  1597                                  	; 15/11/2023
  1598 00000B40 C605[94680000]01        	mov	byte [flags], ENDOFFILE
  1599 00000B47 EBDF                    	jmp	short lff8m_3
  1600                                  
  1601                                  lff8s_5:
  1602                                  lff8m_5:
  1603                                  lff8s2_5:
  1604                                  lff8m2_5:
  1605                                  lff16s_5:
  1606                                  lff16m_5:
  1607                                  lff16s2_5:
  1608                                  lff16m2_5:
  1609                                  lff24_5:
  1610                                  lff32_5:
  1611                                  lff44_5:
  1612                                  lff22_5:
  1613                                  lff11_5:
  1614                                  	; 09/12/2023	
  1615                                  	;mov	al, '!'  ; error
  1616                                  	;call	tL0
  1617                                  	
  1618                                  	;jmp	short lff8m_3
  1619                                  	; 15/11/2023
  1620 00000B49 EBF5                    	jmp	lff8_eof
  1621                                  
  1622                                  	; --------------
  1623                                  
  1624                                  load_8khz_stereo_8_bit:
  1625                                  	; 15/11/2023
  1626                                  	; 14/11/2023
  1627                                  	; 13/11/2023
  1628 00000B4B F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1629                                  					; last of the file?
  1630 00000B52 7402                    	jz	short lff8s_0		; no
  1631 00000B54 F9                      	stc
  1632 00000B55 C3                      	retn
  1633                                  
  1634                                  lff8s_0:
  1635 00000B56 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1636                                          ;mov	edx, [loadsize]
  1637                                  
  1638                                  	; esi = buffer address
  1639                                  	;; edx = buffer size
  1640                                  
  1641                                  	; load file into memory
  1642                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000B5B 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000B61 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000B63 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000B69 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000B6E CD40                <1>  int 40h
  1643 00000B70 72D7                    	jc	short lff8s_5 ; error !
  1644                                  
  1645 00000B72 BF[00800000]            	mov	edi, audio_buffer
  1646                                  	
  1647 00000B77 D1E8                    	shr	eax, 1
  1648 00000B79 74C5                    	jz	short lff8_eof
  1649                                  
  1650 00000B7B 89C1                    	mov	ecx, eax	; word count
  1651                                  lff8s_1:
  1652 00000B7D AC                      	lodsb
  1653 00000B7E A2[B0200000]            	mov	[previous_val_l], al
  1654 00000B83 2C80                    	sub	al, 80h
  1655 00000B85 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1656 00000B89 66AB                    	stosw		; original sample (L)
  1657 00000B8B AC                      	lodsb
  1658 00000B8C A2[B2200000]            	mov	[previous_val_r], al
  1659 00000B91 2C80                    	sub	al, 80h
  1660 00000B93 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1661 00000B97 66AB                    	stosw		; original sample (R)
  1662                                  
  1663                                  	;xor	eax, eax
  1664 00000B99 66B88080                	mov	ax, 8080h
  1665 00000B9D 49                      	dec	ecx
  1666 00000B9E 7403                    	jz	short lff8s_2
  1667                                  		; convert 8 bit sample to 16 bit sample
  1668 00000BA0 668B06                  	mov	ax, [esi]
  1669                                  lff8s_2:
  1670 00000BA3 A2[B4200000]            	mov	[next_val_l], al
  1671 00000BA8 8825[B6200000]          	mov	[next_val_r], ah
  1672 00000BAE 8A25[B0200000]          	mov	ah, [previous_val_l]
  1673 00000BB4 00E0                    	add	al, ah
  1674 00000BB6 D0D8                    	rcr	al, 1
  1675 00000BB8 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1676 00000BBA 00E0                    	add	al, ah
  1677 00000BBC D0D8                    	rcr	al, 1	
  1678 00000BBE 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1679 00000BC0 00E0                    	add	al, ah
  1680 00000BC2 D0D8                    	rcr	al, 1
  1681 00000BC4 2C80                    	sub	al, 80h
  1682 00000BC6 66C1E008                	shl	ax, 8
  1683 00000BCA 66AB                    	stosw		; this is 1st interpolated sample (L)
  1684 00000BCC A0[B6200000]            	mov	al, [next_val_r]
  1685 00000BD1 8A25[B2200000]          	mov	ah, [previous_val_r]
  1686 00000BD7 00E0                    	add	al, ah
  1687 00000BD9 D0D8                    	rcr	al, 1
  1688 00000BDB 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1689 00000BDD 00E0                    	add	al, ah
  1690 00000BDF D0D8                    	rcr	al, 1
  1691 00000BE1 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1692 00000BE3 00E0                    	add	al, ah
  1693 00000BE5 D0D8                    	rcr	al, 1
  1694 00000BE7 2C80                    	sub	al, 80h
  1695 00000BE9 66C1E008                	shl	ax, 8
  1696 00000BED 66AB                    	stosw		; this is 1st interpolated sample (R)
  1697 00000BEF 88D8                    	mov	al, bl
  1698 00000BF1 00D0                    	add	al, dl
  1699 00000BF3 D0D8                    	rcr	al, 1
  1700 00000BF5 2C80                    	sub	al, 80h
  1701 00000BF7 66C1E008                	shl	ax, 8
  1702 00000BFB 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1703 00000BFD 88F8                    	mov	al, bh
  1704 00000BFF 00F0                    	add	al, dh
  1705 00000C01 D0D8                    	rcr	al, 1
  1706 00000C03 2C80                    	sub	al, 80h
  1707 00000C05 66C1E008                	shl	ax, 8
  1708 00000C09 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1709 00000C0B 88D0                    	mov	al, dl
  1710 00000C0D 2C80                    	sub	al, 80h
  1711 00000C0F 66C1E008                	shl	ax, 8
  1712 00000C13 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1713 00000C15 88F0                    	mov	al, dh
  1714 00000C17 2C80                    	sub	al, 80h
  1715 00000C19 66C1E008                	shl	ax, 8
  1716 00000C1D 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1717 00000C1F A0[B4200000]            	mov	al, [next_val_l]
  1718 00000C24 00D0                    	add	al, dl
  1719 00000C26 D0D8                    	rcr	al, 1
  1720 00000C28 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1721 00000C2A 00D0                    	add	al, dl
  1722 00000C2C D0D8                    	rcr	al, 1
  1723 00000C2E 2C80                    	sub	al, 80h
  1724 00000C30 66C1E008                	shl	ax, 8
  1725 00000C34 66AB                    	stosw		; this is 4th interpolated sample (L)
  1726 00000C36 A0[B6200000]            	mov	al, [next_val_r]
  1727 00000C3B 00F0                    	add	al, dh
  1728 00000C3D D0D8                    	rcr	al, 1
  1729 00000C3F 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1730 00000C41 00F0                    	add	al, dh
  1731 00000C43 D0D8                    	rcr	al, 1
  1732 00000C45 2C80                    	sub	al, 80h
  1733 00000C47 66C1E008                	shl	ax, 8
  1734 00000C4B 66AB                    	stosw		; this is 4th interpolated sample (R)
  1735 00000C4D A0[B4200000]            	mov	al, [next_val_l]
  1736 00000C52 00D8                    	add	al, bl
  1737 00000C54 D0D8                    	rcr	al, 1
  1738 00000C56 2C80                    	sub	al, 80h
  1739 00000C58 66C1E008                	shl	ax, 8
  1740 00000C5C 66AB                    	stosw		; this is 5th interpolated sample (L)
  1741 00000C5E A0[B6200000]            	mov	al, [next_val_r]
  1742 00000C63 00F8                    	add	al, bh
  1743 00000C65 D0D8                    	rcr	al, 1
  1744 00000C67 2C80                    	sub	al, 80h
  1745 00000C69 66C1E008                	shl	ax, 8
  1746 00000C6D 66AB                    	stosw		; this is 5th interpolated sample (R)
  1747                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1748 00000C6F E305                    	jecxz	lff8s_6
  1749 00000C71 E907FFFFFF              	jmp	lff8s_1
  1750                                  lff8s_6:
  1751 00000C76 E9ADFEFFFF              	jmp	lff8s_3
  1752                                  
  1753                                  load_8khz_mono_16_bit:
  1754                                  	; 13/11/2023
  1755 00000C7B F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1756                                  					; last of the file?
  1757 00000C82 7402                    	jz	short lff8m2_0		; no
  1758 00000C84 F9                      	stc
  1759 00000C85 C3                      	retn
  1760                                  
  1761                                  lff8m2_0:
  1762 00000C86 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1763                                          ;mov	edx, [loadsize]
  1764                                  
  1765                                  	; esi = buffer address
  1766                                  	;; edx = buffer size
  1767                                  
  1768                                  	; load file into memory
  1769                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000C8B 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000C91 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000C93 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000C99 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000C9E CD40                <1>  int 40h
  1770 00000CA0 0F82A0000000            	jc	lff8m2_7 ; error !
  1771                                  
  1772 00000CA6 BF[00800000]            	mov	edi, audio_buffer
  1773                                  	
  1774 00000CAB D1E8                    	shr	eax, 1
  1775 00000CAD 7505                    	jnz	short lff8m2_8
  1776 00000CAF E98CFEFFFF              	jmp	lff8_eof
  1777                                  
  1778                                  lff8m2_8:
  1779 00000CB4 89C1                    	mov	ecx, eax	; word count
  1780                                  lff8m2_1:
  1781 00000CB6 66AD                    	lodsw
  1782 00000CB8 66AB                    	stosw		; original sample (left channel)
  1783 00000CBA 66AB                    	stosw		; original sample (right channel)
  1784 00000CBC 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1785 00000CBF 66A3[B0200000]          	mov	[previous_val], ax
  1786 00000CC5 31C0                    	xor	eax, eax
  1787 00000CC7 49                      	dec	ecx
  1788 00000CC8 7403                    	jz	short lff8m2_2
  1789 00000CCA 668B06                  	mov	ax, [esi]
  1790                                  lff8m2_2:
  1791 00000CCD 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  1792 00000CD0 89C5                    	mov	ebp, eax	; [next_val]
  1793 00000CD2 660305[B0200000]        	add	ax, [previous_val]
  1794 00000CD9 66D1D8                  	rcr	ax, 1
  1795 00000CDC 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample
  1796 00000CDE 660305[B0200000]        	add	ax, [previous_val]
  1797 00000CE5 66D1D8                  	rcr	ax, 1	; this is temporary interpolation value
  1798 00000CE8 89C3                    	mov	ebx, eax 		
  1799 00000CEA 660305[B0200000]        	add	ax, [previous_val]
  1800 00000CF1 66D1D8                  	rcr	ax, 1
  1801 00000CF4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1802 00000CF7 66AB                    	stosw		; this is 1st interpolated sample (L)
  1803 00000CF9 66AB                    	stosw		; this is 1st interpolated sample (R)
  1804 00000CFB 89D8                    	mov	eax, ebx
  1805 00000CFD 6601D0                  	add	ax, dx
  1806 00000D00 66D1D8                  	rcr	ax, 1
  1807 00000D03 80EC80                  	sub	ah, 80h
  1808 00000D06 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1809 00000D08 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1810 00000D0A 89D0                    	mov	eax, edx
  1811 00000D0C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1812 00000D0F 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1813 00000D11 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1814 00000D13 89E8                    	mov	eax, ebp
  1815 00000D15 6601D0                  	add	ax, dx
  1816 00000D18 66D1D8                  	rcr	ax, 1
  1817 00000D1B 89C3                    	mov	ebx, eax ; this is temporary interpolation value
  1818 00000D1D 6601D0                  	add	ax, dx
  1819 00000D20 66D1D8                  	rcr	ax, 1
  1820 00000D23 80EC80                  	sub	ah, 80h
  1821 00000D26 66AB                    	stosw		; this is 4th interpolated sample (L)
  1822 00000D28 66AB                    	stosw		; this is 4th interpolated sample (R)
  1823 00000D2A 89E8                    	mov	eax, ebp
  1824 00000D2C 6601D8                  	add	ax, bx
  1825 00000D2F 66D1D8                  	rcr	ax, 1
  1826 00000D32 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1827 00000D35 66AB                    	stosw		; this is 5th interpolated sample (L)
  1828 00000D37 66AB                    	stosw		; this is 5th interpolated sample (R)
  1829                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1830 00000D39 09C9                    	or	ecx, ecx
  1831 00000D3B 0F8575FFFFFF            	jnz	lff8m2_1
  1832 00000D41 E9E2FDFFFF              	jmp	lff8m2_3
  1833                                  
  1834                                  lff8m2_7:
  1835                                  lff8s2_7:
  1836 00000D46 E9FEFDFFFF              	jmp	lff8m2_5  ; error
  1837                                  
  1838                                  load_8khz_stereo_16_bit:
  1839                                  	; 16/11/2023
  1840                                  	; 15/11/2023
  1841                                  	; 13/11/2023
  1842 00000D4B F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1843                                  					; last of the file?
  1844 00000D52 7402                    	jz	short lff8s2_0		; no
  1845 00000D54 F9                      	stc
  1846 00000D55 C3                      	retn
  1847                                  
  1848                                  lff8s2_0:
  1849 00000D56 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1850                                          ;mov	edx, [loadsize]
  1851                                  
  1852                                  	; esi = buffer address
  1853                                  	;; edx = buffer size
  1854                                  
  1855                                  	; load file into memory
  1856                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000D5B 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000D61 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000D63 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000D69 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000D6E CD40                <1>  int 40h
  1857 00000D70 72D4                    	jc	short lff8s2_7 ; error !
  1858                                  
  1859 00000D72 BF[00800000]            	mov	edi, audio_buffer
  1860                                  	
  1861 00000D77 C1E802                  	shr	eax, 2
  1862 00000D7A 7505                    	jnz	short lff8s2_8
  1863 00000D7C E9BFFDFFFF              	jmp	lff8_eof
  1864                                  
  1865                                  lff8s2_8:
  1866 00000D81 89C1                    	mov	ecx, eax ; dword count
  1867                                  lff8s2_1:
  1868 00000D83 66AD                    	lodsw
  1869 00000D85 66AB                    	stosw		; original sample (L)
  1870                                  	; 15/11/2023
  1871 00000D87 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1872 00000D8A 66A3[B0200000]          	mov	[previous_val_l], ax
  1873 00000D90 66AD                    	lodsw
  1874 00000D92 66AB                    	stosw		; original sample (R)
  1875 00000D94 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1876 00000D97 66A3[B2200000]          	mov	[previous_val_r], ax
  1877 00000D9D 31D2                    	xor	edx, edx
  1878 00000D9F 31C0                    	xor	eax, eax
  1879                                  	; 16/11/2023
  1880 00000DA1 49                      	dec	ecx
  1881 00000DA2 7407                    	jz	short lff8s2_2
  1882 00000DA4 668B06                  	mov	ax, [esi]
  1883 00000DA7 668B5602                	mov	dx, [esi+2]
  1884                                  lff8s2_2:
  1885 00000DAB 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1886 00000DAE 66A3[B4200000]          	mov	[next_val_l], ax
  1887 00000DB4 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  1888 00000DB7 668915[B6200000]        	mov	[next_val_r], dx
  1889 00000DBE 660305[B0200000]        	add	ax, [previous_val_l]
  1890 00000DC5 66D1D8                  	rcr	ax, 1
  1891 00000DC8 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample (L)
  1892 00000DCA 660305[B0200000]        	add	ax, [previous_val_l]
  1893 00000DD1 66D1D8                  	rcr	ax, 1	
  1894 00000DD4 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1895 00000DD6 660305[B0200000]        	add	ax, [previous_val_l]
  1896 00000DDD 66D1D8                  	rcr	ax, 1
  1897 00000DE0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1898 00000DE3 66AB                    	stosw		; this is 1st interpolated sample (L)
  1899 00000DE5 66A1[B6200000]          	mov	ax, [next_val_r]
  1900 00000DEB 660305[B2200000]        	add	ax, [previous_val_r]
  1901 00000DF2 66D1D8                  	rcr	ax, 1
  1902 00000DF5 89C5                    	mov	ebp, eax ; this is interpolated middle (3th) sample (R)
  1903 00000DF7 660305[B2200000]        	add	ax, [previous_val_r]
  1904 00000DFE 66D1D8                  	rcr	ax, 1
  1905 00000E01 50                      	push	eax ; *	; this is temporary interpolation value (R)
  1906 00000E02 660305[B2200000]        	add	ax, [previous_val_r]
  1907 00000E09 66D1D8                  	rcr	ax, 1
  1908 00000E0C 80EC80                  	sub	ah, 80h
  1909 00000E0F 66AB                    	stosw		; this is 1st interpolated sample (R)
  1910 00000E11 89D8                    	mov	eax, ebx
  1911 00000E13 6601D0                  	add	ax, dx
  1912 00000E16 66D1D8                  	rcr	ax, 1
  1913 00000E19 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1914 00000E1C 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1915 00000E1E 58                      	pop	eax ; *
  1916 00000E1F 6601E8                  	add	ax, bp
  1917 00000E22 66D1D8                  	rcr	ax, 1
  1918 00000E25 80EC80                  	sub	ah, 80h
  1919 00000E28 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1920 00000E2A 89D0                    	mov	eax, edx
  1921 00000E2C 80EC80                  	sub	ah, 80h
  1922 00000E2F 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1923 00000E31 89E8                    	mov	eax, ebp
  1924 00000E33 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1925 00000E36 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1926 00000E38 66A1[B4200000]          	mov	ax, [next_val_l]
  1927 00000E3E 6601D0                  	add	ax, dx
  1928 00000E41 66D1D8                  	rcr	ax, 1
  1929 00000E44 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1930 00000E46 6601D0                  	add	ax, dx
  1931 00000E49 66D1D8                  	rcr	ax, 1
  1932 00000E4C 80EC80                  	sub	ah, 80h
  1933 00000E4F 66AB                    	stosw		; this is 4th interpolated sample (L)
  1934 00000E51 66A1[B6200000]          	mov	ax, [next_val_r]
  1935 00000E57 6601E8                  	add	ax, bp
  1936 00000E5A 66D1D8                  	rcr	ax, 1
  1937 00000E5D 50                      	push	eax ; ** ; this is temporary interpolation value (R)
  1938 00000E5E 6601E8                  	add	ax, bp
  1939 00000E61 66D1D8                  	rcr	ax, 1
  1940 00000E64 80EC80                  	sub	ah, 80h
  1941 00000E67 66AB                    	stosw		; this is 4th interpolated sample (R)
  1942 00000E69 66A1[B4200000]          	mov	ax, [next_val_l]
  1943 00000E6F 6601D8                  	add	ax, bx
  1944 00000E72 66D1D8                  	rcr	ax, 1
  1945 00000E75 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1946 00000E78 66AB                    	stosw		; this is 5th interpolated sample (L)
  1947 00000E7A 58                      	pop	eax ; **
  1948 00000E7B 660305[B6200000]        	add	ax, [next_val_r]
  1949 00000E82 66D1D8                  	rcr	ax, 1
  1950 00000E85 80EC80                  	sub	ah, 80h
  1951 00000E88 66AB                    	stosw		; this is 5th interpolated sample (R)
  1952                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1953 00000E8A E305                    	jecxz	lff8_s2_9
  1954 00000E8C E9F2FEFFFF              	jmp	lff8s2_1
  1955                                  lff8_s2_9:
  1956 00000E91 E992FCFFFF              	jmp	lff8s2_3
  1957                                  
  1958                                  ; .....................
  1959                                  
  1960                                  load_16khz_mono_8_bit:
  1961                                  	; 14/11/2023
  1962                                  	; 13/11/2023
  1963 00000E96 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1964                                  					; last of the file?
  1965 00000E9D 7402                    	jz	short lff16m_0		; no
  1966 00000E9F F9                      	stc
  1967 00000EA0 C3                      	retn
  1968                                  
  1969                                  lff16m_0:
  1970 00000EA1 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1971                                          ;mov	edx, [loadsize]
  1972                                  
  1973                                  	; esi = buffer address
  1974                                  	;; edx = buffer size
  1975                                  
  1976                                  	; load file into memory
  1977                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000EA6 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000EAC 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000EAE 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000EB4 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000EB9 CD40                <1>  int 40h
  1978 00000EBB 7253                    	jc	short lff16m_7 ; error !
  1979                                  
  1980 00000EBD BF[00800000]            	mov	edi, audio_buffer
  1981                                  	
  1982 00000EC2 21C0                    	and	eax, eax
  1983 00000EC4 7505                    	jnz	short lff16m_8
  1984 00000EC6 E975FCFFFF              	jmp	lff16_eof
  1985                                  
  1986                                  lff16m_8:
  1987 00000ECB 89C1                    	mov	ecx, eax		; byte count
  1988                                  lff16m_1:
  1989 00000ECD AC                      	lodsb
  1990                                  	;mov	[previous_val], al
  1991 00000ECE 88C3                    	mov	bl, al
  1992 00000ED0 2C80                    	sub	al, 80h
  1993 00000ED2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1994 00000ED6 66AB                    	stosw		; original sample (left channel)
  1995 00000ED8 66AB                    	stosw		; original sample (right channel)
  1996                                  	;xor	ax, ax
  1997                                  	; 14/11/22023
  1998 00000EDA B080                    	mov	al, 80h
  1999 00000EDC 49                      	dec	ecx
  2000 00000EDD 7402                    	jz	short lff16m_2
  2001 00000EDF 8A06                    	mov	al, [esi]
  2002                                  lff16m_2:
  2003                                  	;mov	[next_val], al
  2004 00000EE1 88C7                    	mov	bh, al
  2005                                  	;add	al, [previous_val]
  2006 00000EE3 00D8                    	add	al, bl
  2007 00000EE5 D0D8                    	rcr	al, 1
  2008 00000EE7 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  2009                                  	;add	al, [previous_val]
  2010 00000EE9 00D8                    	add	al, bl
  2011 00000EEB D0D8                    	rcr	al, 1
  2012 00000EED 2C80                    	sub	al, 80h
  2013 00000EEF 66C1E008                	shl	ax, 8
  2014 00000EF3 66AB                    	stosw		; this is 1st interpolated sample (L)
  2015 00000EF5 66AB                    	stosw		; this is 1st interpolated sample (R)
  2016                                  	;mov	al, [next_val]
  2017 00000EF7 88F8                    	mov	al, bh
  2018 00000EF9 00D0                    	add	al, dl
  2019 00000EFB D0D8                    	rcr	al, 1
  2020 00000EFD 2C80                    	sub	al, 80h
  2021 00000EFF 66C1E008                	shl	ax, 8
  2022 00000F03 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2023 00000F05 66AB                    	stosw		; this is 2nd interpolated sample (R)
  2024                                  	
  2025                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2026 00000F07 09C9                    	or	ecx, ecx
  2027 00000F09 75C2                    	jnz	short lff16m_1
  2028 00000F0B E918FCFFFF              	jmp	lff16m_3
  2029                                  
  2030                                  lff16m_7:
  2031                                  lff16s_7:
  2032 00000F10 E934FCFFFF              	jmp	lff16m_5  ; error
  2033                                  
  2034                                  load_16khz_stereo_8_bit:
  2035                                  	; 14/11/2023
  2036                                  	; 13/11/2023
  2037 00000F15 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2038                                  					; last of the file?
  2039 00000F1C 7402                    	jz	short lff16s_0		; no
  2040 00000F1E F9                      	stc
  2041 00000F1F C3                      	retn
  2042                                  
  2043                                  lff16s_0:
  2044 00000F20 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2045                                          ;mov	edx, [loadsize]
  2046                                  
  2047                                  	; esi = buffer address
  2048                                  	;; edx = buffer size
  2049                                  
  2050                                  	; load file into memory
  2051                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000F25 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000F2B 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000F2D 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000F33 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000F38 CD40                <1>  int 40h
  2052 00000F3A 72D4                    	jc	short lff16s_7 ; error !
  2053                                  
  2054 00000F3C BF[00800000]            	mov	edi, audio_buffer
  2055                                  	
  2056 00000F41 D1E8                    	shr	eax, 1
  2057 00000F43 7505                    	jnz	short lff16s_8
  2058 00000F45 E9F6FBFFFF              	jmp	lff16_eof
  2059                                  
  2060                                  lff16s_8:
  2061 00000F4A 89C1                    	mov	ecx, eax	; word count
  2062                                  lff16s_1:
  2063 00000F4C AC                      	lodsb
  2064 00000F4D A2[B0200000]            	mov	[previous_val_l], al
  2065 00000F52 2C80                    	sub	al, 80h
  2066 00000F54 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2067 00000F58 66AB                    	stosw		; original sample (L)
  2068 00000F5A AC                      	lodsb
  2069 00000F5B A2[B2200000]            	mov	[previous_val_r], al
  2070 00000F60 2C80                    	sub	al, 80h
  2071 00000F62 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2072 00000F66 66AB                    	stosw		; original sample (R)
  2073                                  
  2074                                  	;xor	eax, eax
  2075 00000F68 66B88080                	mov	ax, 8080h
  2076 00000F6C 49                      	dec	ecx
  2077 00000F6D 7403                    	jz	short lff16s_2
  2078                                  		; convert 8 bit sample to 16 bit sample
  2079 00000F6F 668B06                  	mov	ax, [esi]
  2080                                  lff16s_2:
  2081                                  	;mov	[next_val_l], al
  2082                                  	;mov	[next_val_r], ah
  2083 00000F72 89C3                    	mov	ebx, eax
  2084 00000F74 0205[B0200000]          	add	al, [previous_val_l]
  2085 00000F7A D0D8                    	rcr	al, 1
  2086 00000F7C 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  2087 00000F7E 0205[B0200000]          	add	al, [previous_val_l]
  2088 00000F84 D0D8                    	rcr	al, 1
  2089 00000F86 2C80                    	sub	al, 80h
  2090 00000F88 66C1E008                	shl	ax, 8
  2091 00000F8C 66AB                    	stosw		; this is 1st interpolated sample (L)
  2092 00000F8E 88F8                    	mov	al, bh	; [next_val_r]
  2093 00000F90 0205[B2200000]          	add	al, [previous_val_r]
  2094 00000F96 D0D8                    	rcr	al, 1
  2095 00000F98 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  2096 00000F9A 0205[B2200000]          	add	al, [previous_val_r]
  2097 00000FA0 D0D8                    	rcr	al, 1
  2098 00000FA2 2C80                    	sub	al, 80h
  2099 00000FA4 66C1E008                	shl	ax, 8
  2100 00000FA8 66AB                    	stosw		; this is 1st interpolated sample (R)
  2101 00000FAA 88D0                    	mov	al, dl
  2102 00000FAC 00D8                    	add	al, bl	; [next_val_l]
  2103 00000FAE D0D8                    	rcr	al, 1
  2104 00000FB0 2C80                    	sub	al, 80h
  2105 00000FB2 66C1E008                	shl	ax, 8
  2106 00000FB6 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2107 00000FB8 88F0                    	mov	al, dh
  2108 00000FBA 00F8                    	add	al, bh	; [next_val_r]
  2109 00000FBC D0D8                    	rcr	al, 1
  2110 00000FBE 2C80                    	sub	al, 80h
  2111 00000FC0 66C1E008                	shl	ax, 8
  2112 00000FC4 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  2113                                  	
  2114                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2115 00000FC6 09C9                    	or	ecx, ecx
  2116 00000FC8 7582                    	jnz	short lff16s_1
  2117 00000FCA E959FBFFFF              	jmp	lff16s_3
  2118                                  
  2119                                  load_16khz_mono_16_bit:
  2120                                  	; 15/11/2023
  2121                                  	; 13/11/2023
  2122 00000FCF F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2123                                  					; last of the file?
  2124 00000FD6 7402                    	jz	short lff16m2_0		; no
  2125 00000FD8 F9                      	stc
  2126 00000FD9 C3                      	retn
  2127                                  
  2128                                  lff16m2_0:
  2129 00000FDA BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2130                                          ;mov	edx, [loadsize]
  2131                                  
  2132                                  	; esi = buffer address
  2133                                  	;; edx = buffer size
  2134                                  
  2135                                  	; load file into memory
  2136                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000FDF 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000FE5 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000FE7 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000FED B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000FF2 CD40                <1>  int 40h
  2137 00000FF4 7255                    	jc	short lff16m2_7 ; error !
  2138                                  
  2139 00000FF6 BF[00800000]            	mov	edi, audio_buffer
  2140                                  	
  2141 00000FFB D1E8                    	shr	eax, 1
  2142 00000FFD 7505                    	jnz	short lff16m2_8
  2143 00000FFF E93CFBFFFF              	jmp	lff16_eof
  2144                                  
  2145                                  lff16m2_8:
  2146 00001004 89C1                    	mov	ecx, eax  ; word count
  2147                                  lff16m2_1:
  2148 00001006 66AD                    	lodsw
  2149 00001008 66AB                    	stosw		; original sample (left channel)
  2150 0000100A 66AB                    	stosw		; original sample (right channel)
  2151 0000100C 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2152                                  	;mov	[previous_val], ax
  2153 0000100F 89C3                    	mov	ebx, eax	
  2154 00001011 31C0                    	xor	eax, eax
  2155 00001013 49                      	dec	ecx
  2156 00001014 7403                    	jz	short lff16m2_2
  2157 00001016 668B06                  	mov	ax, [esi]
  2158                                  lff16m2_2:
  2159 00001019 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2160 0000101C 89C5                    	mov	ebp, eax	; [next_val]
  2161                                  	;add	ax, [previous_val]
  2162 0000101E 6601D8                  	add	ax, bx
  2163 00001021 66D1D8                  	rcr	ax, 1
  2164 00001024 89C2                    	mov	edx, eax ; this is temporary interpolation value
  2165                                  	;add	ax, [previous_val]
  2166 00001026 6601D8                  	add	ax, bx
  2167 00001029 66D1D8                  	rcr	ax, 1
  2168 0000102C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2169 0000102F 66AB                    	stosw		; this is 1st interpolated sample (L)
  2170 00001031 66AB                    	stosw		; this is 1st interpolated sample (R)
  2171 00001033 89E8                    	mov	eax, ebp 
  2172 00001035 6601D0                  	add	ax, dx
  2173 00001038 66D1D8                  	rcr	ax, 1
  2174 0000103B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2175 0000103E 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2176 00001040 66AB                    	stosw		; this is 2nd interpolated sample (R)
  2177                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2178 00001042 09C9                    	or	ecx, ecx
  2179 00001044 75C0                    	jnz	short lff16m2_1
  2180 00001046 E9DDFAFFFF              	jmp	lff16m2_3
  2181                                  
  2182                                  lff16m2_7:
  2183                                  lff16s2_7:
  2184 0000104B E9F9FAFFFF              	jmp	lff16m2_5  ; error
  2185                                  
  2186                                  load_16khz_stereo_16_bit:
  2187                                  	; 16/11/2023
  2188                                  	; 15/11/2023
  2189                                  	; 13/11/2023
  2190 00001050 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2191                                  					; last of the file?
  2192 00001057 7402                    	jz	short lff16s2_0		; no
  2193 00001059 F9                      	stc
  2194 0000105A C3                      	retn
  2195                                  
  2196                                  lff16s2_0:
  2197 0000105B BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2198                                          ;mov	edx, [loadsize]
  2199                                  
  2200                                  	; esi = buffer address
  2201                                  	;; edx = buffer size
  2202                                  
  2203                                  	; load file into memory
  2204                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001060 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001066 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001068 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000106E B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001073 CD40                <1>  int 40h
  2205 00001075 72D4                    	jc	short lff16s2_7 ; error !
  2206                                  
  2207 00001077 BF[00800000]            	mov	edi, audio_buffer
  2208                                  	
  2209 0000107C C1E802                  	shr	eax, 2
  2210 0000107F 7505                    	jnz	short lff16s2_8
  2211 00001081 E9BAFAFFFF              	jmp	lff16_eof
  2212                                  
  2213                                  lff16s2_8:
  2214 00001086 89C1                    	mov	ecx, eax  ; dword count
  2215                                  lff16s2_1:
  2216 00001088 66AD                    	lodsw
  2217 0000108A 66AB                    	stosw		; original sample (L)
  2218 0000108C 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2219 0000108F 66A3[B0200000]          	mov	[previous_val_l], ax
  2220 00001095 66AD                    	lodsw
  2221 00001097 66AB                    	stosw		; original sample (R)
  2222 00001099 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2223 0000109C 66A3[B2200000]          	mov	[previous_val_r], ax
  2224 000010A2 31D2                    	xor	edx, edx
  2225 000010A4 31C0                    	xor	eax, eax
  2226                                  	; 16/11/2023
  2227 000010A6 49                      	dec	ecx
  2228 000010A7 7407                    	jz	short lff16s2_2
  2229 000010A9 668B06                  	mov	ax, [esi]
  2230 000010AC 668B5602                	mov	dx, [esi+2]
  2231                                  lff16s2_2:
  2232 000010B0 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2233                                  	;mov	[next_val_l], ax
  2234 000010B3 89C5                    	mov	ebp, eax
  2235 000010B5 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2236 000010B8 668915[B6200000]        	mov	[next_val_r], dx
  2237 000010BF 660305[B0200000]        	add	ax, [previous_val_l]
  2238 000010C6 66D1D8                  	rcr	ax, 1
  2239 000010C9 89C2                    	mov	edx, eax ; this is temporary interpolation value (L)
  2240 000010CB 660305[B0200000]        	add	ax, [previous_val_l]
  2241 000010D2 66D1D8                  	rcr	ax, 1
  2242 000010D5 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2243 000010D8 66AB                    	stosw		; this is 1st interpolated sample (L)
  2244 000010DA 66A1[B6200000]          	mov	ax, [next_val_r]
  2245 000010E0 660305[B2200000]        	add	ax, [previous_val_r]
  2246 000010E7 66D1D8                  	rcr	ax, 1
  2247 000010EA 89C3                    	mov	ebx, eax ; this is temporary interpolation value (R)
  2248 000010EC 660305[B2200000]        	add	ax, [previous_val_r]
  2249 000010F3 66D1D8                  	rcr	ax, 1
  2250 000010F6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2251 000010F9 66AB                    	stosw		; this is 1st interpolated sample (R)
  2252                                  	;mov	ax, [next_val_l]
  2253 000010FB 89E8                    	mov	eax, ebp
  2254 000010FD 6601D0                  	add	ax, dx
  2255 00001100 66D1D8                  	rcr	ax, 1
  2256 00001103 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2257 00001106 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2258 00001108 66A1[B6200000]          	mov	ax, [next_val_r]
  2259 0000110E 6601D8                  	add	ax, bx
  2260 00001111 66D1D8                  	rcr	ax, 1
  2261 00001114 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2262 00001117 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  2263                                  	
  2264                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2265 00001119 09C9                    	or	ecx, ecx
  2266 0000111B 0F8567FFFFFF            	jnz	lff16s2_1
  2267 00001121 E902FAFFFF              	jmp	lff16s2_3
  2268                                  
  2269                                  ; .....................
  2270                                  
  2271                                  load_24khz_mono_8_bit:
  2272                                  	; 15/11/2023
  2273 00001126 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2274                                  					; last of the file?
  2275 0000112D 7402                    	jz	short lff24m_0		; no
  2276 0000112F F9                      	stc
  2277 00001130 C3                      	retn
  2278                                  
  2279                                  lff24m_0:
  2280 00001131 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2281                                          ;mov	edx, [loadsize]
  2282                                  
  2283                                  	; esi = buffer address
  2284                                  	;; edx = buffer size
  2285                                  
  2286                                  	; load file into memory
  2287                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001136 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000113C 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000113E 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001144 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001149 CD40                <1>  int 40h
  2288 0000114B 723B                    	jc	short lff24m_7 ; error !
  2289                                  
  2290 0000114D BF[00800000]            	mov	edi, audio_buffer
  2291                                  	
  2292 00001152 21C0                    	and	eax, eax
  2293 00001154 7505                    	jnz	short lff24m_8
  2294 00001156 E9E5F9FFFF              	jmp	lff24_eof
  2295                                  
  2296                                  lff24m_8:
  2297 0000115B 89C1                    	mov	ecx, eax	; byte count
  2298                                  lff24m_1:
  2299 0000115D AC                      	lodsb
  2300                                  	;mov	[previous_val], al
  2301 0000115E 88C3                    	mov	bl, al
  2302 00001160 2C80                    	sub	al, 80h
  2303 00001162 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2304 00001166 66AB                    	stosw		; original sample (left channel)
  2305 00001168 66AB                    	stosw		; original sample (right channel)
  2306                                  	;xor	eax, eax
  2307 0000116A B080                    	mov	al, 80h
  2308 0000116C 49                      	dec	ecx
  2309 0000116D 7402                    	jz	short lff24m_2
  2310 0000116F 8A06                    	mov	al, [esi]
  2311                                  lff24m_2:
  2312                                  	;;mov	[next_val], al
  2313                                  	;mov	bh, al
  2314                                  	;add	al, [previous_val]
  2315 00001171 00D8                    	add	al, bl
  2316 00001173 D0D8                    	rcr	al, 1
  2317 00001175 2C80                    	sub	al, 80h
  2318 00001177 66C1E008                	shl	ax, 8
  2319 0000117B 66AB                    	stosw		; this is interpolated sample (L)
  2320 0000117D 66AB                    	stosw		; this is interpolated sample (R)
  2321                                  	
  2322                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2323 0000117F 09C9                    	or	ecx, ecx
  2324 00001181 75DA                    	jnz	short lff24m_1
  2325 00001183 E9A0F9FFFF              	jmp	lff24_3
  2326                                  
  2327                                  lff24m_7:
  2328                                  lff24s_7:
  2329 00001188 E9BCF9FFFF              	jmp	lff24_5  ; error
  2330                                  
  2331                                  load_24khz_stereo_8_bit:
  2332                                  	; 15/11/2023
  2333 0000118D F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2334                                  					; last of the file?
  2335 00001194 7402                    	jz	short lff24s_0		; no
  2336 00001196 F9                      	stc
  2337 00001197 C3                      	retn
  2338                                  
  2339                                  lff24s_0:
  2340 00001198 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2341                                          ;mov	edx, [loadsize]
  2342                                  
  2343                                  	; esi = buffer address
  2344                                  	;; edx = buffer size
  2345                                  
  2346                                  	; load file into memory
  2347                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000119D 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000011A3 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000011A5 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000011AB B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000011B0 CD40                <1>  int 40h
  2348 000011B2 72D4                    	jc	short lff24s_7 ; error !
  2349                                  
  2350 000011B4 BF[00800000]            	mov	edi, audio_buffer
  2351                                  	
  2352 000011B9 D1E8                    	shr	eax, 1
  2353 000011BB 7505                    	jnz	short lff24s_8
  2354 000011BD E97EF9FFFF              	jmp	lff24_eof
  2355                                  
  2356                                  lff24s_8:
  2357 000011C2 89C1                    	mov	ecx, eax  ; word count
  2358                                  lff24s_1:
  2359 000011C4 AC                      	lodsb
  2360 000011C5 A2[B0200000]            	mov	[previous_val_l], al
  2361 000011CA 2C80                    	sub	al, 80h
  2362 000011CC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2363 000011D0 66AB                    	stosw		; original sample (L)
  2364 000011D2 AC                      	lodsb
  2365 000011D3 A2[B2200000]            	mov	[previous_val_r], al
  2366 000011D8 2C80                    	sub	al, 80h
  2367 000011DA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2368 000011DE 66AB                    	stosw		; original sample (R)
  2369                                  
  2370                                  	;xor	eax, eax
  2371 000011E0 66B88080                	mov	ax, 8080h
  2372 000011E4 49                      	dec	ecx
  2373 000011E5 7403                    	jz	short lff24s_2
  2374                                  		; convert 8 bit sample to 16 bit sample
  2375 000011E7 668B06                  	mov	ax, [esi]
  2376                                  lff24s_2:
  2377                                  	;;mov	[next_val_l], al
  2378                                  	;;mov	[next_val_r], ah
  2379                                  	;mov	bx, ax
  2380 000011EA 88E7                    	mov	bh, ah
  2381 000011EC 0205[B0200000]          	add	al, [previous_val_l]
  2382 000011F2 D0D8                    	rcr	al, 1
  2383                                  	;mov	dl, al
  2384 000011F4 2C80                    	sub	al, 80h
  2385 000011F6 66C1E008                	shl	ax, 8
  2386 000011FA 66AB                    	stosw		; this is interpolated sample (L)
  2387 000011FC 88F8                    	mov	al, bh	; [next_val_r]
  2388 000011FE 0205[B2200000]          	add	al, [previous_val_r]
  2389 00001204 D0D8                    	rcr	al, 1
  2390                                  	;mov	dh, al
  2391 00001206 2C80                    	sub	al, 80h
  2392 00001208 66C1E008                	shl	ax, 8
  2393 0000120C 66AB                    	stosw		; this is interpolated sample (R)
  2394                                  		
  2395                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2396 0000120E 09C9                    	or	ecx, ecx
  2397 00001210 75B2                    	jnz	short lff24s_1
  2398 00001212 E911F9FFFF              	jmp	lff24_3
  2399                                  
  2400                                  load_24khz_mono_16_bit:
  2401                                  	; 15/11/2023
  2402 00001217 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2403                                  					; last of the file?
  2404 0000121E 7402                    	jz	short lff24m2_0		; no
  2405 00001220 F9                      	stc
  2406 00001221 C3                      	retn
  2407                                  
  2408                                  lff24m2_0:
  2409 00001222 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2410                                          ;mov	edx, [loadsize]
  2411                                  
  2412                                  	; esi = buffer address
  2413                                  	;; edx = buffer size
  2414                                  
  2415                                  	; load file into memory
  2416                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001227 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000122D 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000122F 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001235 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000123A CD40                <1>  int 40h
  2417 0000123C 7237                    	jc	short lff24m2_7 ; error !
  2418                                  
  2419 0000123E BF[00800000]            	mov	edi, audio_buffer
  2420                                  	
  2421 00001243 D1E8                    	shr	eax, 1
  2422 00001245 7505                    	jnz	short lff24m2_8
  2423 00001247 E9F4F8FFFF              	jmp	lff24_eof
  2424                                  
  2425                                  lff24m2_8:
  2426 0000124C 89C1                    	mov	ecx, eax  ; word count
  2427                                  lff24m2_1:
  2428 0000124E 66AD                    	lodsw
  2429 00001250 66AB                    	stosw		; original sample (left channel)
  2430 00001252 66AB                    	stosw		; original sample (right channel)
  2431 00001254 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2432                                  	;mov	[previous_val], ax
  2433                                  	;mov	ebx, eax	
  2434                                  	;xor	eax, eax
  2435 00001257 31DB                    	xor	ebx, ebx
  2436 00001259 49                      	dec	ecx
  2437 0000125A 7403                    	jz	short lff24m2_2
  2438                                  	;mov	ax, [esi]
  2439 0000125C 668B1E                  	mov	bx, [esi]
  2440                                  lff24m2_2:
  2441                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2442                                  	;mov	ebp, eax	; [next_val]
  2443                                  	;add	ax, [previous_val]
  2444                                  	; ax = [previous_val]
  2445                                  	; bx = [next_val]
  2446 0000125F 6601D8                  	add	ax, bx
  2447 00001262 66D1D8                  	rcr	ax, 1
  2448 00001265 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2449 00001268 66AB                    	stosw		; this is interpolated sample (L)
  2450 0000126A 66AB                    	stosw		; this is interpolated sample (R)
  2451                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2452 0000126C 09C9                    	or	ecx, ecx
  2453 0000126E 75DE                    	jnz	short lff24m2_1
  2454 00001270 E9B3F8FFFF              	jmp	lff24_3
  2455                                  
  2456                                  lff24m2_7:
  2457                                  lff24s2_7:
  2458 00001275 E9CFF8FFFF              	jmp	lff24_5  ; error
  2459                                  
  2460                                  load_24khz_stereo_16_bit:
  2461                                  	; 16/11/2023
  2462                                  	; 15/11/2023
  2463 0000127A F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2464                                  					; last of the file?
  2465 00001281 7402                    	jz	short lff24s2_0		; no
  2466 00001283 F9                      	stc
  2467 00001284 C3                      	retn
  2468                                  
  2469                                  lff24s2_0:
  2470 00001285 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2471                                          ;mov	edx, [loadsize]
  2472                                  
  2473                                  	; esi = buffer address
  2474                                  	;; edx = buffer size
  2475                                  
  2476                                  	; load file into memory
  2477                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000128A 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001290 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001292 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001298 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000129D CD40                <1>  int 40h
  2478 0000129F 72D4                    	jc	short lff24s2_7 ; error !
  2479                                  
  2480 000012A1 BF[00800000]            	mov	edi, audio_buffer
  2481                                  	
  2482 000012A6 C1E802                  	shr	eax, 2
  2483 000012A9 7505                    	jnz	short lff24s2_8
  2484 000012AB E990F8FFFF              	jmp	lff24_eof
  2485                                  
  2486                                  lff24s2_8:
  2487 000012B0 89C1                    	mov	ecx, eax  ; dword count
  2488                                  lff24s2_1:
  2489 000012B2 66AD                    	lodsw
  2490 000012B4 66AB                    	stosw		; original sample (L)
  2491 000012B6 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2492 000012B9 66A3[B0200000]          	mov	[previous_val_l], ax
  2493 000012BF 66AD                    	lodsw
  2494 000012C1 66AB                    	stosw		; original sample (R)
  2495 000012C3 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2496                                  	;mov	[previous_val_r], ax
  2497 000012C6 89C3                    	mov	ebx, eax
  2498 000012C8 31D2                    	xor	edx, edx
  2499 000012CA 31C0                    	xor	eax, eax
  2500                                  	; 16/11/2023
  2501 000012CC 49                      	dec	ecx
  2502 000012CD 7407                    	jz	short lff24s2_2
  2503 000012CF 668B06                  	mov	ax, [esi]
  2504 000012D2 668B5602                	mov	dx, [esi+2]
  2505                                  lff24s2_2:
  2506 000012D6 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2507                                  	;;mov	[next_val_l], ax
  2508                                  	;mov	ebp, eax
  2509 000012D9 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2510                                  	;mov	[next_val_r], dx
  2511 000012DC 660305[B0200000]        	add	ax, [previous_val_l]
  2512 000012E3 66D1D8                  	rcr	ax, 1
  2513 000012E6 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2514 000012E9 66AB                    	stosw		; this is interpolated sample (L)
  2515                                  	;mov	ax, [next_val_r]
  2516 000012EB 89D0                    	mov	eax, edx
  2517                                  	;add	ax, [previous_val_r]
  2518 000012ED 6601D8                  	add	ax, bx
  2519 000012F0 66D1D8                  	rcr	ax, 1
  2520 000012F3 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2521 000012F6 66AB                    	stosw		; this is interpolated sample (R)
  2522                                  	
  2523                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2524 000012F8 09C9                    	or	ecx, ecx
  2525 000012FA 75B6                    	jnz	short lff24s2_1
  2526 000012FC E927F8FFFF              	jmp	lff24_3
  2527                                  
  2528                                  ; .....................
  2529                                  
  2530                                  load_32khz_mono_8_bit:
  2531                                  	; 15/11/2023
  2532 00001301 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2533                                  					; last of the file?
  2534 00001308 7402                    	jz	short lff32m_0		; no
  2535 0000130A F9                      	stc
  2536 0000130B C3                      	retn
  2537                                  
  2538                                  lff32m_0:
  2539 0000130C BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2540                                          ;mov	edx, [loadsize]
  2541                                  
  2542                                  	; esi = buffer address
  2543                                  	;; edx = buffer size
  2544                                  
  2545                                  	; load file into memory
  2546                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001311 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001317 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001319 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000131F B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001324 CD40                <1>  int 40h
  2547 00001326 7247                    	jc	short lff32m_7 ; error !
  2548                                  
  2549 00001328 BF[00800000]            	mov	edi, audio_buffer
  2550                                  	
  2551 0000132D 21C0                    	and	eax, eax
  2552 0000132F 7505                    	jnz	short lff32m_8
  2553 00001331 E90AF8FFFF              	jmp	lff32_eof
  2554                                  
  2555                                  lff32m_8:
  2556 00001336 89C1                    	mov	ecx, eax	; byte count
  2557                                  lff32m_1:
  2558 00001338 AC                      	lodsb
  2559                                  	;mov	[previous_val], al
  2560 00001339 88C3                    	mov	bl, al
  2561 0000133B 2C80                    	sub	al, 80h
  2562 0000133D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2563 00001341 66AB                    	stosw		; original sample (left channel)
  2564 00001343 66AB                    	stosw		; original sample (right channel)
  2565                                  	;xor	eax, eax
  2566 00001345 B080                    	mov	al, 80h
  2567 00001347 49                      	dec	ecx
  2568 00001348 7402                    	jz	short lff32m_2
  2569 0000134A 8A06                    	mov	al, [esi]
  2570                                  lff32m_2:
  2571                                  	;;mov	[next_val], al
  2572                                  	;mov	bh, al
  2573                                  	;add	al, [previous_val]
  2574 0000134C 00D8                    	add	al, bl
  2575 0000134E D0D8                    	rcr	al, 1
  2576 00001350 2C80                    	sub	al, 80h
  2577 00001352 66C1E008                	shl	ax, 8
  2578 00001356 66AB                    	stosw		; this is interpolated sample (L)
  2579 00001358 66AB                    	stosw		; this is interpolated sample (R)
  2580                                  	
  2581                                  	; different than 8-16-24 kHZ !
  2582                                  	; 'original-interpolated-original' trio samples 
  2583 0000135A E30E                    	jecxz	lff32m_3
  2584                                  
  2585 0000135C AC                      	lodsb
  2586 0000135D 2C80                    	sub	al, 80h
  2587 0000135F 66C1E008                	shl	ax, 8
  2588 00001363 66AB                    	stosw		; original sample (left channel)
  2589 00001365 66AB                    	stosw		; original sample (right channel)
  2590                                  
  2591                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2592 00001367 49                      	dec	ecx
  2593 00001368 75CE                    	jnz	short lff32m_1
  2594                                  lff32m_3:
  2595 0000136A E9B9F7FFFF              	jmp	lff32_3
  2596                                  
  2597                                  lff32m_7:
  2598                                  lff32s_7:
  2599 0000136F E9D5F7FFFF              	jmp	lff32_5  ; error
  2600                                  
  2601                                  load_32khz_stereo_8_bit:
  2602                                  	; 15/11/2023
  2603 00001374 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2604                                  					; last of the file?
  2605 0000137B 7402                    	jz	short lff32s_0		; no
  2606 0000137D F9                      	stc
  2607 0000137E C3                      	retn
  2608                                  
  2609                                  lff32s_0:
  2610 0000137F BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2611                                          ;mov	edx, [loadsize]
  2612                                  
  2613                                  	; esi = buffer address
  2614                                  	;; edx = buffer size
  2615                                  
  2616                                  	; load file into memory
  2617                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001384 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000138A 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000138C 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001392 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001397 CD40                <1>  int 40h
  2618 00001399 72D4                    	jc	short lff32s_7 ; error !
  2619                                  
  2620 0000139B BF[00800000]            	mov	edi, audio_buffer
  2621                                  	
  2622 000013A0 D1E8                    	shr	eax, 1
  2623 000013A2 7505                    	jnz	short lff32s_8
  2624 000013A4 E997F7FFFF              	jmp	lff32_eof
  2625                                  
  2626                                  lff32s_8:
  2627 000013A9 89C1                    	mov	ecx, eax  ; word count
  2628                                  lff32s_1:
  2629 000013AB AC                      	lodsb
  2630 000013AC A2[B0200000]            	mov	[previous_val_l], al
  2631 000013B1 2C80                    	sub	al, 80h
  2632 000013B3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2633 000013B7 66AB                    	stosw		; original sample (L)
  2634 000013B9 AC                      	lodsb
  2635 000013BA A2[B2200000]            	mov	[previous_val_r], al
  2636 000013BF 2C80                    	sub	al, 80h
  2637 000013C1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2638 000013C5 66AB                    	stosw		; original sample (R)
  2639                                  
  2640                                  	;xor	eax, eax
  2641 000013C7 66B88080                	mov	ax, 8080h
  2642 000013CB 49                      	dec	ecx
  2643 000013CC 7403                    	jz	short lff32s_2
  2644                                  		; convert 8 bit sample to 16 bit sample
  2645 000013CE 668B06                  	mov	ax, [esi]
  2646                                  lff32s_2:
  2647                                  	;;mov	[next_val_l], al
  2648                                  	;;mov	[next_val_r], ah
  2649                                  	;mov	bx, ax
  2650 000013D1 88E7                    	mov	bh, ah
  2651 000013D3 0205[B0200000]          	add	al, [previous_val_l]
  2652 000013D9 D0D8                    	rcr	al, 1
  2653                                  	;mov	dl, al
  2654 000013DB 2C80                    	sub	al, 80h
  2655 000013DD 66C1E008                	shl	ax, 8
  2656 000013E1 66AB                    	stosw		; this is interpolated sample (L)
  2657 000013E3 88F8                    	mov	al, bh	; [next_val_r]
  2658 000013E5 0205[B2200000]          	add	al, [previous_val_r]
  2659 000013EB D0D8                    	rcr	al, 1
  2660                                  	;mov	dh, al
  2661 000013ED 2C80                    	sub	al, 80h
  2662 000013EF 66C1E008                	shl	ax, 8
  2663 000013F3 66AB                    	stosw		; this is interpolated sample (R)
  2664                                  
  2665                                  	; different than 8-16-24 kHZ !
  2666                                  	; 'original-interpolated-original' trio samples 
  2667 000013F5 E315                    	jecxz	lff32s_3
  2668                                  
  2669 000013F7 AC                      	lodsb
  2670 000013F8 2C80                    	sub	al, 80h
  2671 000013FA 66C1E008                	shl	ax, 8
  2672 000013FE 66AB                    	stosw		; original sample (left channel)
  2673                                  
  2674 00001400 AC                      	lodsb
  2675 00001401 2C80                    	sub	al, 80h
  2676 00001403 66C1E008                	shl	ax, 8
  2677 00001407 66AB                    	stosw		; original sample (right channel)
  2678                                  		
  2679                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2680 00001409 49                      	dec	ecx
  2681 0000140A 759F                    	jnz	short lff32s_1
  2682                                  lff32s_3:
  2683 0000140C E917F7FFFF              	jmp	lff32_3
  2684                                  
  2685                                  load_32khz_mono_16_bit:
  2686                                  	; 15/11/2023
  2687 00001411 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2688                                  					; last of the file?
  2689 00001418 7402                    	jz	short lff32m2_0		; no
  2690 0000141A F9                      	stc
  2691 0000141B C3                      	retn
  2692                                  
  2693                                  lff32m2_0:
  2694 0000141C BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2695                                          ;mov	edx, [loadsize]
  2696                                  
  2697                                  	; esi = buffer address
  2698                                  	;; edx = buffer size
  2699                                  
  2700                                  	; load file into memory
  2701                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001421 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001427 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001429 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000142F B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001434 CD40                <1>  int 40h
  2702 00001436 723E                    	jc	short lff32m2_7 ; error !
  2703                                  
  2704 00001438 BF[00800000]            	mov	edi, audio_buffer
  2705                                  	
  2706 0000143D D1E8                    	shr	eax, 1
  2707 0000143F 7505                    	jnz	short lff32m2_8
  2708 00001441 E9FAF6FFFF              	jmp	lff32_eof
  2709                                  
  2710                                  lff32m2_8:
  2711 00001446 89C1                    	mov	ecx, eax  ; word count
  2712                                  lff32m2_1:
  2713 00001448 66AD                    	lodsw
  2714 0000144A 66AB                    	stosw		; original sample (left channel)
  2715 0000144C 66AB                    	stosw		; original sample (right channel)
  2716 0000144E 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2717                                  	;mov	[previous_val], ax
  2718                                  	;mov	ebx, eax	
  2719                                  	;xor	eax, eax
  2720 00001451 31DB                    	xor	ebx, ebx
  2721 00001453 49                      	dec	ecx
  2722 00001454 7403                    	jz	short lff32m2_2
  2723                                  	;mov	ax, [esi]
  2724 00001456 668B1E                  	mov	bx, [esi]
  2725                                  lff32m2_2:
  2726                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2727                                  	;mov	ebp, eax	; [next_val]
  2728                                  	;add	ax, [previous_val]
  2729                                  	; ax = [previous_val]
  2730                                  	; bx = [next_val]
  2731 00001459 6601D8                  	add	ax, bx
  2732 0000145C 66D1D8                  	rcr	ax, 1
  2733 0000145F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2734 00001462 66AB                    	stosw		; this is interpolated sample (L)
  2735 00001464 66AB                    	stosw		; this is interpolated sample (R)
  2736                                  
  2737                                  	; different than 8-16-24 kHZ !
  2738                                  	; 'original-interpolated-original' trio samples 
  2739 00001466 E309                    	jecxz	lff32m2_3
  2740                                  
  2741 00001468 66AD                    	lodsw
  2742 0000146A 66AB                    	stosw		; original sample (left channel)
  2743 0000146C 66AB                    	stosw		; original sample (right channel)
  2744                                  
  2745                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2746 0000146E 49                      	dec	ecx
  2747 0000146F 75D7                    	jnz	short lff32m2_1
  2748                                  lff32m2_3:
  2749 00001471 E9B2F6FFFF              	jmp	lff32_3
  2750                                  
  2751                                  lff32m2_7:
  2752                                  lff32s2_7:
  2753 00001476 E9CEF6FFFF              	jmp	lff32_5  ; error
  2754                                  
  2755                                  load_32khz_stereo_16_bit:
  2756                                  	; 16/11/2023
  2757                                  	; 15/11/2023
  2758 0000147B F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2759                                  					; last of the file?
  2760 00001482 7402                    	jz	short lff32s2_0		; no
  2761 00001484 F9                      	stc
  2762 00001485 C3                      	retn
  2763                                  
  2764                                  lff32s2_0:
  2765 00001486 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2766                                          ;mov	edx, [loadsize]
  2767                                  
  2768                                  	; esi = buffer address
  2769                                  	;; edx = buffer size
  2770                                  
  2771                                  	; load file into memory
  2772                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000148B 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001491 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001493 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001499 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000149E CD40                <1>  int 40h
  2773 000014A0 72D4                    	jc	short lff32s2_7 ; error !
  2774                                  
  2775 000014A2 BF[00800000]            	mov	edi, audio_buffer
  2776                                  	
  2777 000014A7 C1E802                  	shr	eax, 2
  2778 000014AA 7505                    	jnz	short lff32s2_8
  2779 000014AC E98FF6FFFF              	jmp	lff32_eof
  2780                                  
  2781                                  lff32s2_8:
  2782 000014B1 89C1                    	mov	ecx, eax ; dword count
  2783                                  lff32s2_1:
  2784 000014B3 66AD                    	lodsw
  2785 000014B5 66AB                    	stosw		; original sample (L)
  2786 000014B7 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2787 000014BA 66A3[B0200000]          	mov	[previous_val_l], ax
  2788 000014C0 66AD                    	lodsw
  2789 000014C2 66AB                    	stosw		; original sample (R)
  2790 000014C4 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2791                                  	;mov	[previous_val_r], ax
  2792 000014C7 89C3                    	mov	ebx, eax
  2793 000014C9 31D2                    	xor	edx, edx
  2794 000014CB 31C0                    	xor	eax, eax
  2795                                  	; 16/11/2023
  2796 000014CD 49                      	dec	ecx
  2797 000014CE 7407                    	jz	short lff32s2_2
  2798 000014D0 668B06                  	mov	ax, [esi]
  2799 000014D3 668B5602                	mov	dx, [esi+2]
  2800                                  lff32s2_2:
  2801 000014D7 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2802                                  	;;mov	[next_val_l], ax
  2803                                  	;mov	ebp, eax
  2804 000014DA 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2805                                  	;mov	[next_val_r], dx
  2806 000014DD 660305[B0200000]        	add	ax, [previous_val_l]
  2807 000014E4 66D1D8                  	rcr	ax, 1
  2808 000014E7 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2809 000014EA 66AB                    	stosw		; this is interpolated sample (L)
  2810                                  	;mov	ax, [next_val_r]
  2811 000014EC 89D0                    	mov	eax, edx
  2812                                  	;add	ax, [previous_val_r]
  2813 000014EE 6601D8                  	add	ax, bx
  2814 000014F1 66D1D8                  	rcr	ax, 1
  2815 000014F4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2816 000014F7 66AB                    	stosw		; this is interpolated sample (R)
  2817                                  
  2818                                  	; different than 8-16-24 kHZ !
  2819                                  	; 'original-interpolated-original' trio samples 
  2820 000014F9 E30B                    	jecxz	lff32s2_3
  2821                                  
  2822 000014FB 66AD                    	lodsw
  2823 000014FD 66AB                    	stosw	; original sample (L)
  2824 000014FF 66AD                    	lodsw
  2825 00001501 66AB                    	stosw	; original sample (R)
  2826                                  	
  2827                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2828 00001503 49                      	dec	ecx
  2829 00001504 75AD                    	jnz	short lff32s2_1
  2830                                  lff32s2_3:
  2831 00001506 E91DF6FFFF              	jmp	lff32_3
  2832                                  
  2833                                  ; .....................
  2834                                  
  2835                                  load_22khz_mono_8_bit:
  2836                                  	; 16/11/2023
  2837 0000150B F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2838                                  					; last of the file?
  2839 00001512 7402                    	jz	short lff22m_0		; no
  2840 00001514 F9                      	stc
  2841 00001515 C3                      	retn
  2842                                  
  2843                                  lff22m_0:
  2844 00001516 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2845                                          ;mov	edx, [loadsize]
  2846                                  
  2847                                  	; esi = buffer address
  2848                                  	;; edx = buffer size
  2849                                  
  2850                                  	; load file into memory
  2851                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000151B 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001521 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001523 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001529 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000152E CD40                <1>  int 40h
  2852 00001530 725D                    	jc	short lff22m_7 ; error !
  2853                                  
  2854 00001532 BF[00800000]            	mov	edi, audio_buffer
  2855                                  	
  2856 00001537 21C0                    	and	eax, eax
  2857 00001539 7505                    	jnz	short lff22m_8
  2858 0000153B E900F6FFFF              	jmp	lff22_eof
  2859                                  
  2860                                  lff22m_8:
  2861 00001540 89C1                    	mov	ecx, eax	; byte count
  2862                                  lff22m_9:
  2863 00001542 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2864 00001547 C605[B8200000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2865                                  lff22m_1:
  2866                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2867 0000154E AC                      	lodsb
  2868 0000154F B280                    	mov	dl, 80h
  2869 00001551 49                      	dec	ecx
  2870 00001552 7402                    	jz	short lff22m_2_1
  2871 00001554 8A16                    	mov	dl, [esi]
  2872                                  lff22m_2_1:	
  2873                                  	; al = [previous_val]
  2874                                  	; dl = [next_val]
  2875 00001556 E80F060000              	call	interpolating_3_8bit_mono ; 1 of 17
  2876 0000155B E32D                    	jecxz	lff22m_3
  2877                                  lff22m_2_2:
  2878 0000155D AC                      	lodsb
  2879 0000155E B280                    	mov	dl, 80h
  2880 00001560 49                      	dec	ecx
  2881 00001561 7402                    	jz	short lff22m_2_3
  2882 00001563 8A16                    	mov	dl, [esi]
  2883                                  lff22m_2_3:
  2884 00001565 E884060000               	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2885 0000156A E31E                    	jecxz	lff22m_3
  2886 0000156C 4D                      	dec	ebp
  2887 0000156D 75EE                    	jnz	short lff22m_2_2
  2888                                  
  2889 0000156F A0[B8200000]            	mov	al, [faz]
  2890 00001574 FEC8                    	dec	al
  2891 00001576 74CA                    	jz	short lff22m_9
  2892 00001578 FE0D[B8200000]          	dec	byte [faz]
  2893 0000157E BD04000000              	mov	ebp, 4
  2894 00001583 FEC8                    	dec	al
  2895 00001585 75C7                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2896 00001587 45                      	inc	ebp ; 5
  2897 00001588 EBC4                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2898                                  
  2899                                  lff22m_3:
  2900                                  lff22s_3:
  2901 0000158A E999F5FFFF              	jmp	lff22_3	; padfill
  2902                                  		; (put zeros in the remain words of the buffer)
  2903                                  lff22m_7:
  2904                                  lff22s_7:
  2905 0000158F E9B5F5FFFF              	jmp	lff22_5  ; error
  2906                                  
  2907                                  load_22khz_stereo_8_bit:
  2908                                  	; 16/11/2023
  2909 00001594 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2910                                  					; last of the file?
  2911 0000159B 7402                    	jz	short lff22s_0		; no
  2912 0000159D F9                      	stc
  2913 0000159E C3                      	retn
  2914                                  
  2915                                  lff22s_0:
  2916 0000159F BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2917                                          ;mov	edx, [loadsize]
  2918                                  
  2919                                  	; esi = buffer address
  2920                                  	;; edx = buffer size
  2921                                  
  2922                                  	; load file into memory
  2923                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000015A4 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000015AA 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000015AC 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000015B2 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000015B7 CD40                <1>  int 40h
  2924 000015B9 72D4                    	jc	short lff22s_7 ; error !
  2925                                  
  2926 000015BB BF[00800000]            	mov	edi, audio_buffer
  2927                                  	
  2928 000015C0 D1E8                    	shr	eax, 1
  2929 000015C2 7505                    	jnz	short lff22s_8
  2930 000015C4 E977F5FFFF              	jmp	lff22_eof
  2931                                  
  2932                                  lff22s_8:
  2933 000015C9 89C1                    	mov	ecx, eax	; word count
  2934                                  lff22s_9:
  2935 000015CB BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2936 000015D0 C605[B8200000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2937                                  lff22s_1:
  2938                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2939 000015D7 66AD                    	lodsw
  2940 000015D9 66BA8080                	mov	dx, 8080h
  2941 000015DD 49                      	dec	ecx
  2942 000015DE 7403                    	jz	short lff22s_2_1 
  2943 000015E0 668B16                  	mov	dx, [esi]
  2944                                  lff22s_2_1:	
  2945                                  	; al = [previous_val_l]
  2946                                  	; ah = [previous_val_r]
  2947                                  	; dl = [next_val_l]
  2948                                  	; dh = [next_val_r]	
  2949 000015E3 E8B3050000              	call	interpolating_3_8bit_stereo ; 1 of 17 
  2950 000015E8 E3A0                    	jecxz	lff22s_3
  2951                                  lff22s_2_2:
  2952 000015EA 66AD                    	lodsw
  2953 000015EC 66BA8080                	mov	dx, 8080h
  2954 000015F0 49                      	dec	ecx
  2955 000015F1 7403                    	jz	short lff22s_2_3
  2956 000015F3 668B16                  	mov	dx, [esi]
  2957                                  lff22s_2_3:
  2958 000015F6 E810060000               	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2959 000015FB E38D                    	jecxz	lff22s_3
  2960 000015FD 4D                      	dec	ebp
  2961 000015FE 75EA                    	jnz	short lff22s_2_2
  2962                                  
  2963 00001600 A0[B8200000]            	mov	al, [faz]
  2964 00001605 FEC8                    	dec	al
  2965 00001607 74C2                    	jz	short lff22s_9
  2966 00001609 FE0D[B8200000]          	dec	byte [faz]
  2967 0000160F BD04000000              	mov	ebp, 4
  2968 00001614 FEC8                    	dec	al
  2969 00001616 75BF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2970 00001618 45                      	inc	ebp ; 5
  2971 00001619 EBBC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2972                                  
  2973                                  load_22khz_mono_16_bit:
  2974                                  	; 16/11/2023
  2975 0000161B F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2976                                  					; last of the file?
  2977 00001622 7402                    	jz	short lff22m2_0		; no
  2978 00001624 F9                      	stc
  2979 00001625 C3                      	retn
  2980                                  
  2981                                  lff22m2_0:
  2982 00001626 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2983                                          ;mov	edx, [loadsize]
  2984                                  
  2985                                  	; esi = buffer address
  2986                                  	;; edx = buffer size
  2987                                  
  2988                                  	; load file into memory
  2989                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000162B 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001631 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001633 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001639 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000163E CD40                <1>  int 40h
  2990 00001640 7261                    	jc	short lff22m2_7 ; error !
  2991                                  
  2992 00001642 BF[00800000]            	mov	edi, audio_buffer
  2993                                  	
  2994 00001647 D1E8                    	shr	eax, 1
  2995 00001649 7505                    	jnz	short lff22m2_8
  2996 0000164B E9F0F4FFFF              	jmp	lff22_eof
  2997                                  
  2998                                  lff22m2_8:
  2999 00001650 89C1                    	mov	ecx, eax	; word count
  3000                                  lff22m2_9:
  3001 00001652 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  3002 00001657 C605[B8200000]03        	mov	byte [faz], 3  ; 3 steps/phases
  3003                                  lff22m2_1:
  3004                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  3005 0000165E 66AD                    	lodsw
  3006 00001660 31D2                    	xor	edx, edx
  3007 00001662 49                      	dec	ecx
  3008 00001663 7403                    	jz	short lff22m2_2_1
  3009 00001665 668B16                  	mov	dx, [esi]
  3010                                  lff22m2_2_1:	
  3011                                  	; ax = [previous_val]
  3012                                  	; dx = [next_val]
  3013 00001668 E8CF050000              	call	interpolating_3_16bit_mono ; 1 of 17
  3014 0000166D E32F                    	jecxz	lff22m2_3
  3015                                  lff22m2_2_2:
  3016 0000166F 66AD                    	lodsw
  3017 00001671 31D2                    	xor	edx, edx
  3018 00001673 49                      	dec	ecx
  3019 00001674 7403                    	jz	short lff22m2_2_3
  3020 00001676 668B16                  	mov	dx, [esi]
  3021                                  lff22m2_2_3:
  3022 00001679 E851060000               	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  3023 0000167E E31E                    	jecxz	lff22m2_3
  3024 00001680 4D                      	dec	ebp
  3025 00001681 75EC                    	jnz	short lff22m2_2_2
  3026                                  
  3027 00001683 A0[B8200000]            	mov	al, [faz]
  3028 00001688 FEC8                    	dec	al
  3029 0000168A 74C6                    	jz	short lff22m2_9
  3030 0000168C FE0D[B8200000]          	dec	byte [faz]
  3031 00001692 BD04000000              	mov	ebp, 4
  3032 00001697 FEC8                    	dec	al
  3033 00001699 75C3                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  3034 0000169B 45                      	inc	ebp ; 5
  3035 0000169C EBC0                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  3036                                  
  3037                                  lff22m2_3:
  3038                                  lff22s2_3:
  3039 0000169E E985F4FFFF              	jmp	lff22_3	; padfill
  3040                                  		; (put zeros in the remain words of the buffer)
  3041                                  lff22m2_7:
  3042                                  lff22s2_7:
  3043 000016A3 E9A1F4FFFF              	jmp	lff22_5  ; error
  3044                                  
  3045                                  load_22khz_stereo_16_bit:
  3046                                  	; 16/11/2023
  3047 000016A8 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3048                                  					; last of the file?
  3049 000016AF 7402                    	jz	short lff22s2_0		; no
  3050 000016B1 F9                      	stc
  3051 000016B2 C3                      	retn
  3052                                  
  3053                                  lff22s2_0:
  3054 000016B3 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3055                                          ;mov	edx, [loadsize]
  3056                                  
  3057                                  	; esi = buffer address
  3058                                  	;; edx = buffer size
  3059                                  
  3060                                  	; load file into memory
  3061                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000016B8 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000016BE 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000016C0 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000016C6 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000016CB CD40                <1>  int 40h
  3062 000016CD 72D4                    	jc	short lff22s2_7 ; error !
  3063                                  
  3064 000016CF BF[00800000]            	mov	edi, audio_buffer
  3065                                  	
  3066 000016D4 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3067 000016D7 7505                    	jnz	short lff22s2_8
  3068 000016D9 E962F4FFFF              	jmp	lff22_eof
  3069                                  
  3070                                  lff22s2_8:
  3071 000016DE 89C1                    	mov	ecx, eax	; dword count
  3072                                  lff22s2_9:
  3073 000016E0 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  3074 000016E5 C605[B8200000]03        	mov	byte [faz], 3  ; 3 steps/phase
  3075                                  lff22s2_1:
  3076                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  3077 000016EC 66AD                    	lodsw
  3078 000016EE 89C3                    	mov	ebx, eax
  3079 000016F0 66AD                    	lodsw
  3080 000016F2 8B16                    	mov	edx, [esi]
  3081 000016F4 668915[B4200000]        	mov	[next_val_l], dx
  3082                                  	; 26/11/2023
  3083 000016FB C1EA10                  	shr	edx, 16
  3084 000016FE 49                      	dec	ecx
  3085 000016FF 7509                    	jnz	short lff22s2_2_1
  3086 00001701 31D2                    	xor	edx, edx ; 0
  3087 00001703 668915[B4200000]        	mov	[next_val_l], dx
  3088                                  lff22s2_2_1:
  3089                                  	; bx = [previous_val_l]
  3090                                  	; ax = [previous_val_r]
  3091                                  	; [next_val_l]
  3092                                  	; dx = [next_val_r]
  3093 0000170A E85D050000              	call	interpolating_3_16bit_stereo ; 1 of 17 
  3094 0000170F E38D                    	jecxz	lff22s2_3
  3095                                  lff22s2_2_2:
  3096 00001711 66AD                    	lodsw
  3097 00001713 89C3                    	mov	ebx, eax
  3098 00001715 66AD                    	lodsw
  3099 00001717 8B16                    	mov	edx, [esi]
  3100 00001719 668915[B4200000]        	mov	[next_val_l], dx
  3101                                  	; 26/11/2023
  3102 00001720 C1EA10                  	shr	edx, 16
  3103 00001723 49                      	dec	ecx
  3104 00001724 7509                    	jnz	short lff22s2_2_3
  3105 00001726 31D2                    	xor	edx, edx ; 0
  3106 00001728 668915[B4200000]        	mov	[next_val_l], dx
  3107                                  lff22s2_2_3:
  3108 0000172F E8B3050000               	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  3109 00001734 E31E                    	jecxz	lff22s2_2_4
  3110                                  
  3111 00001736 4D                      	dec	ebp
  3112 00001737 75D8                    	jnz	short lff22s2_2_2
  3113                                  
  3114 00001739 A0[B8200000]            	mov	al, [faz]
  3115 0000173E FEC8                    	dec	al
  3116 00001740 749E                    	jz	short lff22s2_9
  3117 00001742 FE0D[B8200000]          	dec	byte [faz]
  3118 00001748 BD04000000              	mov	ebp, 4
  3119 0000174D FEC8                    	dec	al
  3120 0000174F 759B                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  3121 00001751 45                      	inc	ebp ; 5
  3122 00001752 EB98                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  3123                                  
  3124                                  lff22s2_2_4:
  3125                                  	; 26/11/2023
  3126 00001754 E9CFF3FFFF              	jmp	lff22_3	; padfill
  3127                                  
  3128                                  ; .....................
  3129                                  
  3130                                  load_11khz_mono_8_bit:
  3131                                  	; 18/11/2023
  3132 00001759 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3133                                  					; last of the file?
  3134 00001760 7402                    	jz	short lff11m_0		; no
  3135 00001762 F9                      	stc
  3136 00001763 C3                      	retn
  3137                                  
  3138                                  lff11m_0:
  3139 00001764 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3140                                          ;mov	edx, [loadsize]
  3141                                  
  3142                                  	; esi = buffer address
  3143                                  	;; edx = buffer size
  3144                                  
  3145                                  	; load file into memory
  3146                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001769 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000176F 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001771 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001777 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000177C CD40                <1>  int 40h
  3147 0000177E 7247                    	jc	short lff11m_7 ; error !
  3148                                  
  3149 00001780 BF[00800000]            	mov	edi, audio_buffer
  3150                                  	
  3151 00001785 21C0                    	and	eax, eax
  3152 00001787 7505                    	jnz	short lff11m_8
  3153 00001789 E9B2F3FFFF              	jmp	lff11_eof
  3154                                  
  3155                                  lff11m_8:
  3156 0000178E 89C1                    	mov	ecx, eax		; byte count
  3157                                  lff11m_9:
  3158 00001790 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3159                                  lff11m_1:
  3160                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3161 00001795 AC                      	lodsb
  3162 00001796 B280                    	mov	dl, 80h
  3163 00001798 49                      	dec	ecx
  3164 00001799 7402                    	jz	short lff11m_2_1
  3165 0000179B 8A16                    	mov	dl, [esi]
  3166                                  lff11m_2_1:	
  3167                                  	; al = [previous_val]
  3168                                  	; dl = [next_val]
  3169 0000179D E876050000              	call	interpolating_5_8bit_mono
  3170 000017A2 E328                    	jecxz	lff11m_3
  3171                                  lff11m_2_2:
  3172 000017A4 AC                      	lodsb
  3173 000017A5 B280                    	mov	dl, 80h
  3174 000017A7 49                      	dec	ecx
  3175 000017A8 7402                    	jz	short lff11m_2_3
  3176 000017AA 8A16                    	mov	dl, [esi]
  3177                                  lff11m_2_3:
  3178 000017AC E873060000               	call	interpolating_4_8bit_mono
  3179 000017B1 E319                    	jecxz	lff11m_3
  3180                                  
  3181 000017B3 4D                      	dec	ebp
  3182 000017B4 74DA                    	jz	short lff11m_9
  3183                                  
  3184 000017B6 AC                      	lodsb
  3185 000017B7 B280                    	mov	dl, 80h
  3186 000017B9 49                      	dec	ecx
  3187 000017BA 7402                    	jz	short lff11m_2_4
  3188 000017BC 8A16                    	mov	dl, [esi]
  3189                                  lff11m_2_4:
  3190 000017BE E861060000              	call	interpolating_4_8bit_mono
  3191 000017C3 E307                    	jecxz	lff11m_3
  3192 000017C5 EBCE                    	jmp	short lff11m_1
  3193                                  
  3194                                  lff11m_7:
  3195                                  lff11s_7:
  3196 000017C7 E97DF3FFFF              	jmp	lff11_5  ; error
  3197                                  
  3198                                  lff11m_3:
  3199                                  lff11s_3:
  3200 000017CC E957F3FFFF              	jmp	lff11_3	; padfill
  3201                                  		; (put zeros in the remain words of the buffer)
  3202                                  
  3203                                  load_11khz_stereo_8_bit:
  3204                                  	; 18/11/2023
  3205 000017D1 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3206                                  					; last of the file?
  3207 000017D8 7402                    	jz	short lff11s_0		; no
  3208 000017DA F9                      	stc
  3209 000017DB C3                      	retn
  3210                                  
  3211                                  lff11s_0:
  3212 000017DC BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3213                                          ;mov	edx, [loadsize]
  3214                                  
  3215                                  	; esi = buffer address
  3216                                  	;; edx = buffer size
  3217                                  
  3218                                  	; load file into memory
  3219                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000017E1 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000017E7 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000017E9 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000017EF B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000017F4 CD40                <1>  int 40h
  3220 000017F6 72CF                    	jc	short lff11s_7 ; error !
  3221                                  
  3222 000017F8 BF[00800000]            	mov	edi, audio_buffer
  3223                                  	
  3224 000017FD D1E8                    	shr	eax, 1
  3225 000017FF 7505                    	jnz	short lff11s_8
  3226 00001801 E93AF3FFFF              	jmp	lff11_eof
  3227                                  
  3228                                  lff11s_8:
  3229 00001806 89C1                    	mov	ecx, eax	; word count
  3230                                  lff11s_9:
  3231 00001808 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3232                                  lff11s_1:
  3233                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3234 0000180D 66AD                    	lodsw
  3235 0000180F 66BA8080                	mov	dx, 8080h
  3236 00001813 49                      	dec	ecx
  3237 00001814 7403                    	jz	short lff11s_2_1 
  3238 00001816 668B16                  	mov	dx, [esi]
  3239                                  lff11s_2_1:	
  3240                                  	; al = [previous_val_l]
  3241                                  	; ah = [previous_val_r]
  3242                                  	; dl = [next_val_l]
  3243                                  	; dh = [next_val_r]	
  3244 00001819 E859050000              	call	interpolating_5_8bit_stereo
  3245 0000181E E3AC                    	jecxz	lff11s_3
  3246                                  lff11s_2_2:
  3247 00001820 66AD                    	lodsw
  3248 00001822 66BA8080                	mov	dx, 8080h
  3249 00001826 49                      	dec	ecx
  3250 00001827 7403                    	jz	short lff11s_2_3
  3251 00001829 668B16                  	mov	dx, [esi]
  3252                                  lff11s_2_3:
  3253 0000182C E832060000               	call	interpolating_4_8bit_stereo
  3254 00001831 E399                    	jecxz	lff11s_3
  3255                                  	
  3256 00001833 4D                      	dec	ebp
  3257 00001834 74D2                    	jz	short lff11s_9
  3258                                  
  3259 00001836 66AD                    	lodsw
  3260 00001838 66BA8080                	mov	dx, 8080h
  3261 0000183C 49                      	dec	ecx
  3262 0000183D 7403                    	jz	short lff11s_2_4
  3263 0000183F 668B16                  	mov	dx, [esi]
  3264                                  lff11s_2_4:
  3265 00001842 E81C060000              	call	interpolating_4_8bit_stereo
  3266 00001847 E383                    	jecxz	lff11s_3
  3267 00001849 EBC2                    	jmp	short lff11s_1
  3268                                  
  3269                                  load_11khz_mono_16_bit:
  3270                                  	; 18/11/2023
  3271 0000184B F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3272                                  					; last of the file?
  3273 00001852 7402                    	jz	short lff11m2_0		; no
  3274 00001854 F9                      	stc
  3275 00001855 C3                      	retn
  3276                                  
  3277                                  lff11m2_0:
  3278 00001856 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3279                                          ;mov	edx, [loadsize]
  3280                                  
  3281                                  	; esi = buffer address
  3282                                  	;; edx = buffer size
  3283                                  
  3284                                  	; load file into memory
  3285                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000185B 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001861 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001863 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001869 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000186E CD40                <1>  int 40h
  3286 00001870 724D                    	jc	short lff11m2_7 ; error !
  3287                                  
  3288 00001872 BF[00800000]            	mov	edi, audio_buffer
  3289                                  	
  3290 00001877 D1E8                    	shr	eax, 1
  3291 00001879 7505                    	jnz	short lff11m2_8
  3292 0000187B E9C0F2FFFF              	jmp	lff11_eof
  3293                                  
  3294                                  lff11m2_8:
  3295 00001880 89C1                    	mov	ecx, eax	; word count
  3296                                  lff11m2_9:
  3297 00001882 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3298                                  lff11m2_1:
  3299                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3300 00001887 66AD                    	lodsw
  3301 00001889 31D2                    	xor	edx, edx
  3302 0000188B 49                      	dec	ecx
  3303 0000188C 7403                    	jz	short lff11m2_2_1
  3304 0000188E 668B16                  	mov	dx, [esi]
  3305                                  lff11m2_2_1:	
  3306                                  	; ax = [previous_val]
  3307                                  	; dx = [next_val]
  3308 00001891 E83A060000              	call	interpolating_5_16bit_mono
  3309 00001896 E362                    	jecxz	lff11m2_3
  3310                                  lff11m2_2_2:
  3311 00001898 66AD                    	lodsw
  3312 0000189A 31D2                    	xor	edx, edx
  3313 0000189C 49                      	dec	ecx
  3314 0000189D 7403                    	jz	short lff11m2_2_3
  3315 0000189F 668B16                  	mov	dx, [esi]
  3316                                  lff11m2_2_3:
  3317 000018A2 E853070000               	call	interpolating_4_16bit_mono
  3318 000018A7 E351                    	jecxz	lff11m2_3
  3319                                  
  3320 000018A9 4D                      	dec	ebp
  3321 000018AA 74D6                    	jz	short lff11m2_9
  3322                                  
  3323 000018AC 66AD                    	lodsw
  3324 000018AE 31D2                    	xor	edx, edx
  3325 000018B0 49                      	dec	ecx
  3326 000018B1 7403                    	jz	short lff11m2_2_4
  3327 000018B3 668B16                  	mov	dx, [esi]
  3328                                  lff11m2_2_4:
  3329 000018B6 E83F070000               	call	interpolating_4_16bit_mono
  3330 000018BB E33D                    	jecxz	lff11m2_3
  3331 000018BD EBC8                    	jmp	short lff11m2_1
  3332                                  
  3333                                  lff11m2_7:
  3334                                  lff11s2_7:
  3335 000018BF E985F2FFFF              	jmp	lff11_5  ; error
  3336                                  
  3337                                  load_11khz_stereo_16_bit:
  3338                                  	; 18/11/2023
  3339 000018C4 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3340                                  					; last of the file?
  3341 000018CB 7402                    	jz	short lff11s2_0		; no
  3342 000018CD F9                      	stc
  3343 000018CE C3                      	retn
  3344                                  
  3345                                  lff11s2_0:
  3346 000018CF BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3347                                          ;mov	edx, [loadsize]
  3348                                  
  3349                                  	; esi = buffer address
  3350                                  	;; edx = buffer size
  3351                                  
  3352                                  	; load file into memory
  3353                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000018D4 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000018DA 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000018DC 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000018E2 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000018E7 CD40                <1>  int 40h
  3354 000018E9 72D4                    	jc	short lff11s2_7 ; error !
  3355                                  
  3356 000018EB BF[00800000]            	mov	edi, audio_buffer
  3357                                  	
  3358 000018F0 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3359 000018F3 750A                    	jnz	short lff11s2_8
  3360 000018F5 E946F2FFFF              	jmp	lff11_eof
  3361                                  
  3362                                  lff11m2_3:
  3363                                  lff11s2_3:
  3364 000018FA E929F2FFFF              	jmp	lff11_3	; padfill
  3365                                  		; (put zeros in the remain words of the buffer)
  3366                                  
  3367                                  lff11s2_8:
  3368 000018FF 89C1                    	mov	ecx, eax	; dword count
  3369                                  lff11s2_9:
  3370 00001901 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3371                                  lff11s2_1:
  3372                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3373 00001906 66AD                    	lodsw
  3374 00001908 89C3                    	mov	ebx, eax
  3375 0000190A 66AD                    	lodsw
  3376 0000190C 8B16                    	mov	edx, [esi]
  3377 0000190E 8915[B4200000]          	mov	[next_val_l], edx
  3378                                  	; 26/11/2023
  3379 00001914 C1EA10                  	shr	edx, 16
  3380                                  	;mov	[next_val_r], dx
  3381 00001917 49                      	dec	ecx
  3382 00001918 7509                    	jnz	short lff11s2_2_1
  3383 0000191A 31D2                    	xor	edx, edx ; 0
  3384 0000191C 668915[B4200000]        	mov	[next_val_l], dx
  3385                                  	;mov	[next_val_r], dx
  3386                                  lff11s2_2_1:
  3387                                  	; bx = [previous_val_l]
  3388                                  	; ax = [previous_val_r]
  3389                                  	; [next_val_l]
  3390                                  	; dx = [next_val_r]
  3391 00001923 E803060000              	call	interpolating_5_16bit_stereo
  3392 00001928 E3D0                    	jecxz	lff11s2_3
  3393                                  lff11s2_2_2:
  3394 0000192A 66AD                    	lodsw
  3395 0000192C 89C3                    	mov	ebx, eax
  3396 0000192E 66AD                    	lodsw
  3397 00001930 8B16                    	mov	edx, [esi]
  3398 00001932 668915[B4200000]        	mov	[next_val_l], dx
  3399                                  	; 26/11/2023
  3400 00001939 C1EA10                  	shr	edx, 16
  3401                                  	;mov	[next_val_r], dx
  3402 0000193C 49                      	dec	ecx
  3403 0000193D 7509                    	jnz	short lff11s2_2_3
  3404 0000193F 31D2                    	xor	edx, edx ; 0
  3405 00001941 668915[B4200000]        	mov	[next_val_l], dx
  3406                                  	;mov	[next_val_r], dx
  3407                                  lff11s2_2_3:
  3408 00001948 E8E6060000               	call	interpolating_4_16bit_stereo
  3409 0000194D E3AB                    	jecxz	lff11s2_3
  3410                                  	
  3411 0000194F 4D                      	dec	ebp
  3412 00001950 74AF                    	jz	short lff11s2_9
  3413                                  
  3414 00001952 66AD                    	lodsw
  3415 00001954 89C3                    	mov	ebx, eax
  3416 00001956 66AD                    	lodsw
  3417 00001958 8B16                    	mov	edx, [esi]
  3418 0000195A 668915[B4200000]        	mov	[next_val_l], dx
  3419                                  	; 26/11/2023
  3420 00001961 C1EA10                  	shr	edx, 16
  3421                                  	;mov	[next_val_r], dx
  3422 00001964 49                      	dec	ecx
  3423 00001965 7509                    	jnz	short lff11s2_2_4
  3424 00001967 31D2                    	xor	edx, edx ; 0
  3425 00001969 668915[B4200000]        	mov	[next_val_l], dx
  3426                                  	;mov	[next_val_r], dx
  3427                                  lff11s2_2_4:
  3428 00001970 E8BE060000               	call	interpolating_4_16bit_stereo
  3429 00001975 E383                    	jecxz	lff11s2_3
  3430 00001977 EB8D                    	jmp	short lff11s2_1
  3431                                  
  3432                                  ; .....................
  3433                                  
  3434                                  load_44khz_mono_8_bit:
  3435                                  	; 18/11/2023
  3436 00001979 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3437                                  					; last of the file?
  3438 00001980 7402                    	jz	short lff44m_0		; no
  3439 00001982 F9                      	stc
  3440 00001983 C3                      	retn
  3441                                  
  3442                                  lff44m_0:
  3443 00001984 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3444                                          ;mov	edx, [loadsize]
  3445                                  
  3446                                  	; esi = buffer address
  3447                                  	;; edx = buffer size
  3448                                  
  3449                                  	; load file into memory
  3450                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001989 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000198F 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001991 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001997 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000199C CD40                <1>  int 40h
  3451 0000199E 7250                    	jc	short lff44m_7 ; error !
  3452                                  
  3453 000019A0 BF[00800000]            	mov	edi, audio_buffer
  3454                                  	
  3455 000019A5 21C0                    	and	eax, eax
  3456 000019A7 7505                    	jnz	short lff44m_8
  3457 000019A9 E992F1FFFF              	jmp	lff44_eof
  3458                                  
  3459                                  lff44m_8:
  3460 000019AE 89C1                    	mov	ecx, eax	; byte count
  3461                                  lff44m_9:
  3462 000019B0 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3463 000019B5 C605[B8200000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3464                                  lff44m_1:
  3465                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3466                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3467 000019BC AC                      	lodsb
  3468 000019BD B280                    	mov	dl, 80h
  3469 000019BF 49                      	dec	ecx
  3470 000019C0 7402                    	jz	short lff44m_2_1
  3471 000019C2 8A16                    	mov	dl, [esi]
  3472                                  lff44m_2_1:	
  3473                                  	; al = [previous_val]
  3474                                  	; dl = [next_val]
  3475 000019C4 E825020000              	call	interpolating_2_8bit_mono
  3476 000019C9 E320                    	jecxz	lff44m_3
  3477                                  lff44m_2_2:
  3478 000019CB AC                      	lodsb
  3479 000019CC 2C80                    	sub	al, 80h
  3480 000019CE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3481 000019D2 66AB                    	stosw		; (L)
  3482 000019D4 66AB                    	stosw		; (R)	
  3483                                  
  3484 000019D6 49                      	dec	ecx
  3485 000019D7 7412                    	jz	short lff44m_3	
  3486 000019D9 4D                      	dec	ebp
  3487 000019DA 75EF                    	jnz	short lff44m_2_2
  3488                                  	
  3489 000019DC FE0D[B8200000]          	dec	byte [faz]
  3490 000019E2 74CC                    	jz	short lff44m_9 
  3491 000019E4 BD0B000000              	mov	ebp, 11
  3492 000019E9 EBD1                    	jmp	short lff44m_1
  3493                                  
  3494                                  lff44m_3:
  3495                                  lff44s_3:
  3496 000019EB E938F1FFFF              	jmp	lff44_3	; padfill
  3497                                  		; (put zeros in the remain words of the buffer)
  3498                                  lff44m_7:
  3499                                  lff44s_7:
  3500 000019F0 E954F1FFFF              	jmp	lff44_5  ; error
  3501                                  
  3502                                  load_44khz_stereo_8_bit:
  3503                                  	; 16/11/2023
  3504 000019F5 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3505                                  					; last of the file?
  3506 000019FC 7402                    	jz	short lff44s_0		; no
  3507 000019FE F9                      	stc
  3508 000019FF C3                      	retn
  3509                                  
  3510                                  lff44s_0:
  3511 00001A00 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3512                                          ;mov	edx, [loadsize]
  3513                                  
  3514                                  	; esi = buffer address
  3515                                  	;; edx = buffer size
  3516                                  
  3517                                  	; load file into memory
  3518                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001A05 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001A0B 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001A0D 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001A13 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001A18 CD40                <1>  int 40h
  3519 00001A1A 72D4                    	jc	short lff44s_7 ; error !
  3520                                  
  3521 00001A1C BF[00800000]            	mov	edi, audio_buffer
  3522                                  	
  3523 00001A21 D1E8                    	shr	eax, 1
  3524 00001A23 7505                    	jnz	short lff44s_8
  3525 00001A25 E916F1FFFF              	jmp	lff44_eof
  3526                                  
  3527                                  lff44s_8:
  3528 00001A2A 89C1                    	mov	ecx, eax	; word count
  3529                                  lff44s_9:
  3530 00001A2C BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3531 00001A31 C605[B8200000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3532                                  lff44s_1:
  3533                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3534                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3535 00001A38 66AD                    	lodsw
  3536 00001A3A 66BA8080                	mov	dx, 8080h
  3537 00001A3E 49                      	dec	ecx
  3538 00001A3F 7403                    	jz	short lff44s_2_1 
  3539 00001A41 668B16                  	mov	dx, [esi]
  3540                                  lff44s_2_1:	
  3541                                  	; al = [previous_val_l]
  3542                                  	; ah = [previous_val_r]
  3543                                  	; dl = [next_val_l]
  3544                                  	; dh = [next_val_r]	
  3545 00001A44 E8C2010000              	call	interpolating_2_8bit_stereo
  3546 00001A49 E3A0                    	jecxz	lff44s_3
  3547                                  lff44s_2_2:
  3548 00001A4B AC                      	lodsb
  3549 00001A4C 2C80                    	sub	al, 80h
  3550 00001A4E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3551 00001A52 66AB                    	stosw		; (L)
  3552 00001A54 AC                      	lodsb
  3553 00001A55 2C80                    	sub	al, 80h
  3554 00001A57 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3555 00001A5B 66AB                    	stosw		; (R)
  3556                                  
  3557 00001A5D 49                      	dec	ecx
  3558 00001A5E 748B                    	jz	short lff44s_3	
  3559 00001A60 4D                      	dec	ebp
  3560 00001A61 75E8                    	jnz	short lff44s_2_2
  3561                                  	
  3562 00001A63 FE0D[B8200000]          	dec	byte [faz]
  3563 00001A69 74C1                    	jz	short lff44s_9 
  3564 00001A6B BD0B000000              	mov	ebp, 11
  3565 00001A70 EBC6                    	jmp	short lff44s_1
  3566                                  
  3567                                  load_44khz_mono_16_bit:
  3568                                  	; 18/11/2023
  3569 00001A72 F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3570                                  					; last of the file?
  3571 00001A79 7402                    	jz	short lff44m2_0		; no
  3572 00001A7B F9                      	stc
  3573 00001A7C C3                      	retn
  3574                                  
  3575                                  lff44m2_0:
  3576 00001A7D BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3577                                          ;mov	edx, [loadsize]
  3578                                  
  3579                                  	; esi = buffer address
  3580                                  	;; edx = buffer size
  3581                                  
  3582                                  	; load file into memory
  3583                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001A82 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001A88 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001A8A 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001A90 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001A95 CD40                <1>  int 40h
  3584 00001A97 724D                    	jc	short lff44m2_7 ; error !
  3585                                  
  3586 00001A99 BF[00800000]            	mov	edi, audio_buffer
  3587                                  	
  3588 00001A9E D1E8                    	shr	eax, 1
  3589 00001AA0 7505                    	jnz	short lff44m2_8
  3590 00001AA2 E999F0FFFF              	jmp	lff44_eof
  3591                                  
  3592                                  lff44m2_8:
  3593 00001AA7 89C1                    	mov	ecx, eax	; word count
  3594                                  lff44m2_9:
  3595 00001AA9 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3596 00001AAE C605[B8200000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3597                                  lff44m2_1:
  3598                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3599                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3600 00001AB5 66AD                    	lodsw
  3601 00001AB7 31D2                    	xor	edx, edx
  3602 00001AB9 49                      	dec	ecx
  3603 00001ABA 7403                    	jz	short lff44m2_2_1
  3604 00001ABC 668B16                  	mov	dx, [esi]
  3605                                  lff44m2_2_1:	
  3606                                  	; ax = [previous_val]
  3607                                  	; dx = [next_val]
  3608 00001ABF E80B020000              	call	interpolating_2_16bit_mono
  3609 00001AC4 E31B                    	jecxz	lff44m2_3
  3610                                  lff44m2_2_2:
  3611 00001AC6 66AD                    	lodsw
  3612 00001AC8 66AB                    	stosw		; (L)eft Channel
  3613 00001ACA 66AB                    	stosw		; (R)ight Channel
  3614                                  
  3615 00001ACC 49                      	dec	ecx
  3616 00001ACD 7412                    	jz	short lff44m2_3	
  3617 00001ACF 4D                      	dec	ebp
  3618 00001AD0 75F4                    	jnz	short lff44m2_2_2
  3619                                  	
  3620 00001AD2 FE0D[B8200000]          	dec	byte [faz]
  3621 00001AD8 74CF                    	jz	short lff44m2_9 
  3622 00001ADA BD0B000000              	mov	ebp, 11
  3623 00001ADF EBD4                    	jmp	short lff44m2_1
  3624                                  
  3625                                  lff44m2_3:
  3626                                  lff44s2_3:
  3627 00001AE1 E942F0FFFF              	jmp	lff44_3	; padfill
  3628                                  		; (put zeros in the remain words of the buffer)
  3629                                  lff44m2_7:
  3630                                  lff44s2_7:
  3631 00001AE6 E95EF0FFFF              	jmp	lff44_5  ; error
  3632                                  
  3633                                  load_44khz_stereo_16_bit:
  3634                                  	; 18/11/2023
  3635 00001AEB F605[94680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3636                                  					; last of the file?
  3637 00001AF2 7402                    	jz	short lff44s2_0		; no
  3638 00001AF4 F9                      	stc
  3639 00001AF5 C3                      	retn
  3640                                  
  3641                                  lff44s2_0:
  3642 00001AF6 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3643                                          ;mov	edx, [loadsize]
  3644                                  
  3645                                  	; esi = buffer address
  3646                                  	;; edx = buffer size
  3647                                  
  3648                                  	; load file into memory
  3649                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001AFB 8B1D[75650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001B01 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001B03 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001B09 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001B0E CD40                <1>  int 40h
  3650 00001B10 72D4                    	jc	short lff44s2_7 ; error !
  3651                                  
  3652 00001B12 BF[00800000]            	mov	edi, audio_buffer
  3653                                  	
  3654 00001B17 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3655 00001B1A 7505                    	jnz	short lff44s2_8
  3656 00001B1C E91FF0FFFF              	jmp	lff44_eof
  3657                                  
  3658                                  lff44s2_8:
  3659 00001B21 89C1                    	mov	ecx, eax	; dword count
  3660                                  lff44s2_9:
  3661 00001B23 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3662 00001B28 C605[B8200000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3663                                  lff44s2_1:
  3664                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3665                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3666 00001B2F 66AD                    	lodsw
  3667 00001B31 89C3                    	mov	ebx, eax
  3668 00001B33 66AD                    	lodsw
  3669                                  	;mov	dx, [esi]
  3670                                  	;mov	[next_val_l], dx
  3671                                  	;mov	dx, [esi+2]
  3672                                  	; 26/11/2023
  3673 00001B35 8B16                    	mov	edx, [esi]
  3674 00001B37 668915[B4200000]        	mov	[next_val_l], dx
  3675 00001B3E C1EA10                  	shr	edx, 16
  3676 00001B41 49                      	dec	ecx
  3677 00001B42 7509                    	jnz	short lff44s2_2_1
  3678 00001B44 31D2                    	xor	edx, edx ; 0
  3679 00001B46 668915[B4200000]        	mov	[next_val_l], dx
  3680                                  lff44s2_2_1:
  3681                                  	; bx = [previous_val_l]
  3682                                  	; ax = [previous_val_r]
  3683                                  	; [next_val_l]
  3684                                  	; dx = [next_val_r]
  3685 00001B4D E895010000              	call	interpolating_2_16bit_stereo
  3686 00001B52 E38D                    	jecxz	lff44s2_3
  3687                                  lff44s2_2_2:
  3688                                  	;movsw		; (L)eft Channel
  3689                                  	;movsw		; (R)ight Channel
  3690 00001B54 A5                      	movsd
  3691                                  
  3692 00001B55 49                      	dec	ecx
  3693 00001B56 7489                    	jz	short lff44s2_3	
  3694 00001B58 4D                      	dec	ebp
  3695 00001B59 75F9                    	jnz	short lff44s2_2_2
  3696                                  	
  3697 00001B5B FE0D[B8200000]          	dec	byte [faz]
  3698 00001B61 74C0                    	jz	short lff44s2_9 
  3699 00001B63 BD0B000000              	mov	ebp, 11
  3700 00001B68 EBC5                    	jmp	short lff44s2_1
  3701                                  
  3702                                  ; .....................
  3703                                  
  3704                                  interpolating_3_8bit_mono:
  3705                                  	; 16/11/2023
  3706                                  	; al = [previous_val]
  3707                                  	; dl = [next_val]
  3708                                  	; original-interpolated-interpolated
  3709 00001B6A 88C3                    	mov	bl, al
  3710 00001B6C 2C80                    	sub	al, 80h
  3711 00001B6E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3712 00001B72 66AB                    	stosw		; original sample (L)
  3713 00001B74 66AB                    	stosw		; original sample (R)
  3714 00001B76 88D8                    	mov	al, bl
  3715 00001B78 00D0                    	add	al, dl	
  3716 00001B7A D0D8                    	rcr	al, 1
  3717 00001B7C 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3718 00001B7E 00D8                    	add	al, bl
  3719 00001B80 D0D8                    	rcr	al, 1
  3720 00001B82 2C80                    	sub	al, 80h
  3721 00001B84 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3722 00001B88 66AB                    	stosw		; interpolated sample 1 (L)
  3723 00001B8A 66AB                    	stosw		; interpolated sample 1 (R)
  3724 00001B8C 88F8                    	mov	al, bh
  3725 00001B8E 00D0                    	add	al, dl	; [next_val]
  3726 00001B90 D0D8                    	rcr	al, 1
  3727 00001B92 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3728 00001B96 66AB                    	stosw		; interpolated sample 2 (L)
  3729 00001B98 66AB                    	stosw		; interpolated sample 2 (R)
  3730 00001B9A C3                      	retn
  3731                                  
  3732                                  interpolating_3_8bit_stereo:
  3733                                  	; 16/11/2023
  3734                                  	; al = [previous_val_l]
  3735                                  	; ah = [previous_val_r]
  3736                                  	; dl = [next_val_l]
  3737                                  	; dh = [next_val_r]	
  3738                                  	; original-interpolated-interpolated
  3739 00001B9B 89C3                    	mov	ebx, eax
  3740 00001B9D 2C80                    	sub	al, 80h
  3741 00001B9F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3742 00001BA3 66AB                    	stosw		; original sample (L)
  3743 00001BA5 88F8                    	mov	al, bh
  3744 00001BA7 2C80                    	sub	al, 80h
  3745 00001BA9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3746 00001BAD 66AB                    	stosw		; original sample (R)
  3747 00001BAF 88D8                    	mov	al, bl
  3748 00001BB1 00D0                    	add	al, dl	; [next_val_l]	
  3749 00001BB3 D0D8                    	rcr	al, 1
  3750 00001BB5 50                      	push	eax ; *	; al = interpolated middle (L) (temporary)
  3751 00001BB6 00D8                    	add	al, bl	; [previous_val_l]
  3752 00001BB8 D0D8                    	rcr	al, 1
  3753 00001BBA 2C80                    	sub	al, 80h
  3754 00001BBC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3755 00001BC0 66AB                    	stosw		; interpolated sample 1 (L)
  3756 00001BC2 88F8                    	mov	al, bh
  3757 00001BC4 00F0                    	add	al, dh	; [next_val_r]
  3758 00001BC6 D0D8                    	rcr	al, 1
  3759 00001BC8 50                      	push	eax ; ** ; al = interpolated middle (R) (temporary)
  3760 00001BC9 00F8                    	add	al, bh	; [previous_val_r]
  3761 00001BCB D0D8                    	rcr	al, 1
  3762 00001BCD 2C80                    	sub	al, 80h
  3763 00001BCF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3764 00001BD3 66AB                    	stosw		; interpolated sample 1 (R)
  3765 00001BD5 5B                      	pop	ebx ; **
  3766 00001BD6 58                      	pop	eax ; *
  3767 00001BD7 00D0                    	add	al, dl	; [next_val_l]
  3768 00001BD9 D0D8                    	rcr	al, 1
  3769 00001BDB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3770 00001BDF 66AB                    	stosw		; interpolated sample 2 (L)
  3771 00001BE1 88D8                    	mov	al, bl
  3772 00001BE3 00F0                    	add	al, dh	; [next_val_r]
  3773 00001BE5 D0D8                    	rcr	al, 1
  3774 00001BE7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3775 00001BEB 66AB                    	stosw		; interpolated sample 2 (R)
  3776 00001BED C3                      	retn
  3777                                  
  3778                                  interpolating_2_8bit_mono:
  3779                                  	; 16/11/2023
  3780                                  	; al = [previous_val]
  3781                                  	; dl = [next_val]
  3782                                  	; original-interpolated
  3783 00001BEE 88C3                    	mov	bl, al
  3784 00001BF0 2C80                    	sub	al, 80h
  3785 00001BF2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3786 00001BF6 66AB                    	stosw		; original sample (L)
  3787 00001BF8 66AB                    	stosw		; original sample (R)
  3788 00001BFA 88D8                    	mov	al, bl
  3789 00001BFC 00D0                    	add	al, dl	
  3790 00001BFE D0D8                    	rcr	al, 1
  3791 00001C00 2C80                    	sub	al, 80h
  3792 00001C02 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3793 00001C06 66AB                    	stosw		; interpolated sample (L)
  3794 00001C08 66AB                    	stosw		; interpolated sample (R)
  3795 00001C0A C3                      	retn
  3796                                  
  3797                                  interpolating_2_8bit_stereo:
  3798                                  	; 16/11/2023
  3799                                  	; al = [previous_val_l]
  3800                                  	; ah = [previous_val_r]
  3801                                  	; dl = [next_val_l]
  3802                                  	; dh = [next_val_r]	
  3803                                  	; original-interpolated
  3804 00001C0B 89C3                    	mov	ebx, eax
  3805 00001C0D 2C80                    	sub	al, 80h
  3806 00001C0F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3807 00001C13 66AB                    	stosw		; original sample (L)
  3808 00001C15 88F8                    	mov	al, bh
  3809 00001C17 2C80                    	sub	al, 80h
  3810 00001C19 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3811 00001C1D 66AB                    	stosw		; original sample (R)
  3812 00001C1F 88D8                    	mov	al, bl	; [previous_val_l]
  3813 00001C21 00D0                    	add	al, dl	; [next_val_l]	
  3814 00001C23 D0D8                    	rcr	al, 1
  3815 00001C25 2C80                    	sub	al, 80h
  3816 00001C27 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3817 00001C2B 66AB                    	stosw		; interpolated sample (L)
  3818 00001C2D 88F8                    	mov	al, bh
  3819 00001C2F 00F0                    	add	al, dh	; [next_val_r]
  3820 00001C31 D0D8                    	rcr	al, 1
  3821 00001C33 2C80                    	sub	al, 80h
  3822 00001C35 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3823 00001C39 66AB                    	stosw		; interpolated sample (R)
  3824 00001C3B C3                      	retn
  3825                                  
  3826                                  interpolating_3_16bit_mono:
  3827                                  	; 16/11/2023
  3828                                  	; ax = [previous_val]
  3829                                  	; dx = [next_val]
  3830                                  	; original-interpolated-interpolated
  3831                                  
  3832 00001C3C 66AB                    	stosw		; original sample (L)
  3833 00001C3E 66AB                    	stosw		; original sample (R)
  3834 00001C40 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3835 00001C43 50                      	push	eax ; *	; [previous_val]
  3836 00001C44 80C680                  	add	dh, 80h
  3837 00001C47 6601D0                  	add	ax, dx
  3838 00001C4A 66D1D8                  	rcr	ax, 1
  3839 00001C4D 5B                      	pop	ebx ; *		
  3840 00001C4E 93                      	xchg	ebx, eax ; bx  = interpolated middle (temporary)
  3841 00001C4F 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  3842 00001C52 66D1D8                  	rcr	ax, 1
  3843 00001C55 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3844 00001C58 66AB                    	stosw 		; interpolated sample 1 (L)
  3845 00001C5A 66AB                    	stosw		; interpolated sample 1 (R)
  3846 00001C5C 89D8                    	mov	eax, ebx
  3847 00001C5E 6601D0                  	add	ax, dx	 ;interpolated middle + [next_val]
  3848 00001C61 66D1D8                  	rcr	ax, 1
  3849 00001C64 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3850 00001C67 66AB                    	stosw		; interpolated sample 2 (L)
  3851 00001C69 66AB                    	stosw		; interpolated sample 2 (R)
  3852 00001C6B C3                      	retn
  3853                                  
  3854                                  interpolating_3_16bit_stereo:
  3855                                  	; 16/11/2023
  3856                                  	; bx = [previous_val_l]
  3857                                  	; ax = [previous_val_r]
  3858                                  	; [next_val_l]
  3859                                  	; dx = [next_val_r]
  3860                                  	; original-interpolated-interpolated
  3861                                  
  3862 00001C6C 93                      	xchg	eax, ebx
  3863 00001C6D 66AB                    	stosw		; original sample (L)
  3864 00001C6F 93                      	xchg	eax, ebx
  3865 00001C70 66AB                    	stosw		; original sample (R)
  3866 00001C72 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3867 00001C75 50                      	push	eax ; *	; [previous_val_r]
  3868 00001C76 80C780                  	add	bh, 80h
  3869 00001C79 8005[B5200000]80        	add	byte [next_val_l+1], 80h
  3870 00001C80 66A1[B4200000]          	mov	ax, [next_val_l]
  3871 00001C86 6601D8                  	add	ax, bx	; [previous_val_l]
  3872 00001C89 66D1D8                  	rcr	ax, 1
  3873 00001C8C 93                      	xchg	eax, ebx ; ax = [previous_val_l]	
  3874 00001C8D 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  3875 00001C90 66D1D8                  	rcr	ax, 1
  3876 00001C93 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3877 00001C96 66AB                    	stosw 		; interpolated sample 1 (L)
  3878 00001C98 58                      	pop	eax  ; *
  3879 00001C99 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  3880 00001C9C 52                      	push	edx  ; * ; [next_val_r]
  3881 00001C9D 92                      	xchg	eax, edx
  3882 00001C9E 6601D0                  	add	ax, dx	; [next_val_r] + [previous_val_r]
  3883 00001CA1 66D1D8                  	rcr	ax, 1	; / 2
  3884 00001CA4 50                      	push	eax ; ** ; interpolated middle (R)
  3885 00001CA5 6601D0                  	add	ax, dx	; + [previous_val_r]
  3886 00001CA8 66D1D8                  	rcr	ax, 1
  3887 00001CAB 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3888 00001CAE 66AB                    	stosw 		; interpolated sample 1 (R)
  3889 00001CB0 66A1[B4200000]          	mov	ax, [next_val_l]
  3890 00001CB6 6601D8                  	add	ax, bx	; + interpolated middle (L)
  3891 00001CB9 66D1D8                  	rcr	ax, 1
  3892 00001CBC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3893 00001CBF 66AB                    	stosw 		; interpolated sample 2 (L)
  3894 00001CC1 58                      	pop	eax ; **
  3895 00001CC2 5A                      	pop	edx ; *	
  3896 00001CC3 6601D0                  	add	ax, dx	; interpolated middle + [next_val_r]
  3897 00001CC6 66D1D8                  	rcr	ax, 1	; / 2
  3898 00001CC9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3899 00001CCC 66AB                    	stosw 		; interpolated sample 2 (L)
  3900 00001CCE C3                      	retn
  3901                                  
  3902                                  interpolating_2_16bit_mono:
  3903                                  	; 16/11/2023
  3904                                  	; ax = [previous_val]
  3905                                  	; dx = [next_val]
  3906                                  	; original-interpolated
  3907                                  
  3908 00001CCF 66AB                    	stosw		; original sample (L)
  3909 00001CD1 66AB                    	stosw		; original sample (R)
  3910 00001CD3 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3911 00001CD6 80C680                  	add	dh, 80h
  3912 00001CD9 6601D0                  	add	ax, dx
  3913 00001CDC 66D1D8                  	rcr	ax, 1
  3914 00001CDF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3915 00001CE2 66AB                    	stosw		; interpolated sample (L)
  3916 00001CE4 66AB                    	stosw		; interpolated sample (R)
  3917 00001CE6 C3                      	retn
  3918                                  
  3919                                  interpolating_2_16bit_stereo:
  3920                                  	; 16/11/2023
  3921                                  	; bx = [previous_val_l]
  3922                                  	; ax = [previous_val_r]
  3923                                  	; [next_val_l]
  3924                                  	; dx = [next_val_r]
  3925                                  	; original-interpolated
  3926                                  
  3927 00001CE7 93                      	xchg	eax, ebx
  3928 00001CE8 66AB                    	stosw		; original sample (L)
  3929 00001CEA 93                      	xchg	eax, ebx
  3930 00001CEB 66AB                    	stosw		; original sample (R)
  3931 00001CED 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3932 00001CF0 80C680                  	add	dh, 80h
  3933 00001CF3 6601D0                  	add	ax, dx	; [previous_val_r] + [next_val_r]
  3934 00001CF6 66D1D8                  	rcr	ax, 1	; / 2
  3935 00001CF9 50                      	push	eax ; *	; interpolated sample (R)
  3936 00001CFA 66A1[B4200000]          	mov	ax, [next_val_l]
  3937 00001D00 80C480                  	add	ah, 80h
  3938 00001D03 80C780                  	add	bh, 80h
  3939 00001D06 6601D8                  	add	ax, bx	; [next_val_l] + [previous_val_l]
  3940 00001D09 66D1D8                  	rcr	ax, 1	; / 2		
  3941 00001D0C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3942 00001D0F 66AB                    	stosw 		; interpolated sample (L)
  3943 00001D11 58                      	pop	eax ; *	
  3944 00001D12 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3945 00001D15 66AB                    	stosw 		; interpolated sample (R)
  3946 00001D17 C3                      	retn
  3947                                  
  3948                                  interpolating_5_8bit_mono:
  3949                                  	; 17/11/2023
  3950                                  	; al = [previous_val]
  3951                                  	; dl = [next_val]
  3952                                  	; original-interpltd-interpltd-interpltd-interpltd
  3953 00001D18 88C3                    	mov	bl, al
  3954 00001D1A 2C80                    	sub	al, 80h
  3955 00001D1C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3956 00001D20 66AB                    	stosw		; original sample (L)
  3957 00001D22 66AB                    	stosw		; original sample (R)
  3958 00001D24 88D8                    	mov	al, bl
  3959 00001D26 00D0                    	add	al, dl	
  3960 00001D28 D0D8                    	rcr	al, 1
  3961 00001D2A 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3962 00001D2C 00D8                    	add	al, bl  ; [previous_val]
  3963 00001D2E D0D8                    	rcr	al, 1 	
  3964 00001D30 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  3965 00001D32 00D8                    	add	al, bl
  3966 00001D34 D0D8                    	rcr	al, 1
  3967 00001D36 2C80                    	sub	al, 80h
  3968 00001D38 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3969 00001D3C 66AB                    	stosw		; interpolated sample 1 (L)
  3970 00001D3E 66AB                    	stosw		; interpolated sample 1 (R)
  3971 00001D40 88F8                    	mov	al, bh
  3972 00001D42 00F0                    	add	al, dh
  3973 00001D44 D0D8                    	rcr	al, 1
  3974 00001D46 2C80                    	sub	al, 80h
  3975 00001D48 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3976 00001D4C 66AB                    	stosw		; interpolated sample 2 (L)
  3977 00001D4E 66AB                    	stosw		; interpolated sample 2 (R)
  3978 00001D50 88F8                    	mov	al, bh
  3979 00001D52 00D0                    	add	al, dl	; [next_val]
  3980 00001D54 D0D8                    	rcr	al, 1
  3981 00001D56 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  3982 00001D58 00F8                    	add	al, bh
  3983 00001D5A D0D8                    	rcr	al, 1
  3984 00001D5C 2C80                    	sub	al, 80h
  3985 00001D5E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3986 00001D62 66AB                    	stosw		; interpolated sample 3 (L)
  3987 00001D64 66AB                    	stosw		; interpolated sample 3 (R)
  3988 00001D66 88F0                    	mov	al, dh
  3989 00001D68 00D0                    	add	al, dl
  3990 00001D6A D0D8                    	rcr	al, 1
  3991 00001D6C 2C80                    	sub	al, 80h
  3992 00001D6E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3993 00001D72 66AB                    	stosw		; interpolated sample 4 (L)
  3994 00001D74 66AB                    	stosw		; interpolated sample 4 (R)
  3995 00001D76 C3                      	retn
  3996                                  
  3997                                  interpolating_5_8bit_stereo:
  3998                                  	; 17/11/2023
  3999                                  	; al = [previous_val_l]
  4000                                  	; ah = [previous_val_r]
  4001                                  	; dl = [next_val_l]
  4002                                  	; dh = [next_val_r]	
  4003                                  	; original-interpltd-interpltd-interpltd-interpltd
  4004 00001D77 89C3                    	mov	ebx, eax
  4005 00001D79 2C80                    	sub	al, 80h
  4006 00001D7B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4007 00001D7F 66AB                    	stosw		; original sample (L)
  4008 00001D81 88F8                    	mov	al, bh
  4009 00001D83 2C80                    	sub	al, 80h
  4010 00001D85 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4011 00001D89 66AB                    	stosw		; original sample (R)
  4012 00001D8B 52                      	push	edx ; *
  4013 00001D8C 88D8                    	mov	al, bl
  4014 00001D8E 00D0                    	add	al, dl	; [next_val_l]
  4015 00001D90 D0D8                    	rcr	al, 1
  4016 00001D92 50                      	push	eax ; **	; al = interpolated middle (L) (temporary)
  4017 00001D93 00D8                    	add	al, bl	; [previous_val_l]
  4018 00001D95 D0D8                    	rcr	al, 1
  4019 00001D97 86D8                    	xchg	al, bl	
  4020 00001D99 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  4021 00001D9B D0D8                    	rcr	al, 1
  4022 00001D9D 2C80                    	sub	al, 80h
  4023 00001D9F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4024 00001DA3 66AB                    	stosw		; interpolated sample 1 (L)
  4025 00001DA5 88F8                    	mov	al, bh
  4026 00001DA7 00F0                    	add	al, dh	; [next_val_r]
  4027 00001DA9 D0D8                    	rcr	al, 1
  4028 00001DAB 50                      	push	eax ; *** ; al = interpolated middle (R) (temporary)
  4029 00001DAC 00F8                    	add	al, bh	; [previous_val_r]
  4030 00001DAE D0D8                    	rcr	al, 1
  4031 00001DB0 86F8                    	xchg	al, bh	
  4032 00001DB2 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  4033 00001DB4 D0D8                    	rcr	al, 1
  4034 00001DB6 2C80                    	sub	al, 80h
  4035 00001DB8 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4036 00001DBC 66AB                    	stosw		; interpolated sample 1 (R)
  4037 00001DBE 5A                      	pop	edx ; ***
  4038 00001DBF 58                      	pop	eax ; **	; al = interpolated middle (L) (temporary)
  4039 00001DC0 86D8                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  4040 00001DC2 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  4041 00001DC4 D0D8                    	rcr	al, 1
  4042 00001DC6 2C80                    	sub	al, 80h
  4043 00001DC8 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4044 00001DCC 66AB                    	stosw		; interpolated sample 2 (L)	
  4045 00001DCE 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  4046 00001DD0 86F8                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  4047 00001DD2 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  4048 00001DD4 D0D8                    	rcr	al, 1
  4049 00001DD6 2C80                    	sub	al, 80h
  4050 00001DD8 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4051 00001DDC 66AB                    	stosw		; interpolated sample 2 (R)
  4052 00001DDE 5A                      	pop	edx ; *
  4053 00001DDF 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  4054 00001DE1 00D0                    	add	al, dl	; [next_val_l]
  4055 00001DE3 D0D8                    	rcr	al, 1
  4056 00001DE5 86D8                    	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  4057 00001DE7 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  4058 00001DE9 D0D8                    	rcr	al, 1
  4059 00001DEB 2C80                    	sub	al, 80h
  4060 00001DED 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4061 00001DF1 66AB                    	stosw		; interpolated sample 3 (L)
  4062 00001DF3 88F8                    	mov	al, bh	
  4063 00001DF5 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  4064 00001DF7 D0D8                    	rcr	al, 1
  4065 00001DF9 86F8                    	xchg	al, bh	; al = interpolated middle (R)
  4066 00001DFB 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  4067 00001DFD D0D8                    	rcr	al, 1
  4068 00001DFF 2C80                    	sub	al, 80h
  4069 00001E01 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4070 00001E05 66AB                    	stosw		; interpolated sample 3 (R)
  4071 00001E07 88D8                    	mov	al, bl
  4072 00001E09 00D0                    	add	al, dl	; [next_val_l]
  4073 00001E0B D0D8                    	rcr	al, 1
  4074 00001E0D 2C80                    	sub	al, 80h
  4075 00001E0F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4076 00001E13 66AB                    	stosw		; interpolated sample 4 (L)
  4077 00001E15 88F8                    	mov	al, bh
  4078 00001E17 00F0                    	add	al, dh	; [next_val_r]
  4079 00001E19 D0D8                    	rcr	al, 1
  4080 00001E1B 2C80                    	sub	al, 80h
  4081 00001E1D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4082 00001E21 66AB                    	stosw		; interpolated sample 4 (R)
  4083 00001E23 C3                      	retn
  4084                                  
  4085                                  interpolating_4_8bit_mono:
  4086                                  	; 17/11/2023
  4087                                  	; al = [previous_val]
  4088                                  	; dl = [next_val]
  4089                                  	; original-interpolated-interpolated-interpolated
  4090 00001E24 88C3                    	mov	bl, al
  4091 00001E26 2C80                    	sub	al, 80h
  4092 00001E28 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4093 00001E2C 66AB                    	stosw		; original sample (L)
  4094 00001E2E 66AB                    	stosw		; original sample (R)
  4095 00001E30 88D8                    	mov	al, bl
  4096 00001E32 00D0                    	add	al, dl	
  4097 00001E34 D0D8                    	rcr	al, 1
  4098 00001E36 86D8                    	xchg	al, bl  ; al = [previous_val]
  4099 00001E38 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  4100 00001E3A D0D8                    	rcr	al, 1 	
  4101 00001E3C 2C80                    	sub	al, 80h
  4102 00001E3E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4103 00001E42 66AB                    	stosw		; interpolated sample 1 (L)
  4104 00001E44 66AB                    	stosw		; interpolated sample 1 (R)
  4105 00001E46 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  4106 00001E48 2C80                    	sub	al, 80h
  4107 00001E4A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4108 00001E4E 66AB                    	stosw		; interpolated sample 2 (L)
  4109 00001E50 66AB                    	stosw		; interpolated sample 2 (R)
  4110 00001E52 88D8                    	mov	al, bl
  4111 00001E54 00D0                    	add	al, dl	; [next_val]
  4112 00001E56 D0D8                    	rcr	al, 1
  4113 00001E58 2C80                    	sub	al, 80h
  4114 00001E5A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4115 00001E5E 66AB                    	stosw		; interpolated sample 3 (L)
  4116 00001E60 66AB                    	stosw		; interpolated sample 3 (R)
  4117 00001E62 C3                      	retn
  4118                                  
  4119                                  interpolating_4_8bit_stereo:
  4120                                  	; 17/11/2023
  4121                                  	; al = [previous_val_l]
  4122                                  	; ah = [previous_val_r]
  4123                                  	; dl = [next_val_l]
  4124                                  	; dh = [next_val_r]	
  4125                                  	; original-interpolated-interpolated-interpolated
  4126 00001E63 89C3                    	mov	ebx, eax
  4127 00001E65 2C80                    	sub	al, 80h
  4128 00001E67 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4129 00001E6B 66AB                    	stosw		; original sample (L)
  4130 00001E6D 88F8                    	mov	al, bh
  4131 00001E6F 2C80                    	sub	al, 80h
  4132 00001E71 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4133 00001E75 66AB                    	stosw		; original sample (R)
  4134 00001E77 88D8                    	mov	al, bl
  4135 00001E79 00D0                    	add	al, dl	; [next_val_l]
  4136 00001E7B D0D8                    	rcr	al, 1
  4137 00001E7D 86D8                    	xchg	al, bl	; al = [previous_val_l]
  4138 00001E7F 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  4139 00001E81 D0D8                    	rcr	al, 1
  4140 00001E83 2C80                    	sub	al, 80h
  4141 00001E85 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4142 00001E89 66AB                    	stosw		; interpolated sample 1 (L)
  4143 00001E8B 88F8                    	mov	al, bh
  4144 00001E8D 00F0                    	add	al, dh	; [next_val_r]
  4145 00001E8F D0D8                    	rcr	al, 1
  4146 00001E91 86F8                    	xchg	al, bh	; al = [previous_val_h]
  4147 00001E93 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  4148 00001E95 D0D8                    	rcr	al, 1
  4149 00001E97 2C80                    	sub	al, 80h
  4150 00001E99 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4151 00001E9D 66AB                    	stosw		; interpolated sample 1 (R)
  4152 00001E9F 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  4153 00001EA1 2C80                    	sub	al, 80h
  4154 00001EA3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4155 00001EA7 66AB                    	stosw		; interpolated sample 2 (L)
  4156 00001EA9 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  4157 00001EAB 2C80                    	sub	al, 80h
  4158 00001EAD 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4159 00001EB1 66AB                    	stosw		; interpolated sample 2 (L)
  4160 00001EB3 88D8                    	mov	al, bl
  4161 00001EB5 00D0                    	add	al, dl	; [next_val_l]
  4162 00001EB7 D0D8                    	rcr	al, 1
  4163 00001EB9 2C80                    	sub	al, 80h
  4164 00001EBB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4165 00001EBF 66AB                    	stosw		; interpolated sample 3 (L)
  4166 00001EC1 88F8                    	mov	al, bh
  4167 00001EC3 00F0                    	add	al, dh	; [next_val_r]
  4168 00001EC5 D0D8                    	rcr	al, 1
  4169 00001EC7 2C80                    	sub	al, 80h
  4170 00001EC9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4171 00001ECD 66AB                    	stosw		; interpolated sample 3 (R)
  4172 00001ECF C3                      	retn
  4173                                  
  4174                                  interpolating_5_16bit_mono:
  4175                                  	; 18/11/2023
  4176                                  	; ax = [previous_val]
  4177                                  	; dx = [next_val]
  4178                                  	; original-interpltd-interpltd-interpltd-interpltd
  4179 00001ED0 66AB                    	stosw		; original sample (L)
  4180 00001ED2 66AB                    	stosw		; original sample (R)
  4181 00001ED4 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4182 00001ED7 89C3                    	mov	ebx, eax ; [previous_val]
  4183 00001ED9 80C680                  	add	dh, 80h
  4184 00001EDC 6601D0                  	add	ax, dx
  4185 00001EDF 66D1D8                  	rcr	ax, 1
  4186 00001EE2 50                      	push	eax ; *	; interpolated middle (temporary)
  4187 00001EE3 6601D8                  	add	ax, bx	; interpolated middle + [previous_val] 
  4188 00001EE6 66D1D8                  	rcr	ax, 1
  4189 00001EE9 50                      	push	eax ; **	; interpolated 1st quarter (temporary)
  4190 00001EEA 6601D8                  	add	ax, bx	; 1st quarter + [previous_val]
  4191 00001EED 66D1D8                  	rcr	ax, 1	
  4192 00001EF0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4193 00001EF3 66AB                    	stosw 		; interpolated sample 1 (L)
  4194 00001EF5 66AB                    	stosw		; interpolated sample 1 (R)
  4195 00001EF7 58                      	pop	eax ; **	
  4196 00001EF8 5B                      	pop	ebx ; *
  4197 00001EF9 6601D8                  	add	ax, bx	; 1st quarter + middle
  4198 00001EFC 66D1D8                  	rcr	ax, 1	; / 2
  4199 00001EFF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  4200 00001F02 66AB                    	stosw		; interpolated sample 2 (L)
  4201 00001F04 66AB                    	stosw		; interpolated sample 2 (R)		
  4202 00001F06 89D8                    	mov	eax, ebx
  4203 00001F08 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4204 00001F0B 66D1D8                  	rcr	ax, 1
  4205 00001F0E 50                      	push	eax ; *	; interpolated 3rd quarter (temporary)
  4206 00001F0F 6601D8                  	add	ax, bx	; + interpolated middle
  4207 00001F12 66D1D8                  	rcr	ax, 1
  4208 00001F15 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4209 00001F18 66AB                    	stosw		; interpolated sample 3 (L)
  4210 00001F1A 66AB                    	stosw		; interpolated sample 3 (R)
  4211 00001F1C 58                      	pop	eax ; *	
  4212 00001F1D 6601D0                  	add	ax, dx	; 3rd quarter + [next_val]
  4213 00001F20 66D1D8                  	rcr	ax, 1	; / 2
  4214 00001F23 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4215 00001F26 66AB                    	stosw		; interpolated sample 4 (L)
  4216 00001F28 66AB                    	stosw		; interpolated sample 4 (R)
  4217 00001F2A C3                      	retn
  4218                                  
  4219                                  interpolating_5_16bit_stereo:
  4220                                  	; 18/11/2023
  4221                                  	; bx = [previous_val_l]
  4222                                  	; ax = [previous_val_r]
  4223                                  	; [next_val_l]
  4224                                  	; [next_val_r]
  4225                                  	; original-interpltd-interpltd-interpltd-interpltd
  4226 00001F2B 51                      	push	ecx ; !
  4227 00001F2C 93                      	xchg	eax, ebx
  4228 00001F2D 66AB                    	stosw		; original sample (L)
  4229 00001F2F 93                      	xchg	eax, ebx
  4230 00001F30 66AB                    	stosw		; original sample (R)
  4231 00001F32 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4232 00001F35 50                      	push	eax ; *	; [previous_val_r]
  4233 00001F36 80C780                  	add	bh, 80h
  4234 00001F39 8005[B5200000]80        	add	byte [next_val_l+1], 80h
  4235 00001F40 66A1[B4200000]          	mov	ax, [next_val_l]
  4236 00001F46 6601D8                  	add	ax, bx	; [previous_val_l]
  4237 00001F49 66D1D8                  	rcr	ax, 1
  4238 00001F4C 89C1                    	mov	ecx, eax ; interpolated middle (L)
  4239 00001F4E 6601D8                  	add	ax, bx	
  4240 00001F51 66D1D8                  	rcr	ax, 1
  4241 00001F54 89C2                    	mov	edx, eax ; interpolated 1st quarter (L)	
  4242 00001F56 6601D8                  	add	ax, bx	; [previous_val_l]
  4243 00001F59 66D1D8                  	rcr	ax, 1
  4244 00001F5C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4245 00001F5F 66AB                    	stosw 		; interpolated sample 1 (L)
  4246 00001F61 89C8                    	mov	eax, ecx
  4247 00001F63 6601D0                  	add	ax, dx	; middle (L) + 1st quarter (L) 
  4248 00001F66 66D1D8                  	rcr	ax, 1	; / 2
  4249 00001F69 89C3                    	mov	ebx, eax  ; interpolated sample 2 (L)
  4250 00001F6B 5A                      	pop	edx ; *	; [previous_val_r]
  4251 00001F6C 89D0                    	mov	eax, edx
  4252 00001F6E 8005[B7200000]80        	add	byte [next_val_r+1], 80h
  4253 00001F75 660305[B6200000]        	add	ax, [next_val_r]
  4254 00001F7C 66D1D8                  	rcr	ax, 1
  4255 00001F7F 50                      	push	eax ; *	; interpolated middle (R)
  4256 00001F80 6601D0                  	add	ax, dx
  4257 00001F83 66D1D8                  	rcr	ax, 1
  4258 00001F86 50                      	push	eax ; ** ; interpolated 1st quarter (R)
  4259 00001F87 6601D0                  	add	ax, dx	; [previous_val_r]
  4260 00001F8A 66D1D8                  	rcr	ax, 1
  4261 00001F8D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4262 00001F90 66AB                    	stosw 		; interpolated sample 1 (R)
  4263 00001F92 89D8                    	mov	eax, ebx
  4264 00001F94 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4265 00001F97 66AB                    	stosw 		; interpolated sample 2 (L)
  4266 00001F99 58                      	pop	eax ; **
  4267 00001F9A 5A                      	pop	edx ; *
  4268 00001F9B 6601D0                  	add	ax, dx	; 1st quarter (R) + middle (R)
  4269 00001F9E 66D1D8                  	rcr	ax, 1	; / 2
  4270 00001FA1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4271 00001FA4 66AB                    	stosw 		; interpolated sample 2 (R)
  4272 00001FA6 89C8                    	mov	eax, ecx
  4273 00001FA8 660305[B4200000]        	add	ax, [next_val_l]
  4274 00001FAF 66D1D8                  	rcr	ax, 1
  4275 00001FB2 50                      	push	eax ; * ; interpolated 3rd quarter (L)
  4276 00001FB3 6601C8                  	add	ax, cx	; interpolated middle (L)
  4277 00001FB6 66D1D8                  	rcr	ax, 1
  4278 00001FB9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4279 00001FBC 66AB                    	stosw 		; interpolated sample 3 (L)
  4280 00001FBE 89D0                    	mov	eax, edx
  4281 00001FC0 660305[B6200000]        	add	ax, [next_val_r]
  4282 00001FC7 66D1D8                  	rcr	ax, 1
  4283 00001FCA 50                      	push	eax ; ** ; interpolated 3rd quarter (R)
  4284 00001FCB 6601D0                  	add	ax, dx	; interpolated middle (R)
  4285 00001FCE 66D1D8                  	rcr	ax, 1
  4286 00001FD1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4287 00001FD4 66AB                    	stosw 		; interpolated sample 3 (R)
  4288 00001FD6 5B                      	pop	ebx ; **
  4289 00001FD7 58                      	pop	eax ; *
  4290 00001FD8 660305[B4200000]        	add	ax, [next_val_l]
  4291 00001FDF 66D1D8                  	rcr	ax, 1
  4292 00001FE2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4293 00001FE5 66AB                    	stosw 		; interpolated sample 4 (L)
  4294 00001FE7 89D8                    	mov	eax, ebx	
  4295 00001FE9 660305[B6200000]        	add	ax, [next_val_r]
  4296 00001FF0 66D1D8                  	rcr	ax, 1
  4297 00001FF3 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4298 00001FF6 66AB                    	stosw 		; interpolated sample 4 (R)
  4299 00001FF8 59                      	pop	ecx ; !
  4300 00001FF9 C3                      	retn
  4301                                  
  4302                                  interpolating_4_16bit_mono:
  4303                                  	; 18/11/2023
  4304                                  	; ax = [previous_val]
  4305                                  	; dx = [next_val]
  4306                                  	; original-interpolated
  4307                                  
  4308 00001FFA 66AB                    	stosw		; original sample (L)
  4309 00001FFC 66AB                    	stosw		; original sample (R)
  4310 00001FFE 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4311 00002001 89C3                    	mov	ebx, eax ; [previous_val]
  4312 00002003 80C680                  	add	dh, 80h
  4313 00002006 6601D0                  	add	ax, dx	; [previous_val] + [next_val]
  4314 00002009 66D1D8                  	rcr	ax, 1
  4315 0000200C 93                      	xchg	eax, ebx	
  4316 0000200D 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  4317 00002010 66D1D8                  	rcr	ax, 1
  4318 00002013 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4319 00002016 66AB                    	stosw 		; interpolated sample 1 (L)
  4320 00002018 66AB                    	stosw		; interpolated sample 1 (R)
  4321 0000201A 89D8                    	mov	eax, ebx ; interpolated middle
  4322 0000201C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4323 0000201F 66AB                    	stosw 		; interpolated sample 2 (L)
  4324 00002021 66AB                    	stosw		; interpolated sample 2 (R)
  4325 00002023 89D8                    	mov	eax, ebx
  4326 00002025 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4327 00002028 66D1D8                  	rcr	ax, 1
  4328 0000202B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4329 0000202E 66AB                    	stosw		; interpolated sample 3 (L)
  4330 00002030 66AB                    	stosw		; interpolated sample 3 (R)
  4331 00002032 C3                      	retn
  4332                                  
  4333                                  interpolating_4_16bit_stereo:
  4334                                  	; 18/11/2023
  4335                                  	; bx = [previous_val_l]
  4336                                  	; ax = [previous_val_r]
  4337                                  	; [next_val_l]
  4338                                  	; [next_val_r]
  4339                                  	; original-interpolated-interpolated-interpolated
  4340 00002033 93                      	xchg	eax, ebx
  4341 00002034 66AB                    	stosw		; original sample (L)
  4342 00002036 93                      	xchg	eax, ebx
  4343 00002037 66AB                    	stosw		; original sample (R)
  4344 00002039 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4345 0000203C 89C2                    	mov	edx, eax ; [previous_val_r]
  4346 0000203E 80C780                  	add	bh, 80h
  4347 00002041 8005[B5200000]80        	add	byte [next_val_l+1], 80h
  4348 00002048 66A1[B4200000]          	mov	ax, [next_val_l]
  4349 0000204E 6601D8                  	add	ax, bx	; [previous_val_l]
  4350 00002051 66D1D8                  	rcr	ax, 1
  4351 00002054 93                      	xchg	eax, ebx	
  4352 00002055 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  4353 00002058 66D1D8                  	rcr	ax, 1
  4354 0000205B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4355 0000205E 66AB                    	stosw 		; interpolated sample 1 (L)
  4356 00002060 8005[B7200000]80        	add	byte [next_val_r+1], 80h
  4357 00002067 89D0                    	mov	eax, edx ; [previous_val_r]
  4358 00002069 660305[B6200000]        	add	ax, [next_val_r]
  4359 00002070 66D1D8                  	rcr	ax, 1
  4360 00002073 92                      	xchg	eax, edx	
  4361 00002074 6601D0                  	add	ax, dx	; dx = interpolated middle (R)
  4362 00002077 66D1D8                  	rcr	ax, 1
  4363 0000207A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4364 0000207D 66AB                    	stosw 		; interpolated sample 1 (R)
  4365 0000207F 89D8                    	mov	eax, ebx
  4366 00002081 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4367 00002084 66AB                    	stosw 		; interpolated sample 2 (L)
  4368 00002086 89D0                    	mov	eax, edx
  4369 00002088 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4370 0000208B 66AB                    	stosw 		; interpolated sample 2 (R)
  4371 0000208D 89D8                    	mov	eax, ebx
  4372 0000208F 660305[B4200000]        	add	ax, [next_val_l]
  4373 00002096 66D1D8                  	rcr	ax, 1
  4374 00002099 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4375 0000209C 66AB                    	stosw 		; interpolated sample 3 (L)
  4376 0000209E 89D0                    	mov	eax, edx
  4377 000020A0 660305[B6200000]        	add	ax, [next_val_r]
  4378 000020A7 66D1D8                  	rcr	ax, 1
  4379 000020AA 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4380 000020AD 66AB                    	stosw 		; interpolated sample 3 (R)
  4381 000020AF C3                      	retn
  4382                                  
  4383                                  ; 13/11/2023
  4384                                  previous_val:
  4385 000020B0 0000                    previous_val_l: dw 0
  4386 000020B2 0000                    previous_val_r: dw 0
  4387                                  next_val:
  4388 000020B4 0000                    next_val_l: dw 0
  4389 000020B6 0000                    next_val_r: dw 0
  4390                                  
  4391                                  ; 16/11/2023
  4392 000020B8 00                      faz:	db 0	
  4393                                  	
  4394                                  ;=============================================================================
  4395                                  ;	gfx.asm - draw scopes in VGA 640x480x16 mode      
  4396                                  ;=============================================================================
  4397                                  
  4398                                  ; EX1A.ASM (21/6/1994, Carlos Hasan; MSDOS, 'RUNME.EXE', 'TNYPL211')
  4399                                  
  4400                                  ;-----------------------------------------------------------------------------
  4401                                  ; setgraphmode - setup the VGA 640x480x16 graphics mode
  4402                                  ;-----------------------------------------------------------------------------
  4403                                  	; 22/10/2017
  4404                                  setgraphmode:
  4405                                  	;pushad
  4406 000020B9 66B81200                	mov	ax,0012h
  4407                                  	;int	10h
  4408 000020BD CD31                    	int 	31h
  4409 000020BF 66BAC003                	mov	dx,3C0h
  4410 000020C3 30C0                    	xor	al,al
  4411                                  setgraphmodel0:
  4412                                  	;out	dx,al
  4413 000020C5 B401                    	mov	ah, 1 ; outb
  4414 000020C7 CD34                    	int	34h
  4415                                  	;out	dx, al
  4416                                  	;mov	ah, 1
  4417 000020C9 CD34                    	int	34h
  4418 000020CB FEC0                    	inc	al
  4419 000020CD 3C10                    	cmp	al, 10h
  4420 000020CF 72F4                    	jb	short setgraphmodel0
  4421 000020D1 B020                    	mov	al, 20h
  4422                                  	;out	dx, al
  4423                                  	;mov	ah, 1
  4424 000020D3 CD34                    	int	34h
  4425                                  	;popad
  4426 000020D5 C3                      	retn
  4427                                  
  4428                                  ;-----------------------------------------------------------------------------
  4429                                  ; settextmode - restore the VGA 80x25x16 text mode
  4430                                  ;-----------------------------------------------------------------------------
  4431                                  	; 22/10/2017
  4432                                  settextmode:
  4433                                  	;pushad
  4434 000020D6 66B80300                	mov	ax, 0003h
  4435                                  	;int	10h
  4436 000020DA CD31                    	int	31h
  4437                                  	;popad
  4438 000020DC C3                      	retn
  4439                                  
  4440                                  ;-----------------------------------------------------------------------------
  4441                                  ; drawscopes - draw the track voices sample scopes
  4442                                  ; In:
  4443                                  ;  ESI = (current) sample buffer
  4444                                  ;-----------------------------------------------------------------------------
  4445                                  	; 27/12/2024
  4446                                  	; 29/10/2017
  4447                                  	; 28/10/2017
  4448                                  	; (ESI = Current DMA buffer offset)
  4449                                  	; 27/10/2017
  4450                                  	; 26/10/2017
  4451                                  	; 23/10/2017
  4452                                  drawscopes:
  4453                                  	;pushad
  4454                                    	;mov	esi, g_buff
  4455                                  	;mov	esi, edx
  4456 000020DD 31C9                    	xor     ecx, ecx	
  4457 000020DF 31D2                    	xor     edx, edx
  4458 000020E1 31FF                    	xor	edi, edi
  4459                                  drawscope0:
  4460 000020E3 66AD                    	lodsw
  4461 000020E5 80F480                  	xor	ah, 80h
  4462 000020E8 0FB6DC                  	movzx	ebx, ah  ; Left Channel
  4463                                  	;shl	bx, 1
  4464                                  	; 27/12/2024
  4465 000020EB D1E3                    	shl	ebx, 1
  4466 000020ED 668B83[A0680000]        	mov	ax, [RowOfs+ebx]
  4467 000020F4 668987[A06A0000]        	mov	[NewScope_L+edi], ax
  4468 000020FB 30FF                    	xor	bh, bh
  4469 000020FD 66AD                    	lodsw
  4470 000020FF 80F480                  	xor	ah, 80h
  4471 00002102 88E3                    	mov	bl, ah	; Right Channel
  4472                                  	;shl	bx, 1
  4473                                  	; 27/12/2024
  4474 00002104 D1E3                    	shl	ebx, 1
  4475 00002106 668B83[A0680000]        	mov	ax, [RowOfs+ebx]
  4476 0000210D 668987[A06C0000]        	mov	[NewScope_R+edi], ax
  4477 00002114 6683C702                	add	di, 2
  4478 00002118 FEC1                    	inc	cl
  4479 0000211A 75C7                    	jnz	short drawscope0	
  4480                                  
  4481 0000211C 66BAC403                        mov	dx, 3C4h
  4482                                          ;mov	ax, 0802h
  4483                                          ;out	dx, ax
  4484 00002120 66BB0208                        mov	bx, 0802h
  4485 00002124 B403                    	mov	ah, 3 ; outw
  4486 00002126 CD34                    	int	34h
  4487                                  	;mov	dx, 3CEh
  4488                                  	; 27/12/2024 
  4489 00002128 B2CE                            mov	dl, 0CEh
  4490 0000212A B008                            mov	al, 08h
  4491                                         ;out	dx, al
  4492 0000212C B401                            mov	ah, 1 ; outb
  4493 0000212E CD34                    	int	34h
  4494                                  	;inc	dx
  4495                                  	; 27/12/2024
  4496 00002130 42                      	inc	edx
  4497                                  
  4498                                  	; 26/10/2017
  4499 00002131 31F6                            xor	esi, esi
  4500                                         ;xor	edi, edi
  4501 00002133 BB45060A00                      mov     ebx, 0A0645h
  4502                                  drawscopel4:
  4503 00002138 B080                            mov     al, 80h
  4504                                  drawscopel2:
  4505 0000213A 50                              push    eax ; *
  4506 0000213B 52                              push    edx ; **
  4507                                  	;out	dx, al
  4508 0000213C B401                    	mov	ah, 1 ; outb
  4509 0000213E CD34                    	int	34h
  4510                                  
  4511 00002140 B4FF                            mov	ah, 0FFh
  4512                                          ;mov	ecx, 32
  4513 00002142 B120                    	mov	cl, 32
  4514 00002144 28C0                    	sub     al, al
  4515                                  drawscopel3:
  4516                                  	; 23/10/2017
  4517 00002146 668B96[A06E0000]                mov	dx, [OldScope_L+esi]
  4518 0000214D 663B96[A06A0000]                cmp	dx, [NewScope_L+esi]
  4519 00002154 7414                            je	short drawscopef3
  4520 00002156 88041A                          mov	[edx+ebx], al ; L
  4521 00002159 668B96[A06A0000]                mov     dx, [NewScope_L+esi]
  4522 00002160 88241A                  	mov	[edx+ebx], ah ; L
  4523 00002163 668996[A06E0000]                mov     [OldScope_L+esi], dx
  4524                                  drawscopef3:
  4525                                  	; 27/10/2017
  4526 0000216A 668B96[A0700000]                mov	dx, [OldScope_R+esi]
  4527 00002171 663B96[A06C0000]                cmp	dx, [NewScope_R+esi]
  4528 00002178 7416                            je	short drawscopef4
  4529 0000217A 88441A26                	mov	[edx+ebx+38], al ; R
  4530 0000217E 668B96[A06C0000]                mov     dx, [NewScope_R+esi]
  4531 00002185 88641A26                        mov	[edx+ebx+38], ah ; R
  4532 00002189 668996[A0700000]                mov     [OldScope_R+esi], dx
  4533                                  drawscopef4:
  4534 00002190 83C610                  	add	esi, 2*8
  4535 00002193 43                      	inc	ebx
  4536 00002194 E2B0                    	loop    drawscopel3
  4537                                  
  4538 00002196 5A                              pop     edx ; **
  4539 00002197 58                              pop     eax ; *
  4540 00002198 81EEFE010000            	sub	esi, 2*256-2
  4541 0000219E 83EB20                  	sub	ebx, 32
  4542 000021A1 D0E8                            shr     al, 1
  4543 000021A3 7595                            jnz	short drawscopel2
  4544                                  	;popad
  4545 000021A5 C3                              retn
  4546                                  
  4547                                  ;=============================================================================
  4548                                  ;	Load IFF/ILBM files for VGA 640x480x16 graphics mode       
  4549                                  ;=============================================================================
  4550                                  
  4551                                  ; EX1B.ASM (21/6/1994, Carlos Hasan; MSDOS, 'RUNME.EXE', 'TNYPL211')
  4552                                  
  4553                                  ; 21/10/2017 (TRDOS 386, 'tmodplay.s', Erdogan Tan, NASM syntax)
  4554                                  
  4555                                  ;-----------------------------------------------------------------------------
  4556                                  ; EQUATES AND STRUCTURES
  4557                                  ;-----------------------------------------------------------------------------
  4558                                  
  4559                                  ID_FORM equ 4D524F46h		; IFF/ILBM chunk IDs
  4560                                  ID_ILBM equ 4D424C49h
  4561                                  ID_BMHD equ 44484D42h
  4562                                  ID_CMAP equ 50414D43h
  4563                                  ID_BODY equ 59444F42h
  4564                                  
  4565                                  struc Form			; IFF/ILBM header file format
  4566 00000000 ????????                  .ID:		resd 1
  4567 00000004 ????????                  .Length:	resd 1
  4568 00000008 ????????                  .Type:	resd 1
  4569                                    .size:
  4570                                  endstruc
  4571                                  
  4572                                  struc Chunk			; IFF/ILBM header chunk format
  4573 00000000 ????????                  .ID:		resd 1
  4574 00000004 ????????                  .Length:	resd 1
  4575                                    .size:	
  4576                                  endstruc
  4577                                  
  4578                                  struc BMHD			; IFF/ILBM BMHD chunk format
  4579 00000000 ????                      .Width: 	resw 1
  4580 00000002 ????                      .Height:	resw 1
  4581 00000004 ????                      .PosX:	resw 1
  4582 00000006 ????                      .PosY:	resw 1
  4583 00000008 ??                        .Planes:	resb 1
  4584 00000009 ??                        .Masking:	resb 1
  4585 0000000A ??                        .Compression:	resb 1
  4586 0000000B ??                        .Pad:		resb 1
  4587 0000000C ????                      .Transparent:	resw 1
  4588 0000000E ??                        .AspectX	resb 1
  4589 0000000F ??                        .AspectY:	resb 1
  4590 00000010 ????                      .PageWidth:	resw 1
  4591 00000012 ????                      .PageHeight:	resw 1
  4592                                    .size:	
  4593                                  endstruc
  4594                                  
  4595                                  struc CMAP			; IFF/ILBM CMAP chunk format
  4596 00000000 <res 300h>                .Colors:	resb 768
  4597                                    .size:	
  4598                                  endstruc
  4599                                  
  4600                                  ;LOGO_ADDRESS	equ 100000h	; virtual address at the end of the 1st 1MB
  4601                                  
  4602                                  ;------------------------------------------------------------------------------
  4603                                  ; bswap - macro to reverse the byte order of a 32-bit register, converting
  4604                                  ;         a value in little/big endian form to big/little endian form.
  4605                                  ;------------------------------------------------------------------------------
  4606                                  %macro	bswap   1
  4607                                          xchg    al, ah
  4608                                          rol     eax, 16
  4609                                          xchg    al, ah
  4610                                  %endmacro
  4611                                  
  4612                                  ;------------------------------------------------------------------------------
  4613                                  ; putlbm - draw the IFF/ILBM picture on VGA 640x480x16 graphics mode
  4614                                  ; In:
  4615                                  ;  ESI = IFF/ILBM image file address
  4616                                  ;------------------------------------------------------------------------------
  4617                                  putlbm:
  4618 000021A6 60                              pushad
  4619                                  
  4620                                  ; check if this is a valid IFF/ILBM Deluxe Paint file
  4621                                  
  4622 000021A7 813E464F524D                    cmp     dword [esi+Form.ID], ID_FORM
  4623 000021AD 7551                            jne     short putlbmd0
  4624 000021AF 817E08494C424D                  cmp     dword [esi+Form.Type], ID_ILBM
  4625 000021B6 7548                            jne     short putlbmd0
  4626                                  
  4627                                  ; get the IFF/ILBM file length in bytes
  4628                                  
  4629 000021B8 8B4604                          mov     eax, [esi+Form.Length]
  4630                                          bswap   eax
  4607 000021BB 86E0                <1>  xchg al, ah
  4608 000021BD C1C010              <1>  rol eax, 16
  4609 000021C0 86E0                <1>  xchg al, ah
  4631 000021C2 89C1                            mov     ecx, eax
  4632                                  
  4633                                  ; decrease the file length and updates the file pointer
  4634                                  
  4635 000021C4 83E904                          sub     ecx, 4
  4636 000021C7 83C60C                          add     esi, Form.size
  4637                                  
  4638                                  ; IFF/ILBM main parser body loop
  4639                                  
  4640                                  putlbml0:
  4641 000021CA 85C9                            test    ecx, ecx
  4642 000021CC 7E64                            jle     short putlbmd1
  4643                                  
  4644                                  ; get the next chunk ID and length in bytes
  4645                                  
  4646 000021CE 8B1E                            mov     ebx, [esi+Chunk.ID]
  4647 000021D0 8B4604                          mov     eax, [esi+Chunk.Length]
  4648                                          bswap   eax
  4607 000021D3 86E0                <1>  xchg al, ah
  4608 000021D5 C1C010              <1>  rol eax, 16
  4609 000021D8 86E0                <1>  xchg al, ah
  4649 000021DA 93                              xchg    ebx, eax
  4650 000021DB 83C608                          add     esi, Chunk.size
  4651                                  
  4652                                  ; word align the chunk length and decrease the file length counter
  4653                                  
  4654 000021DE 43                              inc     ebx
  4655 000021DF 80E3FE                          and     bl, 0FEh ; ~1
  4656 000021E2 83E908                          sub     ecx, Chunk.size
  4657 000021E5 29D9                            sub     ecx, ebx
  4658                                  
  4659                                  ; check for the BMHD/CMAP/BODY chunk headers
  4660                                  
  4661 000021E7 3D424D4844                      cmp     eax, ID_BMHD
  4662 000021EC 7415                            je      short putlbmf0
  4663 000021EE 3D434D4150                      cmp     eax, ID_CMAP
  4664 000021F3 7440                            je      short putlbmf1
  4665 000021F5 3D424F4459                      cmp     eax, ID_BODY
  4666 000021FA 7454                            je      short putlbmf2
  4667                                  
  4668                                  ; advance to the next IFF/ILBM chunk structure
  4669                                  
  4670                                  putlbmc0:
  4671 000021FC 01DE                            add     esi, ebx
  4672 000021FE EBCA                            jmp     short putlbml0
  4673                                  
  4674                                  putlbmd0:
  4675 00002200 F9                              stc
  4676 00002201 61                              popad
  4677 00002202 C3                              retn
  4678                                  
  4679                                  ; process the BMHD bitmap header chunk
  4680                                  
  4681                                  putlbmf0:
  4682 00002203 807E0804                        cmp     byte [esi+BMHD.Planes], 4
  4683 00002207 75F7                            jne     short putlbmd0
  4684 00002209 807E0A01                        cmp     byte [esi+BMHD.Compression], 1
  4685 0000220D 75F1                            jne     short putlbmd0
  4686 0000220F 807E0B00                        cmp     byte [esi+BMHD.Pad], 0
  4687 00002213 75EB                            jne     short putlbmd0
  4688 00002215 0FB706                          movzx   eax, word [esi+BMHD.Width]
  4689 00002218 86E0                            xchg    al, ah
  4690 0000221A 83C007                          add     eax, 7
  4691 0000221D C1E803                          shr     eax, 3
  4692 00002220 A3[08680000]                    mov     [picture.width], eax
  4693 00002225 0FB74602                        movzx   eax, word [esi+BMHD.Height]
  4694 00002229 86E0                            xchg    al, ah
  4695 0000222B A3[0C680000]                    mov     [picture.height], eax
  4696 00002230 EBCA                            jmp     short putlbmc0
  4697                                  
  4698                                  putlbmd1:
  4699 00002232 F8                              clc
  4700 00002233 61                              popad
  4701 00002234 C3                              retn
  4702                                  
  4703                                  ; process the CMAP colormap chunk
  4704                                  
  4705                                  putlbmf1:
  4706 00002235 66BAC803                        mov     dx, 3C8h
  4707 00002239 30C0                            xor     al, al
  4708                                          ;out	dx, al
  4709 0000223B B401                    	mov	ah, 1 ; outb
  4710 0000223D CD34                    	int	34h
  4711                                          ;inc	dx
  4712                                  	; 27/11/2023
  4713 0000223F 42                      	inc	edx
  4714                                  putlbml1:
  4715 00002240 8A06                            mov     al, [esi]
  4716 00002242 C0E802                          shr     al, 2
  4717                                          ;out	dx, al
  4718                                  	;mov	ah, 1 ; outb
  4719 00002245 CD34                    	int	34h ; IOCTL interrupt (IN/OUT)
  4720 00002247 46                              inc     esi
  4721 00002248 4B                              dec     ebx
  4722 00002249 7FF5                            jg      short putlbml1
  4723 0000224B E97AFFFFFF                      jmp     putlbml0
  4724                                  
  4725                                  ; process the BODY bitmap body chunk
  4726                                  
  4727                                  putlbmf2:
  4728 00002250 60                              pushad
  4729 00002251 BF00000A00                      mov     edi, 0A0000h
  4730                                          ;cld
  4731 00002256 66BACE03                        mov     dx, 3CEh
  4732                                          ;mov	ax, 0FF08h
  4733                                          ;out	dx, ax
  4734 0000225A 66BB08FF                	mov	bx, 0FF08h
  4735 0000225E B403                    	mov	ah, 3 ; outw
  4736 00002260 CD34                    	int	34h ; IOCTL interrupt (IN/OUT)
  4737                                  	;mov	dx, 3C4h
  4738                                  	; 27/11/2023
  4739 00002262 B2C4                    	mov	dl, 0C4h
  4740 00002264 B002                            mov     al, 02h
  4741                                          ;out	dx, al
  4742 00002266 B401                    	mov	ah, 1 ; outb
  4743 00002268 CD34                    	int	34h ; IOCTL interrupt (IN/OUT)
  4744                                  	;inc	dx
  4745                                  	; 27/11/2023
  4746 0000226A 42                      	inc	edx
  4747 0000226B 8B0D[0C680000]                  mov     ecx, [picture.height]
  4748                                  putlbml2:
  4749 00002271 51                              push    ecx
  4750 00002272 B011                            mov     al, 11h
  4751                                  putlbml3:
  4752 00002274 50                              push    eax
  4753 00002275 57                              push    edi
  4754                                          ;out	dx, al
  4755 00002276 B401                    	mov	ah, 1 ; outb
  4756 00002278 CD34                    	int	34h ; IOCTL interrupt (IN/OUT)
  4757 0000227A 8B1D[08680000]                  mov     ebx, [picture.width]
  4758                                  putlbml4:
  4759 00002280 AC                              lodsb
  4760 00002281 84C0                            test    al, al
  4761 00002283 7C0A                            jl      short putlbmf3
  4762 00002285 0FB6C8                          movzx   ecx, al
  4763 00002288 41                              inc     ecx
  4764 00002289 29CB                            sub     ebx, ecx
  4765 0000228B F3A4                            rep     movsb
  4766 0000228D EB0B                            jmp     short putlbmc4
  4767                                  putlbmf3:
  4768 0000228F F6D8                            neg     al
  4769 00002291 0FB6C8                          movzx   ecx, al
  4770 00002294 41                              inc     ecx
  4771 00002295 29CB                            sub     ebx, ecx
  4772 00002297 AC                              lodsb
  4773 00002298 F3AA                            rep     stosb
  4774                                  putlbmc4:
  4775 0000229A 85DB                            test    ebx, ebx
  4776 0000229C 7FE2                            jg      short putlbml4
  4777 0000229E 5F                              pop     edi
  4778 0000229F 58                              pop     eax
  4779 000022A0 00C0                            add     al, al
  4780 000022A2 73D0                            jnc     short putlbml3
  4781 000022A4 83C750                          add     edi, 80
  4782 000022A7 59                              pop     ecx
  4783 000022A8 E2C7                            loop    putlbml2
  4784 000022AA 61                      	popad
  4785 000022AB E94CFFFFFF                      jmp	putlbmc0
  4786                                  
  4787                                  ; EX1.C (Carlos Hasan, 21/06/1994)
  4788                                  ;------------------------------------------------------------------------------
  4789                                  ; loadlbm - load the IFF/ILBM image file ("LOGO.LBM") at memory
  4790                                  ;  ESI = IFF/ILBM image file address
  4791                                  ;------------------------------------------------------------------------------
  4792                                  
  4793                                  ;if ((Logo = loadlbm("LOGO.LBM")) == NULL) {
  4794                                  ;       printf("Error loading the IFF/ILBM logo picture\n");
  4795                                  ;       MODStopModule();
  4796                                  ;       MODFreeModule(Song);
  4797                                  ;       return;
  4798                                  ;   }
  4799                                  ;   setgraphmode();
  4800                                  ;   putlbm(Logo);
  4801                                  ;   while (!kbhit())
  4802                                  ;       drawscopes(Song->NumTracks);
  4803                                  ;   settextmode();
  4804                                  ;   free(Logo);
  4805                                  ;   MODStopModule();
  4806                                  ;   MODFreeModule(Song);
  4807                                  
  4808                                  ;loadlbm:
  4809                                  ;	; ebx = ASCIIZ file name address
  4810                                  ;	; ecx = open mode (0 = open for read)	
  4811                                  ;	sys	_open, LOGO_FILE_NAME, 0 ; open for reading
  4812                                  ;	jc	short loadlbm_retn
  4813                                  ;
  4814                                  ;	mov     [LBM_FileHandle], eax
  4815                                  ;
  4816                                  ;	; get file size by moving file pointer to the end of file
  4817                                  ;	; ebx = file handle/number
  4818                                  ;	; ecx : offset = 0
  4819                                  ;	; edx : switch = 2 (move fp to end of file + offset)
  4820                                  ;	sys	_seek, eax, 0, 2
  4821                                  ;	jc	short loadlbm_cf
  4822                                  ;
  4823                                  ;	mov	[LBM_FileSize], eax
  4824                                  ;
  4825                                  ;	; move file pointer to the beginning of the file
  4826                                  ;	; ecx = 0
  4827                                  ;	; edx = 0
  4828                                  ;	;xor	ecx, ecx
  4829                                  ; 	xor	dl, dl
  4830                                  ;	; ebx = [LBM_FileHandle]
  4831                                  ;	sys	_seek
  4832                                  ;	;jc	short loadlbm_cf
  4833                                  ;
  4834                                  ;	; ebx = File handle
  4835                                  ;	; ecx = Buffer address
  4836                                  ;	; edx = Byte count
  4837                                  ;	;sys	_read, [LBM_FileHandle], LOGO_ADDRESS, [LBM_FileSize]
  4838                                  ;	mov	ecx, LOGO_ADDRESS
  4839                                  ;	mov	edx, [LBM_FileSize]
  4840                                  ;	sys	_read
  4841                                  ;	jc	short loadlbm_cf
  4842                                  ;
  4843                                  ;	cmp	eax, edx  ; read count = file size ?
  4844                                  ;	;jb	short loadlbm_cf		 
  4845                                  ;loadlbm_cf:
  4846                                  ;	pushf
  4847                                  ;	sys	_close, [LBM_FileHandle]	
  4848                                  ;	popf
  4849                                  ;loadlbm_retn:
  4850                                  ;	retn	
  4851                                  ;
  4852                                  ;LOGO_FILE_NAME:
  4853                                  ;	db	"LOGO.LBM", 0
  4854                                  
  4855                                  LOGO_ERROR_MSG:
  4856 000022B0 4572726F72206C6F61-     	db	"Error loading the IFF/ILBM logo picture !", 0Dh, 0Ah, 0 
  4856 000022B9 64696E672074686520-
  4856 000022C2 4946462F494C424D20-
  4856 000022CB 6C6F676F2070696374-
  4856 000022D4 75726520210D0A00   
  4857                                  
  4858                                  align 2
  4859                                  ; 22/10/2017
  4860                                  LOGO_ADDRESS:
  4861                                  ;incbin "LOGO.LBM"	  	 
  4862                                  ; 27/10/2017
  4863 000022DC <bin 4298h>             incbin "TINYPLAY.LBM"
  4864                                  
  4865                                  ;=============================================================================
  4866                                  ;               preinitialized data
  4867                                  ;=============================================================================
  4868                                  	
  4869 00006574 00                      	db	0
  4870                                  	; 23/08/2020
  4871                                  FileHandle:	
  4872 00006575 FFFFFFFF                	dd	-1
  4873 00006579 00                      	db	0
  4874                                  Credits:
  4875                                  msg_usage:
  4876                                  	; 09/12/2023
  4877 0000657A 54696E792057415620-     	db	'Tiny WAV Player for TRDOS 386 by Erdogan Tan',10,13
  4877 00006583 506C6179657220666F-
  4877 0000658C 72205452444F532033-
  4877 00006595 383620627920457264-
  4877 0000659E 6F67616E2054616E0A-
  4877 000065A7 0D                 
  4878 000065A8 666F7220496E74656C-     	db 	'for Intel AC97 (ICH) Audio Controller.',10,13
  4878 000065B1 204143393720284943-
  4878 000065BA 482920417564696F20-
  4878 000065C3 436F6E74726F6C6C65-
  4878 000065CC 722E0A0D           
  4879                                  	;db	'December 2023.',10,13
  4880 000065D0 446563656D62657220-     	db	'December 2024.',10,13
  4880 000065D9 323032342E0A0D     
  4881                                  credits_zero:
  4882 000065E0 0A0D                    	db	10,13
  4883 000065E2 75736167653A207477-     	db	'usage: twavplay filename.wav',10,13,0
  4883 000065EB 6176706C6179206669-
  4883 000065F4 6C656E616D652E7761-
  4883 000065FD 760A0D00           
  4884 00006601 32342F30382F323032-     	db	'24/08/2020',10,13,0
  4884 0000660A 300A0D00           
  4885 0000660E 30392F31322F323032-     	db	'09/12/2023',10,13,0
  4885 00006617 330A0D00           
  4886                                  	;;db	'08/12/2024',10,13,0
  4887                                  	;db	'14/12/2024',10,13,0
  4888 0000661B 32372F31322F323032-     	db	'27/12/2024',10,13,0
  4888 00006624 340A0D00           
  4889                                  
  4890                                  noDevMsg:
  4891                                  	; 09/12/2023
  4892 00006628 4572726F723A20556E-     	db	'Error: Unable to find AC97 audio device!'
  4892 00006631 61626C6520746F2066-
  4892 0000663A 696E64204143393720-
  4892 00006643 617564696F20646576-
  4892 0000664C 69636521           
  4893 00006650 0A0D00                  	db	10,13,0
  4894                                  
  4895                                  noFileErrMsg:
  4896 00006653 4572726F723A206669-     	db	'Error: file not found.',10,13,0
  4896 0000665C 6C65206E6F7420666F-
  4896 00006665 756E642E0A0D00     
  4897                                  
  4898                                  trdos386_err_msg:
  4899 0000666C 5452444F5320333836-     	db	'TRDOS 386 System call error !',10,13,0
  4899 00006675 2053797374656D2063-
  4899 0000667E 616C6C206572726F72-
  4899 00006687 20210A0D00         
  4900                                  
  4901                                  ; 09/12/2023
  4902                                  msg_no_vra:
  4903 0000668C 0A0D                    	db	10,13
  4904 0000668E 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  4904 00006697 70706F72742021204F-
  4904 000066A0 6E6C79203438206B48-
  4904 000066A9 5A2073616D706C6520-
  4904 000066B2 726174652073757070-
  4904 000066BB 6F727465642021     
  4905 000066C2 0A0D00                  	db	10,13,0
  4906                                  
  4907                                  ; 13/11/2016
  4908 000066C5 303132333435363738-     hex_chars:	db "0123456789ABCDEF", 0
  4908 000066CE 3941424344454600   
  4909                                  ;
  4910                                  msgAC97Info:	
  4911 000066D6 0D0A                    		db 0Dh, 0Ah
  4912 000066D8 414339372041756469-     		db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  4912 000066E1 6F20436F6E74726F6C-
  4912 000066EA 6C6572202620436F64-
  4912 000066F3 656320496E666F0D0A 
  4913 000066FC 56656E646F72204944-     		db "Vendor ID: "
  4913 00006705 3A20               
  4914 00006707 303030306820446576-     msgVendorId:	db "0000h Device ID: "
  4914 00006710 6963652049443A20   
  4915 00006718 30303030680D0A          msgDevId:	db "0000h", 0Dh, 0Ah
  4916 0000671F 4275733A20              		db "Bus: "
  4917 00006724 303068204465766963-     msgBusNo	db "00h Device: "
  4917 0000672D 653A20             
  4918 00006730 3030682046756E6374-     msgDevNo	db "00h Function: "
  4918 00006739 696F6E3A20         
  4919 0000673E 303068                  msgFncNo	db "00h"
  4920 00006741 0D0A                    		db 0Dh, 0Ah
  4921                                  ; 09/12/2023
  4922 00006743 4E414D4241523A20        		db "NAMBAR: "
  4923 0000674B 30303030682020          msgNamBar	db "0000h  "
  4924 00006752 4E41424D4241523A20      		db "NABMBAR: "
  4925 0000675B 303030306820204952-     msgNabmBar	db "0000h  IRQ: "
  4925 00006764 513A20             
  4926 00006767 3030                    msgIRQ		dw 3030h
  4927 00006769 0D0A00                  		db 0Dh, 0Ah, 0
  4928                                  
  4929 0000676C 0D0A5741562046696C-     msgWavFileName:	db 0Dh, 0Ah, "WAV File Name: ",0
  4929 00006775 65204E616D653A2000 
  4930 0000677E 0D0A53616D706C6520-     msgSampleRate:	db 0Dh, 0Ah, "Sample Rate: "
  4930 00006787 526174653A20       
  4931 0000678D 303030303020487A2C-     msgHertz:	db "00000 Hz, ", 0 
  4931 00006796 2000               
  4932 00006798 3820626974732C2000      msg8Bits:	db "8 bits, ", 0 
  4933 000067A1 4D6F6E6F0D0A00          msgMono:	db "Mono", 0Dh, 0Ah, 0
  4934 000067A8 313620626974732C20-     msg16Bits:	db "16 bits, ", 0 
  4934 000067B1 00                 
  4935 000067B2 53746572656F            msgStereo:	db "Stereo"
  4936 000067B8 0D0A00                  nextline:	db 0Dh, 0Ah, 0
  4937                                  
  4938                                  ; 09/12/2023
  4939 000067BB 56524120737570706F-     msgVRAheader:	db "VRA support: "
  4939 000067C4 72743A20           
  4940 000067C8 00                      		db 0	
  4941 000067C9 5945530D0A00            msgVRAyes:	db "YES", 0Dh, 0Ah, 0
  4942 000067CF 4E4F200D0A              msgVRAno:	db "NO ", 0Dh, 0Ah
  4943 000067D4 28496E746572706F6C-     		db "(Interpolated sample rate playing method)"
  4943 000067DD 617465642073616D70-
  4943 000067E6 6C6520726174652070-
  4943 000067EF 6C6179696E67206D65-
  4943 000067F8 74686F6429         
  4944 000067FD 0D0A00                  		db 0Dh, 0Ah, 0
  4945                                  
  4946                                  ;=============================================================================
  4947                                  ;		uninitialized data
  4948                                  ;=============================================================================
  4949                                  
  4950                                  ; 23/08/2020
  4951                                  
  4952                                  ; BSS
  4953                                  
  4954                                  bss_start:
  4955                                  
  4956                                  ABSOLUTE bss_start
  4957                                  
  4958                                  alignb 4
  4959                                  
  4960                                  ;------------------------------------------------------------------------------
  4961                                  ; IFF/ILBM DATA
  4962                                  ;------------------------------------------------------------------------------
  4963                                  
  4964 00006800 ????????                LBM_FileHandle:	resd 1
  4965 00006804 ????????                LBM_FileSize:	resd 1
  4966                                  ;
  4967 00006808 ????????                picture.width:	resd 1 		; current picture width and height
  4968 0000680C ????????                picture.height:	resd 1
  4969                                  
  4970                                  ;------------------------------------------------------------------------------
  4971                                  
  4972                                  ;alignb 4
  4973                                  
  4974 00006810 ??                      stmo:		resb 1 ; stereo or mono (1=stereo) 
  4975 00006811 ??                      bps:		resb 1 ; bits per sample (8,16)
  4976 00006812 ????                    sample_rate:	resw 1 ; Sample Frequency (Hz)
  4977                                  
  4978                                  ; 09/12/2023
  4979                                  ; 'playwav6.s' (27/11/2023)
  4980                                  ; .......
  4981                                  ; 25/11/2023
  4982 00006814 ????????                bufferSize:	resd 1
  4983                                  
  4984 00006818 <res 1Ch>               smpRBuff:	resw 14 
  4985                                  
  4986                                  wav_file_name:
  4987 00006834 <res 50h>               		resb 80 ; wave file, path name (<= 80 bytes)
  4988                                  ;alignb 4
  4989 00006884 ????                    		resw 1
  4990                                  
  4991 00006886 ??                      ac97_int_ln_reg: resb 1
  4992 00006887 ??                      fbs_shift:	resb 1 ; 26/11/2023
  4993                                  
  4994 00006888 ????????                dev_vendor:	resd 1
  4995 0000688C ????????                bus_dev_fn:	resd 1
  4996 00006890 ????                    ac97_NamBar:	resw 1
  4997 00006892 ????                    ac97_NabmBar:	resw 1
  4998                                  
  4999 00006894 ??                      flags:		resb 1
  5000                                  ;half_buff:	resb 1
  5001 00006895 ??                      srb:		resb 1
  5002                                  ; 27/12/2024
  5003                                  ; 23/08/2020
  5004                                  ;counter:	resb 1
  5005                                  ; 18/08/2020
  5006 00006896 ??                      volume_level:	resb 1
  5007                                  ; 25/11/2023
  5008 00006897 ??                      VRA:		resb 1	; Variable Rate Audio Support Status
  5009                                  ; 09/12/2023
  5010 00006898 ??                      pan_shift:	resb 1
  5011                                  ; .......
  5012                                  
  5013 00006899 ??????????????          alignb 16
  5014                                  
  5015                                  ; PLAY.ASM
  5016                                  ;Scope:		resw 320
  5017 000068A0 <res 200h>              RowOfs:		resw 256
  5018                                  
  5019                                  ; 23/10/2017
  5020 00006AA0 <res 200h>              NewScope_L:	resw 256
  5021 00006CA0 <res 200h>              NewScope_R:	resw 256
  5022 00006EA0 <res 200h>              OldScope_L:	resw 256
  5023 000070A0 <res 200h>              OldScope_R:	resw 256
  5024                                  
  5025                                  ; 20/10/2017 (modplay7.s, SB16)
  5026                                  ; 19/10/2017 (modplay6.s, AC97)
  5027                                  ;pan_shift:	resb 1
  5028                                  ;volume_level:	resb 1
  5029                                  
  5030                                  ; 27/12/2024
  5031 000072A0 ????????                timerticks:	resd 1
  5032                                  
  5033                                  ; 09/12/2023
  5034 000072A4 ????????                DMA_buffer_size: resd 1	
  5035                                  
  5036 000072A8 <res D58h>              alignb 4096
  5037                                  
  5038                                  ;audio_buffer:	resb BUFFERSIZE ; DMA Buffer Size / 2  (32768)
  5039                                  ; 09/12/2023
  5040 00008000 <res 10000h>            audio_buffer:	resb 65536
  5041                                  
  5042 00018000 <res 8000h>             alignb 65536
  5043                                  
  5044                                  ;DMA_Buffer:	resb 2*BUFFERSIZE  ; 65536 ; 09/10/2017
  5045                                  ; 09/12/2023
  5046 00020000 <res 20000h>            DMA_Buffer:	resb 2*65536
  5047                                   
  5048                                  ; 13/06/2017
  5049                                  ;temp_buffer:	resb BUFFERSIZE
  5050                                  ; 26/11/2023
  5051 00040000 <res 10000h>            temp_buffer:	resb 65536
  5052                                  
  5053                                  EOF:
