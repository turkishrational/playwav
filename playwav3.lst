     1                                  ; ****************************************************************************
     2                                  ; PLAYWAV.ASM - ICH AC97 .wav player for DOS.			   PLAYWAV.COM
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 15/11/2023 (Previous: 12/11/2023)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 17/02/2017
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.11 (2.15)
     9                                  ;	     nasm playwav.asm -l playwav.lst -o PLAYWAV.COM	
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002 
    12                                  ; ****************************************************************************
    13                                  ; Modidified from 'PLAYER.COM' for VIA VT8233 wav player source code by
    14                                  ; (PLAYER.ASM) by Erdogan Tan (07/11/2016 - 08/12/2016)
    15                                  
    16                                  ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    17                                  
    18                                  [BITS 16]
    19                                  
    20                                  [ORG 100h] 
    21                                  
    22                                  	%include 'ac97.inc' ; 17/02/2017
     1                              <1> ; 11/11/2023
     2                              <1> ; 05/11/2023
     3                              <1> ; 03/11/2023
     4                              <1> ; 17/02/2017 (Erdogan Tan, PLAYWAV.ASM)
     5                              <1> ; constant.inc & codec.inc (for ICH AC97 wav player, 'PLAYWAV.COM') 
     6                              <1> 
     7                              <1> ; ----------------------------------------------------------------------------
     8                              <1> ; CONSTANT.INC
     9                              <1> ; ----------------------------------------------------------------------------
    10                              <1> 
    11                              <1> ;constants of stuff that seem hard to remember at times.
    12                              <1> 
    13                              <1> TRUE  EQU 1
    14                              <1> FALSE EQU 0
    15                              <1> 
    16                              <1> ENABLED  EQU 1
    17                              <1> DISABLED EQU 0
    18                              <1> 
    19                              <1> BIT0  EQU 1
    20                              <1> BIT1  EQU 2
    21                              <1> BIT2  EQU 4
    22                              <1> BIT3  EQU 8
    23                              <1> BIT4  EQU 10h
    24                              <1> BIT5  EQU 20h
    25                              <1> BIT6  EQU 40h
    26                              <1> BIT7  EQU 80h
    27                              <1> BIT8  EQU 100h
    28                              <1> BIT9  EQU 200h
    29                              <1> BIT10 EQU 400h
    30                              <1> BIT11 EQU 800h
    31                              <1> BIT12 EQU 1000h
    32                              <1> BIT13 EQU 2000h
    33                              <1> BIT14 EQU 4000h
    34                              <1> BIT15 EQU 8000h
    35                              <1> BIT16 EQU 10000h
    36                              <1> BIT17 EQU 20000h
    37                              <1> BIT18 EQU 40000h
    38                              <1> BIT19 EQU 80000h
    39                              <1> BIT20 EQU 100000h
    40                              <1> BIT21 EQU 200000h
    41                              <1> BIT22 EQU 400000h
    42                              <1> BIT23 EQU 800000h
    43                              <1> BIT24 EQU 1000000h
    44                              <1> BIT25 EQU 2000000h
    45                              <1> BIT26 EQU 4000000h
    46                              <1> BIT27 EQU 8000000h
    47                              <1> BIT28 EQU 10000000h
    48                              <1> BIT29 EQU 20000000h
    49                              <1> BIT30 EQU 40000000h
    50                              <1> BIT31 EQU 80000000h
    51                              <1> 
    52                              <1> ;special characters
    53                              <1> NUL     EQU 0
    54                              <1> NULL    EQU 0
    55                              <1> BELL    EQU 07
    56                              <1> BS      EQU 08
    57                              <1> TAB     EQU 09
    58                              <1> LF      EQU 10
    59                              <1> CR      EQU 13
    60                              <1> ESCAPE  EQU 27           ;ESC is a reserved word....
    61                              <1> 
    62                              <1> 
    63                              <1> ;file stuff
    64                              <1> READONLY  EQU   BIT0
    65                              <1> HIDDEN    EQU   BIT1
    66                              <1> SYSTEM    EQU   BIT2
    67                              <1> VOLUME    EQU   BIT3         ;ignored for file access
    68                              <1> DIRECTORY EQU   BIT4         ;must be 0 for file access
    69                              <1> ARCHIVE   EQU   BIT5
    70                              <1> SHAREABLE EQU   BIT7         ;for novell networks
    71                              <1> OPEN	EQU	2		; open existing file
    72                              <1> CREATE	EQU	1		; create new file
    73                              <1> 
    74                              <1> 
    75                              <1> ; PCI equates
    76                              <1> ; PCI function address (PFA)
    77                              <1> ; bit 31 = 1
    78                              <1> ; bit 23:16 = bus number     (0-255)
    79                              <1> ; bit 15:11 = device number  (0-31)
    80                              <1> ; bit 10:8 = function number (0-7)
    81                              <1> ; bit 7:0 = register number  (0-255)
    82                              <1> 
    83                              <1> IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
    84                              <1> PCI_INDEX_PORT  EQU     0CF8h
    85                              <1> PCI_DATA_PORT   EQU     0CFCh
    86                              <1> PCI32           EQU     BIT31           ; bitflag to signal 32bit access
    87                              <1> PCI16           EQU     BIT30           ; bitflag for 16bit access
    88                              <1> 
    89                              <1> PCI_FN0         EQU     0 << 8
    90                              <1> PCI_FN1         EQU     1 << 8
    91                              <1> PCI_FN2         EQU     2 << 8
    92                              <1> PCI_FN3         EQU     3 << 8
    93                              <1> PCI_FN4         EQU     4 << 8
    94                              <1> PCI_FN5         EQU     5 << 8
    95                              <1> PCI_FN6         EQU     6 << 8
    96                              <1> PCI_FN7         EQU     7 << 8
    97                              <1> 
    98                              <1> PCI_CMD_REG		EQU	04h		; reg 04, command reg
    99                              <1>  IO_ENA			EQU	BIT0		; i/o decode enable
   100                              <1>  MEM_ENA		EQU	BIT1		; memory decode enable
   101                              <1>  BM_ENA                 EQU     BIT2		; bus master enable
   102                              <1> 
   103                              <1> ; ----------------------------------------------------------------------------
   104                              <1> ; CODEC.INC
   105                              <1> ; ----------------------------------------------------------------------------
   106                              <1> 
   107                              <1> ;Codec registers.
   108                              <1> ;
   109                              <1> ;Not all codecs are created equal. Refer to the spec for your specific codec.
   110                              <1> ;
   111                              <1> ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   112                              <1> ;is defined by the OEM.  
   113                              <1> ;
   114                              <1> ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   115                              <1> ;
   116                              <1> 
   117                              <1> ; each codec/mixer register is 16bits
   118                              <1> 
   119                              <1> CODEC_RESET_REG                 equ     00      ; reset codec
   120                              <1> CODEC_MASTER_VOL_REG            equ     02      ; master volume
   121                              <1> CODEC_HP_VOL_REG                equ     04      ; headphone volume
   122                              <1> CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   123                              <1> CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   124                              <1> CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   125                              <1> CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   126                              <1> CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   127                              <1> CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   128                              <1> CODEC_CD_VOL_REG                equ     12h     ; CD volume
   129                              <1> CODEC_VID_VOL_REG               equ     14h     ; video volume
   130                              <1> CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   131                              <1> CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   132                              <1> CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   133                              <1> CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   134                              <1> CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   135                              <1> CODEC_GP_REG                    equ     20h     ; general purpose
   136                              <1> CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   137                              <1> ; 24h is reserved
   138                              <1> CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   139                              <1> CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   140                              <1> CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   141                              <1> CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   142                              <1> CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   143                              <1> CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   144                              <1> CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   145                              <1> CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   146                              <1> 
   147                              <1> ; registers 36-7a are reserved on the ICH
   148                              <1> 
   149                              <1> CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   150                              <1> CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   151                              <1> 
   152                              <1> ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   153                              <1> ; the AC97 link to the codec, which I think is a little weird.  Looks like
   154                              <1> ; the ICH makes it so you don't need a fully functional codec to play audio?
   155                              <1> ;
   156                              <1> ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   157                              <1> ; set of registers, ie 80h-feh
   158                              <1> 
   159                              <1> PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   160                              <1> SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   161                              <1> 
   162                              <1> SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   163                              <1> 
   164                              <1> ; ----------------------------------------------------------------------------
   165                              <1> ; 17/02/2017
   166                              <1> PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   167                              <1> AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   168                              <1> 
   169                              <1> ; ----------------------------------------------------------------------------
   170                              <1> ; ICH2AC97.INC
   171                              <1> ; ----------------------------------------------------------------------------
   172                              <1> 
   173                              <1> ; PCI stuff
   174                              <1> 
   175                              <1> ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   176                              <1> 
   177                              <1> INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   178                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   179                              <1> SIS_VID		equ	1039h
   180                              <1> NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   181                              <1> AMD_VID		equ	1022h
   182                              <1> 
   183                              <1> ICH_DID         equ     2415h           ; ICH device ID
   184                              <1> ICH0_DID        equ     2425h           ; ICH0
   185                              <1> ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   186                              <1>                                         ; they all should be compatible.
   187                              <1> 
   188                              <1> ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   189                              <1> ICH3_DID	equ     2485h           ; ICH3
   190                              <1> ICH4_DID        equ     24C5h           ; ICH4
   191                              <1> ICH5_DID	equ     24D5h           ; ICH5 
   192                              <1> ICH6_DID	equ     266Eh           ; ICH6
   193                              <1> ESB6300_DID	equ     25A6h           ; 6300ESB
   194                              <1> ESB631X_DID	equ     2698h           ; 631XESB
   195                              <1> ICH7_DID	equ	27DEh		; ICH7
   196                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   197                              <1> MX82440_DID	equ	7195h
   198                              <1> SI7012_DID	equ	7012h
   199                              <1> NFORCE_DID	equ	01B1h
   200                              <1> NFORCE2_DID	equ	006Ah
   201                              <1> AMD8111_DID	equ	746Dh
   202                              <1> AMD768_DID	equ	7445h
   203                              <1> ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   204                              <1> CK804_DID	equ	0059h
   205                              <1> MCP04_DID	equ	003Ah
   206                              <1> CK8_DID		equ	008Ah
   207                              <1> NFORCE3_DID	equ	00DAh
   208                              <1> CK8S_DID	equ	00EAh
   209                              <1> 
   210                              <1> NAMBAR_REG      equ     10h             ; native audio mixer BAR
   211                              <1>  NAM_SIZE       equ     256             ; 256 bytes required.
   212                              <1> 
   213                              <1> NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   214                              <1>  NABM_SIZE      equ     64              ; 64 bytes
   215                              <1> 
   216                              <1> ; BUS master registers, accessed via NABMBAR+offset
   217                              <1> 
   218                              <1> ; ICH supports 3 different types of register sets for three types of things
   219                              <1> ; it can do, thus:
   220                              <1> ;
   221                              <1> ; PCM in (for recording) aka PI
   222                              <1> ; PCM out (for playback) aka PO
   223                              <1> ; MIC in (for recording) aka MC
   224                              <1> 
   225                              <1> PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   226                              <1> PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   227                              <1> MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   228                              <1> 
   229                              <1> ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   230                              <1> ; contents of the .WAV file we're going to play. Each entry is 8 bytes long
   231                              <1> ; (more on that later) and can contain 32 entries total, so each BAR is
   232                              <1> ; 256 bytes in length, thus:
   233                              <1> 
   234                              <1> BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   235                              <1> INDEX_MASK              equ     31      ; indexes must be 0-31
   236                              <1> 
   237                              <1> 
   238                              <1> 
   239                              <1> PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   240                              <1> PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   241                              <1> MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   242                              <1> ;8bit read only
   243                              <1> ; each current index value is simply a pointer showing us which buffer
   244                              <1> ; (0-31) the codec is currently processing. Once this counter hits 31, it
   245                              <1> ; wraps back to 0.
   246                              <1> ; this can be handy to know, as once it hits 31, we're almost out of data to
   247                              <1> ; play back or room to record!
   248                              <1> 
   249                              <1> 
   250                              <1> PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   251                              <1> PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   252                              <1> MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   253                              <1> ;8bit read/write
   254                              <1> ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   255                              <1> ; number to stop on after processing. It could be very nasty to play audio
   256                              <1> ; from buffers that aren't filled with the audio we want to play.
   257                              <1> 
   258                              <1> 
   259                              <1> PI_SR_REG               equ     6       ; PCM in Status register
   260                              <1> PO_SR_REG               equ     16h     ; PCM out Status register
   261                              <1> MC_SR_REG               equ     26h     ; MIC in Status register
   262                              <1> ;16bit read/write
   263                              <1> ; status registers.  Bitfields follow:
   264                              <1> 
   265                              <1> FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   266                              <1> 
   267                              <1> BCIS                    equ     BIT3    ; buffer completion interrupt status.
   268                              <1>                                         ; Set whenever the last sample in ANY
   269                              <1>                                         ; buffer is finished.  Bit is only
   270                              <1>                                         ; set when the Interrupt on Complete
   271                              <1>                                         ; (BIT4 of control reg) is set.
   272                              <1> 
   273                              <1> LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   274                              <1>                                         ; the last buffer in the buffer list.
   275                              <1>                                         ; Will fire an interrupt if IOC bit is
   276                              <1>                                         ; set. Probably set after the last
   277                              <1>                                         ; sample in the last buffer is
   278                              <1>                                         ; processed.  W1TC
   279                              <1> 
   280                              <1>                                         ; 
   281                              <1> CELV                    equ     BIT1    ; Current buffer == last valid.
   282                              <1>                                         ; Bit is RO and remains set until LVI is
   283                              <1>                                         ; cleared.  Probably set up the start
   284                              <1>                                         ; of processing for the last buffer.
   285                              <1> 
   286                              <1> 
   287                              <1> DCH                     equ     BIT0    ; DMA controller halted.
   288                              <1>                                         ; set whenever audio stream is stopped
   289                              <1>                                         ; or something else goes wrong.
   290                              <1> 
   291                              <1> 
   292                              <1> PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   293                              <1> PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   294                              <1> MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   295                              <1> ;16bit read only
   296                              <1> ; position in current buffer regs show the number of dwords left to be
   297                              <1> ; processed in the current buffer.
   298                              <1> ; 
   299                              <1> 
   300                              <1> PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   301                              <1> PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   302                              <1> MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   303                              <1> ;8bit, read only
   304                              <1> ; Prefetched index value register.
   305                              <1> ; tells which buffer number (0-31) has be prefetched. I'd imagine this
   306                              <1> ; value follows the current index value fairly closely. (CIV+1)
   307                              <1> ;
   308                              <1> 
   309                              <1> 
   310                              <1> PI_CR_REG               equ     0bh     ; PCM in Control Register
   311                              <1> PO_CR_REG               equ     1bh     ; PCM out Control Register
   312                              <1> MC_CR_REG               equ     2bh     ; MIC in Control Register
   313                              <1> ; 8bit
   314                              <1> ; Control register *MUST* only be accessed as an 8bit value.
   315                              <1> ; Control register. See bitfields below.
   316                              <1> ;
   317                              <1> 
   318                              <1> 
   319                              <1> IOCE                    equ     BIT4    ; interrupt on complete enable.
   320                              <1>                                         ; set this bit if you want an intrtpt
   321                              <1>                                         ; to fire whenever LVBCI is set.
   322                              <1> FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   323                              <1>                                         ; whenever there is a FIFO (over or
   324                              <1>                                         ; under) error.
   325                              <1> LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   326                              <1>                                         ; set if you want an interrupt to fire
   327                              <1>                                         ; whenever the completion of the last
   328                              <1>                                         ; valid buffer.
   329                              <1> RR                      equ     BIT1    ; reset registers.  Nukes all regs
   330                              <1>                                         ; except bits 4:2 of this register.
   331                              <1>                                         ; Only set this bit if BIT 0 is 0
   332                              <1> RPBM                    equ     BIT0    ; Run/Pause
   333                              <1>                                         ; set this bit to start the codec!
   334                              <1> 
   335                              <1> 
   336                              <1> GLOB_CNT_REG            equ     2ch     ; Global control register
   337                              <1> SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   338                              <1>                                         ; interrupt enable.  Not used here.
   339                              <1> PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   340                              <1> ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   341                              <1> ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   342                              <1>                                         ; registers preserved, bit self clears
   343                              <1> ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   344                              <1>                                         ; reset all registers.  Not self clearing
   345                              <1> 
   346                              <1> GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   347                              <1>                                         ; set if you want an interrupt to
   348                              <1>                                         ; fire upon ANY of the bits in the
   349                              <1>                                         ; GPI (general pursose inputs?) not used.
   350                              <1> 
   351                              <1> GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   352                              <1> 
   353                              <1> MD3                     equ     BIT17   ; modem powerdown status (yawn)
   354                              <1> AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   355                              <1> RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   356                              <1> BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   357                              <1> BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   358                              <1> BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   359                              <1> SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   360                              <1> PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   361                              <1> SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   362                              <1> PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   363                              <1>                                         ; software must check these bits before
   364                              <1>                                         ; starting the codec!
   365                              <1> MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   366                              <1> PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   367                              <1> PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   368                              <1> MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   369                              <1> MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   370                              <1> GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   371                              <1>                                         ; BIT0 of slot 12 also reflects this.
   372                              <1> 
   373                              <1> ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
   374                              <1> CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
   375                              <1>                                         ; self clearing
   376                              <1> ;
   377                              <1> ; Buffer Descriptors List
   378                              <1> ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
   379                              <1> ; descriptors, each 8 bytes in length. Bytes 0-3 of a descriptor entry point
   380                              <1> ; to a chunk of memory to either play from or record to. Bytes 4-7 of an
   381                              <1> ; entry describe various control things detailed below.
   382                              <1> ; 
   383                              <1> ; Buffer pointers must always be aligned on a Dword boundry.
   384                              <1> ;
   385                              <1> 
   386                              <1> IOC                     equ     BIT31   ; Fire an interrupt whenever this
   387                              <1>                                         ; buffer is complete.
   388                              <1> 
   389                              <1> BUP                     equ     BIT30   ; Buffer Underrun Policy.
   390                              <1>                                         ; if this buffer is the last buffer
   391                              <1>                                         ; in a playback, fill the remaining
   392                              <1>                                         ; samples with 0 (silence) or not.
   393                              <1>                                         ; It's a good idea to set this to 1
   394                              <1>                                         ; for the last buffer in playback,
   395                              <1>                                         ; otherwise you're likely to get a lot
   396                              <1>                                         ; of noise at the end of the sound.
   397                              <1> 
   398                              <1> ;
   399                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   400                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   401                              <1> ; Luckily for us, that's the same format as .wav files.
   402                              <1> ;
   403                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   404                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   405                              <1> ;
   406                              <1> ; A value of 0 in these bits means play no samples.
   407                              <1> ;
   408                              <1> 
   409                              <1> ; 11/11/2023
   410                              <1> CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
   411                              <1> CODEC_REG_POWERDOWN	equ	26h
    23                                  
    24                                  _STARTUP:
    25                                  
    26                                  ; memory allocation
    27                                  
    28 00000000 E85D01                          call    setFree				; deallocate unused DOS mem
    29                                  
    30                                  	; 17/02/2017
    31                                  	; Clear BSS (uninitialized data) area
    32 00000003 31C0                    	xor	ax, ax ; 0
    33 00000005 B92240                  	mov	cx, (EOF - bss_start)/2
    34 00000008 BF[7A11]                	mov	di, bss_start
    35 0000000B F3AB                    	rep	stosw
    36                                  
    37                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    38                                  
    39 0000000D B81000                          mov     ax, BDL_SIZE / 16
    40 00000010 E85501                          call    memAlloc
    41 00000013 A3[A611]                        mov     [BDL_BUFFER], ax		; segment 
    42                                  
    43                                  ; allocate 2 buffers, 64k each for now.
    44                                  
    45 00000016 B80010                          mov     ax, BUFFERSIZE / 16		; 64k for .WAV file
    46 00000019 E84C01                          call    memAlloc
    47 0000001C A3[A811]                        mov     [WAV_BUFFER1], ax		; segment
    48                                  
    49 0000001F B80010                  	mov	ax, BUFFERSIZE / 16
    50 00000022 E84301                  	call	memAlloc
    51 00000025 A3[AA11]                	mov	[WAV_BUFFER2], ax
    52                                  
    53                                  ; Detect/reset AC97 
    54                                  
    55 00000028 E8B002                          call    pciFindDevice
    56 0000002B 7342                            jnc     short _1
    57                                  
    58                                  ; couldn't find the audio device!
    59                                  
    60 0000002D 0E                      	push	cs
    61 0000002E 1F                      	pop	ds
    62 0000002F BA[3900]                        mov     dx, noDevMsg
    63 00000032 B409                            mov     ah, 9
    64 00000034 CD21                            int     21h
    65 00000036 E91701                          jmp     exit
    66                                  
    67                                  ; 17/02/2017
    68 00000039 4572726F723A20556E-     noDevMsg: db "Error: Unable to find intel ICH based audio device!",CR,LF,"$"
    68 00000042 61626C6520746F2066-
    68 0000004B 696E6420696E74656C-
    68 00000054 204943482062617365-
    68 0000005D 6420617564696F2064-
    68 00000066 6576696365210D0A24 
    69                                  
    70                                  _1:
    71                                  	; eax = BUS/DEV/FN
    72                                  	;	00000000BBBBBBBBDDDDDFFF00000000
    73                                  	; edx = DEV/VENDOR
    74                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
    75                                  
    76 0000006F 66A3[AC11]              	mov	[bus_dev_fn], eax
    77 00000073 668916[B011]            	mov	[dev_vendor], edx
    78                                  
    79                                  	; get ICH base address regs for mixer and bus master
    80                                  
    81 00000078 B010                            mov     al, NAMBAR_REG
    82 0000007A E8D001                          call    pciRegRead16			; read PCI registers 10-11
    83 0000007D 83E2FE                          and     dx, IO_ADDR_MASK 		; mask off BIT0
    84                                  
    85 00000080 8916[A211]                      mov     [NAMBAR], dx			; save audio mixer base addy
    86                                  
    87 00000084 B014                    	mov     al, NABMBAR_REG
    88 00000086 E8C401                          call    pciRegRead16
    89 00000089 83E2FE                          and     dx, IO_ADDR_MASK
    90                                  
    91 0000008C 8916[A411]                      mov     [NABMBAR], dx			; save bus master base addy
    92                                  
    93                                  	; 06/11/2023
    94                                  	;; init controller
    95                                  	;; 17/02/2017
    96                                  	;mov	al, PCI_CMD_REG ; command register (04h)
    97                                  	;call	pciRegRead16 ; pciRegRead8
    98                                  	;
    99                                  	;; eax = BUS/DEV/FN/REG
   100                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   101                                  	;; 	00000000CCCCCCCC
   102                                  	;mov	[stats_cmd], dx
   103                                  	;
   104                                  	; 06/11/2023
   105                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   106                                  	;call	pciRegRead32
   107                                  	;
   108                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   109                                          ;mov	[ac97_io_base], dx
   110                                  
   111 00000090 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   112 00000092 E8B001                  	call	pciRegRead8 ; 17/02/2017
   113                                  
   114 00000095 8816[9911]              	mov     [ac97_int_ln_reg], dl
   115                                  
   116                                  ; 09/11/2023
   117                                  ; 05/11/2023
   118                                  %if 1
   119                                  	; 28/11/2016
   120 00000099 BB0100                  	mov	bx, 1
   121 0000009C 30F6                    	xor	dh, dh 	 ; 17/02/2017
   122                                  	; 10/11/2023
   123                                  	;mov	cx, dx
   124                                  	;shl	bx, cl
   125                                  
   126                                  	; 04/11/2023
   127 0000009E FA                      	cli
   128                                  
   129                                  	;not	bx
   130 0000009F E4A1                    	in	al, 0A1h ; irq 8-15
   131 000000A1 88C4                            mov	ah, al
   132 000000A3 E421                            in	al, 21h  ; irq 0-7 
   133                                  
   134                                  	; 04/11/2023
   135                                  	; save IRQ status
   136 000000A5 A3[9C11]                	mov	[IRQ_status], ax
   137                                  
   138                                  	;and	ax, bx   ; unmask
   139 000000A8 0FB3D0                   	btr	ax, dx	 ; unmask
   140 000000AB E621                    	out	21h, al  ; enable interrupt (if irq <= 7)
   141 000000AD 88E0                    	mov	al, ah
   142 000000AF E6A1                    	out	0A1h, al ; enable interrupt (if irq > 7)
   143                                  	;not	bx
   144                                  
   145                                  	; 04/11/2023
   146                                  	;mov	dx, 4D1h			;8259 ELCR1
   147                                          ;in	al, dx
   148                                  	;mov	ah, al
   149                                  	;mov	dx, 4D0h 
   150                                          ;in	al, dx
   151                                  	;;or	ax, bx        
   152                                  	;bts	ax, cx
   153                                  	;mov	dx, 4D0h
   154                                  	;out	dx, al                          ;set level-triggered mode
   155                                  	;mov	al, ah
   156                                  	;mov	dx, 4D1h
   157                                  	;out	dx, al                          ;set level-triggered mode
   158                                  
   159                                  	; 24/11/2016 - Erdogan Tan
   160                                  	;mov	bx, cx
   161                                  	; 10/11/2023
   162 000000B1 89D3                    	mov	bx, dx
   163 000000B3 8A9F[C50F]              	mov	bl, [bx+irq_int]
   164 000000B7 C1E302                  	shl	bx, 2 ; * 4
   165                                  
   166                                  	; set up interrupt vector
   167                                  	; 30/11/2016
   168 000000BA 06                      	push	es
   169 000000BB 31C0                    	xor	ax, ax
   170 000000BD 8EC0                    	mov	es, ax
   171                                  	; 04/11/2023
   172                                  	; save interrupt vector
   173 000000BF 268B07                  	mov	ax, [es:bx]
   174 000000C2 A3[9E11]                	mov	[IRQ_vector], ax
   175 000000C5 268B4702                	mov	ax, [es:bx+2]
   176 000000C9 A3[A011]                	mov	[IRQ_vector+2], ax
   177                                  
   178 000000CC 26C707[140F]            	mov	word [es:bx], ac97_int_handler
   179 000000D1 8CC8                    	mov	ax, cs
   180 000000D3 26894702                	mov	[es:bx+2], ax
   181 000000D7 07                      	pop	es
   182                                  
   183                                  	; 04/11/2023
   184 000000D8 FB                      	sti
   185                                  
   186                                  %endif
   187 000000D9 E8850C                  	call	write_ac97_dev_info 
   188                                  
   189                                  ; check the command line for a file to play
   190                                  
   191                                          ;push	ds
   192 000000DC E89200                          call    processCmdline			; get the filename
   193                                  
   194                                  ; open the file
   195 000000DF B002                            mov     al, OPEN                        ; open existing file
   196 000000E1 E8AD00                          call    openFile                        ; no error? ok.
   197                                          ;pop	ds
   198 000000E4 7322                            jnc     short _gsr
   199                                  
   200                                  ; file not found!
   201                                  
   202                                          ;push   cs
   203                                          ;pop    ds
   204 000000E6 BA[EF00]                        mov	dx, noFileErrMsg
   205 000000E9 B409                            mov     ah, 9
   206 000000EB CD21                            int     21h
   207 000000ED EB61                            jmp     exit
   208                                  
   209                                  noFileErrMsg:
   210 000000EF 4572726F723A206669-     	db "Error: file not found.",CR,LF,"$"
   210 000000F8 6C65206E6F7420666F-
   210 00000101 756E642E0D0A24     
   211                                  
   212                                  _gsr:
   213 00000108 E8AD00                          call    getSampleRate                   ; read the sample rate
   214                                                                                  ; pass it onto codec.
   215 0000010B 7243                    	jc	short exit ; 19/11/2016 - nothing to do
   216                                  
   217 0000010D A3[B411]                	mov	[sample_rate], ax
   218                                  	
   219                                  	; 19/11/2016
   220 00000110 880E[B611]              	mov	[stmo], cl
   221 00000114 8816[B811]              	mov	[bps], dl
   222                                  	
   223                                  	; 17/02/2017
   224 00000118 C606[BA11]00            	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   225 0000011D FEC9                    	dec	cl
   226 0000011F 7504                    	jnz	short _gsr_1 ; stereo
   227 00000121 FE06[BA11]              	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   228                                  _gsr_1:	
   229 00000125 80FA08                  	cmp	dl, 8 
   230 00000128 7704                    	ja	short _gsr_2 ; 16 bit samples
   231 0000012A FE06[BA11]              	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   232                                  _gsr_2:	
   233 0000012E E8920D                  	call	write_sample_rate
   234                                  
   235                                  	; 05/11/2023
   236                                  _2:
   237 00000131 E80807                  	call	check4keyboardstop  ; flush keyboard buffer
   238 00000134 72FB                    	jc	short _2 	; 07/11/2023
   239                                  
   240                                  	; 09/11/2023
   241                                  	;; 05/11/2023
   242                                  	;mov	eax, [bus_dev_fn]
   243                                  	;mov	al, PCI_CMD_REG
   244                                  	;call	pciRegRead16			; read PCI command register
   245                                  	;; 17/02/2017
   246                                  	;;mov	dx, [stats_cmd]
   247                                          ;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   248                                  	;call	pciRegWrite16 ; pciRegWrite8
   249                                  
   250                                  	;; 06/11/2023
   251                                  	;;mov	eax, [bus_dev_fn]
   252                                  	;;mov	al, PCI_CMD_REG
   253                                  	;;call	pciRegRead8                     ; read PCI command register
   254                                  	;;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   255                                  	;;call	pciRegWrite8
   256                                  
   257                                  ; setup the Codec (actually mixer registers) 
   258 00000136 E8E601                          call    codecConfig                     ; unmute codec, set rates.
   259                                  	; 11/11/2023
   260 00000139 721C                    	jc	short init_err
   261                                  ;
   262                                  ; position file pointer to start in actual wav data
   263                                  ; MUCH improvement should really be done here to check if sample size is
   264                                  ; supported, make sure there are 2 channels, etc.  
   265                                  ;
   266 0000013B B442                            mov     ah, 42h
   267 0000013D B000                            mov     al, 0                           ; from start of file
   268 0000013F 8B1E[9611]                      mov     bx, [filehandle]
   269 00000143 31C9                            xor     cx, cx
   270 00000145 BA2C00                          mov     dx, 44                          ; jump past .wav/riff header
   271 00000148 CD21                            int     21h
   272                                  
   273                                  ; play the .wav file. Most of the good stuff is in here.
   274                                  
   275 0000014A E84203                          call    playWav
   276                                  
   277                                  ; close the .wav file and exit.
   278                                  
   279                                  close_exit:			; 11/11/2023
   280 0000014D E85300                          call    closeFile
   281                                  
   282                                  exit:
   283 00000150 B8004C                          mov     ax, 4c00h
   284 00000153 CD21                    	int 	21h
   285                                  
   286                                  here:
   287 00000155 EBFE                    	jmp	short here
   288                                  
   289                                  	; 11/11/2023
   290                                  init_err:
   291 00000157 BA[1011]                	mov	dx, msg_init_err
   292                                  vra_err: ; 12/11/2023
   293 0000015A B409                            mov	ah, 9
   294 0000015C CD21                            int	21h
   295 0000015E EBED                    	jmp	short close_exit
   296                                  
   297                                  ; MEMALLOC.ASM
   298                                  ;-- SETFREE: Release memory not used  ----------------
   299                                  ;-- Input    : ES = address of PSP
   300                                  ;-- Output   : none
   301                                  ;-- Register : AX, BX, CL and FLAGS are changed 
   302                                  ;-- Info     : Since the stack-segment is always the last segment in an 
   303                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
   304                                  ;              to the end of the program in memory. Through this the
   305                                  ;              length of the program can be calculated 
   306                                  ; call this routine once at the beginning of the program to free up memory
   307                                  ; assigned to it by DOS.
   308                                  
   309                                  setFree:
   310 00000160 BB0010                  	  mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)		
   311                                  
   312 00000163 B44A                              mov	ah, 4ah		; pass new length to DOS
   313 00000165 CD21                              int	21h
   314                                  
   315 00000167 C3                                retn			; back to caller 
   316                                  				; new size (allocated memory) = 64KB
   317                                  
   318                                  memAlloc:
   319                                  ; input: AX = # of paragraphs required
   320                                  ; output: AX = segment of block to use
   321                                  
   322 00000168 53                      	push	bx
   323 00000169 89C3                    	mov	bx, ax
   324 0000016B B448                    	mov	ah, 48h
   325 0000016D CD21                    	int	21h
   326 0000016F 5B                      	pop	bx
   327 00000170 C3                      	retn
   328                                  
   329                                  ; CMDLINE.ASM
   330                                  ; parse the command line
   331                                  ; entry: none
   332                                  ; exit: DS:DX to the 1st supplied item on the command line 
   333                                  
   334                                  processCmdline:
   335 00000171 53                              push    bx
   336 00000172 56                              push    si
   337                                  
   338                                          ;mov    ah, 51h
   339                                          ;int    21h
   340                                          ;mov    ds, bx
   341                                  
   342 00000173 BE8000                          mov     si, 80h
   343 00000176 0FB61C                          movzx   bx, byte [si]
   344 00000179 01DE                            add     si, bx
   345 0000017B 46                              inc     si
   346                                  
   347 0000017C C60400                          mov     byte [si], NULL         ; zero terminate
   348                                  
   349 0000017F BE8100                          mov     si, 81h
   350                                  
   351                                  cmdlineloop:
   352 00000182 AC                              lodsb
   353                                  
   354 00000183 3C00                            cmp     al, NULL                ; found end of line?
   355 00000185 7404                            je      short exitpc
   356 00000187 3C20                            cmp     al, ' '                 ; found a space?
   357 00000189 74F7                            je      short cmdlineloop
   358                                  
   359                                          ; must be the filename here.
   360                                  exitpc:
   361 0000018B 4E                              dec     si                      ; point to start of filename
   362 0000018C 89F2                            mov     dx, si
   363 0000018E 5E                              pop     si
   364 0000018F 5B                              pop     bx
   365 00000190 C3                      	retn
   366                                  
   367                                  ; FILE.ASM
   368                                  ;open or create file
   369                                  ;
   370                                  ;input: ds:dx-->filename (asciiz)
   371                                  ;       al=file Mode (create or open)
   372                                  ;output: none  cs:[filehandle] filled
   373                                  ;
   374                                  openFile:
   375 00000191 50                      	push	ax
   376 00000192 51                      	push	cx
   377 00000193 B43B                    	mov	ah, 3bh			; start with a mode
   378 00000195 00C4                    	add	ah, al			; add in create or open mode
   379 00000197 31C9                    	xor	cx, cx
   380 00000199 CD21                    	int	21h
   381 0000019B 7203                    	jc	short _of1
   382                                  	;mov	[cs:filehandle], ax
   383 0000019D A3[9611]                	mov	[filehandle], ax
   384                                  _of1:
   385 000001A0 59                      	pop	cx
   386 000001A1 58                      	pop	ax
   387 000001A2 C3                      	retn
   388                                  
   389                                  ; close the currently open file
   390                                  ; input: none, uses cs:[filehandle]
   391                                  closeFile:
   392 000001A3 50                      	push	ax
   393 000001A4 53                      	push	bx
   394 000001A5 833E[9611]FF            	cmp	word [filehandle], -1
   395 000001AA 7409                    	jz	short _cf1
   396 000001AC 8B1E[9611]              	mov     bx, [filehandle]  
   397 000001B0 B8003E                  	mov     ax,3e00h
   398 000001B3 CD21                            int     21h              ;close file
   399                                  _cf1:
   400 000001B5 5B                      	pop	bx
   401 000001B6 58                      	pop	ax
   402 000001B7 C3                      	retn
   403                                  
   404                                  getSampleRate:
   405                                  	; 08/12/2016
   406                                  ; reads the sample rate from the .wav file.
   407                                  ; entry: none - assumes file is already open
   408                                  	; 19/11/2016 - Erdogan Tan
   409                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   410                                  ;	cx = number of channels (mono=1, stereo=2)
   411                                  ;	dx = bits per sample (8, 16)
   412                                  
   413 000001B8 53                      	push    bx
   414                                  
   415 000001B9 B442                            mov     ah, 42h
   416 000001BB B000                            mov     al, 0				; from start of file
   417 000001BD 8B1E[9611]                      mov     bx, [filehandle]
   418 000001C1 31C9                            xor     cx, cx
   419 000001C3 BA0800                          mov     dx, 08h				; "WAVE"
   420 000001C6 CD21                            int     21h
   421                                  
   422 000001C8 BA[7A11]                        mov     dx, smpRBuff
   423 000001CB B91C00                          mov     cx, 28				; 28 bytes
   424 000001CE B43F                    	mov	ah, 3fh
   425 000001D0 CD21                            int     21h
   426                                  
   427 000001D2 813E[7A11]5741          	cmp	word [smpRBuff], 'WA'
   428 000001D8 751C                    	jne	short gsr_stc
   429                                  
   430 000001DA 813E[7C11]5645          	cmp	word [smpRBuff+2], 'VE'
   431 000001E0 7514                    	jne	short gsr_stc
   432                                  
   433 000001E2 833E[8611]01            	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   434 000001E7 750D                    	jne	short gsr_stc
   435                                  
   436                                  
   437 000001E9 8B0E[8811]              	mov	cx, [smpRBuff+14]	; return num of channels in CX
   438 000001ED A1[8A11]                        mov     ax, [smpRBuff+16]	; return sample rate in AX
   439 000001F0 8B16[9411]              	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   440                                  gsr_retn:
   441 000001F4 5B                              pop     bx
   442 000001F5 C3                              retn
   443                                  
   444                                  gsr_stc:
   445 000001F6 F9                      	stc
   446 000001F7 EBFB                    	jmp	short gsr_retn
   447                                  
   448                                  ;%include 'ac97.asm' ; 29/11/2016 (AC97 codec configuration)
   449                                  %include 'ac97_vra.asm' ; 13/11/2023 (AC97 codec configuration)
     1                              <1> ; 15/11/2023
     2                              <1> ; 13/11/2023
     3                              <1> ; 12/11/2023
     4                              <1> ; 11/11/2023
     5                              <1> ; 03/11/2023 - 06/11/2023
     6                              <1> ; PCI and AC97 codec functions for wav player
     7                              <1> ; Erdogan Tan (17/02/2017)
     8                              <1> 
     9                              <1> ; ----------------------------------------------------------------------------
    10                              <1> ; PCI.ASM
    11                              <1> ; ----------------------------------------------------------------------------
    12                              <1> 
    13                              <1> ; PCI device register reader/writers.
    14                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    15                              <1> ; 		Last Update: 17/02/2017
    16                              <1> 
    17                              <1> ;===============================================================
    18                              <1> ; 8/16/32bit PCI reader
    19                              <1> ;
    20                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    21                              <1> ;           BIT30 set if 32 bit access requested
    22                              <1> ;           BIT29 set if 16 bit access requested
    23                              <1> ;           otherwise defaults to 8 bit read
    24                              <1> ;
    25                              <1> ; Exit:  DL,DX,EDX register data depending on requested read size
    26                              <1> ;
    27                              <1> ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
    28                              <1> ;	or pciRegRead32, listed below.
    29                              <1> ;
    30                              <1> ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
    31                              <1> ;	 number. Likewise, don't do 16bit reads from non word aligned reg #
    32                              <1> ; 
    33                              <1> pciRegRead:
    34 000001F9 6653                <1> 	push	ebx
    35 000001FB 51                  <1> 	push	cx
    36 000001FC 6689C3              <1>         mov     ebx, eax                        ; save eax, dh
    37 000001FF 88F1                <1>         mov     cl, dh
    38 00000201 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    39 00000207 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
    40 0000020D 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
    41                              <1> 
    42 0000020F BAF80C              <1>         mov     dx, PCI_INDEX_PORT
    43 00000212 66EF                <1>         out     dx, eax                         ; write PCI selector
    44                              <1> 
    45 00000214 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
    46 00000217 88D8                <1>         mov     al, bl
    47 00000219 2403                <1>         and     al, 3                           ; figure out which port to
    48 0000021B 00C2                <1>         add     dl, al                          ; read to
    49                              <1> 
    50 0000021D 66ED                <1> 	in      eax, dx                         ; do 32bit read
    51 0000021F 66F7C300000080      <1>         test    ebx, PCI32
    52 00000226 7403                <1>         jz      short _pregr1
    53                              <1> 
    54 00000228 6689C2              <1>         mov     edx, eax                        ; return 32bits of data
    55                              <1> _pregr1:
    56 0000022B 89C2                <1> 	mov     dx, ax                          ; return 16bits of data
    57 0000022D 66F7C3000000C0      <1>         test    ebx, PCI32+PCI16
    58 00000234 7502                <1>         jnz     short _pregr2
    59 00000236 88CE                <1>         mov     dh, cl                          ; restore dh for 8 bit read
    60                              <1> _pregr2:
    61 00000238 6689D8              <1>         mov     eax, ebx                        ; restore eax
    62 0000023B 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    63 00000241 59                  <1> 	pop	cx
    64 00000242 665B                <1> 	pop	ebx
    65 00000244 C3                  <1> 	retn
    66                              <1> 
    67                              <1> pciRegRead8:
    68 00000245 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
    69 0000024B EBAC                <1>         jmp     short pciRegRead		; call generic PCI access
    70                              <1> 
    71                              <1> pciRegRead16:
    72 0000024D 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit read size
    73 00000253 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
    74 00000259 EB9E                <1>         jmp     short pciRegRead
    75                              <1> 
    76                              <1> pciRegRead32:
    77 0000025B 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit read size
    78 00000261 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
    79 00000267 EB90                <1>         jmp     short pciRegRead
    80                              <1> 
    81                              <1> ;===============================================================
    82                              <1> ; 8/16/32bit PCI writer
    83                              <1> ;
    84                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    85                              <1> ;           BIT31 set if 32 bit access requested
    86                              <1> ;           BIT30 set if 16 bit access requested
    87                              <1> ;           otherwise defaults to 8bit read
    88                              <1> ;        DL/DX/EDX data to write depending on size
    89                              <1> ;
    90                              <1> ;
    91                              <1> ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
    92                              <1> ; 	or pciRegWrite32 as detailed below.
    93                              <1> ;
    94                              <1> ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
    95                              <1> ;	 number. Likewise, don't do 16bit writes from non word aligned reg #
    96                              <1> ;
    97                              <1> pciRegWrite:
    98 00000269 6653                <1> 	push	ebx
    99 0000026B 51                  <1> 	push	cx
   100 0000026C 6689C3              <1>         mov     ebx, eax                        ; save eax, dx
   101 0000026F 89D1                <1>         mov     cx, dx
   102 00000271 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
   103 00000277 6625FFFFFFBF        <1>         and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   104 0000027D 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
   105                              <1> 
   106 0000027F BAF80C              <1>         mov     dx, PCI_INDEX_PORT
   107 00000282 66EF                <1>         out     dx, eax                         ; write PCI selector
   108                              <1> 
   109 00000284 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
   110 00000287 88D8                <1>         mov     al, bl
   111 00000289 2403                <1>         and     al, 3                           ; figure out which port to
   112 0000028B 00C2                <1>         add     dl, al                          ; write to
   113                              <1> 
   114 0000028D 6689D0              <1>         mov     eax, edx                        ; put data into eax
   115 00000290 89C8                <1>         mov     ax, cx
   116                              <1> 
   117 00000292 EE                  <1>         out     dx, al
   118 00000293 66F7C3000000C0      <1>         test    ebx, PCI16+PCI32                ; only 8bit access? bail
   119 0000029A 740C                <1>         jz      short _pregw1
   120                              <1> 
   121 0000029C EF                  <1>         out     dx, ax                          ; write 16 bit value
   122 0000029D 66F7C300000040      <1>         test    ebx, PCI16                      ; 16bit requested?  bail
   123 000002A4 7502                <1>         jnz     short _pregw1
   124                              <1> 
   125 000002A6 66EF                <1>         out     dx, eax                         ; write full 32bit
   126                              <1> _pregw1:
   127 000002A8 6689D8              <1>         mov     eax, ebx                        ; restore eax
   128 000002AB 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
   129 000002B1 89CA                <1>         mov     dx, cx                          ; restore dx
   130 000002B3 59                  <1> 	pop	cx
   131 000002B4 665B                <1> 	pop	ebx
   132 000002B6 C3                  <1> 	ret
   133                              <1> 
   134                              <1> pciRegWrite8:
   135 000002B7 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   136 000002BD EBAA                <1>         jmp     short pciRegWrite		; call generic PCI access
   137                              <1> 
   138                              <1> pciRegWrite16:
   139 000002BF 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   140 000002C5 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
   141 000002CB EB9C                <1>         jmp     short pciRegWrite
   142                              <1> 
   143                              <1> pciRegWrite32:
   144 000002CD 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   145 000002D3 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
   146 000002D9 EB8E                <1>         jmp     short pciRegWrite
   147                              <1> 
   148                              <1> ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   149                              <1> ;===============================================================
   150                              <1> ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   151                              <1> ;
   152                              <1> ;  ENTRY: none
   153                              <1> ;; Entry: EAX=Device+Vendor ID
   154                              <1> ;
   155                              <1> ;  Exit: EAX=PCI address if device found
   156                              <1> ;	 EDX=Device+Vendor ID
   157                              <1> ;        CY clear if found, set if not found. EAX invalid if CY set.
   158                              <1> ;
   159                              <1> ; [old stackless] Destroys: ebx, esi, edi, cl
   160                              <1> ;
   161                              <1> pciFindDevice:
   162                              <1> 	;push	cx
   163                              <1> 	;push	eax ; *
   164                              <1> 	;push	esi
   165                              <1> 	;push	edi
   166                              <1> 
   167                              <1>  	;mov     esi, eax                ; save off vend+device ID
   168                              <1> 
   169                              <1> 	; 17/02/2017
   170 000002DB BE[D50F]            <1> 	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   171 000002DE B91500              <1> 	mov	cx, valid_id_count
   172                              <1> pfd_0:
   173 000002E1 66BF00FFFF7F        <1>        	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   174                              <1> nextPCIdevice:
   175 000002E7 6681C700010000      <1>         add     edi, 100h
   176 000002EE 6681FF00F8FF80      <1>         cmp     edi, 80FFF800h		; scanned all devices?
   177                              <1>         ;stc
   178                              <1>         ;je 	short PCIScanExit       ; not found
   179 000002F5 720D                <1> 	jb	short pfd_1
   180 000002F7 66BF00000080        <1> 	mov     edi, 80000000h
   181 000002FD 83C604              <1> 	add	si, 4 ; scan for next device ID
   182 00000300 E202                <1> 	loop	pfd_1	 
   183 00000302 F9                  <1> 	stc	
   184                              <1> 	;jmp 	short PCIScanExit
   185 00000303 C3                  <1> 	retn
   186                              <1> pfd_1:
   187 00000304 6689F8              <1>         mov     eax, edi                ; read PCI registers
   188 00000307 E851FF              <1>         call    pciRegRead32
   189                              <1>         ;cmp    edx, esi                ; found device?
   190 0000030A 663B14              <1>         cmp	edx, dword [si]
   191 0000030D 75D8                <1> 	jne     short nextPCIdevice
   192                              <1>         ;clc
   193                              <1> PCIScanExit:
   194                              <1> 	;pushf
   195 0000030F 66B800000080        <1> 	mov	eax, BIT31
   196 00000315 66F7D0              <1> 	not	eax
   197 00000318 6621F8              <1> 	and	eax, edi		; return only bus/dev/fn #
   198                              <1> 	;popf
   199                              <1> 
   200                              <1> 	;pop	edi
   201                              <1> 	;pop	esi
   202                              <1> 	;pop	edx ; *
   203                              <1> 	;pop	cx
   204 0000031B C3                  <1> 	retn
   205                              <1> 
   206                              <1> ; ----------------------------------------------------------------------------
   207                              <1> ; CODEC.ASM
   208                              <1> ; ----------------------------------------------------------------------------
   209                              <1> 
   210                              <1> ; codec configuration code. Not much here really.
   211                              <1> ; NASM version: Erdogan Tan (29/11/2016)
   212                              <1> 
   213                              <1> ; enable codec, unmute stuff, set output rate to 44.1
   214                              <1> ; entry: ax = desired sample rate
   215                              <1> 
   216                              <1> ; 11/11/2023
   217                              <1> ; 06/11/2023
   218                              <1> %if 1
   219                              <1> 
   220                              <1> 	; 11/11/2023
   221                              <1> init_ac97_codec_err1:
   222 0000031C F9                  <1> 	stc
   223                              <1> init_ac97_codec_err2:
   224 0000031D C3                  <1> 	retn
   225                              <1> 
   226                              <1> 	; 13/11/2023
   227 0000031E 01                  <1> VRA:	db 1	
   228                              <1> 
   229                              <1> codecConfig:
   230                              <1> 	; 15/11/2023
   231                              <1> 	; 04/11/2023
   232                              <1> 	; 17/02/2017 
   233                              <1> 	; 07/11/2016 (Erdogan Tan)
   234                              <1> 	;PORT_NABM_GLB_CTRL_STAT equ 60h
   235                              <1> 
   236                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   237                              <1>  	; 'AC97_DEF.H'
   238                              <1> 	;AC97_EXTENDED_STATUS equ 002Ah
   239                              <1> 	AC97_EA_SPDIF	equ 0002h
   240                              <1> 	AC97_EA_VRA	equ 0001h
   241                              <1> 	; 04/11/2023
   242                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   243                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   244                              <1> 	ICH_PCM_246_MASK equ 300000h ; 6 channels
   245                              <1> 
   246                              <1> 	; 04/11/2023
   247                              <1> init_ac97_controller:
   248 0000031F 66A1[AC11]          <1> 	mov	eax, [bus_dev_fn]
   249 00000323 B004                <1> 	mov	al, PCI_CMD_REG
   250 00000325 E825FF              <1> 	call	pciRegRead16		; read PCI command register
   251 00000328 80CA05              <1> 	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
   252 0000032B E891FF              <1> 	call	pciRegWrite16
   253                              <1> 
   254 0000032E E85301              <1> 	call	delay_100ms
   255                              <1> 
   256                              <1> init_ac97_codec:
   257                              <1> 	; 11/11/2023
   258                              <1> 	; (TRDOS 386 v2.0.5, 'audio.s')
   259 00000331 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   260 00000334 0316[A411]          <1> 	add	dx, [NABMBAR]
   261 00000338 66ED                <1> 	in	eax, dx
   262                              <1> 	; ?
   263                              <1> 	; 15/11/2023
   264 0000033A B92800              <1> 	mov	cx, 40
   265                              <1> _initc_1:
   266 0000033D BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   267 00000340 0316[A411]          <1> 	add	dx, [NABMBAR]
   268 00000344 66ED                <1> 	in	eax, dx
   269                              <1> 
   270 00000346 6683F8FF            <1> 	cmp	eax, 0FFFFFFFFh ; -1
   271                              <1> 	;je	short init_ac97_codec_err1
   272                              <1> 	; 15/11/2023
   273 0000034A 7508                <1> 	jne	short _initc_3
   274                              <1> _initc_2:
   275 0000034C 49                  <1> 	dec	cx
   276 0000034D 74CD                <1> 	jz	short init_ac97_codec_err1
   277                              <1> 
   278 0000034F E83201              <1> 	call	delay_100ms
   279 00000352 EBE9                <1> 	jmp	short _initc_1
   280                              <1> _initc_3:
   281 00000354 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   282 0000035A 7505                <1> 	jnz	short _ac97_codec_ready
   283                              <1> 
   284 0000035C E8A500              <1> 	call	reset_ac97_codec
   285                              <1> 	; 11/11/2023
   286                              <1> 	;jc	short init_ac97_codec_err2
   287                              <1> 	; 15/11/2023
   288 0000035F 72EB                <1> 	jc	short _initc_2
   289                              <1> 
   290                              <1> _ac97_codec_ready:
   291 00000361 8B16[A211]          <1> 	mov	dx, [NAMBAR]
   292                              <1> 	;add	dx, 0 ; ac_reg_0 ; reset register
   293 00000365 EF                  <1> 	out	dx, ax
   294                              <1> 
   295                              <1> ;	call	delay_100ms
   296                              <1> ;
   297                              <1> ;	xor	eax, eax ; 0
   298                              <1> ;	mov	dx, [NAMBAR]
   299                              <1> ;	add	dx, CODEC_REG_POWERDOWN
   300                              <1> ;	out	dx, ax
   301                              <1> ;
   302                              <1> ;	; wait for 1 second
   303                              <1> ;	mov	ecx, 1000 ; 1000*0.25ms = 1s
   304                              <1> ;_ac97_codec_rloop:
   305                              <1> ;	call	delay1_4ms
   306                              <1> ;	call	delay1_4ms
   307                              <1> ;	call	delay1_4ms
   308                              <1> ;	call	delay1_4ms
   309                              <1> ;	;mov	dx, [NAMBAR]
   310                              <1> ;	;add	dx, CODEC_REG_POWERDOWN
   311                              <1> ;	in	ax, dx	
   312                              <1> ;	and	ax, 0Fh
   313                              <1> ;	cmp	al, 0Fh
   314                              <1> ;	je	short _ac97_codec_init_ok
   315                              <1> ;	loop	_ac97_codec_rloop 
   316                              <1> ;
   317                              <1> ;init_ac97_codec_err1:
   318                              <1> ;	stc
   319                              <1> ;init_ac97_codec_err2:
   320                              <1> ;	retn
   321                              <1> 
   322                              <1> _ac97_codec_init_ok:
   323                              <1>         ; 11/11/2023
   324                              <1> 	;mov	al, 2 ; force set 16-bit 2-channel PCM
   325                              <1> 	;mov	dx, GLOB_CNT_REG ; 2Ch
   326                              <1> 	;add	dx, [NABMBAR]
   327                              <1> 	;out	dx, eax
   328                              <1> 
   329                              <1> 	;;call	delay1_4ms
   330                              <1> 
   331 00000366 E86600              <1> 	call 	reset_ac97_controller
   332                              <1> 
   333                              <1> 	; 11/11/2023
   334 00000369 E8D509              <1> 	call	delay1_4ms
   335                              <1> 
   336                              <1> 	;call 	setup_ac97_codec
   337                              <1> 
   338                              <1> setup_ac97_codec:
   339                              <1> 	; 12/11/2023
   340 0000036C 813E[B411]80BB      <1> 	cmp	word [sample_rate], 48000
   341 00000372 742F                <1> 	je	short skip_rate
   342                              <1> 
   343                              <1> ; 11/11/2023
   344                              <1> ; 05/11/2023
   345                              <1> ;%if 1
   346                              <1> 	AC97_EA_VRA equ BIT0 ; 11/11/2023
   347                              <1> 
   348                              <1> 	; 11/11/2023
   349 00000374 8B16[A211]          <1> 	mov    	dx, [NAMBAR]               	
   350 00000378 83C22A              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
   351 0000037B ED                  <1> 	in     	ax, dx
   352 0000037C 24FD                <1> 	and	al, ~BIT1 ; Clear DRA
   353 0000037E 0C01                <1> 	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
   354 00000380 EF                  <1> 	out	dx, ax			; Enable variable rate audio
   355                              <1> 	
   356 00000381 B90A00              <1> 	mov	cx, 10
   357                              <1> check_vra:
   358 00000384 E8FD00              <1> 	call	delay_100ms
   359                              <1> 
   360                              <1> 	; 11/11/2023
   361 00000387 ED                  <1> 	in	ax, dx
   362 00000388 A801                <1> 	test	al, AC97_EA_VRA ; 1
   363 0000038A 7509                <1> 	jnz	short set_rate
   364                              <1> 
   365                              <1> 	; 11/11/2023
   366 0000038C E2F6                <1> 	loop	check_vra
   367                              <1> 
   368                              <1> 	; 13/11/2023
   369 0000038E C606[1E03]00        <1> 	mov	byte [VRA], 0
   370 00000393 EB0E                <1> 	jmp	short skip_rate	
   371                              <1> 
   372                              <1> 	; 12/11/2023
   373                              <1> 	;pop	ax ; discard return address to the caller
   374                              <1> 	;mov	dx, msg_no_vra
   375                              <1> 	;jmp	vra_err
   376                              <1> 
   377                              <1> set_rate:
   378 00000395 A1[B411]            <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   379                              <1> 
   380 00000398 8B16[A211]          <1> 	mov    	dx, [NAMBAR]               	
   381 0000039C 83C22C              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   382 0000039F EF                  <1> 	out	dx, ax 			; PCM Front/Center Output Sample Rate
   383                              <1> 
   384 000003A0 E8E100              <1> 	call	delay_100ms
   385                              <1> 
   386                              <1> 	; 12/11/2023
   387                              <1> skip_rate:
   388                              <1> 	; 11/11/2023 (temporary)
   389                              <1> 
   390                              <1> 	;mov   	dx, [NAMBAR]               	
   391                              <1> 	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
   392                              <1> 	;out	dx, ax 			; PCM Surround Output Sample Rate
   393                              <1> 
   394                              <1> 	;call	delay_100ms
   395                              <1> 
   396                              <1> 	;mov   	dx, [NAMBAR]               	
   397                              <1> 	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
   398                              <1> 	;out	dx, ax 			; PCM LFE Output Sample Rate
   399                              <1> 
   400                              <1> 	;call	delay_100ms
   401                              <1> 
   402                              <1> 	; 05/11/2023 (temporary)
   403                              <1> 	;mov	dx, [NAMBAR]               	
   404                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   405                              <1> 	;out	dx, ax 			; PCM Input Sample Rate
   406                              <1> 	;
   407                              <1> 	;call	delay_100ms
   408                              <1> 
   409 000003A3 B80202              <1> 	mov	ax, 0202h
   410 000003A6 8B16[A211]          <1>   	mov     dx, [NAMBAR]
   411 000003AA 83C202              <1>   	add     dx, CODEC_MASTER_VOL_REG	;02h 
   412 000003AD EF                  <1> 	out     dx, ax
   413                              <1> 
   414                              <1> 	; 11/11/2023
   415                              <1>         ;call	delay1_4ms
   416                              <1>         ;call	delay1_4ms
   417                              <1>         ;call	delay1_4ms
   418                              <1>         ;call	delay1_4ms
   419                              <1>  	;
   420                              <1>   	;mov	dx, [NAMBAR]
   421                              <1>   	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
   422                              <1>   	;out	dx, ax
   423                              <1> 
   424                              <1> 	; 11/11/2023
   425                              <1>         ;call	delay1_4ms
   426                              <1>         ;call	delay1_4ms
   427                              <1>         ;call	delay1_4ms
   428                              <1>         ;call	delay1_4ms
   429                              <1> 	;
   430                              <1> 	;mov	ax, 02h
   431                              <1>   	;mov	dx, [NAMBAR]
   432                              <1>   	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
   433                              <1>   	;out	dx, ax
   434                              <1> 
   435 000003AE E89009              <1>         call    delay1_4ms
   436 000003B1 E88D09              <1>         call    delay1_4ms
   437 000003B4 E88A09              <1>         call    delay1_4ms
   438 000003B7 E88709              <1>         call    delay1_4ms
   439                              <1> 
   440                              <1> 	;mov	ax, 0202h
   441 000003BA 8B16[A211]          <1>   	mov     dx, [NAMBAR]
   442 000003BE 83C218              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h 
   443 000003C1 EF                  <1>   	out     dx, ax
   444                              <1> 
   445 000003C2 E87C09              <1>         call    delay1_4ms
   446 000003C5 E87909              <1>         call    delay1_4ms
   447 000003C8 E87609              <1>         call    delay1_4ms
   448 000003CB E87309              <1>         call    delay1_4ms
   449                              <1> 
   450                              <1> 	; 11/11/2023
   451                              <1> 	;mov	ax, 8008h ; Mute
   452                              <1>   	;mov	dx, [NAMBAR]
   453                              <1> 	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
   454                              <1> 	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
   455                              <1>   	;out	dx, ax
   456                              <1> 	;
   457                              <1>         ;call	delay1_4ms
   458                              <1>         ;call	delay1_4ms
   459                              <1>         ;call	delay1_4ms
   460                              <1> 	;call	delay1_4ms
   461                              <1> 
   462                              <1> 	;mov	ax, 0808h
   463                              <1> 	;mov	dx, [NAMBAR]
   464                              <1> 	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
   465                              <1> 	;out	dx, ax
   466                              <1> 	;
   467                              <1>         ;call	delay1_4ms
   468                              <1>         ;call	delay1_4ms
   469                              <1>         ;call	delay1_4ms
   470                              <1> 	;call	delay1_4ms
   471                              <1> 
   472                              <1>   	;mov	dx, [NAMBAR]
   473                              <1>         ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
   474                              <1>   	;out	dx, ax
   475                              <1> 	;
   476                              <1>   	;mov	dx, [NAMBAR]
   477                              <1>         ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
   478                              <1>   	;out	dx, ax
   479                              <1> 	;
   480                              <1>         ;call	delay1_4ms
   481                              <1>         ;call	delay1_4ms
   482                              <1>         ;call	delay1_4ms
   483                              <1> 	;call	delay1_4ms
   484                              <1> 
   485                              <1> ;detect_ac97_codec:
   486 000003CE C3                  <1>         retn
   487                              <1> 
   488                              <1> reset_ac97_controller:
   489                              <1> 	; 11/11/2023
   490                              <1> 	; 10/06/2017
   491                              <1> 	; 29/05/2017
   492                              <1> 	; 28/05/2017
   493                              <1> 	; reset AC97 audio controller registers
   494 000003CF 31C0                <1> 	xor     ax, ax
   495 000003D1 BA0B00              <1>         mov	dx, PI_CR_REG
   496 000003D4 0316[A411]          <1> 	add	dx, [NABMBAR]
   497 000003D8 EE                  <1> 	out     dx, al
   498                              <1> 
   499 000003D9 BA1B00              <1>         mov     dx, PO_CR_REG
   500 000003DC 0316[A411]          <1> 	add	dx, [NABMBAR]
   501 000003E0 EE                  <1> 	out     dx, al
   502                              <1> 
   503 000003E1 BA2B00              <1>         mov     dx, MC_CR_REG
   504 000003E4 0316[A411]          <1> 	add	dx, [NABMBAR]
   505 000003E8 EE                  <1> 	out     dx, al
   506                              <1> 
   507 000003E9 B002                <1>         mov     al, RR
   508 000003EB BA0B00              <1>         mov     dx, PI_CR_REG
   509 000003EE 0316[A411]          <1> 	add	dx, [NABMBAR]
   510 000003F2 EE                  <1> 	out     dx, al
   511                              <1> 
   512 000003F3 BA1B00              <1>         mov     dx, PO_CR_REG
   513 000003F6 0316[A411]          <1> 	add	dx, [NABMBAR]
   514 000003FA EE                  <1> 	out     dx, al
   515                              <1> 
   516 000003FB BA2B00              <1>         mov     dx, MC_CR_REG
   517 000003FE 0316[A411]          <1> 	add	dx, [NABMBAR]
   518 00000402 EE                  <1> 	out     dx, al
   519                              <1> 
   520 00000403 C3                  <1> 	retn
   521                              <1> 
   522                              <1> reset_ac97_codec:
   523                              <1> 	; 11/11/2023
   524                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   525 00000404 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   526 00000407 0316[A411]          <1> 	add	dx, [NABMBAR]
   527 0000040B 66ED                <1> 	in	eax, dx
   528                              <1> 
   529                              <1> 	;test	eax, 2
   530                              <1> 	; 06/08/2022
   531 0000040D A802                <1> 	test	al, 2
   532 0000040F 7405                <1> 	jz	short _r_ac97codec_cold	
   533                              <1> 
   534 00000411 E80E00              <1> 	call	warm_ac97codec_reset
   535 00000414 7306                <1> 	jnc	short _r_ac97codec_ok
   536                              <1> _r_ac97codec_cold:
   537 00000416 E83400              <1>         call    cold_ac97codec_reset
   538 00000419 7301                <1>         jnc     short _r_ac97codec_ok
   539                              <1> 	
   540                              <1> 	; 16/04/2017
   541                              <1>         ;xor	eax, eax	; timeout error
   542                              <1>        	;stc
   543 0000041B C3                  <1> 	retn
   544                              <1> 
   545                              <1> _r_ac97codec_ok:
   546 0000041C 6631C0              <1>         xor     eax, eax
   547                              <1>         ;mov	al, VIA_ACLINK_C00_READY ; 1
   548 0000041F FEC0                <1>         inc	al
   549 00000421 C3                  <1> 	retn
   550                              <1> 
   551                              <1> warm_ac97codec_reset:
   552                              <1> 	; 11/11/2023
   553                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   554                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   555 00000422 66B806000000        <1> 	mov	eax, 6
   556 00000428 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   557 0000042B 0316[A411]          <1> 	add	dx, [NABMBAR]
   558 0000042F 66EF                <1> 	out	dx, eax
   559                              <1> 
   560 00000431 B90A00              <1> 	mov	cx, 10	; total 1s
   561                              <1> _warm_ac97c_rst_wait:
   562 00000434 E84D00              <1> 	call	delay_100ms
   563                              <1> 
   564 00000437 BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   565 0000043A 0316[A411]          <1> 	add	dx, [NABMBAR]
   566 0000043E 66ED                <1> 	in	eax, dx
   567                              <1> 
   568 00000440 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   569 00000446 7504                <1> 	jnz	short _warm_ac97c_rst_ok
   570                              <1> 
   571 00000448 49                  <1>         dec     cx
   572 00000449 75E9                <1>         jnz     short _warm_ac97c_rst_wait
   573                              <1> 
   574                              <1> _warm_ac97c_rst_fail:
   575 0000044B F9                  <1>         stc
   576                              <1> _warm_ac97c_rst_ok:
   577 0000044C C3                  <1> 	retn
   578                              <1> 
   579                              <1> cold_ac97codec_reset:
   580                              <1> 	; 11/11/2023
   581                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   582                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   583 0000044D 66B802000000        <1>         mov	eax, 2
   584 00000453 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   585 00000456 0316[A411]          <1> 	add	dx, [NABMBAR]
   586 0000045A 66EF                <1> 	out	dx, eax
   587                              <1> 
   588 0000045C E82500              <1> 	call	delay_100ms 	; wait 100 ms
   589 0000045F E82200              <1> 	call	delay_100ms 	; wait 100 ms
   590 00000462 E81F00              <1> 	call	delay_100ms 	; wait 100 ms
   591 00000465 E81C00              <1> 	call	delay_100ms 	; wait 100 ms
   592                              <1> 
   593 00000468 B91000              <1> 	mov	cx, 16	; total 20*100 ms = 2s
   594                              <1> 
   595                              <1> _cold_ac97c_rst_wait:
   596 0000046B BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   597 0000046E 0316[A411]          <1> 	add	dx, [NABMBAR]
   598 00000472 66ED                <1> 	in	eax, dx
   599                              <1> 
   600 00000474 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   601 0000047A 7507                <1> 	jnz	short _cold_ac97c_rst_ok
   602                              <1> 
   603 0000047C E80500              <1> 	call	delay_100ms
   604                              <1> 
   605 0000047F 49                  <1>         dec     cx
   606 00000480 75E9                <1>         jnz     short _cold_ac97c_rst_wait
   607                              <1> 
   608                              <1> _cold_ac97c_rst_fail:
   609 00000482 F9                  <1>         stc
   610                              <1> _cold_ac97c_rst_ok:
   611 00000483 C3                  <1> 	retn
   612                              <1> 
   613                              <1> delay_100ms:
   614                              <1> 	; 11/11/2023
   615                              <1> 	; 29/05/2017
   616                              <1> 	; 24/03/2017 ('codec.asm')
   617                              <1> 	; wait 100 ms
   618 00000484 51                  <1> 	push	cx
   619 00000485 B99001              <1> 	mov	cx, 400  ; 400*0.25ms
   620                              <1> _delay_x_ms:
   621 00000488 E8B608              <1> 	call	delay1_4ms
   622 0000048B E2FB                <1>         loop	_delay_x_ms
   623 0000048D 59                  <1> 	pop	cx
   624 0000048E C3                  <1> 	retn
   625                              <1> 
   626                              <1> %endif
   627                              <1> 
   628                              <1> ; 11/11/2023
   629                              <1> %if 0
   630                              <1> 
   631                              <1> codecConfig:
   632                              <1> 	; 06/11/2023
   633                              <1> 	; TUNELOOP version (playing without interrupt)
   634                              <1> 	; 04/11/2023
   635                              <1> 	; 17/02/2017 
   636                              <1> 	; 07/11/2016 (Erdogan Tan)
   637                              <1> 
   638                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   639                              <1> 
   640                              <1> 	mov    	dx, [NAMBAR]               	
   641                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   642                              <1> 	out	dx, ax 				; out sample rate
   643                              <1> 		
   644                              <1> 	; 05/11/2023 temp
   645                              <1> 	;mov	dx, [NAMBAR]               	
   646                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   647                              <1> 	;out	dx, ax 
   648                              <1> 
   649                              <1>         call    delay1_4ms
   650                              <1>         call    delay1_4ms
   651                              <1>         call    delay1_4ms
   652                              <1>         call    delay1_4ms
   653                              <1> 
   654                              <1> 	mov	eax, [dev_vendor]
   655                              <1>         cmp	eax, (SI7012_DID<<16)+SIS_VID
   656                              <1>         jne	short cConfig1
   657                              <1> 
   658                              <1> 	; Unmute quirk specifically for the SiS7012
   659                              <1> 
   660                              <1> 	CUSTOM_SIS_7012_REG equ 4Ch ; SiS7012-specific register
   661                              <1> 	
   662                              <1>         mov     dx, [NABMBAR]
   663                              <1>         add     dx, CUSTOM_SIS_7012_REG
   664                              <1>         in      ax, dx
   665                              <1>         or	al, 1
   666                              <1>         out     dx, ax
   667                              <1> 
   668                              <1> cConfig1:
   669                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   670                              <1> 	; initial ac97 volumes (and clear mute flag)
   671                              <1> 		
   672                              <1>   	mov     dx, [NAMBAR]
   673                              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   674                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   675                              <1>   	; 03/11/2023
   676                              <1> 	mov	ax, 0202h
   677                              <1> 	out     dx, ax
   678                              <1> 
   679                              <1>         call    delay1_4ms	; delays because codecs are slow
   680                              <1>         call    delay1_4ms
   681                              <1>         call    delay1_4ms
   682                              <1>         call    delay1_4ms
   683                              <1>  
   684                              <1>   	mov     dx, [NAMBAR]
   685                              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   686                              <1>   	;;xor	ax, ax
   687                              <1> 	;mov	ax, 0202h
   688                              <1>   	out     dx, ax
   689                              <1> 
   690                              <1>         call    delay1_4ms
   691                              <1>         call    delay1_4ms
   692                              <1>         call    delay1_4ms
   693                              <1>         call    delay1_4ms
   694                              <1>  
   695                              <1> 	retn
   696                              <1> 
   697                              <1> %endif
   450                                  ;%include 'ich_wav.asm' ; 17/02/2017 (ICH AC97 wav playing functions)
   451                                  %include 'ich_wav3.asm' ; 13/11/2023 (ICH AC97 wav playing functions)
     1                              <1> ; 15/11/2023
     2                              <1> ; 14/11/2023
     3                              <1> ; 13/11/2023
     4                              <1> ; 03/11/2023 - 11/11/2023
     5                              <1> ; DOS based .WAV player using AC'97 and codec interface.
     6                              <1> ; ---------------------------------------------------------------
     7                              <1> ; NASM version: Erdogan Tan (29/11/2016)
     8                              <1> ; Last Update: 17/02/2017 (by Erdogan Tan)
     9                              <1> 
    10                              <1> ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    11                              <1> ; sample rate conversion version - 13/11/2023 - Erdogan Tan
    12                              <1> 
    13                              <1> ; ICHWAV.ASM
    14                              <1> 
    15                              <1> ; player internal variables and other equates.
    16                              <1> BUFFERSIZE      equ     64 * 1024       ; 64k file buffer size.
    17                              <1> ENDOFFILE       equ     BIT0            ; flag for knowing end of file
    18                              <1> 
    19                              <1> ;===========================================================================
    20                              <1> ; entry: none. File is already open and [filehandle] filled.
    21                              <1> ; exit:  not until the song is finished or the user aborts.
    22                              <1> ;
    23                              <1> playWav:
    24                              <1> 	; 13/11/2023
    25                              <1> 
    26 0000048F 803E[1E03]01        <1> 	cmp	byte [VRA], 1
    27 00000494 720F                <1> 	jb	short chk_sample_rate
    28                              <1> playwav_48_khz:	
    29 00000496 C706[4506][6607]    <1> 	mov	word [loadfromwavfile], loadFromFile
    30                              <1> 	;mov	word [loadsize], 0 ; 65536
    31 0000049C C706[4906]0080      <1> 	mov	word [buffersize], 32768 ; samples
    32 000004A2 E9A801              <1> 	jmp	playWav_vra
    33                              <1> 
    34                              <1> chk_sample_rate:
    35                              <1> 	; set conversion parameters
    36                              <1> 	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
    37 000004A5 A1[B411]            <1> 	mov	ax, [sample_rate]
    38 000004A8 3D80BB              <1> 	cmp	ax, 48000
    39 000004AB 74E9                <1> 	je	short playwav_48_khz
    40                              <1> chk_22khz:
    41 000004AD 3D2256              <1> 	cmp	ax, 22050
    42 000004B0 752F                <1> 	jne	short chk_11khz
    43 000004B2 803E[B811]08        <1> 	cmp	byte [bps], 8
    44 000004B7 760F                <1> 	jna	short chk_22khz_1
    45 000004B9 BB[380D]            <1> 	mov	bx, load_22khz_stereo_16_bit
    46 000004BC 803E[B611]01        <1> 	cmp	byte [stmo], 1 
    47 000004C1 7512                <1> 	jne	short chk_22khz_2
    48 000004C3 BB[380D]            <1> 	mov	bx, load_22khz_mono_16_bit
    49 000004C6 EB0D                <1> 	jmp	short chk_22khz_2
    50                              <1> chk_22khz_1:
    51 000004C8 BB[380D]            <1> 	mov	bx, load_22khz_stereo_8_bit
    52 000004CB 803E[B611]01        <1> 	cmp	byte [stmo], 1 
    53 000004D0 7503                <1> 	jne	short chk_22khz_2
    54 000004D2 BB[380D]            <1> 	mov	bx, load_22khz_mono_8_bit
    55                              <1> chk_22khz_2:
    56 000004D5 B85A1D              <1> 	mov	ax, 7514  ; (442*17)
    57 000004D8 BA2500              <1> 	mov	dx, 37
    58 000004DB B91100              <1> 	mov	cx, 17 
    59 000004DE E93301              <1> 	jmp	set_sizes	
    60                              <1> chk_11khz:
    61 000004E1 3D112B              <1> 	cmp	ax, 11025
    62 000004E4 752F                <1> 	jne	short chk_44khz
    63 000004E6 803E[B811]08        <1> 	cmp	byte [bps], 8
    64 000004EB 760F                <1> 	jna	short chk_11khz_1
    65 000004ED BB[380D]            <1> 	mov	bx, load_11khz_stereo_16_bit
    66 000004F0 803E[B611]01        <1> 	cmp	byte [stmo], 1 
    67 000004F5 7512                <1> 	jne	short chk_11khz_2
    68 000004F7 BB[380D]            <1> 	mov	bx, load_11khz_mono_16_bit
    69 000004FA EB0D                <1> 	jmp	short chk_11khz_2
    70                              <1> chk_11khz_1:
    71 000004FC BB[380D]            <1> 	mov	bx, load_11khz_stereo_8_bit
    72 000004FF 803E[B611]01        <1> 	cmp	byte [stmo], 1 
    73 00000504 7503                <1> 	jne	short chk_11khz_2
    74 00000506 BB[380D]            <1> 	mov	bx, load_11khz_mono_8_bit
    75                              <1> chk_11khz_2:
    76 00000509 B8AD0E              <1> 	mov	ax, 3757  ; (221*17)
    77 0000050C BA4A00              <1> 	mov	dx, 74
    78 0000050F B91100              <1> 	mov	cx, 17
    79 00000512 E9FF00              <1> 	jmp	set_sizes 
    80                              <1> chk_44khz:
    81 00000515 3D44AC              <1> 	cmp	ax, 44100
    82 00000518 752F                <1> 	jne	short chk_16khz
    83 0000051A 803E[B811]08        <1> 	cmp	byte [bps], 8
    84 0000051F 760F                <1> 	jna	short chk_44khz_1
    85 00000521 BB[380D]            <1> 	mov	bx, load_44khz_stereo_16_bit
    86 00000524 803E[B611]01        <1> 	cmp	byte [stmo], 1 
    87 00000529 7512                <1> 	jne	short chk_44khz_2
    88 0000052B BB[380D]            <1> 	mov	bx, load_44khz_mono_16_bit
    89 0000052E EB0D                <1> 	jmp	short chk_44khz_2
    90                              <1> chk_44khz_1:
    91 00000530 BB[380D]            <1> 	mov	bx, load_44khz_stereo_8_bit
    92 00000533 803E[B611]01        <1> 	cmp	byte [stmo], 1 
    93 00000538 7503                <1> 	jne	short chk_44khz_2
    94 0000053A BB[380D]            <1> 	mov	bx, load_44khz_mono_8_bit
    95                              <1> chk_44khz_2:
    96 0000053D B8D93A              <1> 	mov	ax, 15065 ; (655*23)
    97 00000540 BA1900              <1> 	mov	dx, 25
    98 00000543 B91700              <1> 	mov	cx, 23
    99 00000546 E9CB00              <1> 	jmp	set_sizes 
   100                              <1> chk_16khz:
   101 00000549 3D803E              <1> 	cmp	ax, 16000
   102 0000054C 752F                <1> 	jne	short chk_8khz
   103 0000054E 803E[B811]08        <1> 	cmp	byte [bps], 8
   104 00000553 760F                <1> 	jna	short chk_16khz_1
   105 00000555 BB[A10C]            <1> 	mov	bx, load_16khz_stereo_16_bit
   106 00000558 803E[B611]01        <1> 	cmp	byte [stmo], 1 
   107 0000055D 7512                <1> 	jne	short chk_16khz_2
   108 0000055F BB[400C]            <1> 	mov	bx, load_16khz_mono_16_bit
   109 00000562 EB0D                <1> 	jmp	short chk_16khz_2
   110                              <1> chk_16khz_1:
   111 00000564 BB[A90B]            <1> 	mov	bx, load_16khz_stereo_8_bit
   112 00000567 803E[B611]01        <1> 	cmp	byte [stmo], 1 
   113 0000056C 7503                <1> 	jne	short chk_16khz_2
   114 0000056E BB[450B]            <1> 	mov	bx, load_16khz_mono_8_bit
   115                              <1> chk_16khz_2:
   116 00000571 B85515              <1> 	mov	ax, 5461
   117 00000574 BA0300              <1> 	mov	dx, 3
   118 00000577 B90100              <1> 	mov	cx, 1
   119 0000057A E99700              <1> 	jmp	set_sizes 
   120                              <1> chk_8khz:
   121 0000057D 3D401F              <1> 	cmp	ax, 8000
   122 00000580 752E                <1> 	jne	short chk_24khz
   123 00000582 803E[B811]08        <1> 	cmp	byte [bps], 8
   124 00000587 760F                <1> 	jna	short chk_8khz_1
   125 00000589 BB[680A]            <1> 	mov	bx, load_8khz_stereo_16_bit
   126 0000058C 803E[B611]01        <1> 	cmp	byte [stmo], 1 
   127 00000591 7512                <1> 	jne	short chk_8khz_2
   128 00000593 BB[EC09]            <1> 	mov	bx, load_8khz_mono_16_bit
   129 00000596 EB0D                <1> 	jmp	short chk_8khz_2
   130                              <1> chk_8khz_1:
   131 00000598 BB[FC08]            <1> 	mov	bx, load_8khz_stereo_8_bit
   132 0000059B 803E[B611]01        <1> 	cmp	byte [stmo], 1 
   133 000005A0 7503                <1> 	jne	short chk_8khz_2
   134 000005A2 BB[4908]            <1> 	mov	bx, load_8khz_mono_8_bit
   135                              <1> chk_8khz_2:
   136 000005A5 B8AA0A              <1> 	mov	ax, 2730
   137 000005A8 BA0600              <1> 	mov	dx, 6
   138 000005AB B90100              <1> 	mov	cx, 1
   139 000005AE EB64                <1> 	jmp	short set_sizes 
   140                              <1> chk_24khz:
   141 000005B0 3DC05D              <1> 	cmp	ax, 24000
   142 000005B3 752E                <1> 	jne	short chk_32khz
   143 000005B5 803E[B811]08        <1> 	cmp	byte [bps], 8
   144 000005BA 760F                <1> 	jna	short chk_24khz_1
   145 000005BC BB[380D]            <1> 	mov	bx, load_24khz_stereo_16_bit
   146 000005BF 803E[B611]01        <1> 	cmp	byte [stmo], 1 
   147 000005C4 7512                <1> 	jne	short chk_24khz_2
   148 000005C6 BB[380D]            <1> 	mov	bx, load_24khz_mono_16_bit
   149 000005C9 EB0D                <1> 	jmp	short chk_24khz_2
   150                              <1> chk_24khz_1:
   151 000005CB BB[380D]            <1> 	mov	bx, load_24khz_stereo_8_bit
   152 000005CE 803E[B611]01        <1> 	cmp	byte [stmo], 1 
   153 000005D3 7503                <1> 	jne	short chk_24khz_2
   154 000005D5 BB[380D]            <1> 	mov	bx, load_24khz_mono_8_bit
   155                              <1> chk_24khz_2:
   156 000005D8 B80020              <1> 	mov	ax, 8192
   157 000005DB BA0200              <1> 	mov	dx, 2
   158 000005DE B90100              <1> 	mov	cx, 1
   159 000005E1 EB31                <1> 	jmp	short set_sizes 
   160                              <1> chk_32khz:
   161 000005E3 3D007D              <1> 	cmp	ax, 32000
   162 000005E6 7556                <1> 	jne	short vra_needed
   163 000005E8 803E[B811]08        <1> 	cmp	byte [bps], 8
   164 000005ED 760F                <1> 	jna	short chk_32khz_1
   165 000005EF BB[380D]            <1> 	mov	bx, load_32khz_stereo_16_bit
   166 000005F2 803E[B611]01        <1> 	cmp	byte [stmo], 1 
   167 000005F7 750F                <1> 	jne	short chk_32khz_2
   168 000005F9 BB[380D]            <1> 	mov	bx, load_32khz_mono_16_bit
   169 000005FC EB0A                <1> 	jmp	short chk_32khz_2
   170                              <1> chk_32khz_1:
   171 000005FE BB[380D]            <1> 	mov	bx, load_32khz_stereo_8_bit
   172 00000601 803E[B611]01        <1> 	cmp	byte [stmo], 1 
   173 00000606 7500                <1> 	jne	short chk_32khz_2
   174                              <1> chk_32khz_2:
   175 00000608 BB[380D]            <1> 	mov	bx, load_32khz_mono_8_bit
   176 0000060B B8AA2A              <1> 	mov	ax, 10922
   177 0000060E BA0300              <1> 	mov	dx, 3
   178 00000611 B90200              <1> 	mov	cx, 2
   179                              <1> 	;jmp	short set_sizes 
   180                              <1> set_sizes:
   181 00000614 803E[B611]01        <1> 	cmp	byte [stmo], 1
   182 00000619 7402                <1> 	je	short ss_1
   183 0000061B D1E0                <1> 	shl	ax, 1
   184                              <1> ss_1:
   185 0000061D 803E[B811]08        <1> 	cmp	byte [bps], 8
   186 00000622 7602                <1> 	jna	short ss_2
   187                              <1> 	; 16 bit samples
   188 00000624 D1E0                <1> 	shl	ax, 1
   189                              <1> ss_2:
   190 00000626 A3[4706]            <1> 	mov	[loadsize], ax
   191 00000629 F7E2                <1> 	mul	dx
   192                              <1> 	;cmp	cx, 1
   193                              <1> 	;je	short ss_3
   194                              <1> ;ss_3:
   195 0000062B F7F1                <1> 	div	cx
   196 0000062D 8A0E[BA11]          <1> 	mov	cl, [fbs_shift]
   197 00000631 D3E0                <1> 	shl	ax, cl
   198 00000633 D1E8                <1> 	shr	ax, 1	; buffer size is 16 bit sample count
   199 00000635 A3[4906]            <1> 	mov	[buffersize], ax 
   200 00000638 891E[4506]          <1> 	mov	[loadfromwavfile], bx
   201 0000063C EB0F                <1> 	jmp	short playWav_vra
   202                              <1> 
   203                              <1> vra_needed:
   204                              <1> 	; 13/11/2023
   205 0000063E 58                  <1> 	pop	ax ; discard return address to the caller
   206 0000063F BA[4111]            <1> 	mov	dx, msg_no_vra
   207 00000642 E915FB              <1> 	jmp	vra_err
   208                              <1> 
   209                              <1> 	; 13/11/2023
   210                              <1> loadfromwavfile:
   211 00000645 [6607]              <1> 	dw	loadFromFile
   212                              <1> loadsize:	; read from wav file
   213 00000647 0000                <1> 	dw	0
   214                              <1> buffersize:	; write to DMA buffer
   215 00000649 00800000            <1> 	dd	32768 ; 16 bit samples (not bytes)
   216                              <1> 
   217                              <1> playWav_vra:
   218                              <1> 	; 07/11/2023
   219                              <1> 	; clear buffer 2
   220                              <1>         ;push	es
   221                              <1> 	;mov	ax, [WAV_BUFFER2]
   222                              <1> 	;mov	es, ax
   223                              <1> 	;sub	ax, ax
   224                              <1> 	;mov	di, ax ; 17/02/2017
   225                              <1> 	;mov	cx, (BUFFERSIZE/2)
   226                              <1> 	;rep	stosw
   227                              <1> 	;pop	es	     
   228                              <1> 	
   229                              <1> 	; load 64k into buffer 1
   230 0000064D A1[A811]            <1>         mov     ax, [WAV_BUFFER1]
   231                              <1>         ;call	loadFromFile
   232                              <1> 	; 13/11/2023
   233 00000650 FF16[4506]          <1> 	call	word [loadfromwavfile]
   234                              <1> 
   235                              <1> 	; and 64k into buffer 2
   236 00000654 A1[AA11]            <1> 	mov     ax, [WAV_BUFFER2]
   237                              <1>        	;call	loadFromFile
   238                              <1> 	; 13/11/2023
   239 00000657 FF16[4506]          <1> 	call	word [loadfromwavfile]
   240                              <1> 
   241                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
   242                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
   243                              <1> ; reset.
   244                              <1> 
   245                              <1> 	; 11/11/2023
   246                              <1>         ;mov	dx, [NABMBAR]
   247                              <1>         ;add	dx, PO_CR_REG		; set pointer to Ctrl reg
   248                              <1>         ;mov	al, RR			; set reset
   249                              <1> 	;out	dx, al			; self clearing bit
   250                              <1> 
   251                              <1> ; write last valid index to 31 to start with.
   252                              <1> ; The Last Valid Index register tells the DMA engine when to stop playing.
   253                              <1> ; 
   254                              <1> ; As we progress through the song we change the last valid index to always be
   255                              <1> ; something other than the index we're currently playing.  
   256                              <1> ;
   257                              <1> 	; 08/11/2023
   258                              <1> 	;; 07/11/2023
   259                              <1> 	;mov	al, 1
   260                              <1>         ;;mov	al, 31
   261                              <1> 	;call	setLastValidIndex
   262                              <1> 
   263                              <1> ; create Buffer Descriptor List
   264                              <1> ;
   265                              <1> ; A buffer descriptor list is a list of pointers and control bits that the
   266                              <1> ; DMA engine uses to know where to get the .wav data and how to play it.
   267                              <1> ;
   268                              <1> ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
   269                              <1> ; playing, I refresh the other one with good data.
   270                              <1> ;
   271                              <1> ;
   272                              <1> ; For the control bits, you can specify that the DMA engine fire an interrupt
   273                              <1> ; after a buffer has been processed, but I poll the current index register
   274                              <1> ; to know when it's safe to update the other buffer.
   275                              <1> ;
   276                              <1> ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
   277                              <1> ; if it ever runs out of data to play. Good for safety.
   278                              <1> ;
   279 0000065B 06                  <1>         push    es
   280 0000065C A1[A611]            <1>         mov     ax, [BDL_BUFFER]		; get segment # for BDL
   281 0000065F 8EC0                <1>         mov     es, ax
   282                              <1> 
   283 00000661 B91000              <1>         mov     cx, 32 / 2                      ; make 32 entries in BDL
   284 00000664 31FF                <1>         xor     di, di                          
   285                              <1> _0:
   286                              <1> 
   287                              <1> ; set buffer descriptor 0 to start of data file in memory
   288 00000666 660FB706[A811]      <1>         movzx   eax, word [WAV_BUFFER1]
   289 0000066C 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   290 00000670 66AB                <1>         stosd                                   ; store pointer to wavbuffer1
   291                              <1> 
   292                              <1> ;
   293                              <1> ; set length to 32k samples. 1 sample is 16bits or 2bytes.
   294                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
   295                              <1> ; 
   296                              <1> 
   297                              <1> ; 17/02/2017 (Erdogan Tan)
   298                              <1> ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC97
   299                              <1> ; Programmers Reference Manual
   300                              <1> 
   301                              <1> ; 2.2.1 Buffer Descriptor List  (on Page 13)
   302                              <1> 	;
   303                              <1> 	;  Generic Form of Buffer Descriptor
   304                              <1> 	;  ---------------------------------
   305                              <1> 	;  63   62    61-48    47-32   31-0
   306                              <1> 	;  ---  ---  --------  ------- -----
   307                              <1> 	;  IOC  BUP -reserved- Buffer  Buffer
   308                              <1> 	;		      Length   Pointer
   309                              <1> 	;		      [15:0]   [31:0]
   310                              <1> 	;
   311                              <1> 	;  IOC:	Interrupt On Completion. 
   312                              <1> 	;	1 = Enabled. 
   313                              <1> 	;	    When this is set, it means that the controller should
   314                              <1> 	;	    issue an interrupt upon completion of this buffer.
   315                              <1> 	;	    It should also set the IOC bit in the status register
   316                              <1> 	;	0 = Disabled	
   317                              <1> 	;
   318                              <1> 	;  BUP: Buffer Underrun Policy.
   319                              <1> 	;       0 = When this buffer is complete,
   320                              <1> 	;	    if the next buffer is not yet ready 
   321                              <1> 	;	    (i.e., the last valid buffer has been processed),
   322                              <1> 	;	    then continue to transmit the last valid sample.
   323                              <1> 	;	1 = When this buffer is complete,
   324                              <1> 	;     	    if this is the last valid buffer, transmit zeros after
   325                              <1> 	;	    this buffer has been processed completely.
   326                              <1> 	;	    This bit typically is set only if this is the last 
   327                              <1> 	;	    buffer in the current stream.
   328                              <1> 	;
   329                              <1> 	; [31:0]: Buffer pointer. This field points to the location of
   330                              <1> 	;	  the data buffer. Since samples can be as wide as one
   331                              <1> 	;	  word, the buffer must be aligned with word boundaries,
   332                              <1> 	;	  to prevent samples from straddling DWord boundaries.
   333                              <1> 	;
   334                              <1> 	; [15:0]: Buffer Length: This is the length of the data buffer,
   335                              <1> 	;	  in number of samples. The controller uses this data
   336                              <1> 	;	  to determine the length of the buffer, in bytes.
   337                              <1> 	;	  "0" indicates no sample to process.
   338                              <1> 
   339                              <1> ; ICH2AC97.INC
   340                              <1> 
   341                              <1> ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
   342                              <1> 				; buffer is complete.
   343                              <1> 
   344                              <1> ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
   345                              <1> 				; if this buffer is the last buffer
   346                              <1> 				; in a playback, fill the remaining
   347                              <1> 				; samples with 0 (silence) or not.
   348                              <1> 				; It's a good idea to set this to 1
   349                              <1> 				; for the last buffer in playback,
   350                              <1> 				; otherwise you're likely to get a lot
   351                              <1> 				; of noise at the end of the sound.
   352                              <1> ;
   353                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   354                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   355                              <1> ; Luckily for us, that's the same format as .wav files.
   356                              <1> ;
   357                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   358                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   359                              <1> ;
   360                              <1> ; A value of 0 in these bits means play no samples.
   361                              <1> ;
   362                              <1> 
   363                              <1> ; ICHWAV.ASM
   364                              <1> 
   365                              <1> 	;mov	eax, BUFFERSIZE / 2 ; size of half buffer (32K)
   366                              <1> 	; 13/11/2023
   367 00000672 66A1[4906]          <1> 	mov	eax, [buffersize]
   368                              <1> 
   369                              <1> 	; 09/11/2023
   370 00000676 660D000000C0        <1> 	or	eax, IOC + BUP
   371                              <1> 	; 06/11/2023
   372                              <1> 	;or	eax, BUP
   373 0000067C 66AB                <1> 	stosd
   374                              <1> 
   375                              <1> ; 2nd buffer:
   376                              <1> 
   377 0000067E 660FB706[AA11]      <1>         movzx   eax, word [WAV_BUFFER2]
   378 00000684 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   379 00000688 66AB                <1>         stosd                                   ; store pointer to wavbuffer2
   380                              <1> 
   381                              <1> ; set length to 64k (32k of two 16 bit samples)
   382                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
   383                              <1> ; 
   384                              <1> 	;mov	eax, BUFFERSIZE / 2
   385                              <1> 	; 13/11/2023
   386 0000068A 66A1[4906]          <1> 	mov	eax, [buffersize]
   387                              <1> 
   388                              <1> 	; 09/11/2023
   389 0000068E 660D000000C0        <1> 	or	eax, IOC + BUP
   390                              <1> 	; 06/11/2023
   391                              <1> 	;or	eax, BUP
   392 00000694 66AB                <1> 	stosd
   393                              <1> 
   394 00000696 E2CE                <1>         loop    _0
   395 00000698 07                  <1>         pop     es
   396                              <1> 
   397                              <1> ;
   398                              <1> ; tell the DMA engine where to find our list of Buffer Descriptors.
   399                              <1> ; this 32bit value is a flat mode memory offset (ie no segment:offset)
   400                              <1> ;
   401                              <1> ; write NABMBAR+10h with offset of buffer descriptor list
   402                              <1> ;
   403 00000699 660FB706[A611]      <1>         movzx   eax, word [BDL_BUFFER]
   404 0000069F 66C1E004            <1> 	shl     eax, 4                          ; convert seg:off to 0:off
   405 000006A3 8B16[A411]          <1>         mov     dx, [NABMBAR]
   406 000006A7 83C210              <1>         add     dx, PO_BDBAR_REG                ; set pointer to BDL
   407 000006AA 66EF                <1>         out     dx, eax                         ; write to AC97 controller
   408                              <1> 
   409                              <1> ;
   410                              <1> ; All set. Let's play some music.
   411                              <1> ;
   412                              <1> 
   413                              <1> 	; 10/11/2023
   414                              <1> 	; 08/11/2023
   415                              <1> 	; 07/11/2023
   416                              <1> 	; 08/12/2016
   417                              <1> 	; 07/10/2016
   418                              <1> 	;mov	al, 1
   419 000006AC B01F                <1> 	mov	al, 31
   420 000006AE A2[BC11]            <1> 	mov	[LVI], al ; 10/11/2023
   421 000006B1 E87F01              <1> 	call	setLastValidIndex
   422                              <1> 
   423                              <1> 	; 06/11/2023 (not neccessary)
   424                              <1> 	;; 05/11/2023
   425                              <1> 	;; reset current index
   426                              <1> 	;mov	al, 0
   427                              <1> 	;call	setCurrentIndex
   428                              <1> 
   429                              <1> 	; 06/11/2023
   430                              <1> 	;mov	byte [tLoop], 1 ; 30/11/2016
   431                              <1> 
   432                              <1> 	; 17/02/2017
   433 000006B4 8B16[A411]          <1>         mov     dx, [NABMBAR]
   434 000006B8 83C21B              <1>         add     dx, PO_CR_REG                   ; PCM out Control Register
   435                              <1>         ; 09/11/2023
   436 000006BB B011                <1> 	mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   437                              <1> 	;			; (LVBI interrupt will not be enabled)
   438                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   439                              <1> 	;mov	al, RPBM
   440 000006BD EE                  <1> 	out     dx, al                          ; Start bus master operation.
   441                              <1> 
   442                              <1> 	; 09/11/2023
   443 000006BE C606[BB11]3F        <1> 	mov	byte [b_indicator], '?'	
   444                              <1> 
   445                              <1> 	; 06/11/2023
   446                              <1> 	;call	delay1_4ms
   447                              <1> 	;call	delay1_4ms
   448                              <1> 	;call	delay1_4ms
   449                              <1> 	;call	delay1_4ms
   450                              <1> 
   451                              <1> 	; 10/11/2023
   452                              <1> 	;mov	byte [tloop], 1
   453                              <1> 
   454                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   455                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   456                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   457                              <1> 
   458                              <1> ; 09/11/2023   
   459                              <1> ; 06/11/2023
   460                              <1> %if 1
   461                              <1> 	; 08/12/2016
   462                              <1> 	; 28/11/2016
   463                              <1> p_loop:
   464 000006C3 E87601              <1> 	call    check4keyboardstop ; keyboard halt?
   465 000006C6 732A                <1>         jnc	short r_loop 	   ; no ; 09/11/2023
   466                              <1> 
   467                              <1> 	; 09/11/2023
   468                              <1> 	;or	byte [flags], ENDOFFILE
   469                              <1> 	;mov	byte [b_indicator], '0'
   470                              <1> q_loop:
   471                              <1> 	;mov	al, '0'
   472 000006C8 E88D00              <1> 	call	tL0
   473                              <1> 
   474                              <1> 	; 04/11/2023
   475                              <1> 	; finished with song, stop everything
   476 000006CB E89108              <1> 	call	ac97_stop
   477                              <1> 
   478                              <1> 	; 11/11/2023
   479                              <1> irq_restore:	
   480                              <1> 	; restore previous interrupt vector and interrupt_status
   481 000006CE FA                  <1> 	cli
   482 000006CF E4A1                <1> 	in	al, 0A1h ; irq 8-15
   483 000006D1 A0[9D11]            <1> 	mov	al, [IRQ_status+1]
   484 000006D4 E6A1                <1> 	out	0A1h, al 
   485 000006D6 E421                <1> 	in	al, 021h ; irq 0-7
   486 000006D8 A0[9C11]            <1> 	mov	al, [IRQ_status]
   487 000006DB E621                <1> 	out	21h, al 
   488                              <1> 	; ...
   489 000006DD 06                  <1> 	push	es
   490 000006DE 31C0                <1> 	xor	ax, ax
   491 000006E0 8EC0                <1> 	mov	es, ax
   492 000006E2 A1[9E11]            <1> 	mov	ax, [IRQ_vector]
   493 000006E5 268907              <1> 	mov	[es:bx], ax
   494 000006E8 A1[A011]            <1> 	mov	ax, [IRQ_vector+2]
   495 000006EB 26894702            <1> 	mov	[es:bx+2], ax
   496 000006EF 07                  <1> 	pop	es
   497 000006F0 FB                  <1> 	sti
   498 000006F1 C3                  <1> 	retn
   499                              <1> 
   500                              <1> r_loop:
   501                              <1> 	; 10/11/2023
   502                              <1> 	;nop
   503                              <1> 	;nop
   504                              <1> 	;nop
   505                              <1> 
   506                              <1> 	; 11/11/2023	
   507 000006F2 B030                <1> 	mov	al, '0'
   508 000006F4 803E[9B11]00        <1> 	cmp	byte [tloop], 0
   509 000006F9 74C8                <1> 	je	short p_loop
   510 000006FB 7CCB                <1> 	jl	short q_loop
   511                              <1> 
   512 000006FD FE0E[9B11]          <1> 	dec	byte [tloop] ; 0
   513                              <1> 
   514 00000701 803E[BB11]31        <1> 	cmp	byte [b_indicator], '1'
   515 00000706 7515                <1> 	jne	short s_loop
   516                              <1> 
   517                              <1> 	; load buffer 1
   518 00000708 A1[A811]            <1> 	mov	ax, [WAV_BUFFER1]
   519                              <1> u_loop:
   520                              <1> 	;call	loadFromFile
   521                              <1> 	; 13/11/2023
   522 0000070B FF16[4506]          <1> 	call	[loadfromwavfile]
   523 0000070F 7304                <1> 	jnc	short v_loop
   524 00000711 B030                <1> 	mov	al, '0'
   525 00000713 EBB3                <1> 	jmp	short q_loop
   526                              <1> v_loop:
   527                              <1> 	; 09/11/2023 - Erdogan Tan
   528                              <1> 	; (print buffer number on top left of the screen)
   529 00000715 A0[BB11]            <1> 	mov	al, [b_indicator]
   530 00000718 E83D00              <1> 	call	tL0
   531 0000071B EBA6                <1> 	jmp	short p_loop
   532                              <1> s_loop:
   533                              <1> 	; load buffer 2
   534 0000071D A1[AA11]            <1> 	mov	ax, [WAV_BUFFER2]
   535 00000720 EBE9                <1> 	jmp	short u_loop
   536                              <1> 
   537                              <1> %endif
   538                              <1> 
   539                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   540                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   541                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   542                              <1> 
   543                              <1> ; 11/11/2023
   544                              <1> ; 10/11/2023
   545                              <1> ; 09/11/2023
   546                              <1> ; 08/11/2023
   547                              <1> ; 07/11/2023
   548                              <1> %if 1
   549                              <1> 
   550                              <1> tuneLoop:
   551                              <1> 	; 11/11/2023
   552                              <1> 	; 10/11/2023
   553                              <1> 	; 09/11/2023
   554                              <1> 	; 08/11/2023
   555                              <1> 	; 06/11/2023
   556                              <1> 	;mov	al, '1'
   557                              <1> 	;call	tL0
   558                              <1> tL1:
   559                              <1> 	; 10/11/2023
   560                              <1> 	;mov	byte [tloop], 1
   561                              <1> 
   562                              <1> 	; 11/11/2023
   563                              <1> 	;call    updateLVI	; set LVI != CIV
   564                              <1> 	;jz	short tL4	
   565                              <1> 
   566                              <1> 	; 11/11/2023
   567 00000722 C606[9B11]01        <1> 	mov	byte [tloop], 1
   568                              <1> 
   569 00000727 E80001              <1> 	call    getCurrentIndex
   570                              <1> 
   571                              <1> 	; 10/11/2023
   572 0000072A 3A06[BC11]          <1> 	cmp	al, [LVI]
   573 0000072E 7511                <1> 	jne	short tL2
   574                              <1> 
   575 00000730 F606[9811]01        <1> 	test	byte [flags], ENDOFFILE
   576                              <1> 	;jnz	short tL2
   577 00000735 751A                <1> 	jnz	short tL4
   578                              <1> 
   579 00000737 48                  <1> 	dec	ax
   580 00000738 241F                <1> 	and	al, 1Fh 
   581 0000073A E8F600              <1> 	call	setLastValidIndex	
   582 0000073D 8606[BC11]          <1> 	xchg	al, [LVI]
   583                              <1> 
   584                              <1> tL2:
   585 00000741 A801                <1> 	test	al, BIT0
   586 00000743 7406                <1> 	jz	short tL3
   587                              <1> 
   588 00000745 C606[BB11]31        <1> 	mov	byte [b_indicator], '1'
   589 0000074A C3                  <1> 	retn
   590                              <1> tL3:	
   591 0000074B C606[BB11]32        <1> 	mov	byte [b_indicator], '2'
   592 00000750 C3                  <1> 	retn
   593                              <1> tL4:
   594                              <1> 	; 11/11/2023
   595 00000751 C606[9B11]FF        <1> 	mov	byte [tloop], -1
   596 00000756 F9                  <1> 	stc
   597 00000757 C3                  <1> 	retn
   598                              <1> 
   599                              <1> 
   600                              <1> 	; 06/11/2023
   601                              <1> tL0:
   602                              <1> 	; 08/11/2023
   603                              <1> 	; 05/11/2023
   604                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   605                              <1> 	; 06/11/2023
   606                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   607 00000758 1E                  <1> 	push	ds
   608                              <1> 	;push	bx 
   609 00000759 BB00B8              <1> 	mov	bx, 0B800h ; video display page segment
   610 0000075C 8EDB                <1> 	mov	ds, bx
   611 0000075E 29DB                <1> 	sub	bx, bx ; 0
   612 00000760 B44E                <1> 	mov	ah, 4Eh
   613 00000762 8907                <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   614                              <1> 	;pop	bx
   615 00000764 1F                  <1> 	pop	ds
   616 00000765 C3                  <1> 	retn
   617                              <1> 
   618                              <1> %endif
   619                              <1> 
   620                              <1> ; 08/11/2023
   621                              <1> ; 07/11/2023
   622                              <1> %if 0
   623                              <1> 
   624                              <1> tuneLoop:
   625                              <1> 	; 07/11/2023
   626                              <1> 	;mov	dx, NABMBAR
   627                              <1> 	;add	dx, PO_CIV_REG ; 14h
   628                              <1> tL1:
   629                              <1> 	call    updateLVI	; set LVI != CIV
   630                              <1> 	call    check4keyboardstop
   631                              <1> 	jc	short _exit_
   632                              <1> 	call    getCurrentIndex
   633                              <1> 	test	al, BIT0
   634                              <1> 	jz	short tL1	; loop if buffer 2 is not playing
   635                              <1> 
   636                              <1> 	; load buffer 1
   637                              <1> 	mov     ax, [WAV_BUFFER1]
   638                              <1> 	call	loadFromFile
   639                              <1> 	jc	short _exit_	; end of file
   640                              <1> tL2:
   641                              <1> 	call    updateLVI
   642                              <1> 	call    check4keyboardstop
   643                              <1> 	jc	short _exit_
   644                              <1> 	call    getCurrentIndex
   645                              <1> 	test	al, BIT0
   646                              <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   647                              <1> 
   648                              <1> 	; load buffer 2
   649                              <1> 	mov     ax, [WAV_BUFFER2]
   650                              <1> 	call	loadFromFile
   651                              <1> 	jnc	short tuneLoop
   652                              <1> _exit_:
   653                              <1> 	mov	dx, [NABMBAR]		
   654                              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   655                              <1> 	mov	al, 0
   656                              <1> 	out	dx, al		; stop player
   657                              <1> 	retn
   658                              <1> 
   659                              <1> %endif
   660                              <1> 
   661                              <1> ; load data from file in 32k chunks. Would be nice to load 1 64k chunk,
   662                              <1> ; but in DOS you can only load FFFF bytes at a time.
   663                              <1> ;
   664                              <1> ; entry: ax = segment to load data to
   665                              <1> ; exit: CY set if end of file reached.
   666                              <1> ; note: last file buffer is padded with 0's to avoid pops at the end of song.
   667                              <1> ; assumes file is already open. uses [filehandle]
   668                              <1> 
   669                              <1> ; 07/11/2023
   670                              <1> %if 0
   671                              <1> 
   672                              <1> loadFromFile:
   673                              <1> 	; 07/11/2023
   674                              <1> 	; 06/11/2023
   675                              <1> 	; 17/02/2017
   676                              <1> 	;push	ax
   677                              <1> 	;push	cx
   678                              <1> 	;push	dx
   679                              <1> 	;push	bx
   680                              <1> 
   681                              <1> 	;push	es
   682                              <1> 	;push	ds
   683                              <1> 	
   684                              <1>         test    byte [flags], ENDOFFILE	; have we already read the
   685                              <1> 	;stc				; last of the file?
   686                              <1> 	; 05/11/2023
   687                              <1> 	;jnz	endLFF
   688                              <1> 	jz	short lff_12	; 06/11/2023
   689                              <1> 	; 06/11/2023
   690                              <1> 	;;mov	byte [tLoop], 0
   691                              <1> 	;jmp	endLFF
   692                              <1> 	stc
   693                              <1> 	retn
   694                              <1> 
   695                              <1> lff_12:	; 06/11/2023    
   696                              <1> 	mov	[fbs_seg], ax ; save buffer segment
   697                              <1> 	xor	dx, dx
   698                              <1> lff_0:
   699                              <1> 	mov	[fbs_off], dx ; buffer offset
   700                              <1> 
   701                              <1> 	mov     bx, (BUFFERSIZE / 2)	; 32k chunk
   702                              <1> 	mov	cl, [fbs_shift]   
   703                              <1> 	and	cl, cl
   704                              <1> 	jz	short lff_1 ; stereo, 16 bit	
   705                              <1> 
   706                              <1> 	; fbs_shift =
   707                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   708                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   709                              <1> 	shr	bx, cl ; 32K / multiplier
   710                              <1> 
   711                              <1> 	mov	ax, cs
   712                              <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   713                              <1> lff_1:
   714                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   715                              <1> 	; load file into memory
   716                              <1>         mov	cx, bx                         
   717                              <1> 	mov	bx, [filehandle]
   718                              <1> 	mov     ds, ax
   719                              <1>        	mov	ah, 3fh
   720                              <1> 	int	21h
   721                              <1> 
   722                              <1> 	mov	bx, cs
   723                              <1> 	mov	ds, bx
   724                              <1> 
   725                              <1> 	jc	short lff_9 ; error !
   726                              <1> 
   727                              <1> 	and	ax, ax
   728                              <1> 	jz	short lff_10
   729                              <1> 	
   730                              <1> 	mov	bl, [fbs_shift] ; shift count  
   731                              <1> 	or	bl, bl
   732                              <1> 	jz	short lff_7 ; 16 bit stereo samples
   733                              <1> 
   734                              <1> 	push	es
   735                              <1> 	; 06/11/2023
   736                              <1> 	;push	di
   737                              <1> 	;push	si
   738                              <1> 	mov	di, [fbs_off]
   739                              <1> 	mov	si, [fbs_seg] ; buffer segment
   740                              <1> 	mov	es, si
   741                              <1> 	mov	si, temp_buffer ; temporary buffer address
   742                              <1> 	mov	cl, [bps] ; bits per sample (8 or 16)
   743                              <1> 	cmp	cl, 8
   744                              <1> 	jne	short lff_4 ; 16 bit samples
   745                              <1> 	; 8 bit samples
   746                              <1> 	mov	cx, ax ; byte count
   747                              <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   748                              <1> 	jz	short lff_3 ; 8 bit, stereo
   749                              <1> lff_2:
   750                              <1> 	; mono & 8 bit
   751                              <1> 	lodsb
   752                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   753                              <1> 	stosw	; left channel
   754                              <1> 	stosw	; right channel
   755                              <1> 	loop	lff_2
   756                              <1> 	jmp	short lff_6	
   757                              <1> lff_3:
   758                              <1> 	; stereo & 8 bit
   759                              <1> 	lodsb
   760                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   761                              <1> 	stosw
   762                              <1> 	loop	lff_3			
   763                              <1> 	jmp	short lff_6
   764                              <1> lff_4:
   765                              <1> 	; 16 bit mono samples
   766                              <1> 	mov	cx, ax ; word count
   767                              <1> lff_5:	
   768                              <1> 	lodsw
   769                              <1> 	stosw	; left channel
   770                              <1> 	stosw	; right channel
   771                              <1> 	loop	lff_5
   772                              <1> lff_6:
   773                              <1> 	mov	ax, di ; save next buffer offset/position
   774                              <1> 	; 06/11/2023
   775                              <1> 	;pop	si
   776                              <1> 	;pop	di
   777                              <1> 	pop	es
   778                              <1> ;lff_7:        
   779                              <1> 	; 06/11/2023
   780                              <1> 	and	ax, ax
   781                              <1> 	jz	short endLFF ; end of 2nd half
   782                              <1> 	mov	cx, (BUFFERSIZE / 2)
   783                              <1> lff_7:
   784                              <1> 	cmp	ax, cx
   785                              <1> 	je	short endLFF	 ; 06/11/2023
   786                              <1> 	;jb	short lff_11
   787                              <1> 	;xor	cx, cx
   788                              <1> 	;sub	cx, ax
   789                              <1> 	;neg	cx
   790                              <1> 	jmp	short lff_11
   791                              <1> lff_8:
   792                              <1> 	; 07/11/2023
   793                              <1> 	cmp	word [fbs_off], (BUFFERSIZE / 2) ; 32768
   794                              <1> 	jnb	short endLFF
   795                              <1> 	
   796                              <1> 	mov	dx, ax ; buffer offset
   797                              <1> 	mov	ax, [fbs_seg] ; buffer segment
   798                              <1> 	jmp	lff_0
   799                              <1> lff_9:  
   800                              <1> 	; 07/11/2023
   801                              <1> 	;; 06/11/2023 (temporary)
   802                              <1> 	;mov	al, '!'  ; error
   803                              <1> 	;call	tL0
   804                              <1> 
   805                              <1> 	xor	ax, ax
   806                              <1> lff_10:
   807                              <1> 	; 07/11/2023
   808                              <1> 	;mov	cx, (BUFFERSIZE / 2)  
   809                              <1> lff_11:
   810                              <1> 	call    padfill				; blank pad the remainder
   811                              <1>         ;clc					; don't exit with CY yet.
   812                              <1>         or	byte [flags], ENDOFFILE		; end of file flag
   813                              <1> endLFF:
   814                              <1>         ;pop	ds
   815                              <1> 	;pop	es
   816                              <1> 	; 06/11/2023
   817                              <1> 	;pop	bx
   818                              <1> 	;pop	dx
   819                              <1>         ;pop	cx
   820                              <1>         ;pop	ax
   821                              <1>         retn
   822                              <1> 
   823                              <1> %endif
   824                              <1> 
   825                              <1> ; 08/11/2023
   826                              <1> ; 07/11/2023
   827                              <1> %if 1
   828                              <1> 
   829                              <1> loadFromFile:
   830                              <1> 	; 07/11/2023
   831                              <1> 
   832 00000766 F606[9811]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
   833                              <1> 					; last of the file?
   834 0000076B 7402                <1> 	jz	short lff_0		; no
   835 0000076D F9                  <1> 	stc
   836 0000076E C3                  <1> 	retn
   837                              <1> 
   838                              <1> lff_0:
   839                              <1> 	; 08/11/2023
   840 0000076F 89C5                <1> 	mov	bp, ax ; save buffer segment	
   841                              <1> 
   842 00000771 8A0E[BA11]          <1> 	mov	cl, [fbs_shift]   
   843 00000775 20C9                <1> 	and	cl, cl
   844 00000777 7470                <1> 	jz	short lff_1 ; stereo, 16 bit	
   845                              <1> 
   846 00000779 BFFFFF              <1> 	mov	di, BUFFERSIZE - 1 ; 65535
   847                              <1> 
   848                              <1> 	; fbs_shift =
   849                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   850                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   851 0000077C D3EF                <1> 	shr	di, cl
   852 0000077E 47                  <1> 	inc	di ; 16384 for 8 bit and mono	
   853                              <1> 		   ; 32768 for 8 bit or mono	
   854                              <1> 
   855 0000077F 8CC8                <1> 	mov	ax, cs
   856 00000781 BA[BE11]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   857                              <1> 
   858                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   859                              <1> 	; load file into memory
   860 00000784 89F9                <1>         mov	cx, di                       
   861 00000786 8B1E[9611]          <1> 	mov	bx, [filehandle]
   862 0000078A 8ED8                <1> 	mov     ds, ax
   863 0000078C B43F                <1>        	mov	ah, 3Fh
   864 0000078E CD21                <1> 	int	21h
   865                              <1> 
   866 00000790 8CCB                <1> 	mov	bx, cs
   867 00000792 8EDB                <1> 	mov	ds, bx
   868                              <1> 
   869 00000794 724A                <1> 	jc	short lff_4 ; error !
   870                              <1> 
   871                              <1> 	; 08/11/2023
   872 00000796 31D2                <1> 	xor	dx, dx ; 0
   873                              <1> 
   874 00000798 21C0                <1> 	and	ax, ax
   875 0000079A 7476                <1> 	jz	short lff_3
   876                              <1> 
   877 0000079C 8A1E[BA11]          <1> 	mov	bl, [fbs_shift]
   878                              <1> 
   879 000007A0 06                  <1> 	push	es
   880 000007A1 89D7                <1> 	mov	di, dx ; 0 ; [fbs_off]
   881                              <1> 	;mov	bp, [fbs_seg] ; buffer segment
   882 000007A3 8EC5                <1> 	mov	es, bp
   883 000007A5 BE[BE11]            <1> 	mov	si, temp_buffer ; temporary buffer address
   884 000007A8 89C1                <1> 	mov	cx, ax ; byte count
   885 000007AA 803E[B811]08        <1> 	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   886 000007AF 751B                <1> 	jne	short lff_7 ; 16 bit samples
   887                              <1> 	; 8 bit samples
   888 000007B1 FECB                <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   889 000007B3 740C                <1> 	jz	short lff_6 ; 8 bit, stereo
   890                              <1> lff_5:
   891                              <1> 	; mono & 8 bit
   892 000007B5 AC                  <1> 	lodsb
   893 000007B6 2C80                <1> 	sub	al, 80h ; 08/11/2023
   894 000007B8 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   895 000007BB AB                  <1> 	stosw	; left channel
   896 000007BC AB                  <1> 	stosw	; right channel
   897 000007BD E2F6                <1> 	loop	lff_5
   898 000007BF EB12                <1> 	jmp	short lff_9	
   899                              <1> lff_6:
   900                              <1> 	; stereo & 8 bit
   901 000007C1 AC                  <1> 	lodsb
   902 000007C2 2C80                <1> 	sub	al, 80h ; 08/11/2023
   903 000007C4 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   904 000007C7 AB                  <1> 	stosw
   905 000007C8 E2F7                <1> 	loop	lff_6			
   906 000007CA EB07                <1> 	jmp	short lff_9
   907                              <1> lff_7:
   908 000007CC D1E9                <1> 	shr	cx, 1 ; word count
   909                              <1> lff_8:
   910 000007CE AD                  <1> 	lodsw
   911 000007CF AB                  <1> 	stosw	; left channel
   912 000007D0 AB                  <1> 	stosw	; right channel
   913 000007D1 E2FB                <1> 	loop	lff_8
   914                              <1> lff_9:
   915 000007D3 07                  <1> 	pop	es
   916 000007D4 09FF                <1> 	or	di, di
   917 000007D6 7442                <1> 	jz	short endLFF ; 64KB ok 
   918                              <1> 	
   919 000007D8 89F8                <1> 	mov	ax, di ; [fbs_off]
   920 000007DA 48                  <1> 	dec	ax
   921 000007DB B9FFFF              <1> 	mov	cx, BUFFERSIZE - 1 ; 65535
   922 000007DE EB32                <1> 	jmp	short lff_3
   923                              <1> 
   924                              <1> lff_4:
   925                              <1> 	; 08/11/2023
   926 000007E0 B021                <1> 	mov	al, '!'  ; error
   927 000007E2 E873FF              <1> 	call	tL0
   928                              <1> 
   929 000007E5 31C0                <1> 	xor	ax, ax
   930 000007E7 EB29                <1> 	jmp	short lff_3
   931                              <1> 	
   932                              <1> lff_1:  
   933                              <1> 	;mov	bp, ax ; save buffer segment
   934 000007E9 31D2                <1> 	xor	dx, dx
   935                              <1> 	; load file into memory
   936 000007EB B90080              <1>         mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   937 000007EE 8B1E[9611]          <1> 	mov	bx, [filehandle]
   938 000007F2 8ED8                <1> 	mov     ds, ax
   939 000007F4 B43F                <1>        	mov	ah, 3Fh
   940 000007F6 CD21                <1> 	int	21h
   941                              <1> 
   942 000007F8 8CCF                <1> 	mov	di, cs
   943 000007FA 8EDF                <1> 	mov	ds, di
   944                              <1> 
   945                              <1> 	; 07/11/2023
   946 000007FC 72E2                <1> 	jc	short lff_4 ; error !
   947                              <1> 	
   948 000007FE 39C8                <1> 	cmp	ax, cx
   949 00000800 7510                <1> 	jne	short lff_3
   950                              <1> lff_2:
   951                              <1> 	; 08/11/2023
   952 00000802 01C2                <1> 	add	dx, ax
   953                              <1> 	;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   954                              <1> 	;mov	bx, [filehandle]
   955 00000804 8EDD                <1> 	mov     ds, bp
   956 00000806 B43F                <1>        	mov	ah, 3Fh
   957 00000808 CD21                <1> 	int	21h
   958                              <1> 
   959                              <1> 	;mov	di, cs
   960 0000080A 8EDF                <1> 	mov	ds, di
   961                              <1> 
   962 0000080C 72D2                <1> 	jc	short lff_4 ; error !
   963                              <1> 
   964 0000080E 39C8                <1> 	cmp	ax, cx
   965 00000810 7408                <1> 	je	short endLFF
   966                              <1> lff_3:
   967 00000812 E80600              <1> 	call    padfill			; blank pad the remainder
   968                              <1>         ;clc				; don't exit with CY yet.
   969 00000815 800E[9811]01        <1>         or	byte [flags], ENDOFFILE	; end of file flag
   970                              <1> endLFF:
   971 0000081A C3                  <1>         retn
   972                              <1> 
   973                              <1> %endif
   974                              <1> 
   975                              <1> ; entry ds:ax points to last byte in file
   976                              <1> ; cx=target size
   977                              <1> ; note: must do byte size fill
   978                              <1> ; destroys bx, cx
   979                              <1> ;
   980                              <1> padfill:
   981                              <1> 	; 07/11/2023
   982                              <1> 	; 06/11/2023
   983                              <1> 	; 17/02/2017
   984 0000081B 06                  <1> 	push	es
   985                              <1>         ;push	di
   986                              <1> 	;mov	di, [fbs_seg]
   987                              <1> 	;mov	es, di
   988 0000081C 8EC5                <1>         mov	es, bp
   989 0000081E 29C1                <1> 	sub	cx, ax
   990                              <1> 	; 08/11/2023
   991                              <1> 	;mov	di, ax ; (wrong)
   992 00000820 89D7                <1> 	mov	di, dx ; buffer offset
   993 00000822 01C7                <1> 	add	di, ax       	
   994                              <1> 	; 07/11/2023
   995                              <1> 	;add	di, [fbs_off]
   996 00000824 30C0                <1>         xor	al, al
   997 00000826 F3AA                <1> 	rep	stosb
   998                              <1> 	;mov	[fbs_off], di
   999                              <1> 	;pop	di
  1000 00000828 07                  <1>         pop	es
  1001 00000829 C3                  <1> 	retn
  1002                              <1> 
  1003                              <1> ; returns AL = current index value
  1004                              <1> getCurrentIndex:
  1005                              <1> 	; 08/11/2023
  1006                              <1> 	;push	dx
  1007 0000082A 8B16[A411]          <1> 	mov	dx, [NABMBAR]      		
  1008 0000082E 83C214              <1> 	add	dx, PO_CIV_REG
  1009 00000831 EC                  <1> 	in	al, dx
  1010                              <1> 	;pop	dx
  1011                              <1> uLVI2:	;	06/11/2023
  1012 00000832 C3                  <1> 	retn
  1013                              <1> 
  1014                              <1> ; examines the CIV and the LVI. When they're the same, we set LVI <> CIV
  1015                              <1> ; that way, we never run out of buffers to play
  1016                              <1> 
  1017                              <1> ; 08/11/2023
  1018                              <1> %if 0
  1019                              <1> 	; 07/11/2023
  1020                              <1> updateLVI:
  1021                              <1> 	push	ax
  1022                              <1> 	push	dx
  1023                              <1> 	; 06/11/2023
  1024                              <1> 	mov	dx, [NABMBAR]
  1025                              <1> 	add	dx, PO_CIV_REG
  1026                              <1> 	; (Current Index Value and Last Valid Index value)
  1027                              <1> 	in	ax, dx
  1028                              <1> 
  1029                              <1> 	cmp	al, ah ; is current index = last index ?
  1030                              <1> 	jne	short uLVI1
  1031                              <1> 
  1032                              <1> 	call	setNewIndex
  1033                              <1> uLVI1:
  1034                              <1> 	pop	dx
  1035                              <1> 	pop	ax
  1036                              <1> 	retn
  1037                              <1> 
  1038                              <1> setNewIndex:
  1039                              <1> 	; 07/11/2023
  1040                              <1> 	push	ax
  1041                              <1>         call    getCurrentIndex                 ; get CIV
  1042                              <1>         test    byte [flags], ENDOFFILE
  1043                              <1>         jnz     short sni_1
  1044                              <1>         ; not at the end of the file yet.
  1045                              <1>         dec     al                              ; make new index <> current
  1046                              <1>         and     al, INDEX_MASK                  ; make sure new value is 0-31
  1047                              <1> sni_1:
  1048                              <1>         call    setLastValidIndex               ; write new value
  1049                              <1>         clc
  1050                              <1>         pop	ax
  1051                              <1> 	retn
  1052                              <1> 
  1053                              <1> %endif	
  1054                              <1> 
  1055                              <1> ; 08/11/2023
  1056                              <1> ; 07/11/2023
  1057                              <1> %if 0
  1058                              <1> updateLVI:
  1059                              <1> 	; 06/11/2023
  1060                              <1> 	mov	dx, [NABMBAR]      		
  1061                              <1> 	add	dx, PO_CIV_REG
  1062                              <1> 	; (Current Index Value and Last Valid Index value)
  1063                              <1> 	in	ax, dx
  1064                              <1> 
  1065                              <1> 	cmp	al, ah ; is current index = last index ?
  1066                              <1> 	jne	short uLVI2
  1067                              <1> 
  1068                              <1> 	; 10/11/2023
  1069                              <1> 	; 08/11/2023	
  1070                              <1> 	call	getCurrentIndex
  1071                              <1>  
  1072                              <1> 	test	byte [flags], ENDOFFILE
  1073                              <1> 	;jnz	short uLVI1
  1074                              <1> 	jz	short uLVI0  ; 08/11/2023
  1075                              <1> 
  1076                              <1> 	; 08/11/2023
  1077                              <1> 	push	ax
  1078                              <1> 	mov	dx, [NABMBAR]
  1079                              <1> 	add	dx, PO_SR_REG  ; PCM out status register
  1080                              <1> 	in	ax, dx
  1081                              <1> 
  1082                              <1> 	;test	al, 2
  1083                              <1> 	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
  1084                              <1> 		      ; (has been processed)
  1085                              <1> 		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
  1086                              <1> 	pop	ax
  1087                              <1> 	jz	short uLVI1
  1088                              <1> uLVI3:
  1089                              <1> 	xor	ax, ax
  1090                              <1> 	; zf = 1
  1091                              <1> 	retn
  1092                              <1> uLVI0:
  1093                              <1>         ; not at the end of the file yet.
  1094                              <1> 	dec	al
  1095                              <1> 	and	al, 1Fh
  1096                              <1> uLVI1:
  1097                              <1> 	;call	setLastValidIndex
  1098                              <1> ;uLVI2:
  1099                              <1> 	;retn
  1100                              <1> 
  1101                              <1> %endif
  1102                              <1> 	
  1103                              <1> ;input AL = index # to stop on
  1104                              <1> setLastValidIndex:
  1105                              <1> 	; 08/11/2023
  1106                              <1> 	;push	dx
  1107 00000833 8B16[A411]          <1> 	mov	dx, [NABMBAR]
  1108 00000837 83C215              <1> 	add	dx, PO_LVI_REG
  1109 0000083A EE                  <1>         out     dx, al
  1110                              <1> 	;pop	dx
  1111 0000083B C3                  <1> 	retn
  1112                              <1> 
  1113                              <1> ; 06/11/2023
  1114                              <1> ;	; 05/11/2023
  1115                              <1> ;setCurrentIndex:
  1116                              <1> ;	;push	dx
  1117                              <1> ;	mov	dx, [NABMBAR]
  1118                              <1> ;	add	dx, PO_CIV_REG
  1119                              <1> ;	out	dx, al
  1120                              <1> ;	;pop	dx
  1121                              <1> ;	retn
  1122                              <1> 
  1123                              <1> ; checks if either shift key has been pressed. Exits with CY if so.
  1124                              <1> ; 
  1125                              <1> check4keyboardstop:
  1126                              <1> 
  1127                              <1> ; 06/11/2023
  1128                              <1> %if 1
  1129                              <1> 	; 08/11/2023
  1130                              <1> 	; 04/11/2023
  1131 0000083C B401                <1> 	mov	ah, 1
  1132 0000083E CD16                <1> 	int	16h
  1133 00000840 F8                  <1> 	clc
  1134 00000841 7405                <1> 	jz	short _cksr
  1135 00000843 30E4                <1> 	xor	ah, ah
  1136 00000845 CD16                <1> 	int	16h
  1137 00000847 F9                  <1> 	stc
  1138                              <1> _cksr:
  1139 00000848 C3                  <1> 	retn
  1140                              <1> %endif
  1141                              <1> 
  1142                              <1> ; 06/11/2023
  1143                              <1> ; 04/11/2023
  1144                              <1> %if 0	
  1145                              <1>         push    ds
  1146                              <1>         push    0
  1147                              <1>         pop     ds		       ; examine BDA for keyboard flags
  1148                              <1>         test    byte [417h], (BIT0 | BIT1)
  1149                              <1>         pop     ds
  1150                              <1>         stc
  1151                              <1>         jnz	short _cksr ; 07/11/2023
  1152                              <1> 	;jz	short _cksr ; 06/11/2023
  1153                              <1>         clc
  1154                              <1> _cksr:
  1155                              <1>         retn
  1156                              <1> %endif
  1157                              <1> 
  1158                              <1> ; 15/11/2023
  1159                              <1> ; 14/11/2023
  1160                              <1> ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1161                              <1> ; --------------------------------------------------------
  1162                              <1> 
  1163                              <1> ;;Note:	At the end of every buffer load,
  1164                              <1> ;;	during buffer switch/swap, there will be discontinuity
  1165                              <1> ;;	between the last converted sample and the 1st sample
  1166                              <1> ;;	of the next buffer.
  1167                              <1> ;;	(like as a dot noises vaguely between normal sound samples)
  1168                              <1> ;;	-To avoid this defect, the 1st sample of
  1169                              <1> ;;	the next buffer may be read from the wav file but
  1170                              <1> ;;	the file pointer would need to be set to 1 sample back
  1171                              <1> ;;	again via seek system call. Time comsumption problem! -
  1172                              <1> ;;
  1173                              <1> ;;	Erdogan Tan - 15/11/2023
  1174                              <1> ;;
  1175                              <1> ;;	((If entire wav data would be loaded at once.. conversion
  1176                              <1> ;;	defect/noise would disappear.. but for DOS, to keep
  1177                              <1> ;;	64KB buffer limit is important also it is important
  1178                              <1> ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1179                              <1> ;;	I have tested this program by using 2-30MB wav files.))
  1180                              <1> ;;
  1181                              <1> ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1182                              <1> ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1183                              <1> ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1184                              <1> ;;			Realtek ALC850 codec.
  1185                              <1> ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1186                              <1> 
  1187                              <1> load_8khz_mono_8_bit:
  1188                              <1> 	; 15/11/2023
  1189                              <1> 	; 14/11/2023
  1190                              <1> 	; 13/11/2023
  1191 00000849 F606[9811]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1192                              <1> 					; last of the file?
  1193 0000084E 7402                <1> 	jz	short lff8m_0		; no
  1194 00000850 F9                  <1> 	stc
  1195 00000851 C3                  <1> 	retn
  1196                              <1> 
  1197                              <1> lff8m_0:
  1198 00000852 8EC0                <1> 	mov	es, ax ; buffer segment	
  1199 00000854 31FF                <1> 	xor	di, di
  1200 00000856 BA[BE11]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1201                              <1> 	; ds = cs
  1202                              <1> 
  1203                              <1> 	; load file into memory
  1204 00000859 8B0E[4706]          <1>         mov	cx, [loadsize]
  1205 0000085D 8B1E[9611]          <1> 	mov	bx, [filehandle]
  1206 00000861 B43F                <1>        	mov	ah, 3Fh
  1207 00000863 CD21                <1> 	int	21h
  1208                              <1> 	;jc	short lff8m_5 ; error !
  1209                              <1> 	; 14/11/2023
  1210 00000865 7303                <1> 	jnc	short lff8m_6
  1211 00000867 E98B00              <1> 	jmp	lff8m_5
  1212                              <1> 
  1213                              <1> lff8m_6:
  1214 0000086A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1215 0000086C 21C0                <1> 	and	ax, ax
  1216                              <1> 	;jz	short lff8m_3
  1217                              <1> 	; 15/11/2023
  1218 0000086E 747E                <1> 	jz	short lff8_eof
  1219                              <1> 
  1220 00000870 89C1                <1> 	mov	cx, ax		; byte count
  1221                              <1> lff8m_1:
  1222 00000872 AC                  <1> 	lodsb
  1223 00000873 A2[390D]            <1> 	mov	[previous_val], al
  1224 00000876 2C80                <1> 	sub	al, 80h
  1225 00000878 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1226 0000087B AB                  <1> 	stosw		; original sample (left channel)
  1227 0000087C AB                  <1> 	stosw		; original sample (right channel)
  1228                              <1> 	;xor	ax, ax
  1229                              <1> 	; 14/11/2023
  1230 0000087D B080                <1> 	mov	al, 80h
  1231 0000087F 49                  <1> 	dec	cx
  1232 00000880 7402                <1> 	jz	short lff8m_2
  1233 00000882 8A04                <1> 	mov	al, [si]
  1234                              <1> lff8m_2:
  1235                              <1> 	;mov	[new_val], ax
  1236 00000884 88C7                <1> 	mov	bh, al	; [new_val]
  1237 00000886 8A26[390D]          <1> 	mov	ah, [previous_val]
  1238 0000088A 00E0                <1> 	add	al, ah	; [previous_val]
  1239 0000088C D0D8                <1> 	rcr	al, 1
  1240 0000088E 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample
  1241 00000890 00E0                <1> 	add	al, ah	; [previous_val]
  1242 00000892 D0D8                <1> 	rcr	al, 1	
  1243 00000894 88C3                <1> 	mov	bl, al 	; this is temporary interpolation value	
  1244 00000896 00E0                <1> 	add	al, ah	; [previous_val]
  1245 00000898 D0D8                <1> 	rcr	al, 1
  1246 0000089A 2C80                <1> 	sub	al, 80h
  1247 0000089C C1E008              <1> 	shl	ax, 8	
  1248 0000089F AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1249 000008A0 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1250 000008A1 88D8                <1> 	mov	al, bl
  1251 000008A3 00D0                <1> 	add	al, dl
  1252 000008A5 D0D8                <1> 	rcr	al, 1
  1253 000008A7 2C80                <1> 	sub	al, 80h
  1254 000008A9 C1E008              <1> 	shl	ax, 8
  1255 000008AC AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1256 000008AD AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1257 000008AE 88D0                <1> 	mov	al, dl
  1258 000008B0 2C80                <1> 	sub	al, 80h
  1259 000008B2 C1E008              <1> 	shl	ax, 8
  1260 000008B5 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1261 000008B6 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1262                              <1> 	;mov	al, [new_val]
  1263 000008B7 88F8                <1> 	mov	al, bh
  1264 000008B9 00D0                <1> 	add	al, dl
  1265 000008BB D0D8                <1> 	rcr	al, 1
  1266 000008BD 88C3                <1> 	mov	bl, al	; this is temporary interpolation value
  1267 000008BF 00D0                <1> 	add	al, dl
  1268 000008C1 D0D8                <1> 	rcr	al, 1
  1269 000008C3 2C80                <1> 	sub	al, 80h
  1270 000008C5 C1E008              <1> 	shl	ax, 8
  1271 000008C8 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1272 000008C9 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1273                              <1> 	;mov	al, [new_val]
  1274 000008CA 88F8                <1> 	mov	al, bh
  1275 000008CC 00D8                <1> 	add	al, bl
  1276 000008CE D0D8                <1> 	rcr	al, 1
  1277 000008D0 2C80                <1> 	sub	al, 80h
  1278 000008D2 C1E008              <1> 	shl	ax, 8
  1279 000008D5 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1280 000008D6 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1281                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1282 000008D7 09C9                <1> 	or	cx, cx
  1283 000008D9 7597                <1> 	jnz	short lff8m_1
  1284                              <1> 
  1285                              <1> lff8s_3:
  1286                              <1> lff8m_3:
  1287                              <1> lff8s2_3:
  1288                              <1> lff8m2_3:
  1289                              <1> lff16s_3:
  1290                              <1> lff16m_3:
  1291                              <1> lff16s2_3:
  1292                              <1> lff16m2_3:
  1293 000008DB 8B0E[4906]          <1> 	mov	cx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1294 000008DF D1E1                <1> 	shl	cx, 1	; byte count
  1295 000008E1 29F9                <1> 	sub	cx, di
  1296 000008E3 7606                <1> 	jna	short lff8m_4
  1297                              <1> 	;inc	cx
  1298 000008E5 D1E9                <1> 	shr	cx, 1
  1299 000008E7 31C0                <1> 	xor	ax, ax	; fill (remain part of) buffer with zeros	
  1300 000008E9 F3AB                <1> 	rep	stosw
  1301                              <1> lff8m_4:
  1302 000008EB 0E                  <1> 	push	cs
  1303 000008EC 07                  <1> 	pop	es
  1304 000008ED C3                  <1> 	retn
  1305                              <1> 
  1306                              <1> lff8_eof:
  1307                              <1> lff16_eof:
  1308                              <1> 	; 15/11/2023
  1309 000008EE C606[9811]01        <1> 	mov	byte [flags], ENDOFFILE
  1310 000008F3 EBE6                <1> 	jmp	short lff8m_3
  1311                              <1> 
  1312                              <1> lff8s_5:
  1313                              <1> lff8m_5:
  1314                              <1> lff8s2_5:
  1315                              <1> lff8m2_5:
  1316                              <1> lff16s_5:
  1317                              <1> lff16m_5:
  1318                              <1> lff16s2_5:
  1319                              <1> lff16m2_5:
  1320 000008F5 B021                <1> 	mov	al, '!'  ; error
  1321 000008F7 E85EFE              <1> 	call	tL0
  1322                              <1> 	
  1323                              <1> 	;jmp	short lff8m_3
  1324                              <1> 	; 15/11/2023
  1325 000008FA EBF2                <1> 	jmp	lff8_eof
  1326                              <1> 
  1327                              <1> load_8khz_stereo_8_bit:
  1328                              <1> 	; 15/11/2023
  1329                              <1> 	; 14/11/2023
  1330                              <1> 	; 13/11/2023
  1331 000008FC F606[9811]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1332                              <1> 					; last of the file?
  1333 00000901 7402                <1> 	jz	short lff8s_0		; no
  1334 00000903 F9                  <1> 	stc
  1335 00000904 C3                  <1> 	retn
  1336                              <1> 
  1337                              <1> lff8s_0:
  1338 00000905 8EC0                <1> 	mov	es, ax ; buffer segment	
  1339 00000907 31FF                <1> 	xor	di, di
  1340 00000909 BA[BE11]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1341                              <1> 	; ds = cs
  1342                              <1> 
  1343                              <1> 	; load file into memory
  1344 0000090C 8B0E[4706]          <1>         mov	cx, [loadsize]
  1345 00000910 8B1E[9611]          <1> 	mov	bx, [filehandle]
  1346 00000914 B43F                <1>        	mov	ah, 3Fh
  1347 00000916 CD21                <1> 	int	21h
  1348 00000918 72DB                <1> 	jc	short lff8s_5 ; error !
  1349                              <1> 
  1350 0000091A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1351                              <1> 	
  1352 0000091C D1E8                <1> 	shr	ax, 1
  1353                              <1> 	;;and	ax, ax
  1354                              <1> 	;jz	short lff8s_3
  1355                              <1> 	; 15/11/2023
  1356 0000091E 74CE                <1> 	jz	short lff8_eof
  1357                              <1> 
  1358 00000920 89C1                <1> 	mov	cx, ax		; word count
  1359                              <1> lff8s_1:
  1360 00000922 AC                  <1> 	lodsb
  1361 00000923 A2[390D]            <1> 	mov	[previous_val_l], al
  1362 00000926 2C80                <1> 	sub	al, 80h
  1363 00000928 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1364 0000092B AB                  <1> 	stosw		; original sample (L)
  1365 0000092C AC                  <1> 	lodsb
  1366 0000092D A2[3B0D]            <1> 	mov	[previous_val_r], al
  1367 00000930 2C80                <1> 	sub	al, 80h
  1368 00000932 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1369 00000935 AB                  <1> 	stosw		; original sample (R)
  1370                              <1> 
  1371                              <1> 	;xor	ax, ax
  1372                              <1> 	; 14/11/2023
  1373 00000936 B88080              <1> 	mov	ax, 8080h
  1374 00000939 49                  <1> 	dec	cx
  1375 0000093A 7402                <1> 	jz	short lff8s_2
  1376                              <1> 		; convert 8 bit sample to 16 bit sample
  1377 0000093C 8B04                <1> 	mov	ax, [si]
  1378                              <1> lff8s_2:
  1379 0000093E A2[3D0D]            <1> 	mov	[new_val_l], al
  1380 00000941 8826[3F0D]          <1> 	mov	[new_val_r], ah
  1381 00000945 8A26[390D]          <1> 	mov	ah, [previous_val_l]
  1382 00000949 00E0                <1> 	add	al, ah
  1383 0000094B D0D8                <1> 	rcr	al, 1
  1384 0000094D 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1385 0000094F 00E0                <1> 	add	al, ah
  1386 00000951 D0D8                <1> 	rcr	al, 1	
  1387 00000953 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1388 00000955 00E0                <1> 	add	al, ah
  1389 00000957 D0D8                <1> 	rcr	al, 1
  1390 00000959 2C80                <1> 	sub	al, 80h
  1391 0000095B C1E008              <1> 	shl	ax, 8
  1392 0000095E AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1393 0000095F A0[3F0D]            <1> 	mov	al, [new_val_r]
  1394 00000962 8A26[3B0D]          <1> 	mov	ah, [previous_val_r]
  1395 00000966 00E0                <1> 	add	al, ah
  1396 00000968 D0D8                <1> 	rcr	al, 1
  1397 0000096A 88C6                <1> 	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1398 0000096C 00E0                <1> 	add	al, ah
  1399 0000096E D0D8                <1> 	rcr	al, 1
  1400 00000970 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1401 00000972 00E0                <1> 	add	al, ah
  1402 00000974 D0D8                <1> 	rcr	al, 1
  1403 00000976 2C80                <1> 	sub	al, 80h
  1404 00000978 C1E008              <1> 	shl	ax, 8
  1405 0000097B AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1406 0000097C 88D8                <1> 	mov	al, bl
  1407 0000097E 00D0                <1> 	add	al, dl
  1408 00000980 D0D8                <1> 	rcr	al, 1
  1409 00000982 2C80                <1> 	sub	al, 80h
  1410 00000984 C1E008              <1> 	shl	ax, 8
  1411 00000987 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1412 00000988 88F8                <1> 	mov	al, bh
  1413 0000098A 00F0                <1> 	add	al, dh
  1414 0000098C D0D8                <1> 	rcr	al, 1
  1415 0000098E 2C80                <1> 	sub	al, 80h
  1416 00000990 C1E008              <1> 	shl	ax, 8
  1417 00000993 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1418 00000994 88D0                <1> 	mov	al, dl
  1419 00000996 2C80                <1> 	sub	al, 80h
  1420 00000998 C1E008              <1> 	shl	ax, 8
  1421 0000099B AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1422 0000099C 88F0                <1> 	mov	al, dh
  1423 0000099E 2C80                <1> 	sub	al, 80h
  1424 000009A0 C1E008              <1> 	shl	ax, 8
  1425 000009A3 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1426 000009A4 A0[3D0D]            <1> 	mov	al, [new_val_l]
  1427 000009A7 00D0                <1> 	add	al, dl
  1428 000009A9 D0D8                <1> 	rcr	al, 1
  1429 000009AB 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1430 000009AD 00D0                <1> 	add	al, dl
  1431 000009AF D0D8                <1> 	rcr	al, 1
  1432 000009B1 2C80                <1> 	sub	al, 80h
  1433 000009B3 C1E008              <1> 	shl	ax, 8
  1434 000009B6 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1435 000009B7 A0[3F0D]            <1> 	mov	al, [new_val_r]
  1436 000009BA 00F0                <1> 	add	al, dh
  1437 000009BC D0D8                <1> 	rcr	al, 1
  1438 000009BE 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1439 000009C0 00F0                <1> 	add	al, dh
  1440 000009C2 D0D8                <1> 	rcr	al, 1
  1441 000009C4 2C80                <1> 	sub	al, 80h
  1442 000009C6 C1E008              <1> 	shl	ax, 8
  1443 000009C9 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1444 000009CA A0[3D0D]            <1> 	mov	al, [new_val_l]
  1445 000009CD 00D8                <1> 	add	al, bl
  1446 000009CF D0D8                <1> 	rcr	al, 1
  1447 000009D1 2C80                <1> 	sub	al, 80h
  1448 000009D3 C1E008              <1> 	shl	ax, 8
  1449 000009D6 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1450 000009D7 A0[3F0D]            <1> 	mov	al, [new_val_r]
  1451 000009DA 00F8                <1> 	add	al, bh
  1452 000009DC D0D8                <1> 	rcr	al, 1
  1453 000009DE 2C80                <1> 	sub	al, 80h
  1454 000009E0 C1E008              <1> 	shl	ax, 8
  1455 000009E3 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1456                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1457 000009E4 E303                <1> 	jcxz	lff8s_6
  1458 000009E6 E939FF              <1> 	jmp	lff8s_1
  1459                              <1> lff8s_6:
  1460 000009E9 E9EFFE              <1> 	jmp	lff8s_3
  1461                              <1> 
  1462                              <1> load_8khz_mono_16_bit:
  1463                              <1> 	; 13/11/2023
  1464 000009EC F606[9811]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1465                              <1> 					; last of the file?
  1466 000009F1 7402                <1> 	jz	short lff8m2_0		; no
  1467 000009F3 F9                  <1> 	stc
  1468 000009F4 C3                  <1> 	retn
  1469                              <1> 
  1470                              <1> lff8m2_0:
  1471 000009F5 8EC0                <1> 	mov	es, ax ; buffer segment	
  1472 000009F7 31FF                <1> 	xor	di, di
  1473 000009F9 BA[BE11]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1474                              <1> 	; ds = cs
  1475                              <1> 
  1476                              <1> 	; load file into memory
  1477 000009FC 8B0E[4706]          <1>         mov	cx, [loadsize]
  1478 00000A00 8B1E[9611]          <1> 	mov	bx, [filehandle]
  1479 00000A04 B43F                <1>        	mov	ah, 3Fh
  1480 00000A06 CD21                <1> 	int	21h
  1481 00000A08 725B                <1> 	jc	short lff8m2_7 ; error !
  1482                              <1> 
  1483 00000A0A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1484                              <1> 	
  1485 00000A0C D1E8                <1> 	shr	ax, 1
  1486                              <1> 	;and	ax, ax
  1487 00000A0E 7503                <1> 	jnz	short lff8m2_8
  1488                              <1> 	;jmp	lff8m2_3
  1489                              <1> 	; 15/11/2023
  1490 00000A10 E9DBFE              <1> 	jmp	lff8_eof
  1491                              <1> 
  1492                              <1> lff8m2_8:
  1493 00000A13 89C1                <1> 	mov	cx, ax		; word count
  1494                              <1> lff8m2_1:
  1495 00000A15 AD                  <1> 	lodsw
  1496 00000A16 A3[390D]            <1> 	mov	[previous_val], ax
  1497 00000A19 AB                  <1> 	stosw		; original sample (left channel)
  1498 00000A1A AB                  <1> 	stosw		; original sample (right channel)
  1499 00000A1B 31C0                <1> 	xor	ax, ax
  1500 00000A1D 49                  <1> 	dec	cx
  1501 00000A1E 7402                <1> 	jz	short lff8m2_2
  1502 00000A20 8B04                <1> 	mov	ax, [si]
  1503                              <1> lff8m2_2:
  1504 00000A22 89C5                <1> 	mov	bp, ax	; [new_val]
  1505 00000A24 0306[390D]          <1> 	add	ax, [previous_val]
  1506 00000A28 D1D8                <1> 	rcr	ax, 1
  1507 00000A2A 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample
  1508 00000A2C 0306[390D]          <1> 	add	ax, [previous_val]
  1509 00000A30 D1D8                <1> 	rcr	ax, 1	; this is temporary interpolation value
  1510 00000A32 89C3                <1> 	mov	bx, ax 		
  1511 00000A34 0306[390D]          <1> 	add	ax, [previous_val]
  1512 00000A38 D1D8                <1> 	rcr	ax, 1
  1513 00000A3A AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1514 00000A3B AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1515 00000A3C 89D8                <1> 	mov	ax, bx
  1516 00000A3E 01D0                <1> 	add	ax, dx
  1517 00000A40 D1D8                <1> 	rcr	ax, 1
  1518 00000A42 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1519 00000A43 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1520 00000A44 89D0                <1> 	mov	ax, dx
  1521 00000A46 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1522 00000A47 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1523 00000A48 89E8                <1> 	mov	ax, bp
  1524 00000A4A 01D0                <1> 	add	ax, dx
  1525 00000A4C D1D8                <1> 	rcr	ax, 1
  1526 00000A4E 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value
  1527 00000A50 01D0                <1> 	add	ax, dx
  1528 00000A52 D1D8                <1> 	rcr	ax, 1
  1529 00000A54 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1530 00000A55 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1531 00000A56 89E8                <1> 	mov	ax, bp
  1532 00000A58 01D8                <1> 	add	ax, bx
  1533 00000A5A D1D8                <1> 	rcr	ax, 1
  1534 00000A5C AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1535 00000A5D AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1536                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1537 00000A5E 09C9                <1> 	or	cx, cx
  1538 00000A60 75B3                <1> 	jnz	short lff8m2_1
  1539 00000A62 E976FE              <1> 	jmp	lff8m2_3
  1540                              <1> 
  1541                              <1> lff8m2_7:
  1542                              <1> lff8s2_7:
  1543 00000A65 E98DFE              <1> 	jmp	lff8m2_5  ; error
  1544                              <1> 
  1545                              <1> load_8khz_stereo_16_bit:
  1546                              <1> 	; 13/11/2023
  1547 00000A68 F606[9811]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1548                              <1> 					; last of the file?
  1549 00000A6D 7402                <1> 	jz	short lff8s2_0		; no
  1550 00000A6F F9                  <1> 	stc
  1551 00000A70 C3                  <1> 	retn
  1552                              <1> 
  1553                              <1> lff8s2_0:
  1554 00000A71 8EC0                <1> 	mov	es, ax ; buffer segment	
  1555 00000A73 31FF                <1> 	xor	di, di
  1556 00000A75 BA[BE11]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1557                              <1> 	; ds = cs
  1558                              <1> 
  1559                              <1> 	; load file into memory
  1560 00000A78 8B0E[4706]          <1>         mov	cx, [loadsize]
  1561 00000A7C 8B1E[9611]          <1> 	mov	bx, [filehandle]
  1562 00000A80 B43F                <1>        	mov	ah, 3Fh
  1563 00000A82 CD21                <1> 	int	21h
  1564 00000A84 72DF                <1> 	jc	short lff8s2_7 ; error !
  1565                              <1> 
  1566 00000A86 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1567                              <1> 	
  1568 00000A88 D1E8                <1> 	shr	ax, 1
  1569                              <1> 	;and	ax, ax
  1570 00000A8A 7503                <1> 	jnz	short lff8s2_8
  1571                              <1> 	;jmp	lff8s2_3
  1572                              <1> 	; 15/11/2023
  1573 00000A8C E95FFE              <1> 	jmp	lff8_eof
  1574                              <1> 
  1575                              <1> lff8s2_8:
  1576 00000A8F 89C1                <1> 	mov	cx, ax ; word count
  1577                              <1> lff8s2_1:
  1578 00000A91 AD                  <1> 	lodsw
  1579 00000A92 A3[390D]            <1> 	mov	[previous_val_l], ax
  1580 00000A95 AB                  <1> 	stosw		; original sample (L)
  1581 00000A96 AD                  <1> 	lodsw
  1582 00000A97 A3[3B0D]            <1> 	mov	[previous_val_r], ax
  1583 00000A9A AB                  <1> 	stosw		; original sample (R)
  1584 00000A9B 31D2                <1> 	xor	dx, dx
  1585 00000A9D 31C0                <1> 	xor	ax, ax
  1586 00000A9F 49                  <1> 	dec	cx	; 16 bit
  1587 00000AA0 7408                <1> 	jz	short lff8s2_2
  1588 00000AA2 49                  <1> 	dec	cx	; stereo
  1589 00000AA3 7405                <1> 	jz	short lff8s2_2
  1590 00000AA5 8B04                <1> 	mov	ax, [si]
  1591 00000AA7 8B5402              <1> 	mov	dx, [si+2]
  1592                              <1> lff8s2_2:
  1593 00000AAA A3[3D0D]            <1> 	mov	[new_val_l], ax
  1594 00000AAD 8916[3F0D]          <1> 	mov	[new_val_r], dx
  1595 00000AB1 0306[390D]          <1> 	add	ax, [previous_val_l]
  1596 00000AB5 D1D8                <1> 	rcr	ax, 1
  1597 00000AB7 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample (L)
  1598 00000AB9 0306[390D]          <1> 	add	ax, [previous_val_l]
  1599 00000ABD D1D8                <1> 	rcr	ax, 1	
  1600 00000ABF 89C3                <1> 	mov	bx, ax 	; this is temporary interpolation value (L)
  1601 00000AC1 0306[390D]          <1> 	add	ax, [previous_val_l]
  1602 00000AC5 D1D8                <1> 	rcr	ax, 1
  1603 00000AC7 80EC80              <1> 	sub	ah, 80h
  1604 00000ACA AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1605 00000ACB A1[3F0D]            <1> 	mov	ax, [new_val_r]
  1606 00000ACE 0306[3B0D]          <1> 	add	ax, [previous_val_r]
  1607 00000AD2 D1D8                <1> 	rcr	ax, 1
  1608 00000AD4 89C5                <1> 	mov	bp, ax	; this is interpolated middle (3th) sample (R)
  1609 00000AD6 0306[3B0D]          <1> 	add	ax, [previous_val_r]
  1610 00000ADA D1D8                <1> 	rcr	ax, 1
  1611 00000ADC 50                  <1> 	push	ax ; *	; this is temporary interpolation value (R)
  1612 00000ADD 0306[3B0D]          <1> 	add	ax, [previous_val_r]
  1613 00000AE1 D1D8                <1> 	rcr	ax, 1
  1614 00000AE3 80EC80              <1> 	sub	ah, 80h
  1615 00000AE6 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1616 00000AE7 89D8                <1> 	mov	ax, bx
  1617 00000AE9 01D0                <1> 	add	ax, dx
  1618 00000AEB D1D8                <1> 	rcr	ax, 1
  1619 00000AED 80EC80              <1> 	sub	ah, 80h
  1620 00000AF0 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1621 00000AF1 58                  <1> 	pop	ax ; *
  1622 00000AF2 01E8                <1> 	add	ax, bp
  1623 00000AF4 D1D8                <1> 	rcr	ax, 1
  1624 00000AF6 80EC80              <1> 	sub	ah, 80h
  1625 00000AF9 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1626 00000AFA 89D0                <1> 	mov	ax, dx
  1627 00000AFC 80EC80              <1> 	sub	ah, 80h
  1628 00000AFF AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1629 00000B00 89E8                <1> 	mov	ax, bp
  1630 00000B02 80EC80              <1> 	sub	ah, 80h
  1631 00000B05 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1632 00000B06 A1[3D0D]            <1> 	mov	ax, [new_val_l]
  1633 00000B09 01D0                <1> 	add	ax, dx
  1634 00000B0B D1D8                <1> 	rcr	ax, 1
  1635 00000B0D 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (L)
  1636 00000B0F 01D0                <1> 	add	ax, dx
  1637 00000B11 D1D8                <1> 	rcr	ax, 1
  1638 00000B13 80EC80              <1> 	sub	ah, 80h
  1639 00000B16 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1640 00000B17 A1[3F0D]            <1> 	mov	ax, [new_val_r]
  1641 00000B1A 01E8                <1> 	add	ax, bp
  1642 00000B1C D1D8                <1> 	rcr	ax, 1
  1643 00000B1E 50                  <1> 	push	ax ; ** ; this is temporary interpolation value (R)
  1644 00000B1F 01E8                <1> 	add	ax, bp
  1645 00000B21 D1D8                <1> 	rcr	ax, 1
  1646 00000B23 80EC80              <1> 	sub	ah, 80h
  1647 00000B26 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1648 00000B27 A1[3D0D]            <1> 	mov	ax, [new_val_l]
  1649 00000B2A 01D8                <1> 	add	ax, bx
  1650 00000B2C D1D8                <1> 	rcr	ax, 1
  1651 00000B2E 80EC80              <1> 	sub	ah, 80h
  1652 00000B31 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1653 00000B32 58                  <1> 	pop	ax ; **
  1654 00000B33 0306[3F0D]          <1> 	add	ax, [new_val_r]
  1655 00000B37 D1D8                <1> 	rcr	ax, 1
  1656 00000B39 80EC80              <1> 	sub	ah, 80h
  1657 00000B3C AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1658                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1659 00000B3D E303                <1> 	jcxz	lff8_s2_9
  1660 00000B3F E94FFF              <1> 	jmp	lff8s2_1
  1661                              <1> lff8_s2_9:
  1662 00000B42 E996FD              <1> 	jmp	lff8s2_3
  1663                              <1> 
  1664                              <1> ; .....................
  1665                              <1> 
  1666                              <1> load_16khz_mono_8_bit:
  1667                              <1> 	; 14/11/2023
  1668                              <1> 	; 13/11/2023
  1669 00000B45 F606[9811]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1670                              <1> 					; last of the file?
  1671 00000B4A 7402                <1> 	jz	short lff16m_0		; no
  1672 00000B4C F9                  <1> 	stc
  1673 00000B4D C3                  <1> 	retn
  1674                              <1> 
  1675                              <1> lff16m_0:
  1676 00000B4E 8EC0                <1> 	mov	es, ax ; buffer segment	
  1677 00000B50 31FF                <1> 	xor	di, di
  1678 00000B52 BA[BE11]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1679                              <1> 	; ds = cs
  1680                              <1> 
  1681                              <1> 	; load file into memory
  1682 00000B55 8B0E[4706]          <1>         mov	cx, [loadsize]
  1683 00000B59 8B1E[9611]          <1> 	mov	bx, [filehandle]
  1684 00000B5D B43F                <1>        	mov	ah, 3Fh
  1685 00000B5F CD21                <1> 	int	21h
  1686 00000B61 7243                <1> 	jc	short lff16m_7 ; error !
  1687                              <1> 
  1688 00000B63 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1689                              <1> 	
  1690 00000B65 21C0                <1> 	and	ax, ax
  1691 00000B67 7503                <1> 	jnz	short lff16m_8
  1692                              <1> 	;jmp	lff16m_3
  1693                              <1> 	; 15/11/2023
  1694 00000B69 E982FD              <1> 	jmp	lff16_eof
  1695                              <1> 
  1696                              <1> lff16m_8:
  1697 00000B6C 89C1                <1> 	mov	cx, ax		; byte count
  1698                              <1> lff16m_1:
  1699 00000B6E AC                  <1> 	lodsb
  1700                              <1> 	;mov	[previous_val], al
  1701 00000B6F 88C3                <1> 	mov	bl, al
  1702 00000B71 2C80                <1> 	sub	al, 80h
  1703 00000B73 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1704 00000B76 AB                  <1> 	stosw		; original sample (left channel)
  1705 00000B77 AB                  <1> 	stosw		; original sample (right channel)
  1706                              <1> 	;xor	ax, ax
  1707                              <1> 	; 14/11/22023
  1708 00000B78 B080                <1> 	mov	al, 80h
  1709 00000B7A 49                  <1> 	dec	cx
  1710 00000B7B 7402                <1> 	jz	short lff16m_2
  1711 00000B7D 8A04                <1> 	mov	al, [si]
  1712                              <1> lff16m_2:
  1713                              <1> 	;mov	[new_val], al
  1714 00000B7F 88C7                <1> 	mov	bh, al
  1715                              <1> 	;add	al, [previous_val]
  1716 00000B81 00D8                <1> 	add	al, bl
  1717 00000B83 D0D8                <1> 	rcr	al, 1
  1718 00000B85 88C2                <1> 	mov	dl, al	; this is interpolated middle (temp) sample
  1719                              <1> 	;add	al, [previous_val]
  1720 00000B87 00D8                <1> 	add	al, bl
  1721 00000B89 D0D8                <1> 	rcr	al, 1
  1722 00000B8B 2C80                <1> 	sub	al, 80h
  1723 00000B8D C1E008              <1> 	shl	ax, 8
  1724 00000B90 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1725 00000B91 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1726                              <1> 	;mov	al, [new_val]
  1727 00000B92 88F8                <1> 	mov	al, bh
  1728 00000B94 00D0                <1> 	add	al, dl
  1729 00000B96 D0D8                <1> 	rcr	al, 1
  1730 00000B98 2C80                <1> 	sub	al, 80h
  1731 00000B9A C1E008              <1> 	shl	ax, 8
  1732 00000B9D AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1733 00000B9E AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1734                              <1> 	
  1735                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1736 00000B9F 09C9                <1> 	or	cx, cx
  1737 00000BA1 75CB                <1> 	jnz	short lff16m_1
  1738 00000BA3 E935FD              <1> 	jmp	lff16m_3
  1739                              <1> 
  1740                              <1> lff16m_7:
  1741                              <1> lff16s_7:
  1742 00000BA6 E94CFD              <1> 	jmp	lff16m_5  ; error
  1743                              <1> 
  1744                              <1> load_16khz_stereo_8_bit:
  1745                              <1> 	; 14/11/2023
  1746                              <1> 	; 13/11/2023
  1747 00000BA9 F606[9811]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1748                              <1> 					; last of the file?
  1749 00000BAE 7402                <1> 	jz	short lff16s_0		; no
  1750 00000BB0 F9                  <1> 	stc
  1751 00000BB1 C3                  <1> 	retn
  1752                              <1> 
  1753                              <1> lff16s_0:
  1754 00000BB2 8EC0                <1> 	mov	es, ax ; buffer segment	
  1755 00000BB4 31FF                <1> 	xor	di, di
  1756 00000BB6 BA[BE11]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1757                              <1> 	; ds = cs
  1758                              <1> 
  1759                              <1> 	; load file into memory
  1760 00000BB9 8B0E[4706]          <1>         mov	cx, [loadsize]
  1761 00000BBD 8B1E[9611]          <1> 	mov	bx, [filehandle]
  1762 00000BC1 B43F                <1>        	mov	ah, 3Fh
  1763 00000BC3 CD21                <1> 	int	21h
  1764 00000BC5 72DF                <1> 	jc	short lff16s_7 ; error !
  1765                              <1> 
  1766 00000BC7 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1767                              <1> 	
  1768 00000BC9 D1E8                <1> 	shr	ax, 1
  1769                              <1> 	;and	ax, ax
  1770 00000BCB 7503                <1> 	jnz	short lff16s_8
  1771                              <1> 	;jmp	lff16s_3
  1772                              <1> 	; 15/11/2023
  1773 00000BCD E91EFD              <1> 	jmp	lff16_eof
  1774                              <1> 
  1775                              <1> lff16s_8:
  1776 00000BD0 89C1                <1> 	mov	cx, ax		; word count
  1777                              <1> lff16s_1:
  1778 00000BD2 AC                  <1> 	lodsb
  1779 00000BD3 A2[390D]            <1> 	mov	[previous_val_l], al
  1780 00000BD6 2C80                <1> 	sub	al, 80h
  1781 00000BD8 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1782 00000BDB AB                  <1> 	stosw		; original sample (L)
  1783 00000BDC AC                  <1> 	lodsb
  1784 00000BDD A2[3B0D]            <1> 	mov	[previous_val_r], al
  1785 00000BE0 2C80                <1> 	sub	al, 80h
  1786 00000BE2 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1787 00000BE5 AB                  <1> 	stosw		; original sample (R)
  1788                              <1> 
  1789                              <1> 	;xor	ax, ax
  1790                              <1> 	; 14/11/2023
  1791 00000BE6 B88080              <1> 	mov	ax, 8080h
  1792 00000BE9 49                  <1> 	dec	cx
  1793 00000BEA 7402                <1> 	jz	short lff16s_2
  1794                              <1> 		; convert 8 bit sample to 16 bit sample
  1795 00000BEC 8B04                <1> 	mov	ax, [si]
  1796                              <1> lff16s_2:
  1797 00000BEE A2[3D0D]            <1> 	mov	[new_val_l], al
  1798 00000BF1 8826[3F0D]          <1> 	mov	[new_val_r], ah
  1799 00000BF5 89C3                <1> 	mov	bx, ax
  1800 00000BF7 0206[390D]          <1> 	add	al, [previous_val_l]
  1801 00000BFB D0D8                <1> 	rcr	al, 1
  1802 00000BFD 88C2                <1> 	mov	dl, al	; this is temporary interpolation value (L)
  1803 00000BFF 0206[390D]          <1> 	add	al, [previous_val_l]
  1804 00000C03 D0D8                <1> 	rcr	al, 1
  1805 00000C05 2C80                <1> 	sub	al, 80h
  1806 00000C07 C1E008              <1> 	shl	ax, 8
  1807 00000C0A AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1808 00000C0B 88F8                <1> 	mov	al, bh	; [new_val_r]
  1809 00000C0D 0206[3B0D]          <1> 	add	al, [previous_val_r]
  1810 00000C11 D0D8                <1> 	rcr	al, 1
  1811 00000C13 88C6                <1> 	mov	dh, al	; this is temporary interpolation value (R)
  1812 00000C15 0206[3B0D]          <1> 	add	al, [previous_val_r]
  1813 00000C19 D0D8                <1> 	rcr	al, 1
  1814 00000C1B 2C80                <1> 	sub	al, 80h
  1815 00000C1D C1E008              <1> 	shl	ax, 8
  1816 00000C20 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1817 00000C21 88D0                <1> 	mov	al, dl
  1818 00000C23 00D8                <1> 	add	al, bl	; [new_val_l]
  1819 00000C25 D0D8                <1> 	rcr	al, 1
  1820 00000C27 2C80                <1> 	sub	al, 80h
  1821 00000C29 C1E008              <1> 	shl	ax, 8
  1822 00000C2C AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1823 00000C2D 88F0                <1> 	mov	al, dh
  1824 00000C2F 00F8                <1> 	add	al, bh ; [new_val_r]
  1825 00000C31 D0D8                <1> 	rcr	al, 1
  1826 00000C33 2C80                <1> 	sub	al, 80h
  1827 00000C35 C1E008              <1> 	shl	ax, 8
  1828 00000C38 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1829                              <1> 	
  1830                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1831 00000C39 09C9                <1> 	or	cx, cx
  1832 00000C3B 7595                <1> 	jnz	short lff16s_1
  1833 00000C3D E99BFC              <1> 	jmp	lff16s_3
  1834                              <1> 
  1835                              <1> load_16khz_mono_16_bit:
  1836                              <1> 	; 15/11/2023
  1837                              <1> 	; 13/11/2023
  1838 00000C40 F606[9811]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1839                              <1> 					; last of the file?
  1840 00000C45 7402                <1> 	jz	short lff16m2_0		; no
  1841 00000C47 F9                  <1> 	stc
  1842 00000C48 C3                  <1> 	retn
  1843                              <1> 
  1844                              <1> lff16m2_0:
  1845 00000C49 8EC0                <1> 	mov	es, ax ; buffer segment	
  1846 00000C4B 31FF                <1> 	xor	di, di
  1847 00000C4D BA[BE11]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1848                              <1> 	; ds = cs
  1849                              <1> 
  1850                              <1> 	; load file into memory
  1851 00000C50 8B0E[4706]          <1>         mov	cx, [loadsize]
  1852 00000C54 8B1E[9611]          <1> 	mov	bx, [filehandle]
  1853 00000C58 B43F                <1>        	mov	ah, 3Fh
  1854 00000C5A CD21                <1> 	int	21h
  1855 00000C5C 7240                <1> 	jc	short lff16m2_7 ; error !
  1856                              <1> 
  1857 00000C5E 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1858                              <1> 	
  1859 00000C60 D1E8                <1> 	shr	ax, 1
  1860                              <1> 	;and	ax, ax
  1861 00000C62 7503                <1> 	jnz	short lff16m2_8
  1862                              <1> 	;jmp	lff16m2_3
  1863                              <1> 	; 15/11/2023
  1864 00000C64 E987FC              <1> 	jmp	lff16_eof
  1865                              <1> 
  1866                              <1> lff16m2_8:
  1867 00000C67 89C1                <1> 	mov	cx, ax	; word count
  1868                              <1> lff16m2_1:
  1869 00000C69 AD                  <1> 	lodsw
  1870 00000C6A AB                  <1> 	stosw		; original sample (left channel)
  1871 00000C6B AB                  <1> 	stosw		; original sample (right channel)
  1872 00000C6C 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1873                              <1> 	;mov	[previous_val], ax
  1874 00000C6F 89C3                <1> 	mov	bx, ax	
  1875 00000C71 31C0                <1> 	xor	ax, ax
  1876 00000C73 49                  <1> 	dec	cx
  1877 00000C74 7402                <1> 	jz	short lff16m2_2
  1878 00000C76 8B04                <1> 	mov	ax, [si]
  1879                              <1> lff16m2_2:
  1880 00000C78 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1881 00000C7B 89C5                <1> 	mov	bp, ax	; [new_val]
  1882                              <1> 	;add	ax, [previous_val]
  1883 00000C7D 01D8                <1> 	add	ax, bx
  1884 00000C7F D1D8                <1> 	rcr	ax, 1
  1885 00000C81 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value
  1886                              <1> 	;add	ax, [previous_val]
  1887 00000C83 01D8                <1> 	add	ax, bx
  1888 00000C85 D1D8                <1> 	rcr	ax, 1
  1889 00000C87 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1890 00000C8A AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1891 00000C8B AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1892 00000C8C 89E8                <1> 	mov	ax, bp 
  1893 00000C8E 01D0                <1> 	add	ax, dx
  1894 00000C90 D1D8                <1> 	rcr	ax, 1
  1895 00000C92 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1896 00000C95 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1897 00000C96 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1898                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1899 00000C97 09C9                <1> 	or	cx, cx
  1900 00000C99 75CE                <1> 	jnz	short lff16m2_1
  1901 00000C9B E93DFC              <1> 	jmp	lff16m2_3
  1902                              <1> 
  1903                              <1> lff16m2_7:
  1904                              <1> lff16s2_7:
  1905 00000C9E E954FC              <1> 	jmp	lff16m2_5  ; error
  1906                              <1> 
  1907                              <1> load_16khz_stereo_16_bit:
  1908                              <1> 	; 15/11/2023
  1909                              <1> 	; 13/11/2023
  1910 00000CA1 F606[9811]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1911                              <1> 					; last of the file?
  1912 00000CA6 7402                <1> 	jz	short lff16s2_0		; no
  1913 00000CA8 F9                  <1> 	stc
  1914 00000CA9 C3                  <1> 	retn
  1915                              <1> 
  1916                              <1> lff16s2_0:
  1917 00000CAA 8EC0                <1> 	mov	es, ax ; buffer segment	
  1918 00000CAC 31FF                <1> 	xor	di, di
  1919 00000CAE BA[BE11]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1920                              <1> 	; ds = cs
  1921                              <1> 
  1922                              <1> 	; load file into memory
  1923 00000CB1 8B0E[4706]          <1>         mov	cx, [loadsize]
  1924 00000CB5 8B1E[9611]          <1> 	mov	bx, [filehandle]
  1925 00000CB9 B43F                <1>        	mov	ah, 3Fh
  1926 00000CBB CD21                <1> 	int	21h
  1927 00000CBD 72DF                <1> 	jc	short lff16s2_7 ; error !
  1928                              <1> 
  1929 00000CBF 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1930                              <1> 	
  1931 00000CC1 D1E8                <1> 	shr	ax, 1
  1932                              <1> 	;and	ax, ax
  1933 00000CC3 7503                <1> 	jnz	short lff16s2_8
  1934                              <1> 	;jmp	lff16s2_3
  1935                              <1> 	; 15/11/2023
  1936 00000CC5 E926FC              <1> 	jmp	lff16_eof
  1937                              <1> 
  1938                              <1> lff16s2_8:
  1939 00000CC8 89C1                <1> 	mov	cx, ax		; word count
  1940                              <1> lff16s2_1:
  1941 00000CCA AD                  <1> 	lodsw
  1942 00000CCB AB                  <1> 	stosw		; original sample (L)
  1943 00000CCC 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1944 00000CCF A3[390D]            <1> 	mov	[previous_val_l], ax
  1945 00000CD2 AD                  <1> 	lodsw
  1946 00000CD3 AB                  <1> 	stosw		; original sample (R)
  1947 00000CD4 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1948 00000CD7 A3[3B0D]            <1> 	mov	[previous_val_r], ax
  1949 00000CDA 31D2                <1> 	xor	dx, dx
  1950 00000CDC 31C0                <1> 	xor	ax, ax
  1951 00000CDE 49                  <1> 	dec	cx	; 16 bit
  1952 00000CDF 7408                <1> 	jz	short lff16s2_2
  1953 00000CE1 49                  <1> 	dec	cx	; stereo
  1954 00000CE2 7405                <1> 	jz	short lff16s2_2
  1955 00000CE4 8B04                <1> 	mov	ax, [si]
  1956 00000CE6 8B5402              <1> 	mov	dx, [si+2]
  1957                              <1> lff16s2_2:
  1958 00000CE9 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1959                              <1> 	;mov	[new_val_l], ax
  1960 00000CEC 89C5                <1> 	mov	bp, ax
  1961 00000CEE 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  1962 00000CF1 8916[3F0D]          <1> 	mov	[new_val_r], dx
  1963 00000CF5 0306[390D]          <1> 	add	ax, [previous_val_l]
  1964 00000CF9 D1D8                <1> 	rcr	ax, 1
  1965 00000CFB 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value (L)
  1966 00000CFD 0306[390D]          <1> 	add	ax, [previous_val_l]
  1967 00000D01 D1D8                <1> 	rcr	ax, 1
  1968 00000D03 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  1969 00000D06 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1970 00000D07 A1[3F0D]            <1> 	mov	ax, [new_val_r]
  1971 00000D0A 0306[3B0D]          <1> 	add	ax, [previous_val_r]
  1972 00000D0E D1D8                <1> 	rcr	ax, 1
  1973 00000D10 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (R)
  1974 00000D12 0306[3B0D]          <1> 	add	ax, [previous_val_r]
  1975 00000D16 D1D8                <1> 	rcr	ax, 1
  1976 00000D18 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1977 00000D1B AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1978                              <1> 	;mov	ax, [new_val_l]
  1979 00000D1C 89E8                <1> 	mov	ax, bp
  1980 00000D1E 01D0                <1> 	add	ax, dx
  1981 00000D20 D1D8                <1> 	rcr	ax, 1
  1982 00000D22 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1983 00000D25 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1984 00000D26 A1[3F0D]            <1> 	mov	ax, [new_val_r]
  1985 00000D29 01D8                <1> 	add	ax, bx
  1986 00000D2B D1D8                <1> 	rcr	ax, 1
  1987 00000D2D 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1988 00000D30 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1989                              <1> 	
  1990                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1991 00000D31 09C9                <1> 	or	cx, cx
  1992 00000D33 7595                <1> 	jnz	short lff16s2_1
  1993 00000D35 E9A3FB              <1> 	jmp	lff16s2_3
  1994                              <1> 
  1995                              <1> ; .....................
  1996                              <1> 
  1997                              <1> ; 13/11/2023 (temporary)
  1998                              <1> load_22khz_stereo_16_bit:
  1999                              <1> load_22khz_mono_16_bit:
  2000                              <1> load_22khz_stereo_8_bit:
  2001                              <1> load_22khz_mono_8_bit:
  2002                              <1> load_11khz_stereo_16_bit:
  2003                              <1> load_11khz_mono_16_bit:
  2004                              <1> load_11khz_stereo_8_bit:
  2005                              <1> load_11khz_mono_8_bit:
  2006                              <1> load_44khz_stereo_16_bit:
  2007                              <1> load_44khz_mono_16_bit:
  2008                              <1> load_44khz_stereo_8_bit:
  2009                              <1> load_44khz_mono_8_bit:
  2010                              <1> load_24khz_stereo_16_bit:
  2011                              <1> load_24khz_mono_16_bit:
  2012                              <1> load_24khz_stereo_8_bit:
  2013                              <1> load_24khz_mono_8_bit:
  2014                              <1> load_32khz_stereo_16_bit:
  2015                              <1> load_32khz_mono_16_bit:
  2016                              <1> load_32khz_stereo_8_bit:
  2017                              <1> load_32khz_mono_8_bit:
  2018 00000D38 C3                  <1> 	retn
  2019                              <1> 
  2020                              <1> 
  2021                              <1> ; 13/11/2023
  2022                              <1> previous_val:
  2023 00000D39 0000                <1> previous_val_l: dw 0
  2024 00000D3B 0000                <1> previous_val_r: dw 0
  2025                              <1> new_val:
  2026 00000D3D 0000                <1> new_val_l: dw 0
  2027 00000D3F 0000                <1> new_val_r: dw 0	
  2028                              <1> 	
  2029                              <1> ; --------------------------------------------------------	
  2030                              <1> 		
   452                                  
   453                                  ; UTILS.ASM
   454                                  ;----------------------------------------------------------------------------
   455                                  ;       delay1_4ms - Delay for 1/4 millisecond.
   456                                  ;		    1mS = 1000us
   457                                  ;       Entry:
   458                                  ;         None
   459                                  ;       Exit:
   460                                  ;	  None
   461                                  ;
   462                                  ;       Modified:
   463                                  ;         None
   464                                  ;
   465                                  PORTB			EQU	061h
   466                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
   467                                  
   468                                  delay1_4ms:
   469 00000D41 50                              push    ax 
   470 00000D42 51                              push    cx
   471 00000D43 B91000                          mov     cx, 16			; close enough.
   472 00000D46 E461                    	in	al,PORTB
   473 00000D48 2410                    	and	al,REFRESH_STATUS
   474 00000D4A 88C4                    	mov	ah,al			; Start toggle state
   475 00000D4C 09C9                    	or	cx, cx
   476 00000D4E 7401                    	jz	short _d4ms1
   477 00000D50 41                      	inc	cx			; Throwaway first toggle
   478                                  _d4ms1:	
   479 00000D51 E461                    	in	al,PORTB		; Read system control port
   480 00000D53 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
   481 00000D55 38C4                    	cmp	ah,al
   482 00000D57 74F8                    	je	short _d4ms1		; Wait for state change
   483                                  
   484 00000D59 88C4                    	mov	ah,al			; Update with new state
   485 00000D5B 49                      	dec	cx
   486 00000D5C 75F3                    	jnz	short _d4ms1
   487                                  
   488 00000D5E 59                              pop     cx
   489 00000D5F 58                              pop     ax
   490 00000D60 C3                              retn
   491                                  
   492                                  	; 13/11/2016 - Erdogan Tan
   493                                  write_ac97_dev_info:
   494                                  	; BUS/DEV/FN
   495                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   496                                  	; DEV/VENDOR
   497                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   498                                  
   499 00000D61 30FF                    	xor	bh, bh
   500 00000D63 668B36[B011]            	mov	esi, [dev_vendor]
   501 00000D68 89F0                    	mov	ax, si
   502 00000D6A 88C3                    	mov	bl, al
   503 00000D6C 88DA                    	mov	dl, bl
   504 00000D6E 80E30F                  	and	bl, 0Fh
   505 00000D71 8A87[2910]              	mov	al, [bx+hex_chars]
   506 00000D75 A2[6C10]                	mov	[msgVendorId+3], al
   507 00000D78 88D3                    	mov	bl, dl
   508 00000D7A C0EB04                  	shr	bl, 4
   509 00000D7D 8A87[2910]              	mov	al, [bx+hex_chars]
   510 00000D81 A2[6B10]                	mov	[msgVendorId+2], al
   511 00000D84 88E3                    	mov	bl, ah
   512 00000D86 88DA                    	mov	dl, bl
   513 00000D88 80E30F                  	and	bl, 0Fh
   514 00000D8B 8A87[2910]              	mov	al, [bx+hex_chars]
   515 00000D8F A2[6A10]                	mov	[msgVendorId+1], al
   516 00000D92 88D3                    	mov	bl, dl
   517 00000D94 C0EB04                  	shr	bl, 4
   518 00000D97 8A87[2910]              	mov	al, [bx+hex_chars]
   519 00000D9B A2[6910]                	mov	[msgVendorId], al
   520 00000D9E 66C1EE10                	shr	esi, 16
   521 00000DA2 89F0                    	mov	ax, si
   522 00000DA4 88C3                    	mov	bl, al
   523 00000DA6 88DA                    	mov	dl, bl
   524 00000DA8 80E30F                  	and	bl, 0Fh
   525 00000DAB 8A87[2910]              	mov	al, [bx+hex_chars]
   526 00000DAF A2[7D10]                	mov	[msgDevId+3], al
   527 00000DB2 88D3                    	mov	bl, dl
   528 00000DB4 C0EB04                  	shr	bl, 4
   529 00000DB7 8A87[2910]              	mov	al, [bx+hex_chars]
   530 00000DBB A2[7C10]                	mov	[msgDevId+2], al
   531 00000DBE 88E3                    	mov	bl, ah
   532 00000DC0 88DA                    	mov	dl, bl
   533 00000DC2 80E30F                  	and	bl, 0Fh
   534 00000DC5 8A87[2910]              	mov	al, [bx+hex_chars]
   535 00000DC9 A2[7B10]                	mov	[msgDevId+1], al
   536 00000DCC 88D3                    	mov	bl, dl
   537 00000DCE C0EB04                  	shr	bl, 4
   538 00000DD1 8A87[2910]              	mov	al, [bx+hex_chars]
   539 00000DD5 A2[7A10]                	mov	[msgDevId], al
   540                                  
   541 00000DD8 668B36[AC11]            	mov	esi, [bus_dev_fn]
   542 00000DDD 66C1EE08                	shr	esi, 8
   543 00000DE1 89F0                    	mov	ax, si
   544 00000DE3 88C3                    	mov	bl, al
   545 00000DE5 88DA                    	mov	dl, bl
   546 00000DE7 80E307                  	and	bl, 7 ; bit 0,1,2
   547 00000DEA 8A87[2910]              	mov	al, [bx+hex_chars]
   548 00000DEE A2[A110]                	mov	[msgFncNo+1], al
   549 00000DF1 88D3                    	mov	bl, dl
   550 00000DF3 C0EB03                  	shr	bl, 3
   551 00000DF6 88DA                    	mov	dl, bl
   552 00000DF8 80E30F                  	and	bl, 0Fh
   553 00000DFB 8A87[2910]              	mov	al, [bx+hex_chars]
   554 00000DFF A2[9310]                	mov	[msgDevNo+1], al
   555 00000E02 88D3                    	mov	bl, dl
   556 00000E04 C0EB04                  	shr	bl, 4
   557 00000E07 8A87[2910]              	mov	al, [bx+hex_chars]
   558 00000E0B A2[9210]                	mov	[msgDevNo], al
   559 00000E0E 88E3                    	mov	bl, ah
   560 00000E10 88DA                    	mov	dl, bl
   561 00000E12 80E30F                  	and	bl, 0Fh
   562 00000E15 8A87[2910]              	mov	al, [bx+hex_chars]
   563 00000E19 A2[8710]                	mov	[msgBusNo+1], al
   564 00000E1C 88D3                    	mov	bl, dl
   565 00000E1E C0EB04                  	shr	bl, 4
   566 00000E21 8A87[2910]              	mov	al, [bx+hex_chars]
   567 00000E25 A2[8610]                	mov	[msgBusNo], al
   568                                  
   569 00000E28 A1[A211]                	mov	ax, [NAMBAR]
   570 00000E2B 88C3                    	mov	bl, al
   571 00000E2D 88DA                    	mov	dl, bl
   572 00000E2F 80E30F                  	and	bl, 0Fh
   573 00000E32 8A87[2910]              	mov	al, [bx+hex_chars]
   574 00000E36 A2[B010]                	mov	[msgNamBar+3], al
   575 00000E39 88D3                    	mov	bl, dl
   576 00000E3B C0EB04                  	shr	bl, 4
   577 00000E3E 8A87[2910]              	mov	al, [bx+hex_chars]
   578 00000E42 A2[AF10]                	mov	[msgNamBar+2], al
   579 00000E45 88E3                    	mov	bl, ah
   580 00000E47 88DA                    	mov	dl, bl
   581 00000E49 80E30F                  	and	bl, 0Fh
   582 00000E4C 8A87[2910]              	mov	al, [bx+hex_chars]
   583 00000E50 A2[AE10]                	mov	[msgNamBar+1], al
   584 00000E53 88D3                    	mov	bl, dl
   585 00000E55 C0EB04                  	shr	bl, 4
   586 00000E58 8A87[2910]              	mov	al, [bx+hex_chars]
   587 00000E5C A2[AD10]                	mov	[msgNamBar], al
   588                                  
   589                                  	; 05/11/2023
   590 00000E5F A1[A411]                	mov	ax, [NABMBAR]
   591 00000E62 88C3                    	mov	bl, al
   592 00000E64 88DA                    	mov	dl, bl
   593 00000E66 80E30F                  	and	bl, 0Fh
   594 00000E69 678A83[29100000]        	mov	al, [ebx+hex_chars]
   595 00000E70 A2[BF10]                	mov	[msgNabmBar+3], al
   596 00000E73 88D3                    	mov	bl, dl
   597 00000E75 C0EB04                  	shr	bl, 4
   598 00000E78 678A83[29100000]        	mov	al, [ebx+hex_chars]
   599 00000E7F A2[BE10]                	mov	[msgNabmBar+2], al
   600 00000E82 88E3                    	mov	bl, ah
   601 00000E84 88DA                    	mov	dl, bl
   602 00000E86 80E30F                  	and	bl, 0Fh
   603 00000E89 678A83[29100000]        	mov	al, [ebx+hex_chars]
   604 00000E90 A2[BD10]                	mov	[msgNabmBar+1], al
   605 00000E93 88D3                    	mov	bl, dl
   606 00000E95 C0EB04                  	shr	bl, 4
   607 00000E98 678A83[29100000]        	mov	al, [ebx+hex_chars]
   608 00000E9F A2[BC10]                	mov	[msgNabmBar], al
   609                                  
   610                                  	; 24/11/2016
   611 00000EA2 30E4                    	xor	ah, ah
   612 00000EA4 A0[9911]                	mov	al, [ac97_int_ln_reg]
   613 00000EA7 B10A                    	mov	cl, 10
   614 00000EA9 F6F1                    	div	cl
   615 00000EAB 0106[C710]              	add	[msgIRQ], ax
   616 00000EAF 20C0                    	and	al, al
   617 00000EB1 7508                    	jnz	short _pmi
   618 00000EB3 A0[C810]                	mov	al, [msgIRQ+1]
   619 00000EB6 B420                    	mov	ah, ' '
   620 00000EB8 A3[C710]                	mov	[msgIRQ], ax
   621                                  _pmi:
   622 00000EBB BA[3A10]                        mov	dx, msgAC97Info
   623 00000EBE B409                            mov     ah, 9
   624 00000EC0 CD21                            int     21h
   625 00000EC2 C3                              retn
   626                                  
   627                                  write_sample_rate:
   628                                  	; ax = sample rate (hertz)
   629                                  
   630 00000EC3 31D2                    	xor	dx, dx
   631 00000EC5 B90A00                  	mov	cx, 10
   632 00000EC8 F7F1                    	div	cx
   633 00000ECA 0016[DD10]              	add	[msgHertz+4], dl
   634 00000ECE 29D2                    	sub	dx, dx
   635 00000ED0 F7F1                    	div	cx
   636 00000ED2 0016[DC10]              	add	[msgHertz+3], dl
   637 00000ED6 29D2                    	sub	dx, dx
   638 00000ED8 F7F1                    	div	cx
   639 00000EDA 0016[DB10]              	add	[msgHertz+2], dl
   640 00000EDE 29D2                    	sub	dx, dx
   641 00000EE0 F7F1                    	div	cx
   642 00000EE2 0016[DA10]              	add	[msgHertz+1], dl
   643 00000EE6 0006[D910]              	add	[msgHertz], al
   644                                  	
   645 00000EEA BA[CC10]                        mov     dx, msgSampleRate
   646 00000EED B409                            mov     ah, 9
   647 00000EEF CD21                            int     21h
   648                                  
   649                                  	; 19/11/2016
   650 00000EF1 BA[F210]                	mov	dx, msg16Bits
   651 00000EF4 803E[B811]10            	cmp	byte [bps], 16
   652 00000EF9 7403                    	je	short wsr_1
   653 00000EFB BA[E310]                	mov	dx, msg8Bits
   654                                  wsr_1:
   655 00000EFE B409                            mov     ah, 9
   656 00000F00 CD21                            int     21h
   657                                  
   658 00000F02 BA[EB10]                	mov	dx, msgMono
   659 00000F05 803E[B611]01            	cmp	byte [stmo], 1
   660 00000F0A 7403                    	je	short wsr_2
   661 00000F0C BA[FB10]                	mov	dx, msgStereo		
   662                                  wsr_2:
   663 00000F0F B409                            mov     ah, 9
   664 00000F11 CD21                            int     21h
   665                                  
   666 00000F13 C3                              retn
   667                                  
   668                                  ;detect_codec:
   669                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   670                                  ;	mov	eax, 7Ch
   671                                  ;	call	codec_read
   672                                  ;       shl     eax, 16
   673                                  ;       mov     [codec_id], eax
   674                                  ;
   675                                  ;	mov	eax, 7Eh
   676                                  ;       call	codec_read
   677                                  ;       or      eax, [codec_id]
   678                                  ;       mov     [codec_chip_id], eax
   679                                  ;       and     eax, 0FFFFFF00h
   680                                  ;
   681                                  ;       mov     edi, codecs
   682                                  ;_dcb:
   683                                  ;       mov     ebx, [di]
   684                                  ;       test    ebx, ebx
   685                                  ;       jz      short _dco_unknown
   686                                  ;
   687                                  ;       cmp     eax, ebx
   688                                  ;       jne     short _dco_next
   689                                  ;       mov     ax, [di+4]
   690                                  ;       mov     [codec_vendor_ids], ax
   691                                  ;       movzx   esi, ax
   692                                  ;       call	print_msg
   693                                  ;       
   694                                  ;	mov	ax, [di+6]
   695                                  ;	call	detect_chip
   696                                  ;       retn
   697                                  ;
   698                                  ;_dco_next:
   699                                  ;       add     di, 8
   700                                  ;       jmp     short _dcb
   701                                  ;
   702                                  ;_dco_unknown:
   703                                  ;       mov    word [codec_vendor_ids], ac_unknown
   704                                  ;       mov    word [codec_chip_ids], chip_unknown
   705                                  ;       mov     esi, chip_unknown
   706                                  ;	call	print_msg
   707                                  ;       mov     eax, [codec_chip_id]
   708                                  ;       call    dword2str
   709                                  ;       call	print_msg
   710                                  ;       retn
   711                                  
   712                                  ;detect_chip:
   713                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   714                                  ;	mov	di, ax ; chip_tab
   715                                  ;       mov     eax, [codec_chip_id]
   716                                  ;       and     ax, 0FFh
   717                                  ;_dch1:
   718                                  ;       mov     bx, [di]
   719                                  ;       cmp     bx, 0FFh
   720                                  ;       je      short _dch_unknown
   721                                  ;
   722                                  ;       cmp     ax, bx
   723                                  ;       jne     short _dch_next
   724                                  ;       mov     ax, [di+2]
   725                                  ;       mov     [codec_chip_ids], ax
   726                                  ;       mov     si, ax
   727                                  ;       call	print_msg
   728                                  ;       retn
   729                                  
   730                                  ;_dch_next:
   731                                  ;       add     di, 4
   732                                  ;       jmp     short _dch1
   733                                  ;
   734                                  ;_dch_unknown:
   735                                  ;       mov    word [codec_chip_ids], chip_unknown
   736                                  ;       mov     si, chip_unknown
   737                                  ;       call	print_msg
   738                                  ;       mov     eax, [codec_chip_id]
   739                                  ;       call    dword2str
   740                                  ;       call	print_msg
   741                                  ;       retn
   742                                  
   743                                  ; 10/11/2023
   744                                  ; 09/11/2023
   745                                  ; 06/11/2023
   746                                  %if 1
   747                                  
   748                                  ac97_int_handler:
   749                                  	; 11/11/2023
   750                                  	; 10/11/2023
   751                                  	; 17/02/2016
   752 00000F14 6650                    	push	eax	; 11/11/2023
   753 00000F16 52                      	push	dx
   754                                  	; 05/11/2023	
   755                                  	;push	cx
   756                                  	;push	bx
   757                                  	;push	si
   758                                  	;push	di
   759                                  
   760                                  	; 10/11/2023
   761                                  	; EOI at first
   762 00000F17 B020                    	mov	al, 20h
   763 00000F19 F606[9911]08            	test	byte [ac97_int_ln_reg], 8
   764 00000F1E 7402                    	jz	short _ih_0
   765 00000F20 E6A0                    	out 	0A0h, al ; 20h	; EOI
   766                                  _ih_0:
   767 00000F22 E620                    	out	20h, al  ; 20h	; EOI
   768                                  
   769                                  	; 11/11/2023
   770                                  	; 09/11/2023
   771 00000F24 BA3000                  	mov	dx, GLOB_STS_REG
   772 00000F27 0316[A411]                      add	dx, [NABMBAR]
   773 00000F2B 66ED                    	in	eax, dx
   774                                  	
   775                                  	; 09/11/2023,
   776 00000F2D 6683F8FF                        cmp	eax, 0FFFFFFFFh ; -1
   777 00000F31 741D                    	je	short _ih_2
   778                                  	
   779 00000F33 A840                    	test	al, 40h		; PCM Out Interrupt
   780 00000F35 7509                    	jnz	short _ih_1
   781                                  
   782 00000F37 6685C0                  	test	eax, eax
   783 00000F3A 7414                    	jz	short _ih_2
   784                                  
   785                                   	;mov	dx, GLOB_STS_REG
   786                                          ;add	dx, [NABMBAR]
   787 00000F3C 66EF                    	out	dx, eax
   788 00000F3E EB10                    	jmp	short _ih_2
   789                                  
   790                                  	; .....
   791                                  	;mov	al, 1
   792                                  	; 10/11/2023
   793                                  	;mov	[tloop], al  ; 1
   794                                  
   795                                  	;cmp	[inside], al ; 1
   796                                  	;jnb	short _ih_3	; busy
   797                                  
   798                                  	;mov	[inside], al ; 1
   799                                  	;
   800                                  	;; 09/11/2023
   801                                          ;mov	dx, [NABMBAR]
   802                                          ;add	dx, PO_SR_REG	; set pointer to Status reg
   803                                  	;in	al, dx
   804                                  	;; 10/11/2023
   805                                  	;;;out	dx, eax
   806                                  	;;out	dx, al		; clear interrupt event
   807                                  	;			; (by writing 1 to same bits)
   808                                  	;
   809                                  	;;mov	[pcm_irq_status], al ; 05/11/2023
   810                                  	;test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   811                                  	;jz	short _ih_2
   812                                  	; .....
   813                                  
   814                                  _ih_1:
   815                                  	; 11/11/2023
   816 00000F40 6650                    	push	eax
   817                                  
   818                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   819                                  	;mov	dx, PO_SR_REG
   820                                          ;add	dx, [NABMBAR]
   821                                  	;out	dx, ax
   822                                  
   823                                  	; 10/11/2023
   824                                  	; 28/11/2016 - Erdogan Tan
   825 00000F42 E8DDF7                  	call	tuneLoop
   826                                  
   827                                  	; 11/11/2023
   828 00000F45 6658                    	pop	eax
   829 00000F47 BA3000                  	mov	dx, GLOB_STS_REG
   830 00000F4A 0316[A411]                      add	dx, [NABMBAR]
   831 00000F4E 66EF                    	out	dx, eax
   832                                  _ih_2:
   833                                  	; 11/11/2023
   834 00000F50 8B16[A411]              	mov	dx, [NABMBAR]
   835 00000F54 83C216                  	add	dx, PO_SR_REG	; set pointer to Status reg
   836 00000F57 B81C00                  	mov	ax, 1Ch
   837 00000F5A EF                      	out	dx, ax
   838                                  
   839                                  ;	; 10/11/2023
   840                                  ;	mov	al, 20h
   841                                  ;	test	byte [ac97_int_ln_reg], 8
   842                                  ;	jz	short _ih_3
   843                                  ;	out 	0A0h, al ; 20h	; EOI
   844                                  ;_ih_3:
   845                                  ;	out	20h, al  ; 20h	; EOI
   846                                  ;_ih_4:
   847                                  	;mov	byte [inside], 0
   848                                  	;pop	di
   849                                  	;pop	si
   850                                  	;pop	bx
   851                                  	;pop	cx
   852 00000F5B 5A                      	pop	dx
   853 00000F5C 6658                    	pop	eax ; 11/11/2023
   854 00000F5E CF                      	iret
   855                                  
   856                                  %endif
   857                                  
   858                                  ; 10/11/2023
   859                                  ; 09/11/2023
   860                                  ; 06/11/2023
   861                                  %if 0
   862                                  
   863                                  ac97_int_handler:
   864                                  	; 10/11/2023
   865                                  	; 17/02/2016
   866                                  	push	ax	; 09/11/2023
   867                                  	push	dx
   868                                  	; 05/11/2023
   869                                  	;push	cx
   870                                  	;push	bx
   871                                  	;push	si
   872                                  	;push	di
   873                                  
   874                                  	; 10/11/2023
   875                                  	; EOI at first
   876                                  	mov	al, 20h
   877                                  	test	byte [ac97_int_ln_reg], 8
   878                                  	jz	short _ih_0
   879                                  	out 	0A0h, al ; 20h	; EOI
   880                                  _ih_0:
   881                                  	out	20h, al  ; 20h	; EOI
   882                                  
   883                                  	mov	al, 1
   884                                  
   885                                  	; 10/11/2023
   886                                  	;mov	[tloop], al  ; 1
   887                                  
   888                                  	cmp	[inside], al ; 1
   889                                  	jnb	short _ih_3	; busy
   890                                  
   891                                  	mov	[inside], al ; 1
   892                                  
   893                                  	; 09/11/2023
   894                                          mov	dx, [NABMBAR]
   895                                          add	dx, PO_SR_REG	; set pointer to Status reg
   896                                  	in	al, dx
   897                                  	; 10/11/2023
   898                                  	;out	dx, eax
   899                                  	out	dx, al		; clear interrupt event
   900                                  				; (by writing 1 to same bits)
   901                                  
   902                                  	;mov	[pcm_irq_status], al ; 05/11/2023
   903                                  	test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   904                                  	jz	short _ih_2
   905                                  	
   906                                  	; 09/11/2023
   907                                  	;mov	dx, GLOB_STS_REG
   908                                          ;add	dx, [NABMBAR]
   909                                  	;in	eax, dx
   910                                  	
   911                                  	; 09/11/2023,
   912                                          ;cmp	eax, 0FFFFFFFFh ; -1
   913                                  	;je	short _ih_2
   914                                  	
   915                                  	;test	al, 40h		; PCM Out Interrupt
   916                                  	;jz	short _ih_2
   917                                  _ih_1:
   918                                  	; 10/11/2023
   919                                  	; 28/11/2016 - Erdogan Tan
   920                                  	call	tuneLoop
   921                                  	;jnc	short _ih_2
   922                                  	;dec	byte [tloop] ; [tloop] = 0
   923                                  _ih_2:
   924                                  	mov	byte [inside], 0
   925                                  _ih_3:
   926                                  	;pop	di
   927                                  	;pop	si
   928                                  	;pop	bx
   929                                  	;pop	cx
   930                                  	pop	dx
   931                                  	pop	ax ; 09/11/2023
   932                                  	iret
   933                                  
   934                                  %endif
   935                                  
   936                                  
   937                                  ac97_stop:
   938                                  	; 11/11/2023
   939                                  	; 09/11/2023
   940                                  	; 05/11/2023
   941                                  	; 04/11/2023 
   942                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
   943                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
   944                                  ;_ac97_stop:
   945                                  
   946                                  	; 11/11/2023
   947 00000F5F 8B16[A211]              	mov	dx, [NAMBAR]
   948                                  	;add	dx, 0 ; ac_reg_0 ; reset register
   949 00000F63 EF                      	out	dx, ax
   950                                  
   951                                  	; 04/11/2023
   952                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
   953                                  	; 11/06/2017
   954 00000F64 30C0                    	xor	al, al ; 0
   955 00000F66 E80D00                  	call	ac97_po_cmd
   956                                  
   957                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
   958                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
   959 00000F69 B81C00                  	mov     ax, 1Ch
   960 00000F6C 8B16[A411]              	mov     dx, [NABMBAR]
   961 00000F70 83C216                  	add     dx, PO_SR_REG
   962 00000F73 EF                      	out     dx, ax
   963                                  
   964                                  	; 11/06/2017
   965 00000F74 B002                    	mov     al, RR
   966                                  ac97_po_cmd:
   967                                  	; 11/06/2017
   968                                  	; 29/05/2017
   969 00000F76 8B16[A411]              	mov     dx, [NABMBAR]
   970 00000F7A 83C21B                          add     dx, PO_CR_REG		; PCM out control register
   971 00000F7D EE                      	out	dx, al
   972 00000F7E C3                      	retn
   973                                  
   974                                  print_msg:
   975                                  	; 13/11/2016 - Erdogan Tan 
   976                                  	; esi = ASCIIZ text address
   977                                  	;
   978 00000F7F BB0700                  	mov	bx, 7h
   979 00000F82 B40E                    	mov	ah, 0Eh 
   980                                  pm_next_char:
   981 00000F84 AC                      	lodsb
   982 00000F85 20C0                    	and	al, al
   983 00000F87 7404                    	jz	short pm_retn
   984 00000F89 CD10                    	int	10h
   985 00000F8B EBF7                    	jmp	short pm_next_char
   986                                  pm_retn:
   987 00000F8D C3                      	retn
   988                                  
   989                                  ; 06/11/2023
   990                                  ;dword2str:
   991                                  ;	; 13/11/2016 - Erdogan Tan 
   992                                  ;	; eax = dword value
   993                                  ;	;
   994                                  ;	call	dwordtohex
   995                                  ;	mov	[dword_str], edx
   996                                  ;	mov	[dword_str+4], eax
   997                                  ;	mov	si, dword_str
   998                                  ;	retn
   999                                  
  1000                                  	; trdos386.s (unix386.s) - 10/05/2015
  1001                                  	; Convert binary number to hexadecimal string
  1002                                  
  1003                                  bytetohex:
  1004                                  	; INPUT ->
  1005                                  	; 	AL = byte (binary number)
  1006                                  	; OUTPUT ->
  1007                                  	;	AX = hexadecimal string
  1008                                  	;
  1009 00000F8E 53                      	push	bx
  1010 00000F8F 30FF                    	xor	bh, bh
  1011 00000F91 88C3                    	mov	bl, al
  1012 00000F93 C0EB04                  	shr	bl, 4
  1013 00000F96 8A9F[2910]              	mov	bl, [bx+hex_chars] 	 	
  1014 00000F9A 86D8                    	xchg	bl, al
  1015 00000F9C 80E30F                  	and	bl, 0Fh
  1016 00000F9F 8AA7[2910]              	mov	ah, [bx+hex_chars] 
  1017 00000FA3 5B                      	pop	bx	
  1018 00000FA4 C3                      	retn
  1019                                  
  1020                                  wordtohex:
  1021                                  	; INPUT ->
  1022                                  	; 	AX = word (binary number)
  1023                                  	; OUTPUT ->
  1024                                  	;	EAX = hexadecimal string
  1025                                  	;
  1026 00000FA5 53                      	push	bx
  1027 00000FA6 30FF                    	xor	bh, bh
  1028 00000FA8 86E0                    	xchg	ah, al
  1029 00000FAA 50                      	push	ax
  1030 00000FAB 88E3                    	mov	bl, ah
  1031 00000FAD C0EB04                  	shr	bl, 4
  1032 00000FB0 8A87[2910]              	mov	al, [bx+hex_chars] 	 	
  1033 00000FB4 88E3                    	mov	bl, ah
  1034 00000FB6 80E30F                  	and	bl, 0Fh
  1035 00000FB9 8AA7[2910]              	mov	ah, [bx+hex_chars]
  1036 00000FBD 66C1E010                	shl	eax, 16
  1037 00000FC1 58                      	pop	ax
  1038 00000FC2 5B                      	pop	bx
  1039 00000FC3 EBC9                    	jmp	short bytetohex
  1040                                  
  1041                                  ; 06/11/2023
  1042                                  ;dwordtohex:
  1043                                  ;	; INPUT ->
  1044                                  ;	; 	EAX = dword (binary number)
  1045                                  ;	; OUTPUT ->
  1046                                  ;	;	EDX:EAX = hexadecimal string
  1047                                  ;	;
  1048                                  ;	push	eax
  1049                                  ;	shr	eax, 16
  1050                                  ;	call	wordtohex
  1051                                  ;	mov	edx, eax
  1052                                  ;	pop	eax
  1053                                  ;	call	wordtohex
  1054                                  ;	retn
  1055                                  
  1056                                  _DATA:
  1057                                  
  1058                                  ; 24/11/2016
  1059                                  ;	IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  1060 00000FC5 08090A0B0C0D0E0F70-     irq_int	 db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  1060 00000FCE 71727374757677     
  1061                                  
  1062                                  ; 17/02/2017
  1063                                  ; Valid ICH device IDs
  1064                                  
  1065                                  valid_ids:
  1066 00000FD5 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h 
  1067 00000FD9 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h 
  1068 00000FDD 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h 
  1069 00000FE1 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h 
  1070 00000FE5 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  1071 00000FE9 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  1072 00000FED 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  1073 00000FF1 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  1074 00000FF5 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  1075 00000FF9 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  1076                                  ; 03/11/2023 - Erdogan Tan
  1077 00000FFD 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  1078 00001001 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  1079 00001005 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  1080 00001009 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  1081 0000100D 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  1082 00001011 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  1083 00001015 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  1084 00001019 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  1085 0000101D DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  1086 00001021 DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  1087 00001025 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  1088                                  
  1089                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  1090                                  
  1091                                  ; 13/11/2016
  1092 00001029 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  1092 00001032 3941424344454600   
  1093 0000103A 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  1093 00001043 6F20436F6E74726F6C-
  1093 0000104C 6C6572202620436F64-
  1093 00001055 656320496E666F0D0A 
  1094 0000105E 56656E646F72204944-     		db "Vendor ID: "
  1094 00001067 3A20               
  1095 00001069 303030306820446576-     msgVendorId	db "0000h Device ID: "
  1095 00001072 6963652049443A20   
  1096 0000107A 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  1097 00001081 4275733A20              		db "Bus: "
  1098 00001086 303068204465766963-     msgBusNo	db "00h Device: "
  1098 0000108F 653A20             
  1099 00001092 3030682046756E6374-     msgDevNo	db "00h Function: "
  1099 0000109B 696F6E3A20         
  1100 000010A0 303068                  msgFncNo	db "00h"
  1101 000010A3 0D0A                    		db 0Dh, 0Ah
  1102                                  ; 05/11/2023	
  1103 000010A5 4E414D4241523A20        		db "NAMBAR: "
  1104 000010AD 303030306820            msgNamBar	db "0000h "
  1105 000010B3 4E41424D4241523A20      		db "NABMBAR: "
  1106 000010BC 303030306820495251-     msgNabmBar	db "0000h IRQ: "
  1106 000010C5 3A20               
  1107 000010C7 3030                    msgIRQ		dw 3030h
  1108 000010C9 0D0A24                  		db 0Dh, 0Ah, "$"
  1109 000010CC 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
  1109 000010D5 74653A20           
  1110 000010D9 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
  1110 000010E2 24                 
  1111 000010E3 3820626974732024        msg8Bits	db "8 bits ", "$" 
  1112 000010EB 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
  1113 000010F2 313620626974732024      msg16Bits	db "16 bits ", "$" 
  1114 000010FB 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  1115                                  
  1116                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  1117                                  ;codec_id	dd 0
  1118                                  ;codec_chip_id	dd 0
  1119                                  ;codec_vendor_ids dw 0
  1120                                  ;codec_chip_ids	dw 0
  1121                                  
  1122 00001104 3030303030303030        dword_str	 dd 30303030h, 30303030h
  1123 0000110C 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  1124                                  
  1125                                  ;ac_unknown     db 'unknown manufacturer',13,10,0
  1126                                  ;ac_Realtek     db 'Realtek Semiconductor',13,10,0
  1127                                  ;ac_Analog      db 'Analog Devices',13,10,0
  1128                                  ;ac_CMedia      db 'C-Media Electronics',13,10,0
  1129                                  ;ac_Cirrus      db 'Cirrus Logic',13,10,0
  1130                                  ;ac_Wolfson     db 'Wolfson Microelectronics',13,10,0
  1131                                  ;ac_VIA         db 'VIA Technologies',13,10,0
  1132                                  ;ac_SigmaTel    db 'SigmaTel',13,10,0
  1133                                  ;ac_eMicro      db 'eMicro',13,10,0
  1134                                  ;
  1135                                  ;chip_unknown   db 'unknown codec id ', 0
  1136                                  
  1137                                  ;CHIP_REALTEK   equ 414C4700h
  1138                                  ;CHIP_CMEDIA    equ 434D4900h
  1139                                  ;CHIP_VIA       equ 56494100h
  1140                                  
  1141                                  ;codecs        dd CHIP_CMEDIA
  1142                                  ;	       dw ac_CMedia, chips_CMedia
  1143                                  ;              dd CHIP_REALTEK
  1144                                  ;	       dw ac_Realtek, chips_Realtek
  1145                                  ;              dd CHIP_VIA
  1146                                  ;	       dw ac_VIA, chips_VIA
  1147                                  ;              dd 0
  1148                                  
  1149                                  ;chips_Realtek dw 10h, chip_ALC201a
  1150                                  ;              dw 20h, chip_ALC650
  1151                                  ;              dw 21h, chip_ALC650D
  1152                                  ;              dw 22h, chip_ALC650E
  1153                                  ;              dw 23h, chip_ALC650F
  1154                                  ;              dw 60h, chip_ALC655
  1155                                  ;              dw 80h, chip_ALC658
  1156                                  ;              dw 81h, chip_ALC658D
  1157                                  ;              dw 90h, chip_ALC850
  1158                                  ;              dw 0FFh
  1159                                  
  1160                                  ;chips_CMedia  dw 41h, chip_CM9738
  1161                                  ;              dw 61h, chip_CM9739
  1162                                  ;              dw 69h, chip_CM9780
  1163                                  ;              dw 78h, chip_CM9761
  1164                                  ;              dw 82h, chip_CM9761
  1165                                  ;              dw 83h, chip_CM9761
  1166                                  ;              dw 0FFh
  1167                                  
  1168                                  ;chips_VIA     dw 61h, chip_VIA1612A
  1169                                  ;              dw 0FFh
  1170                                  
  1171                                  ;Realtek
  1172                                  ;chip_ALC201a    db 'ALC201a',0dh,0ah,00h
  1173                                  ;chip_ALC650     db 'ALC650 ',0dh,0ah,00h
  1174                                  ;chip_ALC650D    db 'ALC650D',0dh,0ah,00h
  1175                                  ;chip_ALC650E    db 'ALC650E',0dh,0ah,00h
  1176                                  ;chip_ALC650F    db 'ALC650F',0dh,0ah,00h
  1177                                  ;chip_ALC655     db 'ALC655 ',0dh,0ah,00h
  1178                                  ;chip_ALC658     db 'ALC658 ',0dh,0ah,00h
  1179                                  ;chip_ALC658D    db 'ALC658D',0dh,0ah,00h
  1180                                  ;chip_ALC850     db 'ALC850 ',0dh,0ah,00h
  1181                                  
  1182                                  ;CMedia
  1183                                  ;chip_CM9738     db 'CMI9738', 0dh,0ah,0
  1184                                  ;chip_CM9739     db 'CMI9739', 0dh,0ah,0
  1185                                  ;chip_CM9780     db 'CMI9780', 0dh,0ah,0
  1186                                  ;chip_CM9761     db 'CMI9761', 0dh,0ah,0
  1187                                  
  1188                                  ;VIA
  1189                                  ;chip_VIA1612A   db 'VIA1612A',13,10,0
  1190                                  
  1191                                  ; 11/11/2023
  1192                                  msg_init_err:
  1193 00001110 0D0A                    	db	CR, LF
  1194 00001112 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  1194 0000111B 726F6C6C65722F436F-
  1194 00001124 64656320696E697469-
  1194 0000112D 616C697A6174696F6E-
  1194 00001136 206572726F722021   
  1195 0000113E 0D0A24                  	db	CR, LF, "$"
  1196                                  
  1197                                  ; 12/11/2023
  1198                                  msg_no_vra:
  1199 00001141 0D0A                    	db	CR, LF
  1200 00001143 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  1200 0000114C 70706F72742021204F-
  1200 00001155 6E6C79203438206B48-
  1200 0000115E 5A2073616D706C6520-
  1200 00001167 726174652073757070-
  1200 00001170 6F727465642021     
  1201 00001177 0D0A24                  	db	CR, LF, "$"
  1202                                  
  1203                                  ; 17/02/2017
  1204                                  bss_start:
  1205                                  
  1206                                  ABSOLUTE bss_start
  1207                                  
  1208                                  alignb 2
  1209                                  
  1210                                  ; 28/11/2016
  1211                                  
  1212 0000117A <res 1Ch>               smpRBuff:	resw 14 ; 19/11/2016 - Erdogan Tan
  1213                                  
  1214 00001196 ????                    filehandle:	resw 1
  1215                                  
  1216 00001198 ??                      flags:		resb 1
  1217                                  ; 06/11/2023
  1218 00001199 ??                      ac97_int_ln_reg: resb 1
  1219                                  
  1220                                  ; 09/11/2023
  1221                                  ; 06/11/2023
  1222                                  ;pcm_irq_status: resb 1	; 05/11/2023
  1223 0000119A ??                      inside:		resb 1
  1224 0000119B ??                      tloop:		resb 1	; 10/11/2023
  1225                                  
  1226                                  ; 09/11/2023
  1227                                  ; 04/11/2023 - 06/11/2023
  1228 0000119C ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  1229 0000119E ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address	
  1230                                  
  1231                                  ; 17/02/2017
  1232                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  1233                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  1234                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  1235                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  1236 000011A2 ????                    NAMBAR:		resw 1			; BAR for mixer
  1237 000011A4 ????                    NABMBAR:	resw 1			; BAR for bus master regs
  1238                                  
  1239                                  ; 256 byte buffer for descriptor list
  1240 000011A6 ????                    BDL_BUFFER:	resw 1			; segment of our 256byte BDL buffer
  1241 000011A8 ????                    WAV_BUFFER1:	resw 1			; segment of our WAV storage
  1242                                  ; 64k buffers for wav file storage
  1243 000011AA ????                    WAV_BUFFER2:	resw 1			; segment of 2nd wav buffer
  1244                                  
  1245                                  ; 06/11/2023
  1246                                  ;tBuff:		resb 1
  1247                                  ;ac97_int_ln_reg: resb 1
  1248                                  
  1249                                  ; 12/11/2016 - Erdogan Tan
  1250                                  
  1251 000011AC ????????                bus_dev_fn:	resd 1
  1252 000011B0 ????????                dev_vendor:	resd 1
  1253                                  ; 06/11/2023
  1254                                  ;stats_cmd:	resw 1 ; 17/02/2017
  1255                                  ; 05/11/2023
  1256                                  ;ac97_io_base:	resw 1
  1257 000011B4 ????                    sample_rate:	resw 1
  1258                                  
  1259                                  ; 19/11/2016
  1260 000011B6 ????                    stmo:		resw 1 
  1261 000011B8 ????                    bps:		resw 1
  1262                                  
  1263                                  ; 08/11/2023
  1264                                  ; 07/11/2023
  1265 000011BA ??                      fbs_shift:	resb 1
  1266                                  ; 09/11/2023
  1267 000011BB ??                      b_indicator:	resb 1
  1268                                  ; 10/11/2023
  1269 000011BC ??                      LVI:		resb 1
  1270 000011BD ??                      		resb 1 ; 10/11/2023 
  1271                                  
  1272                                  ;fbs_seg:	resw 1
  1273                                  ;fbs_off:	resw 1
  1274                                  
  1275                                  ;alignb 2
  1276                                  
  1277                                  ; 32 kilo bytes for temporay buffer
  1278                                  ; (for stereo-mono, 8bit/16bit corrections)
  1279 000011BE <res 8000h>             temp_buffer:	resb 32768
  1280                                  
  1281                                  ;alignb 16
  1282                                  EOF:
