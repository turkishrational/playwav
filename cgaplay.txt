     1                                  ; ****************************************************************************
     2                                  ; cgaplay.s - TRDOS 386 (TRDOS v2.0.9) WAV PLAYER - Video Mode 13h
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; CGAPLAY.PRG ! AC'97 (ICH) .WAV PLAYER program by Erdogan TAN
     5                                  ;
     6                                  ; 27/12/2024				- play music from multiple wav files -
     7                                  ;
     8                                  ; [ Last Modification: 18/01/2025 ]
     9                                  ;
    10                                  ; Modified from VGAPLAY3.PRG .wav player program by Erdogan Tan, 30/12/2024
    11                                  ;
    12                                  ; ****************************************************************************
    13                                  ; nasm cgaplay.s -l cgaplay.txt -o CGAPLAY.PRG -Z error.txt
    14                                  
    15                                  ; 30/12/2024
    16                                  ; vgaplay3.s
    17                                  ; 27/12/2024
    18                                  ; vgaplay2.s : DMA buffer tracking (instead of user's audio buffer)
    19                                  ; 18/12/2024
    20                                  ; ac97play.s : TUNELOOP version (playing without AC97 interrupt)
    21                                  
    22                                  ; vgaplay.s (26/12/2024) - play music from multiple wav files -
    23                                  ; dplayvga.s (25/12/2024) - play music from single wav file -
    24                                  ; ac97play.s (18/12/2024) - play music from multiple wav files -
    25                                  
    26                                  ; 07/12/2024 - playwav9.s - interrupt (srb) + tuneloop version
    27                                  ; ------------------------------------------------------------
    28                                  ; INTERRUPT (SRB) + TUNELOOP version ; 24/11/2024 (PLAYWAV9.ASM)
    29                                  ;	(running in DOSBOX, VIRTUALBOX, QEMU is ok)
    30                                  ; Signal Response Byte = message/signal to user about an event/interrupt
    31                                  ;	    as requested (TuneLoop procedure continuously checks this SRB)
    32                                  ; (TRDOS 386 v2 feature is used here as very simple interrupt handler output)
    33                                  
    34                                  ; ------------------------------------------------------------
    35                                  
    36                                  ; 30/11/2024
    37                                  ; 20/08/2024 ; TRDOS 386 v2.0.9
    38                                  ; 29/04/2016
    39                                  _ver 	equ 0
    40                                  _exit 	equ 1
    41                                  _fork 	equ 2
    42                                  _read 	equ 3
    43                                  _write	equ 4
    44                                  _open	equ 5
    45                                  _close 	equ 6
    46                                  _wait 	equ 7
    47                                  _creat 	equ 8
    48                                  _link 	equ 9
    49                                  _unlink	equ 10
    50                                  _exec	equ 11
    51                                  _chdir	equ 12
    52                                  _time 	equ 13
    53                                  _mkdir 	equ 14
    54                                  _chmod	equ 15
    55                                  _chown	equ 16
    56                                  _break	equ 17
    57                                  _stat	equ 18
    58                                  _seek	equ 19
    59                                  _tell 	equ 20
    60                                  _mount	equ 21
    61                                  _umount	equ 22
    62                                  _setuid	equ 23
    63                                  _getuid	equ 24
    64                                  _stime	equ 25
    65                                  _quit	equ 26
    66                                  _intr	equ 27
    67                                  _fstat	equ 28
    68                                  _emt 	equ 29
    69                                  _mdate 	equ 30
    70                                  _video 	equ 31
    71                                  _audio	equ 32
    72                                  _timer	equ 33
    73                                  _sleep	equ 34
    74                                  _msg    equ 35
    75                                  _geterr	equ 36
    76                                  _fpsave	equ 37
    77                                  _pri	equ 38
    78                                  _rele	equ 39
    79                                  _fff	equ 40
    80                                  _fnf	equ 41
    81                                  _alloc	equ 42
    82                                  _dalloc equ 43
    83                                  _calbac equ 44
    84                                  _dma	equ 45
    85                                  _stdio  equ 46
    86                                  
    87                                  ; ------------------------------------------------------------
    88                                  
    89                                  %macro sys 1-4
    90                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)
    91                                      ; 03/09/2015
    92                                      ; 13/04/2015
    93                                      ; Retro UNIX 386 v1 system call.
    94                                      %if %0 >= 2
    95                                          mov ebx, %2
    96                                          %if %0 >= 3
    97                                              mov ecx, %3
    98                                              %if %0 = 4
    99                                                 mov edx, %4
   100                                              %endif
   101                                          %endif
   102                                      %endif
   103                                      mov eax, %1
   104                                      ;int 30h
   105                                      int 40h ; TRDOS 386 (TRDOS v2.0)
   106                                  %endmacro
   107                                  
   108                                  ; Retro UNIX 386 v1 system call format:
   109                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
   110                                  
   111                                  ; ------------------------------------------------------------
   112                                  
   113                                  ; player internal variables and other equates.
   114                                  BUFFERSIZE	equ 65536
   115                                  ENDOFFILE	equ 1		; flag for knowing end of file
   116                                  
   117                                  ; ------------------------------------------------------------
   118                                  
   119                                  [BITS 32] ; 32-bit intructions
   120                                  
   121                                  [ORG 0]
   122                                  
   123                                  START_CODE:
   124                                  	; Prints the Credits Text.
   125                                  	sys	_msg, Credits, 255, 0Bh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000000 BB[902C0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000005 B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000000A BA0B000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000000F B823000000          <1>  mov eax, %1
   104                              <1> 
   105 00000014 CD40                <1>  int 40h
   126                                  
   127                                  	; clear bss
   128 00000016 BF[D8320000]            	mov	edi, bss_start
   129 0000001B B976010000              	mov	ecx, (bss_end - bss_start)/4
   130 00000020 31C0                    	xor	eax, eax
   131 00000022 F3AB                    	rep	stosd
   132                                  
   133                                  ; -------------------------------------------------------------
   134                                  
   135                                  	; 21/12/2024
   136                                  	; Detect (& Enable) AC'97 Audio Device
   137 00000024 E88E070000              	call	DetectAC97
   138 00000029 731B                    	jnc	short ac97_hardware_ready
   139                                  
   140                                  	; 30/11/2024
   141                                  	; 30/05/2024
   142                                  _dev_not_ready:
   143                                  	; couldn't find the audio device!
   144                                  	sys	_msg, noDevMsg, 255, 0Fh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000002B BB[322D0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000030 B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00000035 BA0F000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000003A B823000000          <1>  mov eax, %1
   104                              <1> 
   105 0000003F CD40                <1>  int 40h
   145 00000041 E975040000                      jmp     Exit
   146                                  
   147                                  ac97_hardware_ready:
   148 00000046 E8A30D0000              	call	write_audio_dev_info
   149                                  
   150                                  ; -------------------------------------------------------------
   151                                  
   152                                  	; 30/12/2024
   153                                  	;;;
   154                                  	; DIRECT VGA MEMORY ACCESS
   155                                  	; bl = 0, bh = 5
   156                                  	; Direct access/map to VGA memory (0A0000h)
   157                                  
   158                                  	sys	_video, 0500h
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000004B BB00050000          <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97                              <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000050 B81F000000          <1>  mov eax, %1
   104                              <1> 
   105 00000055 CD40                <1>  int 40h
   159 00000057 3D00000A00              	cmp	eax, 0A0000h
   160 0000005C 7405                    	je	short _a
   161                                  
   162                                  	; 30/12/2024
   163 0000005E E9A0040000              	jmp	trdos386_error
   164                                  
   165                                  _a:
   166                                  	;; Set Video Mode to 13h
   167                                  	;sys	_video, 0813h
   168                                  	;cmp	eax, 14h 
   169                                  	;je	short mode_13h_set_ok
   170                                  
   171                                  	; set VGA mode by using int 31h
   172 00000063 66B81300                	mov	ax, 13h	; mode 13h ; 
   173 00000067 CD31                    	int	31h	; real mode: int 10h
   174                                  
   175                                  ; -------------------------------------------------------------
   176                                  
   177                                  mode_13h_set_ok:
   178                                  	; 30/12/2024
   179                                  	; 24/12/2024 (setting for wave lighting points)
   180                                  	;mov	eax, 0A0000h
   181                                  	;;add	eax, 12*8*320
   182                                  	;add	eax, (13*8*320)+(2*320)
   183                                  			; wave graphics start (top) line/row
   184                                  			; 64 volume levels
   185                                  	;mov	[graphstart], eax
   186                                  	; 30/12/2024
   187                                  	;mov	dword [graphstart], 0A0000h+(13*8*320)+(4*320)
   188                                  	; 01/01/2025
   189 00000069 C705[C8320000]0073-     	mov	dword [graphstart], 0A0000h+(11*8*320)+(4*320)
   189 00000071 0A00               
   190                                  
   191                                  ; -------------------------------------------------------------
   192                                  
   193                                  	; 25/12/2024
   194                                  	; 28/11/2024
   195                                  Player_InitalizePSP:
   196                                  	; 30/11/2024
   197                                  	; (TRDOS 386 -Retro UNIX 386- argument transfer method)
   198                                  	; (stack: argc,argv0addr,argv1addr,argv2addr ..
   199                                  	;			.. argv0text, argv1text ..) 
   200                                  	; ---- argc, argv[] ----
   201 00000073 89E6                    	mov	esi, esp
   202 00000075 AD                      	lodsd
   203 00000076 83F802                  	cmp	eax, 2 ; two arguments 
   204                                  		; (program file name & mod file name)
   205 00000079 0F8245040000            	jb	pmsg_usage ; nothing to do
   206                                  	;mov	[argc], al
   207 0000007F C1E002                  	shl	eax, 2 ; *4
   208 00000082 01E0                    	add	eax, esp
   209                                  	; eax = last argument's address pointer
   210 00000084 A3[28380000]            	mov	[argvl], eax ; last wav file (argument)
   211 00000089 8935[20380000]          	mov	[argv], esi ; current argument (PRG file name)
   212 0000008F AD                      	lodsd	; skip program (PRG) file name
   213 00000090 8935[24380000]          	mov	[argvf], esi ; 1st wav file (argument)
   214                                  
   215                                  	; 30/12/2024
   216                                  Player_ParseParameters:
   217 00000096 EB2A                    	jmp	short Player_ParseNextParameter
   218                                  	; 25/12/2024
   219                                  check_p_command:
   220                                  	; 07/12/2024
   221 00000098 8B35[20380000]          	mov	esi, [argv]
   222                                  	;
   223 0000009E 803D[EA370000]50          	cmp	byte [command], 'P'
   224 000000A5 7410                    	je	short Player_ParsePreviousParameter
   225                                      
   226                                  	; 07/12/2024
   227                                  	; 30/11/2024
   228                                  	;mov	esi, [argv] ; current argument (wav file) ptr
   229 000000A7 83C604                  	add	esi, 4
   230 000000AA 3B35[28380000]          	cmp	esi, [argvl] ; last argument (wav file) ptr
   231 000000B0 7610                    	jna	short Player_ParseNextParameter
   232                                  jmp_Player_Quit:
   233 000000B2 E9D0040000              	jmp	Player_Quit
   234                                  
   235                                  Player_ParsePreviousParameter:
   236                                  	; 29/11/2024
   237                                  	;mov	byte [command], 0
   238                                  	; 30/11/2024
   239                                  	;mov	esi, [argv] ; 07/12/2024	
   240 000000B7 3B35[24380000]          	cmp	esi, [argvf] ; first argument (wav file) ptr
   241 000000BD 7603                    	jna	short Player_ParseNextParameter
   242 000000BF 83EE04                  	sub	esi, 4
   243                                  Player_ParseNextParameter:
   244                                  	; 30/11/2024
   245 000000C2 8935[20380000]          	mov	[argv], esi  ; set as current argument
   246                                  
   247                                  	; 01/12/2024
   248 000000C8 8B36                    	mov	esi, [esi]
   249                                  
   250                                  	; 30/12/2024
   251                                  	; 29/11/2024
   252 000000CA E83C000000              	call	GetFileName
   253                                  	;jcxz	jmp_Player_Quit
   254 000000CF E3E1                    	jecxz	jmp_Player_Quit ; 30/11/2024
   255                                  
   256                                  	; 30/12/2024
   257                                          ; open existing file
   258                                  	; 28/11/2024
   259 000000D1 BA[2C380000]            	mov	edx, wav_file_name
   260 000000D6 E82C070000                      call	openFile ; no error? ok.
   261 000000DB 7376                            jnc	getwavparms	; 14/11/2024
   262                                  
   263                                  	; 29/11/2024
   264 000000DD 803D[EB370000]00        	cmp	byte [filecount], 0
   265 000000E4 77B2                    	ja	short check_p_command
   266                                  
   267                                  	; 25/12/2024
   268                                  	; 21/12/2024
   269 000000E6 E894040000              	call	set_text_mode
   270                                  	; file not found!
   271                                  	; 30/11/2024
   272                                  	sys	_msg, noFileErrMsg, 255, 0Ch
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000000EB BB[5D2D0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000000F0 B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000000F5 BA0C000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000000FA B823000000          <1>  mov eax, %1
   104                              <1> 
   105 000000FF CD40                <1>  int 40h
   273 00000101 E9B5030000                      jmp     Exit
   274                                  
   275                                  _exit_:
   276 00000106 E9AB030000              	jmp	terminate
   277                                  
   278                                  ; -------------------------------------------------------------
   279                                  
   280                                  	; 26/12/2024
   281                                  	; 25/12/2024
   282                                  	; 30/11/2024 (32bit)
   283                                  	; 29/11/2024
   284                                  	; 30/05/2024
   285                                  GetFileName:
   286 0000010B BF[2C380000]            	mov	edi, wav_file_name 
   287                                  	; 30/11/2024
   288                                  	;mov	esi, [argv]
   289 00000110 31C9                    	xor	ecx, ecx ; 0
   290                                  ScanName:
   291 00000112 AC                      	lodsb
   292                                  	;test	al, al
   293                                  	;jz	short a_4
   294                                  	; 29/11/2024
   295 00000113 3C0D                    	cmp	al, 0Dh
   296 00000115 7638                    	jna	short a_4
   297 00000117 3C20                    	cmp	al, 20h
   298 00000119 74F7                    	je	short ScanName	; scan start of name.
   299 0000011B AA                      	stosb
   300 0000011C B4FF                    	mov	ah, 0FFh
   301                                  	;;;
   302                                  	; 14/11/2024
   303                                  	; (max. path length = 64 bytes for MSDOS ?) (*)
   304                                  	;xor	ecx, ecx ; 0
   305                                  	;;;
   306                                  a_0:	
   307 0000011E FEC4                    	inc	ah
   308                                  a_1:
   309                                  	;;;
   310                                  	; 14/11/2024
   311 00000120 41                      	inc	ecx
   312                                  	;;;
   313 00000121 AC                      	lodsb
   314 00000122 AA                      	stosb
   315 00000123 3C2E                    	cmp	al, '.'
   316 00000125 74F7                    	je	short a_0
   317                                  	; 29/11/2024
   318 00000127 3C20                    	cmp	al, 20h
   319                                  	;and	al, al
   320                                  	;jnz	short a_1
   321                                  	;;;
   322                                  	; 14/11/2024
   323 00000129 7613                    	jna	short a_3
   324 0000012B 20E4                    	and	ah, ah
   325 0000012D 7406                    	jz	short a_2
   326 0000012F 3C2F                    	cmp	al, '/'	; 14/12/2024
   327 00000131 7502                    	jne	short a_2
   328 00000133 B400                    	mov	ah, 0
   329                                  a_2:
   330 00000135 80F94B                  	cmp	cl, 75	; 64+8+'.'+3 -> offset 75 is the last chr
   331 00000138 72E6                    	jb	short a_1
   332                                  	; 29/11/2024
   333 0000013A 29C9                    	sub	ecx, ecx
   334 0000013C EB11                    	jmp	short a_4
   335                                  a_3:
   336                                  	; 29/11/2024
   337 0000013E 4F                      	dec	edi
   338                                  	;;;
   339 0000013F 08E4                    	or	ah, ah		; if period NOT found,
   340 00000141 750C                    	jnz	short a_4 	; then add a .WAV extension.
   341                                  SetExt:
   342                                  	; 29/11/2024
   343                                  	;dec	edi
   344 00000143 C7072E574156            	mov	dword [edi], '.WAV'
   345                                  				; ! 64+12 is DOS limit
   346                                  				; but writing +4 must not
   347                                  				; destroy the following data	 
   348                                  	;mov	byte [edi+4], 0	; so, 80 bytes path + 0 is possible here
   349                                  	; 29/11/2024
   350 00000149 83C104                  	add	ecx, 4
   351 0000014C 83C704                  	add	edi, 4
   352                                  a_4:	
   353 0000014F C60700                  	mov	byte [edi], 0
   354                                  	; 30/11/2024
   355 00000152 C3                      	retn
   356                                  
   357                                  ; -------------------------------------------------------------
   358                                  
   359                                  getwavparms:
   360                                  	; 14/11/2024
   361 00000153 E8E1060000                     	call    getWAVParameters
   362 00000158 72AC                    	jc	short _exit_		; nothing to do
   363                                  
   364                                  	; 17/11/2024
   365 0000015A B304                    	mov	bl, 4
   366 0000015C 2A1D[0C380000]          	sub	bl, byte [WAVE_BlockAlign]
   367                                  			; = 0 for 16 bit stereo
   368                                  			; = 2 for 8 bit stereo or 16 bit mono
   369                                  			; = 3 for 8 bit mono	
   370                                  
   371 00000162 D0EB                    	shr	bl, 1	;  0 -->  0,  2 -->  1,  3 -->  1
   372                                  	; 15/11/2024
   373 00000164 80D300                  	adc	bl, 0	; 3 --> 1 --> 2
   374 00000167 881D[7E380000]          	mov	byte [fbs_shift], bl	; = 2 mono and 8 bit
   375                                  					; = 0 stereo and 16 bit
   376                                  					; = 1 mono or 8 bit
   377                                  	; 29/12/2024
   378                                  	; 30/05/2024
   379 0000016D E828080000              	call	codecConfig		; unmute codec, set rates.
   380 00000172 0F8269030000            	jc	init_err
   381                                  
   382                                  ; -------------------------------------------------------------
   383                                  
   384                                  StartPlay:
   385                                  	; 30/12/2024
   386 00000178 C605[DF370000]01        	mov	byte [wpoints], 1
   387                                  
   388                                  	;;;
   389                                  	; 09/12/2024
   390 0000017F B834290000              	mov	eax, 10548 ; (48000*10/182)*4
   391 00000184 803D[E9370000]00        	cmp	byte [VRA], 0
   392 0000018B 7614                    	jna	short _w ; 48kHZ (interpolation)
   393                                  	;
   394 0000018D 66A1[04380000]          	mov	ax, [WAVE_SampleRate]
   395 00000193 B90A000000              	mov	ecx, 10
   396 00000198 F7E1                    	mul	ecx
   397 0000019A B1B6                    	mov	cl, 182
   398 0000019C F7F1                    	div	ecx
   399                                  	; ax = samples per 1/18.2 second
   400                                  	;mov	cl, byte [WAVE_BlockAlign]
   401                                  	; 09/12/2024 
   402                                  	;mov	cl, 4 ; 16 bit, stereo
   403                                  	;mul	ecx
   404 0000019E C1E002                  	shl	eax, 2 ; * 4
   405                                  _w:
   406 000001A1 A3[C4320000]            	mov	[wpoints_dif], eax ; buffer read differential (distance)
   407                                  				; for wave volume leds update
   408                                  				; (byte stream per 1/18.2 second)
   409                                  
   410                                  ; -------------------------------------------------------------
   411                                  
   412                                  	; 25/12/2024
   413 000001A6 FE05[EB370000]          	inc	byte [filecount]
   414 000001AC C605[EA370000]00        	mov	byte [command], 0
   415                                  	; 30/12/2024
   416 000001B3 C605[D5320000]FF        	mov	byte [pbprev], -1
   417                                  
   418                                  ; -------------------------------------------------------------
   419                                  
   420                                  	; 07/12/2024 (playwav9.s)
   421                                  
   422                                  	; 18/11/2023 (ich_wav4.asm)
   423                                  	; 13/11/2023 (ich_wav3.asm)
   424                                  
   425 000001BA 803D[E9370000]01        	cmp	byte [VRA], 1
   426 000001C1 7226                    	jb	short chk_sample_rate
   427                                  
   428                                  playwav_48_khz:
   429 000001C3 C705[8C380000]-         	mov	dword [loadfromwavfile], loadFromFile
   429 000001C9 [200D0000]         
   430                                  	;mov	dword [loadsize], 0 ; 65536
   431                                  	;;;
   432                                  	; 17/11/2024
   433                                  	;mov	word [buffersize], 32768
   434                                  	;mov	ax, BUFFERSIZE/2 ; 32760
   435                                  	; 30/11/2024
   436                                  	;mov	eax, BUFFERSIZE/2 ; 32768
   437                                  	; 07/12/2024
   438 000001CD B800000100              	mov	eax, BUFFERSIZE ; 65536
   439 000001D2 A3[94380000]            	mov	[buffersize], eax	; 16 bit samples
   440                                  	; 07/12/2024
   441                                  	;shl	eax, 1			; bytes
   442 000001D7 8A0D[7E380000]          	mov	cl, [fbs_shift]
   443 000001DD D3E8                    	shr	eax, cl 
   444                                  	;mov	[loadsize], ax ; 16380 or 32760 or 65520
   445 000001DF A3[90380000]            	mov	[loadsize], eax ; 16384 or 32768 or 65536
   446                                  	;;;
   447                                  	;jmp	PlayNow ; 30/05/2024
   448                                  	; 07/12/2024
   449 000001E4 E95F020000              	jmp	Player_Template
   450                                  
   451                                  chk_sample_rate:
   452                                  	; set conversion parameters
   453                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   454 000001E9 66A1[04380000]          	mov	ax, [WAVE_SampleRate]
   455 000001EF 663D80BB                	cmp	ax, 48000
   456 000001F3 74CE                    	je	short playwav_48_khz
   457                                  chk_22khz:
   458 000001F5 663D2256                	cmp	ax, 22050
   459 000001F9 7545                    	jne	short chk_11khz
   460 000001FB 803D[0E380000]08        	cmp	byte [WAVE_BitsPerSample], 8
   461 00000202 7615                    	jna	short chk_22khz_1
   462 00000204 BB[001D0000]            	mov	ebx, load_22khz_stereo_16_bit
   463 00000209 803D[02380000]01        	cmp	byte [WAVE_NumChannels], 1
   464 00000210 751A                    	jne	short chk_22khz_2
   465 00000212 BB[6D1C0000]            	mov	ebx, load_22khz_mono_16_bit
   466 00000217 EB13                    	jmp	short chk_22khz_2
   467                                  chk_22khz_1:
   468 00000219 BB[E01B0000]            	mov	ebx, load_22khz_stereo_8_bit
   469 0000021E 803D[02380000]01        	cmp	byte [WAVE_NumChannels], 1
   470 00000225 7505                    	jne	short chk_22khz_2
   471 00000227 BB[511B0000]            	mov	ebx, load_22khz_mono_8_bit
   472                                  chk_22khz_2:
   473 0000022C B85A1D0000              	mov	eax, 7514  ; (442*17)
   474 00000231 BA25000000              	mov	edx, 37
   475 00000236 B911000000              	mov	ecx, 17
   476 0000023B E9DB010000              	jmp	set_sizes
   477                                  chk_11khz:
   478 00000240 663D112B                	cmp	ax, 11025
   479 00000244 7545                    	jne	short chk_44khz
   480 00000246 803D[0E380000]08        	cmp	byte [WAVE_BitsPerSample], 8
   481 0000024D 7615                    	jna	short chk_11khz_1
   482 0000024F BB[341F0000]            	mov	ebx, load_11khz_stereo_16_bit
   483 00000254 803D[02380000]01        	cmp	byte [WAVE_NumChannels], 1
   484 0000025B 751A                    	jne	short chk_11khz_2
   485 0000025D BB[B51E0000]            	mov	ebx, load_11khz_mono_16_bit
   486 00000262 EB13                    	jmp	short chk_11khz_2
   487                                  chk_11khz_1:
   488 00000264 BB[301E0000]            	mov	ebx, load_11khz_stereo_8_bit
   489 00000269 803D[02380000]01        	cmp	byte [WAVE_NumChannels], 1 
   490 00000270 7505                    	jne	short chk_11khz_2
   491 00000272 BB[B71D0000]            	mov	ebx, load_11khz_mono_8_bit
   492                                  chk_11khz_2:
   493 00000277 B8AD0E0000              	mov	eax, 3757  ; (221*17)
   494 0000027C BA4A000000              	mov	edx, 74
   495 00000281 B911000000              	mov	ecx, 17
   496 00000286 E990010000              	jmp	set_sizes
   497                                  chk_44khz:
   498 0000028B 663D44AC                	cmp	ax, 44100
   499 0000028F 7545                    	jne	short chk_16khz
   500 00000291 803D[0E380000]08        	cmp	byte [WAVE_BitsPerSample], 8
   501 00000298 7615                    	jna	short chk_44khz_1
   502 0000029A BB[53210000]            	mov	ebx, load_44khz_stereo_16_bit
   503 0000029F 803D[02380000]01        	cmp	byte [WAVE_NumChannels], 1
   504 000002A6 751A                    	jne	short chk_44khz_2
   505 000002A8 BB[D4200000]            	mov	ebx, load_44khz_mono_16_bit
   506 000002AD EB13                    	jmp	short chk_44khz_2
   507                                  chk_44khz_1:
   508 000002AF BB[51200000]            	mov	ebx, load_44khz_stereo_8_bit
   509 000002B4 803D[02380000]01        	cmp	byte [WAVE_NumChannels], 1
   510 000002BB 7505                    	jne	short chk_44khz_2
   511 000002BD BB[CF1F0000]            	mov	ebx, load_44khz_mono_8_bit
   512                                  chk_44khz_2:
   513                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   514 000002C2 B8D93A0000              	mov	eax, 15065 ; (655*23)
   515                                  	; 18/11/2023 ((file size + bss + stack) <= 64KB)
   516                                  	;mov	ax, 14076 ; (612*23)
   517                                  	; 17/11/2024
   518                                  	;mov	ax, 12650 ; (550*23)
   519 000002C7 BA19000000              	mov	edx, 25
   520 000002CC B917000000              	mov	ecx, 23
   521 000002D1 E945010000              	jmp	set_sizes
   522                                  chk_16khz:
   523 000002D6 663D803E                	cmp	ax, 16000
   524 000002DA 7545                    	jne	short chk_8khz
   525 000002DC 803D[0E380000]08        	cmp	byte [WAVE_BitsPerSample], 8
   526 000002E3 7615                    	jna	short chk_16khz_1
   527 000002E5 BB[60160000]            	mov	ebx, load_16khz_stereo_16_bit
   528 000002EA 803D[02380000]01        	cmp	byte [WAVE_NumChannels], 1 
   529 000002F1 751A                    	jne	short chk_16khz_2
   530 000002F3 BB[D9150000]            	mov	ebx, load_16khz_mono_16_bit
   531 000002F8 EB13                    	jmp	short chk_16khz_2
   532                                  chk_16khz_1:
   533 000002FA BB[19150000]            	mov	ebx, load_16khz_stereo_8_bit
   534 000002FF 803D[02380000]01        	cmp	byte [WAVE_NumChannels], 1
   535 00000306 7505                    	jne	short chk_16khz_2
   536 00000308 BB[94140000]            	mov	ebx, load_16khz_mono_8_bit
   537                                  chk_16khz_2:
   538                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   539 0000030D B855150000              	mov	eax, 5461
   540                                  	; 17/11/2024
   541                                  	;mov	ax, 5460
   542 00000312 BA03000000              	mov	edx, 3
   543 00000317 B901000000              	mov	ecx, 1
   544 0000031C E9FA000000              	jmp	set_sizes
   545                                  chk_8khz:
   546 00000321 663D401F                	cmp	ax, 8000
   547 00000325 7545                    	jne	short chk_24khz
   548 00000327 803D[0E380000]08        	cmp	byte [WAVE_BitsPerSample], 8
   549 0000032E 7615                    	jna	short chk_8khz_1
   550 00000330 BB[43130000]            	mov	ebx, load_8khz_stereo_16_bit
   551 00000335 803D[02380000]01        	cmp	byte [WAVE_NumChannels], 1
   552 0000033C 751A                    	jne	short chk_8khz_2
   553 0000033E BB[6D120000]            	mov	ebx, load_8khz_mono_16_bit
   554 00000343 EB13                    	jmp	short chk_8khz_2
   555                                  chk_8khz_1:
   556 00000345 BB[37110000]            	mov	ebx, load_8khz_stereo_8_bit
   557 0000034A 803D[02380000]01        	cmp	byte [WAVE_NumChannels], 1 
   558 00000351 7505                    	jne	short chk_8khz_2
   559 00000353 BB[49100000]            	mov	ebx, load_8khz_mono_8_bit
   560                                  chk_8khz_2:
   561 00000358 B8AA0A0000              	mov	eax, 2730
   562 0000035D BA06000000              	mov	edx, 6
   563 00000362 B901000000              	mov	ecx, 1
   564 00000367 E9AF000000              	jmp	set_sizes
   565                                  chk_24khz:
   566 0000036C 663DC05D                	cmp	ax, 24000
   567 00000370 7563                    	jne	short chk_32khz
   568 00000372 803D[0E380000]08        	cmp	byte [WAVE_BitsPerSample], 8
   569 00000379 7615                    	jna	short chk_24khz_1
   570                                  	; 18/01/2025 (BugFix)
   571                                  	; bx -> ebx
   572 0000037B BB[A2180000]            	mov	ebx, load_24khz_stereo_16_bit
   573 00000380 803D[02380000]01        	cmp	byte [WAVE_NumChannels], 1
   574 00000387 751A                    	jne	short chk_24khz_2
   575 00000389 BB[39180000]            	mov	ebx, load_24khz_mono_16_bit
   576 0000038E EB13                    	jmp	short chk_24khz_2
   577                                  chk_24khz_1:
   578 00000390 BB[A9170000]            	mov	ebx, load_24khz_stereo_8_bit
   579 00000395 803D[02380000]01        	cmp	byte [WAVE_NumChannels], 1 
   580 0000039C 7505                    	jne	short chk_24khz_2
   581 0000039E BB[3C170000]            	mov	ebx, load_24khz_mono_8_bit
   582                                  chk_24khz_2:
   583                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   584 000003A3 B800200000              	mov	eax, 8192
   585                                  	; 17/11/2024
   586                                  	;mov	ax, 8190
   587 000003A8 BA02000000              	mov	edx, 2
   588 000003AD B901000000              	mov	ecx, 1
   589 000003B2 EB67                    	jmp	short set_sizes
   590                                  
   591                                  	; 07/12/2024
   592                                  vra_needed:
   593                                  	; 30/11/2024 (TRDOS 386, ax -> eax)
   594                                  	; 13/11/2023
   595 000003B4 58                      	pop	eax ; discard return address to the caller
   596                                  	; 30/05/2024
   597                                  vra_err:
   598                                  	; 21/12/2024
   599 000003B5 E8C5010000              	call	set_text_mode
   600                                  	; 30/11/2024
   601                                  	sys	_msg, msg_no_vra, 255, 0Fh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000003BA BB[C72D0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000003BF B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000003C4 BA0F000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000003C9 B823000000          <1>  mov eax, %1
   104                              <1> 
   105 000003CE CD40                <1>  int 40h
   602 000003D0 E9E6000000              	jmp	Exit
   603                                  
   604                                  chk_32khz:
   605 000003D5 663D007D                	cmp	ax, 32000
   606 000003D9 75D9                    	jne	short vra_needed
   607 000003DB 803D[0E380000]08        	cmp	byte [WAVE_BitsPerSample], 8
   608 000003E2 7615                    	jna	short chk_32khz_1
   609 000003E4 BB[BB1A0000]            	mov	ebx, load_32khz_stereo_16_bit
   610 000003E9 803D[02380000]01        	cmp	byte [WAVE_NumChannels], 1
   611 000003F0 751A                    	jne	short chk_32khz_2
   612 000003F2 BB[4B1A0000]            	mov	ebx, load_32khz_mono_16_bit
   613 000003F7 EB13                    	jmp	short chk_32khz_2
   614                                  chk_32khz_1:
   615 000003F9 BB[A8190000]            	mov	ebx, load_32khz_stereo_8_bit
   616 000003FE 803D[02380000]01        	cmp	byte [WAVE_NumChannels], 1
   617 00000405 7505                    	jne	short chk_32khz_2
   618 00000407 BB[2F190000]            	mov	ebx, load_32khz_mono_8_bit
   619                                  chk_32khz_2:
   620                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   621 0000040C B8AA2A0000              	mov	eax, 10922
   622                                  	; 17/11/2024
   623                                  	;mov	ax, 10920
   624 00000411 BA03000000              	mov	edx, 3
   625 00000416 B902000000              	mov	ecx, 2
   626                                  	;jmp	short set_sizes
   627                                  set_sizes:
   628                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   629                                  	;;;
   630                                  	; 17/11/2024
   631 0000041B 51                      	push	ecx
   632 0000041C B102                    	mov	cl, 2
   633 0000041E 2A0D[7E380000]          	sub	cl, [fbs_shift]
   634                                  		; = 2 for 16 bit stereo
   635                                  		; = 1 for 16 bit mono or 8 bit stereo
   636                                  		; = 0 for 8 bit mono
   637 00000424 D3E0                    	shl	eax, cl
   638 00000426 59                      	pop	ecx	
   639 00000427 A3[90380000]            	mov	[loadsize], eax	; (one) read count in bytes
   640                                  	;;;
   641 0000042C F7E2                    	mul	edx
   642 0000042E 83F901                  	cmp	ecx, 1
   643 00000431 7402                    	je	short s_2
   644                                  s_1:
   645 00000433 F7F1                    	div	ecx
   646                                  s_2:
   647                                  	;;;
   648                                  	; eax = byte count of (to be) converted samples 
   649                                  	
   650                                  	; 17/11/2024
   651                                  	;;;
   652 00000435 8A0D[7E380000]          	mov	cl, [fbs_shift]
   653                                  
   654 0000043B D3E0                    	shl	eax, cl
   655                                  		; *1 for 16 bit stereo
   656                                  		; *2 for 16 bit mono or 8 bit stereo
   657                                  		; *4 for for 8 bit mono
   658                                  	;;;
   659                                  
   660                                  	; eax = 16 bit stereo byte count (target buffer size)
   661                                  	
   662                                  	; 07/12/2024
   663                                  	;shr	eax, 1	; buffer size is 16 bit sample count
   664 0000043D A3[94380000]            	mov	[buffersize], eax ; buffer size in bytes
   665 00000442 891D[8C380000]          	mov	[loadfromwavfile], ebx
   666                                  
   667                                  ; -------------------------------------------------------------
   668                                  
   669                                  	; 30/12/2024
   670                                  Player_Template:
   671                                  	; 21/12/2024
   672 00000448 E8DF000000              	call	clearscreen
   673 0000044D E8E9000000              	call	drawplayingscreen
   674                                  
   675                                  	; 14/11/2024
   676 00000452 E80C250000              	call	SetTotalTime
   677 00000457 E8D9250000              	call	UpdateFileInfo
   678                                  
   679                                  ; -------------------------------------------------------------
   680                                  
   681                                  	; 30/12/2024 (cgaplay.s)
   682                                  	; 29/12/2024 (vgaplay3.s)
   683                                  	; 18/12/2024 (ac97play.s)
   684                                  PlayNow:
   685                                  	; 01/12/2024 (32bit)
   686                                  	; 14/11/2024
   687                                  	;mov	al, 3	; 0 = max, 31 = min
   688                                  	; 14/12/2024
   689 0000045C A0[46290000]            	mov	al, [volume]
   690 00000461 E83D030000              	call	SetPCMOutVolume@
   691                                  	; 15/11/2024
   692                                  	;;call	SetMasterVolume
   693                                  	;call	SetPCMOutVolume
   694                                  
   695                                  	;;;
   696                                  	; 14/11/2024
   697 00000466 E8D0260000              	call	UpdateProgressBar
   698                                  	;;;
   699                                  
   700                                   	; 30/05/2024
   701                                  	; playwav4.asm
   702                                  _2:	
   703 0000046B E873240000              	call	check4keyboardstop	; flush keyboard buffer
   704 00000470 72F9                    	jc	short _2		; 07/11/2023
   705                                  
   706                                  ; play the .wav file. Most of the good stuff is in here.
   707                                  
   708                                  	; 05/12/2024
   709                                  	; 02/12/2024
   710                                  	;mov	eax, [_bdl_buffer]	; BDL_BUFFER physical address
   711                                  ;_3:
   712 00000472 E815010000              	call    PlayWav
   713                                  
   714                                  	; 30/12/2024
   715                                  	; 29/12/2024 (vgaplay3.s)
   716                                  	; 27/12/2024 (vgaplay.s)
   717                                  _3:
   718                                  
   719                                  ; close the .wav file and exit.
   720                                  
   721                                  	; 25/12/2024
   722 00000477 E8A6030000              	call	closeFile
   723                                  
   724                                  	; 25/12/2024
   725                                  	;;;
   726                                  	; reset file loading and EOF parameters
   727                                  	; 18/12/2024
   728 0000047C C705[A0380000]0000-     	mov	dword [count], 0
   728 00000484 0000               
   729 00000486 C705[A4380000]0000-     	mov	dword [LoadedDataBytes], 0
   729 0000048E 0000               
   730 00000490 C605[1A380000]00        	mov	byte [flags], 0
   731 00000497 C605[DC370000]00        	mov	byte [stopped], 0
   732                                  	; 29/12/2024
   733 0000049E C705[E4370000]0000-     	mov	dword [pbuf_s], 0
   733 000004A6 0000               
   734                                  	;;;
   735                                  
   736 000004A8 803D[EA370000]51        	cmp	byte [command], 'Q'
   737 000004AF 7405                    	je	short terminate
   738 000004B1 E9E2FBFFFF              	jmp	check_p_command
   739                                  
   740                                  terminate:
   741 000004B6 E8C4000000              	call	set_text_mode
   742                                  Exit:
   743                                  	sys	_exit
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95                              <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97                              <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000004BB B801000000          <1>  mov eax, %1
   104                              <1> 
   105 000004C0 CD40                <1>  int 40h
   744                                  halt:
   745 000004C2 EBFE                    	jmp	short halt
   746                                  
   747                                  ; -------------------------------------------------------------
   748                                  
   749                                  	; 30/05/2024
   750                                  pmsg_usage:
   751                                  	; 21/12/2024
   752 000004C4 E8B6000000              	call	set_text_mode
   753                                  	; 01/12/2024
   754                                  	sys	_msg, msg_usage, 255, 0Fh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000004C9 BB[032D0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000004CE B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000004D3 BA0F000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000004D8 B823000000          <1>  mov eax, %1
   104                              <1> 
   105 000004DD CD40                <1>  int 40h
   755 000004DF EBDA                    	jmp	short Exit
   756                                  
   757                                  ; -------------------------------------------------------------
   758                                  
   759                                  	; 30/05/2024
   760                                  init_err:
   761                                  	; 21/12/2024
   762 000004E1 E899000000              	call	set_text_mode
   763                                  	; 01/12/2024
   764                                  	sys	_msg, msg_init_err, 255, 0Fh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000004E6 BB[962D0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000004EB B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000004F0 BA0F000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000004F5 B823000000          <1>  mov eax, %1
   104                              <1> 
   105 000004FA CD40                <1>  int 40h
   765 000004FC EBBD                    	jmp	short Exit
   766                                  
   767                                  ; -------------------------------------------------------------
   768                                  
   769                                  	; 07/12/2024
   770                                  error_exit:
   771                                  	; 21/12/2024
   772 000004FE E87C000000              	call	set_text_mode
   773                                  trdos386_error:
   774                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000503 BB[762D0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000508 B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000050D BA0E000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000512 B823000000          <1>  mov eax, %1
   104                              <1> 
   105 00000517 CD40                <1>  int 40h
   775 00000519 EBA0                    	jmp	short Exit
   776                                  
   777                                  ; -------------------------------------------------------------
   778                                  
   779                                  	; 21/12/2024
   780                                  print_msg:
   781 0000051B B40E                    	mov	ah, 0Eh
   782 0000051D BB07000000              	mov	ebx, 7
   783                                  	;mov	bl, 7 ; char attribute & color
   784                                  p_next_chr:
   785 00000522 AC                      	lodsb
   786 00000523 08C0                    	or	al, al
   787 00000525 7404                    	jz	short p_retn ; retn
   788 00000527 CD31                    	int	31h
   789 00000529 EBF7                    	jmp	short p_next_chr
   790                                  p_retn:
   791 0000052B C3                      	retn
   792                                  
   793                                  ; -------------------------------------------------------------
   794                                  
   795                                  	; 30/12/2024
   796                                  clearscreen:
   797                                  	; fast clear
   798                                  	; 320*200, 256 colors
   799 0000052C BF00000A00              	mov	edi, 0A0000h
   800 00000531 B9803E0000              	mov	ecx, (320*200*1)/4
   801 00000536 31C0                    	xor	eax, eax
   802 00000538 F3AB                    	rep	stosd
   803 0000053A C3                      	retn
   804                                  
   805                                  ; -------------------------------------------------------------
   806                                  
   807                                  	; 30/12/2024 (VGA Mode 13h, 320*200 pixels, 256 colors)
   808                                  	; 26/12/2024
   809                                  	; 21/12/2024
   810                                  drawplayingscreen:
   811 0000053B BD[F02E0000]            	mov	ebp, PlayingScreen
   812                                  	;mov	esi, 0 ; row 0, column 0
   813 00000540 BE00000200              	mov	esi, 00020000h ; row 2, column 0 ; top margin = 2
   814                                  p_d_x:
   815 00000545 C605[D4320000]28        	mov	byte [columns], 40
   816 0000054C B601                    	mov	dh, 01h ; 8x8 system font
   817                                  p_d_x_n:
   818 0000054E 8A5500                  	mov	dl, [ebp]
   819 00000551 20D2                    	and	dl, dl
   820 00000553 7429                    	jz	short p_d_x_ok
   821                                  
   822                                  	; sysvideo system call
   823                                  	; BH = 01h = VGA graphics (0A0000h) data transfers
   824                                  	; BL = 0Fh = write character/font
   825                                  	; DH = 01h = 8*8 system font 
   826                                  	; CL = 0Fh = color (white)
   827                                  	; ESI = cursor/writing position (pixels)
   828                                  	;	HW = row, SI = column
   829                                  
   830                                  	sys	_video, 010Fh, 0Fh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000555 BB0F010000          <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000055A B90F000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000055F B81F000000          <1>  mov eax, %1
   104                              <1> 
   105 00000564 CD40                <1>  int 40h
   831                                  
   832 00000566 45                      	inc	ebp
   833 00000567 6683C608                	add	si, 8 ; next char pos
   834 0000056B FE0D[D4320000]          	dec	byte [columns]
   835 00000571 75DB                    	jnz	short p_d_x_n	; next column
   836 00000573 6631F6                  	xor	si, si
   837 00000576 81C600000800            	add	esi, 00080000h	; next row ; 8*8
   838 0000057C EBC7                    	jmp	short p_d_x
   839                                  p_d_x_ok:
   840 0000057E C3                      	retn
   841                                  
   842                                  ; -------------------------------------------------------------
   843                                  
   844                                  	; 21/12/2024
   845                                  set_text_mode:
   846 0000057F 30E4                    	xor    ah, ah
   847 00000581 B003                    	mov    al, 3                        
   848                                   	;int   10h ; al = 03h text mode, int 10 video
   849 00000583 CD31                    	int    31h ; TRDOS 386 - Video interrupt
   850 00000585 C3                      	retn
   851                                  
   852                                  ; -------------------------------------------------------------
   853                                  
   854                                  	; 02/12/2024
   855                                  Player_Quit@:
   856 00000586 58                      	pop	eax ; return addr (call PlayWav@)
   857                                  	
   858                                  	; 29/11/2024
   859                                  Player_Quit:
   860 00000587 E92AFFFFFF              	jmp	 terminate
   861                                  
   862                                  ; -------------------------------------------------------------
   863                                  
   864                                  	; 30/12/2024 (cgaplay.s)
   865                                  	; 29/12/2024 (vgaplay3.s)
   866                                  	; 02/12/2024 (ac97play.s)
   867                                  PlayWav:
   868                                  	; 30/12/2024
   869 0000058C A1[AC380000]            	mov	eax, [_bdl_buffer] ; BDL_BUFFER physical address
   870 00000591 09C0                    	or	eax, eax
   871 00000593 751D                    	jnz	short PlayWav@
   872                                  
   873                                  	; 29/05/2024
   874                                  	; Allocate memory block (33 pages)
   875                                  	sys	_alloc, BDL_BUFFER, 33*4096, 0	; no upper limit
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000595 BB[00400000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000059A B900100200          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000059F BA00000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000005A4 B82A000000          <1>  mov eax, %1
   104                              <1> 
   105 000005A9 CD40                <1>  int 40h
   876                                  	;jc	short Player_Quit ; 01/12/2024
   877 000005AB 72D9                    	jc	short Player_Quit@ ; 02/12/2024
   878                                  
   879 000005AD A3[AC380000]            	mov	[_bdl_buffer], eax ; BDL_BUFFER physical address
   880                                  
   881                                  PlayWav@:
   882                                  	; create Buffer Descriptor List
   883                                  
   884                                  	;  Generic Form of Buffer Descriptor
   885                                  	;  ---------------------------------
   886                                  	;  63   62    61-48    47-32   31-0
   887                                  	;  ---  ---  --------  ------- -----
   888                                  	;  IOC  BUP -reserved- Buffer  Buffer
   889                                  	;		      Length   Pointer
   890                                  	;		      [15:0]   [31:0]
   891                                  
   892                                  	; 30/12/2024	
   893                                  
   894 000005B2 0500100000              	add	eax, 4096	; WAVBUFFER_1 physical address
   895 000005B7 89C3                    	mov	ebx, eax
   896                                  	;mov	[wav_buffer1], eax
   897                                  	;add	eax, 65536	; WAVBUFFER_2 physical address
   898                                  	;mov	[wav_buffer2], eax
   899                                  
   900 000005B9 BF[00400000]            	mov	edi, BDL_BUFFER
   901 000005BE B910000000              	mov	ecx, 16
   902                                  _pw0:
   903                                  	;mov	eax, WAVBUFFER_1
   904 000005C3 89D8                    	mov	eax, ebx	; WAVBUFFER_1 physical address
   905 000005C5 AB                      	stosd
   906                                  
   907 000005C6 A1[94380000]            	mov	eax, [buffersize]
   908                                  	; 02/12/2024
   909 000005CB D1E8                    	shr	eax, 1 ; buffer size in word
   910 000005CD 0D00000040              	or	eax, BUP	; tuneloop (without interrupt)
   911 000005D2 AB                      	stosd
   912                                  
   913                                  	;mov	eax, WAVBUFFER_2
   914 000005D3 89D8                    	mov	eax, ebx
   915 000005D5 0500000100              	add	eax, 65536	; WAVBUFFER_2 physical address
   916 000005DA AB                      	stosd
   917                                  
   918 000005DB A1[94380000]            	mov	eax, [buffersize]
   919                                  	; 02/12/2024
   920 000005E0 D1E8                    	shr	eax, 1 ; buffer size in word
   921 000005E2 0D00000040              	or	eax, BUP	; tuneloop (without interrupt)
   922 000005E7 AB                      	stosd
   923                                  
   924 000005E8 E2D9                    	loop	_pw0
   925                                  
   926                                  	; 14/11/2024
   927                                  	;mov	dword [count], ecx ; 0
   928                                  	;mov	dword [LoadedDataBytes], 0
   929                                  
   930                                  RePlayWav:
   931                                  	; 01/12/2024
   932                                  	; load 64k into buffer 1
   933 000005EA BF[00500000]            	mov	edi, WAVBUFFER_1
   934 000005EF FF15[8C380000]          	call	dword [loadfromwavfile]
   935                                  	; 01/12/2024
   936                                  	; 14/11/2024
   937 000005F5 A1[A0380000]            	mov	eax, [count]
   938 000005FA 0105[A4380000]          	add	[LoadedDataBytes], eax
   939                                  
   940                                  	; 18/12/2024
   941 00000600 C705[A0380000]0000-     	mov	dword [count], 0
   941 00000608 0000               
   942                                  
   943                                  	; and 64k into buffer 2
   944 0000060A BF[00500100]            	mov	edi, WAVBUFFER_2
   945 0000060F FF15[8C380000]          	call	dword [loadfromwavfile]
   946                                  	; 01/12/2024
   947                                  	; 14/11/2024
   948 00000615 A1[A0380000]            	mov	eax, [count]
   949 0000061A 0105[A4380000]          	add	[LoadedDataBytes], eax
   950                                  	
   951                                  	; write NABMBAR+10h with offset of buffer descriptor list
   952                                  
   953                                         	;;mov	eax, BDL_BUFFER
   954                                          ;mov	eax, esi	; BDL_BUFFER physical address
   955                                  
   956                                  	;mov	eax, [_bdl_buffer] ; BDL_BUFFER physical address
   957                                  	; 02/12/2024
   958 00000620 8B1D[AC380000]          	mov	ebx, [_bdl_buffer]
   959                                  
   960 00000626 668B15[8A380000]        	mov	dx, [NABMBAR]
   961 0000062D 6683C210                        add     dx, PO_BDBAR_REG	; set pointer to BDL
   962                                  	;out	dx, eax 		; write to AC97 controller
   963                                  	; 29/05/2024
   964                                  	;mov	ebx, eax ; data, dword
   965                                  	; 02/12/2024
   966                                  	; ebx = [_bdl_buffer] ; data, dword
   967 00000631 B405                    	mov	ah, 5	; write port dword
   968 00000633 CD34                    	int	34h
   969                                  
   970                                  	; 31/05/2024
   971                                  	; 19/05/2024
   972                                  	;call	delay1_4ms
   973                                  
   974 00000635 B01F                            mov	al, 31
   975 00000637 E8D4060000              	call	setLastValidIndex
   976                                  
   977                                  	; 31/05/2024
   978                                  	; 19/05/2024
   979                                  	;call	delay1_4ms
   980                                  
   981                                  	; 17/02/2017
   982 0000063C 668B15[8A380000]                mov	dx, [NABMBAR]
   983 00000643 6683C21B                        add	dx, PO_CR_REG		; PCM out Control Register
   984                                          ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   985                                  	;			; (LVBI interrupt will not be enabled)
   986                                  	; 06/11/2023 (TUNELOOP version, without interrupt)
   987 00000647 B001                    	mov	al, RPBM
   988                                  	;out	dx, al			; Start bus master operation.
   989                                  	; 29/05/2024
   990                                  	; al = data, byte
   991 00000649 B401                    	mov	ah, 1 ; write port, byte
   992 0000064B CD34                    	int	34h
   993                                  
   994                                  	; 30/12/2024
   995                                  
   996                                  ; -------------------------------------------
   997                                  
   998                                  	; 30/12/2024 (cgaplay.s)
   999                                  	; 29/12/2024 (vgaplay3.s)
  1000                                  	; 18/12/2024 (ac97play.s)
  1001                                  	; 01/12/2024 (32bit)
  1002                                  	; 29/11/2024
  1003                                  tuneLoop:
  1004                                  	; 30/05/2024
  1005                                  	; 18/11/2023 (ich_wav4.asm)
  1006                                  	; 08/11/2023
  1007                                  	; 06/11/2023
  1008                                  tLWait:
  1009                                  	; 18/11/2024
  1010 0000064D 803D[DC370000]00        	cmp	byte [stopped], 0
  1011                                  	;jna	short tL@
  1012                                  	; 21/11/2024
  1013 00000654 7718                    	ja	short tLWait@
  1014 00000656 A0[DE370000]            	mov	al, [tLP]
  1015 0000065B 3C31                    	cmp	al, '1'
  1016 0000065D 7458                    	je	short tL1@
  1017 0000065F 0F87A3000000            	ja	tL2@
  1018 00000665 B031                    	mov	al, '1'
  1019 00000667 A2[DE370000]            	mov	[tLP], al
  1020 0000066C EB49                    	jmp	short tL1@ 
  1021                                  tLWait@:	; 21/11/2024
  1022                                  	;;;
  1023                                  	; 09/12/2024
  1024 0000066E 803D[DC370000]03        	cmp	byte [stopped], 3
  1025 00000675 0F83DF000000            	jnb	_exitt_
  1026                                  	;;;
  1027 0000067B E8A5200000              	call	checkUpdateEvents
  1028 00000680 0F82D4000000            	jc	_exitt_
  1029                                  	;;;
  1030                                  	; 29/11/2024
  1031 00000686 803D[EA370000]4E        	cmp	byte [command], 'N'
  1032 0000068D 0F84C7000000            	je	_exitt_
  1033 00000693 803D[EA370000]50        	cmp	byte [command], 'P'
  1034 0000069A 0F84BA000000            	je	_exitt_
  1035                                  	;;;
  1036 000006A0 803D[DD370000]30        	cmp	byte [tLO], '0'
  1037 000006A7 74A4                    	je	short tLWait
  1038 000006A9 E8B6000000              	call	tLZ
  1039 000006AE C605[DD370000]30        	mov	byte [tLO], '0'
  1040 000006B5 EB96                    	jmp	short tLWait
  1041                                  
  1042                                  ;tLO:	db 0
  1043                                  	
  1044                                  tL1@:
  1045                                  	;mov	al, '1'
  1046                                  	; 19/11/2024
  1047 000006B7 A2[DD370000]            	mov	[tLO], al
  1048 000006BC E8A5000000              	call	tL0
  1049                                  tL1:
  1050 000006C1 E80D060000              	call	updateLVI	; /set LVI != CIV/
  1051 000006C6 0F848E000000            	jz	_exitt_		; 08/11/2023
  1052                                  	;;;
  1053                                  	;call	check4keyboardstop
  1054                                  	; 14/11/2024
  1055 000006CC E854200000              	call	checkUpdateEvents
  1056 000006D1 0F8283000000            	jc	_exitt_
  1057                                  	; 18/11/2024
  1058 000006D7 803D[DC370000]00        	cmp	byte [stopped], 0
  1059 000006DE 778E                    	ja	short tLWait@	; 21/11/2024
  1060                                  	;;;
  1061 000006E0 E8DE050000              	call	getCurrentIndex
  1062 000006E5 A801                    	test	al, BIT0
  1063 000006E7 74D8                    	jz	short tL1	; loop if buffer 2 is not playing
  1064                                  
  1065                                  	; load buffer 1
  1066                                  	;mov	ax, [WAV_BUFFER1]
  1067                                  	; 01/12/2024
  1068 000006E9 BF[00500000]            	mov	edi, WAVBUFFER_1	
  1069                                  
  1070                                  	;call	loadFromFile
  1071                                  	; 18/11/2023
  1072                                  	;call	word [loadfromwavfile]
  1073                                  	; 01/12/2024
  1074 000006EE FF15[8C380000]          	call	dword [loadfromwavfile]
  1075 000006F4 7264                    	jc	short _exitt_	; end of file
  1076                                  
  1077                                  	; 14/11/2024
  1078                                  	;mov	ax, [count]
  1079                                  	;add	[LoadedDataBytes], ax
  1080                                  	;adc	word [LoadedDataBytes+2], 0
  1081                                  	; 01/12/2024
  1082 000006F6 A1[A0380000]            	mov	eax, [count]
  1083 000006FB 0105[A4380000]          	add	[LoadedDataBytes], eax
  1084                                  
  1085 00000701 B032                    	mov	al, '2'
  1086                                  	; 21/11/2024
  1087 00000703 A2[DE370000]            	mov	[tLP], al
  1088                                  tL2@:
  1089                                  	; 19/11/2024
  1090 00000708 A2[DD370000]            	mov	[tLO], al
  1091 0000070D E854000000              	call	tL0
  1092                                  tL2:
  1093 00000712 E8BC050000              	call    updateLVI
  1094 00000717 7441                    	jz	short _exitt_	; 08/11/2023
  1095                                  	;;;
  1096                                  	;call	check4keyboardstop
  1097                                  	; 14/11/2024
  1098 00000719 E807200000              	call	checkUpdateEvents
  1099 0000071E 723A                    	jc	short _exitt_
  1100                                  	; 18/11/2024
  1101 00000720 803D[DC370000]00        	cmp	byte [stopped], 0
  1102 00000727 0F8741FFFFFF            	ja	tLWait@		; 21/11/2024 
  1103                                  	;;;
  1104 0000072D E891050000              	call    getCurrentIndex
  1105 00000732 A801                    	test	al, BIT0
  1106 00000734 75DC                    	jnz	short tL2	; loop if buffer 1 is not playing
  1107                                  
  1108                                  	; load buffer 2
  1109                                  	;mov	ax, [WAV_BUFFER2]
  1110                                  	; 01/12/2024
  1111 00000736 BF[00500100]            	mov	edi, WAVBUFFER_2
  1112                                  	;call	loadFromFile
  1113                                  	; 18/11/2023
  1114                                  	;call	word [loadfromwavfile]
  1115                                  	; 01/12/2024
  1116 0000073B FF15[8C380000]          	call	dword [loadfromwavfile]
  1117                                  	;jnc	short tuneLoop
  1118 00000741 7217                    	jc	short _exitt_
  1119                                  
  1120                                  	; 14/11/2024
  1121                                  	;mov	ax, [count]
  1122                                  	;add	[LoadedDataBytes], ax
  1123                                  	;adc	word [LoadedDataBytes+2], 0
  1124                                  	; 01/12/2024
  1125 00000743 A1[A0380000]            	mov	eax, [count]
  1126 00000748 0105[A4380000]          	add	[LoadedDataBytes], eax	
  1127                                  
  1128                                  	; 21/11/2024
  1129 0000074E C605[DE370000]31        	mov	byte [tLP], '1'
  1130 00000755 E9F3FEFFFF              	jmp	tuneLoop
  1131                                  
  1132                                  	; 29/12/2024 (vgaplay3.s)
  1133                                  _exitt_:
  1134                                  	; 07/12/2024
  1135                                  	; Stop Playing
  1136                                  	;mov	byte [stopped], 2
  1137                                  	;sys	_audio, 0700h
  1138 0000075A E8F6040000              	call	ac97_stop
  1139                                  
  1140                                  	;;;
  1141                                  	; 14/11/2024
  1142 0000075F E8D7230000              	call	UpdateProgressBar
  1143                                  	;;;
  1144                                  
  1145                                  	; 18/11/2024
  1146                                  tLZ:
  1147                                  	; 30/05/2024
  1148 00000764 B030                    	mov	al, '0'
  1149                                  
  1150                                  	;add	al, '0'
  1151                                  	;call	tL0
  1152                                  	;
  1153                                  	;retn
  1154                                  	; 06/11/2023
  1155                                  	;jmp	short tL0
  1156                                  	;retn
  1157                                  
  1158                                  tL0:
  1159                                  	; 30/12/2024 (cgaplay.s)
  1160                                  	; 29/05/2024 (TRDOS 386)
  1161                                  	; 08/11/2023
  1162                                  	; 05/11/2023
  1163                                  	; 17/02/2017 - Buffer switch test (temporary)
  1164                                  	; 06/11/2023
  1165                                  	; al = buffer indicator ('1', '2' or '0' -stop- )
  1166                                  
  1167                                  	; 30/12/2024 (video mode 13h modification)
  1168                                  	; (320*200, 256 colors)
  1169                                  	;;;
  1170 00000766 88C2                    	mov	dl, al ; character
  1171 00000768 BF00000A00              	mov	edi, 0A0000h
  1172                                  
  1173 0000076D BB08000000              	mov	ebx, 8 ; 8 pixels (8*8 pixels font)
  1174                                  
  1175 00000772 B00C                    	mov	al, 0Ch ; red
  1176                                  tL0_1:
  1177                                  	;mov	ecx, 8 ; 8 pixels (8*8 pixels font)
  1178 00000774 B907000000              	mov	ecx, 7
  1179                                  tL0_2:
  1180 00000779 AA                      	stosb
  1181 0000077A 49                      	dec	ecx
  1182 0000077B 75FC                    	jnz	short tL0_2
  1183 0000077D 4B                      	dec	ebx
  1184 0000077E 7408                    	jz	short tL0_3
  1185                                  	;add	edi, 320-8 ; next line
  1186 00000780 81C739010000            	add	edi, 320-7
  1187 00000786 EBEC                    	jmp	short tL0_1
  1188                                  tL0_3:
  1189                                  	; write system font
  1190 00000788 B601                    	mov	dh, 01h
  1191                                  	;mov	dl, al ; character
  1192 0000078A 31F6                    	xor	esi, esi ; = row 0, column 0
  1193                                  	sys	_video, 010Fh, 0Eh ; yellow
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000078C BB0F010000          <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000791 B90E000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000796 B81F000000          <1>  mov eax, %1
   104                              <1> 
   105 0000079B CD40                <1>  int 40h
  1194                                  	;;;
  1195                                  
  1196 0000079D C3                      	retn
  1197                                  
  1198                                  ; -------------------------------------------
  1199                                  
  1200                                  	; 29/12/2024 (vgaplay3.s)
  1201                                  	; 18/12/2024 (ac97play.s)
  1202                                  	; 14/11/2024
  1203                                  ;SetMasterVolume:
  1204                                  	; 15/11/2024
  1205                                  SetPCMOutVolume:
  1206                                  	;cmp	al, 31
  1207                                  	;ja	short setvolume_ok
  1208 0000079E A2[46290000]            	mov	[volume], al  ; max = 0, min = 31
  1209                                  SetPCMOutVolume@:	; 19/11/2024
  1210 000007A3 88C4                    	mov	ah, al
  1211 000007A5 668B15[88380000]        	mov	dx, [NAMBAR]
  1212                                  	; 15/11/2024 (QEMU)
  1213                                    	;add	dx, CODEC_MASTER_VOL_REG
  1214 000007AC 6683C218                	add	dx, CODEC_PCM_OUT_REG
  1215                                  	;out	dx, ax
  1216                                  	; 01/12/2024
  1217                                  	; bx = data, word
  1218                                  	; 03/12/2024
  1219 000007B0 89C3                    	mov	ebx, eax
  1220 000007B2 B403                    	mov	ah, 3  ; write port, word
  1221 000007B4 CD34                    	int	34h
  1222                                  ;setvolume_ok:
  1223 000007B6 C3                      	retn
  1224                                  
  1225                                  ; -------------------------------------------
  1226                                  
  1227                                  	; 29/12/2024 (vgaplay3.s)
  1228                                  	; 18/12/2024 (ac97play.s)
  1229                                  	; 30/05/2024
  1230                                  DetectAC97:
  1231                                  DetectICH:
  1232                                  	; 22/11/2023
  1233                                  	; 19/11/2023
  1234                                  	; 01/11/2023 - TRDOS 386 Kernel v2.0.7
  1235                                  	;; 10/06/2017
  1236                                  	;; 05/06/2017
  1237                                  	;; 29/05/2017
  1238                                  	;; 28/05/2017
  1239                                  
  1240                                  	; 01/12/2024
  1241                                  	; 19/11/2023
  1242 000007B7 BE[382C0000]            	mov	esi, valid_ids	; address of Valid ICH (AC97) Device IDs
  1243 000007BC B915000000              	mov	ecx, valid_id_count
  1244                                  pfd_1:
  1245 000007C1 AD                      	lodsd
  1246 000007C2 E8A8000000              	call	pciFindDevice
  1247 000007C7 7303                    	jnc	short d_ac97_1
  1248 000007C9 E2F6                    	loop	pfd_1
  1249                                  
  1250                                  	;stc
  1251 000007CB C3                      	retn
  1252                                  
  1253                                  d_ac97_1:
  1254                                  	; eax = BUS/DEV/FN
  1255                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1256                                  	; edx = DEV/VENDOR
  1257                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1258                                  
  1259                                  	; playwav4.asm - 19/05/2024
  1260                                  
  1261 000007CC A3[80380000]            	mov	[bus_dev_fn], eax
  1262 000007D1 8915[84380000]          	mov	[dev_vendor], edx
  1263                                  
  1264                                  	; get ICH base address regs for mixer and bus master
  1265                                  
  1266 000007D7 B010                            mov     al, NAMBAR_REG
  1267 000007D9 E81F010000                      call    pciRegRead16			; read PCI registers 10-11
  1268                                          ;and    dx, IO_ADDR_MASK 		; mask off BIT0
  1269                                  	; 19/05/2024
  1270 000007DE 80E2FE                  	and	dl, 0FEh
  1271                                  
  1272 000007E1 668915[88380000]                mov     [NAMBAR], dx			; save audio mixer base addr
  1273                                  
  1274 000007E8 B014                    	mov     al, NABMBAR_REG
  1275 000007EA E80E010000                      call    pciRegRead16
  1276                                          ;and    dx, IO_ADDR_MASK
  1277                                  	; 19/05/2024
  1278 000007EF 80E2C0                  	and	dl, 0C0h
  1279                                  
  1280 000007F2 668915[8A380000]                mov     [NABMBAR], dx			; save bus master base addr
  1281                                  
  1282 000007F9 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
  1283 000007FB E8F6000000              	call	pciRegRead8 ; 17/02/2017
  1284                                  	
  1285 00000800 8815[1B380000]          	mov	[ac97_int_ln_reg], dl
  1286                                  
  1287                                  	;clc
  1288                                  
  1289 00000806 C3                      	retn
  1290                                  
  1291                                  ; ----------------------------------
  1292                                  	
  1293                                  	; 26/12/2024
  1294                                  	; 07/12/2024
  1295                                  	; 01/12/2024
  1296                                  	; 14/11/2024
  1297                                  	; INPUT: ds:dx = file name address
  1298                                  	; OUTPUT: [filehandle] = ; -1 = not open
  1299                                  openFile:
  1300                                  	; 26/12/2024
  1301                                  	; 01/12/2024
  1302                                  	sys	_open, edx, 0
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000807 89D3                <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000809 B900000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000080E B805000000          <1>  mov eax, %1
   104                              <1> 
   105 00000813 CD40                <1>  int 40h
  1303                                  	; 07/12/2024
  1304                                  	;sys	_open, wav_file_name, 0
  1305 00000815 7305                    	jnc	short _of1
  1306                                  
  1307 00000817 B8FFFFFFFF              	mov	eax, -1
  1308                                  	; cf = 1 -> not found or access error
  1309                                  _of1:
  1310 0000081C A3[1C380000]            	mov	[filehandle], eax
  1311 00000821 C3                      	retn
  1312                                  
  1313                                  ; ----------------------------------
  1314                                  
  1315                                  ; close the currently open file
  1316                                  
  1317                                  	; 01/12/2024
  1318                                  	; 14/11/2024
  1319                                  	; INPUT: [filehandle] ; -1 = not open
  1320                                  	; OUTPUT: none
  1321                                  closeFile:
  1322 00000822 833D[1C380000]FF        	cmp	dword [filehandle], -1
  1323 00000829 740D                    	jz	short _cf1
  1324                                  	; 01/12/2024
  1325                                  	sys	_close, [filehandle]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000082B 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97                              <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000831 B806000000          <1>  mov eax, %1
   104                              <1> 
   105 00000836 CD40                <1>  int 40h
  1326                                  	;mov 	dword [filehandle], -1
  1327                                  _cf1:
  1328 00000838 C3                      	retn
  1329                                  
  1330                                  ; ----------------------------------
  1331                                  
  1332                                  	; 01/12/2024
  1333                                  	; 14/11/2024 - Erdogan Tan
  1334                                  getWAVParameters:
  1335                                  ; reads WAV file header(s) (44 bytes) from the .wav file.
  1336                                  ; entry: none - assumes file is already open
  1337                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
  1338                                  ;	cx = number of channels (mono=1, stereo=2)
  1339                                  ;	dx = bits per sample (8, 16)
  1340                                  ;	bx = number of bytes per sample (1 to 4)
  1341                                  
  1342                                          ;mov	dx, WAVFILEHEADERbuff
  1343                                  	;mov	bx, [filehandle]
  1344                                          ;mov	cx, 44			; 44 bytes
  1345                                  	;mov	ah, 3Fh
  1346                                          ;int	21h
  1347                                  	;jc	short gwavp_retn
  1348                                  	; 01/12/2024 (TRDOS 386)
  1349                                  	sys	_read, [filehandle], WAVFILEHEADERbuff, 44
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000839 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000083F B9[EC370000]        <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00000844 BA2C000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000849 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 0000084E CD40                <1>  int 40h
  1350 00000850 721C                    	jc	short gwavp_retn
  1351                                  
  1352 00000852 83F82C                  	cmp	eax, 44
  1353 00000855 7217                    	jb	short gwavp_retn
  1354                                  
  1355 00000857 813D[F4370000]5741-     	cmp	dword [RIFF_Format], 'WAVE'
  1355 0000085F 5645               
  1356 00000861 750A                    	jne	short gwavp_stc_retn
  1357                                  
  1358 00000863 66833D[00380000]01      	cmp	word [WAVE_AudioFormat], 1 ; Offset 20, must be 1 (= PCM)
  1359                                  	;jne	short gwavp_stc_retn
  1360 0000086B 7401                    	je	short gwavp_retn ; 15/11/2024
  1361                                  
  1362                                  	; 15/11/2024
  1363                                  	;mov	cx, [WAVE_NumChannels]	; return num of channels in CX
  1364                                          ;mov    ax, [WAVE_SampleRate]	; return sample rate in AX
  1365                                  	;mov	dx, [WAVE_BitsPerSample] 
  1366                                  					; return bits per sample value in DX
  1367                                  	;mov	bx, [WAVE_BlockAlign]	; return bytes per sample in BX
  1368                                  ;gwavp_retn:
  1369                                          ;retn
  1370                                  
  1371                                  gwavp_stc_retn:
  1372 0000086D F9                      	stc
  1373                                  gwavp_retn:
  1374 0000086E C3                      	retn
  1375                                  
  1376                                  
  1377                                  ; 29/12/2024 (vgaplay3.s)
  1378                                  ; 18/12/2024 (ac97play.s)
  1379                                  ; --------------------------------------------------------
  1380                                  ; 27/05/2024 - (TRDOS 386 Kernel) audio.s
  1381                                  ; --------------------------------------------------------
  1382                                  
  1383                                  NOT_PCI32_PCI16	EQU 03FFFFFFFh ; NOT BIT31+BIT30 ; 19/03/2017
  1384                                  NOT_BIT31 EQU 7FFFFFFFh
  1385                                  
  1386                                  pciFindDevice:
  1387                                  	; 19/11/2023
  1388                                  	; 03/04/2017 ('pci.asm', 20/03/2017)
  1389                                  	;
  1390                                  	; scan through PCI space looking for a device+vendor ID
  1391                                  	;
  1392                                  	; Entry: EAX=Device+Vendor ID
  1393                                  	;
  1394                                  	; Exit: EAX=PCI address if device found
  1395                                  	;	EDX=Device+Vendor ID
  1396                                  	;       CY clear if found, set if not found. EAX invalid if CY set.
  1397                                  	;
  1398                                  	; Destroys: ebx, edi ; 19/11/2023
  1399                                  
  1400                                          ; 19/11/2023
  1401 0000086F 89C3                    	mov	ebx, eax
  1402 00000871 BF00000080              	mov	edi, 80000000h
  1403                                  nextPCIdevice:
  1404 00000876 89F8                    	mov 	eax, edi		; read PCI registers
  1405 00000878 E88C000000              	call	pciRegRead32
  1406                                  	; 19/11/2023
  1407 0000087D 39DA                    	cmp	edx, ebx
  1408 0000087F 7412                    	je	short PCIScanExit	; found
  1409                                  	; 19/11/2023
  1410 00000881 81FF00F8FF80            	cmp	edi, 80FFF800h
  1411 00000887 7308                    	jnb	short pfd_nf		; not found
  1412 00000889 81C700010000            	add	edi, 100h
  1413 0000088F EBE5                    	jmp	short nextPCIdevice
  1414                                  pfd_nf:
  1415 00000891 F9                      	stc
  1416 00000892 C3                      	retn
  1417                                  PCIScanExit:
  1418                                  	;pushf
  1419 00000893 B8FFFFFF7F              	mov	eax, NOT_BIT31 	; 19/03/2017
  1420 00000898 21F8                    	and	eax, edi	; return only bus/dev/fn #
  1421 0000089A C3                      	retn
  1422                                  
  1423                                  pciRegRead:
  1424                                  	; 01/12/2024
  1425                                  	; 03/04/2017 ('pci.asm', 20/03/2017)
  1426                                  	;
  1427                                  	; 8/16/32bit PCI reader
  1428                                  	;
  1429                                  	; Entry: EAX=PCI Bus/Device/fn/register number
  1430                                  	;           BIT30 set if 32 bit access requested
  1431                                  	;           BIT29 set if 16 bit access requested
  1432                                  	;           otherwise defaults to 8 bit read
  1433                                  	;
  1434                                  	; Exit:  DL,DX,EDX register data depending on requested read size
  1435                                  	;
  1436                                  	; Note1: this routine is meant to be called via pciRegRead8,
  1437                                  	;	 pciRegread16 or pciRegRead32, listed below.
  1438                                  	;
  1439                                  	; Note2: don't attempt to read 32 bits of data from a non dword
  1440                                  	;	 aligned reg number. Likewise, don't do 16 bit reads from
  1441                                  	;	 non word aligned reg #
  1442                                  
  1443 0000089B 53                      	push	ebx
  1444 0000089C 51                      	push	ecx
  1445 0000089D 89C3                            mov     ebx, eax		; save eax, dh
  1446 0000089F 88F1                            mov     cl, dh
  1447                                  
  1448 000008A1 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; clear out data size request
  1449 000008A6 0D00000080                      or      eax, BIT31		; make a PCI access request
  1450 000008AB 24FC                            and     al, ~3 ; NOT 3 ; 0FCh	; force index to be dword
  1451                                  
  1452 000008AD 66BAF80C                        mov     dx, PCI_INDEX_PORT
  1453                                          ;out	dx, eax			; write PCI selector
  1454                                  	; 29/05/2024
  1455 000008B1 53                      	push	ebx
  1456 000008B2 89C3                    	mov	ebx, eax ; data, dword
  1457 000008B4 B405                    	mov	ah, 5 ; write port, dword
  1458                                  	; dx = port number
  1459 000008B6 CD34                    	int	34h
  1460 000008B8 5B                      	pop	ebx
  1461                                  	
  1462 000008B9 66BAFC0C                        mov     dx, PCI_DATA_PORT
  1463 000008BD 88D8                            mov     al, bl
  1464 000008BF 2403                            and     al, 3			; figure out which port to
  1465 000008C1 00C2                            add     dl, al			; read to
  1466                                  
  1467 000008C3 F7C3000000C0            	test    ebx, PCI32+PCI16
  1468 000008C9 750A                            jnz     short _pregr0
  1469                                  
  1470                                  	;in	al, dx			; return 8 bits of data
  1471                                  	; 29/05/2024
  1472 000008CB B400                    	mov	ah, 0 ; read port, byte
  1473                                  	; dx = port number
  1474 000008CD CD34                    	int	34h
  1475                                          
  1476 000008CF 88C2                    	mov	dl, al
  1477 000008D1 88CE                    	mov     dh, cl			; restore dh for 8 bit read
  1478 000008D3 EB17                    	jmp	short _pregr2
  1479                                  _pregr0:	
  1480 000008D5 F7C300000080            	test    ebx, PCI32
  1481 000008DB 7509                            jnz	short _pregr1
  1482                                  
  1483                                  	;in	ax, dx
  1484                                  	; 29/05/2024
  1485 000008DD B402                    	mov	ah, 2 ; read port, word
  1486                                  	; dx = port number
  1487 000008DF CD34                    	int	34h
  1488                                  
  1489 000008E1 6689C2                  	mov     dx, ax			; return 16 bits of data
  1490 000008E4 EB06                    	jmp	short _pregr2
  1491                                  _pregr1:
  1492                                  	;in	eax, dx			; return 32 bits of data
  1493                                  	; 29/05/2024
  1494 000008E6 B404                    	mov	ah, 4 ; read port, dword
  1495                                  	; dx = port number
  1496 000008E8 CD34                    	int	34h
  1497                                  
  1498 000008EA 89C2                    	mov	edx, eax
  1499                                  _pregr2:
  1500 000008EC 89D8                    	mov     eax, ebx		; restore eax
  1501 000008EE 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; clear out data size request
  1502 000008F3 59                      	pop	ecx
  1503 000008F4 5B                      	pop	ebx
  1504 000008F5 C3                      	retn
  1505                                  
  1506                                  pciRegRead8:
  1507 000008F6 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 8 bit read size
  1508 000008FB EB9E                            jmp     short pciRegRead	; call generic PCI access
  1509                                  
  1510                                  pciRegRead16:
  1511 000008FD 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 16 bit read size
  1512 00000902 0D00000040                      or      eax, PCI16		; call generic PCI access
  1513 00000907 EB92                            jmp     short pciRegRead
  1514                                  
  1515                                  pciRegRead32:
  1516 00000909 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 32 bit read size
  1517 0000090E 0D00000080                      or      eax, PCI32		; call generic PCI access
  1518 00000913 EB86                            jmp     pciRegRead
  1519                                  
  1520                                  pciRegWrite:
  1521                                  	; 01/12/2024
  1522                                  	; 03/04/2017 ('pci.asm', 29/11/2016)
  1523                                  	;
  1524                                  	; 8/16/32bit PCI writer
  1525                                  	;
  1526                                  	; Entry: EAX=PCI Bus/Device/fn/register number
  1527                                  	;           BIT31 set if 32 bit access requested
  1528                                  	;           BIT30 set if 16 bit access requested
  1529                                  	;           otherwise defaults to 8bit read
  1530                                  	;        DL/DX/EDX data to write depending on size
  1531                                  	;
  1532                                  	; Note1: this routine is meant to be called via pciRegWrite8,
  1533                                  	;	 pciRegWrite16 or pciRegWrite32 as detailed below.
  1534                                  	;
  1535                                  	; Note2: don't attempt to write 32bits of data from a non dword
  1536                                  	;	 aligned reg number. Likewise, don't do 16 bit writes from
  1537                                  	;	 non word aligned reg #
  1538                                  
  1539 00000915 53                      	push	ebx
  1540 00000916 51                      	push	ecx
  1541 00000917 89C3                            mov     ebx, eax		; save eax, edx
  1542 00000919 89D1                            mov     ecx, edx
  1543 0000091B 25FFFFFF3F              	and     eax, NOT_PCI32_PCI16	; clear out data size request
  1544 00000920 0D00000080                      or      eax, BIT31		; make a PCI access request
  1545 00000925 24FC                            and     al, ~3 ; NOT 3 ; 0FCh	; force index to be dword
  1546                                  
  1547 00000927 66BAF80C                        mov     dx, PCI_INDEX_PORT
  1548                                  	;out	dx, eax			; write PCI selector
  1549                                  	; 29/05/2024
  1550 0000092B 53                      	push	ebx
  1551 0000092C 89C3                    	mov	ebx, eax ; data, dword
  1552 0000092E B405                    	mov	ah, 5 ; write port, dword
  1553                                  	; dx = port number
  1554 00000930 CD34                    	int	34h
  1555 00000932 5B                      	pop	ebx
  1556                                  	
  1557 00000933 66BAFC0C                        mov     dx, PCI_DATA_PORT
  1558 00000937 88D8                            mov     al, bl
  1559 00000939 2403                            and     al, 3			; figure out which port to
  1560 0000093B 00C2                            add     dl, al			; write to
  1561                                  
  1562 0000093D F7C3000000C0            	test    ebx, PCI32+PCI16
  1563 00000943 7508                            jnz     short _pregw0
  1564 00000945 88C8                    	mov	al, cl 			; put data into al
  1565                                  	;out	dx, al
  1566                                  	; 29/05/2024
  1567                                  	; al = data, byte
  1568 00000947 B401                    	mov	ah, 1 ; write port, byte
  1569                                  	; dx = port number
  1570 00000949 CD34                    	int	34h
  1571                                  
  1572 0000094B EB1F                    	jmp	short _pregw2
  1573                                  _pregw0:
  1574 0000094D F7C300000080            	test    ebx, PCI32
  1575 00000953 750D                            jnz     short _pregw1
  1576 00000955 6689C8                  	mov	ax, cx			; put data into ax
  1577                                  	;out	dx, ax
  1578                                  	; 29/05/2024
  1579 00000958 53                      	push	ebx
  1580 00000959 89C3                    	mov	ebx, eax ; data, word
  1581 0000095B B403                    	mov	ah, 3 ; write port, word
  1582                                  	; dx = port number
  1583 0000095D CD34                    	int	34h
  1584 0000095F 5B                      	pop	ebx
  1585                                  
  1586 00000960 EB0A                    	jmp	short _pregw2
  1587                                  _pregw1:
  1588 00000962 89C8                    	mov	eax, ecx		; put data into eax
  1589                                  	;out	dx, eax
  1590                                  	; 29/05/2024
  1591 00000964 53                      	push	ebx
  1592 00000965 89C3                    	mov	ebx, eax ; data, dword
  1593 00000967 B405                    	mov	ah, 5 ; write port, dword
  1594                                  	; dx = port number
  1595 00000969 CD34                    	int	34h
  1596 0000096B 5B                      	pop	ebx
  1597                                  _pregw2:
  1598 0000096C 89D8                            mov     eax, ebx		; restore eax
  1599 0000096E 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; clear out data size request
  1600 00000973 89CA                            mov     edx, ecx		; restore dx
  1601 00000975 59                      	pop	ecx
  1602 00000976 5B                      	pop	ebx
  1603 00000977 C3                      	retn
  1604                                  
  1605                                  pciRegWrite8:
  1606 00000978 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 8 bit write size
  1607 0000097D EB96                            jmp	short pciRegWrite	; call generic PCI access
  1608                                  
  1609                                  pciRegWrite16:
  1610 0000097F 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 16 bit write size
  1611 00000984 0D00000040                      or      eax, PCI16		; call generic PCI access
  1612 00000989 EB8A                            jmp	short pciRegWrite
  1613                                  
  1614                                  pciRegWrite32:
  1615 0000098B 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 32 bit write size
  1616 00000990 0D00000080                      or      eax, PCI32		; call generic PCI access
  1617 00000995 E97BFFFFFF                      jmp	pciRegWrite
  1618                                  
  1619                                  ; --------------------------------------------------------
  1620                                  ; 19/05/2024 - (playwav4.asm) ac97_vra.asm
  1621                                  ; --------------------------------------------------------
  1622                                  
  1623                                  	; 13/11/2023
  1624                                  
  1625                                  ;VRA:	db 1
  1626                                  
  1627                                  codecConfig:
  1628                                  	; 01/12/2024 (ac97play.s)
  1629                                  	; 29/05/2024 (playwav7.s modification)
  1630                                  	; 19/05/2024
  1631                                  	; 19/11/2023
  1632                                  	; 15/11/2023
  1633                                  	; 04/11/2023
  1634                                  	; 17/02/2017 
  1635                                  	; 07/11/2016 (Erdogan Tan)
  1636                                  
  1637                                  	;AC97_EA_VRA equ 1
  1638                                  	AC97_EA_VRA equ BIT0
  1639                                  
  1640                                  	; 04/11/2023
  1641                                  init_ac97_controller:
  1642 0000099A A1[80380000]            	mov	eax, [bus_dev_fn]
  1643 0000099F B004                    	mov	al, PCI_CMD_REG
  1644 000009A1 E857FFFFFF              	call	pciRegRead16		; read PCI command register
  1645 000009A6 80CA05                  	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
  1646 000009A9 E8D1FFFFFF              	call	pciRegWrite16
  1647                                  
  1648                                  	;call	delay_100ms
  1649                                  
  1650                                  	; 19/05/2024
  1651                                  	; ('PLAYMOD3.ASM', Erdogan Tan, 18/05/2024)
  1652                                  
  1653                                  init_ac97_codec:
  1654                                  	; 18/11/2023
  1655 000009AE BD28000000              	mov	ebp, 40
  1656                                  	; 29/05/2024
  1657                                  	;mov	ebp, 1000
  1658                                  _initc_1:
  1659                                  	; 29/05/2024
  1660 000009B3 66BA3000                	mov	dx, GLOB_STS_REG ; 30h
  1661 000009B7 660315[8A380000]        	add	dx, [NABMBAR]
  1662                                  	;in	eax, dx
  1663 000009BE B404                    	mov	ah, 4	; read port, dword
  1664 000009C0 CD34                    	int	34h
  1665                                  
  1666                                  	; 19/05/2024
  1667                                  	;call	delay1_4ms
  1668                                  
  1669 000009C2 83F8FF                  	cmp	eax, 0FFFFFFFFh ; -1
  1670 000009C5 750A                    	jne	short _initc_3
  1671                                  _initc_2:
  1672 000009C7 4D                      	dec	ebp
  1673 000009C8 7425                    	jz	short _ac97_codec_ready
  1674                                  
  1675                                  	; 31/05/2024
  1676 000009CA E8B3020000              	call	delay_100ms
  1677 000009CF EBE2                    	jmp	short _initc_1
  1678                                  _initc_3:
  1679 000009D1 A900030010              	test	eax, CTRL_ST_CREADY
  1680 000009D6 7517                    	jnz	short _ac97_codec_ready
  1681                                  
  1682                                  	; 30/05/2024
  1683 000009D8 803D[D92C0000]01        	cmp	byte [reset], 1
  1684 000009DF 73E6                    	jnb	short _initc_2
  1685                                  
  1686 000009E1 E893010000              	call	reset_ac97_codec
  1687                                  	; 30/05/2024
  1688 000009E6 C605[D92C0000]01        	mov	byte [reset], 1
  1689                                  	; 19/05/2024
  1690 000009ED EBD8                    	jmp	short _initc_2
  1691                                  
  1692                                  _ac97_codec_ready:
  1693 000009EF 668B15[88380000]        	mov	dx, [NAMBAR]
  1694                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1695                                  	;out	dx, ax
  1696                                  	; 29/05/2024
  1697 000009F6 53                      	push	ebx
  1698 000009F7 89C3                    	mov	ebx, eax ; bx = data, word
  1699 000009F9 B403                    	mov	ah, 3	; write port, word
  1700 000009FB CD34                    	int	34h
  1701 000009FD 5B                      	pop	ebx
  1702                                  
  1703                                  	; 31/05/2024
  1704                                  	; 29/05/2024
  1705                                  	;call	delay_100ms
  1706                                  
  1707                                  	; 19/11/2023
  1708 000009FE 09ED                    	or	ebp, ebp
  1709 00000A00 7539                    	jnz	short _ac97_codec_init_ok
  1710                                  
  1711 00000A02 31C0                    	xor	eax, eax ; 0
  1712 00000A04 668B15[88380000]        	mov	dx, [NAMBAR]
  1713 00000A0B 6683C226                	add	dx, CODEC_REG_POWERDOWN
  1714                                  	;out	dx, ax
  1715                                  	; 29/05/2024
  1716 00000A0F 53                      	push	ebx
  1717 00000A10 89C3                    	mov	ebx, eax
  1718 00000A12 B403                    	mov	ah, 3	; write port, word
  1719 00000A14 CD34                    	int	34h
  1720 00000A16 5B                      	pop	ebx
  1721                                  
  1722                                  	; 19/11/2023
  1723                                  	; wait for 1 second
  1724                                  	; 19/05/2024
  1725 00000A17 B9E8030000              	mov	ecx, 1000 ; 1000*4*0.25ms = 1s
  1726                                  	;;mov	ecx, 10
  1727                                  	; 30/05/2024
  1728                                  	;mov	ecx, 40
  1729                                  _ac97_codec_rloop:
  1730                                  	;call	delay_100ms
  1731                                  	; 31/05/2024
  1732 00000A1C E870020000              	call	delay1_4ms
  1733                                  
  1734                                  	;mov	dx, [NAMBAR]
  1735                                  	;add	dx, CODEC_REG_POWERDOWN
  1736                                  	;in	ax, dx
  1737                                  	; 29/05/2024
  1738 00000A21 668B15[88380000]        	mov	dx, [NAMBAR]
  1739 00000A28 6683C226                	add	dx, CODEC_REG_POWERDOWN
  1740                                  	; 31/05/2024
  1741 00000A2C B402                    	mov	ah, 2	; read port, word
  1742 00000A2E CD34                    	int	34h
  1743                                  
  1744                                  	; 31/05/2024
  1745                                  	;call	delay1_4ms
  1746                                  	
  1747 00000A30 6683E00F                	and	ax, 0Fh
  1748 00000A34 3C0F                    	cmp	al, 0Fh
  1749 00000A36 7403                    	je	short _ac97_codec_init_ok
  1750 00000A38 E2E2                    	loop	_ac97_codec_rloop 
  1751                                  
  1752                                  init_ac97_codec_err1:
  1753                                  	;stc	; cf = 1 ; 19/05/2024
  1754                                  init_ac97_codec_err2:
  1755 00000A3A C3                      	retn
  1756                                  
  1757                                  _ac97_codec_init_ok:
  1758 00000A3B E8DA000000              	call 	reset_ac97_controller
  1759                                  
  1760                                  	; 31/05/2024
  1761                                  	; 30/05/2024
  1762                                  	; 19/05/2024
  1763                                  	;call	delay_100ms
  1764                                  
  1765                                  	; 30/05/2024
  1766                                  	;call	delay1_4ms
  1767                                  	;call	delay1_4ms
  1768                                  	;call	delay1_4ms
  1769                                  	;call	delay1_4ms
  1770                                  
  1771                                  	; 01/12/2024
  1772                                  setup_ac97_codec:
  1773                                  	; 12/11/2023
  1774 00000A40 66813D[04380000]80-     	cmp	word [WAVE_SampleRate], 48000
  1774 00000A48 BB                 
  1775 00000A49 0F849C000000            	je	skip_rate
  1776                                  	
  1777                                  	; 31/05/2024
  1778                                  	; 30/05/2024
  1779                                  	; 29/05/2024
  1780                                  	;cmp	byte [VRA], 0
  1781                                  	;jna	short skip_rate
  1782                                  
  1783                                  	; 11/11/2023
  1784 00000A4F 668B15[88380000]        	mov	dx, [NAMBAR]
  1785 00000A56 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1786                                  	;in	ax, dx
  1787                                  	; 29/05/2024
  1788 00000A5A B402                    	mov	ah, 2 ; read port, word
  1789 00000A5C CD34                    	int	34h
  1790                                  
  1791                                  	; 30/05/2024
  1792                                  	; 19/05/2024
  1793 00000A5E E82E020000              	call	delay1_4ms
  1794                                  
  1795                                  	;and	al, ~BIT1 ; Clear DRA
  1796                                  	;;;
  1797                                  	; 30/05/2024
  1798 00000A63 24FC                    	and	al, ~(BIT1+BIT0) ; Clear DRA+VRA
  1799                                  	; 01/12/2024 (FASM)
  1800                                  	;and	al, NOT (BIT1+BIT0) ; 0FCh
  1801                                  	;out	dx, ax
  1802                                  	; 31/05/2024
  1803 00000A65 53                      	push	ebx
  1804 00000A66 89C3                    	mov	ebx, eax
  1805 00000A68 668B15[88380000]        	mov	dx, [NAMBAR]
  1806 00000A6F 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1807 00000A73 B403                    	mov	ah, 3 ; write port, word
  1808 00000A75 CD34                    	int	34h
  1809 00000A77 5B                      	pop	ebx
  1810                                  
  1811                                  	; 31/05/2024
  1812 00000A78 E8B1010000              	call	check_vra
  1813                                  
  1814                                  	; 31/05/2024 - temporary (interpolated sample rate test)
  1815                                  	;mov	byte [VRA], 0
  1816                                  
  1817                                  	; 31/05/2024
  1818 00000A7D 803D[E9370000]00        	cmp	byte [VRA], 0
  1819 00000A84 7665                    	jna	short skip_rate
  1820                                  
  1821 00000A86 668B15[88380000]        	mov	dx, [NAMBAR]
  1822 00000A8D 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1823                                  	;in	ax, dx
  1824                                  	; 31/05/2024
  1825 00000A91 B402                    	mov	ah, 2 ; read port, word
  1826 00000A93 CD34                    	int	34h
  1827                                  
  1828                                  	;and	al, ~BIT1 ; Clear DRA
  1829                                  	;;;
  1830                                  
  1831 00000A95 0C01                    	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
  1832                                  	;out	dx, ax	; Enable variable rate audio
  1833                                  	; 29/05/2024
  1834 00000A97 53                      	push	ebx
  1835 00000A98 89C3                    	mov	ebx, eax
  1836                                  	;
  1837                                  	; 30/05/2024
  1838 00000A9A 668B15[88380000]        	mov	dx, [NAMBAR]
  1839 00000AA1 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1840                                  	;
  1841 00000AA5 B403                    	mov	ah, 3 ; write port, word
  1842 00000AA7 CD34                    	int	34h
  1843 00000AA9 5B                      	pop	ebx
  1844                                  
  1845                                  	;mov	cx, 10
  1846 00000AAA B90A000000              	mov	ecx, 10 ; 30/05/2024
  1847                                  check_vra_loop:
  1848                                  	; 31/05/2024
  1849                                  	;call	delay_100ms
  1850                                  	; 30/05/2024
  1851 00000AAF E8DD010000              	call	delay1_4ms
  1852                                  
  1853                                  	; 11/11/2023
  1854                                  	;in	ax, dx
  1855                                  	; 29/05/2024
  1856 00000AB4 668B15[88380000]        	mov	dx, [NAMBAR]
  1857 00000ABB 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1858 00000ABF B402                    	mov	ah, 2 ; read port, word
  1859 00000AC1 CD34                    	int	34h
  1860                                  
  1861 00000AC3 A801                    	test	al, AC97_EA_VRA ; 1
  1862 00000AC5 750B                    	jnz	short set_rate
  1863                                  
  1864                                  	; 11/11/2023
  1865 00000AC7 E2E6                    	loop	check_vra_loop
  1866                                  
  1867                                  ;vra_not_supported:	; 19/05/2024
  1868 00000AC9 C605[E9370000]00        	mov	byte [VRA], 0
  1869 00000AD0 EB19                    	jmp	short skip_rate
  1870                                  
  1871                                  set_rate:
  1872                                  	;mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1873                                  	; 01/12/2024
  1874 00000AD2 66A1[04380000]          	mov	ax, [WAVE_SampleRate]
  1875                                  
  1876 00000AD8 668B15[88380000]        	mov    	dx, [NAMBAR]
  1877 00000ADF 6683C22C                	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch
  1878                                  	;out	dx, ax 	; PCM Front/Center Output Sample Rate
  1879                                  	; 29/05/2024
  1880 00000AE3 53                      	push	ebx
  1881 00000AE4 89C3                    	mov	ebx, eax  ; bx = data, word
  1882 00000AE6 B403                    	mov	ah, 3 ; write port, word
  1883 00000AE8 CD34                    	int	34h
  1884 00000AEA 5B                      	pop	ebx
  1885                                  
  1886                                  	; 29/05/2024
  1887                                  	;call	delay_100ms
  1888                                  	; 30/05/2024
  1889                                  	;call	delay1_4ms
  1890                                  
  1891                                  	; 12/11/2023
  1892                                  skip_rate:
  1893 00000AEB 66B80202                	mov	ax, 0202h
  1894 00000AEF 668B15[88380000]          	mov	dx, [NAMBAR]
  1895 00000AF6 6683C202                  	add	dx, CODEC_MASTER_VOL_REG ;02h
  1896                                  	;out	dx, ax
  1897                                  	; 29/05/2024
  1898 00000AFA 53                      	push	ebx
  1899 00000AFB 89C3                    	mov	ebx, eax  ; bx = data, word
  1900 00000AFD B403                    	mov	ah, 3 ; write port, word
  1901 00000AFF CD34                    	int	34h
  1902 00000B01 5B                      	pop	ebx
  1903                                  
  1904                                  	; 29/05/2024
  1905                                  	;call	delay1_4ms
  1906                                  	;call	delay1_4ms
  1907                                  	;call	delay1_4ms
  1908                                  	;call	delay1_4ms
  1909                                  
  1910 00000B02 66B80202                	mov	ax, 0202h
  1911 00000B06 668B15[88380000]          	mov	dx, [NAMBAR]
  1912 00000B0D 6683C218                  	add	dx, CODEC_PCM_OUT_REG		;18h
  1913                                    	;out	dx, ax
  1914                                  	; 29/05/2024
  1915 00000B11 53                      	push	ebx
  1916 00000B12 89C3                    	mov	ebx, eax  ; bx = data, word
  1917 00000B14 B403                    	mov	ah, 3 ; write port, word
  1918 00000B16 CD34                    	int	34h
  1919 00000B18 5B                      	pop	ebx
  1920                                  
  1921                                   	; 29/05/2024
  1922                                  	;call	delay1_4ms
  1923                                  	;call	delay1_4ms
  1924                                  	;call	delay1_4ms
  1925                                  	;call	delay1_4ms
  1926                                  
  1927                                  	; 19/05/2024
  1928                                  	;clc
  1929                                  
  1930 00000B19 C3                              retn
  1931                                  
  1932                                  reset_ac97_controller:
  1933                                  	; 29/05/2024 (TRDOS 386)
  1934                                  	; 19/05/2024
  1935                                  	; 11/11/2023
  1936                                  	; 10/06/2017
  1937                                  	; 29/05/2017
  1938                                  	; 28/05/2017
  1939                                  	; reset AC97 audio controller registers
  1940 00000B1A 31C0                    	xor	eax, eax
  1941 00000B1C 66BA0B00                        mov	dx, PI_CR_REG
  1942 00000B20 660315[8A380000]        	add	dx, [NABMBAR]
  1943                                  	;out	dx, al
  1944                                  	; 29/05/2024
  1945                                  	; al = data, byte
  1946 00000B27 B401                    	mov	ah, 1 ; write port, byte
  1947 00000B29 CD34                    	int	34h
  1948                                  
  1949                                  	; 19/05/2024
  1950                                  	;call	delay1_4ms
  1951                                  
  1952 00000B2B 66BA1B00                        mov     dx, PO_CR_REG
  1953 00000B2F 660315[8A380000]        	add	dx, [NABMBAR]
  1954                                  	;out	dx, al
  1955                                  	; 29/05/2024
  1956                                  	; al = data, byte
  1957 00000B36 B401                    	mov	ah, 1 ; write port, byte
  1958 00000B38 CD34                    	int	34h
  1959                                  
  1960                                  	; 19/05/2024
  1961                                  	;call	delay1_4ms
  1962                                  
  1963 00000B3A 66BA2B00                        mov     dx, MC_CR_REG
  1964 00000B3E 660315[8A380000]        	add	dx, [NABMBAR]
  1965                                  	;out	dx, al
  1966                                  	; 29/05/2024
  1967                                  	; al = data, byte
  1968 00000B45 B401                    	mov	ah, 1 ; write port, byte
  1969 00000B47 CD34                    	int	34h
  1970                                  
  1971                                  	; 19/05/2024
  1972                                  	;call	delay1_4ms
  1973                                  
  1974 00000B49 B002                            mov	al, RR
  1975 00000B4B 66BA0B00                        mov	dx, PI_CR_REG
  1976 00000B4F 660315[8A380000]        	add	dx, [NABMBAR]
  1977                                  	;out	dx, al
  1978                                  	; 29/05/2024
  1979                                  	; al = data, byte
  1980 00000B56 B401                    	mov	ah, 1 ; write port, byte
  1981 00000B58 CD34                    	int	34h
  1982                                  
  1983                                  	; 19/05/2024
  1984                                  	;call	delay1_4ms
  1985                                  
  1986 00000B5A 66BA1B00                        mov	dx, PO_CR_REG
  1987 00000B5E 660315[8A380000]        	add	dx, [NABMBAR]
  1988                                  	;out	dx, al
  1989                                  	; 29/05/2024
  1990                                  	; al = data, byte
  1991 00000B65 B401                    	mov	ah, 1 ; write port, byte
  1992 00000B67 CD34                    	int	34h
  1993                                  
  1994                                  	; 19/05/2024
  1995                                  	;call	delay1_4ms
  1996                                  
  1997 00000B69 66BA2B00                        mov	dx, MC_CR_REG
  1998 00000B6D 660315[8A380000]        	add	dx, [NABMBAR]
  1999                                  	;out	dx, al
  2000                                  	; 29/05/2024
  2001                                  	; al = data, byte
  2002 00000B74 B401                    	mov	ah, 1 ; write port, byte
  2003 00000B76 CD34                    	int	34h
  2004                                  
  2005                                  	; 19/05/2024
  2006                                  	;call	delay1_4ms
  2007                                  
  2008 00000B78 C3                      	retn
  2009                                  
  2010                                  reset_ac97_codec:
  2011                                  	; 29/05/2024 (TRDOS 386)
  2012                                  	; 11/11/2023
  2013                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  2014 00000B79 66BA2C00                	mov	dx, GLOB_CNT_REG ; 2Ch
  2015 00000B7D 660315[8A380000]        	add	dx, [NABMBAR]
  2016                                  	;in	eax, dx
  2017                                  	; 29/05/2024
  2018 00000B84 B404                    	mov	ah, 4 ; read port, dword
  2019 00000B86 CD34                    	int	34h
  2020                                  
  2021                                  	;test	eax, 2
  2022                                  	; 06/08/2022
  2023 00000B88 A802                    	test	al, 2
  2024 00000B8A 7407                    	jz	short _r_ac97codec_cold
  2025                                  
  2026 00000B8C E80F000000              	call	warm_ac97codec_reset
  2027 00000B91 7308                    	jnc	short _r_ac97codec_ok
  2028                                  _r_ac97codec_cold:
  2029 00000B93 E845000000                      call	cold_ac97codec_reset
  2030 00000B98 7301                            jnc	short _r_ac97codec_ok
  2031                                  	
  2032                                  	; 16/04/2017
  2033                                          ;xor	eax, eax	; timeout error
  2034                                         	;stc
  2035 00000B9A C3                      	retn
  2036                                  
  2037                                  _r_ac97codec_ok:
  2038 00000B9B 31C0                            xor     eax, eax
  2039                                          ;mov	al, VIA_ACLINK_C00_READY ; 1
  2040 00000B9D FEC0                            inc	al
  2041 00000B9F C3                      	retn
  2042                                  
  2043                                  warm_ac97codec_reset:
  2044                                  	; 29/05/2024 (TRDOS 386)
  2045                                  	; 11/11/2023
  2046                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  2047                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  2048 00000BA0 B806000000              	mov	eax, 6
  2049 00000BA5 66BA2C00                	mov	dx, GLOB_CNT_REG ; 2Ch
  2050 00000BA9 660315[8A380000]        	add	dx, [NABMBAR]
  2051                                  	;out	dx, eax
  2052                                  	; 29/05/2024
  2053 00000BB0 53                      	push	ebx
  2054 00000BB1 89C3                    	mov	ebx, eax  ; ebx = data, dword
  2055 00000BB3 B405                    	mov	ah, 5 ; write port, dword
  2056 00000BB5 CD34                    	int	34h
  2057 00000BB7 5B                      	pop	ebx
  2058                                  
  2059                                  	; 30/05/2024
  2060 00000BB8 B90A000000              	mov	ecx, 10	; total 1s
  2061                                  	; 29/05/2024
  2062                                  	;mov	ecx, 4000
  2063                                  _warm_ac97c_rst_wait:
  2064                                  	; 30/05/2024
  2065 00000BBD E8C0000000              	call	delay_100ms
  2066                                  
  2067 00000BC2 66BA3000                	mov	dx, GLOB_STS_REG ; 30h
  2068 00000BC6 660315[8A380000]        	add	dx, [NABMBAR]
  2069                                  	;in	eax, dx
  2070                                  	; 29/05/2024
  2071 00000BCD B404                    	mov	ah, 4 ; read port, dword
  2072 00000BCF CD34                    	int	34h
  2073                                  
  2074 00000BD1 A900030010              	test	eax, CTRL_ST_CREADY
  2075 00000BD6 7504                    	jnz	short _warm_ac97c_rst_ok
  2076                                  
  2077 00000BD8 49                      	dec	ecx
  2078 00000BD9 75E2                    	jnz	short _warm_ac97c_rst_wait
  2079                                  
  2080                                  _warm_ac97c_rst_fail:
  2081 00000BDB F9                              stc
  2082                                  _warm_ac97c_rst_ok:
  2083 00000BDC C3                      	retn
  2084                                  
  2085                                  cold_ac97codec_reset:
  2086                                  	; 11/11/2023
  2087                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  2088                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  2089 00000BDD B802000000                      mov	eax, 2
  2090 00000BE2 66BA2C00                	mov	dx, GLOB_CNT_REG ; 2Ch
  2091 00000BE6 660315[8A380000]        	add	dx, [NABMBAR]
  2092                                  	;out	dx, eax
  2093                                  	; 29/05/2024
  2094 00000BED 53                      	push	ebx
  2095 00000BEE 89C3                    	mov	ebx, eax  ; ebx = data, dword
  2096 00000BF0 B405                    	mov	ah, 5 ; write port, dword
  2097 00000BF2 CD34                    	int	34h
  2098 00000BF4 5B                      	pop	ebx
  2099                                  
  2100                                  	; 30/05/2024
  2101 00000BF5 E888000000              	call	delay_100ms 	; wait 100 ms
  2102 00000BFA E883000000              	call	delay_100ms 	; wait 100 ms
  2103 00000BFF E87E000000              	call	delay_100ms 	; wait 100 ms
  2104 00000C04 E879000000              	call	delay_100ms 	; wait 100 ms
  2105                                  
  2106                                  	; 30/05/2024
  2107 00000C09 B910000000              	mov	ecx, 16	; total 20*100 ms = 2s
  2108                                  	; 29/05/2024
  2109                                  	;mov	ecx, 16000
  2110                                  _cold_ac97c_rst_wait:
  2111 00000C0E 66BA3000                	mov	dx, GLOB_STS_REG ; 30h
  2112 00000C12 660315[8A380000]        	add	dx, [NABMBAR]
  2113                                  	;in	eax, dx
  2114                                  	; 29/05/2024
  2115 00000C19 B404                    	mov	ah, 4 ; read port, dword
  2116 00000C1B CD34                    	int	34h
  2117                                  
  2118 00000C1D A900030010              	test	eax, CTRL_ST_CREADY
  2119 00000C22 7509                    	jnz	short _cold_ac97c_rst_ok
  2120                                  
  2121                                  	; 30/05/2024
  2122                                  	; 29/05/2024
  2123 00000C24 E859000000              	call	delay_100ms
  2124                                  
  2125 00000C29 49                      	dec	ecx
  2126 00000C2A 75E2                    	jnz	short _cold_ac97c_rst_wait
  2127                                  
  2128                                  _cold_ac97c_rst_fail:
  2129 00000C2C F9                              stc
  2130                                  _cold_ac97c_rst_ok:
  2131 00000C2D C3                      	retn
  2132                                  
  2133                                  ; 29/12/2024 (vgaplay3.s, NASM)
  2134                                  ; 18/12/2024 (ac97play.s, FASM)
  2135                                  ; 13/11/2024
  2136                                  ; 30/05/2024
  2137                                  %if 1
  2138                                  ;if 1
  2139                                  check_vra:
  2140                                  	; 29/05/2024
  2141 00000C2E C605[E9370000]01        	mov	byte [VRA], 1
  2142                                  
  2143                                  	; 29/05/2024 - audio.s (TRDOS 386 Kernel) - 27/05/2024
  2144                                  	; 24/05/2024
  2145                                  	; 23/05/2024
  2146 00000C35 668B15[88380000]        	mov	dx, [NAMBAR]
  2147 00000C3C 6683C228                	add	dx, CODEC_EXT_AUDIO_REG	; 28h
  2148                                  	;in	ax, dx
  2149                                  	; 29/05/2024
  2150 00000C40 B402                    	mov	ah, 2 ; read port, word
  2151 00000C42 CD34                    	int	34h
  2152                                  
  2153                                  	; 30/05/2024
  2154                                  	; 23/05/2024
  2155 00000C44 E848000000              	call	delay1_4ms
  2156                                  
  2157                                  	; 29/05/2024
  2158 00000C49 A801                    	test	al, BIT0
  2159                                  	;test	al, 1 ; BIT0 ; Variable Rate Audio bit
  2160 00000C4B 7507                    	jnz	short check_vra_ok
  2161                                  
  2162                                  vra_not_supported:
  2163                                  	; 13/11/2023
  2164 00000C4D C605[E9370000]00        	mov	byte [VRA], 0
  2165                                  check_vra_ok:
  2166 00000C54 C3                      	retn
  2167                                  ;end if
  2168                                  %endif
  2169                                  
  2170                                  ; --------------------------------------------------------
  2171                                  ; --------------------------------------------------------
  2172                                  
  2173                                  ; 29/12/2024 (vgaplay3.s)
  2174                                  ; 18/12/2024 (ac97play.s)
  2175                                  ;
  2176                                  ; 18/11/2024
  2177                                  ; Ref: TRDOS 386 v2.0.9, audio.s, Erdogan Tan, 06/06/2024
  2178                                  
  2179                                  ac97_stop: 
  2180                                  	; 18/11/2024
  2181 00000C55 C605[DC370000]02        	mov	byte [stopped], 2
  2182                                  
  2183                                  ac97_po_cmd@:
  2184 00000C5C 30C0                    	xor	al, al ; 0
  2185                                  ac97_po_cmd:
  2186 00000C5E 668B15[8A380000]        	mov     dx, [NABMBAR]
  2187 00000C65 6683C21B                        add     dx, PO_CR_REG	; PCM out control register
  2188                                  	;out	dx, al
  2189                                  	; 01/12/2024
  2190 00000C69 B401                    	mov	ah, 1 ; write port, byte
  2191 00000C6B CD34                    	int	34h
  2192 00000C6D C3                      	retn
  2193                                  
  2194                                  ac97_pause:
  2195 00000C6E C605[DC370000]01        	mov	byte [stopped], 1 ; paused
  2196                                  	;mov	al, 0
  2197                                  	;jmp	short ac97_po_cmd
  2198 00000C75 EBE5                    	jmp	short ac97_po_cmd@
  2199                                  
  2200                                  ac97_play: ; continue to play (after pause)
  2201 00000C77 C605[DC370000]00        	mov	byte [stopped], 0
  2202 00000C7E B001                    	mov	al, RPBM
  2203 00000C80 EBDC                    	jmp	short ac97_po_cmd
  2204                                  
  2205                                  ; --------------------------------------------------------
  2206                                  
  2207                                  PORTB		EQU 061h
  2208                                  REFRESH_STATUS	EQU 010h	; Refresh signal status
  2209                                  
  2210                                  	; 29/12/2024 (vgaplay3.s)
  2211                                  	; 18/12/2024
  2212                                  	; 01/12/2024 (ac97play.s)
  2213                                  delay_100ms:
  2214                                  	; 30/05/2024 (playwav7.s)
  2215 00000C82 51                      	push	ecx
  2216 00000C83 B990010000              	mov	ecx, 400  ; 400*0.25ms
  2217                                  _delay_x_ms:
  2218 00000C88 E804000000              	call	delay1_4ms
  2219 00000C8D E2F9                            loop	_delay_x_ms
  2220 00000C8F 59                      	pop	ecx
  2221 00000C90 C3                      	retn
  2222                                  
  2223                                  delay1_4ms:
  2224                                  	; 30/05/2024 (TRDOS 386)
  2225 00000C91 50                              push    eax 
  2226 00000C92 51                              push    ecx
  2227 00000C93 53                      	push	ebx
  2228 00000C94 52                      	push	edx
  2229 00000C95 B910000000                      mov     ecx, 16			; close enough.
  2230                                  	;in	al, PORTB
  2231                                  	; 30/05/2024
  2232 00000C9A 66BA6100                	mov	dx, PORTB
  2233 00000C9E B400                    	mov	ah, 0  ; read port, byte
  2234 00000CA0 CD34                    	int	34h
  2235                                  
  2236 00000CA2 2410                    	and	al, REFRESH_STATUS
  2237                                  	;mov	ah, al			; Start toggle state
  2238 00000CA4 88C3                    	mov	bl, al
  2239 00000CA6 09C9                    	or	ecx, ecx
  2240 00000CA8 7401                    	jz	short _d4ms1
  2241 00000CAA 41                      	inc	ecx			; Throwaway first toggle
  2242                                  _d4ms1:	
  2243                                  	;in	al, PORTB		; Read system control port
  2244                                  	; 30/05/2024
  2245 00000CAB 66BA6100                	mov	dx, PORTB
  2246 00000CAF B400                    	mov	ah, 0  ; read port, byte
  2247 00000CB1 CD34                    	int	34h
  2248                                  
  2249 00000CB3 2410                    	and	al, REFRESH_STATUS	; Refresh toggles 15.085 microseconds
  2250                                  	;cmp	ah, al
  2251 00000CB5 38C3                    	cmp	bl, al
  2252 00000CB7 74F2                    	je	short _d4ms1		; Wait for state change
  2253                                  
  2254                                  	;mov	ah, al			; Update with new state
  2255 00000CB9 88C3                    	mov	bl, al
  2256 00000CBB 49                      	dec	ecx
  2257 00000CBC 75ED                    	jnz	short _d4ms1
  2258                                  
  2259 00000CBE 5A                      	pop	edx
  2260 00000CBF 5B                              pop	ebx
  2261 00000CC0 59                      	pop	ecx
  2262 00000CC1 58                              pop	eax
  2263                                  c4ue_okk:
  2264 00000CC2 C3                              retn
  2265                                  
  2266                                  ; --------------------------------------------------------
  2267                                  
  2268                                  getCurrentIndex:
  2269                                  	; returns AL = current index value
  2270                                  	; 01/12/2024
  2271                                  	; 29/05/2024 (TRDOS 386)
  2272                                  	; 08/11/2023
  2273 00000CC3 668B15[8A380000]        	mov	dx, [NABMBAR]
  2274 00000CCA 6683C214                	add	dx, PO_CIV_REG
  2275                                  	;in	al, dx
  2276                                  	; 29/05/2024
  2277 00000CCE B400                    	mov	ah, 0 ; read port, byte
  2278 00000CD0 CD34                    	int	34h
  2279                                  uLVI2:	;	06/11/2023
  2280 00000CD2 C3                      	retn
  2281                                  
  2282                                  ; --------------------------------------------------------
  2283                                  
  2284                                  updateLVI:
  2285                                  	; 01/12/2024
  2286                                  	; 29/05/2024 (TRDOS 386)
  2287                                  	; 08/11/2023
  2288                                  	; 07/11/2023
  2289                                  	; 06/11/2023
  2290 00000CD3 668B15[8A380000]        	mov	dx, [NABMBAR]
  2291 00000CDA 6683C214                	add	dx, PO_CIV_REG
  2292                                  	; (Current Index Value and Last Valid Index value)
  2293                                  	;in	ax, dx
  2294                                  	; 29/05/2024
  2295 00000CDE B402                    	mov	ah, 2 ; read port, word
  2296 00000CE0 CD34                    	int	34h
  2297                                  
  2298 00000CE2 38E0                    	cmp	al, ah ; is current index = last index ?
  2299 00000CE4 75EC                    	jne	short uLVI2
  2300                                  
  2301                                  	; 08/11/2023	
  2302 00000CE6 E8D8FFFFFF              	call	getCurrentIndex
  2303                                   
  2304 00000CEB F605[1A380000]01        	test	byte [flags], ENDOFFILE
  2305                                  	;jnz	short uLVI1
  2306 00000CF2 7418                    	jz	short uLVI0  ; 08/11/2023
  2307                                  
  2308                                  	; 08/11/2023
  2309 00000CF4 50                      	push	eax	; 29/05/2024 (32 bit)
  2310 00000CF5 668B15[8A380000]        	mov	dx, [NABMBAR]
  2311 00000CFC 6683C216                	add	dx, PO_SR_REG  ; PCM out status register
  2312                                  	;in	ax, dx
  2313                                  	; 29/05/2024
  2314 00000D00 B402                    	mov	ah, 2 ; read port, word
  2315 00000D02 CD34                    	int	34h
  2316                                  
  2317 00000D04 A803                    	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
  2318                                  		      ; (has been processed)
  2319                                  		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
  2320 00000D06 58                      	pop	eax
  2321 00000D07 7407                    	jz	short uLVI1
  2322                                  uLVI3:
  2323 00000D09 31C0                    	xor	eax, eax
  2324                                  	; zf = 1
  2325 00000D0B C3                      	retn
  2326                                  uLVI0:
  2327                                          ; not at the end of the file yet.
  2328 00000D0C FEC8                    	dec	al
  2329 00000D0E 241F                    	and	al, 1Fh
  2330                                  uLVI1:
  2331                                  	;call	setLastValidIndex
  2332                                  ;uLVI2:
  2333                                  	;retn
  2334                                  
  2335                                  ;input AL = index # to stop on
  2336                                  setLastValidIndex:
  2337                                  	; 01/12/2024
  2338                                  	; 29/05/2024 (TRDOS 386)
  2339                                  	; 08/11/2023
  2340 00000D10 668B15[8A380000]        	mov	dx, [NABMBAR]
  2341 00000D17 6683C215                	add	dx, PO_LVI_REG
  2342                                          ;out	dx, al
  2343                                  	; 29/05/2024
  2344                                  	; al = data, byte
  2345 00000D1B B401                    	mov	ah, 1 ; write port, byte
  2346 00000D1D CD34                    	int	34h
  2347 00000D1F C3                      	retn
  2348                                  
  2349                                  ; --------------------------------------------------------
  2350                                  ; 07/12/2024
  2351                                  ; --------------------------------------------------------
  2352                                  
  2353                                  ; /////
  2354                                  	; 14/12/2024
  2355                                  	; 07/12/2024
  2356                                  	; 01/12/2024
  2357                                  	; 30/05/2024 (ich_wav4.asm, 19/05/2024)
  2358                                  loadFromFile:
  2359                                  	; 07/11/2023
  2360                                  
  2361 00000D20 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2362                                  					; last of the file?
  2363 00000D27 7402                    	jz	short lff_0		; no
  2364 00000D29 F9                      	stc
  2365 00000D2A C3                      	retn
  2366                                  
  2367                                  lff_0:
  2368                                  	; 07/12/2024
  2369                                  	; 26/11/2023 (playwav8.s)
  2370                                  	;mov	edi, audio_buffer
  2371                                  
  2372                                  	; 01/12/2024 (TRDOS 386)
  2373                                  	; edi = audio buffer address
  2374                                  
  2375                                  	; 14/12/2024
  2376                                  	; 01/12/2024
  2377                                  	; 17/11/2024
  2378                                  	;mov	ebx, [filehandle]
  2379                                  	; 02/12/2024
  2380                                  	;mov	edx, [loadsize] 
  2381                                  
  2382                                  	; 17/11/2024
  2383 00000D2B 803D[7E380000]00        	cmp	byte [fbs_shift], 0
  2384 00000D32 7677                    	jna	short lff_1 ; stereo, 16 bit
  2385                                  
  2386                                  lff_2:
  2387                                  	; 01/12/2024
  2388 00000D34 BE[00500200]            	mov	esi, temp_buffer 
  2389                                  	; 14/12/2024
  2390                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000D39 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000D3F 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00000D41 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000D47 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00000D4C CD40                <1>  int 40h
  2391 00000D4E 0F8289000000            	jc	lff_4 ; error !
  2392                                  
  2393                                  	; 01/12/2024
  2394                                  	; 14/11/2024
  2395 00000D54 A3[A0380000]            	mov	[count], eax
  2396                                  
  2397                                  	; 01/12/2024
  2398 00000D59 21C0                    	and	eax, eax
  2399                                  	;jz	short lff_3
  2400                                  	; 14/12/2024
  2401 00000D5B 0F8485000000            	jz	lff_10
  2402                                  
  2403 00000D61 8A1D[7E380000]          	mov	bl, [fbs_shift]
  2404                                  
  2405                                  	; 14/12/2024
  2406 00000D67 89FA                    	mov	edx, edi ; audio buffer start address
  2407                                  
  2408                                  	; 01/12/2024
  2409 00000D69 89C1                    	mov	ecx, eax
  2410 00000D6B 803D[0E380000]08        	cmp	byte [WAVE_BitsPerSample], 8 ; bits per sample (8 or 16)
  2411 00000D72 751E                    	jne	short lff_7 ; 16 bit samples
  2412                                  	; 8 bit samples
  2413 00000D74 FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
  2414 00000D76 740E                    	jz	short lff_6 ; 8 bit, stereo
  2415                                  	; 01/12/2024 (32bit registers)
  2416                                  lff_5:
  2417                                  	; mono & 8 bit
  2418 00000D78 AC                      	lodsb
  2419 00000D79 2C80                    	sub	al, 80h ; 08/11/2023
  2420 00000D7B C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
  2421 00000D7E 66AB                    	stosw	; left channel
  2422 00000D80 66AB                    	stosw	; right channel
  2423 00000D82 E2F4                    	loop	lff_5
  2424 00000D84 EB16                    	jmp	short lff_9
  2425                                  lff_6:
  2426                                  	; stereo & 8 bit
  2427 00000D86 AC                      	lodsb
  2428 00000D87 2C80                    	sub	al, 80h ; 08/11/2023
  2429 00000D89 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
  2430 00000D8C 66AB                    	stosw
  2431 00000D8E E2F6                    	loop	lff_6
  2432 00000D90 EB0A                    	jmp	short lff_9
  2433                                  lff_7:
  2434 00000D92 D1E9                    	shr	ecx, 1 ; word count
  2435                                  lff_8:
  2436 00000D94 66AD                    	lodsw
  2437 00000D96 66AB                    	stosw	; left channel
  2438 00000D98 66AB                    	stosw	; right channel
  2439 00000D9A E2F8                    	loop	lff_8
  2440                                  lff_9:
  2441                                  	; 14/12/2024
  2442 00000D9C 89F8                    	mov	eax, edi
  2443 00000D9E 8B0D[94380000]          	mov	ecx, [buffersize] 
  2444 00000DA4 01D1                    	add	ecx, edx ; + buffer start address
  2445 00000DA6 39C8                    	cmp	eax, ecx	
  2446 00000DA8 7225                    	jb	short lff_3
  2447 00000DAA C3                      	retn
  2448                                  	
  2449                                  lff_1:  
  2450                                  	; 07/12/2024
  2451                                  	; 01/12/2024
  2452                                  	;sys 	_read, [filehandle], esi, [loadsize] ; edx
  2453                                  	; 14/12/2024
  2454                                  	sys 	_read, [filehandle], edi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000DAB 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000DB1 89F9                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00000DB3 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000DB9 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00000DBE CD40                <1>  int 40h
  2455                                  	; 07/11/2023
  2456 00000DC0 721B                    	jc	short lff_4 ; error !
  2457                                  
  2458                                  	; 01/12/2024
  2459                                  	; 14/11/2024
  2460 00000DC2 A3[A0380000]            	mov	[count], eax
  2461                                  
  2462                                  	; 02/12/2024
  2463 00000DC7 39D0                    	cmp	eax, edx ; cmp eax, [loadsize]	
  2464 00000DC9 7411                    	je	short endLFF
  2465                                  	; edi = buffer (start) address
  2466 00000DCB 01C7                    	add	edi, eax
  2467 00000DCD 89D1                    	mov	ecx, edx
  2468                                  lff_3:
  2469                                  	;call	padfill			; blank pad the remainder
  2470                                  	; 21/12/2024
  2471                                  padfill:
  2472                                  	; 14/12/2024
  2473                                  	; 01/12/2024 (TRDOS 386, 32bit registers)
  2474                                  	; 17/11/2024
  2475                                  	;   di = offset (to be filled with ZEROs)
  2476                                  	;   bp = buffer segment
  2477                                  	;   ax = di = number of bytes loaded
  2478                                  	;   cx = buffer size (> loaded bytes)	
  2479                                  	; 07/11/2023
  2480                                  	; 06/11/2023
  2481                                  	; 17/02/2017
  2482                                  	; 01/12/2024
  2483 00000DCF 29C1                    	sub	ecx, eax
  2484                                  	; 01/12/2024
  2485                                  	; 25/11/2024
  2486 00000DD1 31C0                    	xor	eax, eax
  2487                                  	; 14/12/2024
  2488 00000DD3 F3AA                    	rep	stosb
  2489                                  	; 21/12/2024
  2490                                  	;retn
  2491                                  	; ----------
  2492                                          ;clc				; don't exit with CY yet.
  2493 00000DD5 800D[1A380000]01                or	byte [flags], ENDOFFILE	; end of file flag
  2494                                  endLFF:
  2495 00000DDC C3                              retn
  2496                                  lff_4:
  2497                                  	; 08/11/2023
  2498 00000DDD B021                    	mov	al, '!'  ; error
  2499 00000DDF E882F9FFFF              	call	tL0
  2500                                  
  2501                                  	; 01/12/2024
  2502 00000DE4 31C0                    	xor	eax, eax
  2503                                  lff_10:
  2504                                  	; 14/12/2024
  2505 00000DE6 8B0D[94380000]          	mov	ecx, [buffersize]
  2506 00000DEC EBE1                    	jmp	short lff_3
  2507                                  
  2508                                  ; /////
  2509                                  
  2510                                  ; --------------------------------------------------------
  2511                                  ; --------------------------------------------------------
  2512                                  	
  2513                                  write_audio_dev_info:
  2514                                  	; 30/05/2024
  2515                                       	;sys_msg msgAudioCardInfo, 0Fh
  2516                                  	; 01/12/2024
  2517                                  	sys 	_msg, msgAudioCardInfo, 255, 0Fh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000DEE BB[DA2C0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000DF3 B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00000DF8 BA0F000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000DFD B823000000          <1>  mov eax, %1
   104                              <1> 
   105 00000E02 CD40                <1>  int 40h
  2518 00000E04 C3                      	retn
  2519                                  
  2520                                  ; --------------------------------------------------------
  2521                                  
  2522                                  write_ac97_pci_dev_info:
  2523                                  	; 19/11/2024
  2524                                  	; 30/05/2024
  2525                                  	; 06/06/2017
  2526                                  	; 03/06/2017
  2527                                  	; BUS/DEV/FN
  2528                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  2529                                  	; DEV/VENDOR
  2530                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  2531                                  
  2532 00000E05 A1[84380000]            	mov	eax, [dev_vendor]
  2533 00000E0A 31DB                    	xor	ebx, ebx
  2534 00000E0C 88C3                    	mov	bl, al
  2535 00000E0E 88DA                    	mov	dl, bl
  2536 00000E10 80E30F                  	and	bl, 0Fh
  2537 00000E13 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2538 00000E19 A2[472E0000]            	mov	[msgVendorId+3], al
  2539 00000E1E 88D3                    	mov	bl, dl
  2540 00000E20 C0EB04                  	shr	bl, 4
  2541 00000E23 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2542 00000E29 A2[462E0000]            	mov	[msgVendorId+2], al
  2543 00000E2E 88E3                    	mov	bl, ah
  2544 00000E30 88DA                    	mov	dl, bl
  2545 00000E32 80E30F                  	and	bl, 0Fh
  2546 00000E35 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2547 00000E3B A2[452E0000]            	mov	[msgVendorId+1], al
  2548 00000E40 88D3                    	mov	bl, dl
  2549 00000E42 C0EB04                  	shr	bl, 4
  2550 00000E45 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2551 00000E4B A2[442E0000]            	mov	[msgVendorId], al
  2552 00000E50 C1E810                  	shr	eax, 16
  2553 00000E53 88C3                    	mov	bl, al
  2554 00000E55 88DA                    	mov	dl, bl
  2555 00000E57 80E30F                  	and	bl, 0Fh
  2556 00000E5A 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2557 00000E60 A2[582E0000]            	mov	[msgDevId+3], al
  2558 00000E65 88D3                    	mov	bl, dl
  2559 00000E67 C0EB04                  	shr	bl, 4
  2560 00000E6A 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2561 00000E70 A2[572E0000]            	mov	[msgDevId+2], al
  2562 00000E75 88E3                    	mov	bl, ah
  2563 00000E77 88DA                    	mov	dl, bl
  2564 00000E79 80E30F                  	and	bl, 0Fh
  2565 00000E7C 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2566 00000E82 A2[562E0000]            	mov	[msgDevId+1], al
  2567 00000E87 88D3                    	mov	bl, dl
  2568 00000E89 C0EB04                  	shr	bl, 4
  2569 00000E8C 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2570 00000E92 A2[552E0000]            	mov	[msgDevId], al
  2571                                  
  2572 00000E97 A1[80380000]            	mov	eax, [bus_dev_fn]
  2573 00000E9C C1E808                  	shr	eax, 8
  2574 00000E9F 88C3                    	mov	bl, al
  2575 00000EA1 88DA                    	mov	dl, bl
  2576 00000EA3 80E307                  	and	bl, 7 ; bit 0,1,2
  2577 00000EA6 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2578 00000EAC A2[7D2E0000]            	mov	[msgFncNo+1], al
  2579 00000EB1 88D3                    	mov	bl, dl
  2580 00000EB3 C0EB03                  	shr	bl, 3
  2581 00000EB6 88DA                    	mov	dl, bl
  2582 00000EB8 80E30F                  	and	bl, 0Fh
  2583 00000EBB 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2584 00000EC1 A2[6F2E0000]            	mov	[msgDevNo+1], al
  2585 00000EC6 88D3                    	mov	bl, dl
  2586 00000EC8 C0EB04                  	shr	bl, 4
  2587 00000ECB 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2588 00000ED1 A2[6E2E0000]            	mov	[msgDevNo], al
  2589 00000ED6 88E3                    	mov	bl, ah
  2590 00000ED8 88DA                    	mov	dl, bl
  2591 00000EDA 80E30F                  	and	bl, 0Fh
  2592 00000EDD 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2593 00000EE3 A2[632E0000]            	mov	[msgBusNo+1], al
  2594 00000EE8 88D3                    	mov	bl, dl
  2595 00000EEA C0EB04                  	shr	bl, 4
  2596 00000EED 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2597 00000EF3 A2[622E0000]            	mov	[msgBusNo], al
  2598                                  
  2599                                  	;mov	ax, [ac97_NamBar]
  2600 00000EF8 66A1[88380000]          	mov	ax, [NAMBAR]
  2601 00000EFE 88C3                    	mov	bl, al
  2602 00000F00 88DA                    	mov	dl, bl
  2603 00000F02 80E30F                  	and	bl, 0Fh
  2604 00000F05 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2605 00000F0B A2[8D2E0000]            	mov	[msgNamBar+3], al
  2606 00000F10 88D3                    	mov	bl, dl
  2607 00000F12 C0EB04                  	shr	bl, 4
  2608 00000F15 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2609 00000F1B A2[8C2E0000]            	mov	[msgNamBar+2], al
  2610 00000F20 88E3                    	mov	bl, ah
  2611 00000F22 88DA                    	mov	dl, bl
  2612 00000F24 80E30F                  	and	bl, 0Fh
  2613 00000F27 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2614 00000F2D A2[8B2E0000]            	mov	[msgNamBar+1], al
  2615 00000F32 88D3                    	mov	bl, dl
  2616 00000F34 C0EB04                  	shr	bl, 4
  2617 00000F37 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2618 00000F3D A2[8A2E0000]            	mov	[msgNamBar], al
  2619                                  
  2620                                  	;mov	ax, [ac97_NabmBar]
  2621 00000F42 66A1[8A380000]          	mov	ax, [NABMBAR]
  2622 00000F48 88C3                    	mov	bl, al
  2623 00000F4A 88DA                    	mov	dl, bl
  2624 00000F4C 80E30F                  	and	bl, 0Fh
  2625 00000F4F 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2626 00000F55 A2[9D2E0000]            	mov	[msgNabmBar+3], al
  2627 00000F5A 88D3                    	mov	bl, dl
  2628 00000F5C C0EB04                  	shr	bl, 4
  2629 00000F5F 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2630 00000F65 A2[9C2E0000]            	mov	[msgNabmBar+2], al
  2631 00000F6A 88E3                    	mov	bl, ah
  2632 00000F6C 88DA                    	mov	dl, bl
  2633 00000F6E 80E30F                  	and	bl, 0Fh
  2634 00000F71 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2635 00000F77 A2[9B2E0000]            	mov	[msgNabmBar+1], al
  2636 00000F7C 88D3                    	mov	bl, dl
  2637 00000F7E C0EB04                  	shr	bl, 4
  2638 00000F81 8A83[002E0000]          	mov	al, [hex_chars+ebx]
  2639 00000F87 A2[9A2E0000]            	mov	[msgNabmBar], al
  2640                                  
  2641 00000F8C 31C0                    	xor	eax, eax
  2642 00000F8E A0[1B380000]            	mov	al, [ac97_int_ln_reg]
  2643 00000F93 B10A                    	mov	cl, 10
  2644 00000F95 F6F1                    	div	cl
  2645                                  	; 23/11/2024
  2646                                  	;add	[msgIRQ], ax
  2647 00000F97 66053030                	add	ax, 3030h
  2648 00000F9B 66A3[A62E0000]          	mov	[msgIRQ], ax
  2649                                  	;and	al, al
  2650 00000FA1 3C30                    	cmp	al, 30h
  2651 00000FA3 750D                    	jnz	short _w_ac97imsg_
  2652 00000FA5 A0[A72E0000]            	mov	al, byte [msgIRQ+1]
  2653 00000FAA B420                    	mov	ah, ' '
  2654 00000FAC 66A3[A62E0000]          	mov	[msgIRQ], ax
  2655                                  _w_ac97imsg_:
  2656                                  	; 19/11/2024
  2657 00000FB2 E86B1C0000              	call 	clear_window
  2658                                  	;mov	dh, 13
  2659                                  	; 30/12/2024 (video mode 13h)
  2660 00000FB7 B60B                    	mov	dh, 11
  2661 00000FB9 B200                    	mov	dl, 0
  2662 00000FBB E887190000              	call	setCursorPosition
  2663                                  	;;;
  2664                                  	; 21/12/2024
  2665 00000FC0 BD[112E0000]            	mov	ebp, msgAC97Info ; message
  2666                                  	; 22/12/2024
  2667                                  	;mov	cl, 07h ; color 
  2668 00000FC5 E81F000000              	call	sys_gmsg
  2669                                  	;
  2670                                  	; 30/05/2024
  2671                                  write_VRA_info:
  2672                                  	; 21/12/2024
  2673 00000FCA BD[AB2E0000]            	mov	ebp, msgVRAheader ; message
  2674                                  	;mov	cl, 07h ; color 
  2675 00000FCF E815000000              	call	sys_gmsg
  2676                                  	;
  2677 00000FD4 803D[E9370000]00        	cmp	byte [VRA], 0
  2678 00000FDB 7607                    	jna	short _w_VRAi_no
  2679                                  _w_VRAi_yes:
  2680 00000FDD BD[BA2E0000]            	mov	ebp, msgVRAyes
  2681 00000FE2 EB05                    	jmp	short _w_VRAi_yn_msg
  2682                                  _w_VRAi_no:
  2683 00000FE4 BD[C02E0000]            	mov	ebp, msgVRAno
  2684                                  _w_VRAi_yn_msg:
  2685                                  	;mov	cl, 07h ; color 
  2686                                  	;call	sys_msg
  2687                                  	;retn
  2688                                  	;jmp	short sys_gmsg
  2689                                  	;;;
  2690                                  ; --------------------------------------------------------
  2691                                  
  2692                                  	; 30/12/2024 (Video Mode 13h)
  2693                                  	; (write message in VGA/CGA mode)
  2694                                  	; 22/12/2024
  2695                                  	; 21/12/2024
  2696                                  	; (write message in VGA/VESA-VBE mode)
  2697                                  sys_gmsg:
  2698 00000FE9 8A4500                  	mov	al, [ebp]
  2699 00000FEC 20C0                    	and	al, al
  2700 00000FEE 7458                    	jz	short sys_gmsg_ok
  2701 00000FF0 3C20                    	cmp	al, 20h
  2702 00000FF2 731E                    	jnb	short sys_gmsg_3
  2703 00000FF4 3C0D                    	cmp	al, CR ; 13
  2704 00000FF6 750C                    	jne	short sys_gmsg_2
  2705                                  	; carriege return, move cursor to column 0
  2706 00000FF8 66C705[CC320000]00-     	mov	word [screenpos], 0
  2706 00001000 00                 
  2707                                  sys_gmsg_1:
  2708 00001001 45                      	inc	ebp
  2709 00001002 EBE5                    	jmp	short sys_gmsg
  2710                                  sys_gmsg_2:
  2711 00001004 3C0A                    	cmp	al, LF ; 10
  2712 00001006 7540                    	jne	short sys_gmsg_ok ; 22/12/2024
  2713                                  	; line feed, move cursor to next row
  2714                                  	;add	word [screenpos+2], 16
  2715                                  	; 30/12/2024
  2716 00001008 668305[CE320000]08      	add	word [screenpos+2], 8
  2717 00001010 EBEF                    	jmp	short sys_gmsg_1
  2718                                  sys_gmsg_3:
  2719 00001012 8B35[CC320000]          	mov	esi, [screenpos]
  2720                                  		; hw = (cursor) row
  2721                                  		; si = (cursor) column
  2722 00001018 B907000000              	mov	ecx, 07h ; gray (light)
  2723 0000101D E8DF1A0000              	call	write_character
  2724 00001022 83C608                  	add	esi, 8
  2725                                  	;;;
  2726                                  	;cmp	si, 640
  2727                                  	; 30/12/2024 (cgaplay.s)
  2728 00001025 6681FE4001              	cmp	si, 320
  2729 0000102A 7213                    	jb	short sys_gmsg_5
  2730 0000102C C1EE10                  	shr	esi, 16
  2731                                  	;add	si, 16
  2732                                  	;cmp	si, 480
  2733                                  	; 30/12/2024
  2734 0000102F 6683C608                	add	si, 8
  2735 00001033 6681FEC800              	cmp	si, 200
  2736 00001038 7202                    	jb	short sys_gmsg_4
  2737 0000103A 31F6                    	xor	esi, esi
  2738                                  sys_gmsg_4:
  2739 0000103C C1E610                  	shl	esi, 16
  2740                                  	;;;
  2741                                  sys_gmsg_5:
  2742 0000103F 8935[CC320000]          	mov	[screenpos], esi
  2743 00001045 45                      	inc	ebp
  2744 00001046 EBA1                    	jmp	short sys_gmsg
  2745                                  sys_gmsg_ok:
  2746 00001048 C3                      	retn
  2747                                  	;;;
  2748                                  
  2749                                  ; --------------------------------------------------------
  2750                                  
  2751                                  ; 29/12/2024 - vgaplay3.s
  2752                                  ; 18/12/2024
  2753                                  ; 01/12/2024 - ac97play.s
  2754                                  ; 29/05/2024
  2755                                  ; 26/11/2023
  2756                                  ; 25/11/2023 - playwav6.s (32 bit registers, TRDOS 386 adaption)
  2757                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  2758                                  ; 14/11/2023
  2759                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  2760                                  ; --------------------------------------------------------
  2761                                  
  2762                                  ;;Note:	At the end of every buffer load,
  2763                                  ;;	during buffer switch/swap, there will be discontinuity
  2764                                  ;;	between the last converted sample and the 1st sample
  2765                                  ;;	of the next buffer.
  2766                                  ;;	(like as a dot noises vaguely between normal sound samples)
  2767                                  ;;	-To avoid this defect, the 1st sample of
  2768                                  ;;	the next buffer may be read from the wav file but
  2769                                  ;;	the file pointer would need to be set to 1 sample back
  2770                                  ;;	again via seek system call. Time comsumption problem! -
  2771                                  ;;
  2772                                  ;;	Erdogan Tan - 15/11/2023
  2773                                  ;;
  2774                                  ;;	((If entire wav data would be loaded at once.. conversion
  2775                                  ;;	defect/noise would disappear.. but for DOS, to keep
  2776                                  ;;	64KB buffer limit is important also it is important
  2777                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  2778                                  ;;	I have tested this program by using 2-30MB wav files.))
  2779                                  ;;
  2780                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  2781                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  2782                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  2783                                  ;;			Realtek ALC850 codec.
  2784                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  2785                                  
  2786                                  load_8khz_mono_8_bit:
  2787                                  	; 15/11/2023
  2788                                  	; 14/11/2023
  2789                                  	; 13/11/2023
  2790 00001049 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2791                                  					; last of the file?
  2792 00001050 7402                    	jz	short lff8m_0		; no
  2793 00001052 F9                      	stc
  2794 00001053 C3                      	retn
  2795                                  
  2796                                  lff8m_0:
  2797                                  	; 01/12/2024
  2798                                  	; edi = audio buffer address
  2799                                  	; 13/12/2024
  2800 00001054 893D[D8320000]          	mov	[audio_buffer], edi
  2801 0000105A BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2802                                          ;mov	edx, [loadsize]
  2803                                  
  2804                                  	; esi = buffer address
  2805                                  	;; edx = buffer size
  2806                                  
  2807                                  	; load file into memory
  2808                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000105F 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001065 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001067 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000106D B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001072 CD40                <1>  int 40h
  2809 00001074 7305                    	jnc	short lff8m_6
  2810 00001076 E9B3000000              	jmp	lff8m_5  ; error !
  2811                                  
  2812                                  lff8m_6:
  2813                                  	; 01/12/2024
  2814 0000107B A3[A0380000]            	mov	[count], eax
  2815                                  	;mov	edi, audio_buffer
  2816                                  	; 29/05/2024
  2817 00001080 8B3D[D8320000]          	mov	edi, [audio_buffer]
  2818                                  	;and	eax, eax
  2819 00001086 0F8499000000            	jz	lff8_eof
  2820                                  
  2821 0000108C 89C1                    	mov	ecx, eax		; byte count
  2822                                  lff8m_1:
  2823 0000108E AC                      	lodsb
  2824 0000108F A2[1C270000]            	mov	[previous_val], al
  2825 00001094 2C80                    	sub	al, 80h
  2826 00001096 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2827 0000109A 66AB                    	stosw		; original sample (left channel)
  2828 0000109C 66AB                    	stosw		; original sample (right channel)
  2829                                  	;xor	eax, eax
  2830 0000109E B080                    	mov	al, 80h
  2831 000010A0 49                      	dec	ecx
  2832 000010A1 7402                    	jz	short lff8m_2
  2833 000010A3 8A06                    	mov	al, [esi]
  2834                                  lff8m_2:
  2835                                  	;mov	[next_val], ax
  2836 000010A5 88C7                    	mov	bh, al	; [next_val]
  2837 000010A7 8A25[1C270000]          	mov	ah, [previous_val]
  2838 000010AD 00E0                    	add	al, ah	; [previous_val]
  2839 000010AF D0D8                    	rcr	al, 1
  2840 000010B1 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  2841 000010B3 00E0                    	add	al, ah	; [previous_val]
  2842 000010B5 D0D8                    	rcr	al, 1	
  2843 000010B7 88C3                    	mov	bl, al 	; this is temporary interpolation value
  2844 000010B9 00E0                    	add	al, ah	; [previous_val]
  2845 000010BB D0D8                    	rcr	al, 1
  2846 000010BD 2C80                    	sub	al, 80h
  2847 000010BF 66C1E008                	shl	ax, 8	
  2848 000010C3 66AB                    	stosw		; this is 1st interpolated sample (L)
  2849 000010C5 66AB                    	stosw		; this is 1st interpolated sample (R)
  2850 000010C7 88D8                    	mov	al, bl
  2851 000010C9 00D0                    	add	al, dl
  2852 000010CB D0D8                    	rcr	al, 1
  2853 000010CD 2C80                    	sub	al, 80h
  2854 000010CF 66C1E008                	shl	ax, 8
  2855 000010D3 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2856 000010D5 66AB                    	stosw		; this is 2nd interpolated sample (R)
  2857 000010D7 88D0                    	mov	al, dl
  2858 000010D9 2C80                    	sub	al, 80h
  2859 000010DB 66C1E008                	shl	ax, 8
  2860 000010DF 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  2861 000010E1 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  2862                                  	;mov	al, [next_val]
  2863 000010E3 88F8                    	mov	al, bh
  2864 000010E5 00D0                    	add	al, dl
  2865 000010E7 D0D8                    	rcr	al, 1
  2866 000010E9 88C3                    	mov	bl, al	; this is temporary interpolation value
  2867 000010EB 00D0                    	add	al, dl
  2868 000010ED D0D8                    	rcr	al, 1
  2869 000010EF 2C80                    	sub	al, 80h
  2870 000010F1 66C1E008                	shl	ax, 8
  2871 000010F5 66AB                    	stosw		; this is 4th interpolated sample (L)
  2872 000010F7 66AB                    	stosw		; this is 4th interpolated sample (R)
  2873                                  	;mov	al, [next_val]
  2874 000010F9 88F8                    	mov	al, bh
  2875 000010FB 00D8                    	add	al, bl
  2876 000010FD D0D8                    	rcr	al, 1
  2877 000010FF 2C80                    	sub	al, 80h
  2878 00001101 66C1E008                	shl	ax, 8
  2879 00001105 66AB                    	stosw		; this is 5th interpolated sample (L)
  2880 00001107 66AB                    	stosw		; this is 5th interpolated sample (R)
  2881                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2882 00001109 09C9                    	or	ecx, ecx
  2883 0000110B 7581                    	jnz	short lff8m_1
  2884                                  
  2885                                  	; --------------
  2886                                  
  2887                                  lff8s_3:
  2888                                  lff8m_3:
  2889                                  lff8s2_3:
  2890                                  lff8m2_3:
  2891                                  lff16s_3:
  2892                                  lff16m_3:
  2893                                  lff16s2_3:
  2894                                  lff16m2_3:
  2895                                  lff24_3:
  2896                                  lff32_3:
  2897                                  lff44_3:
  2898                                  lff22_3:
  2899                                  lff11_3:
  2900                                  	; 08/12/2024 (BugFix)
  2901                                  	; 31/05/2024
  2902 0000110D 8B0D[94380000]          	mov	ecx, [buffersize] ; buffer size in words
  2903                                  	; 29/12/2024
  2904                                  	; 08/12/2024
  2905                                  	;shl	ecx, 1 ; buffer size in bytes
  2906                                  	; 13/12/2024
  2907 00001113 030D[D8320000]          	add	ecx, [audio_buffer] ; + start address of the buffer
  2908 00001119 29F9                    	sub	ecx, edi
  2909 0000111B 7607                    	jna	short lff8m_4
  2910                                  	;inc	ecx
  2911 0000111D C1E902                  	shr	ecx, 2
  2912 00001120 31C0                    	xor	eax, eax ; fill (remain part of) buffer with zeros
  2913 00001122 F3AB                    	rep	stosd
  2914                                  lff8m_4:
  2915                                  	; 31/05/2024
  2916                                  	; cf=1
  2917                                  	; 08/12/2024
  2918                                  	;clc
  2919 00001124 C3                      	retn
  2920                                  
  2921                                  lff8_eof:
  2922                                  lff16_eof:
  2923                                  lff24_eof:
  2924                                  lff32_eof:
  2925                                  lff44_eof:
  2926                                  lff22_eof:
  2927                                  lff11_eof:
  2928                                  	; 15/11/2023
  2929 00001125 C605[1A380000]01        	mov	byte [flags], ENDOFFILE
  2930 0000112C EBDF                    	jmp	short lff8m_3
  2931                                  
  2932                                  lff8s_5:
  2933                                  lff8m_5:
  2934                                  lff8s2_5:
  2935                                  lff8m2_5:
  2936                                  lff16s_5:
  2937                                  lff16m_5:
  2938                                  lff16s2_5:
  2939                                  lff16m2_5:
  2940                                  lff24_5:
  2941                                  lff32_5:
  2942                                  lff44_5:
  2943                                  lff22_5:
  2944                                  lff11_5:
  2945 0000112E B021                    	mov	al, '!'  ; error
  2946 00001130 E831F6FFFF              	call	tL0
  2947                                  	
  2948                                  	;jmp	short lff8m_3
  2949                                  	; 15/11/2023
  2950 00001135 EBEE                    	jmp	lff8_eof
  2951                                  
  2952                                  	; --------------
  2953                                  
  2954                                  load_8khz_stereo_8_bit:
  2955                                  	; 15/11/2023
  2956                                  	; 14/11/2023
  2957                                  	; 13/11/2023
  2958 00001137 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2959                                  					; last of the file?
  2960 0000113E 7402                    	jz	short lff8s_0		; no
  2961 00001140 F9                      	stc
  2962 00001141 C3                      	retn
  2963                                  
  2964                                  lff8s_0:
  2965                                  	; 01/12/2024
  2966                                  	; edi = audio buffer address
  2967                                  	; 13/12/2024
  2968 00001142 893D[D8320000]          	mov	[audio_buffer], edi
  2969 00001148 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2970                                          ;mov	edx, [loadsize]
  2971                                  
  2972                                  	; esi = buffer address
  2973                                  	;; edx = buffer size
  2974                                  
  2975                                  	; load file into memory
  2976                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000114D 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001153 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001155 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000115B B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001160 CD40                <1>  int 40h
  2977 00001162 72CA                    	jc	short lff8s_5 ; error !
  2978                                  
  2979                                  	; 01/12/2024
  2980 00001164 A3[A0380000]            	mov	[count], eax
  2981                                  
  2982                                  	;mov	edi, audio_buffer
  2983                                  	; 29/05/2024
  2984                                  	;mov	edi, [audio_buffer]
  2985                                  	
  2986 00001169 D1E8                    	shr	eax, 1
  2987 0000116B 74B8                    	jz	short lff8_eof
  2988                                  
  2989 0000116D 89C1                    	mov	ecx, eax	; word count
  2990                                  lff8s_1:
  2991 0000116F AC                      	lodsb
  2992 00001170 A2[1C270000]            	mov	[previous_val_l], al
  2993 00001175 2C80                    	sub	al, 80h
  2994 00001177 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2995 0000117B 66AB                    	stosw		; original sample (L)
  2996 0000117D AC                      	lodsb
  2997 0000117E A2[1E270000]            	mov	[previous_val_r], al
  2998 00001183 2C80                    	sub	al, 80h
  2999 00001185 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3000 00001189 66AB                    	stosw		; original sample (R)
  3001                                  
  3002                                  	;xor	eax, eax
  3003 0000118B 66B88080                	mov	ax, 8080h
  3004 0000118F 49                      	dec	ecx
  3005 00001190 7403                    	jz	short lff8s_2
  3006                                  		; convert 8 bit sample to 16 bit sample
  3007 00001192 668B06                  	mov	ax, [esi]
  3008                                  lff8s_2:
  3009 00001195 A2[20270000]            	mov	[next_val_l], al
  3010 0000119A 8825[22270000]          	mov	[next_val_r], ah
  3011 000011A0 8A25[1C270000]          	mov	ah, [previous_val_l]
  3012 000011A6 00E0                    	add	al, ah
  3013 000011A8 D0D8                    	rcr	al, 1
  3014 000011AA 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  3015 000011AC 00E0                    	add	al, ah
  3016 000011AE D0D8                    	rcr	al, 1
  3017 000011B0 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  3018 000011B2 00E0                    	add	al, ah
  3019 000011B4 D0D8                    	rcr	al, 1
  3020 000011B6 2C80                    	sub	al, 80h
  3021 000011B8 66C1E008                	shl	ax, 8
  3022 000011BC 66AB                    	stosw		; this is 1st interpolated sample (L)
  3023 000011BE A0[22270000]            	mov	al, [next_val_r]
  3024 000011C3 8A25[1E270000]          	mov	ah, [previous_val_r]
  3025 000011C9 00E0                    	add	al, ah
  3026 000011CB D0D8                    	rcr	al, 1
  3027 000011CD 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  3028 000011CF 00E0                    	add	al, ah
  3029 000011D1 D0D8                    	rcr	al, 1
  3030 000011D3 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  3031 000011D5 00E0                    	add	al, ah
  3032 000011D7 D0D8                    	rcr	al, 1
  3033 000011D9 2C80                    	sub	al, 80h
  3034 000011DB 66C1E008                	shl	ax, 8
  3035 000011DF 66AB                    	stosw		; this is 1st interpolated sample (R)
  3036 000011E1 88D8                    	mov	al, bl
  3037 000011E3 00D0                    	add	al, dl
  3038 000011E5 D0D8                    	rcr	al, 1
  3039 000011E7 2C80                    	sub	al, 80h
  3040 000011E9 66C1E008                	shl	ax, 8
  3041 000011ED 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3042 000011EF 88F8                    	mov	al, bh
  3043 000011F1 00F0                    	add	al, dh
  3044 000011F3 D0D8                    	rcr	al, 1
  3045 000011F5 2C80                    	sub	al, 80h
  3046 000011F7 66C1E008                	shl	ax, 8
  3047 000011FB 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3048 000011FD 88D0                    	mov	al, dl
  3049 000011FF 2C80                    	sub	al, 80h
  3050 00001201 66C1E008                	shl	ax, 8
  3051 00001205 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  3052 00001207 88F0                    	mov	al, dh
  3053 00001209 2C80                    	sub	al, 80h
  3054 0000120B 66C1E008                	shl	ax, 8
  3055 0000120F 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  3056 00001211 A0[20270000]            	mov	al, [next_val_l]
  3057 00001216 00D0                    	add	al, dl
  3058 00001218 D0D8                    	rcr	al, 1
  3059 0000121A 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  3060 0000121C 00D0                    	add	al, dl
  3061 0000121E D0D8                    	rcr	al, 1
  3062 00001220 2C80                    	sub	al, 80h
  3063 00001222 66C1E008                	shl	ax, 8
  3064 00001226 66AB                    	stosw		; this is 4th interpolated sample (L)
  3065 00001228 A0[22270000]            	mov	al, [next_val_r]
  3066 0000122D 00F0                    	add	al, dh
  3067 0000122F D0D8                    	rcr	al, 1
  3068 00001231 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  3069 00001233 00F0                    	add	al, dh
  3070 00001235 D0D8                    	rcr	al, 1
  3071 00001237 2C80                    	sub	al, 80h
  3072 00001239 66C1E008                	shl	ax, 8
  3073 0000123D 66AB                    	stosw		; this is 4th interpolated sample (R)
  3074 0000123F A0[20270000]            	mov	al, [next_val_l]
  3075 00001244 00D8                    	add	al, bl
  3076 00001246 D0D8                    	rcr	al, 1
  3077 00001248 2C80                    	sub	al, 80h
  3078 0000124A 66C1E008                	shl	ax, 8
  3079 0000124E 66AB                    	stosw		; this is 5th interpolated sample (L)
  3080 00001250 A0[22270000]            	mov	al, [next_val_r]
  3081 00001255 00F8                    	add	al, bh
  3082 00001257 D0D8                    	rcr	al, 1
  3083 00001259 2C80                    	sub	al, 80h
  3084 0000125B 66C1E008                	shl	ax, 8
  3085 0000125F 66AB                    	stosw		; this is 5th interpolated sample (R)
  3086                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3087 00001261 E305                    	jecxz	lff8s_6
  3088 00001263 E907FFFFFF              	jmp	lff8s_1
  3089                                  lff8s_6:
  3090 00001268 E9A0FEFFFF              	jmp	lff8s_3
  3091                                  
  3092                                  load_8khz_mono_16_bit:
  3093                                  	; 13/11/2023
  3094 0000126D F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3095                                  					; last of the file?
  3096 00001274 7402                    	jz	short lff8m2_0		; no
  3097 00001276 F9                      	stc
  3098 00001277 C3                      	retn
  3099                                  
  3100                                  lff8m2_0:
  3101                                  	; 01/12/2024
  3102                                  	; edi = audio buffer address
  3103                                  	; 13/12/2024
  3104 00001278 893D[D8320000]          	mov	[audio_buffer], edi
  3105 0000127E BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3106                                          ;mov	edx, [loadsize]
  3107                                  
  3108                                  	; esi = buffer address
  3109                                  	;; edx = buffer size
  3110                                  
  3111                                  	; load file into memory
  3112                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001283 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001289 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000128B 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001291 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001296 CD40                <1>  int 40h
  3113 00001298 0F82A0000000            	jc	lff8m2_7 ; error !
  3114                                  
  3115                                  	; 01/12/2024
  3116 0000129E A3[A0380000]            	mov	[count], eax
  3117                                  
  3118                                  	;mov	edi, audio_buffer
  3119                                  	; 29/05/2024
  3120                                  	;mov	edi, [audio_buffer]
  3121                                  	
  3122 000012A3 D1E8                    	shr	eax, 1
  3123 000012A5 7505                    	jnz	short lff8m2_8
  3124 000012A7 E979FEFFFF              	jmp	lff8_eof
  3125                                  
  3126                                  lff8m2_8:
  3127 000012AC 89C1                    	mov	ecx, eax	; word count
  3128                                  lff8m2_1:
  3129 000012AE 66AD                    	lodsw
  3130 000012B0 66AB                    	stosw		; original sample (left channel)
  3131 000012B2 66AB                    	stosw		; original sample (right channel)
  3132 000012B4 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3133 000012B7 66A3[1C270000]          	mov	[previous_val], ax
  3134 000012BD 31C0                    	xor	eax, eax
  3135 000012BF 49                      	dec	ecx
  3136 000012C0 7403                    	jz	short lff8m2_2
  3137 000012C2 668B06                  	mov	ax, [esi]
  3138                                  lff8m2_2:
  3139 000012C5 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  3140 000012C8 89C5                    	mov	ebp, eax	; [next_val]
  3141 000012CA 660305[1C270000]        	add	ax, [previous_val]
  3142 000012D1 66D1D8                  	rcr	ax, 1
  3143 000012D4 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample
  3144 000012D6 660305[1C270000]        	add	ax, [previous_val]
  3145 000012DD 66D1D8                  	rcr	ax, 1	; this is temporary interpolation value
  3146 000012E0 89C3                    	mov	ebx, eax 		
  3147 000012E2 660305[1C270000]        	add	ax, [previous_val]
  3148 000012E9 66D1D8                  	rcr	ax, 1
  3149 000012EC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3150 000012EF 66AB                    	stosw		; this is 1st interpolated sample (L)
  3151 000012F1 66AB                    	stosw		; this is 1st interpolated sample (R)
  3152 000012F3 89D8                    	mov	eax, ebx
  3153 000012F5 6601D0                  	add	ax, dx
  3154 000012F8 66D1D8                  	rcr	ax, 1
  3155 000012FB 80EC80                  	sub	ah, 80h
  3156 000012FE 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3157 00001300 66AB                    	stosw		; this is 2nd interpolated sample (R)
  3158 00001302 89D0                    	mov	eax, edx
  3159 00001304 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3160 00001307 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  3161 00001309 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  3162 0000130B 89E8                    	mov	eax, ebp
  3163 0000130D 6601D0                  	add	ax, dx
  3164 00001310 66D1D8                  	rcr	ax, 1
  3165 00001313 89C3                    	mov	ebx, eax ; this is temporary interpolation value
  3166 00001315 6601D0                  	add	ax, dx
  3167 00001318 66D1D8                  	rcr	ax, 1
  3168 0000131B 80EC80                  	sub	ah, 80h
  3169 0000131E 66AB                    	stosw		; this is 4th interpolated sample (L)
  3170 00001320 66AB                    	stosw		; this is 4th interpolated sample (R)
  3171 00001322 89E8                    	mov	eax, ebp
  3172 00001324 6601D8                  	add	ax, bx
  3173 00001327 66D1D8                  	rcr	ax, 1
  3174 0000132A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3175 0000132D 66AB                    	stosw		; this is 5th interpolated sample (L)
  3176 0000132F 66AB                    	stosw		; this is 5th interpolated sample (R)
  3177                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3178 00001331 09C9                    	or	ecx, ecx
  3179 00001333 0F8575FFFFFF            	jnz	lff8m2_1
  3180 00001339 E9CFFDFFFF              	jmp	lff8m2_3
  3181                                  
  3182                                  lff8m2_7:
  3183                                  lff8s2_7:
  3184 0000133E E9EBFDFFFF              	jmp	lff8m2_5  ; error
  3185                                  
  3186                                  load_8khz_stereo_16_bit:
  3187                                  	; 16/11/2023
  3188                                  	; 15/11/2023
  3189                                  	; 13/11/2023
  3190 00001343 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3191                                  					; last of the file?
  3192 0000134A 7402                    	jz	short lff8s2_0		; no
  3193 0000134C F9                      	stc
  3194 0000134D C3                      	retn
  3195                                  
  3196                                  lff8s2_0:
  3197                                  	; 01/12/2024
  3198                                  	; edi = audio buffer address
  3199                                  	; 13/12/2024
  3200 0000134E 893D[D8320000]          	mov	[audio_buffer], edi
  3201 00001354 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3202                                          ;mov	edx, [loadsize]
  3203                                  
  3204                                  	; esi = buffer address
  3205                                  	;; edx = buffer size
  3206                                  
  3207                                  	; load file into memory
  3208                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001359 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000135F 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001361 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001367 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 0000136C CD40                <1>  int 40h
  3209 0000136E 72CE                    	jc	short lff8s2_7 ; error !
  3210                                  
  3211                                  	; 01/12/2024
  3212 00001370 A3[A0380000]            	mov	[count], eax
  3213                                  
  3214                                  	;mov	edi, audio_buffer
  3215                                  	; 29/05/2024
  3216                                  	;mov	edi, [audio_buffer]
  3217                                  	
  3218 00001375 C1E802                  	shr	eax, 2
  3219 00001378 7505                    	jnz	short lff8s2_8
  3220 0000137A E9A6FDFFFF              	jmp	lff8_eof
  3221                                  
  3222                                  lff8s2_8:
  3223 0000137F 89C1                    	mov	ecx, eax ; dword count
  3224                                  lff8s2_1:
  3225 00001381 66AD                    	lodsw
  3226 00001383 66AB                    	stosw		; original sample (L)
  3227                                  	; 15/11/2023
  3228 00001385 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3229 00001388 66A3[1C270000]          	mov	[previous_val_l], ax
  3230 0000138E 66AD                    	lodsw
  3231 00001390 66AB                    	stosw		; original sample (R)
  3232 00001392 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3233 00001395 66A3[1E270000]          	mov	[previous_val_r], ax
  3234 0000139B 31D2                    	xor	edx, edx
  3235 0000139D 31C0                    	xor	eax, eax
  3236                                  	; 16/11/2023
  3237 0000139F 49                      	dec	ecx
  3238 000013A0 7407                    	jz	short lff8s2_2
  3239 000013A2 668B06                  	mov	ax, [esi]
  3240 000013A5 668B5602                	mov	dx, [esi+2]
  3241                                  lff8s2_2:
  3242 000013A9 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3243 000013AC 66A3[20270000]          	mov	[next_val_l], ax
  3244 000013B2 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  3245 000013B5 668915[22270000]        	mov	[next_val_r], dx
  3246 000013BC 660305[1C270000]        	add	ax, [previous_val_l]
  3247 000013C3 66D1D8                  	rcr	ax, 1
  3248 000013C6 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample (L)
  3249 000013C8 660305[1C270000]        	add	ax, [previous_val_l]
  3250 000013CF 66D1D8                  	rcr	ax, 1	
  3251 000013D2 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  3252 000013D4 660305[1C270000]        	add	ax, [previous_val_l]
  3253 000013DB 66D1D8                  	rcr	ax, 1
  3254 000013DE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3255 000013E1 66AB                    	stosw		; this is 1st interpolated sample (L)
  3256 000013E3 66A1[22270000]          	mov	ax, [next_val_r]
  3257 000013E9 660305[1E270000]        	add	ax, [previous_val_r]
  3258 000013F0 66D1D8                  	rcr	ax, 1
  3259 000013F3 89C5                    	mov	ebp, eax ; this is interpolated middle (3th) sample (R)
  3260 000013F5 660305[1E270000]        	add	ax, [previous_val_r]
  3261 000013FC 66D1D8                  	rcr	ax, 1
  3262 000013FF 50                      	push	eax ; *	; this is temporary interpolation value (R)
  3263 00001400 660305[1E270000]        	add	ax, [previous_val_r]
  3264 00001407 66D1D8                  	rcr	ax, 1
  3265 0000140A 80EC80                  	sub	ah, 80h
  3266 0000140D 66AB                    	stosw		; this is 1st interpolated sample (R)
  3267 0000140F 89D8                    	mov	eax, ebx
  3268 00001411 6601D0                  	add	ax, dx
  3269 00001414 66D1D8                  	rcr	ax, 1
  3270 00001417 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3271 0000141A 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3272 0000141C 58                      	pop	eax ; *
  3273 0000141D 6601E8                  	add	ax, bp
  3274 00001420 66D1D8                  	rcr	ax, 1
  3275 00001423 80EC80                  	sub	ah, 80h
  3276 00001426 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3277 00001428 89D0                    	mov	eax, edx
  3278 0000142A 80EC80                  	sub	ah, 80h
  3279 0000142D 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  3280 0000142F 89E8                    	mov	eax, ebp
  3281 00001431 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3282 00001434 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  3283 00001436 66A1[20270000]          	mov	ax, [next_val_l]
  3284 0000143C 6601D0                  	add	ax, dx
  3285 0000143F 66D1D8                  	rcr	ax, 1
  3286 00001442 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  3287 00001444 6601D0                  	add	ax, dx
  3288 00001447 66D1D8                  	rcr	ax, 1
  3289 0000144A 80EC80                  	sub	ah, 80h
  3290 0000144D 66AB                    	stosw		; this is 4th interpolated sample (L)
  3291 0000144F 66A1[22270000]          	mov	ax, [next_val_r]
  3292 00001455 6601E8                  	add	ax, bp
  3293 00001458 66D1D8                  	rcr	ax, 1
  3294 0000145B 50                      	push	eax ; ** ; this is temporary interpolation value (R)
  3295 0000145C 6601E8                  	add	ax, bp
  3296 0000145F 66D1D8                  	rcr	ax, 1
  3297 00001462 80EC80                  	sub	ah, 80h
  3298 00001465 66AB                    	stosw		; this is 4th interpolated sample (R)
  3299 00001467 66A1[20270000]          	mov	ax, [next_val_l]
  3300 0000146D 6601D8                  	add	ax, bx
  3301 00001470 66D1D8                  	rcr	ax, 1
  3302 00001473 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3303 00001476 66AB                    	stosw		; this is 5th interpolated sample (L)
  3304 00001478 58                      	pop	eax ; **
  3305 00001479 660305[22270000]        	add	ax, [next_val_r]
  3306 00001480 66D1D8                  	rcr	ax, 1
  3307 00001483 80EC80                  	sub	ah, 80h
  3308 00001486 66AB                    	stosw		; this is 5th interpolated sample (R)
  3309                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3310 00001488 E305                    	jecxz	lff8_s2_9
  3311 0000148A E9F2FEFFFF              	jmp	lff8s2_1
  3312                                  lff8_s2_9:
  3313 0000148F E979FCFFFF              	jmp	lff8s2_3
  3314                                  
  3315                                  ; .....................
  3316                                  
  3317                                  load_16khz_mono_8_bit:
  3318                                  	; 14/11/2023
  3319                                  	; 13/11/2023
  3320 00001494 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3321                                  					; last of the file?
  3322 0000149B 7402                    	jz	short lff16m_0		; no
  3323 0000149D F9                      	stc
  3324 0000149E C3                      	retn
  3325                                  
  3326                                  lff16m_0:
  3327                                  	; 01/12/2024
  3328                                  	; edi = audio buffer address
  3329                                  	; 13/12/2024
  3330 0000149F 893D[D8320000]          	mov	[audio_buffer], edi
  3331 000014A5 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3332                                          ;mov	edx, [loadsize]
  3333                                  
  3334                                  	; esi = buffer address
  3335                                  	;; edx = buffer size
  3336                                  
  3337                                  	; load file into memory
  3338                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000014AA 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000014B0 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000014B2 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000014B8 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 000014BD CD40                <1>  int 40h
  3339 000014BF 7253                    	jc	short lff16m_7 ; error !
  3340                                  
  3341                                  	; 01/12/2024
  3342 000014C1 A3[A0380000]            	mov	[count], eax
  3343                                  
  3344                                  	;mov	edi, audio_buffer
  3345                                  	; 29/05/2024
  3346                                  	;mov	edi, [audio_buffer]
  3347                                  	
  3348 000014C6 21C0                    	and	eax, eax
  3349 000014C8 7505                    	jnz	short lff16m_8
  3350 000014CA E956FCFFFF              	jmp	lff16_eof
  3351                                  
  3352                                  lff16m_8:
  3353 000014CF 89C1                    	mov	ecx, eax		; byte count
  3354                                  lff16m_1:
  3355 000014D1 AC                      	lodsb
  3356                                  	;mov	[previous_val], al
  3357 000014D2 88C3                    	mov	bl, al
  3358 000014D4 2C80                    	sub	al, 80h
  3359 000014D6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3360 000014DA 66AB                    	stosw		; original sample (left channel)
  3361 000014DC 66AB                    	stosw		; original sample (right channel)
  3362                                  	;xor	ax, ax
  3363                                  	; 14/11/22023
  3364 000014DE B080                    	mov	al, 80h
  3365 000014E0 49                      	dec	ecx
  3366 000014E1 7402                    	jz	short lff16m_2
  3367 000014E3 8A06                    	mov	al, [esi]
  3368                                  lff16m_2:
  3369                                  	;mov	[next_val], al
  3370 000014E5 88C7                    	mov	bh, al
  3371                                  	;add	al, [previous_val]
  3372 000014E7 00D8                    	add	al, bl
  3373 000014E9 D0D8                    	rcr	al, 1
  3374 000014EB 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  3375                                  	;add	al, [previous_val]
  3376 000014ED 00D8                    	add	al, bl
  3377 000014EF D0D8                    	rcr	al, 1
  3378 000014F1 2C80                    	sub	al, 80h
  3379 000014F3 66C1E008                	shl	ax, 8
  3380 000014F7 66AB                    	stosw		; this is 1st interpolated sample (L)
  3381 000014F9 66AB                    	stosw		; this is 1st interpolated sample (R)
  3382                                  	;mov	al, [next_val]
  3383 000014FB 88F8                    	mov	al, bh
  3384 000014FD 00D0                    	add	al, dl
  3385 000014FF D0D8                    	rcr	al, 1
  3386 00001501 2C80                    	sub	al, 80h
  3387 00001503 66C1E008                	shl	ax, 8
  3388 00001507 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3389 00001509 66AB                    	stosw		; this is 2nd interpolated sample (R)
  3390                                  	
  3391                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3392 0000150B 09C9                    	or	ecx, ecx
  3393 0000150D 75C2                    	jnz	short lff16m_1
  3394 0000150F E9F9FBFFFF              	jmp	lff16m_3
  3395                                  
  3396                                  lff16m_7:
  3397                                  lff16s_7:
  3398 00001514 E915FCFFFF              	jmp	lff16m_5  ; error
  3399                                  
  3400                                  load_16khz_stereo_8_bit:
  3401                                  	; 14/11/2023
  3402                                  	; 13/11/2023
  3403 00001519 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3404                                  					; last of the file?
  3405 00001520 7402                    	jz	short lff16s_0		; no
  3406 00001522 F9                      	stc
  3407 00001523 C3                      	retn
  3408                                  
  3409                                  lff16s_0:
  3410                                  	; 01/12/2024
  3411                                  	; edi = audio buffer address
  3412                                  	; 13/12/2024
  3413 00001524 893D[D8320000]          	mov	[audio_buffer], edi
  3414 0000152A BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3415                                          ;mov	edx, [loadsize]
  3416                                  
  3417                                  	; esi = buffer address
  3418                                  	;; edx = buffer size
  3419                                  
  3420                                  	; load file into memory
  3421                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000152F 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001535 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001537 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000153D B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001542 CD40                <1>  int 40h
  3422 00001544 72CE                    	jc	short lff16s_7 ; error !
  3423                                  
  3424                                  	; 01/12/2024
  3425 00001546 A3[A0380000]            	mov	[count], eax
  3426                                  
  3427                                  	;mov	edi, audio_buffer
  3428                                  	; 29/05/2024
  3429                                  	;mov	edi, [audio_buffer]
  3430                                  	
  3431 0000154B D1E8                    	shr	eax, 1
  3432 0000154D 7505                    	jnz	short lff16s_8
  3433 0000154F E9D1FBFFFF              	jmp	lff16_eof
  3434                                  
  3435                                  lff16s_8:
  3436 00001554 89C1                    	mov	ecx, eax	; word count
  3437                                  lff16s_1:
  3438 00001556 AC                      	lodsb
  3439 00001557 A2[1C270000]            	mov	[previous_val_l], al
  3440 0000155C 2C80                    	sub	al, 80h
  3441 0000155E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3442 00001562 66AB                    	stosw		; original sample (L)
  3443 00001564 AC                      	lodsb
  3444 00001565 A2[1E270000]            	mov	[previous_val_r], al
  3445 0000156A 2C80                    	sub	al, 80h
  3446 0000156C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3447 00001570 66AB                    	stosw		; original sample (R)
  3448                                  
  3449                                  	;xor	eax, eax
  3450 00001572 66B88080                	mov	ax, 8080h
  3451 00001576 49                      	dec	ecx
  3452 00001577 7403                    	jz	short lff16s_2
  3453                                  		; convert 8 bit sample to 16 bit sample
  3454 00001579 668B06                  	mov	ax, [esi]
  3455                                  lff16s_2:
  3456                                  	;mov	[next_val_l], al
  3457                                  	;mov	[next_val_r], ah
  3458 0000157C 89C3                    	mov	ebx, eax
  3459 0000157E 0205[1C270000]          	add	al, [previous_val_l]
  3460 00001584 D0D8                    	rcr	al, 1
  3461 00001586 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  3462 00001588 0205[1C270000]          	add	al, [previous_val_l]
  3463 0000158E D0D8                    	rcr	al, 1
  3464 00001590 2C80                    	sub	al, 80h
  3465 00001592 66C1E008                	shl	ax, 8
  3466 00001596 66AB                    	stosw		; this is 1st interpolated sample (L)
  3467 00001598 88F8                    	mov	al, bh	; [next_val_r]
  3468 0000159A 0205[1E270000]          	add	al, [previous_val_r]
  3469 000015A0 D0D8                    	rcr	al, 1
  3470 000015A2 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  3471 000015A4 0205[1E270000]          	add	al, [previous_val_r]
  3472 000015AA D0D8                    	rcr	al, 1
  3473 000015AC 2C80                    	sub	al, 80h
  3474 000015AE 66C1E008                	shl	ax, 8
  3475 000015B2 66AB                    	stosw		; this is 1st interpolated sample (R)
  3476 000015B4 88D0                    	mov	al, dl
  3477 000015B6 00D8                    	add	al, bl	; [next_val_l]
  3478 000015B8 D0D8                    	rcr	al, 1
  3479 000015BA 2C80                    	sub	al, 80h
  3480 000015BC 66C1E008                	shl	ax, 8
  3481 000015C0 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3482 000015C2 88F0                    	mov	al, dh
  3483 000015C4 00F8                    	add	al, bh	; [next_val_r]
  3484 000015C6 D0D8                    	rcr	al, 1
  3485 000015C8 2C80                    	sub	al, 80h
  3486 000015CA 66C1E008                	shl	ax, 8
  3487 000015CE 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3488                                  	
  3489                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3490 000015D0 09C9                    	or	ecx, ecx
  3491 000015D2 7582                    	jnz	short lff16s_1
  3492 000015D4 E934FBFFFF              	jmp	lff16s_3
  3493                                  
  3494                                  load_16khz_mono_16_bit:
  3495                                  	; 15/11/2023
  3496                                  	; 13/11/2023
  3497 000015D9 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3498                                  					; last of the file?
  3499 000015E0 7402                    	jz	short lff16m2_0		; no
  3500 000015E2 F9                      	stc
  3501 000015E3 C3                      	retn
  3502                                  
  3503                                  lff16m2_0:
  3504                                  	; 01/12/2024
  3505                                  	; edi = audio buffer address
  3506                                  	; 13/12/2024
  3507 000015E4 893D[D8320000]          	mov	[audio_buffer], edi
  3508 000015EA BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3509                                          ;mov	edx, [loadsize]
  3510                                  
  3511                                  	; esi = buffer address
  3512                                  	;; edx = buffer size
  3513                                  
  3514                                  	; load file into memory
  3515                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000015EF 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000015F5 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000015F7 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000015FD B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001602 CD40                <1>  int 40h
  3516 00001604 7255                    	jc	short lff16m2_7 ; error !
  3517                                  
  3518                                  	; 01/12/2024
  3519 00001606 A3[A0380000]            	mov	[count], eax
  3520                                  
  3521                                  	;mov	edi, audio_buffer
  3522                                  	; 29/05/2024
  3523                                  	;mov	edi, [audio_buffer]
  3524                                  	
  3525 0000160B D1E8                    	shr	eax, 1
  3526 0000160D 7505                    	jnz	short lff16m2_8
  3527 0000160F E911FBFFFF              	jmp	lff16_eof
  3528                                  
  3529                                  lff16m2_8:
  3530 00001614 89C1                    	mov	ecx, eax  ; word count
  3531                                  lff16m2_1:
  3532 00001616 66AD                    	lodsw
  3533 00001618 66AB                    	stosw		; original sample (left channel)
  3534 0000161A 66AB                    	stosw		; original sample (right channel)
  3535 0000161C 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3536                                  	;mov	[previous_val], ax
  3537 0000161F 89C3                    	mov	ebx, eax
  3538 00001621 31C0                    	xor	eax, eax
  3539 00001623 49                      	dec	ecx
  3540 00001624 7403                    	jz	short lff16m2_2
  3541 00001626 668B06                  	mov	ax, [esi]
  3542                                  lff16m2_2:
  3543 00001629 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3544 0000162C 89C5                    	mov	ebp, eax	; [next_val]
  3545                                  	;add	ax, [previous_val]
  3546 0000162E 6601D8                  	add	ax, bx
  3547 00001631 66D1D8                  	rcr	ax, 1
  3548 00001634 89C2                    	mov	edx, eax ; this is temporary interpolation value
  3549                                  	;add	ax, [previous_val]
  3550 00001636 6601D8                  	add	ax, bx
  3551 00001639 66D1D8                  	rcr	ax, 1
  3552 0000163C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3553 0000163F 66AB                    	stosw		; this is 1st interpolated sample (L)
  3554 00001641 66AB                    	stosw		; this is 1st interpolated sample (R)
  3555 00001643 89E8                    	mov	eax, ebp
  3556 00001645 6601D0                  	add	ax, dx
  3557 00001648 66D1D8                  	rcr	ax, 1
  3558 0000164B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3559 0000164E 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3560 00001650 66AB                    	stosw		; this is 2nd interpolated sample (R)
  3561                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3562 00001652 09C9                    	or	ecx, ecx
  3563 00001654 75C0                    	jnz	short lff16m2_1
  3564 00001656 E9B2FAFFFF              	jmp	lff16m2_3
  3565                                  
  3566                                  lff16m2_7:
  3567                                  lff16s2_7:
  3568 0000165B E9CEFAFFFF              	jmp	lff16m2_5  ; error
  3569                                  
  3570                                  load_16khz_stereo_16_bit:
  3571                                  	; 16/11/2023
  3572                                  	; 15/11/2023
  3573                                  	; 13/11/2023
  3574 00001660 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3575                                  					; last of the file?
  3576 00001667 7402                    	jz	short lff16s2_0		; no
  3577 00001669 F9                      	stc
  3578 0000166A C3                      	retn
  3579                                  
  3580                                  lff16s2_0:
  3581                                  	; 01/12/2024
  3582                                  	; edi = audio buffer address
  3583                                  	; 13/12/2024
  3584 0000166B 893D[D8320000]          	mov	[audio_buffer], edi
  3585 00001671 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3586                                          ;mov	edx, [loadsize]
  3587                                  
  3588                                  	; esi = buffer address
  3589                                  	;; edx = buffer size
  3590                                  
  3591                                  	; load file into memory
  3592                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001676 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000167C 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000167E 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001684 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001689 CD40                <1>  int 40h
  3593 0000168B 72CE                    	jc	short lff16s2_7 ; error !
  3594                                  
  3595                                  	; 01/12/2024
  3596 0000168D A3[A0380000]            	mov	[count], eax
  3597                                  
  3598                                  	;mov	edi, audio_buffer
  3599                                  	; 29/05/2024
  3600                                  	;mov	edi, [audio_buffer]
  3601                                  	
  3602 00001692 C1E802                  	shr	eax, 2
  3603 00001695 7505                    	jnz	short lff16s2_8
  3604 00001697 E989FAFFFF              	jmp	lff16_eof
  3605                                  
  3606                                  lff16s2_8:
  3607 0000169C 89C1                    	mov	ecx, eax  ; dword count
  3608                                  lff16s2_1:
  3609 0000169E 66AD                    	lodsw
  3610 000016A0 66AB                    	stosw		; original sample (L)
  3611 000016A2 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3612 000016A5 66A3[1C270000]          	mov	[previous_val_l], ax
  3613 000016AB 66AD                    	lodsw
  3614 000016AD 66AB                    	stosw		; original sample (R)
  3615 000016AF 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3616 000016B2 66A3[1E270000]          	mov	[previous_val_r], ax
  3617 000016B8 31D2                    	xor	edx, edx
  3618 000016BA 31C0                    	xor	eax, eax
  3619                                  	; 16/11/2023
  3620 000016BC 49                      	dec	ecx
  3621 000016BD 7407                    	jz	short lff16s2_2
  3622 000016BF 668B06                  	mov	ax, [esi]
  3623 000016C2 668B5602                	mov	dx, [esi+2]
  3624                                  lff16s2_2:
  3625 000016C6 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3626                                  	;mov	[next_val_l], ax
  3627 000016C9 89C5                    	mov	ebp, eax
  3628 000016CB 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  3629 000016CE 668915[22270000]        	mov	[next_val_r], dx
  3630 000016D5 660305[1C270000]        	add	ax, [previous_val_l]
  3631 000016DC 66D1D8                  	rcr	ax, 1
  3632 000016DF 89C2                    	mov	edx, eax ; this is temporary interpolation value (L)
  3633 000016E1 660305[1C270000]        	add	ax, [previous_val_l]
  3634 000016E8 66D1D8                  	rcr	ax, 1
  3635 000016EB 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  3636 000016EE 66AB                    	stosw		; this is 1st interpolated sample (L)
  3637 000016F0 66A1[22270000]          	mov	ax, [next_val_r]
  3638 000016F6 660305[1E270000]        	add	ax, [previous_val_r]
  3639 000016FD 66D1D8                  	rcr	ax, 1
  3640 00001700 89C3                    	mov	ebx, eax ; this is temporary interpolation value (R)
  3641 00001702 660305[1E270000]        	add	ax, [previous_val_r]
  3642 00001709 66D1D8                  	rcr	ax, 1
  3643 0000170C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3644 0000170F 66AB                    	stosw		; this is 1st interpolated sample (R)
  3645                                  	;mov	ax, [next_val_l]
  3646 00001711 89E8                    	mov	eax, ebp
  3647 00001713 6601D0                  	add	ax, dx
  3648 00001716 66D1D8                  	rcr	ax, 1
  3649 00001719 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3650 0000171C 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3651 0000171E 66A1[22270000]          	mov	ax, [next_val_r]
  3652 00001724 6601D8                  	add	ax, bx
  3653 00001727 66D1D8                  	rcr	ax, 1
  3654 0000172A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3655 0000172D 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3656                                  	
  3657                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3658 0000172F 09C9                    	or	ecx, ecx
  3659 00001731 0F8567FFFFFF            	jnz	lff16s2_1
  3660 00001737 E9D1F9FFFF              	jmp	lff16s2_3
  3661                                  
  3662                                  ; .....................
  3663                                  
  3664                                  load_24khz_mono_8_bit:
  3665                                  	; 15/11/2023
  3666 0000173C F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3667                                  					; last of the file?
  3668 00001743 7402                    	jz	short lff24m_0		; no
  3669 00001745 F9                      	stc
  3670 00001746 C3                      	retn
  3671                                  
  3672                                  lff24m_0:
  3673                                  	; 01/12/2024
  3674                                  	; edi = audio buffer address
  3675                                  	; 13/12/2024
  3676 00001747 893D[D8320000]          	mov	[audio_buffer], edi
  3677 0000174D BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3678                                          ;mov	edx, [loadsize]
  3679                                  
  3680                                  	; esi = buffer address
  3681                                  	;; edx = buffer size
  3682                                  
  3683                                  	; load file into memory
  3684                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001752 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001758 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000175A 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001760 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001765 CD40                <1>  int 40h
  3685 00001767 723B                    	jc	short lff24m_7 ; error !
  3686                                  
  3687                                  	; 01/12/2024
  3688 00001769 A3[A0380000]            	mov	[count], eax
  3689                                  
  3690                                  	;mov	edi, audio_buffer
  3691                                  	; 29/05/2024
  3692                                  	;mov	edi, [audio_buffer]
  3693                                  	
  3694 0000176E 21C0                    	and	eax, eax
  3695 00001770 7505                    	jnz	short lff24m_8
  3696 00001772 E9AEF9FFFF              	jmp	lff24_eof
  3697                                  
  3698                                  lff24m_8:
  3699 00001777 89C1                    	mov	ecx, eax	; byte count
  3700                                  lff24m_1:
  3701 00001779 AC                      	lodsb
  3702                                  	;mov	[previous_val], al
  3703 0000177A 88C3                    	mov	bl, al
  3704 0000177C 2C80                    	sub	al, 80h
  3705 0000177E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3706 00001782 66AB                    	stosw		; original sample (left channel)
  3707 00001784 66AB                    	stosw		; original sample (right channel)
  3708                                  	;xor	eax, eax
  3709 00001786 B080                    	mov	al, 80h
  3710 00001788 49                      	dec	ecx
  3711 00001789 7402                    	jz	short lff24m_2
  3712 0000178B 8A06                    	mov	al, [esi]
  3713                                  lff24m_2:
  3714                                  	;;mov	[next_val], al
  3715                                  	;mov	bh, al
  3716                                  	;add	al, [previous_val]
  3717 0000178D 00D8                    	add	al, bl
  3718 0000178F D0D8                    	rcr	al, 1
  3719 00001791 2C80                    	sub	al, 80h
  3720 00001793 66C1E008                	shl	ax, 8
  3721 00001797 66AB                    	stosw		; this is interpolated sample (L)
  3722 00001799 66AB                    	stosw		; this is interpolated sample (R)
  3723                                  	
  3724                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3725 0000179B 09C9                    	or	ecx, ecx
  3726 0000179D 75DA                    	jnz	short lff24m_1
  3727 0000179F E969F9FFFF              	jmp	lff24_3
  3728                                  
  3729                                  lff24m_7:
  3730                                  lff24s_7:
  3731 000017A4 E985F9FFFF              	jmp	lff24_5  ; error
  3732                                  
  3733                                  load_24khz_stereo_8_bit:
  3734                                  	; 15/11/2023
  3735 000017A9 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3736                                  					; last of the file?
  3737 000017B0 7402                    	jz	short lff24s_0		; no
  3738 000017B2 F9                      	stc
  3739 000017B3 C3                      	retn
  3740                                  
  3741                                  lff24s_0:
  3742                                  	; 01/12/2024
  3743                                  	; edi = audio buffer address
  3744                                  	; 13/12/2024
  3745 000017B4 893D[D8320000]          	mov	[audio_buffer], edi
  3746 000017BA BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3747                                          ;mov	edx, [loadsize]
  3748                                  
  3749                                  	; esi = buffer address
  3750                                  	;; edx = buffer size
  3751                                  
  3752                                  	; load file into memory
  3753                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000017BF 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000017C5 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000017C7 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000017CD B803000000          <1>  mov eax, %1
   104                              <1> 
   105 000017D2 CD40                <1>  int 40h
  3754 000017D4 72CE                    	jc	short lff24s_7 ; error !
  3755                                  
  3756                                  	; 01/12/2024
  3757 000017D6 A3[A0380000]            	mov	[count], eax
  3758                                  
  3759                                  	;mov	edi, audio_buffer
  3760                                  	; 29/05/2024
  3761                                  	;mov	edi, [audio_buffer]
  3762                                  	
  3763 000017DB D1E8                    	shr	eax, 1
  3764 000017DD 7505                    	jnz	short lff24s_8
  3765 000017DF E941F9FFFF              	jmp	lff24_eof
  3766                                  
  3767                                  lff24s_8:
  3768 000017E4 89C1                    	mov	ecx, eax  ; word count
  3769                                  lff24s_1:
  3770 000017E6 AC                      	lodsb
  3771 000017E7 A2[1C270000]            	mov	[previous_val_l], al
  3772 000017EC 2C80                    	sub	al, 80h
  3773 000017EE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3774 000017F2 66AB                    	stosw		; original sample (L)
  3775 000017F4 AC                      	lodsb
  3776 000017F5 A2[1E270000]            	mov	[previous_val_r], al
  3777 000017FA 2C80                    	sub	al, 80h
  3778 000017FC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3779 00001800 66AB                    	stosw		; original sample (R)
  3780                                  
  3781                                  	;xor	eax, eax
  3782 00001802 66B88080                	mov	ax, 8080h
  3783 00001806 49                      	dec	ecx
  3784 00001807 7403                    	jz	short lff24s_2
  3785                                  		; convert 8 bit sample to 16 bit sample
  3786 00001809 668B06                  	mov	ax, [esi]
  3787                                  lff24s_2:
  3788                                  	;;mov	[next_val_l], al
  3789                                  	;;mov	[next_val_r], ah
  3790                                  	;mov	bx, ax
  3791 0000180C 88E7                    	mov	bh, ah
  3792 0000180E 0205[1C270000]          	add	al, [previous_val_l]
  3793 00001814 D0D8                    	rcr	al, 1
  3794                                  	;mov	dl, al
  3795 00001816 2C80                    	sub	al, 80h
  3796 00001818 66C1E008                	shl	ax, 8
  3797 0000181C 66AB                    	stosw		; this is interpolated sample (L)
  3798 0000181E 88F8                    	mov	al, bh	; [next_val_r]
  3799 00001820 0205[1E270000]          	add	al, [previous_val_r]
  3800 00001826 D0D8                    	rcr	al, 1
  3801                                  	;mov	dh, al
  3802 00001828 2C80                    	sub	al, 80h
  3803 0000182A 66C1E008                	shl	ax, 8
  3804 0000182E 66AB                    	stosw		; this is interpolated sample (R)
  3805                                  		
  3806                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3807 00001830 09C9                    	or	ecx, ecx
  3808 00001832 75B2                    	jnz	short lff24s_1
  3809 00001834 E9D4F8FFFF              	jmp	lff24_3
  3810                                  
  3811                                  load_24khz_mono_16_bit:
  3812                                  	; 15/11/2023
  3813 00001839 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3814                                  					; last of the file?
  3815 00001840 7402                    	jz	short lff24m2_0		; no
  3816 00001842 F9                      	stc
  3817 00001843 C3                      	retn
  3818                                  
  3819                                  lff24m2_0:
  3820                                  	; 01/12/2024
  3821                                  	; edi = audio buffer address
  3822                                  	; 13/12/2024
  3823 00001844 893D[D8320000]          	mov	[audio_buffer], edi
  3824 0000184A BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3825                                          ;mov	edx, [loadsize]
  3826                                  
  3827                                  	; esi = buffer address
  3828                                  	;; edx = buffer size
  3829                                  
  3830                                  	; load file into memory
  3831                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000184F 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001855 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001857 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000185D B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001862 CD40                <1>  int 40h
  3832 00001864 7237                    	jc	short lff24m2_7 ; error !
  3833                                  
  3834                                  	; 01/12/2024
  3835 00001866 A3[A0380000]            	mov	[count], eax
  3836                                  
  3837                                  	;mov	edi, audio_buffer
  3838                                  	; 29/05/2024
  3839                                  	;mov	edi, [audio_buffer]
  3840                                  	
  3841 0000186B D1E8                    	shr	eax, 1
  3842 0000186D 7505                    	jnz	short lff24m2_8
  3843 0000186F E9B1F8FFFF              	jmp	lff24_eof
  3844                                  
  3845                                  lff24m2_8:
  3846 00001874 89C1                    	mov	ecx, eax  ; word count
  3847                                  lff24m2_1:
  3848 00001876 66AD                    	lodsw
  3849 00001878 66AB                    	stosw		; original sample (left channel)
  3850 0000187A 66AB                    	stosw		; original sample (right channel)
  3851 0000187C 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3852                                  	;mov	[previous_val], ax
  3853                                  	;mov	ebx, eax
  3854                                  	;xor	eax, eax
  3855 0000187F 31DB                    	xor	ebx, ebx
  3856 00001881 49                      	dec	ecx
  3857 00001882 7403                    	jz	short lff24m2_2
  3858                                  	;mov	ax, [esi]
  3859 00001884 668B1E                  	mov	bx, [esi]
  3860                                  lff24m2_2:
  3861                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  3862                                  	;mov	ebp, eax	; [next_val]
  3863                                  	;add	ax, [previous_val]
  3864                                  	; ax = [previous_val]
  3865                                  	; bx = [next_val]
  3866 00001887 6601D8                  	add	ax, bx
  3867 0000188A 66D1D8                  	rcr	ax, 1
  3868 0000188D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3869 00001890 66AB                    	stosw		; this is interpolated sample (L)
  3870 00001892 66AB                    	stosw		; this is interpolated sample (R)
  3871                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3872 00001894 09C9                    	or	ecx, ecx
  3873 00001896 75DE                    	jnz	short lff24m2_1
  3874 00001898 E970F8FFFF              	jmp	lff24_3
  3875                                  
  3876                                  lff24m2_7:
  3877                                  lff24s2_7:
  3878 0000189D E98CF8FFFF              	jmp	lff24_5  ; error
  3879                                  
  3880                                  load_24khz_stereo_16_bit:
  3881                                  	; 16/11/2023
  3882                                  	; 15/11/2023
  3883 000018A2 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3884                                  					; last of the file?
  3885 000018A9 7402                    	jz	short lff24s2_0		; no
  3886 000018AB F9                      	stc
  3887 000018AC C3                      	retn
  3888                                  
  3889                                  lff24s2_0:
  3890                                  	; 01/12/2024
  3891                                  	; edi = audio buffer address
  3892                                  	; 13/12/2024
  3893 000018AD 893D[D8320000]          	mov	[audio_buffer], edi
  3894 000018B3 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3895                                          ;mov	edx, [loadsize]
  3896                                  
  3897                                  	; esi = buffer address
  3898                                  	;; edx = buffer size
  3899                                  
  3900                                  	; load file into memory
  3901                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000018B8 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000018BE 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000018C0 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000018C6 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 000018CB CD40                <1>  int 40h
  3902 000018CD 72CE                    	jc	short lff24s2_7 ; error !
  3903                                  
  3904                                  	; 01/12/2024
  3905 000018CF A3[A0380000]            	mov	[count], eax
  3906                                  
  3907                                  	;mov	edi, audio_buffer
  3908                                  	; 29/05/2024
  3909                                  	;mov	edi, [audio_buffer]
  3910                                  	
  3911 000018D4 C1E802                  	shr	eax, 2
  3912 000018D7 7505                    	jnz	short lff24s2_8
  3913 000018D9 E947F8FFFF              	jmp	lff24_eof
  3914                                  
  3915                                  lff24s2_8:
  3916 000018DE 89C1                    	mov	ecx, eax  ; dword count
  3917                                  lff24s2_1:
  3918 000018E0 66AD                    	lodsw
  3919 000018E2 66AB                    	stosw		; original sample (L)
  3920 000018E4 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3921 000018E7 66A3[1C270000]          	mov	[previous_val_l], ax
  3922 000018ED 66AD                    	lodsw
  3923 000018EF 66AB                    	stosw		; original sample (R)
  3924 000018F1 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3925                                  	;mov	[previous_val_r], ax
  3926 000018F4 89C3                    	mov	ebx, eax
  3927 000018F6 31D2                    	xor	edx, edx
  3928 000018F8 31C0                    	xor	eax, eax
  3929                                  	; 16/11/2023
  3930 000018FA 49                      	dec	ecx
  3931 000018FB 7407                    	jz	short lff24s2_2
  3932 000018FD 668B06                  	mov	ax, [esi]
  3933 00001900 668B5602                	mov	dx, [esi+2]
  3934                                  lff24s2_2:
  3935 00001904 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3936                                  	;;mov	[next_val_l], ax
  3937                                  	;mov	ebp, eax
  3938 00001907 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  3939                                  	;mov	[next_val_r], dx
  3940 0000190A 660305[1C270000]        	add	ax, [previous_val_l]
  3941 00001911 66D1D8                  	rcr	ax, 1
  3942 00001914 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  3943 00001917 66AB                    	stosw		; this is interpolated sample (L)
  3944                                  	;mov	ax, [next_val_r]
  3945 00001919 89D0                    	mov	eax, edx
  3946                                  	;add	ax, [previous_val_r]
  3947 0000191B 6601D8                  	add	ax, bx
  3948 0000191E 66D1D8                  	rcr	ax, 1
  3949 00001921 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3950 00001924 66AB                    	stosw		; this is interpolated sample (R)
  3951                                  	
  3952                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3953 00001926 09C9                    	or	ecx, ecx
  3954 00001928 75B6                    	jnz	short lff24s2_1
  3955 0000192A E9DEF7FFFF              	jmp	lff24_3
  3956                                  
  3957                                  ; .....................
  3958                                  
  3959                                  load_32khz_mono_8_bit:
  3960                                  	; 15/11/2023
  3961 0000192F F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3962                                  					; last of the file?
  3963 00001936 7402                    	jz	short lff32m_0		; no
  3964 00001938 F9                      	stc
  3965 00001939 C3                      	retn
  3966                                  
  3967                                  lff32m_0:
  3968                                  	; 01/12/2024
  3969                                  	; edi = audio buffer address
  3970                                  	; 13/12/2024
  3971 0000193A 893D[D8320000]          	mov	[audio_buffer], edi
  3972 00001940 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3973                                          ;mov	edx, [loadsize]
  3974                                  
  3975                                  	; esi = buffer address
  3976                                  	;; edx = buffer size
  3977                                  
  3978                                  	; load file into memory
  3979                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001945 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000194B 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000194D 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001953 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001958 CD40                <1>  int 40h
  3980 0000195A 7247                    	jc	short lff32m_7 ; error !
  3981                                  
  3982                                  	; 01/12/2024
  3983 0000195C A3[A0380000]            	mov	[count], eax
  3984                                  
  3985                                  	;mov	edi, audio_buffer
  3986                                  	; 29/05/2024
  3987                                  	;mov	edi, [audio_buffer]
  3988                                  	
  3989 00001961 21C0                    	and	eax, eax
  3990 00001963 7505                    	jnz	short lff32m_8
  3991 00001965 E9BBF7FFFF              	jmp	lff32_eof
  3992                                  
  3993                                  lff32m_8:
  3994 0000196A 89C1                    	mov	ecx, eax	; byte count
  3995                                  lff32m_1:
  3996 0000196C AC                      	lodsb
  3997                                  	;mov	[previous_val], al
  3998 0000196D 88C3                    	mov	bl, al
  3999 0000196F 2C80                    	sub	al, 80h
  4000 00001971 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4001 00001975 66AB                    	stosw		; original sample (left channel)
  4002 00001977 66AB                    	stosw		; original sample (right channel)
  4003                                  	;xor	eax, eax
  4004 00001979 B080                    	mov	al, 80h
  4005 0000197B 49                      	dec	ecx
  4006 0000197C 7402                    	jz	short lff32m_2
  4007 0000197E 8A06                    	mov	al, [esi]
  4008                                  lff32m_2:
  4009                                  	;;mov	[next_val], al
  4010                                  	;mov	bh, al
  4011                                  	;add	al, [previous_val]
  4012 00001980 00D8                    	add	al, bl
  4013 00001982 D0D8                    	rcr	al, 1
  4014 00001984 2C80                    	sub	al, 80h
  4015 00001986 66C1E008                	shl	ax, 8
  4016 0000198A 66AB                    	stosw		; this is interpolated sample (L)
  4017 0000198C 66AB                    	stosw		; this is interpolated sample (R)
  4018                                  	
  4019                                  	; different than 8-16-24 kHZ !
  4020                                  	; 'original-interpolated-original' trio samples
  4021 0000198E E30E                    	jecxz	lff32m_3
  4022                                  
  4023 00001990 AC                      	lodsb
  4024 00001991 2C80                    	sub	al, 80h
  4025 00001993 66C1E008                	shl	ax, 8
  4026 00001997 66AB                    	stosw		; original sample (left channel)
  4027 00001999 66AB                    	stosw		; original sample (right channel)
  4028                                  
  4029                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  4030 0000199B 49                      	dec	ecx
  4031 0000199C 75CE                    	jnz	short lff32m_1
  4032                                  lff32m_3:
  4033 0000199E E96AF7FFFF              	jmp	lff32_3
  4034                                  
  4035                                  lff32m_7:
  4036                                  lff32s_7:
  4037 000019A3 E986F7FFFF              	jmp	lff32_5  ; error
  4038                                  
  4039                                  load_32khz_stereo_8_bit:
  4040                                  	; 15/11/2023
  4041 000019A8 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4042                                  					; last of the file?
  4043 000019AF 7402                    	jz	short lff32s_0		; no
  4044 000019B1 F9                      	stc
  4045 000019B2 C3                      	retn
  4046                                  
  4047                                  lff32s_0:
  4048                                  	; 01/12/2024
  4049                                  	; edi = audio buffer address
  4050                                  	; 13/12/2024
  4051 000019B3 893D[D8320000]          	mov	[audio_buffer], edi
  4052 000019B9 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4053                                          ;mov	edx, [loadsize]
  4054                                  
  4055                                  	; esi = buffer address
  4056                                  	;; edx = buffer size
  4057                                  
  4058                                  	; load file into memory
  4059                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000019BE 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000019C4 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000019C6 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000019CC B803000000          <1>  mov eax, %1
   104                              <1> 
   105 000019D1 CD40                <1>  int 40h
  4060 000019D3 72CE                    	jc	short lff32s_7 ; error !
  4061                                  
  4062                                  	; 01/12/2024
  4063 000019D5 A3[A0380000]            	mov	[count], eax
  4064                                  
  4065                                  	;mov	edi, audio_buffer
  4066                                  	; 29/05/2024
  4067                                  	;mov	edi, [audio_buffer]
  4068                                  	
  4069 000019DA D1E8                    	shr	eax, 1
  4070 000019DC 7505                    	jnz	short lff32s_8
  4071 000019DE E942F7FFFF              	jmp	lff32_eof
  4072                                  
  4073                                  lff32s_8:
  4074 000019E3 89C1                    	mov	ecx, eax  ; word count
  4075                                  lff32s_1:
  4076 000019E5 AC                      	lodsb
  4077 000019E6 A2[1C270000]            	mov	[previous_val_l], al
  4078 000019EB 2C80                    	sub	al, 80h
  4079 000019ED 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4080 000019F1 66AB                    	stosw		; original sample (L)
  4081 000019F3 AC                      	lodsb
  4082 000019F4 A2[1E270000]            	mov	[previous_val_r], al
  4083 000019F9 2C80                    	sub	al, 80h
  4084 000019FB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4085 000019FF 66AB                    	stosw		; original sample (R)
  4086                                  
  4087                                  	;xor	eax, eax
  4088 00001A01 66B88080                	mov	ax, 8080h
  4089 00001A05 49                      	dec	ecx
  4090 00001A06 7403                    	jz	short lff32s_2
  4091                                  		; convert 8 bit sample to 16 bit sample
  4092 00001A08 668B06                  	mov	ax, [esi]
  4093                                  lff32s_2:
  4094                                  	;;mov	[next_val_l], al
  4095                                  	;;mov	[next_val_r], ah
  4096                                  	;mov	bx, ax
  4097 00001A0B 88E7                    	mov	bh, ah
  4098 00001A0D 0205[1C270000]          	add	al, [previous_val_l]
  4099 00001A13 D0D8                    	rcr	al, 1
  4100                                  	;mov	dl, al
  4101 00001A15 2C80                    	sub	al, 80h
  4102 00001A17 66C1E008                	shl	ax, 8
  4103 00001A1B 66AB                    	stosw		; this is interpolated sample (L)
  4104 00001A1D 88F8                    	mov	al, bh	; [next_val_r]
  4105 00001A1F 0205[1E270000]          	add	al, [previous_val_r]
  4106 00001A25 D0D8                    	rcr	al, 1
  4107                                  	;mov	dh, al
  4108 00001A27 2C80                    	sub	al, 80h
  4109 00001A29 66C1E008                	shl	ax, 8
  4110 00001A2D 66AB                    	stosw		; this is interpolated sample (R)
  4111                                  
  4112                                  	; different than 8-16-24 kHZ !
  4113                                  	; 'original-interpolated-original' trio samples
  4114 00001A2F E315                    	jecxz	lff32s_3
  4115                                  
  4116 00001A31 AC                      	lodsb
  4117 00001A32 2C80                    	sub	al, 80h
  4118 00001A34 66C1E008                	shl	ax, 8
  4119 00001A38 66AB                    	stosw		; original sample (left channel)
  4120                                  
  4121 00001A3A AC                      	lodsb
  4122 00001A3B 2C80                    	sub	al, 80h
  4123 00001A3D 66C1E008                	shl	ax, 8
  4124 00001A41 66AB                    	stosw		; original sample (right channel)
  4125                                  		
  4126                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  4127 00001A43 49                      	dec	ecx
  4128 00001A44 759F                    	jnz	short lff32s_1
  4129                                  lff32s_3:
  4130 00001A46 E9C2F6FFFF              	jmp	lff32_3
  4131                                  
  4132                                  load_32khz_mono_16_bit:
  4133                                  	; 15/11/2023
  4134 00001A4B F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4135                                  					; last of the file?
  4136 00001A52 7402                    	jz	short lff32m2_0		; no
  4137 00001A54 F9                      	stc
  4138 00001A55 C3                      	retn
  4139                                  
  4140                                  lff32m2_0:
  4141                                  	; 01/12/2024
  4142                                  	; edi = audio buffer address
  4143                                  	; 13/12/2024
  4144 00001A56 893D[D8320000]          	mov	[audio_buffer], edi
  4145 00001A5C BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4146                                          ;mov	edx, [loadsize]
  4147                                  
  4148                                  	; esi = buffer address
  4149                                  	;; edx = buffer size
  4150                                  
  4151                                  	; load file into memory
  4152                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001A61 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001A67 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001A69 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001A6F B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001A74 CD40                <1>  int 40h
  4153 00001A76 723E                    	jc	short lff32m2_7 ; error !
  4154                                  
  4155                                  	; 01/12/2024
  4156 00001A78 A3[A0380000]            	mov	[count], eax
  4157                                  
  4158                                  	;mov	edi, audio_buffer
  4159                                  	; 29/05/2024
  4160                                  	;mov	edi, [audio_buffer]
  4161                                  	
  4162 00001A7D D1E8                    	shr	eax, 1
  4163 00001A7F 7505                    	jnz	short lff32m2_8
  4164 00001A81 E99FF6FFFF              	jmp	lff32_eof
  4165                                  
  4166                                  lff32m2_8:
  4167 00001A86 89C1                    	mov	ecx, eax  ; word count
  4168                                  lff32m2_1:
  4169 00001A88 66AD                    	lodsw
  4170 00001A8A 66AB                    	stosw		; original sample (left channel)
  4171 00001A8C 66AB                    	stosw		; original sample (right channel)
  4172 00001A8E 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4173                                  	;mov	[previous_val], ax
  4174                                  	;mov	ebx, eax
  4175                                  	;xor	eax, eax
  4176 00001A91 31DB                    	xor	ebx, ebx
  4177 00001A93 49                      	dec	ecx
  4178 00001A94 7403                    	jz	short lff32m2_2
  4179                                  	;mov	ax, [esi]
  4180 00001A96 668B1E                  	mov	bx, [esi]
  4181                                  lff32m2_2:
  4182                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  4183                                  	;mov	ebp, eax	; [next_val]
  4184                                  	;add	ax, [previous_val]
  4185                                  	; ax = [previous_val]
  4186                                  	; bx = [next_val]
  4187 00001A99 6601D8                  	add	ax, bx
  4188 00001A9C 66D1D8                  	rcr	ax, 1
  4189 00001A9F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4190 00001AA2 66AB                    	stosw		; this is interpolated sample (L)
  4191 00001AA4 66AB                    	stosw		; this is interpolated sample (R)
  4192                                  
  4193                                  	; different than 8-16-24 kHZ !
  4194                                  	; 'original-interpolated-original' trio samples 
  4195 00001AA6 E309                    	jecxz	lff32m2_3
  4196                                  
  4197 00001AA8 66AD                    	lodsw
  4198 00001AAA 66AB                    	stosw		; original sample (left channel)
  4199 00001AAC 66AB                    	stosw		; original sample (right channel)
  4200                                  
  4201                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  4202 00001AAE 49                      	dec	ecx
  4203 00001AAF 75D7                    	jnz	short lff32m2_1
  4204                                  lff32m2_3:
  4205 00001AB1 E957F6FFFF              	jmp	lff32_3
  4206                                  
  4207                                  lff32m2_7:
  4208                                  lff32s2_7:
  4209 00001AB6 E973F6FFFF              	jmp	lff32_5  ; error
  4210                                  
  4211                                  load_32khz_stereo_16_bit:
  4212                                  	; 16/11/2023
  4213                                  	; 15/11/2023
  4214 00001ABB F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4215                                  					; last of the file?
  4216 00001AC2 7402                    	jz	short lff32s2_0		; no
  4217 00001AC4 F9                      	stc
  4218 00001AC5 C3                      	retn
  4219                                  
  4220                                  lff32s2_0:
  4221                                  	; 01/12/2024
  4222                                  	; edi = audio buffer address
  4223                                  	; 13/12/2024
  4224 00001AC6 893D[D8320000]          	mov	[audio_buffer], edi
  4225 00001ACC BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4226                                          ;mov	edx, [loadsize]
  4227                                  
  4228                                  	; esi = buffer address
  4229                                  	;; edx = buffer size
  4230                                  
  4231                                  	; load file into memory
  4232                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001AD1 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001AD7 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001AD9 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001ADF B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001AE4 CD40                <1>  int 40h
  4233 00001AE6 72CE                    	jc	short lff32s2_7 ; error !
  4234                                  
  4235                                  	; 01/12/2024
  4236 00001AE8 A3[A0380000]            	mov	[count], eax
  4237                                  
  4238                                  	;mov	edi, audio_buffer
  4239                                  	; 29/05/2024
  4240                                  	;mov	edi, [audio_buffer]
  4241                                  	
  4242 00001AED C1E802                  	shr	eax, 2
  4243 00001AF0 7505                    	jnz	short lff32s2_8
  4244 00001AF2 E92EF6FFFF              	jmp	lff32_eof
  4245                                  
  4246                                  lff32s2_8:
  4247 00001AF7 89C1                    	mov	ecx, eax ; dword count
  4248                                  lff32s2_1:
  4249 00001AF9 66AD                    	lodsw
  4250 00001AFB 66AB                    	stosw		; original sample (L)
  4251 00001AFD 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  4252 00001B00 66A3[1C270000]          	mov	[previous_val_l], ax
  4253 00001B06 66AD                    	lodsw
  4254 00001B08 66AB                    	stosw		; original sample (R)
  4255 00001B0A 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  4256                                  	;mov	[previous_val_r], ax
  4257 00001B0D 89C3                    	mov	ebx, eax
  4258 00001B0F 31D2                    	xor	edx, edx
  4259 00001B11 31C0                    	xor	eax, eax
  4260                                  	; 16/11/2023
  4261 00001B13 49                      	dec	ecx
  4262 00001B14 7407                    	jz	short lff32s2_2
  4263 00001B16 668B06                  	mov	ax, [esi]
  4264 00001B19 668B5602                	mov	dx, [esi+2]
  4265                                  lff32s2_2:
  4266 00001B1D 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  4267                                  	;;mov	[next_val_l], ax
  4268                                  	;mov	ebp, eax
  4269 00001B20 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  4270                                  	;mov	[next_val_r], dx
  4271 00001B23 660305[1C270000]        	add	ax, [previous_val_l]
  4272 00001B2A 66D1D8                  	rcr	ax, 1
  4273 00001B2D 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  4274 00001B30 66AB                    	stosw		; this is interpolated sample (L)
  4275                                  	;mov	ax, [next_val_r]
  4276 00001B32 89D0                    	mov	eax, edx
  4277                                  	;add	ax, [previous_val_r]
  4278 00001B34 6601D8                  	add	ax, bx
  4279 00001B37 66D1D8                  	rcr	ax, 1
  4280 00001B3A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4281 00001B3D 66AB                    	stosw		; this is interpolated sample (R)
  4282                                  
  4283                                  	; different than 8-16-24 kHZ !
  4284                                  	; 'original-interpolated-original' trio samples
  4285 00001B3F E30B                    	jecxz	lff32s2_3
  4286                                  
  4287 00001B41 66AD                    	lodsw
  4288 00001B43 66AB                    	stosw	; original sample (L)
  4289 00001B45 66AD                    	lodsw
  4290 00001B47 66AB                    	stosw	; original sample (R)
  4291                                  	
  4292                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  4293 00001B49 49                      	dec	ecx
  4294 00001B4A 75AD                    	jnz	short lff32s2_1
  4295                                  lff32s2_3:
  4296 00001B4C E9BCF5FFFF              	jmp	lff32_3
  4297                                  
  4298                                  ; .....................
  4299                                  
  4300                                  load_22khz_mono_8_bit:
  4301                                  	; 16/11/2023
  4302 00001B51 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4303                                  					; last of the file?
  4304 00001B58 7402                    	jz	short lff22m_0		; no
  4305 00001B5A F9                      	stc
  4306 00001B5B C3                      	retn
  4307                                  
  4308                                  lff22m_0:
  4309                                  	; 01/12/2024
  4310                                  	; edi = audio buffer address
  4311                                  	; 13/12/2024
  4312 00001B5C 893D[D8320000]          	mov	[audio_buffer], edi
  4313 00001B62 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4314                                          ;mov	edx, [loadsize]
  4315                                  
  4316                                  	; esi = buffer address
  4317                                  	;; edx = buffer size
  4318                                  
  4319                                  	; load file into memory
  4320                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001B67 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001B6D 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001B6F 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001B75 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001B7A CD40                <1>  int 40h
  4321 00001B7C 725D                    	jc	short lff22m_7 ; error !
  4322                                  
  4323                                  	; 01/12/2024
  4324 00001B7E A3[A0380000]            	mov	[count], eax
  4325                                  
  4326                                  	;mov	edi, audio_buffer
  4327                                  	; 29/05/2024
  4328                                  	;mov	edi, [audio_buffer]
  4329                                  	
  4330 00001B83 21C0                    	and	eax, eax
  4331 00001B85 7505                    	jnz	short lff22m_8
  4332 00001B87 E999F5FFFF              	jmp	lff22_eof
  4333                                  
  4334                                  lff22m_8:
  4335 00001B8C 89C1                    	mov	ecx, eax	; byte count
  4336                                  lff22m_9:
  4337 00001B8E BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4338 00001B93 C605[24270000]03        	mov	byte [faz], 3  ; 3 steps/phases
  4339                                  lff22m_1:
  4340                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4341 00001B9A AC                      	lodsb
  4342 00001B9B B280                    	mov	dl, 80h
  4343 00001B9D 49                      	dec	ecx
  4344 00001B9E 7402                    	jz	short lff22m_2_1
  4345 00001BA0 8A16                    	mov	dl, [esi]
  4346                                  lff22m_2_1:	
  4347                                  	; al = [previous_val]
  4348                                  	; dl = [next_val]
  4349 00001BA2 E831060000              	call	interpolating_3_8bit_mono ; 1 of 17
  4350 00001BA7 E32D                    	jecxz	lff22m_3
  4351                                  lff22m_2_2:
  4352 00001BA9 AC                      	lodsb
  4353 00001BAA B280                    	mov	dl, 80h
  4354 00001BAC 49                      	dec	ecx
  4355 00001BAD 7402                    	jz	short lff22m_2_3
  4356 00001BAF 8A16                    	mov	dl, [esi]
  4357                                  lff22m_2_3:
  4358 00001BB1 E8A6060000               	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  4359 00001BB6 E31E                    	jecxz	lff22m_3
  4360 00001BB8 4D                      	dec	ebp
  4361 00001BB9 75EE                    	jnz	short lff22m_2_2
  4362                                  
  4363 00001BBB A0[24270000]            	mov	al, [faz]
  4364 00001BC0 FEC8                    	dec	al
  4365 00001BC2 74CA                    	jz	short lff22m_9
  4366 00001BC4 FE0D[24270000]          	dec	byte [faz]
  4367 00001BCA BD04000000              	mov	ebp, 4
  4368 00001BCF FEC8                    	dec	al
  4369 00001BD1 75C7                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  4370 00001BD3 45                      	inc	ebp ; 5
  4371 00001BD4 EBC4                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4372                                  
  4373                                  lff22m_3:
  4374                                  lff22s_3:
  4375 00001BD6 E932F5FFFF              	jmp	lff22_3	; padfill
  4376                                  		; (put zeros in the remain words of the buffer)
  4377                                  lff22m_7:
  4378                                  lff22s_7:
  4379 00001BDB E94EF5FFFF              	jmp	lff22_5  ; error
  4380                                  
  4381                                  load_22khz_stereo_8_bit:
  4382                                  	; 16/11/2023
  4383 00001BE0 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4384                                  					; last of the file?
  4385 00001BE7 7402                    	jz	short lff22s_0		; no
  4386 00001BE9 F9                      	stc
  4387 00001BEA C3                      	retn
  4388                                  
  4389                                  lff22s_0:
  4390                                  	; 01/12/2024
  4391                                  	; edi = audio buffer address
  4392                                  	; 13/12/2024
  4393 00001BEB 893D[D8320000]          	mov	[audio_buffer], edi
  4394 00001BF1 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4395                                          ;mov	edx, [loadsize]
  4396                                  
  4397                                  	; esi = buffer address
  4398                                  	;; edx = buffer size
  4399                                  
  4400                                  	; load file into memory
  4401                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001BF6 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001BFC 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001BFE 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001C04 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001C09 CD40                <1>  int 40h
  4402 00001C0B 72CE                    	jc	short lff22s_7 ; error !
  4403                                  
  4404                                  	; 01/12/2024
  4405 00001C0D A3[A0380000]            	mov	[count], eax
  4406                                  
  4407                                  	;mov	edi, audio_buffer
  4408                                  	; 29/05/2024
  4409                                  	;mov	edi, [audio_buffer]
  4410                                  	
  4411 00001C12 D1E8                    	shr	eax, 1
  4412 00001C14 7505                    	jnz	short lff22s_8
  4413 00001C16 E90AF5FFFF              	jmp	lff22_eof
  4414                                  
  4415                                  lff22s_8:
  4416 00001C1B 89C1                    	mov	ecx, eax	; word count
  4417                                  lff22s_9:
  4418 00001C1D BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4419 00001C22 C605[24270000]03        	mov	byte [faz], 3  ; 3 steps/phase
  4420                                  lff22s_1:
  4421                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4422 00001C29 66AD                    	lodsw
  4423 00001C2B 66BA8080                	mov	dx, 8080h
  4424 00001C2F 49                      	dec	ecx
  4425 00001C30 7403                    	jz	short lff22s_2_1
  4426 00001C32 668B16                  	mov	dx, [esi]
  4427                                  lff22s_2_1:	
  4428                                  	; al = [previous_val_l]
  4429                                  	; ah = [previous_val_r]
  4430                                  	; dl = [next_val_l]
  4431                                  	; dh = [next_val_r]
  4432 00001C35 E8CF050000              	call	interpolating_3_8bit_stereo ; 1 of 17
  4433 00001C3A E39A                    	jecxz	lff22s_3
  4434                                  lff22s_2_2:
  4435 00001C3C 66AD                    	lodsw
  4436 00001C3E 66BA8080                	mov	dx, 8080h
  4437 00001C42 49                      	dec	ecx
  4438 00001C43 7403                    	jz	short lff22s_2_3
  4439 00001C45 668B16                  	mov	dx, [esi]
  4440                                  lff22s_2_3:
  4441 00001C48 E82C060000               	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  4442 00001C4D E387                    	jecxz	lff22s_3
  4443 00001C4F 4D                      	dec	ebp
  4444 00001C50 75EA                    	jnz	short lff22s_2_2
  4445                                  
  4446 00001C52 A0[24270000]            	mov	al, [faz]
  4447 00001C57 FEC8                    	dec	al
  4448 00001C59 74C2                    	jz	short lff22s_9
  4449 00001C5B FE0D[24270000]          	dec	byte [faz]
  4450 00001C61 BD04000000              	mov	ebp, 4
  4451 00001C66 FEC8                    	dec	al
  4452 00001C68 75BF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  4453 00001C6A 45                      	inc	ebp ; 5
  4454 00001C6B EBBC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4455                                  
  4456                                  load_22khz_mono_16_bit:
  4457                                  	; 16/11/2023
  4458 00001C6D F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4459                                  					; last of the file?
  4460 00001C74 7402                    	jz	short lff22m2_0		; no
  4461 00001C76 F9                      	stc
  4462 00001C77 C3                      	retn
  4463                                  
  4464                                  lff22m2_0:
  4465                                  	; 01/12/2024
  4466                                  	; edi = audio buffer address
  4467                                  	; 13/12/2024
  4468 00001C78 893D[D8320000]          	mov	[audio_buffer], edi
  4469 00001C7E BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4470                                          ;mov	edx, [loadsize]
  4471                                  
  4472                                  	; esi = buffer address
  4473                                  	;; edx = buffer size
  4474                                  
  4475                                  	; load file into memory
  4476                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001C83 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001C89 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001C8B 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001C91 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001C96 CD40                <1>  int 40h
  4477 00001C98 7261                    	jc	short lff22m2_7 ; error !
  4478                                  
  4479                                  	; 01/12/2024
  4480 00001C9A A3[A0380000]            	mov	[count], eax
  4481                                  
  4482                                  	;mov	edi, audio_buffer
  4483                                  	; 29/05/2024
  4484                                  	;mov	edi, [audio_buffer]
  4485                                  	
  4486 00001C9F D1E8                    	shr	eax, 1
  4487 00001CA1 7505                    	jnz	short lff22m2_8
  4488 00001CA3 E97DF4FFFF              	jmp	lff22_eof
  4489                                  
  4490                                  lff22m2_8:
  4491 00001CA8 89C1                    	mov	ecx, eax	; word count
  4492                                  lff22m2_9:
  4493 00001CAA BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4494 00001CAF C605[24270000]03        	mov	byte [faz], 3  ; 3 steps/phases
  4495                                  lff22m2_1:
  4496                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4497 00001CB6 66AD                    	lodsw
  4498 00001CB8 31D2                    	xor	edx, edx
  4499 00001CBA 49                      	dec	ecx
  4500 00001CBB 7403                    	jz	short lff22m2_2_1
  4501 00001CBD 668B16                  	mov	dx, [esi]
  4502                                  lff22m2_2_1:	
  4503                                  	; ax = [previous_val]
  4504                                  	; dx = [next_val]
  4505 00001CC0 E8E5050000              	call	interpolating_3_16bit_mono ; 1 of 17
  4506 00001CC5 E32F                    	jecxz	lff22m2_3
  4507                                  lff22m2_2_2:
  4508 00001CC7 66AD                    	lodsw
  4509 00001CC9 31D2                    	xor	edx, edx
  4510 00001CCB 49                      	dec	ecx
  4511 00001CCC 7403                    	jz	short lff22m2_2_3
  4512 00001CCE 668B16                  	mov	dx, [esi]
  4513                                  lff22m2_2_3:
  4514 00001CD1 E867060000               	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  4515 00001CD6 E31E                    	jecxz	lff22m2_3
  4516 00001CD8 4D                      	dec	ebp
  4517 00001CD9 75EC                    	jnz	short lff22m2_2_2
  4518                                  
  4519 00001CDB A0[24270000]            	mov	al, [faz]
  4520 00001CE0 FEC8                    	dec	al
  4521 00001CE2 74C6                    	jz	short lff22m2_9
  4522 00001CE4 FE0D[24270000]          	dec	byte [faz]
  4523 00001CEA BD04000000              	mov	ebp, 4
  4524 00001CEF FEC8                    	dec	al
  4525 00001CF1 75C3                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  4526 00001CF3 45                      	inc	ebp ; 5
  4527 00001CF4 EBC0                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4528                                  
  4529                                  lff22m2_3:
  4530                                  lff22s2_3:
  4531 00001CF6 E912F4FFFF              	jmp	lff22_3	; padfill
  4532                                  		; (put zeros in the remain words of the buffer)
  4533                                  lff22m2_7:
  4534                                  lff22s2_7:
  4535 00001CFB E92EF4FFFF              	jmp	lff22_5  ; error
  4536                                  
  4537                                  load_22khz_stereo_16_bit:
  4538                                  	; 16/11/2023
  4539 00001D00 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4540                                  					; last of the file?
  4541 00001D07 7402                    	jz	short lff22s2_0		; no
  4542 00001D09 F9                      	stc
  4543 00001D0A C3                      	retn
  4544                                  
  4545                                  lff22s2_0:
  4546                                  	; 01/12/2024
  4547                                  	; edi = audio buffer address
  4548                                  	; 13/12/2024
  4549 00001D0B 893D[D8320000]          	mov	[audio_buffer], edi
  4550 00001D11 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4551                                          ;mov	edx, [loadsize]
  4552                                  
  4553                                  	; esi = buffer address
  4554                                  	;; edx = buffer size
  4555                                  
  4556                                  	; load file into memory
  4557                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001D16 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001D1C 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001D1E 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001D24 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001D29 CD40                <1>  int 40h
  4558 00001D2B 72CE                    	jc	short lff22s2_7 ; error !
  4559                                  
  4560                                  	; 01/12/2024
  4561 00001D2D A3[A0380000]            	mov	[count], eax
  4562                                  
  4563                                  	;mov	edi, audio_buffer
  4564                                  	; 29/05/2024
  4565                                  	;mov	edi, [audio_buffer]
  4566                                  	
  4567 00001D32 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  4568 00001D35 7505                    	jnz	short lff22s2_8
  4569 00001D37 E9E9F3FFFF              	jmp	lff22_eof
  4570                                  
  4571                                  lff22s2_8:
  4572 00001D3C 89C1                    	mov	ecx, eax	; dword count
  4573                                  lff22s2_9:
  4574 00001D3E BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4575 00001D43 C605[24270000]03        	mov	byte [faz], 3  ; 3 steps/phase
  4576                                  lff22s2_1:
  4577                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4578 00001D4A 66AD                    	lodsw
  4579 00001D4C 89C3                    	mov	ebx, eax
  4580 00001D4E 66AD                    	lodsw
  4581 00001D50 8B16                    	mov	edx, [esi]
  4582 00001D52 668915[20270000]        	mov	[next_val_l], dx
  4583                                  	; 26/11/2023
  4584 00001D59 C1EA10                  	shr	edx, 16
  4585 00001D5C 49                      	dec	ecx
  4586 00001D5D 7509                    	jnz	short lff22s2_2_1
  4587 00001D5F 31D2                    	xor	edx, edx ; 0
  4588 00001D61 668915[20270000]        	mov	[next_val_l], dx
  4589                                  lff22s2_2_1:
  4590                                  	; bx = [previous_val_l]
  4591                                  	; ax = [previous_val_r]
  4592                                  	; [next_val_l]
  4593                                  	; dx = [next_val_r]
  4594 00001D68 E86D050000              	call	interpolating_3_16bit_stereo ; 1 of 17 
  4595 00001D6D E387                    	jecxz	lff22s2_3
  4596                                  lff22s2_2_2:
  4597 00001D6F 66AD                    	lodsw
  4598 00001D71 89C3                    	mov	ebx, eax
  4599 00001D73 66AD                    	lodsw
  4600 00001D75 8B16                    	mov	edx, [esi]
  4601 00001D77 668915[20270000]        	mov	[next_val_l], dx
  4602                                  	; 26/11/2023
  4603 00001D7E C1EA10                  	shr	edx, 16
  4604 00001D81 49                      	dec	ecx
  4605 00001D82 7509                    	jnz	short lff22s2_2_3
  4606 00001D84 31D2                    	xor	edx, edx ; 0
  4607 00001D86 668915[20270000]        	mov	[next_val_l], dx
  4608                                  lff22s2_2_3:
  4609 00001D8D E8C3050000               	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  4610 00001D92 E31E                    	jecxz	lff22s2_2_4
  4611                                  
  4612 00001D94 4D                      	dec	ebp
  4613 00001D95 75D8                    	jnz	short lff22s2_2_2
  4614                                  
  4615 00001D97 A0[24270000]            	mov	al, [faz]
  4616 00001D9C FEC8                    	dec	al
  4617 00001D9E 749E                    	jz	short lff22s2_9
  4618 00001DA0 FE0D[24270000]          	dec	byte [faz]
  4619 00001DA6 BD04000000              	mov	ebp, 4
  4620 00001DAB FEC8                    	dec	al
  4621 00001DAD 759B                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  4622 00001DAF 45                      	inc	ebp ; 5
  4623 00001DB0 EB98                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4624                                  
  4625                                  lff22s2_2_4:
  4626                                  	; 26/11/2023
  4627 00001DB2 E956F3FFFF              	jmp	lff22_3	; padfill
  4628                                  
  4629                                  ; .....................
  4630                                  
  4631                                  load_11khz_mono_8_bit:
  4632                                  	; 18/11/2023
  4633 00001DB7 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4634                                  					; last of the file?
  4635 00001DBE 7402                    	jz	short lff11m_0		; no
  4636 00001DC0 F9                      	stc
  4637 00001DC1 C3                      	retn
  4638                                  
  4639                                  lff11m_0:
  4640                                  	; 01/12/2024
  4641                                  	; edi = audio buffer address
  4642                                  	; 13/12/2024
  4643 00001DC2 893D[D8320000]          	mov	[audio_buffer], edi
  4644 00001DC8 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4645                                          ;mov	edx, [loadsize]
  4646                                  
  4647                                  	; esi = buffer address
  4648                                  	;; edx = buffer size
  4649                                  
  4650                                  	; load file into memory
  4651                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001DCD 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001DD3 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001DD5 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001DDB B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001DE0 CD40                <1>  int 40h
  4652 00001DE2 7247                    	jc	short lff11m_7 ; error !
  4653                                  
  4654                                  	; 01/12/2024
  4655 00001DE4 A3[A0380000]            	mov	[count], eax
  4656                                  
  4657                                  	;mov	edi, audio_buffer
  4658                                  	; 29/05/2024
  4659                                  	;mov	edi, [audio_buffer]
  4660                                  	
  4661 00001DE9 21C0                    	and	eax, eax
  4662 00001DEB 7505                    	jnz	short lff11m_8
  4663 00001DED E933F3FFFF              	jmp	lff11_eof
  4664                                  
  4665                                  lff11m_8:
  4666 00001DF2 89C1                    	mov	ecx, eax		; byte count
  4667                                  lff11m_9:
  4668 00001DF4 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4669                                  lff11m_1:
  4670                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4671 00001DF9 AC                      	lodsb
  4672 00001DFA B280                    	mov	dl, 80h
  4673 00001DFC 49                      	dec	ecx
  4674 00001DFD 7402                    	jz	short lff11m_2_1
  4675 00001DFF 8A16                    	mov	dl, [esi]
  4676                                  lff11m_2_1:	
  4677                                  	; al = [previous_val]
  4678                                  	; dl = [next_val]
  4679 00001E01 E87E050000              	call	interpolating_5_8bit_mono
  4680 00001E06 E333                    	jecxz	lff11m_3
  4681                                  lff11m_2_2:
  4682 00001E08 AC                      	lodsb
  4683 00001E09 B280                    	mov	dl, 80h
  4684 00001E0B 49                      	dec	ecx
  4685 00001E0C 7402                    	jz	short lff11m_2_3
  4686 00001E0E 8A16                    	mov	dl, [esi]
  4687                                  lff11m_2_3:
  4688 00001E10 E87B060000               	call	interpolating_4_8bit_mono
  4689 00001E15 E324                    	jecxz	lff11m_3
  4690                                  
  4691 00001E17 4D                      	dec	ebp
  4692 00001E18 74DA                    	jz	short lff11m_9
  4693                                  
  4694 00001E1A AC                      	lodsb
  4695 00001E1B B280                    	mov	dl, 80h
  4696 00001E1D 49                      	dec	ecx
  4697 00001E1E 7402                    	jz	short lff11m_2_4
  4698 00001E20 8A16                    	mov	dl, [esi]
  4699                                  lff11m_2_4:
  4700 00001E22 E869060000              	call	interpolating_4_8bit_mono
  4701 00001E27 E312                    	jecxz	lff11m_3
  4702 00001E29 EBCE                    	jmp	short lff11m_1
  4703                                  
  4704                                  lff11m_7:
  4705                                  lff11s_7:
  4706 00001E2B E9FEF2FFFF              	jmp	lff11_5  ; error
  4707                                  
  4708                                  load_11khz_stereo_8_bit:
  4709                                  	; 18/11/2023
  4710 00001E30 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4711                                  					; last of the file?
  4712 00001E37 7407                    	jz	short lff11s_0		; no
  4713 00001E39 F9                      	stc
  4714 00001E3A C3                      	retn
  4715                                  
  4716                                  lff11m_3:
  4717                                  lff11s_3:
  4718 00001E3B E9CDF2FFFF              	jmp	lff11_3	; padfill
  4719                                  		; (put zeros in the remain words of the buffer)
  4720                                  
  4721                                  lff11s_0:
  4722                                  	; 01/12/2024
  4723                                  	; edi = audio buffer address
  4724                                  	; 13/12/2024
  4725 00001E40 893D[D8320000]          	mov	[audio_buffer], edi
  4726 00001E46 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4727                                          ;mov	edx, [loadsize]
  4728                                  
  4729                                  	; esi = buffer address
  4730                                  	;; edx = buffer size
  4731                                  
  4732                                  	; load file into memory
  4733                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001E4B 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001E51 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001E53 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001E59 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001E5E CD40                <1>  int 40h
  4734 00001E60 72C9                    	jc	short lff11s_7 ; error !
  4735                                  
  4736                                  	; 01/12/2024
  4737 00001E62 A3[A0380000]            	mov	[count], eax
  4738                                  
  4739                                  	;mov	edi, audio_buffer
  4740                                  	; 29/05/2024
  4741                                  	;mov	edi, [audio_buffer]
  4742                                  	
  4743 00001E67 D1E8                    	shr	eax, 1
  4744 00001E69 7505                    	jnz	short lff11s_8
  4745 00001E6B E9B5F2FFFF              	jmp	lff11_eof
  4746                                  
  4747                                  lff11s_8:
  4748 00001E70 89C1                    	mov	ecx, eax	; word count
  4749                                  lff11s_9:
  4750 00001E72 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4751                                  lff11s_1:
  4752                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4753 00001E77 66AD                    	lodsw
  4754 00001E79 66BA8080                	mov	dx, 8080h
  4755 00001E7D 49                      	dec	ecx
  4756 00001E7E 7403                    	jz	short lff11s_2_1
  4757 00001E80 668B16                  	mov	dx, [esi]
  4758                                  lff11s_2_1:	
  4759                                  	; al = [previous_val_l]
  4760                                  	; ah = [previous_val_r]
  4761                                  	; dl = [next_val_l]
  4762                                  	; dh = [next_val_r]
  4763 00001E83 E85B050000              	call	interpolating_5_8bit_stereo
  4764 00001E88 E3B1                    	jecxz	lff11s_3
  4765                                  lff11s_2_2:
  4766 00001E8A 66AD                    	lodsw
  4767 00001E8C 66BA8080                	mov	dx, 8080h
  4768 00001E90 49                      	dec	ecx
  4769 00001E91 7403                    	jz	short lff11s_2_3
  4770 00001E93 668B16                  	mov	dx, [esi]
  4771                                  lff11s_2_3:
  4772 00001E96 E834060000               	call	interpolating_4_8bit_stereo
  4773 00001E9B E39E                    	jecxz	lff11s_3
  4774                                  	
  4775 00001E9D 4D                      	dec	ebp
  4776 00001E9E 74D2                    	jz	short lff11s_9
  4777                                  
  4778 00001EA0 66AD                    	lodsw
  4779 00001EA2 66BA8080                	mov	dx, 8080h
  4780 00001EA6 49                      	dec	ecx
  4781 00001EA7 7403                    	jz	short lff11s_2_4
  4782 00001EA9 668B16                  	mov	dx, [esi]
  4783                                  lff11s_2_4:
  4784 00001EAC E81E060000              	call	interpolating_4_8bit_stereo
  4785 00001EB1 E388                    	jecxz	lff11s_3
  4786 00001EB3 EBC2                    	jmp	short lff11s_1
  4787                                  
  4788                                  load_11khz_mono_16_bit:
  4789                                  	; 18/11/2023
  4790 00001EB5 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4791                                  					; last of the file?
  4792 00001EBC 7402                    	jz	short lff11m2_0		; no
  4793 00001EBE F9                      	stc
  4794 00001EBF C3                      	retn
  4795                                  
  4796                                  lff11m2_0:
  4797                                  	; 01/12/2024
  4798                                  	; edi = audio buffer address
  4799                                  	; 13/12/2024
  4800 00001EC0 893D[D8320000]          	mov	[audio_buffer], edi
  4801 00001EC6 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4802                                          ;mov	edx, [loadsize]
  4803                                  
  4804                                  	; esi = buffer address
  4805                                  	;; edx = buffer size
  4806                                  
  4807                                  	; load file into memory
  4808                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001ECB 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001ED1 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001ED3 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001ED9 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001EDE CD40                <1>  int 40h
  4809 00001EE0 724D                    	jc	short lff11m2_7 ; error !
  4810                                  
  4811                                  	; 01/12/2024
  4812 00001EE2 A3[A0380000]            	mov	[count], eax
  4813                                  
  4814                                  	;mov	edi, audio_buffer
  4815                                  	; 29/05/2024
  4816                                  	;mov	edi, [audio_buffer]
  4817                                  	
  4818 00001EE7 D1E8                    	shr	eax, 1
  4819 00001EE9 7505                    	jnz	short lff11m2_8
  4820 00001EEB E935F2FFFF              	jmp	lff11_eof
  4821                                  
  4822                                  lff11m2_8:
  4823 00001EF0 89C1                    	mov	ecx, eax	; word count
  4824                                  lff11m2_9:
  4825 00001EF2 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4826                                  lff11m2_1:
  4827                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4828 00001EF7 66AD                    	lodsw
  4829 00001EF9 31D2                    	xor	edx, edx
  4830 00001EFB 49                      	dec	ecx
  4831 00001EFC 7403                    	jz	short lff11m2_2_1
  4832 00001EFE 668B16                  	mov	dx, [esi]
  4833                                  lff11m2_2_1:	
  4834                                  	; ax = [previous_val]
  4835                                  	; dx = [next_val]
  4836 00001F01 E836060000              	call	interpolating_5_16bit_mono
  4837 00001F06 E368                    	jecxz	lff11m2_3
  4838                                  lff11m2_2_2:
  4839 00001F08 66AD                    	lodsw
  4840 00001F0A 31D2                    	xor	edx, edx
  4841 00001F0C 49                      	dec	ecx
  4842 00001F0D 7403                    	jz	short lff11m2_2_3
  4843 00001F0F 668B16                  	mov	dx, [esi]
  4844                                  lff11m2_2_3:
  4845 00001F12 E84F070000               	call	interpolating_4_16bit_mono
  4846 00001F17 E357                    	jecxz	lff11m2_3
  4847                                  
  4848 00001F19 4D                      	dec	ebp
  4849 00001F1A 74D6                    	jz	short lff11m2_9
  4850                                  
  4851 00001F1C 66AD                    	lodsw
  4852 00001F1E 31D2                    	xor	edx, edx
  4853 00001F20 49                      	dec	ecx
  4854 00001F21 7403                    	jz	short lff11m2_2_4
  4855 00001F23 668B16                  	mov	dx, [esi]
  4856                                  lff11m2_2_4:
  4857 00001F26 E83B070000               	call	interpolating_4_16bit_mono
  4858 00001F2B E343                    	jecxz	lff11m2_3
  4859 00001F2D EBC8                    	jmp	short lff11m2_1
  4860                                  
  4861                                  lff11m2_7:
  4862                                  lff11s2_7:
  4863 00001F2F E9FAF1FFFF              	jmp	lff11_5  ; error
  4864                                  
  4865                                  load_11khz_stereo_16_bit:
  4866                                  	; 18/01/2025
  4867                                  	; 18/11/2023
  4868 00001F34 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4869                                  					; last of the file?
  4870 00001F3B 7402                    	jz	short lff11s2_0		; no
  4871 00001F3D F9                      	stc
  4872 00001F3E C3                      	retn
  4873                                  
  4874                                  lff11s2_0:
  4875                                  	; 01/12/2024
  4876                                  	; edi = audio buffer address
  4877                                  	; 13/12/2024
  4878 00001F3F 893D[D8320000]          	mov	[audio_buffer], edi
  4879 00001F45 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4880                                          ;mov	edx, [loadsize]
  4881                                  
  4882                                  	; esi = buffer address
  4883                                  	;; edx = buffer size
  4884                                  
  4885                                  	; load file into memory
  4886                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001F4A 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001F50 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001F52 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001F58 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001F5D CD40                <1>  int 40h
  4887 00001F5F 72CE                    	jc	short lff11s2_7 ; error !
  4888                                  
  4889                                  	; 01/12/2024
  4890 00001F61 A3[A0380000]            	mov	[count], eax
  4891                                  
  4892                                  	;mov	edi, audio_buffer
  4893                                  	; 29/05/2024
  4894                                  	;mov	edi, [audio_buffer]
  4895                                  	
  4896 00001F66 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  4897 00001F69 750A                    	jnz	short lff11s2_8
  4898 00001F6B E9B5F1FFFF              	jmp	lff11_eof
  4899                                  
  4900                                  lff11m2_3:
  4901                                  lff11s2_3:
  4902 00001F70 E998F1FFFF              	jmp	lff11_3	; padfill
  4903                                  		; (put zeros in the remain words of the buffer)
  4904                                  
  4905                                  lff11s2_8:
  4906 00001F75 89C1                    	mov	ecx, eax	; dword count
  4907                                  lff11s2_9:
  4908 00001F77 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4909                                  lff11s2_1:
  4910                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4911 00001F7C 66AD                    	lodsw
  4912 00001F7E 89C3                    	mov	ebx, eax
  4913 00001F80 66AD                    	lodsw
  4914 00001F82 8B16                    	mov	edx, [esi]
  4915                                  	; 18/01/2025
  4916                                  	;mov	[next_val_l], edx
  4917                                  	; 26/11/2023
  4918                                  	;shr	edx, 16
  4919                                  	;mov	[next_val_r], dx
  4920 00001F84 49                      	dec	ecx
  4921 00001F85 7502                    	jnz	short lff11s2_2_1
  4922 00001F87 31D2                    	xor	edx, edx ; 0
  4923                                  	;mov	[next_val_l], dx
  4924                                  	;mov	[next_val_r], dx
  4925                                  lff11s2_2_1:
  4926                                  	; bx = [previous_val_l]
  4927                                  	; ax = [previous_val_r]
  4928                                  	; [next_val_l]
  4929                                  	; dx = [next_val_r]
  4930                                  	;;;
  4931                                  	; 18/01/2025 (BugFix)
  4932 00001F89 8915[20270000]          	mov	[next_val_l], edx
  4933                                  	;;;
  4934 00001F8F E803060000              	call	interpolating_5_16bit_stereo
  4935 00001F94 E3DA                    	jecxz	lff11s2_3
  4936                                  lff11s2_2_2:
  4937 00001F96 66AD                    	lodsw
  4938 00001F98 89C3                    	mov	ebx, eax
  4939 00001F9A 66AD                    	lodsw
  4940 00001F9C 8B16                    	mov	edx, [esi]
  4941                                  	; 18/01/2025
  4942                                  	;mov	[next_val_l], dx
  4943                                  	; 26/11/2023
  4944                                  	;shr	edx, 16
  4945                                  	;mov	[next_val_r], dx
  4946 00001F9E 49                      	dec	ecx
  4947 00001F9F 7502                    	jnz	short lff11s2_2_3
  4948 00001FA1 31D2                    	xor	edx, edx ; 0
  4949                                  	;mov	[next_val_l], dx
  4950                                  	;mov	[next_val_r], dx
  4951                                  lff11s2_2_3:
  4952                                  	;;;
  4953                                  	; 18/01/2025 (BugFix)
  4954 00001FA3 8915[20270000]          	mov	[next_val_l], edx
  4955                                  	;;;
  4956 00001FA9 E8F1060000              	call	interpolating_4_16bit_stereo
  4957 00001FAE E3C0                    	jecxz	lff11s2_3
  4958                                  	
  4959 00001FB0 4D                      	dec	ebp
  4960 00001FB1 74C4                    	jz	short lff11s2_9
  4961                                  
  4962 00001FB3 66AD                    	lodsw
  4963 00001FB5 89C3                    	mov	ebx, eax
  4964 00001FB7 66AD                    	lodsw
  4965 00001FB9 8B16                    	mov	edx, [esi]
  4966                                  	; 18/01/2025
  4967                                  	;mov	[next_val_l], dx
  4968                                  	; 26/11/2023
  4969                                  	;shr	edx, 16
  4970                                  	;mov	[next_val_r], dx
  4971 00001FBB 49                      	dec	ecx
  4972 00001FBC 7502                    	jnz	short lff11s2_2_4
  4973 00001FBE 31D2                    	xor	edx, edx ; 0
  4974                                  	;mov	[next_val_l], dx
  4975                                  	;mov	[next_val_r], dx
  4976                                  lff11s2_2_4:
  4977                                  	;;;
  4978                                  	; 18/01/2025 (BugFix)
  4979 00001FC0 8915[20270000]          	mov	[next_val_l], edx
  4980                                  	;;;
  4981 00001FC6 E8D4060000               	call	interpolating_4_16bit_stereo
  4982 00001FCB E3A3                    	jecxz	lff11s2_3
  4983 00001FCD EBAD                    	jmp	short lff11s2_1
  4984                                  
  4985                                  ; .....................
  4986                                  
  4987                                  load_44khz_mono_8_bit:
  4988                                  	; 18/11/2023
  4989 00001FCF F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4990                                  					; last of the file?
  4991 00001FD6 7402                    	jz	short lff44m_0		; no
  4992 00001FD8 F9                      	stc
  4993 00001FD9 C3                      	retn
  4994                                  
  4995                                  lff44m_0:
  4996                                  	; 01/12/2024
  4997                                  	; edi = audio buffer address
  4998                                  	; 13/12/2024
  4999 00001FDA 893D[D8320000]          	mov	[audio_buffer], edi
  5000 00001FE0 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5001                                          ;mov	edx, [loadsize]
  5002                                  
  5003                                  	; esi = buffer address
  5004                                  	;; edx = buffer size
  5005                                  
  5006                                  	; load file into memory
  5007                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001FE5 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001FEB 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001FED 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001FF3 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001FF8 CD40                <1>  int 40h
  5008 00001FFA 7250                    	jc	short lff44m_7 ; error !
  5009                                  
  5010                                  	; 01/12/2024
  5011 00001FFC A3[A0380000]            	mov	[count], eax
  5012                                  
  5013                                  	;mov	edi, audio_buffer
  5014                                  	; 29/05/2024
  5015                                  	;mov	edi, [audio_buffer]
  5016                                  	
  5017 00002001 21C0                    	and	eax, eax
  5018 00002003 7505                    	jnz	short lff44m_8
  5019 00002005 E91BF1FFFF              	jmp	lff44_eof
  5020                                  
  5021                                  lff44m_8:
  5022 0000200A 89C1                    	mov	ecx, eax	; byte count
  5023                                  lff44m_9:
  5024 0000200C BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5025 00002011 C605[24270000]02        	mov	byte [faz], 2  ; 2 steps/phases
  5026                                  lff44m_1:
  5027                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5028                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5029 00002018 AC                      	lodsb
  5030 00002019 B280                    	mov	dl, 80h
  5031 0000201B 49                      	dec	ecx
  5032 0000201C 7402                    	jz	short lff44m_2_1
  5033 0000201E 8A16                    	mov	dl, [esi]
  5034                                  lff44m_2_1:	
  5035                                  	; al = [previous_val]
  5036                                  	; dl = [next_val]
  5037 00002020 E837020000              	call	interpolating_2_8bit_mono
  5038 00002025 E320                    	jecxz	lff44m_3
  5039                                  lff44m_2_2:
  5040 00002027 AC                      	lodsb
  5041 00002028 2C80                    	sub	al, 80h
  5042 0000202A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5043 0000202E 66AB                    	stosw		; (L)
  5044 00002030 66AB                    	stosw		; (R)
  5045                                  
  5046 00002032 49                      	dec	ecx
  5047 00002033 7412                    	jz	short lff44m_3
  5048 00002035 4D                      	dec	ebp
  5049 00002036 75EF                    	jnz	short lff44m_2_2
  5050                                  	
  5051 00002038 FE0D[24270000]          	dec	byte [faz]
  5052 0000203E 74CC                    	jz	short lff44m_9 
  5053 00002040 BD0B000000              	mov	ebp, 11
  5054 00002045 EBD1                    	jmp	short lff44m_1
  5055                                  
  5056                                  lff44m_3:
  5057                                  lff44s_3:
  5058 00002047 E9C1F0FFFF              	jmp	lff44_3	; padfill
  5059                                  		; (put zeros in the remain words of the buffer)
  5060                                  lff44m_7:
  5061                                  lff44s_7:
  5062 0000204C E9DDF0FFFF              	jmp	lff44_5  ; error
  5063                                  
  5064                                  load_44khz_stereo_8_bit:
  5065                                  	; 16/11/2023
  5066 00002051 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  5067                                  					; last of the file?
  5068 00002058 7402                    	jz	short lff44s_0		; no
  5069 0000205A F9                      	stc
  5070 0000205B C3                      	retn
  5071                                  
  5072                                  lff44s_0:
  5073                                  	; 01/12/2024
  5074                                  	; edi = audio buffer address
  5075                                  	; 13/12/2024
  5076 0000205C 893D[D8320000]          	mov	[audio_buffer], edi
  5077 00002062 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5078                                          ;mov	edx, [loadsize]
  5079                                  
  5080                                  	; esi = buffer address
  5081                                  	;; edx = buffer size
  5082                                  
  5083                                  	; load file into memory
  5084                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00002067 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000206D 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000206F 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00002075 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 0000207A CD40                <1>  int 40h
  5085 0000207C 72CE                    	jc	short lff44s_7 ; error !
  5086                                  
  5087                                  	; 01/12/2024
  5088 0000207E A3[A0380000]            	mov	[count], eax
  5089                                  
  5090                                  	;mov	edi, audio_buffer
  5091                                  	; 29/05/2024
  5092                                  	;mov	edi, [audio_buffer]
  5093                                  	
  5094 00002083 D1E8                    	shr	eax, 1
  5095 00002085 7505                    	jnz	short lff44s_8
  5096 00002087 E999F0FFFF              	jmp	lff44_eof
  5097                                  
  5098                                  lff44s_8:
  5099 0000208C 89C1                    	mov	ecx, eax	; word count
  5100                                  lff44s_9:
  5101 0000208E BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5102 00002093 C605[24270000]02        	mov	byte [faz], 2  ; 2 steps/phase
  5103                                  lff44s_1:
  5104                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5105                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5106 0000209A 66AD                    	lodsw
  5107 0000209C 66BA8080                	mov	dx, 8080h
  5108 000020A0 49                      	dec	ecx
  5109 000020A1 7403                    	jz	short lff44s_2_1
  5110 000020A3 668B16                  	mov	dx, [esi]
  5111                                  lff44s_2_1:	
  5112                                  	; al = [previous_val_l]
  5113                                  	; ah = [previous_val_r]
  5114                                  	; dl = [next_val_l]
  5115                                  	; dh = [next_val_r]
  5116 000020A6 E8CE010000              	call	interpolating_2_8bit_stereo
  5117 000020AB E39A                    	jecxz	lff44s_3
  5118                                  lff44s_2_2:
  5119 000020AD AC                      	lodsb
  5120 000020AE 2C80                    	sub	al, 80h
  5121 000020B0 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5122 000020B4 66AB                    	stosw		; (L)
  5123 000020B6 AC                      	lodsb
  5124 000020B7 2C80                    	sub	al, 80h
  5125 000020B9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5126 000020BD 66AB                    	stosw		; (R)
  5127                                  
  5128 000020BF 49                      	dec	ecx
  5129 000020C0 7485                    	jz	short lff44s_3	
  5130 000020C2 4D                      	dec	ebp
  5131 000020C3 75E8                    	jnz	short lff44s_2_2
  5132                                  	
  5133 000020C5 FE0D[24270000]          	dec	byte [faz]
  5134 000020CB 74C1                    	jz	short lff44s_9 
  5135 000020CD BD0B000000              	mov	ebp, 11
  5136 000020D2 EBC6                    	jmp	short lff44s_1
  5137                                  
  5138                                  load_44khz_mono_16_bit:
  5139                                  	; 18/11/2023
  5140 000020D4 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  5141                                  					; last of the file?
  5142 000020DB 7402                    	jz	short lff44m2_0		; no
  5143 000020DD F9                      	stc
  5144 000020DE C3                      	retn
  5145                                  
  5146                                  lff44m2_0:
  5147                                  	; 01/12/2024
  5148                                  	; edi = audio buffer address
  5149                                  	; 13/12/2024
  5150 000020DF 893D[D8320000]          	mov	[audio_buffer], edi
  5151 000020E5 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5152                                          ;mov	edx, [loadsize]
  5153                                  
  5154                                  	; esi = buffer address
  5155                                  	;; edx = buffer size
  5156                                  
  5157                                  	; load file into memory
  5158                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000020EA 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000020F0 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000020F2 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000020F8 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 000020FD CD40                <1>  int 40h
  5159 000020FF 724D                    	jc	short lff44m2_7 ; error !
  5160                                  
  5161                                  	; 01/12/2024
  5162 00002101 A3[A0380000]            	mov	[count], eax
  5163                                  
  5164                                  	;mov	edi, audio_buffer
  5165                                  	; 29/05/2024
  5166                                  	;mov	edi, [audio_buffer]
  5167                                  	
  5168 00002106 D1E8                    	shr	eax, 1
  5169 00002108 7505                    	jnz	short lff44m2_8
  5170 0000210A E916F0FFFF              	jmp	lff44_eof
  5171                                  
  5172                                  lff44m2_8:
  5173 0000210F 89C1                    	mov	ecx, eax	; word count
  5174                                  lff44m2_9:
  5175 00002111 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5176 00002116 C605[24270000]02        	mov	byte [faz], 2  ; 2 steps/phases
  5177                                  lff44m2_1:
  5178                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5179                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5180 0000211D 66AD                    	lodsw
  5181 0000211F 31D2                    	xor	edx, edx
  5182 00002121 49                      	dec	ecx
  5183 00002122 7403                    	jz	short lff44m2_2_1
  5184 00002124 668B16                  	mov	dx, [esi]
  5185                                  lff44m2_2_1:	
  5186                                  	; ax = [previous_val]
  5187                                  	; dx = [next_val]
  5188 00002127 E811020000              	call	interpolating_2_16bit_mono
  5189 0000212C E31B                    	jecxz	lff44m2_3
  5190                                  lff44m2_2_2:
  5191 0000212E 66AD                    	lodsw
  5192 00002130 66AB                    	stosw		; (L)eft Channel
  5193 00002132 66AB                    	stosw		; (R)ight Channel
  5194                                  
  5195 00002134 49                      	dec	ecx
  5196 00002135 7412                    	jz	short lff44m2_3	
  5197 00002137 4D                      	dec	ebp
  5198 00002138 75F4                    	jnz	short lff44m2_2_2
  5199                                  	
  5200 0000213A FE0D[24270000]          	dec	byte [faz]
  5201 00002140 74CF                    	jz	short lff44m2_9 
  5202 00002142 BD0B000000              	mov	ebp, 11
  5203 00002147 EBD4                    	jmp	short lff44m2_1
  5204                                  
  5205                                  lff44m2_3:
  5206                                  lff44s2_3:
  5207 00002149 E9BFEFFFFF              	jmp	lff44_3	; padfill
  5208                                  		; (put zeros in the remain words of the buffer)
  5209                                  lff44m2_7:
  5210                                  lff44s2_7:
  5211 0000214E E9DBEFFFFF              	jmp	lff44_5  ; error
  5212                                  
  5213                                  load_44khz_stereo_16_bit:
  5214                                  	; 18/11/2023
  5215 00002153 F605[1A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  5216                                  					; last of the file?
  5217 0000215A 7402                    	jz	short lff44s2_0		; no
  5218 0000215C F9                      	stc
  5219 0000215D C3                      	retn
  5220                                  
  5221                                  lff44s2_0:
  5222                                  	; 01/12/2024
  5223                                  	; edi = audio buffer address
  5224                                  	; 13/12/2024
  5225 0000215E 893D[D8320000]          	mov	[audio_buffer], edi
  5226 00002164 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5227                                          ;mov	edx, [loadsize]
  5228                                  
  5229                                  	; esi = buffer address
  5230                                  	;; edx = buffer size
  5231                                  
  5232                                  	; load file into memory
  5233                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00002169 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000216F 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00002171 8B15[90380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00002177 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 0000217C CD40                <1>  int 40h
  5234 0000217E 72CE                    	jc	short lff44s2_7 ; error !
  5235                                  
  5236                                  	; 01/12/2024
  5237 00002180 A3[A0380000]            	mov	[count], eax
  5238                                  
  5239                                  	;mov	edi, audio_buffer
  5240                                  	; 29/05/2024
  5241                                  	;mov	edi, [audio_buffer]
  5242                                  	
  5243 00002185 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  5244 00002188 7505                    	jnz	short lff44s2_8
  5245 0000218A E996EFFFFF              	jmp	lff44_eof
  5246                                  
  5247                                  lff44s2_8:
  5248 0000218F 89C1                    	mov	ecx, eax	; dword count
  5249                                  lff44s2_9:
  5250 00002191 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5251 00002196 C605[24270000]02        	mov	byte [faz], 2  ; 2 steps/phase
  5252                                  lff44s2_1:
  5253                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5254                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5255 0000219D 66AD                    	lodsw
  5256 0000219F 89C3                    	mov	ebx, eax
  5257 000021A1 66AD                    	lodsw
  5258                                  	;mov	dx, [esi]
  5259                                  	;mov	[next_val_l], dx
  5260                                  	;mov	dx, [esi+2]
  5261                                  	; 26/11/2023
  5262 000021A3 8B16                    	mov	edx, [esi]
  5263 000021A5 668915[20270000]        	mov	[next_val_l], dx
  5264 000021AC C1EA10                  	shr	edx, 16
  5265 000021AF 49                      	dec	ecx
  5266 000021B0 7509                    	jnz	short lff44s2_2_1
  5267 000021B2 31D2                    	xor	edx, edx ; 0
  5268 000021B4 668915[20270000]        	mov	[next_val_l], dx
  5269                                  lff44s2_2_1:
  5270                                  	; bx = [previous_val_l]
  5271                                  	; ax = [previous_val_r]
  5272                                  	; [next_val_l]
  5273                                  	; dx = [next_val_r]
  5274 000021BB E895010000              	call	interpolating_2_16bit_stereo
  5275 000021C0 E387                    	jecxz	lff44s2_3
  5276                                  lff44s2_2_2:
  5277                                  	;movsw		; (L)eft Channel
  5278                                  	;movsw		; (R)ight Channel
  5279 000021C2 A5                      	movsd
  5280                                  
  5281 000021C3 49                      	dec	ecx
  5282 000021C4 7483                    	jz	short lff44s2_3	
  5283 000021C6 4D                      	dec	ebp
  5284 000021C7 75F9                    	jnz	short lff44s2_2_2
  5285                                  	
  5286 000021C9 FE0D[24270000]          	dec	byte [faz]
  5287 000021CF 74C0                    	jz	short lff44s2_9 
  5288 000021D1 BD0B000000              	mov	ebp, 11
  5289 000021D6 EBC5                    	jmp	short lff44s2_1
  5290                                  
  5291                                  ; .....................
  5292                                  
  5293                                  interpolating_3_8bit_mono:
  5294                                  	; 16/11/2023
  5295                                  	; al = [previous_val]
  5296                                  	; dl = [next_val]
  5297                                  	; original-interpolated-interpolated
  5298 000021D8 88C3                    	mov	bl, al
  5299 000021DA 2C80                    	sub	al, 80h
  5300 000021DC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5301 000021E0 66AB                    	stosw		; original sample (L)
  5302 000021E2 66AB                    	stosw		; original sample (R)
  5303 000021E4 88D8                    	mov	al, bl
  5304 000021E6 00D0                    	add	al, dl
  5305 000021E8 D0D8                    	rcr	al, 1
  5306 000021EA 88C7                    	mov	bh, al	; interpolated middle (temporary)
  5307 000021EC 00D8                    	add	al, bl
  5308 000021EE D0D8                    	rcr	al, 1
  5309 000021F0 2C80                    	sub	al, 80h
  5310 000021F2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5311 000021F6 66AB                    	stosw		; interpolated sample 1 (L)
  5312 000021F8 66AB                    	stosw		; interpolated sample 1 (R)
  5313 000021FA 88F8                    	mov	al, bh
  5314 000021FC 00D0                    	add	al, dl	; [next_val]
  5315 000021FE D0D8                    	rcr	al, 1
  5316 00002200 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5317 00002204 66AB                    	stosw		; interpolated sample 2 (L)
  5318 00002206 66AB                    	stosw		; interpolated sample 2 (R)
  5319 00002208 C3                      	retn
  5320                                  
  5321                                  interpolating_3_8bit_stereo:
  5322                                  	; 16/11/2023
  5323                                  	; al = [previous_val_l]
  5324                                  	; ah = [previous_val_r]
  5325                                  	; dl = [next_val_l]
  5326                                  	; dh = [next_val_r]
  5327                                  	; original-interpolated-interpolated
  5328 00002209 89C3                    	mov	ebx, eax
  5329 0000220B 2C80                    	sub	al, 80h
  5330 0000220D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5331 00002211 66AB                    	stosw		; original sample (L)
  5332 00002213 88F8                    	mov	al, bh
  5333 00002215 2C80                    	sub	al, 80h
  5334 00002217 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5335 0000221B 66AB                    	stosw		; original sample (R)
  5336 0000221D 88D8                    	mov	al, bl
  5337 0000221F 00D0                    	add	al, dl	; [next_val_l]
  5338 00002221 D0D8                    	rcr	al, 1
  5339 00002223 50                      	push	eax ; *	; al = interpolated middle (L) (temporary)
  5340 00002224 00D8                    	add	al, bl	; [previous_val_l]
  5341 00002226 D0D8                    	rcr	al, 1
  5342 00002228 2C80                    	sub	al, 80h
  5343 0000222A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5344 0000222E 66AB                    	stosw		; interpolated sample 1 (L)
  5345 00002230 88F8                    	mov	al, bh
  5346 00002232 00F0                    	add	al, dh	; [next_val_r]
  5347 00002234 D0D8                    	rcr	al, 1
  5348 00002236 50                      	push	eax ; ** ; al = interpolated middle (R) (temporary)
  5349 00002237 00F8                    	add	al, bh	; [previous_val_r]
  5350 00002239 D0D8                    	rcr	al, 1
  5351 0000223B 2C80                    	sub	al, 80h
  5352 0000223D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5353 00002241 66AB                    	stosw		; interpolated sample 1 (R)
  5354 00002243 5B                      	pop	ebx ; **
  5355 00002244 58                      	pop	eax ; *
  5356 00002245 00D0                    	add	al, dl	; [next_val_l]
  5357 00002247 D0D8                    	rcr	al, 1
  5358 00002249 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5359 0000224D 66AB                    	stosw		; interpolated sample 2 (L)
  5360 0000224F 88D8                    	mov	al, bl
  5361 00002251 00F0                    	add	al, dh	; [next_val_r]
  5362 00002253 D0D8                    	rcr	al, 1
  5363 00002255 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5364 00002259 66AB                    	stosw		; interpolated sample 2 (R)
  5365 0000225B C3                      	retn
  5366                                  
  5367                                  interpolating_2_8bit_mono:
  5368                                  	; 16/11/2023
  5369                                  	; al = [previous_val]
  5370                                  	; dl = [next_val]
  5371                                  	; original-interpolated
  5372 0000225C 88C3                    	mov	bl, al
  5373 0000225E 2C80                    	sub	al, 80h
  5374 00002260 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5375 00002264 66AB                    	stosw		; original sample (L)
  5376 00002266 66AB                    	stosw		; original sample (R)
  5377 00002268 88D8                    	mov	al, bl
  5378 0000226A 00D0                    	add	al, dl
  5379 0000226C D0D8                    	rcr	al, 1
  5380 0000226E 2C80                    	sub	al, 80h
  5381 00002270 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5382 00002274 66AB                    	stosw		; interpolated sample (L)
  5383 00002276 66AB                    	stosw		; interpolated sample (R)
  5384 00002278 C3                      	retn
  5385                                  
  5386                                  interpolating_2_8bit_stereo:
  5387                                  	; 16/11/2023
  5388                                  	; al = [previous_val_l]
  5389                                  	; ah = [previous_val_r]
  5390                                  	; dl = [next_val_l]
  5391                                  	; dh = [next_val_r]
  5392                                  	; original-interpolated
  5393 00002279 89C3                    	mov	ebx, eax
  5394 0000227B 2C80                    	sub	al, 80h
  5395 0000227D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5396 00002281 66AB                    	stosw		; original sample (L)
  5397 00002283 88F8                    	mov	al, bh
  5398 00002285 2C80                    	sub	al, 80h
  5399 00002287 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5400 0000228B 66AB                    	stosw		; original sample (R)
  5401 0000228D 88D8                    	mov	al, bl	; [previous_val_l]
  5402 0000228F 00D0                    	add	al, dl	; [next_val_l]
  5403 00002291 D0D8                    	rcr	al, 1
  5404 00002293 2C80                    	sub	al, 80h
  5405 00002295 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5406 00002299 66AB                    	stosw		; interpolated sample (L)
  5407 0000229B 88F8                    	mov	al, bh
  5408 0000229D 00F0                    	add	al, dh	; [next_val_r]
  5409 0000229F D0D8                    	rcr	al, 1
  5410 000022A1 2C80                    	sub	al, 80h
  5411 000022A3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5412 000022A7 66AB                    	stosw		; interpolated sample (R)
  5413 000022A9 C3                      	retn
  5414                                  
  5415                                  interpolating_3_16bit_mono:
  5416                                  	; 16/11/2023
  5417                                  	; ax = [previous_val]
  5418                                  	; dx = [next_val]
  5419                                  	; original-interpolated-interpolated
  5420                                  
  5421 000022AA 66AB                    	stosw		; original sample (L)
  5422 000022AC 66AB                    	stosw		; original sample (R)
  5423 000022AE 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5424 000022B1 50                      	push	eax ; *	; [previous_val]
  5425 000022B2 80C680                  	add	dh, 80h
  5426 000022B5 6601D0                  	add	ax, dx
  5427 000022B8 66D1D8                  	rcr	ax, 1
  5428 000022BB 5B                      	pop	ebx ; *
  5429 000022BC 93                      	xchg	ebx, eax ; bx  = interpolated middle (temporary)
  5430 000022BD 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  5431 000022C0 66D1D8                  	rcr	ax, 1
  5432 000022C3 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5433 000022C6 66AB                    	stosw 		; interpolated sample 1 (L)
  5434 000022C8 66AB                    	stosw		; interpolated sample 1 (R)
  5435 000022CA 89D8                    	mov	eax, ebx
  5436 000022CC 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  5437 000022CF 66D1D8                  	rcr	ax, 1
  5438 000022D2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5439 000022D5 66AB                    	stosw		; interpolated sample 2 (L)
  5440 000022D7 66AB                    	stosw		; interpolated sample 2 (R)
  5441 000022D9 C3                      	retn
  5442                                  
  5443                                  interpolating_3_16bit_stereo:
  5444                                  	; 16/11/2023
  5445                                  	; bx = [previous_val_l]
  5446                                  	; ax = [previous_val_r]
  5447                                  	; [next_val_l]
  5448                                  	; dx = [next_val_r]
  5449                                  	; original-interpolated-interpolated
  5450                                  
  5451 000022DA 93                      	xchg	eax, ebx
  5452 000022DB 66AB                    	stosw		; original sample (L)
  5453 000022DD 93                      	xchg	eax, ebx
  5454 000022DE 66AB                    	stosw		; original sample (R)
  5455 000022E0 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5456 000022E3 50                      	push	eax ; *	; [previous_val_r]
  5457 000022E4 80C780                  	add	bh, 80h
  5458 000022E7 8005[21270000]80        	add	byte [next_val_l+1], 80h
  5459 000022EE 66A1[20270000]          	mov	ax, [next_val_l]
  5460 000022F4 6601D8                  	add	ax, bx	; [previous_val_l]
  5461 000022F7 66D1D8                  	rcr	ax, 1
  5462 000022FA 93                      	xchg	eax, ebx ; ax = [previous_val_l]
  5463 000022FB 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  5464 000022FE 66D1D8                  	rcr	ax, 1
  5465 00002301 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5466 00002304 66AB                    	stosw 		; interpolated sample 1 (L)
  5467 00002306 58                      	pop	eax  ; *
  5468 00002307 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  5469 0000230A 52                      	push	edx  ; * ; [next_val_r]
  5470 0000230B 92                      	xchg	eax, edx
  5471 0000230C 6601D0                  	add	ax, dx	; [next_val_r] + [previous_val_r]
  5472 0000230F 66D1D8                  	rcr	ax, 1	; / 2
  5473 00002312 50                      	push	eax ; ** ; interpolated middle (R)
  5474 00002313 6601D0                  	add	ax, dx	; + [previous_val_r]
  5475 00002316 66D1D8                  	rcr	ax, 1
  5476 00002319 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5477 0000231C 66AB                    	stosw 		; interpolated sample 1 (R)
  5478 0000231E 66A1[20270000]          	mov	ax, [next_val_l]
  5479 00002324 6601D8                  	add	ax, bx	; + interpolated middle (L)
  5480 00002327 66D1D8                  	rcr	ax, 1
  5481 0000232A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5482 0000232D 66AB                    	stosw 		; interpolated sample 2 (L)
  5483 0000232F 58                      	pop	eax ; **
  5484 00002330 5A                      	pop	edx ; *
  5485 00002331 6601D0                  	add	ax, dx	; interpolated middle + [next_val_r]
  5486 00002334 66D1D8                  	rcr	ax, 1	; / 2
  5487 00002337 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5488 0000233A 66AB                    	stosw 		; interpolated sample 2 (L)
  5489 0000233C C3                      	retn
  5490                                  
  5491                                  interpolating_2_16bit_mono:
  5492                                  	; 16/11/2023
  5493                                  	; ax = [previous_val]
  5494                                  	; dx = [next_val]
  5495                                  	; original-interpolated
  5496                                  
  5497 0000233D 66AB                    	stosw		; original sample (L)
  5498 0000233F 66AB                    	stosw		; original sample (R)
  5499 00002341 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5500 00002344 80C680                  	add	dh, 80h
  5501 00002347 6601D0                  	add	ax, dx
  5502 0000234A 66D1D8                  	rcr	ax, 1
  5503 0000234D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5504 00002350 66AB                    	stosw		; interpolated sample (L)
  5505 00002352 66AB                    	stosw		; interpolated sample (R)
  5506 00002354 C3                      	retn
  5507                                  
  5508                                  interpolating_2_16bit_stereo:
  5509                                  	; 18/01/2025
  5510                                  	; 16/11/2023
  5511                                  	; bx = [previous_val_l]
  5512                                  	; ax = [previous_val_r]
  5513                                  	; [next_val_l]
  5514                                  	; dx = [next_val_r]
  5515                                  	; original-interpolated
  5516                                  
  5517 00002355 93                      	xchg	eax, ebx
  5518 00002356 66AB                    	stosw		; original sample (L)
  5519 00002358 93                      	xchg	eax, ebx
  5520 00002359 66AB                    	stosw		; original sample (R)
  5521 0000235B 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5522 0000235E 80C680                  	add	dh, 80h
  5523 00002361 6601D0                  	add	ax, dx	; [previous_val_r] + [next_val_r]
  5524 00002364 66D1D8                  	rcr	ax, 1	; / 2
  5525                                  	; 18/01/2025
  5526 00002367 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5527                                  	;push	eax ; *	; interpolated sample (R)
  5528                                  	; 18/01/2025
  5529 0000236A C1E010                  	shl	eax, 16
  5530 0000236D 66A1[20270000]          	mov	ax, [next_val_l]
  5531 00002373 80C480                  	add	ah, 80h
  5532 00002376 80C780                  	add	bh, 80h
  5533 00002379 6601D8                  	add	ax, bx	; [next_val_l] + [previous_val_l]
  5534 0000237C 66D1D8                  	rcr	ax, 1	; / 2
  5535 0000237F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5536                                  	; 18/01/2025
  5537                                  	;stosw 		; interpolated sample (L)
  5538                                  	;pop	eax ; *	
  5539                                  	;sub	ah, 80h	; -32768 to +32767 format again
  5540                                  	;stosw 		; interpolated sample (R)
  5541                                  	; 18/01/2025
  5542 00002382 AB                      	stosd
  5543 00002383 C3                      	retn
  5544                                  
  5545                                  interpolating_5_8bit_mono:
  5546                                  	; 17/11/2023
  5547                                  	; al = [previous_val]
  5548                                  	; dl = [next_val]
  5549                                  	; original-interpltd-interpltd-interpltd-interpltd
  5550 00002384 88C3                    	mov	bl, al
  5551 00002386 2C80                    	sub	al, 80h
  5552 00002388 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5553 0000238C 66AB                    	stosw		; original sample (L)
  5554 0000238E 66AB                    	stosw		; original sample (R)
  5555 00002390 88D8                    	mov	al, bl
  5556 00002392 00D0                    	add	al, dl
  5557 00002394 D0D8                    	rcr	al, 1
  5558 00002396 88C7                    	mov	bh, al	; interpolated middle (temporary)
  5559 00002398 00D8                    	add	al, bl  ; [previous_val]
  5560 0000239A D0D8                    	rcr	al, 1 	
  5561 0000239C 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  5562 0000239E 00D8                    	add	al, bl
  5563 000023A0 D0D8                    	rcr	al, 1
  5564 000023A2 2C80                    	sub	al, 80h
  5565 000023A4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5566 000023A8 66AB                    	stosw		; interpolated sample 1 (L)
  5567 000023AA 66AB                    	stosw		; interpolated sample 1 (R)
  5568 000023AC 88F8                    	mov	al, bh
  5569 000023AE 00F0                    	add	al, dh
  5570 000023B0 D0D8                    	rcr	al, 1
  5571 000023B2 2C80                    	sub	al, 80h
  5572 000023B4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5573 000023B8 66AB                    	stosw		; interpolated sample 2 (L)
  5574 000023BA 66AB                    	stosw		; interpolated sample 2 (R)
  5575 000023BC 88F8                    	mov	al, bh
  5576 000023BE 00D0                    	add	al, dl	; [next_val]
  5577 000023C0 D0D8                    	rcr	al, 1
  5578 000023C2 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  5579 000023C4 00F8                    	add	al, bh
  5580 000023C6 D0D8                    	rcr	al, 1
  5581 000023C8 2C80                    	sub	al, 80h
  5582 000023CA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5583 000023CE 66AB                    	stosw		; interpolated sample 3 (L)
  5584 000023D0 66AB                    	stosw		; interpolated sample 3 (R)
  5585 000023D2 88F0                    	mov	al, dh
  5586 000023D4 00D0                    	add	al, dl
  5587 000023D6 D0D8                    	rcr	al, 1
  5588 000023D8 2C80                    	sub	al, 80h
  5589 000023DA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5590 000023DE 66AB                    	stosw		; interpolated sample 4 (L)
  5591 000023E0 66AB                    	stosw		; interpolated sample 4 (R)
  5592 000023E2 C3                      	retn
  5593                                  
  5594                                  interpolating_5_8bit_stereo:
  5595                                  	; 17/11/2023
  5596                                  	; al = [previous_val_l]
  5597                                  	; ah = [previous_val_r]
  5598                                  	; dl = [next_val_l]
  5599                                  	; dh = [next_val_r]
  5600                                  	; original-interpltd-interpltd-interpltd-interpltd
  5601 000023E3 89C3                    	mov	ebx, eax
  5602 000023E5 2C80                    	sub	al, 80h
  5603 000023E7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5604 000023EB 66AB                    	stosw		; original sample (L)
  5605 000023ED 88F8                    	mov	al, bh
  5606 000023EF 2C80                    	sub	al, 80h
  5607 000023F1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5608 000023F5 66AB                    	stosw		; original sample (R)
  5609 000023F7 52                      	push	edx ; *
  5610 000023F8 88D8                    	mov	al, bl
  5611 000023FA 00D0                    	add	al, dl	; [next_val_l]
  5612 000023FC D0D8                    	rcr	al, 1
  5613 000023FE 50                      	push	eax ; **	; al = interpolated middle (L) (temporary)
  5614 000023FF 00D8                    	add	al, bl	; [previous_val_l]
  5615 00002401 D0D8                    	rcr	al, 1
  5616 00002403 86D8                    	xchg	al, bl
  5617 00002405 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  5618 00002407 D0D8                    	rcr	al, 1
  5619 00002409 2C80                    	sub	al, 80h
  5620 0000240B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5621 0000240F 66AB                    	stosw		; interpolated sample 1 (L)
  5622 00002411 88F8                    	mov	al, bh
  5623 00002413 00F0                    	add	al, dh	; [next_val_r]
  5624 00002415 D0D8                    	rcr	al, 1
  5625 00002417 50                      	push	eax ; *** ; al = interpolated middle (R) (temporary)
  5626 00002418 00F8                    	add	al, bh	; [previous_val_r]
  5627 0000241A D0D8                    	rcr	al, 1
  5628 0000241C 86F8                    	xchg	al, bh
  5629 0000241E 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  5630 00002420 D0D8                    	rcr	al, 1
  5631 00002422 2C80                    	sub	al, 80h
  5632 00002424 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5633 00002428 66AB                    	stosw		; interpolated sample 1 (R)
  5634 0000242A 5A                      	pop	edx ; ***
  5635 0000242B 58                      	pop	eax ; **	; al = interpolated middle (L) (temporary)
  5636 0000242C 86D8                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  5637 0000242E 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  5638 00002430 D0D8                    	rcr	al, 1
  5639 00002432 2C80                    	sub	al, 80h
  5640 00002434 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5641 00002438 66AB                    	stosw		; interpolated sample 2 (L)
  5642 0000243A 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  5643 0000243C 86F8                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  5644 0000243E 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  5645 00002440 D0D8                    	rcr	al, 1
  5646 00002442 2C80                    	sub	al, 80h
  5647 00002444 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5648 00002448 66AB                    	stosw		; interpolated sample 2 (R)
  5649 0000244A 5A                      	pop	edx ; *
  5650 0000244B 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  5651 0000244D 00D0                    	add	al, dl	; [next_val_l]
  5652 0000244F D0D8                    	rcr	al, 1
  5653 00002451 86D8                    	xchg	al, bl	; al = interpolated middle (R) (temporary)
  5654 00002453 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp)
  5655 00002455 D0D8                    	rcr	al, 1
  5656 00002457 2C80                    	sub	al, 80h
  5657 00002459 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5658 0000245D 66AB                    	stosw		; interpolated sample 3 (L)
  5659 0000245F 88F8                    	mov	al, bh	
  5660 00002461 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  5661 00002463 D0D8                    	rcr	al, 1
  5662 00002465 86F8                    	xchg	al, bh	; al = interpolated middle (R)
  5663 00002467 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  5664 00002469 D0D8                    	rcr	al, 1
  5665 0000246B 2C80                    	sub	al, 80h
  5666 0000246D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5667 00002471 66AB                    	stosw		; interpolated sample 3 (R)
  5668 00002473 88D8                    	mov	al, bl
  5669 00002475 00D0                    	add	al, dl	; [next_val_l]
  5670 00002477 D0D8                    	rcr	al, 1
  5671 00002479 2C80                    	sub	al, 80h
  5672 0000247B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5673 0000247F 66AB                    	stosw		; interpolated sample 4 (L)
  5674 00002481 88F8                    	mov	al, bh
  5675 00002483 00F0                    	add	al, dh	; [next_val_r]
  5676 00002485 D0D8                    	rcr	al, 1
  5677 00002487 2C80                    	sub	al, 80h
  5678 00002489 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5679 0000248D 66AB                    	stosw		; interpolated sample 4 (R)
  5680 0000248F C3                      	retn
  5681                                  
  5682                                  interpolating_4_8bit_mono:
  5683                                  	; 17/11/2023
  5684                                  	; al = [previous_val]
  5685                                  	; dl = [next_val]
  5686                                  	; original-interpolated-interpolated-interpolated
  5687 00002490 88C3                    	mov	bl, al
  5688 00002492 2C80                    	sub	al, 80h
  5689 00002494 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5690 00002498 66AB                    	stosw		; original sample (L)
  5691 0000249A 66AB                    	stosw		; original sample (R)
  5692 0000249C 88D8                    	mov	al, bl
  5693 0000249E 00D0                    	add	al, dl	
  5694 000024A0 D0D8                    	rcr	al, 1
  5695 000024A2 86D8                    	xchg	al, bl  ; al = [previous_val]
  5696 000024A4 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  5697 000024A6 D0D8                    	rcr	al, 1 	
  5698 000024A8 2C80                    	sub	al, 80h
  5699 000024AA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5700 000024AE 66AB                    	stosw		; interpolated sample 1 (L)
  5701 000024B0 66AB                    	stosw		; interpolated sample 1 (R)
  5702 000024B2 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  5703 000024B4 2C80                    	sub	al, 80h
  5704 000024B6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5705 000024BA 66AB                    	stosw		; interpolated sample 2 (L)
  5706 000024BC 66AB                    	stosw		; interpolated sample 2 (R)
  5707 000024BE 88D8                    	mov	al, bl
  5708 000024C0 00D0                    	add	al, dl	; [next_val]
  5709 000024C2 D0D8                    	rcr	al, 1
  5710 000024C4 2C80                    	sub	al, 80h
  5711 000024C6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5712 000024CA 66AB                    	stosw		; interpolated sample 3 (L)
  5713 000024CC 66AB                    	stosw		; interpolated sample 3 (R)
  5714 000024CE C3                      	retn
  5715                                  
  5716                                  interpolating_4_8bit_stereo:
  5717                                  	; 17/11/2023
  5718                                  	; al = [previous_val_l]
  5719                                  	; ah = [previous_val_r]
  5720                                  	; dl = [next_val_l]
  5721                                  	; dh = [next_val_r]	
  5722                                  	; original-interpolated-interpolated-interpolated
  5723 000024CF 89C3                    	mov	ebx, eax
  5724 000024D1 2C80                    	sub	al, 80h
  5725 000024D3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5726 000024D7 66AB                    	stosw		; original sample (L)
  5727 000024D9 88F8                    	mov	al, bh
  5728 000024DB 2C80                    	sub	al, 80h
  5729 000024DD 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5730 000024E1 66AB                    	stosw		; original sample (R)
  5731 000024E3 88D8                    	mov	al, bl
  5732 000024E5 00D0                    	add	al, dl	; [next_val_l]
  5733 000024E7 D0D8                    	rcr	al, 1
  5734 000024E9 86D8                    	xchg	al, bl	; al = [previous_val_l]
  5735 000024EB 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  5736 000024ED D0D8                    	rcr	al, 1
  5737 000024EF 2C80                    	sub	al, 80h
  5738 000024F1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5739 000024F5 66AB                    	stosw		; interpolated sample 1 (L)
  5740 000024F7 88F8                    	mov	al, bh
  5741 000024F9 00F0                    	add	al, dh	; [next_val_r]
  5742 000024FB D0D8                    	rcr	al, 1
  5743 000024FD 86F8                    	xchg	al, bh	; al = [previous_val_h]
  5744 000024FF 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  5745 00002501 D0D8                    	rcr	al, 1
  5746 00002503 2C80                    	sub	al, 80h
  5747 00002505 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5748 00002509 66AB                    	stosw		; interpolated sample 1 (R)
  5749 0000250B 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  5750 0000250D 2C80                    	sub	al, 80h
  5751 0000250F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5752 00002513 66AB                    	stosw		; interpolated sample 2 (L)
  5753 00002515 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  5754 00002517 2C80                    	sub	al, 80h
  5755 00002519 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5756 0000251D 66AB                    	stosw		; interpolated sample 2 (L)
  5757 0000251F 88D8                    	mov	al, bl
  5758 00002521 00D0                    	add	al, dl	; [next_val_l]
  5759 00002523 D0D8                    	rcr	al, 1
  5760 00002525 2C80                    	sub	al, 80h
  5761 00002527 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5762 0000252B 66AB                    	stosw		; interpolated sample 3 (L)
  5763 0000252D 88F8                    	mov	al, bh
  5764 0000252F 00F0                    	add	al, dh	; [next_val_r]
  5765 00002531 D0D8                    	rcr	al, 1
  5766 00002533 2C80                    	sub	al, 80h
  5767 00002535 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5768 00002539 66AB                    	stosw		; interpolated sample 3 (R)
  5769 0000253B C3                      	retn
  5770                                  
  5771                                  interpolating_5_16bit_mono:
  5772                                  	; 18/11/2023
  5773                                  	; ax = [previous_val]
  5774                                  	; dx = [next_val]
  5775                                  	; original-interpltd-interpltd-interpltd-interpltd
  5776 0000253C 66AB                    	stosw		; original sample (L)
  5777 0000253E 66AB                    	stosw		; original sample (R)
  5778 00002540 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5779 00002543 89C3                    	mov	ebx, eax ; [previous_val]
  5780 00002545 80C680                  	add	dh, 80h
  5781 00002548 6601D0                  	add	ax, dx
  5782 0000254B 66D1D8                  	rcr	ax, 1
  5783 0000254E 50                      	push	eax ; *	; interpolated middle (temporary)
  5784 0000254F 6601D8                  	add	ax, bx	; interpolated middle + [previous_val] 
  5785 00002552 66D1D8                  	rcr	ax, 1
  5786 00002555 50                      	push	eax ; **	; interpolated 1st quarter (temporary)
  5787 00002556 6601D8                  	add	ax, bx	; 1st quarter + [previous_val]
  5788 00002559 66D1D8                  	rcr	ax, 1	
  5789 0000255C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5790 0000255F 66AB                    	stosw 		; interpolated sample 1 (L)
  5791 00002561 66AB                    	stosw		; interpolated sample 1 (R)
  5792 00002563 58                      	pop	eax ; **
  5793 00002564 5B                      	pop	ebx ; *
  5794 00002565 6601D8                  	add	ax, bx	; 1st quarter + middle
  5795 00002568 66D1D8                  	rcr	ax, 1	; / 2
  5796 0000256B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  5797 0000256E 66AB                    	stosw		; interpolated sample 2 (L)
  5798 00002570 66AB                    	stosw		; interpolated sample 2 (R)
  5799 00002572 89D8                    	mov	eax, ebx
  5800 00002574 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  5801 00002577 66D1D8                  	rcr	ax, 1
  5802 0000257A 50                      	push	eax ; *	; interpolated 3rd quarter (temporary)
  5803 0000257B 6601D8                  	add	ax, bx	; + interpolated middle
  5804 0000257E 66D1D8                  	rcr	ax, 1
  5805 00002581 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5806 00002584 66AB                    	stosw		; interpolated sample 3 (L)
  5807 00002586 66AB                    	stosw		; interpolated sample 3 (R)
  5808 00002588 58                      	pop	eax ; *	
  5809 00002589 6601D0                  	add	ax, dx	; 3rd quarter + [next_val]
  5810 0000258C 66D1D8                  	rcr	ax, 1	; / 2
  5811 0000258F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5812 00002592 66AB                    	stosw		; interpolated sample 4 (L)
  5813 00002594 66AB                    	stosw		; interpolated sample 4 (R)
  5814 00002596 C3                      	retn
  5815                                  
  5816                                  interpolating_5_16bit_stereo:
  5817                                  	; 18/11/2023
  5818                                  	; bx = [previous_val_l]
  5819                                  	; ax = [previous_val_r]
  5820                                  	; [next_val_l]
  5821                                  	; [next_val_r]
  5822                                  	; original-interpltd-interpltd-interpltd-interpltd
  5823 00002597 51                      	push	ecx ; !
  5824 00002598 93                      	xchg	eax, ebx
  5825 00002599 66AB                    	stosw		; original sample (L)
  5826 0000259B 93                      	xchg	eax, ebx
  5827 0000259C 66AB                    	stosw		; original sample (R)
  5828 0000259E 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5829 000025A1 50                      	push	eax ; *	; [previous_val_r]
  5830 000025A2 80C780                  	add	bh, 80h
  5831 000025A5 8005[21270000]80        	add	byte [next_val_l+1], 80h
  5832 000025AC 66A1[20270000]          	mov	ax, [next_val_l]
  5833 000025B2 6601D8                  	add	ax, bx	; [previous_val_l]
  5834 000025B5 66D1D8                  	rcr	ax, 1
  5835 000025B8 89C1                    	mov	ecx, eax ; interpolated middle (L)
  5836 000025BA 6601D8                  	add	ax, bx	
  5837 000025BD 66D1D8                  	rcr	ax, 1
  5838 000025C0 89C2                    	mov	edx, eax ; interpolated 1st quarter (L)
  5839 000025C2 6601D8                  	add	ax, bx	; [previous_val_l]
  5840 000025C5 66D1D8                  	rcr	ax, 1
  5841 000025C8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5842 000025CB 66AB                    	stosw 		; interpolated sample 1 (L)
  5843 000025CD 89C8                    	mov	eax, ecx
  5844 000025CF 6601D0                  	add	ax, dx	; middle (L) + 1st quarter (L)
  5845 000025D2 66D1D8                  	rcr	ax, 1	; / 2
  5846 000025D5 89C3                    	mov	ebx, eax  ; interpolated sample 2 (L)
  5847 000025D7 5A                      	pop	edx ; *	; [previous_val_r]
  5848 000025D8 89D0                    	mov	eax, edx
  5849 000025DA 8005[23270000]80        	add	byte [next_val_r+1], 80h
  5850 000025E1 660305[22270000]        	add	ax, [next_val_r]
  5851 000025E8 66D1D8                  	rcr	ax, 1
  5852 000025EB 50                      	push	eax ; *	; interpolated middle (R)
  5853 000025EC 6601D0                  	add	ax, dx
  5854 000025EF 66D1D8                  	rcr	ax, 1
  5855 000025F2 50                      	push	eax ; ** ; interpolated 1st quarter (R)
  5856 000025F3 6601D0                  	add	ax, dx	; [previous_val_r]
  5857 000025F6 66D1D8                  	rcr	ax, 1
  5858 000025F9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5859 000025FC 66AB                    	stosw 		; interpolated sample 1 (R)
  5860 000025FE 89D8                    	mov	eax, ebx
  5861 00002600 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5862 00002603 66AB                    	stosw 		; interpolated sample 2 (L)
  5863 00002605 58                      	pop	eax ; **
  5864 00002606 5A                      	pop	edx ; *
  5865 00002607 6601D0                  	add	ax, dx	; 1st quarter (R) + middle (R)
  5866 0000260A 66D1D8                  	rcr	ax, 1	; / 2
  5867 0000260D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5868 00002610 66AB                    	stosw 		; interpolated sample 2 (R)
  5869 00002612 89C8                    	mov	eax, ecx
  5870 00002614 660305[20270000]        	add	ax, [next_val_l]
  5871 0000261B 66D1D8                  	rcr	ax, 1
  5872 0000261E 50                      	push	eax ; * ; interpolated 3rd quarter (L)
  5873 0000261F 6601C8                  	add	ax, cx	; interpolated middle (L)
  5874 00002622 66D1D8                  	rcr	ax, 1
  5875 00002625 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5876 00002628 66AB                    	stosw 		; interpolated sample 3 (L)
  5877 0000262A 89D0                    	mov	eax, edx
  5878 0000262C 660305[22270000]        	add	ax, [next_val_r]
  5879 00002633 66D1D8                  	rcr	ax, 1
  5880 00002636 50                      	push	eax ; ** ; interpolated 3rd quarter (R)
  5881 00002637 6601D0                  	add	ax, dx	; interpolated middle (R)
  5882 0000263A 66D1D8                  	rcr	ax, 1
  5883 0000263D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5884 00002640 66AB                    	stosw 		; interpolated sample 3 (R)
  5885 00002642 5B                      	pop	ebx ; **
  5886 00002643 58                      	pop	eax ; *
  5887 00002644 660305[20270000]        	add	ax, [next_val_l]
  5888 0000264B 66D1D8                  	rcr	ax, 1
  5889 0000264E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5890 00002651 66AB                    	stosw 		; interpolated sample 4 (L)
  5891 00002653 89D8                    	mov	eax, ebx
  5892 00002655 660305[22270000]        	add	ax, [next_val_r]
  5893 0000265C 66D1D8                  	rcr	ax, 1
  5894 0000265F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5895 00002662 66AB                    	stosw 		; interpolated sample 4 (R)
  5896 00002664 59                      	pop	ecx ; !
  5897 00002665 C3                      	retn
  5898                                  
  5899                                  interpolating_4_16bit_mono:
  5900                                  	; 18/11/2023
  5901                                  	; ax = [previous_val]
  5902                                  	; dx = [next_val]
  5903                                  	; original-interpolated
  5904                                  
  5905 00002666 66AB                    	stosw		; original sample (L)
  5906 00002668 66AB                    	stosw		; original sample (R)
  5907 0000266A 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5908 0000266D 89C3                    	mov	ebx, eax ; [previous_val]
  5909 0000266F 80C680                  	add	dh, 80h
  5910 00002672 6601D0                  	add	ax, dx	; [previous_val] + [next_val]
  5911 00002675 66D1D8                  	rcr	ax, 1
  5912 00002678 93                      	xchg	eax, ebx
  5913 00002679 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  5914 0000267C 66D1D8                  	rcr	ax, 1
  5915 0000267F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5916 00002682 66AB                    	stosw 		; interpolated sample 1 (L)
  5917 00002684 66AB                    	stosw		; interpolated sample 1 (R)
  5918 00002686 89D8                    	mov	eax, ebx ; interpolated middle
  5919 00002688 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5920 0000268B 66AB                    	stosw 		; interpolated sample 2 (L)
  5921 0000268D 66AB                    	stosw		; interpolated sample 2 (R)
  5922 0000268F 89D8                    	mov	eax, ebx
  5923 00002691 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  5924 00002694 66D1D8                  	rcr	ax, 1
  5925 00002697 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5926 0000269A 66AB                    	stosw		; interpolated sample 3 (L)
  5927 0000269C 66AB                    	stosw		; interpolated sample 3 (R)
  5928 0000269E C3                      	retn
  5929                                  
  5930                                  interpolating_4_16bit_stereo:
  5931                                  	; 18/11/2023
  5932                                  	; bx = [previous_val_l]
  5933                                  	; ax = [previous_val_r]
  5934                                  	; [next_val_l]
  5935                                  	; [next_val_r]
  5936                                  	; original-interpolated-interpolated-interpolated
  5937 0000269F 93                      	xchg	eax, ebx
  5938 000026A0 66AB                    	stosw		; original sample (L)
  5939 000026A2 93                      	xchg	eax, ebx
  5940 000026A3 66AB                    	stosw		; original sample (R)
  5941 000026A5 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5942 000026A8 89C2                    	mov	edx, eax ; [previous_val_r]
  5943 000026AA 80C780                  	add	bh, 80h
  5944 000026AD 8005[21270000]80        	add	byte [next_val_l+1], 80h
  5945 000026B4 66A1[20270000]          	mov	ax, [next_val_l]
  5946 000026BA 6601D8                  	add	ax, bx	; [previous_val_l]
  5947 000026BD 66D1D8                  	rcr	ax, 1
  5948 000026C0 93                      	xchg	eax, ebx
  5949 000026C1 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  5950 000026C4 66D1D8                  	rcr	ax, 1
  5951 000026C7 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5952 000026CA 66AB                    	stosw 		; interpolated sample 1 (L)
  5953 000026CC 8005[23270000]80        	add	byte [next_val_r+1], 80h
  5954 000026D3 89D0                    	mov	eax, edx ; [previous_val_r]
  5955 000026D5 660305[22270000]        	add	ax, [next_val_r]
  5956 000026DC 66D1D8                  	rcr	ax, 1
  5957 000026DF 92                      	xchg	eax, edx
  5958 000026E0 6601D0                  	add	ax, dx	; dx = interpolated middle (R)
  5959 000026E3 66D1D8                  	rcr	ax, 1
  5960 000026E6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5961 000026E9 66AB                    	stosw 		; interpolated sample 1 (R)
  5962 000026EB 89D8                    	mov	eax, ebx
  5963 000026ED 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5964 000026F0 66AB                    	stosw 		; interpolated sample 2 (L)
  5965 000026F2 89D0                    	mov	eax, edx
  5966 000026F4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5967 000026F7 66AB                    	stosw 		; interpolated sample 2 (R)
  5968 000026F9 89D8                    	mov	eax, ebx
  5969 000026FB 660305[20270000]        	add	ax, [next_val_l]
  5970 00002702 66D1D8                  	rcr	ax, 1
  5971 00002705 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5972 00002708 66AB                    	stosw 		; interpolated sample 3 (L)
  5973 0000270A 89D0                    	mov	eax, edx
  5974 0000270C 660305[22270000]        	add	ax, [next_val_r]
  5975 00002713 66D1D8                  	rcr	ax, 1
  5976 00002716 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5977 00002719 66AB                    	stosw 		; interpolated sample 3 (R)
  5978 0000271B C3                      	retn
  5979                                  
  5980                                  ; 13/11/2023
  5981                                  previous_val:
  5982 0000271C 0000                    previous_val_l: dw 0
  5983 0000271E 0000                    previous_val_r: dw 0
  5984                                  next_val:
  5985 00002720 0000                    next_val_l: dw 0
  5986 00002722 0000                    next_val_r: dw 0
  5987                                  
  5988                                  ; 16/11/2023
  5989 00002724 00                      faz:	db 0
  5990                                  
  5991                                  ; --------------------------------------------------------
  5992                                  ; 14/11/2024 - Erdogan Tan
  5993                                  ; --------------------------------------------------------
  5994                                  
  5995                                  	; 07/12/2024
  5996                                  	; 01/12/2024 (32bit registers)
  5997                                  	; 29/11/2024
  5998                                  checkUpdateEvents:
  5999 00002725 E8B9010000              	call	check4keyboardstop
  6000 0000272A 7272                    	jc	short c4ue_ok
  6001                                  
  6002                                  	; 18/11/2024
  6003 0000272C 50                      	push	eax ; *
  6004 0000272D 09C0                    	or	eax, eax
  6005 0000272F 0F84D1000000            	jz	c4ue_cpt
  6006                                  
  6007                                  	; 18/11/2024
  6008 00002735 3C20                    	cmp	al, 20h ; SPACE (spacebar) ; pause/play
  6009 00002737 7543                    	jne	short c4ue_chk_s
  6010 00002739 803D[DC370000]00        	cmp	byte [stopped], 0
  6011 00002740 7714                    	ja	short c4ue_chk_ps
  6012                                  	; pause
  6013 00002742 E827E5FFFF              	call	ac97_pause
  6014                                  	; 21/11/2024
  6015 00002747 A0[DD370000]            	mov	al, [tLO]
  6016 0000274C A2[DE370000]            	mov	byte [tLP], al
  6017 00002751 E9B0000000              	jmp	c4ue_cpt
  6018                                  c4ue_chk_ps:
  6019 00002756 803D[DC370000]01        	cmp	byte [stopped], 1
  6020 0000275D 770A                    	ja	short c4ue_replay
  6021                                  	; continue to play (after a pause)
  6022 0000275F E813E5FFFF              	call	ac97_play 
  6023 00002764 E99D000000              	jmp	c4ue_cpt
  6024                                  c4ue_replay:
  6025                                  	; 19/11/2024
  6026 00002769 58                      	pop	eax ; *
  6027 0000276A 58                      	pop	eax ; return address
  6028                                  	; 07/02/2024
  6029                                  	;mov	al, [volume]
  6030                                  	;call	SetmasterVolume
  6031 0000276B C605[DC370000]00        	mov	byte [stopped], 0
  6032 00002772 E87C040000              	call	move_to_beginning
  6033                                  	;jmp	PlayWav
  6034                                  	; 07/12/2024
  6035 00002777 E96EDEFFFF              	jmp	RePlayWav
  6036                                  
  6037                                  c4ue_chk_s:
  6038 0000277C 3C53                    	cmp	al, 'S'	; stop
  6039 0000277E 751F                    	jne	short c4ue_chk_fb
  6040 00002780 803D[DC370000]00        	cmp	byte [stopped], 0
  6041 00002787 777D                    	ja	c4ue_cpt ; Already stopped/paused
  6042 00002789 E8C7E4FFFF              	call	ac97_stop
  6043                                  	; 19/11/2024
  6044 0000278E C605[DD370000]00        	mov	byte [tLO], 0
  6045                                  	; 21/11/2024
  6046 00002795 C605[DE370000]30        	mov	byte [tLP], '0'
  6047 0000279C EB68                    	jmp	c4ue_cpt
  6048                                  
  6049                                  	; 01/12/2024
  6050                                  	; 18/11/2024
  6051                                  c4ue_ok:
  6052 0000279E C3                      	retn
  6053                                  
  6054                                  c4ue_chk_fb:
  6055                                  	; 17/11/2024
  6056 0000279F 3C46                    	cmp	al, 'F'
  6057 000027A1 7507                    	jne	short c4ue_chk_b
  6058 000027A3 E823040000              	call 	Player_ProcessKey_Forwards
  6059 000027A8 EB5C                    	jmp	c4ue_cpt
  6060                                  
  6061                                  c4ue_chk_b:
  6062 000027AA 3C42                    	cmp	al, 'B'
  6063                                  	;;jne	short c4ue_cpt
  6064                                  	; 19/11/2024
  6065                                  	;jne	short c4ue_chk_h
  6066                                  	; 25/12/2024
  6067                                  	; 29/11/2024
  6068 000027AC 7507                    	jne	short c4ue_chk_n
  6069 000027AE E814040000              	call 	Player_ProcessKey_Backwards
  6070 000027B3 EB51                    	jmp	short c4ue_cpt
  6071                                  
  6072                                  	;;;
  6073                                  	; 25/12/2024
  6074                                  	; 29/11/2024
  6075                                  c4ue_chk_n:
  6076 000027B5 3C4E                    	cmp	al, 'N'
  6077 000027B7 7404                    	je	short c4ue_nps
  6078                                  c4ue_chk_p:
  6079 000027B9 3C50                    	cmp	al, 'P'
  6080 000027BB 7509                    	jne	short c4ue_chk_h
  6081                                  c4ue_nps:
  6082 000027BD C605[DC370000]03        	mov	byte [stopped], 3
  6083 000027C4 EB40                    	jmp	short c4ue_cpt
  6084                                  	;;;
  6085                                  
  6086                                  c4ue_chk_h:
  6087                                  	; 19/11/2024
  6088 000027C6 3C48                    	cmp	al, 'H'
  6089 000027C8 750E                    	jne	short c4ue_chk_cr
  6090 000027CA C605[DF370000]00        	mov	byte [wpoints], 0
  6091 000027D1 E82FE6FFFF              	call 	write_ac97_pci_dev_info
  6092                                  	; 30/12/2024
  6093 000027D6 EB2E                    	jmp	short c4ue_cpt
  6094                                  c4ue_chk_cr:
  6095                                  	;;;
  6096                                  	; 24/12/2024 (wave lighting points option)
  6097                                  	;mov	ah, [wpoints]
  6098                                  	; 30/12/2024
  6099 000027D8 31DB                    	xor	ebx, ebx
  6100 000027DA 8A1D[DF370000]          	mov	bl, [wpoints]
  6101 000027E0 3C47                    	cmp	al, 'G'
  6102 000027E2 7406                    	je	short c4ue_g
  6103                                  	; 19/11/2024
  6104 000027E4 3C0D                    	cmp	al, 0Dh ; ENTER/CR key
  6105 000027E6 751E                    	jne	short c4ue_cpt
  6106                                  	; 23/11/2024
  6107                                  	;xor	ebx, ebx
  6108                                  	; 30/12/2024
  6109                                  	;mov	bl, ah ; 24/12/2024
  6110 000027E8 FEC3                    	inc	bl
  6111                                  c4ue_g:	; 30/12/2024
  6112 000027EA 80E307                  	and	bl, 07h
  6113 000027ED 7501                    	jnz	short c4ue_sc
  6114 000027EF 43                      	inc	ebx
  6115                                  c4ue_sc:
  6116 000027F0 881D[DF370000]          	mov	[wpoints], bl
  6117                                  	; 30/12/2024
  6118 000027F6 8A83[B9320000]          	mov	al, [ebx+colors-1] ; 1 to 7
  6119                                  	; 24/12/2024
  6120 000027FC A2[C1320000]            	mov	[ccolor], al
  6121                                  	; 30/12/2024
  6122 00002801 E81C040000              	call	clear_window
  6123                                  	;;;
  6124                                  c4ue_cpt:
  6125                                  	; 24/12/2024
  6126                                  	; 18/11/2024
  6127 00002806 59                      	pop	ecx ; *
  6128                                  	;;;
  6129                                  	; 29/12/2024
  6130                                  	; 24/12/2024 (skip wave lighting if data is not loaded yet)
  6131                                  	;cmp	byte [SRB], 0
  6132                                  	;ja	short c4ue_vb_ok
  6133                                  	;;;
  6134                                  	; 01/12/2024 (TRDOS 386)
  6135                                  	sys	_time, 4 ; get timer ticks (18.2 ticks/second),
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00002807 BB04000000          <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97                              <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000280C B80D000000          <1>  mov eax, %1
   104                              <1> 
   105 00002811 CD40                <1>  int 40h
  6136                                  	; 24/12/2024
  6137                                  	; 18/11/2024
  6138                                  	;pop	ecx ; *
  6139                                  	; 01/12/2024
  6140 00002813 3B05[A8380000]          	cmp	eax, [timerticks]
  6141                                  	;je	short c4ue_ok
  6142                                  	; 18/11/2024
  6143 00002819 7408                    	je	short c4ue_skip_utt
  6144                                  c4ue_utt:	
  6145                                  	; 01/12/2024
  6146 0000281B A3[A8380000]            	mov	[timerticks], eax
  6147 00002820 EB05                    	jmp	short c4ue_cpt_@
  6148                                  
  6149                                  	; 30/12/2024
  6150                                  c4ue_vb_ok:
  6151 00002822 C3                      	retn
  6152                                  
  6153                                  c4ue_skip_utt:
  6154                                  	; 18/11/2024
  6155 00002823 21C9                    	and	ecx, ecx
  6156 00002825 74FB                    	jz	short c4ue_vb_ok
  6157                                  c4ue_cpt_@:
  6158                                  	; 18/11/2024
  6159 00002827 803D[DC370000]00        	cmp	byte [stopped], 0
  6160 0000282E 77F2                    	ja	short c4ue_vb_ok
  6161                                  	
  6162 00002830 E8E0010000              	call	CalcProgressTime
  6163                                  
  6164                                  	;cmp	ax, [ProgressTime]
  6165                                  	; 01/12/2024
  6166 00002835 3B05[9C380000]          	cmp	eax, [ProgressTime]
  6167                                  	;je	short c4ue_vb_ok
  6168                                  			; same second, no need to update
  6169                                  	; 23/11/2024
  6170 0000283B 7405                    	je	short c4ue_uvb
  6171                                  
  6172                                  	;call	UpdateProgressTime
  6173                                  	;call	UpdateProgressBar@
  6174 0000283D E8F9020000              	call	UpdateProgressBar
  6175                                  
  6176                                  	; 23/11/2024
  6177                                  c4ue_uvb:
  6178 00002842 803D[DF370000]00        	cmp	byte [wpoints], 0
  6179 00002849 76D7                    	jna	short c4ue_vb_ok
  6180                                  
  6181                                  	; 30/12/2024
  6182                                  	;call	UpdateWavePoints
  6183                                  	;retn
  6184                                  
  6185                                  ; --------------------------------------------------------
  6186                                  ; 27/12/2024 - Erdogan Tan
  6187                                  ; --------------------------------------------------------
  6188                                  
  6189                                  	; 30/12/2024 (cgaplay.s)
  6190                                  	;  * 320*200 pixels, 256 colors
  6191                                  	;  * 64 volume levels
  6192                                  	; 29/12/2024
  6193                                  	; 27/12/2024 (DMA Buffer Tracking)
  6194                                  	; 26/12/2024
  6195                                  	; 24/12/2024
  6196                                  UpdateWavePoints:
  6197 0000284B BE[DC320000]            	mov	esi, prev_points
  6198 00002850 833E00                  	cmp	dword [esi], 0
  6199 00002853 740B                    	jz	short lights_off_ok
  6200                                  	;mov	ecx, 640
  6201                                  	; 30/12/2024
  6202 00002855 B940010000              	mov	ecx, 320
  6203                                  light_off:
  6204 0000285A AD                      	lodsd
  6205                                  	; eax = wave point (lighting point) address
  6206 0000285B C60000                  	mov	byte [eax], 0 ; black point (light off)
  6207 0000285E E2FA                    	loop	light_off	
  6208                                  
  6209                                  lights_off_ok:
  6210                                  	; 29/12/2024
  6211 00002860 803D[DD370000]32        	cmp	byte [tLO],'2'
  6212 00002867 7507                    	jne	short lights_on_buff_1
  6213                                  lights_on_buff_2:
  6214 00002869 BA[00500100]            	mov	edx, WAVBUFFER_2
  6215 0000286E EB05                    	jmp	short lights_on
  6216                                  lights_on_buff_1:
  6217 00002870 BA[00500000]            	mov	edx, WAVBUFFER_1
  6218                                  lights_on:
  6219 00002875 3915[E4370000]          	cmp	[pbuf_s], edx
  6220 0000287B 7520                    	jne	short lights_on_2
  6221 0000287D 8B1D[C4320000]          	mov	ebx, [wpoints_dif]
  6222 00002883 8B35[E0370000]          	mov	esi, [pbuf_o]
  6223 00002889 8B0D[94380000]          	mov	ecx, [buffersize] ; bytes
  6224 0000288F 29D9                    	sub	ecx, ebx ; sub ecx, [wpoints_dif]
  6225 00002891 01DE                    	add	esi, ebx
  6226 00002893 7204                    	jc	short lights_on_1
  6227 00002895 39CE                    	cmp	esi, ecx
  6228 00002897 760C                    	jna	short lights_on_3
  6229                                  lights_on_1:
  6230 00002899 89CE                    	mov	esi, ecx
  6231 0000289B EB08                    	jmp	short lights_on_3
  6232                                  
  6233                                  lights_on_2:
  6234                                  	; 29/12/2024
  6235 0000289D 8915[E4370000]          	mov	[pbuf_s], edx
  6236 000028A3 31F6                    	xor	esi, esi ; 0
  6237                                  lights_on_3:
  6238 000028A5 8935[E0370000]          	mov	[pbuf_o], esi
  6239                                  	; 29/12/2024
  6240                                  	;add	esi, [pbuf_s]
  6241 000028AB 01D6                    	add	esi, edx
  6242                                  	;mov	ecx, 640
  6243                                  	; 30/12/2024
  6244 000028AD B940010000              	mov	ecx, 320
  6245 000028B2 89CD                    	mov	ebp, ecx
  6246                                  	; 26/12/2024
  6247 000028B4 BF[DC320000]            	mov	edi, prev_points
  6248 000028B9 8B1D[C8320000]          	mov	ebx, [graphstart] ; start (top) line
  6249                                  lights_on_4:
  6250 000028BF 31C0                    	xor	eax, eax ; 0
  6251 000028C1 66AD                    	lodsw	; left
  6252 000028C3 80C480                  	add	ah, 80h
  6253 000028C6 89C2                    	mov	edx, eax
  6254 000028C8 66AD                    	lodsw	; right
  6255                                  	;add	ax, dx
  6256 000028CA 80C480                  	add	ah, 80h
  6257                                  	;;shr	eax, 9	; 128 volume levels
  6258                                  	; 01/01/2025
  6259 000028CD 01D0                    	add	eax, edx
  6260                                  	;;shr	eax, 10	; (L+R/2) & 128 volume levels
  6261                                  	;shr	eax, 9	; (L+R/2) & 256 volume levels
  6262                                  	; 30/12/2024
  6263 000028CF C1E80B                  	shr	eax, 11	; (L+R/2) & 64 volume levels
  6264                                  	; * 320 row  ; 30/12/2024
  6265 000028D2 F7E5                    	mul	ebp	; * 640 (row) 
  6266 000028D4 01D8                    	add	eax, ebx ; + column
  6267 000028D6 8A15[C1320000]          	mov	dl, [ccolor]
  6268 000028DC 8810                    	mov	[eax], dl ; pixel (light on) color
  6269 000028DE AB                      	stosd		; save light on addr in prev_points
  6270 000028DF 43                      	inc	ebx
  6271 000028E0 E2DD                    	loop	lights_on_4
  6272 000028E2 C3                      	retn
  6273                                  
  6274                                  ; --------------------------------------------------------
  6275                                  ; 19/05/2024 - (playwav4.asm) ich_wav4.asm
  6276                                  ; --------------------------------------------------------
  6277                                  
  6278                                  	; 29/12/2024
  6279                                  	; 25/12/2024
  6280                                  	; 07/12/2024
  6281                                  	; 01/12/2024 (TRDOS 386)
  6282                                  	; 29/11/2024
  6283                                  check4keyboardstop:
  6284                                  	; 19/05/2024
  6285                                  	; 08/11/2023
  6286                                  	; 04/11/2023
  6287 000028E3 B401                    	mov	ah, 1
  6288                                  	;int	16h
  6289                                  	; 01/12/2024 (TRDOS 386 keyboard interrupt)
  6290 000028E5 CD32                    	int	32h
  6291                                  	;clc
  6292 000028E7 7433                    	jz	short _cksr
  6293                                  
  6294 000028E9 30E4                    	xor	ah, ah
  6295                                  	;int	16h
  6296                                  	; 01/12/2024 (TRDOS 386 keyboard interrupt)
  6297 000028EB CD32                    	int	32h
  6298                                  
  6299                                  	; 25/12/2024
  6300                                  	; 29/11/2024
  6301                                  	;mov	[command], al
  6302                                  
  6303                                  	;;;
  6304                                  	; 19/05/2024 (change PCM out volume)
  6305 000028ED 3C2B                    	cmp	al, '+'
  6306 000028EF 750D                    	jne	short p_1
  6307                                  	
  6308 000028F1 A0[46290000]            	mov	al, [volume]
  6309 000028F6 3C00                    	cmp	al, 0
  6310 000028F8 7624                    	jna	short p_3
  6311 000028FA FEC8                    	dec	al
  6312 000028FC EB0F                    	jmp	short p_2
  6313                                  p_1:
  6314 000028FE 3C2D                    	cmp	al, '-'
  6315 00002900 751D                    	jne	short p_4
  6316                                  
  6317 00002902 A0[46290000]            	mov	al, [volume]
  6318 00002907 3C1F                    	cmp	al, 31
  6319 00002909 7313                    	jnb	short p_3
  6320 0000290B FEC0                    	inc	al
  6321                                  p_2:
  6322 0000290D A2[46290000]            	mov	[volume], al
  6323                                  	; 29/12/2024
  6324                                  	; 14/11/2024
  6325 00002912 E887DEFFFF              	call	SetPCMOutVolume
  6326                                  	; 15/11/2024 (QEMU)
  6327                                  	; 07/12/2024
  6328                                  	;call	SetMasterVolume
  6329                                  	;call	UpdateVolume
  6330                                  	;;clc
  6331                                  	;retn
  6332 00002917 E99A010000              	jmp	UpdateVolume
  6333                                  	;mov	ah, al
  6334                                  	;mov    dx, [NAMBAR]
  6335                                    	;;add   dx, CODEC_MASTER_VOL_REG
  6336                                  	;add	dx, CODEC_PCM_OUT_REG
  6337                                  	;out    dx, ax
  6338                                  	;
  6339                                  	;call   delay1_4ms
  6340                                          ;call   delay1_4ms
  6341                                          ;call   delay1_4ms
  6342                                          ;call   delay1_4ms
  6343                                  _cksr:		; 19/05/2024
  6344                                  	; 18/12/2024
  6345 0000291C 31C0                    	xor	eax, eax
  6346                                  	;clc
  6347                                  p_3:
  6348 0000291E C3                      	retn
  6349                                  p_4:
  6350                                  	; 17/11/2024
  6351 0000291F 80FC01                  	cmp	ah, 01h  ; ESC
  6352 00002922 7419                        	je	short p_q
  6353                                  	;cmp	ax, 2E03h ; 21/12/2024 
  6354 00002924 3C03                    	cmp	al, 03h  ; CTRL+C
  6355 00002926 7415                    	je	short p_q
  6356                                  
  6357                                  	; 18/11/2024
  6358 00002928 3C20                    	cmp	al, 20h
  6359 0000292A 7419                    	je	short p_r
  6360                                  
  6361                                  	; 19/11/2024
  6362 0000292C 3C0D                    	cmp	al, 0Dh ; CR/ENTER
  6363 0000292E 7415                    	je	short p_r
  6364                                  
  6365 00002930 24DF                    	and	al, 0DFh
  6366                                  
  6367                                  	; 25/12/2024
  6368                                  	; 29/11/2024
  6369 00002932 A2[EA370000]            	mov	[command], al
  6370                                  
  6371                                  	;cmp	al, 'B'
  6372                                  	;je	short p_r
  6373                                  	;cmp	al, 'F'
  6374                                  	;je	short p_r
  6375                                  
  6376                                  	; 29/11/2024
  6377                                  	;cmp	al, 'N'
  6378                                  	;je	short p_r
  6379                                  	;cmp	al, 'P'
  6380                                  	;je	short p_r
  6381                                  
  6382 00002937 3C51                    	cmp	al, 'Q'
  6383                                  	;je	short p_q
  6384 00002939 7409                    	je	short p_quit ; 29/11/2024
  6385                                  
  6386 0000293B F8                      	clc
  6387 0000293C C3                      	retn
  6388                                  
  6389                                  	;;;
  6390                                  ;_cskr:	
  6391                                  p_q:
  6392                                  	; 27/12/2024
  6393 0000293D C605[EA370000]51        	mov	byte [command], 'Q'
  6394                                  p_quit:
  6395 00002944 F9                      	stc
  6396                                  p_r:
  6397 00002945 C3                      	retn
  6398                                  
  6399                                  ; 29/05/2024
  6400                                  ; 19/05/2024
  6401                                  volume: 
  6402                                  	;db	02h
  6403                                  ; 26/12/2024
  6404 00002946 03                      	db	03h
  6405                                  
  6406                                  ; --------------------------------------------------------
  6407                                  
  6408                                  	; 30/12/2024
  6409                                  	; simulate cursor position in VGA mode 13h
  6410                                  	; ! for 320*200, 256 colors (1 byte/pixel) !
  6411                                  setCursorPosition:
  6412                                  	; dh = Row
  6413                                  	; dl = Column
  6414                                  	
  6415 00002947 31C0                    	xor	eax, eax
  6416                                  	; row height is 8 pixels (8*8)
  6417 00002949 88F0                    	mov	al, dh
  6418 0000294B C1E003                  	shl	eax, 3
  6419 0000294E 6683C002                	add	ax, 2	; top margin
  6420 00002952 C1E010                  	shl	eax, 16
  6421 00002955 88D0                    	mov	al, dl	; * 8 ; character width = 8 pixels
  6422 00002957 66C1E003                	shl	ax, 3
  6423                                  			; hw = row, ax = column
  6424 0000295B A3[CC320000]            	mov	[screenpos], eax
  6425                                  	; 22/12/2024
  6426 00002960 31C0                    	xor	eax, eax
  6427 00002962 C3                      	retn
  6428                                  	
  6429                                  ; --------------------------------------------------------
  6430                                  ; 14/11/2024
  6431                                  ; (Ref: player.asm, out_cs.asm, Matan Alfasi, 2017)
  6432                                  
  6433                                  ;; NAME:	SetTotalTime
  6434                                  ;; DESCRIPTION: Calculates the total time in seconds in file
  6435                                  ;; INPUT:	DATA_SubchunkSize, WAVE_SampleRate, WAVE_BlockAlign
  6436                                  ;; OUTPUT:	CurrentTotalTime=Total time in seconds in file,
  6437                                  ;; 		Output on the screen of the total time in seconds
  6438                                  
  6439                                  	; 01/12/2024 (32 bit registers)
  6440                                  SetTotalTime:
  6441                                  	;; Calculate total seconds in file
  6442                                  	;mov	ax, [DATA_SubchunkSize]
  6443                                  	;mov	dx, [DATA_SubchunkSize + 2]
  6444                                  	;mov	bx, [WAVE_SampleRate]
  6445                                  	;div	bx
  6446                                  	;xor	dx, dx
  6447                                  	; 01/12/2024
  6448 00002963 A1[14380000]            	mov	eax, [DATA_SubchunkSize]
  6449 00002968 0FB71D[04380000]        	movzx	ebx, word [WAVE_SampleRate]
  6450 0000296F 31D2                    	xor	edx, edx
  6451 00002971 F7F3                    	div	ebx
  6452                                  
  6453                                  	;mov	bx, [WAVE_BlockAlign]
  6454                                  	;div	bx
  6455                                  	; 01/12/2024
  6456 00002973 668B1D[0C380000]        	mov	bx, [WAVE_BlockAlign]
  6457 0000297A 31D2                    	xor	edx, edx
  6458 0000297C F7F3                    	div	ebx
  6459                                  
  6460                                  	;mov	[TotalTime], ax
  6461 0000297E A3[98380000]            	mov	[TotalTime], eax
  6462                                  
  6463 00002983 B33C                    	mov	bl, 60
  6464 00002985 F6F3                    	div	bl
  6465                                  
  6466                                  	;; al = minutes, ah = seconds
  6467 00002987 50                      	push	eax ; **
  6468 00002988 50                      	push	eax ; *
  6469                                  
  6470                                  	;mov	dh, 24
  6471                                  	; 21/12/2024 (640*480)
  6472                                  	;mov	dh, 32
  6473                                  	;mov	dl, 42
  6474                                  	; 30/12/2024 (320*200)
  6475 00002989 B617                    	mov	dh, 23
  6476 0000298B B216                    	mov	dl, 22
  6477 0000298D E8B5FFFFFF              	call	setCursorPosition
  6478                                  
  6479 00002992 58                      	pop	eax ; *
  6480 00002993 30E4                    	xor	ah, ah
  6481 00002995 BD02000000              	mov	ebp, 2
  6482 0000299A E812000000              	call	PrintNumber
  6483                                  	
  6484                                  	;mov	dh, 24
  6485                                  	; 21/12/2024 (640*480)
  6486                                  	;mov	dh, 32
  6487                                  	;mov	dl, 45
  6488                                  	; 30/12/2024 (320*200)
  6489 0000299F B617                    	mov	dh, 23
  6490 000029A1 B219                    	mov	dl, 25
  6491 000029A3 E89FFFFFFF              	call	setCursorPosition
  6492                                  
  6493 000029A8 58                      	pop	eax ; **
  6494 000029A9 88E0                    	mov	al, ah
  6495 000029AB 30E4                    	xor	ah, ah
  6496                                  	; 21/12/2024
  6497 000029AD 66BD0200                	mov	bp, 2
  6498                                  	;jmp	short PrintNumber
  6499                                  
  6500                                  ; --------------------------------------------------------
  6501                                  
  6502                                  	; 21/12/2024 (write numbers in VESA VBE graphics mode)
  6503                                  	; 01/12/2024 (32bit registers)
  6504                                  PrintNumber:
  6505                                  	; eax = binary number
  6506                                  	; ebp = digits
  6507 000029B1 8B35[CC320000]          	mov	esi, [screenpos]
  6508                                  		; hw = row, si = column
  6509 000029B7 BB0A000000              	mov	ebx, 10
  6510 000029BC 31C9                    	xor	ecx, ecx
  6511                                  printNumber_CutNumber:
  6512 000029BE 41                      	inc	ecx
  6513 000029BF 31D2                    	xor	edx, edx
  6514 000029C1 F7F3                    	div	ebx
  6515 000029C3 52                      	push	edx
  6516 000029C4 39E9                    	cmp	ecx, ebp
  6517 000029C6 7402                    	je	short printNumber_printloop
  6518 000029C8 EBF4                    	jmp	printNumber_CutNumber
  6519                                  
  6520                                  printNumber_printloop:
  6521 000029CA 58                      	pop	eax
  6522                                  	; 21/12/2024
  6523                                  	; ebp = count of digits
  6524                                  	; eax <= 9
  6525                                  
  6526 000029CB 0430                    	add	al, '0'
  6527                                  	
  6528                                  	; esi = pixel position (hw = row, si = column)
  6529                                  	; eax = al = character
  6530                                  	;call	write_character
  6531                                  	; 22/12/2024
  6532 000029CD E82A010000              	call	write_character_white
  6533                                  
  6534 000029D2 4D                      	dec	ebp
  6535 000029D3 7405                     	jz	short printNumber_ok
  6536 000029D5 83C608                  	add	esi, 8	; next column
  6537 000029D8 EBF0                    	jmp	short printNumber_printloop
  6538                                  printNumber_ok:
  6539 000029DA C3                      	retn
  6540                                  
  6541                                  ; --------------------------------------------------------
  6542                                  
  6543                                  	; 14/11/2024 - Erdogan Tan
  6544                                  SetProgressTime:
  6545                                  	;; Calculate playing/progress seconds in file
  6546 000029DB E835000000              	call	CalcProgressTime
  6547                                  
  6548                                  	; 01/12/2024 (32bit registers)
  6549                                  UpdateProgressTime:
  6550                                  	; eax = (new) progress time 
  6551                                  
  6552 000029E0 A3[9C380000]            	mov	[ProgressTime], eax
  6553                                  
  6554 000029E5 B33C                    	mov	bl, 60
  6555 000029E7 F6F3                    	div	bl
  6556                                  
  6557                                  	;; al = minutes, ah = seconds
  6558 000029E9 50                      	push	eax ; **
  6559 000029EA 50                      	push	eax ; *
  6560                                  
  6561                                  	;mov	dh, 24
  6562                                  	; 21/12/2024 (640*480)
  6563                                  	;mov	dh, 32
  6564                                  	;mov	dl, 33
  6565                                  	; 30/12/2024 (320*200)
  6566 000029EB B617                    	mov	dh, 23
  6567 000029ED B20D                    	mov	dl, 13
  6568 000029EF E853FFFFFF              	call	setCursorPosition
  6569                                  
  6570 000029F4 58                      	pop	eax ; *
  6571 000029F5 30E4                    	xor	ah, ah
  6572 000029F7 BD02000000              	mov	ebp, 2
  6573 000029FC E8B0FFFFFF              	call	PrintNumber
  6574                                  	
  6575                                  	;mov	dh, 24
  6576                                  	; 21/12/2024 (640*480)
  6577                                  	;mov	dh, 32
  6578                                  	;mov	dl, 36
  6579                                  	; 30/12/2024 (320*200)
  6580 00002A01 B617                    	mov	dh, 23
  6581 00002A03 B210                    	mov	dl, 16
  6582 00002A05 E83DFFFFFF              	call	setCursorPosition
  6583                                  
  6584 00002A0A 58                      	pop	eax ; **
  6585 00002A0B 88E0                    	mov	al, ah
  6586 00002A0D 30E4                    	xor	ah, ah
  6587                                  	; 21/12/2024
  6588 00002A0F 66BD0200                	mov	bp, 2
  6589 00002A13 EB9C                    	jmp	short PrintNumber
  6590                                  
  6591                                  ; --------------------------------------------------------
  6592                                  
  6593                                  	; 01/12/2024 (32bit registers)
  6594                                  	; 17/11/2024
  6595                                  	; 14/11/2024
  6596                                  CalcProgressTime:
  6597                                  	;mov	ax, [LoadedDataBytes]
  6598                                  	;mov	dx, [LoadedDataBytes+2]
  6599                                  	;mov	bx, ax
  6600                                  	;or	bx, dx
  6601                                  	;jz	short cpt_ok
  6602                                  	; 01/12/2024
  6603 00002A15 A1[A4380000]            	mov	eax, [LoadedDataBytes]
  6604 00002A1A 09C0                    	or	eax, eax
  6605 00002A1C 7416                    	jz	short cpt_ok
  6606                                  
  6607                                  	;mov	bx, [WAVE_SampleRate]
  6608                                  	;div	bx
  6609                                  	;xor	dx, dx
  6610                                  	;mov	bx, [WAVE_BlockAlign]
  6611                                  	;div	bx
  6612                                  	; 01/12/2024
  6613 00002A1E 0FB71D[04380000]        	movzx	ebx, word [WAVE_SampleRate]
  6614 00002A25 31D2                    	xor	edx, edx
  6615 00002A27 F7F3                    	div	ebx
  6616 00002A29 31D2                    	xor	edx, edx
  6617 00002A2B 668B1D[0C380000]        	mov	bx, [WAVE_BlockAlign]
  6618 00002A32 F7F3                    	div	ebx
  6619                                  cpt_ok:
  6620                                  	; eax = (new) progress time
  6621 00002A34 C3                      	retn
  6622                                  
  6623                                  ; --------------------------------------------------------
  6624                                  ; 14/11/2024
  6625                                  ; (Ref: player.asm, out_cs.asm, Matan Alfasi, 2017)
  6626                                  
  6627                                  ;; DESCRIPTION: Update file information on template
  6628                                  ;; PARAMS:	WAVE parameters and other variables
  6629                                  ;; REGS:	AX(RW)
  6630                                  ;; VARS:	CurrentFileName, WAVE_SampleRate, 
  6631                                  ;; RETURNS:	On-screen file info is updated.
  6632                                  
  6633                                  	; 01/12/2024 (32bit registers)
  6634                                  UpdateFileInfo:
  6635                                  	;; Print File Name
  6636                                  	;mov	dh, 9
  6637                                  	; 21/12/2024 (640*480 graphics display)
  6638                                  	;mov	dh, 8
  6639                                  	;mov	dl, 23
  6640                                  	; 30/12/2024 (320*200, video mode 13h)
  6641 00002A35 B607                    	mov	dh, 7
  6642 00002A37 B208                    	mov	dl, 8
  6643 00002A39 E809FFFFFF              	call	setCursorPosition
  6644                                  	
  6645 00002A3E BE[2C380000]            	mov	esi, wav_file_name
  6646                                  	
  6647                                  	;;;
  6648                                  	; 14/11/2024
  6649                                  	; skip directory separators
  6650                                  	; (note: asciiz string, max. 79 bytes except zero tail)
  6651 00002A43 89F3                    	mov	ebx, esi
  6652                                  chk4_nxt_sep:
  6653 00002A45 AC                      	lodsb
  6654 00002A46 3C2F                    	cmp	al, '/'	; 14/12/2024
  6655 00002A48 7406                    	je	short chg_fpos
  6656 00002A4A 20C0                    	and	al, al
  6657 00002A4C 7406                    	jz	short chg_fpos_ok
  6658 00002A4E EBF5                    	jmp	short chk4_nxt_sep
  6659                                  chg_fpos:
  6660 00002A50 89F3                    	mov	ebx, esi
  6661 00002A52 EBF1                    	jmp	short chk4_nxt_sep
  6662                                  chg_fpos_ok:
  6663 00002A54 89DE                    	mov	esi, ebx ; file name (without its path/directory)
  6664                                  	;;;
  6665                                  _fnl_chk:
  6666                                  	; 30/12/2024 (cgaplay.s)
  6667                                  	; ????????.wav
  6668                                  	; 26/12/2024 (file name length limit -display-)
  6669 00002A56 BB0C000000              	mov	ebx, 12
  6670                                  	;mov	ebx, 17 ; ????????.wav?????
  6671 00002A5B 56                      	push	esi
  6672                                  _fnl_chk_loop:
  6673 00002A5C AC                      	lodsb
  6674 00002A5D 20C0                    	and	al, al
  6675 00002A5F 7406                    	jz	short _fnl_ok
  6676 00002A61 4B                       	dec	ebx
  6677 00002A62 75F8                    	jnz	short _fnl_chk_loop
  6678 00002A64 C60600                  	mov	byte [esi], 0
  6679                                  _fnl_ok:
  6680 00002A67 5E                      	pop	esi
  6681                                  	;;;
  6682                                  
  6683 00002A68 E870000000              	call	PrintString
  6684                                  	
  6685                                  	;; Print Frequency
  6686                                  	;mov	dh, 10
  6687                                  	; 21/12/2024 (640*480 graphics display)
  6688                                  	;mov	dh, 9
  6689                                  	;mov	dl, 23
  6690                                  	; 30/12/2024 (320*200, video mode 13h)
  6691 00002A6D B608                    	mov	dh, 8
  6692 00002A6F B208                    	mov	dl, 8
  6693 00002A71 E8D1FEFFFF              	call	setCursorPosition
  6694                                  	;movzx	eax, word [WAVE_SampleRate]
  6695                                  	; 22/12/2024
  6696                                  	; eax = 0
  6697 00002A76 66A1[04380000]          	mov	ax, [WAVE_SampleRate]
  6698 00002A7C BD05000000              	mov	ebp, 5
  6699 00002A81 E82BFFFFFF              	call	PrintNumber
  6700                                  
  6701                                  	;; Print BitRate
  6702                                  	;mov	dh, 9
  6703                                  	; 21/12/2024 (640*480 graphics display)
  6704                                  	;mov	dh, 8
  6705                                  	;mov	dl, 57
  6706                                  	; 30/12/2024 (320*200, video mode 13h)
  6707 00002A86 B607                    	mov	dh, 7
  6708 00002A88 B21F                    	mov	dl, 31
  6709 00002A8A E8B8FEFFFF              	call	setCursorPosition
  6710 00002A8F 66A1[0E380000]          	mov	ax, [WAVE_BitsPerSample]
  6711 00002A95 66BD0200                	mov	bp, 2
  6712 00002A99 E813FFFFFF              	call	PrintNumber
  6713                                  
  6714                                  	;; Print Channel Number
  6715                                  	;mov	dh, 10
  6716                                  	; 21/12/2024 (640*480 graphics display)
  6717                                  	;mov	dh, 9
  6718                                  	;mov	dl, 57
  6719                                  	; 30/12/2024 (320*200, video mode 13h)
  6720 00002A9E B608                    	mov	dh, 8
  6721 00002AA0 B21F                    	mov	dl, 31
  6722 00002AA2 E8A0FEFFFF              	call	setCursorPosition
  6723 00002AA7 66A1[02380000]          	mov	ax, [WAVE_NumChannels]
  6724 00002AAD 66BD0100                	mov	bp, 1
  6725 00002AB1 E8FBFEFFFF              	call	PrintNumber
  6726                                  
  6727                                  	;call	UpdateVolume
  6728                                  	;retn
  6729                                  
  6730                                  ; --------------------------------------------------------
  6731                                  
  6732                                  	; 14/11/2024
  6733                                  UpdateVolume:
  6734                                  	;; Print Volume
  6735                                  	;mov	dh, 24
  6736                                  	; 21/12/2024 (640*480)
  6737                                  	;mov	dh, 32
  6738                                  	;mov	dl, 75
  6739                                  	; 30/12/2024 (320*200, video mode 13h)
  6740 00002AB6 B617                    	mov	dh, 23
  6741 00002AB8 B223                    	mov	dl, 35
  6742 00002ABA E888FEFFFF              	call	setCursorPosition
  6743                                  	; 22/12/2024
  6744                                  	; eax = 0
  6745                                  
  6746 00002ABF A0[46290000]            	mov	al, [volume]
  6747                                  
  6748 00002AC4 B364                    	mov	bl, 100
  6749 00002AC6 F6E3                    	mul	bl
  6750                                  
  6751 00002AC8 B31F                    	mov	bl, 31
  6752 00002ACA F6F3                    	div	bl
  6753                                  
  6754                                  	;neg	ax
  6755                                  	;add	ax, 100	
  6756                                  	; 01/12/2024
  6757 00002ACC B464                    	mov	ah, 100
  6758 00002ACE 28C4                    	sub	ah, al
  6759 00002AD0 0FB6C4                  	movzx	eax, ah
  6760                                  	;xor	ah, ah
  6761                                  	;mov	bp, 3
  6762 00002AD3 BD03000000              	mov	ebp, 3
  6763                                  	;call	PrintNumber
  6764                                  	;retn
  6765 00002AD8 E9D4FEFFFF              	jmp	PrintNumber	
  6766                                  
  6767                                  ; --------------------------------------------------------
  6768                                  
  6769                                  	; 21/12/2024
  6770                                  	; write text in VESA VBE graphics mode
  6771                                  PrintString:
  6772                                  	; esi = string address
  6773                                  printstr_loop:
  6774 00002ADD 31C0                    	xor	eax, eax
  6775 00002ADF AC                      	lodsb
  6776 00002AE0 08C0                    	or	al, al
  6777 00002AE2 7417                    	jz	short printstr_ok
  6778                                  
  6779 00002AE4 56                      	push	esi
  6780                                  
  6781 00002AE5 8B35[CC320000]          	mov	esi, [screenpos]
  6782                                  
  6783                                  	; esi = pixel position (hw = row, si = column)
  6784                                  	; eax = al = character
  6785                                  	;call	write_character
  6786                                  	; 22/12/2024
  6787 00002AEB E80C000000              	call	write_character_white
  6788                                  
  6789 00002AF0 668305[CC320000]08      	add	word [screenpos], 8 ; update column (only, not row)
  6790                                  
  6791 00002AF8 5E                      	pop	esi
  6792 00002AF9 EBE2                    	jmp	short printstr_loop
  6793                                  
  6794                                  printstr_ok:
  6795 00002AFB C3                      	retn
  6796                                  
  6797                                  ; --------------------------------------------------------
  6798                                  
  6799                                  	; 30/12/2024
  6800                                  	; write character (at cursor position)
  6801                                  	; in video mode 13h (320*200, 256 colors)
  6802                                  	; 21/12/2024
  6803                                  	; write character (at cursor position)
  6804                                  	; in graphics mode (640*480, 256 colors)
  6805                                  	; 22/12/2024
  6806                                  write_character_white:
  6807 00002AFC B90F000000              	mov	ecx, 0Fh
  6808                                  	; 26/12/2024
  6809                                  	;movzx	ecx, byte [tcolor]
  6810                                  write_character:
  6811                                  	; esi = pixel position (hw = row, si = column)
  6812                                  	; eax = al = character
  6813                                  	; cl = color
  6814 00002B01 890D[D0320000]          	mov	[wcolor], ecx ; 22/12/2024
  6815                                  
  6816                                  	; 30/12/2024
  6817                                  	; 22/12/2024
  6818 00002B07 50                      	push	eax
  6819                                  	; clear previous character pixels
  6820 00002B08 BF[B0320000]            	mov	edi, fillblock
  6821                                  	;;sys	_video, 020Fh, 0, 8001h
  6822                                  	; 30/12/2024
  6823                                  	sys	_video, 010Fh, 0, 8000h ; 8*8 userfont
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00002B0D BB0F010000          <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00002B12 B900000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00002B17 BA00800000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00002B1C B81F000000          <1>  mov eax, %1
   104                              <1> 
   105 00002B21 CD40                <1>  int 40h
  6824 00002B23 58                      	pop	eax
  6825                                  
  6826                                  	; 30/12/2024
  6827                                  	;shl	eax, 4 ; 8*16 pixel user font
  6828                                  	;mov	edi, fontbuff2 ; start of user font data
  6829                                  	;add	edi, eax
  6830                                  
  6831                                  	; 21/12/2024
  6832                                  	; NOTE:
  6833                                  	; TRDOS 386 does not use 8*14 pixel fonts in sysvideo
  6834                                  	; system calls -in graphics mode-
  6835                                  	; because 8*16 pixel operations are faster
  6836                                  	;			than 8*14 pixel operations.
  6837                                  	; ((so, 8*14 fonts can be converted to 8*16 fonts by
  6838                                  	; adding 2 empty lines))
  6839                                  	; (8*14 characters can be written via pixel operations)
  6840                                    	
  6841                                  	; 21/12/2024 (TRDOS 386 v2.0.9, trdosk6.s, 27/09/2024)
  6842                                  	;;;;;;;;;;;;;;;;; ; sysvideo system call
  6843                                  	;sysvideo:
  6844                                  	;   function in BH
  6845                                  	;	02h: Super VGA, LINEAR FRAME BUFFER data transfers
  6846                                  	;   sub function in BL
  6847                                  	;	0Fh: WRITE CHARACTER (FONT)
  6848                                  	;          CL = char's color (8 bit, 256 colors)
  6849                                  	;	If DH bit 7 = 1
  6850                                  	;	   USER FONT (from user buffer)
  6851                                  	;	         DL = 1 -> 8x16 pixel font
  6852                                   	;	   EDI = user's font buffer address
  6853                                  	;		(NOTE: byte order is as row0,row1,row2..)
  6854                                  	;	   ESI = start position (row, column)
  6855                                  	;		(HW = row, SI = column)
  6856                                  	;;;;;;;;;;;;;;;;;
  6857                                  
  6858                                  	;sys	_video, 020Fh, [wcolor], 8001h
  6859                                  
  6860                                  	; 30/12/2024
  6861                                  	; sysvideo system call
  6862                                  	; BH = 01h = VGA graphics (0A0000h) data transfers
  6863                                  	; BL = 0Fh = write character/font
  6864                                  	; DH = 01h = 8*8 system font 
  6865                                  	; CL = [wcolor] = color
  6866                                  	; ESI = cursor/writing position (pixels)
  6867                                  	;	HW = row, SI = column
  6868                                  	; DL = character (ASCII code)
  6869                                  
  6870 00002B24 B401                    	mov	ah, 01h ; 8*8 pixels
  6871                                  
  6872                                  	sys	_video, 010Fh, [wcolor], eax
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00002B26 BB0F010000          <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00002B2B 8B0D[D0320000]      <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00002B31 89C2                <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00002B33 B81F000000          <1>  mov eax, %1
   104                              <1> 
   105 00002B38 CD40                <1>  int 40h
  6873                                  
  6874 00002B3A C3                      	retn
  6875                                  
  6876                                  ; --------------------------------------------------------
  6877                                  
  6878                                  	; 30/12/2024
  6879                                  	; write characters in video mode 13h
  6880                                  	; (320*200 pixels, 256 colors)
  6881                                  	; 22/12/2024
  6882                                  	; 21/12/2024
  6883                                  	; (write chars in VESA VBE graphics mode)
  6884                                  	; 14/11/2024
  6885                                  	; (Ref: player.asm, Matan Alfasi, 2017)
  6886                                  	; (Modification: Erdogan Tan, 14/11/2024)
  6887                                  
  6888                                  	;PROGRESSBAR_ROW equ 23
  6889                                  	; 21/12/2024 (640*480)
  6890                                  	;PROGRESSBAR_ROW equ 31
  6891                                  	; 30/12/2024 (320*200)
  6892                                  	PROGRESSBAR_ROW equ 22
  6893                                  
  6894                                  UpdateProgressBar:
  6895 00002B3B E89BFEFFFF              	call	SetProgressTime	; 14/11/2024
  6896                                  
  6897                                  	; 01/12/2024 (32bit registers)
  6898 00002B40 A1[9C380000]            	mov	eax, [ProgressTime]
  6899                                  UpdateProgressBar@:
  6900                                  	;mov	edx, 80
  6901                                  	; 30/12/2024
  6902 00002B45 BA28000000              	mov	edx, 40 ; 320*200 pixels, 40 columns 
  6903 00002B4A F7E2                    	mul	edx
  6904 00002B4C 8B1D[98380000]          	mov	ebx, [TotalTime]
  6905 00002B52 F7F3                    	div	ebx
  6906                                  
  6907                                  	; 22/12/2024
  6908                                  	; check progress bar indicator position if it is same 
  6909 00002B54 3A05[D5320000]          	cmp	al, [pbprev]
  6910 00002B5A 7430                    	je	short UpdateProgressBar_ok
  6911 00002B5C A2[D5320000]            	mov	[pbprev], al
  6912                                  
  6913                                  UpdateProgressBar@@:
  6914                                  	;; Push for the 'Clean' part
  6915 00002B61 50                      	push	eax ; **
  6916 00002B62 50                      	push	eax ; *
  6917                                  
  6918                                  	;; Set cursor position
  6919 00002B63 B616                    	mov	dh, PROGRESSBAR_ROW
  6920 00002B65 B200                    	mov	dl, 0
  6921 00002B67 E8DBFDFFFF              	call	setCursorPosition
  6922                                  
  6923 00002B6C 58                      	pop	eax ; *
  6924 00002B6D 09C0                    	or	eax, eax
  6925 00002B6F 742D                    	jz	short UpdateProgressBar_Clean
  6926                                  
  6927                                  UpdateProgressBar_DrawProgress:
  6928                                  	; 22/12/2024
  6929                                  	; 21/12/2024
  6930                                  	; (write progress bar chars in graphics mode)
  6931                                  	;;;;
  6932 00002B71 89C5                    	mov	ebp, eax
  6933 00002B73 50                      	push	eax ; ***
  6934 00002B74 8B35[CC320000]          	mov	esi, [screenpos]
  6935                                  UpdateProgressBar_DrawProgress_@:
  6936 00002B7A B8DF000000              	mov	eax, 223
  6937                                  	
  6938                                  	; esi = pixel position (hw = row, si = column)
  6939                                  	; eax = al = character
  6940                                  	;call	write_character
  6941                                  	; 22/12/2024
  6942 00002B7F E878FFFFFF              	call	write_character_white
  6943                                  
  6944 00002B84 4D                      	dec	ebp
  6945 00002B85 7406                    	jz	short UpdateProgressBar_DrawCursor
  6946                                  
  6947 00002B87 83C608                  	add	esi, 8 ; next column
  6948 00002B8A EBEE                    	jmp	short UpdateProgressBar_DrawProgress_@
  6949                                  	;;;
  6950                                  
  6951                                  UpdateProgressBar_ok:
  6952 00002B8C C3                      	retn
  6953                                  
  6954                                  UpdateProgressBar_DrawCursor:
  6955                                  	; 22/12/2024
  6956 00002B8D 5A                      	pop	edx ; ***
  6957 00002B8E B616                    	mov	dh, PROGRESSBAR_ROW
  6958 00002B90 E8B2FDFFFF              	call	setCursorPosition
  6959                                  
  6960                                  	; 21/12/2024
  6961                                  	; (write progress bar character in graphics mode)
  6962                                  	;;;;
  6963                                  	;;;mov	eax, 223
  6964                                  	;;;shl	eax, 4 ; 8*16 pixel user font
  6965                                  	;;mov	eax, 223*16
  6966                                  	;;mov	edi, fontbuff2 ; start of user font data
  6967                                  	;;add	edi, eax
  6968                                  	;mov	edi, fontbuff2+(223*16)
  6969                                  	;
  6970                                  	;sys	_video, 020Fh, 0Ch, 8001h
  6971                                  	; 22/12/2024
  6972                                  	;mov	eax, 223
  6973                                  	; eax = 0
  6974 00002B95 B0DF                    	mov	al, 223
  6975 00002B97 B10C                    	mov	cl, 0Ch ; red
  6976 00002B99 E863FFFFFF              	call	write_character
  6977                                  	;;;;
  6978                                  
  6979                                  UpdateProgressBar_Clean:
  6980                                  	;pop	eax  ; **
  6981                                  	; 22/12/2024
  6982 00002B9E 5A                      	pop	edx  ; **
  6983                                  	; 30/12/2024
  6984                                  	; 21/12/2024
  6985                                  	;mov	ebp, 80
  6986                                  	; 30/12/2024
  6987 00002B9F BD28000000              	mov	ebp, 40 ; 40 columns (320*200 pixels)
  6988                                  	;sub	bp, ax
  6989 00002BA4 6629D5                  	sub	bp, dx ; 22/12/2024
  6990 00002BA7 74E3                    	jz	short UpdateProgressBar_ok
  6991                                  
  6992 00002BA9 B616                    	mov	dh, PROGRESSBAR_ROW
  6993                                  	;mov	dl, al ; 22/12/2024
  6994 00002BAB E897FDFFFF              	call	setCursorPosition
  6995                                  
  6996                                  	; 21/12/2024
  6997                                  	; (write progress bar chars in graphics mode)
  6998                                  	;;;;
  6999 00002BB0 8B35[CC320000]          	mov	esi, [screenpos]
  7000                                  UpdateProgressBar_Clean_@:
  7001                                  	;;;mov	eax, 223
  7002                                  	;;;shl	eax, 4 ; 8*16 pixel user font
  7003                                  	;;mov	eax, 223*16
  7004                                  	;mov	edi, fontbuff2 ; start of user font data
  7005                                  	;add	edi, eax
  7006                                  	;mov	edi, fontbuff2+(223*16)
  7007                                  	;
  7008                                  	;sys	_video, 020Fh, 08h, 8001h
  7009                                  	; 22/12/2024
  7010                                  	;mov	eax, 223
  7011                                  	; eax = 0
  7012 00002BB6 B0DF                    	mov	al, 223
  7013 00002BB8 B108                    	mov	cl, 08h ; gray (dark)
  7014 00002BBA E842FFFFFF              	call	write_character
  7015                                  	;;;;
  7016                                  
  7017 00002BBF 4D                      	dec	ebp
  7018 00002BC0 74CA                    	jz	short UpdateProgressBar_ok
  7019                                  
  7020 00002BC2 83C608                  	add	esi, 8 ; next column
  7021 00002BC5 EBEF                    	jmp	short UpdateProgressBar_Clean_@
  7022                                  	;;;;
  7023                                  
  7024                                  ; --------------------------------------------------------
  7025                                  ; 17/11/2024
  7026                                  
  7027                                  Player_ProcessKey_Backwards:
  7028                                  	;; In order to go backwards 5 seconds:
  7029                                  	;; Update file pointer to the beginning, skip headers
  7030 00002BC7 B142                    	mov	cl, 'B'
  7031 00002BC9 EB02                    	jmp	short Player_ProcessKey_B_or_F
  7032                                  
  7033                                  Player_ProcessKey_Forwards:
  7034                                  	;; In order to fast-forward 5 seconds, set the file pointer
  7035                                  	;; to CUR_SEEK + 5 * Freq
  7036                                  
  7037 00002BCB B146                    	mov	cl, 'F'
  7038                                  	;jmp	short Player_ProcessKey_B_or_F
  7039                                  
  7040                                  	; 01/12/2024 (32bit regsisters)
  7041                                  Player_ProcessKey_B_or_F:
  7042                                  	; 17/11/2024
  7043                                  	; 04/11/2024
  7044                                  	; (Ref: player.asm, Matan Alfasi, 2017)
  7045                                    
  7046                                  	; 04/11/2024
  7047 00002BCD B805000000              	mov	eax, 5
  7048 00002BD2 0FB71D[0C380000]        	movzx	ebx, word [WAVE_BlockAlign]
  7049 00002BD9 F7E3                    	mul	ebx
  7050 00002BDB 668B1D[04380000]        	mov	bx, [WAVE_SampleRate]
  7051 00002BE2 F7E3                    	mul	ebx
  7052                                  	; eax = transfer byte count for 5 seconds
  7053                                  	
  7054                                  	; 17/11/2024
  7055 00002BE4 80F942                  	cmp	cl, 'B'
  7056                                  	;mov	bx, [LoadedDataBytes]
  7057                                  	;mov	cx, [LoadedDataBytes+2]
  7058                                  	; 01/12/2024
  7059 00002BE7 8B0D[A4380000]          	mov	ecx, [LoadedDataBytes]
  7060 00002BED 7508                    	jne	short move_forward ; cl = 'F'
  7061                                  move_backward:
  7062                                  	;sub	bx, ax
  7063                                  	;sbb	cx, dx
  7064 00002BEF 29C1                    	sub	ecx, eax
  7065 00002BF1 7316                    	jnc	short move_file_pointer
  7066                                  move_to_beginning:
  7067                                  	;xor	cx, cx ; 0
  7068                                  	;xor	bx, bx ; 0
  7069 00002BF3 31C9                    	xor	ecx, ecx
  7070 00002BF5 EB12                    	jmp	short move_file_pointer
  7071                                  move_forward: 
  7072                                  	;add	bx, ax
  7073                                  	;adc	cx, dx
  7074 00002BF7 01C1                    	add	ecx, eax
  7075 00002BF9 7208                    	jc	short move_to_end
  7076                                  	;cmp	cx, [DATA_SubchunkSize+2]
  7077                                  	;ja	short move_to_end
  7078                                  	;jb	short move_file_pointer
  7079                                  	;cmp	bx, [DATA_SubchunkSize]
  7080                                  	;jna	short move_file_pointer
  7081 00002BFB 3B0D[14380000]          	cmp	ecx, [DATA_SubchunkSize]
  7082 00002C01 7606                    	jna	short move_file_pointer
  7083                                  move_to_end:
  7084                                  	;mov	bx, [DATA_SubchunkSize]
  7085                                  	;mov	cx, [DATA_SubchunkSize+2]
  7086 00002C03 8B0D[14380000]          	mov	ecx, [DATA_SubchunkSize]
  7087                                  move_file_pointer:
  7088                                  	;mov	dx, bx    
  7089                                  	;mov	[LoadedDataBytes], dx
  7090                                  	;mov	[LoadedDataBytes+2], cx
  7091 00002C09 890D[A4380000]          	mov	[LoadedDataBytes], ecx
  7092                                  	;add	dx, 44 ; + header
  7093                                  	;adc	cx, 0
  7094 00002C0F 83C12C                  	add	ecx, 44 
  7095                                  
  7096                                  	; seek
  7097                                  	;mov	bx, [filehandle]
  7098                                  	;mov	ax, 4200h
  7099                                  	;int	21h
  7100                                  	; 01/12/2024
  7101 00002C12 31D2                    	xor	edx, edx ; offset from beginning of the file
  7102                                  	; ecx = offset	
  7103                                  	; ebx = file handle
  7104                                  	; edx = 0
  7105                                  	sys	_seek, [filehandle]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00002C14 8B1D[1C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97                              <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00002C1A B813000000          <1>  mov eax, %1
   104                              <1> 
   105 00002C1F CD40                <1>  int 40h
  7106 00002C21 C3                      	retn
  7107                                  
  7108                                  ; --------------------------------------------------------
  7109                                  
  7110                                  	; 30/12/2024 (video mode 13h)
  7111                                  	; (320*200, 256 colors)
  7112                                  	; 25/12/2024
  7113                                  	; 22/12/2024 (VESA VBE mode graphics) 
  7114                                  	; (640*480, 256 colors)
  7115                                  clear_window:
  7116                                  	;mov	edi, [LFB_ADDR]
  7117                                  	; 30/12/2024
  7118                                  	;mov	edi, 0A0000h
  7119                                  	;;add	edi, (13*80*8*14)
  7120                                  	; 25/12/2024
  7121                                  	;;add	edi, 164*640
  7122                                  	;add	edi, 12*8*320
  7123                                  	; 30/12/2024
  7124                                  	;mov	edi, [graphstart] ; 12*8*320
  7125 00002C22 BF80700A00              	mov	edi, 0A0000h+(11*8*320)+(2*320) ; *
  7126                                  				; AC97 info start 
  7127 00002C27 29C0                    	sub	eax, eax
  7128                                  	;;mov	ecx, (16*640*14)/4 ; 16 rows
  7129                                  	;mov	ecx, 64*640 ; 256 volume level points
  7130                                  	; 30/12/2024
  7131                                  	;mov	ecx, (8*8*320)/4 ; 8 rows 
  7132 00002C29 B900190000              	mov	ecx, (10*8*320)/4 ; *
  7133 00002C2E F3AB                    	rep	stosd
  7134                                  	; 24/12/2024
  7135 00002C30 A3[DC320000]            	mov	[prev_points], eax ; 0
  7136                                  	;
  7137 00002C35 C3                      	retn
  7138                                  
  7139                                  ; -------------------------------------------------------------
  7140                                  ; ac97.inc (11/11/2023)
  7141                                  ; -------------------------------------------------------------
  7142                                  
  7143                                  ; special characters
  7144                                  LF      EQU 10
  7145                                  CR      EQU 13
  7146                                  
  7147                                  ; PCI stuff
  7148                                  
  7149                                  BIT0  EQU 1
  7150                                  BIT1  EQU 2
  7151                                  BIT2  EQU 4
  7152                                  BIT8  EQU 100h
  7153                                  BIT9  EQU 200h
  7154                                  BIT28 EQU 10000000h
  7155                                  BIT30 EQU 40000000h
  7156                                  BIT31 EQU 80000000h
  7157                                  
  7158                                  BUP		equ	BIT30		; Buffer Underrun Policy.
  7159                                  					; if this buffer is the last buffer
  7160                                  					; in a playback, fill the remaining
  7161                                  					; samples with 0 (silence) or not.
  7162                                  					; It's a good idea to set this to 1
  7163                                  					; for the last buffer in playback,
  7164                                  					; otherwise you're likely to get a lot
  7165                                  					; of noise at the end of the sound.
  7166                                  
  7167                                  RR		equ	BIT1		; reset registers. Nukes all regs
  7168                                                                          ; except bits 4:2 of this register.
  7169                                                                          ; Only set this bit if BIT 0 is 0
  7170                                  RPBM		equ	BIT0		; Run/Pause
  7171                                  					; set this bit to start the codec!
  7172                                  IO_ENA		EQU	BIT0		; i/o decode enable
  7173                                  BM_ENA		EQU	BIT2		; bus master enable
  7174                                  
  7175                                  PCI_INDEX_PORT  EQU     0CF8h
  7176                                  PCI_DATA_PORT   EQU     0CFCh
  7177                                  PCI32           EQU     BIT31           ; bitflag to signal 32bit access
  7178                                  PCI16           EQU     BIT30           ; bitflag for 16bit access
  7179                                  
  7180                                  AC97_INT_LINE	equ	3Ch		; AC97 Interrupt Line register offset
  7181                                  
  7182                                  ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
  7183                                  
  7184                                  INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
  7185                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  7186                                  SIS_VID		equ	1039h
  7187                                  NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
  7188                                  AMD_VID		equ	1022h
  7189                                  
  7190                                  ICH_DID         equ     2415h           ; ICH device ID
  7191                                  ICH0_DID        equ     2425h           ; ICH0
  7192                                  ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
  7193                                                                          ; they all should be compatible.
  7194                                  
  7195                                  ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
  7196                                  ICH3_DID	equ     2485h           ; ICH3
  7197                                  ICH4_DID        equ     24C5h           ; ICH4
  7198                                  ICH5_DID	equ     24D5h           ; ICH5
  7199                                  ICH6_DID	equ     266Eh           ; ICH6
  7200                                  ESB6300_DID	equ     25A6h           ; 6300ESB
  7201                                  ESB631X_DID	equ     2698h           ; 631XESB
  7202                                  ICH7_DID	equ	27DEh		; ICH7
  7203                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  7204                                  MX82440_DID	equ	7195h
  7205                                  SI7012_DID	equ	7012h
  7206                                  NFORCE_DID	equ	01B1h
  7207                                  NFORCE2_DID	equ	006Ah
  7208                                  AMD8111_DID	equ	746Dh
  7209                                  AMD768_DID	equ	7445h
  7210                                  ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
  7211                                  CK804_DID	equ	0059h
  7212                                  MCP04_DID	equ	003Ah
  7213                                  CK8_DID		equ	008Ah
  7214                                  NFORCE3_DID	equ	00DAh
  7215                                  CK8S_DID	equ	00EAh
  7216                                  
  7217                                  NAMBAR_REG	equ	10h		; native audio mixer BAR
  7218                                  NABMBAR_REG	equ	14h		; native audio bus mastering BAR
  7219                                  
  7220                                  CODEC_MASTER_VOL_REG	equ	02h	; master volume
  7221                                  CODEC_MASTER_TONE_REG	equ	08h	; master tone (R+L)
  7222                                  CODEC_PCM_OUT_REG 	equ	18h     ; PCM output volume
  7223                                  CODEC_EXT_AUDIO_REG	equ	28h	; extended audio
  7224                                  CODEC_EXT_AUDIO_CTRL_REG equ	2Ah	; extended audio control
  7225                                  CODEC_PCM_FRONT_DACRATE_REG equ	2Ch	; PCM out sample rate
  7226                                  
  7227                                  ; ICH supports 3 different types of register sets for three types of things
  7228                                  ; it can do, thus:
  7229                                  ;
  7230                                  ; PCM in (for recording) aka PI
  7231                                  ; PCM out (for playback) aka PO
  7232                                  ; MIC in (for recording) aka MC
  7233                                  
  7234                                  PI_BDBAR_REG	equ	0		; PCM in buffer descriptor BAR
  7235                                  PO_BDBAR_REG	equ	10h		; PCM out buffer descriptor BAR
  7236                                  
  7237                                  GLOB_CNT_REG	equ	2Ch		; Global control register
  7238                                  GLOB_STS_REG 	equ	30h		; Global Status register (RO)
  7239                                  
  7240                                  PI_CR_REG 	equ	0Bh		; PCM in Control Register
  7241                                  PO_CR_REG	equ	1Bh		; PCM out Control Register
  7242                                  MC_CR_REG	equ	2Bh		; MIC in Control Register
  7243                                  
  7244                                  PCI_CMD_REG	EQU	04h		; reg 04h, command register
  7245                                  
  7246                                  CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
  7247                                  CODEC_REG_POWERDOWN	equ	26h
  7248                                  
  7249                                  PO_CIV_REG	equ	14h		; PCM out current Index value (RO)
  7250                                  PO_LVI_REG	equ	15h		; PCM out Last Valid Index
  7251                                  PO_SR_REG	equ	16h		; PCM out Status register
  7252                                  
  7253                                  ; -------------------------------------------------------------
  7254                                  
  7255                                  ; 22/12/2024
  7256 00002C36 90<rep 2h>              align 4
  7257                                  
  7258                                  ; 13/11/2024
  7259                                  ; ('<<' to 'shl' conversion for FASM)
  7260                                  ;
  7261                                  ; 29/05/2024 (TRDOS 386)
  7262                                  ; 17/02/2017
  7263                                  ; Valid ICH device IDs
  7264                                  
  7265                                  valid_ids:
  7266                                  	;dd (ICH_DID shl 16) + INTEL_VID	; 8086h:2415h
  7267 00002C38 86801524                	dd (ICH_DID << 16) + INTEL_VID		; 8086h:2415h
  7268 00002C3C 86802524                	dd (ICH0_DID << 16) + INTEL_VID		; 8086h:2425h
  7269 00002C40 86804524                	dd (ICH2_DID << 16) + INTEL_VID		; 8086h:2445h
  7270 00002C44 86808524                	dd (ICH3_DID << 16) + INTEL_VID		; 8086h:2485h
  7271 00002C48 8680C524                	dd (ICH4_DID << 16) + INTEL_VID		; 8086h:24C5h
  7272 00002C4C 8680D524                	dd (ICH5_DID << 16) + INTEL_VID		; 8086h:24D5h
  7273 00002C50 86806E26                	dd (ICH6_DID << 16) + INTEL_VID		; 8086h:266Eh
  7274 00002C54 8680A625                	dd (ESB6300_DID << 16) + INTEL_VID	; 8086h:25A6h
  7275 00002C58 86809826                	dd (ESB631X_DID << 16) + INTEL_VID	; 8086h:2698h
  7276 00002C5C 8680DE27                	dd (ICH7_DID << 16) + INTEL_VID		; 8086h:27DEh
  7277                                  	; 03/11/2023 - Erdogan Tan
  7278 00002C60 86809571                	dd (MX82440_DID << 16) + INTEL_VID	; 8086h:7195h
  7279 00002C64 39101270                	dd (SI7012_DID << 16)  + SIS_VID	; 1039h:7012h
  7280 00002C68 DE10B101                	dd (NFORCE_DID << 16)  + NVIDIA_VID	; 10DEh:01B1h
  7281 00002C6C DE106A00                	dd (NFORCE2_DID << 16) + NVIDIA_VID	; 10DEh:006Ah
  7282 00002C70 22106D74                	dd (AMD8111_DID << 16) + AMD_VID	; 1022h:746Dh
  7283 00002C74 22104574                	dd (AMD768_DID << 16)  + AMD_VID	; 1022h:7445h
  7284 00002C78 DE105900                	dd (CK804_DID << 16) + NVIDIA_VID	; 10DEh:0059h
  7285 00002C7C DE103A00                	dd (MCP04_DID << 16) + NVIDIA_VID	; 10DEh:003Ah
  7286 00002C80 DE108A00                	dd (CK8_DID << 16) + NVIDIA_VID		; 1022h:008Ah
  7287 00002C84 DE10DA00                	dd (NFORCE3_DID << 16) + NVIDIA_VID	; 10DEh:00DAh
  7288 00002C88 DE10EA00                	dd (CK8S_DID << 16) + NVIDIA_VID	; 10DEh:00EAh
  7289                                  
  7290                                  valid_id_count equ (($ - valid_ids)>>2)	; 05/11/2023
  7291                                  ; 13/11/2024
  7292                                  ;valid_id_count = ($ - valid_ids) shr 2	; 05/11/2023
  7293                                  
  7294 00002C8C 00000000                	dd 0
  7295                                  
  7296                                  Credits:
  7297 00002C90 564741205741562050-     	db 'VGA WAV Player for TRDOS 386 by Erdogan Tan. '
  7297 00002C99 6C6179657220666F72-
  7297 00002CA2 205452444F53203338-
  7297 00002CAB 36206279204572646F-
  7297 00002CB4 67616E2054616E2E20 
  7298 00002CBD 4A616E756172792032-     	db 'January 2025.',10,13,0
  7298 00002CC6 3032352E0A0D00     
  7299                                  	;db '01/01/2025', 10,13
  7300 00002CCD 31382F30312F323032-     	db '18/01/2025', 10,13
  7300 00002CD6 350A0D             
  7301                                  ; 15/11/2024
  7302                                  reset:
  7303 00002CD9 00                      	db 0
  7304                                  
  7305                                  msgAudioCardInfo:
  7306 00002CDA 666F7220496E74656C-     	db 'for Intel AC97 (ICH) Audio Controller.', 10,13,0
  7306 00002CE3 204143393720284943-
  7306 00002CEC 482920417564696F20-
  7306 00002CF5 436F6E74726F6C6C65-
  7306 00002CFE 722E0A0D00         
  7307                                  
  7308                                  	; 30/12/2024
  7309                                  msg_usage:
  7310 00002D03 75736167653A204347-     	db 'usage: CGAPLAY <FileName1> <FileName2> <...>',10,13,0
  7310 00002D0C 41504C4159203C4669-
  7310 00002D15 6C654E616D65313E20-
  7310 00002D1E 3C46696C654E616D65-
  7310 00002D27 323E203C2E2E2E3E0A-
  7310 00002D30 0D00               
  7311                                  
  7312                                  noDevMsg:
  7313 00002D32 4572726F723A20556E-     	db 'Error: Unable to find AC97 audio device!'
  7313 00002D3B 61626C6520746F2066-
  7313 00002D44 696E64204143393720-
  7313 00002D4D 617564696F20646576-
  7313 00002D56 69636521           
  7314 00002D5A 0A0D00                  	db 10,13,0
  7315                                  
  7316                                  noFileErrMsg:
  7317 00002D5D 4572726F723A206669-     	db 'Error: file not found.',10,13,0
  7317 00002D66 6C65206E6F7420666F-
  7317 00002D6F 756E642E0A0D00     
  7318                                  
  7319                                  ; 07/12/2024
  7320                                  trdos386_err_msg:
  7321 00002D76 5452444F5320333836-     	db 'TRDOS 386 System call error !',10,13,0
  7321 00002D7F 2053797374656D2063-
  7321 00002D88 616C6C206572726F72-
  7321 00002D91 20210A0D00         
  7322                                  
  7323                                  ; 29/05/2024
  7324                                  ; 11/11/2023
  7325                                  msg_init_err:
  7326 00002D96 0D0A                    	db CR, LF
  7327 00002D98 4143393720436F6E74-     	db 'AC97 Controller/Codec initialization error !'
  7327 00002DA1 726F6C6C65722F436F-
  7327 00002DAA 64656320696E697469-
  7327 00002DB3 616C697A6174696F6E-
  7327 00002DBC 206572726F722021   
  7328 00002DC4 0D0A00                  	db CR, LF, 0 ; 07/12/2024
  7329                                  
  7330                                  ; 25/11/2023
  7331                                  msg_no_vra:
  7332 00002DC7 0A0D                    	db 10,13
  7333 00002DC9 4E6F20565241207375-     	db 'No VRA support ! Only 48 kHZ sample rate supported !'
  7333 00002DD2 70706F72742021204F-
  7333 00002DDB 6E6C79203438206B48-
  7333 00002DE4 5A2073616D706C6520-
  7333 00002DED 726174652073757070-
  7333 00002DF6 6F727465642021     
  7334 00002DFD 0A0D00                  	db 10,13,0
  7335                                  
  7336                                  ; 19/11/2024
  7337                                  ; 03/06/2017
  7338                                  hex_chars:
  7339 00002E00 303132333435363738-     	db '0123456789ABCDEF', 0
  7339 00002E09 3941424344454600   
  7340                                  msgAC97Info:
  7341 00002E11 0D0A                    	db 0Dh, 0Ah
  7342 00002E13 204143393720417564-     	db ' AC97 Audio Controller & Codec Info', 0Dh, 0Ah 
  7342 00002E1C 696F20436F6E74726F-
  7342 00002E25 6C6C6572202620436F-
  7342 00002E2E 64656320496E666F0D-
  7342 00002E37 0A                 
  7343 00002E38 2056656E646F722049-     	db ' Vendor ID: '
  7343 00002E41 443A20             
  7344                                  msgVendorId:
  7345 00002E44 303030306820446576-     	db '0000h Device ID: '
  7345 00002E4D 6963652049443A20   
  7346                                  msgDevId:
  7347 00002E55 30303030680D0A          	db '0000h', 0Dh, 0Ah
  7348 00002E5C 204275733A20            	db ' Bus: '
  7349                                  msgBusNo:
  7350 00002E62 303068204465766963-     	db '00h Device: '
  7350 00002E6B 653A20             
  7351                                  msgDevNo:
  7352 00002E6E 3030682046756E6374-     	db '00h Function: '
  7352 00002E77 696F6E3A20         
  7353                                  msgFncNo:
  7354 00002E7C 303068                  	db '00h'
  7355 00002E7F 0D0A                    	db 0Dh, 0Ah
  7356 00002E81 204E414D4241523A20      	db ' NAMBAR: '
  7357                                  msgNamBar:
  7358 00002E8A 30303030682020          	db '0000h  '
  7359 00002E91 4E41424D4241523A20      	db 'NABMBAR: '
  7360                                  msgNabmBar:
  7361 00002E9A 303030306820204952-     	db '0000h  IRQ: '
  7361 00002EA3 513A20             
  7362                                  msgIRQ:
  7363 00002EA6 3030                    	dw 3030h
  7364 00002EA8 0D0A00                  	db 0Dh, 0Ah, 0
  7365                                  ; 25/11/2023
  7366                                  msgVRAheader:
  7367 00002EAB 205652412073757070-     	db ' VRA support: '
  7367 00002EB4 6F72743A20         
  7368 00002EB9 00                      	db 0	
  7369                                  msgVRAyes:
  7370 00002EBA 5945530D0A00            	db 'YES', 0Dh, 0Ah, 0
  7371                                  msgVRAno:
  7372 00002EC0 4E4F200D0A              	db 'NO ', 0Dh, 0Ah
  7373                                  	;db ' (Interpolated sample rate playing method)'
  7374                                  	; 30/12/2024
  7375 00002EC5 2028496E746572706F-     	db ' (Interpolated samplerate play method)'
  7375 00002ECE 6C617465642073616D-
  7375 00002ED7 706C65726174652070-
  7375 00002EE0 6C6179206D6574686F-
  7375 00002EE9 6429               
  7376 00002EEB 0D0A00                  	db 0Dh, 0Ah, 0
  7377                                  
  7378 00002EEE 90<rep 2h>              align 4
  7379                                  
  7380                                  ; -------------------------------------------------------------
  7381                                  
  7382                                  	; 30/12/2024
  7383                                  PlayingScreen:
  7384 00002EF0 DBDBDBDBDBDBDBDBDB-     	db  14 dup(219), " DOS Player ", 14 dup(219)
  7384 00002EF9 DBDBDBDBDB20444F53-
  7384 00002F02 20506C6179657220DB-
  7384 00002F0B DBDBDBDBDBDBDBDBDB-
  7384 00002F14 DBDBDBDB           
  7385 00002F18 C9CDCDCDCDCDCDCDCD-     	db  201, 38 dup(205), 187
  7385 00002F21 CDCDCDCDCDCDCDCDCD-
  7385 00002F2A CDCDCDCDCDCDCDCDCD-
  7385 00002F33 CDCDCDCDCDCDCDCDCD-
  7385 00002F3C CDCDCDBB           
  7386 00002F40 BA203C53706163653E-     	db  186, " <Space> Play/Pause <N>/<P> Next/Prev ", 186
  7386 00002F49 20506C61792F506175-
  7386 00002F52 7365203C4E3E2F3C50-
  7386 00002F5B 3E204E6578742F5072-
  7386 00002F64 657620BA           
  7387 00002F68 BA203C533E20202020-     	db  186, " <S>     Stop       <Enter> Color     ", 186
  7387 00002F71 2053746F7020202020-
  7387 00002F7A 2020203C456E746572-
  7387 00002F83 3E20436F6C6F722020-
  7387 00002F8C 202020BA           
  7388 00002F90 BA203C463E20202020-     	db  186, " <F>     Forwards   <+>/<-> Volume    ", 186
  7388 00002F99 20466F727761726473-
  7388 00002FA2 2020203C2B3E2F3C2D-
  7388 00002FAB 3E20566F6C756D6520-
  7388 00002FB4 202020BA           
  7389 00002FB8 BA203C423E20202020-     	db  186, " <B>     Backwards  <Q>     Quit Prg  ", 186
  7389 00002FC1 204261636B77617264-
  7389 00002FCA 7320203C513E202020-
  7389 00002FD3 202051756974205072-
  7389 00002FDC 672020BA           
  7390 00002FE0 CCCDCDCDCDCDCDCDCD-     	db  204, 38 dup(205), 185
  7390 00002FE9 CDCDCDCDCDCDCDCDCD-
  7390 00002FF2 CDCDCDCDCDCDCDCDCD-
  7390 00002FFB CDCDCDCDCDCDCDCDCD-
  7390 00003004 CDCDCDB9           
  7391 00003008 BA2046696C653A2020-     	db  186, " File:              Bits:     0       ", 186
  7391 00003011 202020202020202020-
  7391 0000301A 202020426974733A20-
  7391 00003023 202020203020202020-
  7391 0000302C 202020BA           
  7392 00003030 BA20467265713A2030-     	db  186, " Freq: 0     Hz     Channels: 0       ", 186
  7392 00003039 2020202020487A2020-
  7392 00003042 2020204368616E6E65-
  7392 0000304B 6C733A203020202020-
  7392 00003054 202020BA           
  7393 00003058 C8CDCDCDCDCDCDCDCD-     	db  200, 38 dup(205), 188
  7393 00003061 CDCDCDCDCDCDCDCDCD-
  7393 0000306A CDCDCDCDCDCDCDCDCD-
  7393 00003073 CDCDCDCDCDCDCDCDCD-
  7393 0000307C CDCDCDBC           
  7394 00003080 202020202020202020-     	db  40 dup(32)
  7394 00003089 202020202020202020-
  7394 00003092 202020202020202020-
  7394 0000309B 202020202020202020-
  7394 000030A4 20202020           
  7395                                  improper_samplerate_txt:
  7396                                  read_error_txt:
  7397 000030A8 202020202020202020-     	db  40 dup(32)
  7397 000030B1 202020202020202020-
  7397 000030BA 202020202020202020-
  7397 000030C3 202020202020202020-
  7397 000030CC 20202020           
  7398 000030D0 202020202020202020-     	db  40 dup(32)
  7398 000030D9 202020202020202020-
  7398 000030E2 202020202020202020-
  7398 000030EB 202020202020202020-
  7398 000030F4 20202020           
  7399 000030F8 202020202020202020-     	db  40 dup(32)
  7399 00003101 202020202020202020-
  7399 0000310A 202020202020202020-
  7399 00003113 202020202020202020-
  7399 0000311C 20202020           
  7400 00003120 202020202020202020-     	db  40 dup(32)
  7400 00003129 202020202020202020-
  7400 00003132 202020202020202020-
  7400 0000313B 202020202020202020-
  7400 00003144 20202020           
  7401 00003148 202020202020202020-     	db  40 dup(32)
  7401 00003151 202020202020202020-
  7401 0000315A 202020202020202020-
  7401 00003163 202020202020202020-
  7401 0000316C 20202020           
  7402 00003170 202020202020202020-     	db  40 dup(32)
  7402 00003179 202020202020202020-
  7402 00003182 202020202020202020-
  7402 0000318B 202020202020202020-
  7402 00003194 20202020           
  7403 00003198 202020202020202020-     	db  40 dup(32)
  7403 000031A1 202020202020202020-
  7403 000031AA 202020202020202020-
  7403 000031B3 202020202020202020-
  7403 000031BC 20202020           
  7404 000031C0 202020202020202020-     	db  40 dup(32)
  7404 000031C9 202020202020202020-
  7404 000031D2 202020202020202020-
  7404 000031DB 202020202020202020-
  7404 000031E4 20202020           
  7405 000031E8 202020202020202020-     	db  40 dup(32)
  7405 000031F1 202020202020202020-
  7405 000031FA 202020202020202020-
  7405 00003203 202020202020202020-
  7405 0000320C 20202020           
  7406 00003210 202020202020202020-     	db  40 dup(32)
  7406 00003219 202020202020202020-
  7406 00003222 202020202020202020-
  7406 0000322B 202020202020202020-
  7406 00003234 20202020           
  7407 00003238 CDCDCDCDCDCDCDCDCD-     	db  40 dup(205)
  7407 00003241 CDCDCDCDCDCDCDCDCD-
  7407 0000324A CDCDCDCDCDCDCDCDCD-
  7407 00003253 CDCDCDCDCDCDCDCDCD-
  7407 0000325C CDCDCDCD           
  7408 00003260 202020202020202020-     	db  40 dup(32)
  7408 00003269 202020202020202020-
  7408 00003272 202020202020202020-
  7408 0000327B 202020202020202020-
  7408 00003284 20202020           
  7409 00003288 202020202020202020-     	db  13 dup(32), "00:00 ", 174, 175, " 00:00", 4 dup(32), "VOL 000%"
  7409 00003291 2020202030303A3030-
  7409 0000329A 20AEAF2030303A3030-
  7409 000032A3 20202020564F4C2030-
  7409 000032AC 303025             
  7410                                  	;db  40 dup(32) ; not necessary
  7411 000032AF 00                      	db 0
  7412                                  
  7413                                  ; -------------------------------------------------------------
  7414                                  
  7415                                  	; 30/12/2024
  7416                                  fillblock:
  7417 000032B0 FF<rep 8h>              	times 8 db 0FFh
  7418 000032B8 0000                    	dw 0
  7419                                  
  7420                                  ; -------------------------------------------------------------
  7421                                  
  7422                                  ; 30/12/2024
  7423                                  ; 23/11/2024
  7424                                  colors:
  7425 000032BA 0F0B0A0C0E090D          	db 0Fh, 0Bh, 0Ah, 0Ch, 0Eh, 09h, 0Dh
  7426                                  	; white, cyan, green, red, yellow, blue, magenta
  7427 000032C1 0B                      ccolor:	db 0Bh	; cyan
  7428                                  
  7429                                  EOF: 
  7430                                  
  7431                                  ; -------------------------------------------------------------
  7432                                  
  7433                                  bss:
  7434                                  
  7435                                  ABSOLUTE bss
  7436                                  
  7437 000032C2 ????                    alignb 4
  7438                                  
  7439                                  ; 24/12/2024
  7440                                  wpoints_dif:	; wave lighting points factor (differential) 
  7441 000032C4 ????????                	resd 1	; required bytes for 1/18 second wave lighting
  7442                                  graphstart:
  7443 000032C8 ????????                	resd 1	; start (top) line/row for wave lighting points 	 
  7444                                  
  7445                                  ; 30/12/2024
  7446                                  ;LFB_ADDR:
  7447                                  ;	resd 1
  7448                                  
  7449                                  ;nextrow:
  7450                                  	;resd 1
  7451                                  screenpos: ; hw = (cursor) row, lw = (cursor) column
  7452 000032CC ????????                	resd 1
  7453 000032D0 ????????                wcolor:	resd 1
  7454                                  ; 26/12/2024
  7455                                  ;tcolor: resb 1 ; text color
  7456                                  columns:
  7457 000032D4 ??                      	resb 1
  7458 000032D5 ??                      pbprev:	resb 1 ; previous progress bar indicator position
  7459                                  
  7460 000032D6 ????                    alignb 4
  7461                                  
  7462                                  bss_start:
  7463                                  
  7464                                  ; 29/12/2024
  7465                                  audio_buffer:
  7466 000032D8 ????????                	resd 1
  7467                                  
  7468                                  ; 30/12/2024
  7469                                  prev_points:
  7470 000032DC <res 500h>              	resd 320 ; previous wave points (which are lighting)	
  7471                                  
  7472                                  ; 18/11/2024
  7473                                  stopped:
  7474 000037DC ??                      	resb 1
  7475 000037DD ??                      tLO:	resb 1
  7476                                  ; 21/11/2024
  7477 000037DE ??                      tLP:	resb 1
  7478                                  ; 30/12/2024
  7479                                  wpoints:
  7480 000037DF ??                      	resb 1
  7481 000037E0 ????????                pbuf_o:	resd 1
  7482                                  ; 29/12/2024
  7483 000037E4 ????????                pbuf_s:	resd 1
  7484                                  
  7485                                  ; 07/12/2024
  7486                                  ; 24/11/2024
  7487                                  half_buffer:
  7488 000037E8 ??                      	resb 1	; dma half buffer 1 or 2 (0 or 1)
  7489                                  
  7490                                  ; 30/05/2024
  7491 000037E9 ??                      VRA:	resb 1	; Variable Rate Audio Support Status
  7492                                  
  7493                                  ; 25/12/2024
  7494                                  ; 29/11/2024
  7495                                  command:
  7496 000037EA ??                      	resb 1
  7497                                  filecount:
  7498 000037EB ??                      	resb 1
  7499                                  
  7500                                  ; 30/11/2024
  7501                                  alignb 4
  7502                                  
  7503                                  ;;;;;;;;;;;;;;
  7504                                  ; 14/11/2024
  7505                                  ; (Ref: player.asm, Matan Alfasi, 2017)  
  7506                                  WAVFILEHEADERbuff:
  7507                                  RIFF_ChunkID:
  7508 000037EC ????????                	resd 1	; Must be equal to "RIFF" - big-endian
  7509                                  		; 0x52494646
  7510                                  RIFF_ChunkSize:
  7511 000037F0 ????????                	resd 1	; Represents total file size, not 
  7512                                          	; including the first 2 fields 
  7513                                  		; (Total_File_Size - 8), little-endian
  7514                                  RIFF_Format:
  7515 000037F4 ????????                	resd 1	; Must be equal to "WAVE" - big-endian
  7516                                  		; 0x57415645
  7517                                  
  7518                                  ;; WAVE header parameters ("Sub-chunk")
  7519                                  WAVE_SubchunkID:
  7520 000037F8 ????????                	resd 1	; Must be equal to "fmt " - big-endian
  7521                                  		; 0x666d7420
  7522                                  WAVE_SubchunkSize:
  7523 000037FC ????????                	resd 1	; Represents total chunk size
  7524                                  WAVE_AudioFormat:
  7525 00003800 ????                    	resw 1	; PCM (Raw) - is 1, other - is a form 
  7526                                  		; of compression, not supported.
  7527                                  WAVE_NumChannels:
  7528 00003802 ????                    	resw 1	; Number of channels, Mono-1, Stereo-2
  7529                                  WAVE_SampleRate:
  7530 00003804 ????????                	resd 1	; Frequency rate, in Hz (8000, 44100 ...)
  7531                                  WAVE_ByteRate:
  7532 00003808 ????????                	resd 1	; SampleRate * NumChannels * BytesPerSample
  7533                                  WAVE_BlockAlign:
  7534 0000380C ????                    	resw 1	; NumChannels * BytesPerSample
  7535                                  		; Number of bytes for one sample.
  7536                                  WAVE_BitsPerSample:
  7537 0000380E ????                    	resw 1	; 8 = 8 bits, 16 = 16 bits, etc.
  7538                                  
  7539                                  ;; DATA header parameters
  7540                                  DATA_SubchunkID:
  7541 00003810 ????????                	resd 1	; Must be equal to "data" - big-endian
  7542                                          	; 0x64617461
  7543                                  DATA_SubchunkSize:
  7544 00003814 ????????                	resd 1	; NumSamples * NumChannels * BytesPerSample
  7545                                          	; Number of bytes in the data.
  7546                                  ;;;;;;;;;;;;;;
  7547                                  
  7548                                  ; 28/12/2024
  7549                                  ; 15/11/2024
  7550                                  ;cursortype:
  7551 00003818 ????                    	resw 1
  7552 0000381A ??                      flags:	resb 1
  7553                                  ; 06/11/2023
  7554                                  ac97_int_ln_reg:
  7555 0000381B ??                      	resb 1
  7556                                  filehandle:
  7557 0000381C ????????                	resd 1
  7558                                  
  7559                                  ; 25/12/2024
  7560                                  ; 30/11/2024
  7561                                  ;argc:	resb 1	; argument count
  7562 00003820 ????????                argv:	resd 1	; current argument (wav file) ptr
  7563 00003824 ????????                argvf:	resd 1	; 1st argument (wav file) ptr
  7564 00003828 ????????                argvl:	resd 1	; last argument (wav file) ptr
  7565                                  
  7566                                  ; 30/05/2024
  7567                                  wav_file_name:
  7568 0000382C <res 50h>               	resb 80	; wave file, path name (<= 80 bytes)
  7569 0000387C ????                    	resw 1	; 30/11/2024
  7570                                  
  7571                                  ; 08/11/2023
  7572                                  ; 07/11/2023
  7573                                  fbs_shift:
  7574 0000387E ??                      	resb 1
  7575                                  ; 07/12/2024
  7576 0000387F ??                      SRB:	resb 1
  7577                                  
  7578                                  ; 12/11/2016 - Erdogan Tan
  7579                                  bus_dev_fn:
  7580 00003880 ????????                	resd 1
  7581                                  dev_vendor:
  7582 00003884 ????????                	resd 1
  7583                                  
  7584                                  ; 17/02/2017
  7585                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  7586                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  7587                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  7588                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  7589 00003888 ????                    NAMBAR:	resw 1	; BAR for mixer
  7590                                  NABMBAR:
  7591 0000388A ????                    	resw 1	; BAR for bus master regs
  7592                                  
  7593                                  ; 15/11/2024
  7594                                  loadfromwavfile:
  7595 0000388C ????????                	resd 1	; 'loadfromfile' or load+conversion proc address
  7596                                  loadsize:
  7597 00003890 ????????                	resd 1	; (.wav file) read count (bytes) per one time
  7598                                  buffersize:
  7599 00003894 ????????                	resd 1	; 16 bit samples (not bytes)
  7600                                  		
  7601                                  ; 14/11/2024
  7602                                  TotalTime:
  7603 00003898 ????????                	resd 1	; Total (WAV File) Playing Time in seconds
  7604                                  ProgressTime:
  7605 0000389C ????????                	resd 1
  7606 000038A0 ????????                count:	resd 1	; byte count of one (wav file) read
  7607                                  LoadedDataBytes:
  7608 000038A4 ????????                	resd 1	; total read/load count
  7609                                  
  7610                                  timerticks:
  7611 000038A8 ????????                	resd 1	; (to eliminate excessive lookup of events in tuneloop)
  7612                                  		; (in order to get the emulator/qemu to run correctly)
  7613                                  ; 01/12/2024
  7614                                  _bdl_buffer:
  7615 000038AC ????????                	resd 1
  7616                                  
  7617                                  ; 14/11/2024
  7618                                  bss_end:
  7619                                  
  7620                                  ; 29/12/2024
  7621 000038B0 <res 750h>              alignb 4096
  7622                                  
  7623                                  ; 01/12/2024
  7624                                  BDL_BUFFER:
  7625 00004000 <res 100h>              	resb 256
  7626                                  	; 02/12/2024
  7627 00004100 <res F00h>              	resb 4096-256
  7628                                  
  7629                                  ;alignb 4096
  7630                                  
  7631                                  ; 29/05/2024
  7632                                  WAVBUFFER_1:
  7633 00005000 <res 10000h>            	resb 65536
  7634                                  WAVBUFFER_2:
  7635 00015000 <res 10000h>            	resb 65536
  7636                                  
  7637                                  ; 01/12/2024
  7638                                  ; 26/11/2023
  7639                                  temp_buffer:
  7640 00025000 <res 10000h>            	resb 65536  ;  resb BUFFERSIZE
