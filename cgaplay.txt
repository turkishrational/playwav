     1                                  ; ****************************************************************************
     2                                  ; cgaplay.s - TRDOS 386 (TRDOS v2.0.9) WAV PLAYER - Video Mode 13h
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; CGAPLAY.PRG ! AC'97 (ICH) .WAV PLAYER program by Erdogan TAN
     5                                  ;
     6                                  ; 27/12/2024				- play music from multiple wav files -
     7                                  ;
     8                                  ; [ Last Modification: 01/01/2025 ]
     9                                  ;
    10                                  ; Modified from VGAPLAY3.PRG .wav player program by Erdogan Tan, 30/12/2024
    11                                  ;
    12                                  ; ****************************************************************************
    13                                  ; nasm cgaplay.s -l cgaplay.txt -o CGAPLAY.PRG -Z error.txt
    14                                  
    15                                  ; 30/12/2024
    16                                  ; vgaplay3.s
    17                                  ; 27/12/2024
    18                                  ; vgaplay2.s : DMA buffer tracking (instead of user's audio buffer)
    19                                  ; 18/12/2024
    20                                  ; ac97play.s : TUNELOOP version (playing without AC97 interrupt)
    21                                  
    22                                  ; vgaplay.s (26/12/2024) - play music from multiple wav files -
    23                                  ; dplayvga.s (25/12/2024) - play music from single wav file -
    24                                  ; ac97play.s (18/12/2024) - play music from multiple wav files -
    25                                  
    26                                  ; 07/12/2024 - playwav9.s - interrupt (srb) + tuneloop version
    27                                  ; ------------------------------------------------------------
    28                                  ; INTERRUPT (SRB) + TUNELOOP version ; 24/11/2024 (PLAYWAV9.ASM)
    29                                  ;	(running in DOSBOX, VIRTUALBOX, QEMU is ok)
    30                                  ; Signal Response Byte = message/signal to user about an event/interrupt
    31                                  ;	    as requested (TuneLoop procedure continuously checks this SRB)
    32                                  ; (TRDOS 386 v2 feature is used here as very simple interrupt handler output)
    33                                  
    34                                  ; ------------------------------------------------------------
    35                                  
    36                                  ; 30/11/2024
    37                                  ; 20/08/2024 ; TRDOS 386 v2.0.9
    38                                  ; 29/04/2016
    39                                  _ver 	equ 0
    40                                  _exit 	equ 1
    41                                  _fork 	equ 2
    42                                  _read 	equ 3
    43                                  _write	equ 4
    44                                  _open	equ 5
    45                                  _close 	equ 6
    46                                  _wait 	equ 7
    47                                  _creat 	equ 8
    48                                  _link 	equ 9
    49                                  _unlink	equ 10
    50                                  _exec	equ 11
    51                                  _chdir	equ 12
    52                                  _time 	equ 13
    53                                  _mkdir 	equ 14
    54                                  _chmod	equ 15
    55                                  _chown	equ 16
    56                                  _break	equ 17
    57                                  _stat	equ 18
    58                                  _seek	equ 19
    59                                  _tell 	equ 20
    60                                  _mount	equ 21
    61                                  _umount	equ 22
    62                                  _setuid	equ 23
    63                                  _getuid	equ 24
    64                                  _stime	equ 25
    65                                  _quit	equ 26
    66                                  _intr	equ 27
    67                                  _fstat	equ 28
    68                                  _emt 	equ 29
    69                                  _mdate 	equ 30
    70                                  _video 	equ 31
    71                                  _audio	equ 32
    72                                  _timer	equ 33
    73                                  _sleep	equ 34
    74                                  _msg    equ 35
    75                                  _geterr	equ 36
    76                                  _fpsave	equ 37
    77                                  _pri	equ 38
    78                                  _rele	equ 39
    79                                  _fff	equ 40
    80                                  _fnf	equ 41
    81                                  _alloc	equ 42
    82                                  _dalloc equ 43
    83                                  _calbac equ 44
    84                                  _dma	equ 45
    85                                  _stdio  equ 46
    86                                  
    87                                  ; ------------------------------------------------------------
    88                                  
    89                                  %macro sys 1-4
    90                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)
    91                                      ; 03/09/2015
    92                                      ; 13/04/2015
    93                                      ; Retro UNIX 386 v1 system call.
    94                                      %if %0 >= 2
    95                                          mov ebx, %2
    96                                          %if %0 >= 3
    97                                              mov ecx, %3
    98                                              %if %0 = 4
    99                                                 mov edx, %4
   100                                              %endif
   101                                          %endif
   102                                      %endif
   103                                      mov eax, %1
   104                                      ;int 30h
   105                                      int 40h ; TRDOS 386 (TRDOS v2.0)
   106                                  %endmacro
   107                                  
   108                                  ; Retro UNIX 386 v1 system call format:
   109                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
   110                                  
   111                                  ; ------------------------------------------------------------
   112                                  
   113                                  ; player internal variables and other equates.
   114                                  BUFFERSIZE	equ 65536
   115                                  ENDOFFILE	equ 1		; flag for knowing end of file
   116                                  
   117                                  ; ------------------------------------------------------------
   118                                  
   119                                  [BITS 32] ; 32-bit intructions
   120                                  
   121                                  [ORG 0]
   122                                  
   123                                  START_CODE:
   124                                  	; Prints the Credits Text.
   125                                  	sys	_msg, Credits, 255, 0Bh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000000 BB[B02C0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000005 B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000000A BA0B000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000000F B823000000          <1>  mov eax, %1
   104                              <1> 
   105 00000014 CD40                <1>  int 40h
   126                                  
   127                                  	; clear bss
   128 00000016 BF[F8320000]            	mov	edi, bss_start
   129 0000001B B976010000              	mov	ecx, (bss_end - bss_start)/4
   130 00000020 31C0                    	xor	eax, eax
   131 00000022 F3AB                    	rep	stosd
   132                                  
   133                                  ; -------------------------------------------------------------
   134                                  
   135                                  	; 21/12/2024
   136                                  	; Detect (& Enable) AC'97 Audio Device
   137 00000024 E88C070000              	call	DetectAC97
   138 00000029 731B                    	jnc	short ac97_hardware_ready
   139                                  
   140                                  	; 30/11/2024
   141                                  	; 30/05/2024
   142                                  _dev_not_ready:
   143                                  	; couldn't find the audio device!
   144                                  	sys	_msg, noDevMsg, 255, 0Fh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000002B BB[522D0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000030 B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00000035 BA0F000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000003A B823000000          <1>  mov eax, %1
   104                              <1> 
   105 0000003F CD40                <1>  int 40h
   145 00000041 E973040000                      jmp     Exit
   146                                  
   147                                  ac97_hardware_ready:
   148 00000046 E8A10D0000              	call	write_audio_dev_info
   149                                  
   150                                  ; -------------------------------------------------------------
   151                                  
   152                                  	; 30/12/2024
   153                                  	;;;
   154                                  	; DIRECT VGA MEMORY ACCESS
   155                                  	; bl = 0, bh = 5
   156                                  	; Direct access/map to VGA memory (0A0000h)
   157                                  
   158                                  	sys	_video, 0500h
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000004B BB00050000          <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97                              <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000050 B81F000000          <1>  mov eax, %1
   104                              <1> 
   105 00000055 CD40                <1>  int 40h
   159 00000057 3D00000A00              	cmp	eax, 0A0000h
   160 0000005C 7405                    	je	short _a
   161                                  
   162                                  	; 30/12/2024
   163 0000005E E99E040000              	jmp	trdos386_error
   164                                  
   165                                  _a:
   166                                  	;; Set Video Mode to 13h
   167                                  	;sys	_video, 0813h
   168                                  	;cmp	eax, 14h 
   169                                  	;je	short mode_13h_set_ok
   170                                  
   171                                  	; set VGA mode by using int 31h
   172 00000063 66B81300                	mov	ax, 13h	; mode 13h ; 
   173 00000067 CD31                    	int	31h	; real mode: int 10h
   174                                  
   175                                  ; -------------------------------------------------------------
   176                                  
   177                                  mode_13h_set_ok:
   178                                  	; 30/12/2024
   179                                  	; 24/12/2024 (setting for wave lighting points)
   180                                  	;mov	eax, 0A0000h
   181                                  	;;add	eax, 12*8*320
   182                                  	;add	eax, (13*8*320)+(2*320)
   183                                  			; wave graphics start (top) line/row
   184                                  			; 64 volume levels
   185                                  	;mov	[graphstart], eax
   186                                  	; 30/12/2024
   187                                  	;mov	dword [graphstart], 0A0000h+(13*8*320)+(4*320)
   188                                  	; 01/01/2025
   189 00000069 C705[E8320000]0073-     	mov	dword [graphstart], 0A0000h+(11*8*320)+(4*320)
   189 00000071 0A00               
   190                                  
   191                                  ; -------------------------------------------------------------
   192                                  
   193                                  	; 25/12/2024
   194                                  	; 28/11/2024
   195                                  Player_InitalizePSP:
   196                                  	; 30/11/2024
   197                                  	; (TRDOS 386 -Retro UNIX 386- argument transfer method)
   198                                  	; (stack: argc,argv0addr,argv1addr,argv2addr ..
   199                                  	;			.. argv0text, argv1text ..) 
   200                                  	; ---- argc, argv[] ----
   201 00000073 89E6                    	mov	esi, esp
   202 00000075 AD                      	lodsd
   203 00000076 83F802                  	cmp	eax, 2 ; two arguments 
   204                                  		; (program file name & mod file name)
   205 00000079 0F8243040000            	jb	pmsg_usage ; nothing to do
   206                                  	;mov	[argc], al
   207 0000007F C1E002                  	shl	eax, 2 ; *4
   208 00000082 01E0                    	add	eax, esp
   209                                  	; eax = last argument's address pointer
   210 00000084 A3[48380000]            	mov	[argvl], eax ; last wav file (argument)
   211 00000089 8935[40380000]          	mov	[argv], esi ; current argument (PRG file name)
   212 0000008F AD                      	lodsd	; skip program (PRG) file name
   213 00000090 8935[44380000]          	mov	[argvf], esi ; 1st wav file (argument)
   214                                  
   215                                  	; 30/12/2024
   216                                  Player_ParseParameters:
   217 00000096 EB2A                    	jmp	short Player_ParseNextParameter
   218                                  	; 25/12/2024
   219                                  check_p_command:
   220                                  	; 07/12/2024
   221 00000098 8B35[40380000]          	mov	esi, [argv]
   222                                  	;
   223 0000009E 803D[0A380000]50          	cmp	byte [command], 'P'
   224 000000A5 7410                    	je	short Player_ParsePreviousParameter
   225                                      
   226                                  	; 07/12/2024
   227                                  	; 30/11/2024
   228                                  	;mov	esi, [argv] ; current argument (wav file) ptr
   229 000000A7 83C604                  	add	esi, 4
   230 000000AA 3B35[48380000]          	cmp	esi, [argvl] ; last argument (wav file) ptr
   231 000000B0 7610                    	jna	short Player_ParseNextParameter
   232                                  jmp_Player_Quit:
   233 000000B2 E9CE040000              	jmp	Player_Quit
   234                                  
   235                                  Player_ParsePreviousParameter:
   236                                  	; 29/11/2024
   237                                  	;mov	byte [command], 0
   238                                  	; 30/11/2024
   239                                  	;mov	esi, [argv] ; 07/12/2024	
   240 000000B7 3B35[44380000]          	cmp	esi, [argvf] ; first argument (wav file) ptr
   241 000000BD 7603                    	jna	short Player_ParseNextParameter
   242 000000BF 83EE04                  	sub	esi, 4
   243                                  Player_ParseNextParameter:
   244                                  	; 30/11/2024
   245 000000C2 8935[40380000]          	mov	[argv], esi  ; set as current argument
   246                                  
   247                                  	; 01/12/2024
   248 000000C8 8B36                    	mov	esi, [esi]
   249                                  
   250                                  	; 30/12/2024
   251                                  	; 29/11/2024
   252 000000CA E83C000000              	call	GetFileName
   253                                  	;jcxz	jmp_Player_Quit
   254 000000CF E3E1                    	jecxz	jmp_Player_Quit ; 30/11/2024
   255                                  
   256                                  	; 30/12/2024
   257                                          ; open existing file
   258                                  	; 28/11/2024
   259 000000D1 BA[4C380000]            	mov	edx, wav_file_name
   260 000000D6 E82A070000                      call	openFile ; no error? ok.
   261 000000DB 7376                            jnc	getwavparms	; 14/11/2024
   262                                  
   263                                  	; 29/11/2024
   264 000000DD 803D[0B380000]00        	cmp	byte [filecount], 0
   265 000000E4 77B2                    	ja	short check_p_command
   266                                  
   267                                  	; 25/12/2024
   268                                  	; 21/12/2024
   269 000000E6 E892040000              	call	set_text_mode
   270                                  	; file not found!
   271                                  	; 30/11/2024
   272                                  	sys	_msg, noFileErrMsg, 255, 0Ch
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000000EB BB[7D2D0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000000F0 B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000000F5 BA0C000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000000FA B823000000          <1>  mov eax, %1
   104                              <1> 
   105 000000FF CD40                <1>  int 40h
   273 00000101 E9B3030000                      jmp     Exit
   274                                  
   275                                  _exit_:
   276 00000106 E9A9030000              	jmp	terminate
   277                                  
   278                                  ; -------------------------------------------------------------
   279                                  
   280                                  	; 26/12/2024
   281                                  	; 25/12/2024
   282                                  	; 30/11/2024 (32bit)
   283                                  	; 29/11/2024
   284                                  	; 30/05/2024
   285                                  GetFileName:
   286 0000010B BF[4C380000]            	mov	edi, wav_file_name 
   287                                  	; 30/11/2024
   288                                  	;mov	esi, [argv]
   289 00000110 31C9                    	xor	ecx, ecx ; 0
   290                                  ScanName:
   291 00000112 AC                      	lodsb
   292                                  	;test	al, al
   293                                  	;jz	short a_4
   294                                  	; 29/11/2024
   295 00000113 3C0D                    	cmp	al, 0Dh
   296 00000115 7638                    	jna	short a_4
   297 00000117 3C20                    	cmp	al, 20h
   298 00000119 74F7                    	je	short ScanName	; scan start of name.
   299 0000011B AA                      	stosb
   300 0000011C B4FF                    	mov	ah, 0FFh
   301                                  	;;;
   302                                  	; 14/11/2024
   303                                  	; (max. path length = 64 bytes for MSDOS ?) (*)
   304                                  	;xor	ecx, ecx ; 0
   305                                  	;;;
   306                                  a_0:	
   307 0000011E FEC4                    	inc	ah
   308                                  a_1:
   309                                  	;;;
   310                                  	; 14/11/2024
   311 00000120 41                      	inc	ecx
   312                                  	;;;
   313 00000121 AC                      	lodsb
   314 00000122 AA                      	stosb
   315 00000123 3C2E                    	cmp	al, '.'
   316 00000125 74F7                    	je	short a_0
   317                                  	; 29/11/2024
   318 00000127 3C20                    	cmp	al, 20h
   319                                  	;and	al, al
   320                                  	;jnz	short a_1
   321                                  	;;;
   322                                  	; 14/11/2024
   323 00000129 7613                    	jna	short a_3
   324 0000012B 20E4                    	and	ah, ah
   325 0000012D 7406                    	jz	short a_2
   326 0000012F 3C2F                    	cmp	al, '/'	; 14/12/2024
   327 00000131 7502                    	jne	short a_2
   328 00000133 B400                    	mov	ah, 0
   329                                  a_2:
   330 00000135 80F94B                  	cmp	cl, 75	; 64+8+'.'+3 -> offset 75 is the last chr
   331 00000138 72E6                    	jb	short a_1
   332                                  	; 29/11/2024
   333 0000013A 29C9                    	sub	ecx, ecx
   334 0000013C EB11                    	jmp	short a_4
   335                                  a_3:
   336                                  	; 29/11/2024
   337 0000013E 4F                      	dec	edi
   338                                  	;;;
   339 0000013F 08E4                    	or	ah, ah		; if period NOT found,
   340 00000141 750C                    	jnz	short a_4 	; then add a .WAV extension.
   341                                  SetExt:
   342                                  	; 29/11/2024
   343                                  	;dec	edi
   344 00000143 C7072E574156            	mov	dword [edi], '.WAV'
   345                                  				; ! 64+12 is DOS limit
   346                                  				; but writing +4 must not
   347                                  				; destroy the following data	 
   348                                  	;mov	byte [edi+4], 0	; so, 80 bytes path + 0 is possible here
   349                                  	; 29/11/2024
   350 00000149 83C104                  	add	ecx, 4
   351 0000014C 83C704                  	add	edi, 4
   352                                  a_4:	
   353 0000014F C60700                  	mov	byte [edi], 0
   354                                  	; 30/11/2024
   355 00000152 C3                      	retn
   356                                  
   357                                  ; -------------------------------------------------------------
   358                                  
   359                                  getwavparms:
   360                                  	; 14/11/2024
   361 00000153 E8DF060000                     	call    getWAVParameters
   362 00000158 72AC                    	jc	short _exit_		; nothing to do
   363                                  
   364                                  	; 17/11/2024
   365 0000015A B304                    	mov	bl, 4
   366 0000015C 2A1D[2C380000]          	sub	bl, byte [WAVE_BlockAlign]
   367                                  			; = 0 for 16 bit stereo
   368                                  			; = 2 for 8 bit stereo or 16 bit mono
   369                                  			; = 3 for 8 bit mono	
   370                                  
   371 00000162 D0EB                    	shr	bl, 1	;  0 -->  0,  2 -->  1,  3 -->  1
   372                                  	; 15/11/2024
   373 00000164 80D300                  	adc	bl, 0	; 3 --> 1 --> 2
   374 00000167 881D[9E380000]          	mov	byte [fbs_shift], bl	; = 2 mono and 8 bit
   375                                  					; = 0 stereo and 16 bit
   376                                  					; = 1 mono or 8 bit
   377                                  	; 29/12/2024
   378                                  	; 30/05/2024
   379 0000016D E826080000              	call	codecConfig		; unmute codec, set rates.
   380 00000172 0F8267030000            	jc	init_err
   381                                  
   382                                  ; -------------------------------------------------------------
   383                                  
   384                                  StartPlay:
   385                                  	; 30/12/2024
   386 00000178 C605[FF370000]01        	mov	byte [wpoints], 1
   387                                  
   388                                  	;;;
   389                                  	; 09/12/2024
   390 0000017F B834290000              	mov	eax, 10548 ; (48000*10/182)*4
   391 00000184 803D[09380000]00        	cmp	byte [VRA], 0
   392 0000018B 7614                    	jna	short _w ; 48kHZ (interpolation)
   393                                  	;
   394 0000018D 66A1[24380000]          	mov	ax, [WAVE_SampleRate]
   395 00000193 B90A000000              	mov	ecx, 10
   396 00000198 F7E1                    	mul	ecx
   397 0000019A B1B6                    	mov	cl, 182
   398 0000019C F7F1                    	div	ecx
   399                                  	; ax = samples per 1/18.2 second
   400                                  	;mov	cl, byte [WAVE_BlockAlign]
   401                                  	; 09/12/2024 
   402                                  	;mov	cl, 4 ; 16 bit, stereo
   403                                  	;mul	ecx
   404 0000019E C1E002                  	shl	eax, 2 ; * 4
   405                                  _w:
   406 000001A1 A3[E4320000]            	mov	[wpoints_dif], eax ; buffer read differential (distance)
   407                                  				; for wave volume leds update
   408                                  				; (byte stream per 1/18.2 second)
   409                                  
   410                                  ; -------------------------------------------------------------
   411                                  
   412                                  	; 25/12/2024
   413 000001A6 FE05[0B380000]          	inc	byte [filecount]
   414 000001AC C605[0A380000]00        	mov	byte [command], 0
   415                                  	; 30/12/2024
   416 000001B3 C605[F5320000]FF        	mov	byte [pbprev], -1
   417                                  
   418                                  ; -------------------------------------------------------------
   419                                  
   420                                  	; 07/12/2024 (playwav9.s)
   421                                  
   422                                  	; 18/11/2023 (ich_wav4.asm)
   423                                  	; 13/11/2023 (ich_wav3.asm)
   424                                  
   425 000001BA 803D[09380000]01        	cmp	byte [VRA], 1
   426 000001C1 7226                    	jb	short chk_sample_rate
   427                                  
   428                                  playwav_48_khz:
   429 000001C3 C705[AC380000]-         	mov	dword [loadfromwavfile], loadFromFile
   429 000001C9 [1E0D0000]         
   430                                  	;mov	dword [loadsize], 0 ; 65536
   431                                  	;;;
   432                                  	; 17/11/2024
   433                                  	;mov	word [buffersize], 32768
   434                                  	;mov	ax, BUFFERSIZE/2 ; 32760
   435                                  	; 30/11/2024
   436                                  	;mov	eax, BUFFERSIZE/2 ; 32768
   437                                  	; 07/12/2024
   438 000001CD B800000100              	mov	eax, BUFFERSIZE ; 65536
   439 000001D2 A3[B4380000]            	mov	[buffersize], eax	; 16 bit samples
   440                                  	; 07/12/2024
   441                                  	;shl	eax, 1			; bytes
   442 000001D7 8A0D[9E380000]          	mov	cl, [fbs_shift]
   443 000001DD D3E8                    	shr	eax, cl 
   444                                  	;mov	[loadsize], ax ; 16380 or 32760 or 65520
   445 000001DF A3[B0380000]            	mov	[loadsize], eax ; 16384 or 32768 or 65536
   446                                  	;;;
   447                                  	;jmp	PlayNow ; 30/05/2024
   448                                  	; 07/12/2024
   449 000001E4 E95D020000              	jmp	Player_Template
   450                                  
   451                                  chk_sample_rate:
   452                                  	; set conversion parameters
   453                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   454 000001E9 66A1[24380000]          	mov	ax, [WAVE_SampleRate]
   455 000001EF 663D80BB                	cmp	ax, 48000
   456 000001F3 74CE                    	je	short playwav_48_khz
   457                                  chk_22khz:
   458 000001F5 663D2256                	cmp	ax, 22050
   459 000001F9 7545                    	jne	short chk_11khz
   460 000001FB 803D[2E380000]08        	cmp	byte [WAVE_BitsPerSample], 8
   461 00000202 7615                    	jna	short chk_22khz_1
   462 00000204 BB[FE1C0000]            	mov	ebx, load_22khz_stereo_16_bit
   463 00000209 803D[22380000]01        	cmp	byte [WAVE_NumChannels], 1
   464 00000210 751A                    	jne	short chk_22khz_2
   465 00000212 BB[6B1C0000]            	mov	ebx, load_22khz_mono_16_bit
   466 00000217 EB13                    	jmp	short chk_22khz_2
   467                                  chk_22khz_1:
   468 00000219 BB[DE1B0000]            	mov	ebx, load_22khz_stereo_8_bit
   469 0000021E 803D[22380000]01        	cmp	byte [WAVE_NumChannels], 1
   470 00000225 7505                    	jne	short chk_22khz_2
   471 00000227 BB[4F1B0000]            	mov	ebx, load_22khz_mono_8_bit
   472                                  chk_22khz_2:
   473 0000022C B85A1D0000              	mov	eax, 7514  ; (442*17)
   474 00000231 BA25000000              	mov	edx, 37
   475 00000236 B911000000              	mov	ecx, 17
   476 0000023B E9D9010000              	jmp	set_sizes
   477                                  chk_11khz:
   478 00000240 663D112B                	cmp	ax, 11025
   479 00000244 7545                    	jne	short chk_44khz
   480 00000246 803D[2E380000]08        	cmp	byte [WAVE_BitsPerSample], 8
   481 0000024D 7615                    	jna	short chk_11khz_1
   482 0000024F BB[321F0000]            	mov	ebx, load_11khz_stereo_16_bit
   483 00000254 803D[22380000]01        	cmp	byte [WAVE_NumChannels], 1
   484 0000025B 751A                    	jne	short chk_11khz_2
   485 0000025D BB[B31E0000]            	mov	ebx, load_11khz_mono_16_bit
   486 00000262 EB13                    	jmp	short chk_11khz_2
   487                                  chk_11khz_1:
   488 00000264 BB[2E1E0000]            	mov	ebx, load_11khz_stereo_8_bit
   489 00000269 803D[22380000]01        	cmp	byte [WAVE_NumChannels], 1 
   490 00000270 7505                    	jne	short chk_11khz_2
   491 00000272 BB[B51D0000]            	mov	ebx, load_11khz_mono_8_bit
   492                                  chk_11khz_2:
   493 00000277 B8AD0E0000              	mov	eax, 3757  ; (221*17)
   494 0000027C BA4A000000              	mov	edx, 74
   495 00000281 B911000000              	mov	ecx, 17
   496 00000286 E98E010000              	jmp	set_sizes
   497                                  chk_44khz:
   498 0000028B 663D44AC                	cmp	ax, 44100
   499 0000028F 7545                    	jne	short chk_16khz
   500 00000291 803D[2E380000]08        	cmp	byte [WAVE_BitsPerSample], 8
   501 00000298 7615                    	jna	short chk_44khz_1
   502 0000029A BB[71210000]            	mov	ebx, load_44khz_stereo_16_bit
   503 0000029F 803D[22380000]01        	cmp	byte [WAVE_NumChannels], 1
   504 000002A6 751A                    	jne	short chk_44khz_2
   505 000002A8 BB[F2200000]            	mov	ebx, load_44khz_mono_16_bit
   506 000002AD EB13                    	jmp	short chk_44khz_2
   507                                  chk_44khz_1:
   508 000002AF BB[6F200000]            	mov	ebx, load_44khz_stereo_8_bit
   509 000002B4 803D[22380000]01        	cmp	byte [WAVE_NumChannels], 1
   510 000002BB 7505                    	jne	short chk_44khz_2
   511 000002BD BB[ED1F0000]            	mov	ebx, load_44khz_mono_8_bit
   512                                  chk_44khz_2:
   513                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   514 000002C2 B8D93A0000              	mov	eax, 15065 ; (655*23)
   515                                  	; 18/11/2023 ((file size + bss + stack) <= 64KB)
   516                                  	;mov	ax, 14076 ; (612*23)
   517                                  	; 17/11/2024
   518                                  	;mov	ax, 12650 ; (550*23)
   519 000002C7 BA19000000              	mov	edx, 25
   520 000002CC B917000000              	mov	ecx, 23
   521 000002D1 E943010000              	jmp	set_sizes
   522                                  chk_16khz:
   523 000002D6 663D803E                	cmp	ax, 16000
   524 000002DA 7545                    	jne	short chk_8khz
   525 000002DC 803D[2E380000]08        	cmp	byte [WAVE_BitsPerSample], 8
   526 000002E3 7615                    	jna	short chk_16khz_1
   527 000002E5 BB[5E160000]            	mov	ebx, load_16khz_stereo_16_bit
   528 000002EA 803D[22380000]01        	cmp	byte [WAVE_NumChannels], 1 
   529 000002F1 751A                    	jne	short chk_16khz_2
   530 000002F3 BB[D7150000]            	mov	ebx, load_16khz_mono_16_bit
   531 000002F8 EB13                    	jmp	short chk_16khz_2
   532                                  chk_16khz_1:
   533 000002FA BB[17150000]            	mov	ebx, load_16khz_stereo_8_bit
   534 000002FF 803D[22380000]01        	cmp	byte [WAVE_NumChannels], 1
   535 00000306 7505                    	jne	short chk_16khz_2
   536 00000308 BB[92140000]            	mov	ebx, load_16khz_mono_8_bit
   537                                  chk_16khz_2:
   538                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   539 0000030D B855150000              	mov	eax, 5461
   540                                  	; 17/11/2024
   541                                  	;mov	ax, 5460
   542 00000312 BA03000000              	mov	edx, 3
   543 00000317 B901000000              	mov	ecx, 1
   544 0000031C E9F8000000              	jmp	set_sizes
   545                                  chk_8khz:
   546 00000321 663D401F                	cmp	ax, 8000
   547 00000325 7545                    	jne	short chk_24khz
   548 00000327 803D[2E380000]08        	cmp	byte [WAVE_BitsPerSample], 8
   549 0000032E 7615                    	jna	short chk_8khz_1
   550 00000330 BB[41130000]            	mov	ebx, load_8khz_stereo_16_bit
   551 00000335 803D[22380000]01        	cmp	byte [WAVE_NumChannels], 1
   552 0000033C 751A                    	jne	short chk_8khz_2
   553 0000033E BB[6B120000]            	mov	ebx, load_8khz_mono_16_bit
   554 00000343 EB13                    	jmp	short chk_8khz_2
   555                                  chk_8khz_1:
   556 00000345 BB[35110000]            	mov	ebx, load_8khz_stereo_8_bit
   557 0000034A 803D[22380000]01        	cmp	byte [WAVE_NumChannels], 1 
   558 00000351 7505                    	jne	short chk_8khz_2
   559 00000353 BB[47100000]            	mov	ebx, load_8khz_mono_8_bit
   560                                  chk_8khz_2:
   561 00000358 B8AA0A0000              	mov	eax, 2730
   562 0000035D BA06000000              	mov	edx, 6
   563 00000362 B901000000              	mov	ecx, 1
   564 00000367 E9AD000000              	jmp	set_sizes
   565                                  chk_24khz:
   566 0000036C 663DC05D                	cmp	ax, 24000
   567 00000370 7561                    	jne	short chk_32khz
   568 00000372 803D[2E380000]08        	cmp	byte [WAVE_BitsPerSample], 8
   569 00000379 7613                    	jna	short chk_24khz_1
   570 0000037B 66BB[A018]              	mov	bx, load_24khz_stereo_16_bit
   571 0000037F 803D[22380000]01        	cmp	byte [WAVE_NumChannels], 1 
   572 00000386 7519                    	jne	short chk_24khz_2
   573 00000388 66BB[3718]              	mov	bx, load_24khz_mono_16_bit
   574 0000038C EB13                    	jmp	short chk_24khz_2
   575                                  chk_24khz_1:
   576 0000038E BB[A7170000]            	mov	ebx, load_24khz_stereo_8_bit
   577 00000393 803D[22380000]01        	cmp	byte [WAVE_NumChannels], 1 
   578 0000039A 7505                    	jne	short chk_24khz_2
   579 0000039C BB[3A170000]            	mov	ebx, load_24khz_mono_8_bit
   580                                  chk_24khz_2:
   581                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   582 000003A1 B800200000              	mov	eax, 8192
   583                                  	; 17/11/2024
   584                                  	;mov	ax, 8190
   585 000003A6 BA02000000              	mov	edx, 2
   586 000003AB B901000000              	mov	ecx, 1
   587 000003B0 EB67                    	jmp	short set_sizes
   588                                  
   589                                  	; 07/12/2024
   590                                  vra_needed:
   591                                  	; 30/11/2024 (TRDOS 386, ax -> eax)
   592                                  	; 13/11/2023
   593 000003B2 58                      	pop	eax ; discard return address to the caller
   594                                  	; 30/05/2024
   595                                  vra_err:
   596                                  	; 21/12/2024
   597 000003B3 E8C5010000              	call	set_text_mode
   598                                  	; 30/11/2024
   599                                  	sys	_msg, msg_no_vra, 255, 0Fh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000003B8 BB[E72D0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000003BD B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000003C2 BA0F000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000003C7 B823000000          <1>  mov eax, %1
   104                              <1> 
   105 000003CC CD40                <1>  int 40h
   600 000003CE E9E6000000              	jmp	Exit
   601                                  
   602                                  chk_32khz:
   603 000003D3 663D007D                	cmp	ax, 32000
   604 000003D7 75D9                    	jne	short vra_needed
   605 000003D9 803D[2E380000]08        	cmp	byte [WAVE_BitsPerSample], 8
   606 000003E0 7615                    	jna	short chk_32khz_1
   607 000003E2 BB[B91A0000]            	mov	ebx, load_32khz_stereo_16_bit
   608 000003E7 803D[22380000]01        	cmp	byte [WAVE_NumChannels], 1
   609 000003EE 751A                    	jne	short chk_32khz_2
   610 000003F0 BB[491A0000]            	mov	ebx, load_32khz_mono_16_bit
   611 000003F5 EB13                    	jmp	short chk_32khz_2
   612                                  chk_32khz_1:
   613 000003F7 BB[A6190000]            	mov	ebx, load_32khz_stereo_8_bit
   614 000003FC 803D[22380000]01        	cmp	byte [WAVE_NumChannels], 1
   615 00000403 7505                    	jne	short chk_32khz_2
   616 00000405 BB[2D190000]            	mov	ebx, load_32khz_mono_8_bit
   617                                  chk_32khz_2:
   618                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   619 0000040A B8AA2A0000              	mov	eax, 10922
   620                                  	; 17/11/2024
   621                                  	;mov	ax, 10920
   622 0000040F BA03000000              	mov	edx, 3
   623 00000414 B902000000              	mov	ecx, 2
   624                                  	;jmp	short set_sizes
   625                                  set_sizes:
   626                                  	; 30/11/2024 (TRDOS 386, 32bit DOS)
   627                                  	;;;
   628                                  	; 17/11/2024
   629 00000419 51                      	push	ecx
   630 0000041A B102                    	mov	cl, 2
   631 0000041C 2A0D[9E380000]          	sub	cl, [fbs_shift]
   632                                  		; = 2 for 16 bit stereo
   633                                  		; = 1 for 16 bit mono or 8 bit stereo
   634                                  		; = 0 for 8 bit mono
   635 00000422 D3E0                    	shl	eax, cl
   636 00000424 59                      	pop	ecx	
   637 00000425 A3[B0380000]            	mov	[loadsize], eax	; (one) read count in bytes
   638                                  	;;;
   639 0000042A F7E2                    	mul	edx
   640 0000042C 83F901                  	cmp	ecx, 1
   641 0000042F 7402                    	je	short s_2
   642                                  s_1:
   643 00000431 F7F1                    	div	ecx
   644                                  s_2:
   645                                  	;;;
   646                                  	; eax = byte count of (to be) converted samples 
   647                                  	
   648                                  	; 17/11/2024
   649                                  	;;;
   650 00000433 8A0D[9E380000]          	mov	cl, [fbs_shift]
   651                                  
   652 00000439 D3E0                    	shl	eax, cl
   653                                  		; *1 for 16 bit stereo
   654                                  		; *2 for 16 bit mono or 8 bit stereo
   655                                  		; *4 for for 8 bit mono
   656                                  	;;;
   657                                  
   658                                  	; eax = 16 bit stereo byte count (target buffer size)
   659                                  	
   660                                  	; 07/12/2024
   661                                  	;shr	eax, 1	; buffer size is 16 bit sample count
   662 0000043B A3[B4380000]            	mov	[buffersize], eax ; buffer size in bytes
   663 00000440 891D[AC380000]          	mov	[loadfromwavfile], ebx
   664                                  
   665                                  ; -------------------------------------------------------------
   666                                  
   667                                  	; 30/12/2024
   668                                  Player_Template:
   669                                  	; 21/12/2024
   670 00000446 E8DF000000              	call	clearscreen
   671 0000044B E8E9000000              	call	drawplayingscreen
   672                                  
   673                                  	; 14/11/2024
   674 00000450 E82E250000              	call	SetTotalTime
   675 00000455 E8FB250000              	call	UpdateFileInfo
   676                                  
   677                                  ; -------------------------------------------------------------
   678                                  
   679                                  	; 30/12/2024 (cgaplay.s)
   680                                  	; 29/12/2024 (vgaplay3.s)
   681                                  	; 18/12/2024 (ac97play.s)
   682                                  PlayNow:
   683                                  	; 01/12/2024 (32bit)
   684                                  	; 14/11/2024
   685                                  	;mov	al, 3	; 0 = max, 31 = min
   686                                  	; 14/12/2024
   687 0000045A A0[66290000]            	mov	al, [volume]
   688 0000045F E83D030000              	call	SetPCMOutVolume@
   689                                  	; 15/11/2024
   690                                  	;;call	SetMasterVolume
   691                                  	;call	SetPCMOutVolume
   692                                  
   693                                  	;;;
   694                                  	; 14/11/2024
   695 00000464 E8F2260000              	call	UpdateProgressBar
   696                                  	;;;
   697                                  
   698                                   	; 30/05/2024
   699                                  	; playwav4.asm
   700                                  _2:	
   701 00000469 E895240000              	call	check4keyboardstop	; flush keyboard buffer
   702 0000046E 72F9                    	jc	short _2		; 07/11/2023
   703                                  
   704                                  ; play the .wav file. Most of the good stuff is in here.
   705                                  
   706                                  	; 05/12/2024
   707                                  	; 02/12/2024
   708                                  	;mov	eax, [_bdl_buffer]	; BDL_BUFFER physical address
   709                                  ;_3:
   710 00000470 E815010000              	call    PlayWav
   711                                  
   712                                  	; 30/12/2024
   713                                  	; 29/12/2024 (vgaplay3.s)
   714                                  	; 27/12/2024 (vgaplay.s)
   715                                  _3:
   716                                  
   717                                  ; close the .wav file and exit.
   718                                  
   719                                  	; 25/12/2024
   720 00000475 E8A6030000              	call	closeFile
   721                                  
   722                                  	; 25/12/2024
   723                                  	;;;
   724                                  	; reset file loading and EOF parameters
   725                                  	; 18/12/2024
   726 0000047A C705[C0380000]0000-     	mov	dword [count], 0
   726 00000482 0000               
   727 00000484 C705[C4380000]0000-     	mov	dword [LoadedDataBytes], 0
   727 0000048C 0000               
   728 0000048E C605[3A380000]00        	mov	byte [flags], 0
   729 00000495 C605[FC370000]00        	mov	byte [stopped], 0
   730                                  	; 29/12/2024
   731 0000049C C705[04380000]0000-     	mov	dword [pbuf_s], 0
   731 000004A4 0000               
   732                                  	;;;
   733                                  
   734 000004A6 803D[0A380000]51        	cmp	byte [command], 'Q'
   735 000004AD 7405                    	je	short terminate
   736 000004AF E9E4FBFFFF              	jmp	check_p_command
   737                                  
   738                                  terminate:
   739 000004B4 E8C4000000              	call	set_text_mode
   740                                  Exit:
   741                                  	sys	_exit
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95                              <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97                              <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000004B9 B801000000          <1>  mov eax, %1
   104                              <1> 
   105 000004BE CD40                <1>  int 40h
   742                                  halt:
   743 000004C0 EBFE                    	jmp	short halt
   744                                  
   745                                  ; -------------------------------------------------------------
   746                                  
   747                                  	; 30/05/2024
   748                                  pmsg_usage:
   749                                  	; 21/12/2024
   750 000004C2 E8B6000000              	call	set_text_mode
   751                                  	; 01/12/2024
   752                                  	sys	_msg, msg_usage, 255, 0Fh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000004C7 BB[232D0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000004CC B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000004D1 BA0F000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000004D6 B823000000          <1>  mov eax, %1
   104                              <1> 
   105 000004DB CD40                <1>  int 40h
   753 000004DD EBDA                    	jmp	short Exit
   754                                  
   755                                  ; -------------------------------------------------------------
   756                                  
   757                                  	; 30/05/2024
   758                                  init_err:
   759                                  	; 21/12/2024
   760 000004DF E899000000              	call	set_text_mode
   761                                  	; 01/12/2024
   762                                  	sys	_msg, msg_init_err, 255, 0Fh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000004E4 BB[B62D0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000004E9 B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000004EE BA0F000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000004F3 B823000000          <1>  mov eax, %1
   104                              <1> 
   105 000004F8 CD40                <1>  int 40h
   763 000004FA EBBD                    	jmp	short Exit
   764                                  
   765                                  ; -------------------------------------------------------------
   766                                  
   767                                  	; 07/12/2024
   768                                  error_exit:
   769                                  	; 21/12/2024
   770 000004FC E87C000000              	call	set_text_mode
   771                                  trdos386_error:
   772                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000501 BB[962D0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000506 B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000050B BA0E000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000510 B823000000          <1>  mov eax, %1
   104                              <1> 
   105 00000515 CD40                <1>  int 40h
   773 00000517 EBA0                    	jmp	short Exit
   774                                  
   775                                  ; -------------------------------------------------------------
   776                                  
   777                                  	; 21/12/2024
   778                                  print_msg:
   779 00000519 B40E                    	mov	ah, 0Eh
   780 0000051B BB07000000              	mov	ebx, 7
   781                                  	;mov	bl, 7 ; char attribute & color
   782                                  p_next_chr:
   783 00000520 AC                      	lodsb
   784 00000521 08C0                    	or	al, al
   785 00000523 7404                    	jz	short p_retn ; retn
   786 00000525 CD31                    	int	31h
   787 00000527 EBF7                    	jmp	short p_next_chr
   788                                  p_retn:
   789 00000529 C3                      	retn
   790                                  
   791                                  ; -------------------------------------------------------------
   792                                  
   793                                  	; 30/12/2024
   794                                  clearscreen:
   795                                  	; fast clear
   796                                  	; 320*200, 256 colors
   797 0000052A BF00000A00              	mov	edi, 0A0000h
   798 0000052F B9803E0000              	mov	ecx, (320*200*1)/4
   799 00000534 31C0                    	xor	eax, eax
   800 00000536 F3AB                    	rep	stosd
   801 00000538 C3                      	retn
   802                                  
   803                                  ; -------------------------------------------------------------
   804                                  
   805                                  	; 30/12/2024 (VGA Mode 13h, 320*200 pixels, 256 colors)
   806                                  	; 26/12/2024
   807                                  	; 21/12/2024
   808                                  drawplayingscreen:
   809 00000539 BD[102F0000]            	mov	ebp, PlayingScreen
   810                                  	;mov	esi, 0 ; row 0, column 0
   811 0000053E BE00000200              	mov	esi, 00020000h ; row 2, column 0 ; top margin = 2
   812                                  p_d_x:
   813 00000543 C605[F4320000]28        	mov	byte [columns], 40
   814 0000054A B601                    	mov	dh, 01h ; 8x8 system font
   815                                  p_d_x_n:
   816 0000054C 8A5500                  	mov	dl, [ebp]
   817 0000054F 20D2                    	and	dl, dl
   818 00000551 7429                    	jz	short p_d_x_ok
   819                                  
   820                                  	; sysvideo system call
   821                                  	; BH = 01h = VGA graphics (0A0000h) data transfers
   822                                  	; BL = 0Fh = write character/font
   823                                  	; DH = 01h = 8*8 system font 
   824                                  	; CL = 0Fh = color (white)
   825                                  	; ESI = cursor/writing position (pixels)
   826                                  	;	HW = row, SI = column
   827                                  
   828                                  	sys	_video, 010Fh, 0Fh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000553 BB0F010000          <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000558 B90F000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000055D B81F000000          <1>  mov eax, %1
   104                              <1> 
   105 00000562 CD40                <1>  int 40h
   829                                  
   830 00000564 45                      	inc	ebp
   831 00000565 6683C608                	add	si, 8 ; next char pos
   832 00000569 FE0D[F4320000]          	dec	byte [columns]
   833 0000056F 75DB                    	jnz	short p_d_x_n	; next column
   834 00000571 6631F6                  	xor	si, si
   835 00000574 81C600000800            	add	esi, 00080000h	; next row ; 8*8
   836 0000057A EBC7                    	jmp	short p_d_x
   837                                  p_d_x_ok:
   838 0000057C C3                      	retn
   839                                  
   840                                  ; -------------------------------------------------------------
   841                                  
   842                                  	; 21/12/2024
   843                                  set_text_mode:
   844 0000057D 30E4                    	xor    ah, ah
   845 0000057F B003                    	mov    al, 3                        
   846                                   	;int   10h ; al = 03h text mode, int 10 video
   847 00000581 CD31                    	int    31h ; TRDOS 386 - Video interrupt
   848 00000583 C3                      	retn
   849                                  
   850                                  ; -------------------------------------------------------------
   851                                  
   852                                  	; 02/12/2024
   853                                  Player_Quit@:
   854 00000584 58                      	pop	eax ; return addr (call PlayWav@)
   855                                  	
   856                                  	; 29/11/2024
   857                                  Player_Quit:
   858 00000585 E92AFFFFFF              	jmp	 terminate
   859                                  
   860                                  ; -------------------------------------------------------------
   861                                  
   862                                  	; 30/12/2024 (cgaplay.s)
   863                                  	; 29/12/2024 (vgaplay3.s)
   864                                  	; 02/12/2024 (ac97play.s)
   865                                  PlayWav:
   866                                  	; 30/12/2024
   867 0000058A A1[CC380000]            	mov	eax, [_bdl_buffer] ; BDL_BUFFER physical address
   868 0000058F 09C0                    	or	eax, eax
   869 00000591 751D                    	jnz	short PlayWav@
   870                                  
   871                                  	; 29/05/2024
   872                                  	; Allocate memory block (33 pages)
   873                                  	sys	_alloc, BDL_BUFFER, 33*4096, 0	; no upper limit
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000593 BB[00400000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000598 B900100200          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000059D BA00000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000005A2 B82A000000          <1>  mov eax, %1
   104                              <1> 
   105 000005A7 CD40                <1>  int 40h
   874                                  	;jc	short Player_Quit ; 01/12/2024
   875 000005A9 72D9                    	jc	short Player_Quit@ ; 02/12/2024
   876                                  
   877 000005AB A3[CC380000]            	mov	[_bdl_buffer], eax ; BDL_BUFFER physical address
   878                                  
   879                                  PlayWav@:
   880                                  	; create Buffer Descriptor List
   881                                  
   882                                  	;  Generic Form of Buffer Descriptor
   883                                  	;  ---------------------------------
   884                                  	;  63   62    61-48    47-32   31-0
   885                                  	;  ---  ---  --------  ------- -----
   886                                  	;  IOC  BUP -reserved- Buffer  Buffer
   887                                  	;		      Length   Pointer
   888                                  	;		      [15:0]   [31:0]
   889                                  
   890                                  	; 30/12/2024	
   891                                  
   892 000005B0 0500100000              	add	eax, 4096	; WAVBUFFER_1 physical address
   893 000005B5 89C3                    	mov	ebx, eax
   894                                  	;mov	[wav_buffer1], eax
   895                                  	;add	eax, 65536	; WAVBUFFER_2 physical address
   896                                  	;mov	[wav_buffer2], eax
   897                                  
   898 000005B7 BF[00400000]            	mov	edi, BDL_BUFFER
   899 000005BC B910000000              	mov	ecx, 16
   900                                  _pw0:
   901                                  	;mov	eax, WAVBUFFER_1
   902 000005C1 89D8                    	mov	eax, ebx	; WAVBUFFER_1 physical address
   903 000005C3 AB                      	stosd
   904                                  
   905 000005C4 A1[B4380000]            	mov	eax, [buffersize]
   906                                  	; 02/12/2024
   907 000005C9 D1E8                    	shr	eax, 1 ; buffer size in word
   908 000005CB 0D00000040              	or	eax, BUP	; tuneloop (without interrupt)
   909 000005D0 AB                      	stosd
   910                                  
   911                                  	;mov	eax, WAVBUFFER_2
   912 000005D1 89D8                    	mov	eax, ebx
   913 000005D3 0500000100              	add	eax, 65536	; WAVBUFFER_2 physical address
   914 000005D8 AB                      	stosd
   915                                  
   916 000005D9 A1[B4380000]            	mov	eax, [buffersize]
   917                                  	; 02/12/2024
   918 000005DE D1E8                    	shr	eax, 1 ; buffer size in word
   919 000005E0 0D00000040              	or	eax, BUP	; tuneloop (without interrupt)
   920 000005E5 AB                      	stosd
   921                                  
   922 000005E6 E2D9                    	loop	_pw0
   923                                  
   924                                  	; 14/11/2024
   925                                  	;mov	dword [count], ecx ; 0
   926                                  	;mov	dword [LoadedDataBytes], 0
   927                                  
   928                                  RePlayWav:
   929                                  	; 01/12/2024
   930                                  	; load 64k into buffer 1
   931 000005E8 BF[00500000]            	mov	edi, WAVBUFFER_1
   932 000005ED FF15[AC380000]          	call	dword [loadfromwavfile]
   933                                  	; 01/12/2024
   934                                  	; 14/11/2024
   935 000005F3 A1[C0380000]            	mov	eax, [count]
   936 000005F8 0105[C4380000]          	add	[LoadedDataBytes], eax
   937                                  
   938                                  	; 18/12/2024
   939 000005FE C705[C0380000]0000-     	mov	dword [count], 0
   939 00000606 0000               
   940                                  
   941                                  	; and 64k into buffer 2
   942 00000608 BF[00500100]            	mov	edi, WAVBUFFER_2
   943 0000060D FF15[AC380000]          	call	dword [loadfromwavfile]
   944                                  	; 01/12/2024
   945                                  	; 14/11/2024
   946 00000613 A1[C0380000]            	mov	eax, [count]
   947 00000618 0105[C4380000]          	add	[LoadedDataBytes], eax
   948                                  	
   949                                  	; write NABMBAR+10h with offset of buffer descriptor list
   950                                  
   951                                         	;;mov	eax, BDL_BUFFER
   952                                          ;mov	eax, esi	; BDL_BUFFER physical address
   953                                  
   954                                  	;mov	eax, [_bdl_buffer] ; BDL_BUFFER physical address
   955                                  	; 02/12/2024
   956 0000061E 8B1D[CC380000]          	mov	ebx, [_bdl_buffer]
   957                                  
   958 00000624 668B15[AA380000]        	mov	dx, [NABMBAR]
   959 0000062B 6683C210                        add     dx, PO_BDBAR_REG	; set pointer to BDL
   960                                  	;out	dx, eax 		; write to AC97 controller
   961                                  	; 29/05/2024
   962                                  	;mov	ebx, eax ; data, dword
   963                                  	; 02/12/2024
   964                                  	; ebx = [_bdl_buffer] ; data, dword
   965 0000062F B405                    	mov	ah, 5	; write port dword
   966 00000631 CD34                    	int	34h
   967                                  
   968                                  	; 31/05/2024
   969                                  	; 19/05/2024
   970                                  	;call	delay1_4ms
   971                                  
   972 00000633 B01F                            mov	al, 31
   973 00000635 E8D4060000              	call	setLastValidIndex
   974                                  
   975                                  	; 31/05/2024
   976                                  	; 19/05/2024
   977                                  	;call	delay1_4ms
   978                                  
   979                                  	; 17/02/2017
   980 0000063A 668B15[AA380000]                mov	dx, [NABMBAR]
   981 00000641 6683C21B                        add	dx, PO_CR_REG		; PCM out Control Register
   982                                          ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   983                                  	;			; (LVBI interrupt will not be enabled)
   984                                  	; 06/11/2023 (TUNELOOP version, without interrupt)
   985 00000645 B001                    	mov	al, RPBM
   986                                  	;out	dx, al			; Start bus master operation.
   987                                  	; 29/05/2024
   988                                  	; al = data, byte
   989 00000647 B401                    	mov	ah, 1 ; write port, byte
   990 00000649 CD34                    	int	34h
   991                                  
   992                                  	; 30/12/2024
   993                                  
   994                                  ; -------------------------------------------
   995                                  
   996                                  	; 30/12/2024 (cgaplay.s)
   997                                  	; 29/12/2024 (vgaplay3.s)
   998                                  	; 18/12/2024 (ac97play.s)
   999                                  	; 01/12/2024 (32bit)
  1000                                  	; 29/11/2024
  1001                                  tuneLoop:
  1002                                  	; 30/05/2024
  1003                                  	; 18/11/2023 (ich_wav4.asm)
  1004                                  	; 08/11/2023
  1005                                  	; 06/11/2023
  1006                                  tLWait:
  1007                                  	; 18/11/2024
  1008 0000064B 803D[FC370000]00        	cmp	byte [stopped], 0
  1009                                  	;jna	short tL@
  1010                                  	; 21/11/2024
  1011 00000652 7718                    	ja	short tLWait@
  1012 00000654 A0[FE370000]            	mov	al, [tLP]
  1013 00000659 3C31                    	cmp	al, '1'
  1014 0000065B 7458                    	je	short tL1@
  1015 0000065D 0F87A3000000            	ja	tL2@
  1016 00000663 B031                    	mov	al, '1'
  1017 00000665 A2[FE370000]            	mov	[tLP], al
  1018 0000066A EB49                    	jmp	short tL1@ 
  1019                                  tLWait@:	; 21/11/2024
  1020                                  	;;;
  1021                                  	; 09/12/2024
  1022 0000066C 803D[FC370000]03        	cmp	byte [stopped], 3
  1023 00000673 0F83DF000000            	jnb	_exitt_
  1024                                  	;;;
  1025 00000679 E8C7200000              	call	checkUpdateEvents
  1026 0000067E 0F82D4000000            	jc	_exitt_
  1027                                  	;;;
  1028                                  	; 29/11/2024
  1029 00000684 803D[0A380000]4E        	cmp	byte [command], 'N'
  1030 0000068B 0F84C7000000            	je	_exitt_
  1031 00000691 803D[0A380000]50        	cmp	byte [command], 'P'
  1032 00000698 0F84BA000000            	je	_exitt_
  1033                                  	;;;
  1034 0000069E 803D[FD370000]30        	cmp	byte [tLO], '0'
  1035 000006A5 74A4                    	je	short tLWait
  1036 000006A7 E8B6000000              	call	tLZ
  1037 000006AC C605[FD370000]30        	mov	byte [tLO], '0'
  1038 000006B3 EB96                    	jmp	short tLWait
  1039                                  
  1040                                  ;tLO:	db 0
  1041                                  	
  1042                                  tL1@:
  1043                                  	;mov	al, '1'
  1044                                  	; 19/11/2024
  1045 000006B5 A2[FD370000]            	mov	[tLO], al
  1046 000006BA E8A5000000              	call	tL0
  1047                                  tL1:
  1048 000006BF E80D060000              	call	updateLVI	; /set LVI != CIV/
  1049 000006C4 0F848E000000            	jz	_exitt_		; 08/11/2023
  1050                                  	;;;
  1051                                  	;call	check4keyboardstop
  1052                                  	; 14/11/2024
  1053 000006CA E876200000              	call	checkUpdateEvents
  1054 000006CF 0F8283000000            	jc	_exitt_
  1055                                  	; 18/11/2024
  1056 000006D5 803D[FC370000]00        	cmp	byte [stopped], 0
  1057 000006DC 778E                    	ja	short tLWait@	; 21/11/2024
  1058                                  	;;;
  1059 000006DE E8DE050000              	call	getCurrentIndex
  1060 000006E3 A801                    	test	al, BIT0
  1061 000006E5 74D8                    	jz	short tL1	; loop if buffer 2 is not playing
  1062                                  
  1063                                  	; load buffer 1
  1064                                  	;mov	ax, [WAV_BUFFER1]
  1065                                  	; 01/12/2024
  1066 000006E7 BF[00500000]            	mov	edi, WAVBUFFER_1	
  1067                                  
  1068                                  	;call	loadFromFile
  1069                                  	; 18/11/2023
  1070                                  	;call	word [loadfromwavfile]
  1071                                  	; 01/12/2024
  1072 000006EC FF15[AC380000]          	call	dword [loadfromwavfile]
  1073 000006F2 7264                    	jc	short _exitt_	; end of file
  1074                                  
  1075                                  	; 14/11/2024
  1076                                  	;mov	ax, [count]
  1077                                  	;add	[LoadedDataBytes], ax
  1078                                  	;adc	word [LoadedDataBytes+2], 0
  1079                                  	; 01/12/2024
  1080 000006F4 A1[C0380000]            	mov	eax, [count]
  1081 000006F9 0105[C4380000]          	add	[LoadedDataBytes], eax
  1082                                  
  1083 000006FF B032                    	mov	al, '2'
  1084                                  	; 21/11/2024
  1085 00000701 A2[FE370000]            	mov	[tLP], al
  1086                                  tL2@:
  1087                                  	; 19/11/2024
  1088 00000706 A2[FD370000]            	mov	[tLO], al
  1089 0000070B E854000000              	call	tL0
  1090                                  tL2:
  1091 00000710 E8BC050000              	call    updateLVI
  1092 00000715 7441                    	jz	short _exitt_	; 08/11/2023
  1093                                  	;;;
  1094                                  	;call	check4keyboardstop
  1095                                  	; 14/11/2024
  1096 00000717 E829200000              	call	checkUpdateEvents
  1097 0000071C 723A                    	jc	short _exitt_
  1098                                  	; 18/11/2024
  1099 0000071E 803D[FC370000]00        	cmp	byte [stopped], 0
  1100 00000725 0F8741FFFFFF            	ja	tLWait@		; 21/11/2024 
  1101                                  	;;;
  1102 0000072B E891050000              	call    getCurrentIndex
  1103 00000730 A801                    	test	al, BIT0
  1104 00000732 75DC                    	jnz	short tL2	; loop if buffer 1 is not playing
  1105                                  
  1106                                  	; load buffer 2
  1107                                  	;mov	ax, [WAV_BUFFER2]
  1108                                  	; 01/12/2024
  1109 00000734 BF[00500100]            	mov	edi, WAVBUFFER_2
  1110                                  	;call	loadFromFile
  1111                                  	; 18/11/2023
  1112                                  	;call	word [loadfromwavfile]
  1113                                  	; 01/12/2024
  1114 00000739 FF15[AC380000]          	call	dword [loadfromwavfile]
  1115                                  	;jnc	short tuneLoop
  1116 0000073F 7217                    	jc	short _exitt_
  1117                                  
  1118                                  	; 14/11/2024
  1119                                  	;mov	ax, [count]
  1120                                  	;add	[LoadedDataBytes], ax
  1121                                  	;adc	word [LoadedDataBytes+2], 0
  1122                                  	; 01/12/2024
  1123 00000741 A1[C0380000]            	mov	eax, [count]
  1124 00000746 0105[C4380000]          	add	[LoadedDataBytes], eax	
  1125                                  
  1126                                  	; 21/11/2024
  1127 0000074C C605[FE370000]31        	mov	byte [tLP], '1'
  1128 00000753 E9F3FEFFFF              	jmp	tuneLoop
  1129                                  
  1130                                  	; 29/12/2024 (vgaplay3.s)
  1131                                  _exitt_:
  1132                                  	; 07/12/2024
  1133                                  	; Stop Playing
  1134                                  	;mov	byte [stopped], 2
  1135                                  	;sys	_audio, 0700h
  1136 00000758 E8F6040000              	call	ac97_stop
  1137                                  
  1138                                  	;;;
  1139                                  	; 14/11/2024
  1140 0000075D E8F9230000              	call	UpdateProgressBar
  1141                                  	;;;
  1142                                  
  1143                                  	; 18/11/2024
  1144                                  tLZ:
  1145                                  	; 30/05/2024
  1146 00000762 B030                    	mov	al, '0'
  1147                                  
  1148                                  	;add	al, '0'
  1149                                  	;call	tL0
  1150                                  	;
  1151                                  	;retn
  1152                                  	; 06/11/2023
  1153                                  	;jmp	short tL0
  1154                                  	;retn
  1155                                  
  1156                                  tL0:
  1157                                  	; 30/12/2024 (cgaplay.s)
  1158                                  	; 29/05/2024 (TRDOS 386)
  1159                                  	; 08/11/2023
  1160                                  	; 05/11/2023
  1161                                  	; 17/02/2017 - Buffer switch test (temporary)
  1162                                  	; 06/11/2023
  1163                                  	; al = buffer indicator ('1', '2' or '0' -stop- )
  1164                                  
  1165                                  	; 30/12/2024 (video mode 13h modification)
  1166                                  	; (320*200, 256 colors)
  1167                                  	;;;
  1168 00000764 88C2                    	mov	dl, al ; character
  1169 00000766 BF00000A00              	mov	edi, 0A0000h
  1170                                  
  1171 0000076B BB08000000              	mov	ebx, 8 ; 8 pixels (8*8 pixels font)
  1172                                  
  1173 00000770 B00C                    	mov	al, 0Ch ; red
  1174                                  tL0_1:
  1175                                  	;mov	ecx, 8 ; 8 pixels (8*8 pixels font)
  1176 00000772 B907000000              	mov	ecx, 7
  1177                                  tL0_2:
  1178 00000777 AA                      	stosb
  1179 00000778 49                      	dec	ecx
  1180 00000779 75FC                    	jnz	short tL0_2
  1181 0000077B 4B                      	dec	ebx
  1182 0000077C 7408                    	jz	short tL0_3
  1183                                  	;add	edi, 320-8 ; next line
  1184 0000077E 81C739010000            	add	edi, 320-7
  1185 00000784 EBEC                    	jmp	short tL0_1
  1186                                  tL0_3:
  1187                                  	; write system font
  1188 00000786 B601                    	mov	dh, 01h
  1189                                  	;mov	dl, al ; character
  1190 00000788 31F6                    	xor	esi, esi ; = row 0, column 0
  1191                                  	sys	_video, 010Fh, 0Eh ; yellow
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000078A BB0F010000          <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000078F B90E000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000794 B81F000000          <1>  mov eax, %1
   104                              <1> 
   105 00000799 CD40                <1>  int 40h
  1192                                  	;;;
  1193                                  
  1194 0000079B C3                      	retn
  1195                                  
  1196                                  ; -------------------------------------------
  1197                                  
  1198                                  	; 29/12/2024 (vgaplay3.s)
  1199                                  	; 18/12/2024 (ac97play.s)
  1200                                  	; 14/11/2024
  1201                                  ;SetMasterVolume:
  1202                                  	; 15/11/2024
  1203                                  SetPCMOutVolume:
  1204                                  	;cmp	al, 31
  1205                                  	;ja	short setvolume_ok
  1206 0000079C A2[66290000]            	mov	[volume], al  ; max = 0, min = 31
  1207                                  SetPCMOutVolume@:	; 19/11/2024
  1208 000007A1 88C4                    	mov	ah, al
  1209 000007A3 668B15[A8380000]        	mov	dx, [NAMBAR]
  1210                                  	; 15/11/2024 (QEMU)
  1211                                    	;add	dx, CODEC_MASTER_VOL_REG
  1212 000007AA 6683C218                	add	dx, CODEC_PCM_OUT_REG
  1213                                  	;out	dx, ax
  1214                                  	; 01/12/2024
  1215                                  	; bx = data, word
  1216                                  	; 03/12/2024
  1217 000007AE 89C3                    	mov	ebx, eax
  1218 000007B0 B403                    	mov	ah, 3  ; write port, word
  1219 000007B2 CD34                    	int	34h
  1220                                  ;setvolume_ok:
  1221 000007B4 C3                      	retn
  1222                                  
  1223                                  ; -------------------------------------------
  1224                                  
  1225                                  	; 29/12/2024 (vgaplay3.s)
  1226                                  	; 18/12/2024 (ac97play.s)
  1227                                  	; 30/05/2024
  1228                                  DetectAC97:
  1229                                  DetectICH:
  1230                                  	; 22/11/2023
  1231                                  	; 19/11/2023
  1232                                  	; 01/11/2023 - TRDOS 386 Kernel v2.0.7
  1233                                  	;; 10/06/2017
  1234                                  	;; 05/06/2017
  1235                                  	;; 29/05/2017
  1236                                  	;; 28/05/2017
  1237                                  
  1238                                  	; 01/12/2024
  1239                                  	; 19/11/2023
  1240 000007B5 BE[582C0000]            	mov	esi, valid_ids	; address of Valid ICH (AC97) Device IDs
  1241 000007BA B915000000              	mov	ecx, valid_id_count
  1242                                  pfd_1:
  1243 000007BF AD                      	lodsd
  1244 000007C0 E8A8000000              	call	pciFindDevice
  1245 000007C5 7303                    	jnc	short d_ac97_1
  1246 000007C7 E2F6                    	loop	pfd_1
  1247                                  
  1248                                  	;stc
  1249 000007C9 C3                      	retn
  1250                                  
  1251                                  d_ac97_1:
  1252                                  	; eax = BUS/DEV/FN
  1253                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1254                                  	; edx = DEV/VENDOR
  1255                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1256                                  
  1257                                  	; playwav4.asm - 19/05/2024
  1258                                  
  1259 000007CA A3[A0380000]            	mov	[bus_dev_fn], eax
  1260 000007CF 8915[A4380000]          	mov	[dev_vendor], edx
  1261                                  
  1262                                  	; get ICH base address regs for mixer and bus master
  1263                                  
  1264 000007D5 B010                            mov     al, NAMBAR_REG
  1265 000007D7 E81F010000                      call    pciRegRead16			; read PCI registers 10-11
  1266                                          ;and    dx, IO_ADDR_MASK 		; mask off BIT0
  1267                                  	; 19/05/2024
  1268 000007DC 80E2FE                  	and	dl, 0FEh
  1269                                  
  1270 000007DF 668915[A8380000]                mov     [NAMBAR], dx			; save audio mixer base addr
  1271                                  
  1272 000007E6 B014                    	mov     al, NABMBAR_REG
  1273 000007E8 E80E010000                      call    pciRegRead16
  1274                                          ;and    dx, IO_ADDR_MASK
  1275                                  	; 19/05/2024
  1276 000007ED 80E2C0                  	and	dl, 0C0h
  1277                                  
  1278 000007F0 668915[AA380000]                mov     [NABMBAR], dx			; save bus master base addr
  1279                                  
  1280 000007F7 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
  1281 000007F9 E8F6000000              	call	pciRegRead8 ; 17/02/2017
  1282                                  	
  1283 000007FE 8815[3B380000]          	mov	[ac97_int_ln_reg], dl
  1284                                  
  1285                                  	;clc
  1286                                  
  1287 00000804 C3                      	retn
  1288                                  
  1289                                  ; ----------------------------------
  1290                                  	
  1291                                  	; 26/12/2024
  1292                                  	; 07/12/2024
  1293                                  	; 01/12/2024
  1294                                  	; 14/11/2024
  1295                                  	; INPUT: ds:dx = file name address
  1296                                  	; OUTPUT: [filehandle] = ; -1 = not open
  1297                                  openFile:
  1298                                  	; 26/12/2024
  1299                                  	; 01/12/2024
  1300                                  	sys	_open, edx, 0
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000805 89D3                <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000807 B900000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000080C B805000000          <1>  mov eax, %1
   104                              <1> 
   105 00000811 CD40                <1>  int 40h
  1301                                  	; 07/12/2024
  1302                                  	;sys	_open, wav_file_name, 0
  1303 00000813 7305                    	jnc	short _of1
  1304                                  
  1305 00000815 B8FFFFFFFF              	mov	eax, -1
  1306                                  	; cf = 1 -> not found or access error
  1307                                  _of1:
  1308 0000081A A3[3C380000]            	mov	[filehandle], eax
  1309 0000081F C3                      	retn
  1310                                  
  1311                                  ; ----------------------------------
  1312                                  
  1313                                  ; close the currently open file
  1314                                  
  1315                                  	; 01/12/2024
  1316                                  	; 14/11/2024
  1317                                  	; INPUT: [filehandle] ; -1 = not open
  1318                                  	; OUTPUT: none
  1319                                  closeFile:
  1320 00000820 833D[3C380000]FF        	cmp	dword [filehandle], -1
  1321 00000827 740D                    	jz	short _cf1
  1322                                  	; 01/12/2024
  1323                                  	sys	_close, [filehandle]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000829 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97                              <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000082F B806000000          <1>  mov eax, %1
   104                              <1> 
   105 00000834 CD40                <1>  int 40h
  1324                                  	;mov 	dword [filehandle], -1
  1325                                  _cf1:
  1326 00000836 C3                      	retn
  1327                                  
  1328                                  ; ----------------------------------
  1329                                  
  1330                                  	; 01/12/2024
  1331                                  	; 14/11/2024 - Erdogan Tan
  1332                                  getWAVParameters:
  1333                                  ; reads WAV file header(s) (44 bytes) from the .wav file.
  1334                                  ; entry: none - assumes file is already open
  1335                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
  1336                                  ;	cx = number of channels (mono=1, stereo=2)
  1337                                  ;	dx = bits per sample (8, 16)
  1338                                  ;	bx = number of bytes per sample (1 to 4)
  1339                                  
  1340                                          ;mov	dx, WAVFILEHEADERbuff
  1341                                  	;mov	bx, [filehandle]
  1342                                          ;mov	cx, 44			; 44 bytes
  1343                                  	;mov	ah, 3Fh
  1344                                          ;int	21h
  1345                                  	;jc	short gwavp_retn
  1346                                  	; 01/12/2024 (TRDOS 386)
  1347                                  	sys	_read, [filehandle], WAVFILEHEADERbuff, 44
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000837 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000083D B9[0C380000]        <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00000842 BA2C000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000847 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 0000084C CD40                <1>  int 40h
  1348 0000084E 721C                    	jc	short gwavp_retn
  1349                                  
  1350 00000850 83F82C                  	cmp	eax, 44
  1351 00000853 7217                    	jb	short gwavp_retn
  1352                                  
  1353 00000855 813D[14380000]5741-     	cmp	dword [RIFF_Format], 'WAVE'
  1353 0000085D 5645               
  1354 0000085F 750A                    	jne	short gwavp_stc_retn
  1355                                  
  1356 00000861 66833D[20380000]01      	cmp	word [WAVE_AudioFormat], 1 ; Offset 20, must be 1 (= PCM)
  1357                                  	;jne	short gwavp_stc_retn
  1358 00000869 7401                    	je	short gwavp_retn ; 15/11/2024
  1359                                  
  1360                                  	; 15/11/2024
  1361                                  	;mov	cx, [WAVE_NumChannels]	; return num of channels in CX
  1362                                          ;mov    ax, [WAVE_SampleRate]	; return sample rate in AX
  1363                                  	;mov	dx, [WAVE_BitsPerSample] 
  1364                                  					; return bits per sample value in DX
  1365                                  	;mov	bx, [WAVE_BlockAlign]	; return bytes per sample in BX
  1366                                  ;gwavp_retn:
  1367                                          ;retn
  1368                                  
  1369                                  gwavp_stc_retn:
  1370 0000086B F9                      	stc
  1371                                  gwavp_retn:
  1372 0000086C C3                      	retn
  1373                                  
  1374                                  
  1375                                  ; 29/12/2024 (vgaplay3.s)
  1376                                  ; 18/12/2024 (ac97play.s)
  1377                                  ; --------------------------------------------------------
  1378                                  ; 27/05/2024 - (TRDOS 386 Kernel) audio.s
  1379                                  ; --------------------------------------------------------
  1380                                  
  1381                                  NOT_PCI32_PCI16	EQU 03FFFFFFFh ; NOT BIT31+BIT30 ; 19/03/2017
  1382                                  NOT_BIT31 EQU 7FFFFFFFh
  1383                                  
  1384                                  pciFindDevice:
  1385                                  	; 19/11/2023
  1386                                  	; 03/04/2017 ('pci.asm', 20/03/2017)
  1387                                  	;
  1388                                  	; scan through PCI space looking for a device+vendor ID
  1389                                  	;
  1390                                  	; Entry: EAX=Device+Vendor ID
  1391                                  	;
  1392                                  	; Exit: EAX=PCI address if device found
  1393                                  	;	EDX=Device+Vendor ID
  1394                                  	;       CY clear if found, set if not found. EAX invalid if CY set.
  1395                                  	;
  1396                                  	; Destroys: ebx, edi ; 19/11/2023
  1397                                  
  1398                                          ; 19/11/2023
  1399 0000086D 89C3                    	mov	ebx, eax
  1400 0000086F BF00000080              	mov	edi, 80000000h
  1401                                  nextPCIdevice:
  1402 00000874 89F8                    	mov 	eax, edi		; read PCI registers
  1403 00000876 E88C000000              	call	pciRegRead32
  1404                                  	; 19/11/2023
  1405 0000087B 39DA                    	cmp	edx, ebx
  1406 0000087D 7412                    	je	short PCIScanExit	; found
  1407                                  	; 19/11/2023
  1408 0000087F 81FF00F8FF80            	cmp	edi, 80FFF800h
  1409 00000885 7308                    	jnb	short pfd_nf		; not found
  1410 00000887 81C700010000            	add	edi, 100h
  1411 0000088D EBE5                    	jmp	short nextPCIdevice
  1412                                  pfd_nf:
  1413 0000088F F9                      	stc
  1414 00000890 C3                      	retn
  1415                                  PCIScanExit:
  1416                                  	;pushf
  1417 00000891 B8FFFFFF7F              	mov	eax, NOT_BIT31 	; 19/03/2017
  1418 00000896 21F8                    	and	eax, edi	; return only bus/dev/fn #
  1419 00000898 C3                      	retn
  1420                                  
  1421                                  pciRegRead:
  1422                                  	; 01/12/2024
  1423                                  	; 03/04/2017 ('pci.asm', 20/03/2017)
  1424                                  	;
  1425                                  	; 8/16/32bit PCI reader
  1426                                  	;
  1427                                  	; Entry: EAX=PCI Bus/Device/fn/register number
  1428                                  	;           BIT30 set if 32 bit access requested
  1429                                  	;           BIT29 set if 16 bit access requested
  1430                                  	;           otherwise defaults to 8 bit read
  1431                                  	;
  1432                                  	; Exit:  DL,DX,EDX register data depending on requested read size
  1433                                  	;
  1434                                  	; Note1: this routine is meant to be called via pciRegRead8,
  1435                                  	;	 pciRegread16 or pciRegRead32, listed below.
  1436                                  	;
  1437                                  	; Note2: don't attempt to read 32 bits of data from a non dword
  1438                                  	;	 aligned reg number. Likewise, don't do 16 bit reads from
  1439                                  	;	 non word aligned reg #
  1440                                  
  1441 00000899 53                      	push	ebx
  1442 0000089A 51                      	push	ecx
  1443 0000089B 89C3                            mov     ebx, eax		; save eax, dh
  1444 0000089D 88F1                            mov     cl, dh
  1445                                  
  1446 0000089F 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; clear out data size request
  1447 000008A4 0D00000080                      or      eax, BIT31		; make a PCI access request
  1448 000008A9 24FC                            and     al, ~3 ; NOT 3 ; 0FCh	; force index to be dword
  1449                                  
  1450 000008AB 66BAF80C                        mov     dx, PCI_INDEX_PORT
  1451                                          ;out	dx, eax			; write PCI selector
  1452                                  	; 29/05/2024
  1453 000008AF 53                      	push	ebx
  1454 000008B0 89C3                    	mov	ebx, eax ; data, dword
  1455 000008B2 B405                    	mov	ah, 5 ; write port, dword
  1456                                  	; dx = port number
  1457 000008B4 CD34                    	int	34h
  1458 000008B6 5B                      	pop	ebx
  1459                                  	
  1460 000008B7 66BAFC0C                        mov     dx, PCI_DATA_PORT
  1461 000008BB 88D8                            mov     al, bl
  1462 000008BD 2403                            and     al, 3			; figure out which port to
  1463 000008BF 00C2                            add     dl, al			; read to
  1464                                  
  1465 000008C1 F7C3000000C0            	test    ebx, PCI32+PCI16
  1466 000008C7 750A                            jnz     short _pregr0
  1467                                  
  1468                                  	;in	al, dx			; return 8 bits of data
  1469                                  	; 29/05/2024
  1470 000008C9 B400                    	mov	ah, 0 ; read port, byte
  1471                                  	; dx = port number
  1472 000008CB CD34                    	int	34h
  1473                                          
  1474 000008CD 88C2                    	mov	dl, al
  1475 000008CF 88CE                    	mov     dh, cl			; restore dh for 8 bit read
  1476 000008D1 EB17                    	jmp	short _pregr2
  1477                                  _pregr0:	
  1478 000008D3 F7C300000080            	test    ebx, PCI32
  1479 000008D9 7509                            jnz	short _pregr1
  1480                                  
  1481                                  	;in	ax, dx
  1482                                  	; 29/05/2024
  1483 000008DB B402                    	mov	ah, 2 ; read port, word
  1484                                  	; dx = port number
  1485 000008DD CD34                    	int	34h
  1486                                  
  1487 000008DF 6689C2                  	mov     dx, ax			; return 16 bits of data
  1488 000008E2 EB06                    	jmp	short _pregr2
  1489                                  _pregr1:
  1490                                  	;in	eax, dx			; return 32 bits of data
  1491                                  	; 29/05/2024
  1492 000008E4 B404                    	mov	ah, 4 ; read port, dword
  1493                                  	; dx = port number
  1494 000008E6 CD34                    	int	34h
  1495                                  
  1496 000008E8 89C2                    	mov	edx, eax
  1497                                  _pregr2:
  1498 000008EA 89D8                    	mov     eax, ebx		; restore eax
  1499 000008EC 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; clear out data size request
  1500 000008F1 59                      	pop	ecx
  1501 000008F2 5B                      	pop	ebx
  1502 000008F3 C3                      	retn
  1503                                  
  1504                                  pciRegRead8:
  1505 000008F4 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 8 bit read size
  1506 000008F9 EB9E                            jmp     short pciRegRead	; call generic PCI access
  1507                                  
  1508                                  pciRegRead16:
  1509 000008FB 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 16 bit read size
  1510 00000900 0D00000040                      or      eax, PCI16		; call generic PCI access
  1511 00000905 EB92                            jmp     short pciRegRead
  1512                                  
  1513                                  pciRegRead32:
  1514 00000907 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 32 bit read size
  1515 0000090C 0D00000080                      or      eax, PCI32		; call generic PCI access
  1516 00000911 EB86                            jmp     pciRegRead
  1517                                  
  1518                                  pciRegWrite:
  1519                                  	; 01/12/2024
  1520                                  	; 03/04/2017 ('pci.asm', 29/11/2016)
  1521                                  	;
  1522                                  	; 8/16/32bit PCI writer
  1523                                  	;
  1524                                  	; Entry: EAX=PCI Bus/Device/fn/register number
  1525                                  	;           BIT31 set if 32 bit access requested
  1526                                  	;           BIT30 set if 16 bit access requested
  1527                                  	;           otherwise defaults to 8bit read
  1528                                  	;        DL/DX/EDX data to write depending on size
  1529                                  	;
  1530                                  	; Note1: this routine is meant to be called via pciRegWrite8,
  1531                                  	;	 pciRegWrite16 or pciRegWrite32 as detailed below.
  1532                                  	;
  1533                                  	; Note2: don't attempt to write 32bits of data from a non dword
  1534                                  	;	 aligned reg number. Likewise, don't do 16 bit writes from
  1535                                  	;	 non word aligned reg #
  1536                                  
  1537 00000913 53                      	push	ebx
  1538 00000914 51                      	push	ecx
  1539 00000915 89C3                            mov     ebx, eax		; save eax, edx
  1540 00000917 89D1                            mov     ecx, edx
  1541 00000919 25FFFFFF3F              	and     eax, NOT_PCI32_PCI16	; clear out data size request
  1542 0000091E 0D00000080                      or      eax, BIT31		; make a PCI access request
  1543 00000923 24FC                            and     al, ~3 ; NOT 3 ; 0FCh	; force index to be dword
  1544                                  
  1545 00000925 66BAF80C                        mov     dx, PCI_INDEX_PORT
  1546                                  	;out	dx, eax			; write PCI selector
  1547                                  	; 29/05/2024
  1548 00000929 53                      	push	ebx
  1549 0000092A 89C3                    	mov	ebx, eax ; data, dword
  1550 0000092C B405                    	mov	ah, 5 ; write port, dword
  1551                                  	; dx = port number
  1552 0000092E CD34                    	int	34h
  1553 00000930 5B                      	pop	ebx
  1554                                  	
  1555 00000931 66BAFC0C                        mov     dx, PCI_DATA_PORT
  1556 00000935 88D8                            mov     al, bl
  1557 00000937 2403                            and     al, 3			; figure out which port to
  1558 00000939 00C2                            add     dl, al			; write to
  1559                                  
  1560 0000093B F7C3000000C0            	test    ebx, PCI32+PCI16
  1561 00000941 7508                            jnz     short _pregw0
  1562 00000943 88C8                    	mov	al, cl 			; put data into al
  1563                                  	;out	dx, al
  1564                                  	; 29/05/2024
  1565                                  	; al = data, byte
  1566 00000945 B401                    	mov	ah, 1 ; write port, byte
  1567                                  	; dx = port number
  1568 00000947 CD34                    	int	34h
  1569                                  
  1570 00000949 EB1F                    	jmp	short _pregw2
  1571                                  _pregw0:
  1572 0000094B F7C300000080            	test    ebx, PCI32
  1573 00000951 750D                            jnz     short _pregw1
  1574 00000953 6689C8                  	mov	ax, cx			; put data into ax
  1575                                  	;out	dx, ax
  1576                                  	; 29/05/2024
  1577 00000956 53                      	push	ebx
  1578 00000957 89C3                    	mov	ebx, eax ; data, word
  1579 00000959 B403                    	mov	ah, 3 ; write port, word
  1580                                  	; dx = port number
  1581 0000095B CD34                    	int	34h
  1582 0000095D 5B                      	pop	ebx
  1583                                  
  1584 0000095E EB0A                    	jmp	short _pregw2
  1585                                  _pregw1:
  1586 00000960 89C8                    	mov	eax, ecx		; put data into eax
  1587                                  	;out	dx, eax
  1588                                  	; 29/05/2024
  1589 00000962 53                      	push	ebx
  1590 00000963 89C3                    	mov	ebx, eax ; data, dword
  1591 00000965 B405                    	mov	ah, 5 ; write port, dword
  1592                                  	; dx = port number
  1593 00000967 CD34                    	int	34h
  1594 00000969 5B                      	pop	ebx
  1595                                  _pregw2:
  1596 0000096A 89D8                            mov     eax, ebx		; restore eax
  1597 0000096C 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; clear out data size request
  1598 00000971 89CA                            mov     edx, ecx		; restore dx
  1599 00000973 59                      	pop	ecx
  1600 00000974 5B                      	pop	ebx
  1601 00000975 C3                      	retn
  1602                                  
  1603                                  pciRegWrite8:
  1604 00000976 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 8 bit write size
  1605 0000097B EB96                            jmp	short pciRegWrite	; call generic PCI access
  1606                                  
  1607                                  pciRegWrite16:
  1608 0000097D 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 16 bit write size
  1609 00000982 0D00000040                      or      eax, PCI16		; call generic PCI access
  1610 00000987 EB8A                            jmp	short pciRegWrite
  1611                                  
  1612                                  pciRegWrite32:
  1613 00000989 25FFFFFF3F                      and     eax, NOT_PCI32_PCI16	; set up 32 bit write size
  1614 0000098E 0D00000080                      or      eax, PCI32		; call generic PCI access
  1615 00000993 E97BFFFFFF                      jmp	pciRegWrite
  1616                                  
  1617                                  ; --------------------------------------------------------
  1618                                  ; 19/05/2024 - (playwav4.asm) ac97_vra.asm
  1619                                  ; --------------------------------------------------------
  1620                                  
  1621                                  	; 13/11/2023
  1622                                  
  1623                                  ;VRA:	db 1
  1624                                  
  1625                                  codecConfig:
  1626                                  	; 01/12/2024 (ac97play.s)
  1627                                  	; 29/05/2024 (playwav7.s modification)
  1628                                  	; 19/05/2024
  1629                                  	; 19/11/2023
  1630                                  	; 15/11/2023
  1631                                  	; 04/11/2023
  1632                                  	; 17/02/2017 
  1633                                  	; 07/11/2016 (Erdogan Tan)
  1634                                  
  1635                                  	;AC97_EA_VRA equ 1
  1636                                  	AC97_EA_VRA equ BIT0
  1637                                  
  1638                                  	; 04/11/2023
  1639                                  init_ac97_controller:
  1640 00000998 A1[A0380000]            	mov	eax, [bus_dev_fn]
  1641 0000099D B004                    	mov	al, PCI_CMD_REG
  1642 0000099F E857FFFFFF              	call	pciRegRead16		; read PCI command register
  1643 000009A4 80CA05                  	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
  1644 000009A7 E8D1FFFFFF              	call	pciRegWrite16
  1645                                  
  1646                                  	;call	delay_100ms
  1647                                  
  1648                                  	; 19/05/2024
  1649                                  	; ('PLAYMOD3.ASM', Erdogan Tan, 18/05/2024)
  1650                                  
  1651                                  init_ac97_codec:
  1652                                  	; 18/11/2023
  1653 000009AC BD28000000              	mov	ebp, 40
  1654                                  	; 29/05/2024
  1655                                  	;mov	ebp, 1000
  1656                                  _initc_1:
  1657                                  	; 29/05/2024
  1658 000009B1 66BA3000                	mov	dx, GLOB_STS_REG ; 30h
  1659 000009B5 660315[AA380000]        	add	dx, [NABMBAR]
  1660                                  	;in	eax, dx
  1661 000009BC B404                    	mov	ah, 4	; read port, dword
  1662 000009BE CD34                    	int	34h
  1663                                  
  1664                                  	; 19/05/2024
  1665                                  	;call	delay1_4ms
  1666                                  
  1667 000009C0 83F8FF                  	cmp	eax, 0FFFFFFFFh ; -1
  1668 000009C3 750A                    	jne	short _initc_3
  1669                                  _initc_2:
  1670 000009C5 4D                      	dec	ebp
  1671 000009C6 7425                    	jz	short _ac97_codec_ready
  1672                                  
  1673                                  	; 31/05/2024
  1674 000009C8 E8B3020000              	call	delay_100ms
  1675 000009CD EBE2                    	jmp	short _initc_1
  1676                                  _initc_3:
  1677 000009CF A900030010              	test	eax, CTRL_ST_CREADY
  1678 000009D4 7517                    	jnz	short _ac97_codec_ready
  1679                                  
  1680                                  	; 30/05/2024
  1681 000009D6 803D[F92C0000]01        	cmp	byte [reset], 1
  1682 000009DD 73E6                    	jnb	short _initc_2
  1683                                  
  1684 000009DF E893010000              	call	reset_ac97_codec
  1685                                  	; 30/05/2024
  1686 000009E4 C605[F92C0000]01        	mov	byte [reset], 1
  1687                                  	; 19/05/2024
  1688 000009EB EBD8                    	jmp	short _initc_2
  1689                                  
  1690                                  _ac97_codec_ready:
  1691 000009ED 668B15[A8380000]        	mov	dx, [NAMBAR]
  1692                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1693                                  	;out	dx, ax
  1694                                  	; 29/05/2024
  1695 000009F4 53                      	push	ebx
  1696 000009F5 89C3                    	mov	ebx, eax ; bx = data, word
  1697 000009F7 B403                    	mov	ah, 3	; write port, word
  1698 000009F9 CD34                    	int	34h
  1699 000009FB 5B                      	pop	ebx
  1700                                  
  1701                                  	; 31/05/2024
  1702                                  	; 29/05/2024
  1703                                  	;call	delay_100ms
  1704                                  
  1705                                  	; 19/11/2023
  1706 000009FC 09ED                    	or	ebp, ebp
  1707 000009FE 7539                    	jnz	short _ac97_codec_init_ok
  1708                                  
  1709 00000A00 31C0                    	xor	eax, eax ; 0
  1710 00000A02 668B15[A8380000]        	mov	dx, [NAMBAR]
  1711 00000A09 6683C226                	add	dx, CODEC_REG_POWERDOWN
  1712                                  	;out	dx, ax
  1713                                  	; 29/05/2024
  1714 00000A0D 53                      	push	ebx
  1715 00000A0E 89C3                    	mov	ebx, eax
  1716 00000A10 B403                    	mov	ah, 3	; write port, word
  1717 00000A12 CD34                    	int	34h
  1718 00000A14 5B                      	pop	ebx
  1719                                  
  1720                                  	; 19/11/2023
  1721                                  	; wait for 1 second
  1722                                  	; 19/05/2024
  1723 00000A15 B9E8030000              	mov	ecx, 1000 ; 1000*4*0.25ms = 1s
  1724                                  	;;mov	ecx, 10
  1725                                  	; 30/05/2024
  1726                                  	;mov	ecx, 40
  1727                                  _ac97_codec_rloop:
  1728                                  	;call	delay_100ms
  1729                                  	; 31/05/2024
  1730 00000A1A E870020000              	call	delay1_4ms
  1731                                  
  1732                                  	;mov	dx, [NAMBAR]
  1733                                  	;add	dx, CODEC_REG_POWERDOWN
  1734                                  	;in	ax, dx
  1735                                  	; 29/05/2024
  1736 00000A1F 668B15[A8380000]        	mov	dx, [NAMBAR]
  1737 00000A26 6683C226                	add	dx, CODEC_REG_POWERDOWN
  1738                                  	; 31/05/2024
  1739 00000A2A B402                    	mov	ah, 2	; read port, word
  1740 00000A2C CD34                    	int	34h
  1741                                  
  1742                                  	; 31/05/2024
  1743                                  	;call	delay1_4ms
  1744                                  	
  1745 00000A2E 6683E00F                	and	ax, 0Fh
  1746 00000A32 3C0F                    	cmp	al, 0Fh
  1747 00000A34 7403                    	je	short _ac97_codec_init_ok
  1748 00000A36 E2E2                    	loop	_ac97_codec_rloop 
  1749                                  
  1750                                  init_ac97_codec_err1:
  1751                                  	;stc	; cf = 1 ; 19/05/2024
  1752                                  init_ac97_codec_err2:
  1753 00000A38 C3                      	retn
  1754                                  
  1755                                  _ac97_codec_init_ok:
  1756 00000A39 E8DA000000              	call 	reset_ac97_controller
  1757                                  
  1758                                  	; 31/05/2024
  1759                                  	; 30/05/2024
  1760                                  	; 19/05/2024
  1761                                  	;call	delay_100ms
  1762                                  
  1763                                  	; 30/05/2024
  1764                                  	;call	delay1_4ms
  1765                                  	;call	delay1_4ms
  1766                                  	;call	delay1_4ms
  1767                                  	;call	delay1_4ms
  1768                                  
  1769                                  	; 01/12/2024
  1770                                  setup_ac97_codec:
  1771                                  	; 12/11/2023
  1772 00000A3E 66813D[24380000]80-     	cmp	word [WAVE_SampleRate], 48000
  1772 00000A46 BB                 
  1773 00000A47 0F849C000000            	je	skip_rate
  1774                                  	
  1775                                  	; 31/05/2024
  1776                                  	; 30/05/2024
  1777                                  	; 29/05/2024
  1778                                  	;cmp	byte [VRA], 0
  1779                                  	;jna	short skip_rate
  1780                                  
  1781                                  	; 11/11/2023
  1782 00000A4D 668B15[A8380000]        	mov	dx, [NAMBAR]
  1783 00000A54 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1784                                  	;in	ax, dx
  1785                                  	; 29/05/2024
  1786 00000A58 B402                    	mov	ah, 2 ; read port, word
  1787 00000A5A CD34                    	int	34h
  1788                                  
  1789                                  	; 30/05/2024
  1790                                  	; 19/05/2024
  1791 00000A5C E82E020000              	call	delay1_4ms
  1792                                  
  1793                                  	;and	al, ~BIT1 ; Clear DRA
  1794                                  	;;;
  1795                                  	; 30/05/2024
  1796 00000A61 24FC                    	and	al, ~(BIT1+BIT0) ; Clear DRA+VRA
  1797                                  	; 01/12/2024 (FASM)
  1798                                  	;and	al, NOT (BIT1+BIT0) ; 0FCh
  1799                                  	;out	dx, ax
  1800                                  	; 31/05/2024
  1801 00000A63 53                      	push	ebx
  1802 00000A64 89C3                    	mov	ebx, eax
  1803 00000A66 668B15[A8380000]        	mov	dx, [NAMBAR]
  1804 00000A6D 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1805 00000A71 B403                    	mov	ah, 3 ; write port, word
  1806 00000A73 CD34                    	int	34h
  1807 00000A75 5B                      	pop	ebx
  1808                                  
  1809                                  	; 31/05/2024
  1810 00000A76 E8B1010000              	call	check_vra
  1811                                  
  1812                                  	; 31/05/2024 - temporary (interpolated sample rate test)
  1813                                  	;mov	byte [VRA], 0
  1814                                  
  1815                                  	; 31/05/2024
  1816 00000A7B 803D[09380000]00        	cmp	byte [VRA], 0
  1817 00000A82 7665                    	jna	short skip_rate
  1818                                  
  1819 00000A84 668B15[A8380000]        	mov	dx, [NAMBAR]
  1820 00000A8B 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1821                                  	;in	ax, dx
  1822                                  	; 31/05/2024
  1823 00000A8F B402                    	mov	ah, 2 ; read port, word
  1824 00000A91 CD34                    	int	34h
  1825                                  
  1826                                  	;and	al, ~BIT1 ; Clear DRA
  1827                                  	;;;
  1828                                  
  1829 00000A93 0C01                    	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
  1830                                  	;out	dx, ax	; Enable variable rate audio
  1831                                  	; 29/05/2024
  1832 00000A95 53                      	push	ebx
  1833 00000A96 89C3                    	mov	ebx, eax
  1834                                  	;
  1835                                  	; 30/05/2024
  1836 00000A98 668B15[A8380000]        	mov	dx, [NAMBAR]
  1837 00000A9F 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1838                                  	;
  1839 00000AA3 B403                    	mov	ah, 3 ; write port, word
  1840 00000AA5 CD34                    	int	34h
  1841 00000AA7 5B                      	pop	ebx
  1842                                  
  1843                                  	;mov	cx, 10
  1844 00000AA8 B90A000000              	mov	ecx, 10 ; 30/05/2024
  1845                                  check_vra_loop:
  1846                                  	; 31/05/2024
  1847                                  	;call	delay_100ms
  1848                                  	; 30/05/2024
  1849 00000AAD E8DD010000              	call	delay1_4ms
  1850                                  
  1851                                  	; 11/11/2023
  1852                                  	;in	ax, dx
  1853                                  	; 29/05/2024
  1854 00000AB2 668B15[A8380000]        	mov	dx, [NAMBAR]
  1855 00000AB9 6683C22A                	add	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1856 00000ABD B402                    	mov	ah, 2 ; read port, word
  1857 00000ABF CD34                    	int	34h
  1858                                  
  1859 00000AC1 A801                    	test	al, AC97_EA_VRA ; 1
  1860 00000AC3 750B                    	jnz	short set_rate
  1861                                  
  1862                                  	; 11/11/2023
  1863 00000AC5 E2E6                    	loop	check_vra_loop
  1864                                  
  1865                                  ;vra_not_supported:	; 19/05/2024
  1866 00000AC7 C605[09380000]00        	mov	byte [VRA], 0
  1867 00000ACE EB19                    	jmp	short skip_rate
  1868                                  
  1869                                  set_rate:
  1870                                  	;mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1871                                  	; 01/12/2024
  1872 00000AD0 66A1[24380000]          	mov	ax, [WAVE_SampleRate]
  1873                                  
  1874 00000AD6 668B15[A8380000]        	mov    	dx, [NAMBAR]
  1875 00000ADD 6683C22C                	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch
  1876                                  	;out	dx, ax 	; PCM Front/Center Output Sample Rate
  1877                                  	; 29/05/2024
  1878 00000AE1 53                      	push	ebx
  1879 00000AE2 89C3                    	mov	ebx, eax  ; bx = data, word
  1880 00000AE4 B403                    	mov	ah, 3 ; write port, word
  1881 00000AE6 CD34                    	int	34h
  1882 00000AE8 5B                      	pop	ebx
  1883                                  
  1884                                  	; 29/05/2024
  1885                                  	;call	delay_100ms
  1886                                  	; 30/05/2024
  1887                                  	;call	delay1_4ms
  1888                                  
  1889                                  	; 12/11/2023
  1890                                  skip_rate:
  1891 00000AE9 66B80202                	mov	ax, 0202h
  1892 00000AED 668B15[A8380000]          	mov	dx, [NAMBAR]
  1893 00000AF4 6683C202                  	add	dx, CODEC_MASTER_VOL_REG ;02h
  1894                                  	;out	dx, ax
  1895                                  	; 29/05/2024
  1896 00000AF8 53                      	push	ebx
  1897 00000AF9 89C3                    	mov	ebx, eax  ; bx = data, word
  1898 00000AFB B403                    	mov	ah, 3 ; write port, word
  1899 00000AFD CD34                    	int	34h
  1900 00000AFF 5B                      	pop	ebx
  1901                                  
  1902                                  	; 29/05/2024
  1903                                  	;call	delay1_4ms
  1904                                  	;call	delay1_4ms
  1905                                  	;call	delay1_4ms
  1906                                  	;call	delay1_4ms
  1907                                  
  1908 00000B00 66B80202                	mov	ax, 0202h
  1909 00000B04 668B15[A8380000]          	mov	dx, [NAMBAR]
  1910 00000B0B 6683C218                  	add	dx, CODEC_PCM_OUT_REG		;18h
  1911                                    	;out	dx, ax
  1912                                  	; 29/05/2024
  1913 00000B0F 53                      	push	ebx
  1914 00000B10 89C3                    	mov	ebx, eax  ; bx = data, word
  1915 00000B12 B403                    	mov	ah, 3 ; write port, word
  1916 00000B14 CD34                    	int	34h
  1917 00000B16 5B                      	pop	ebx
  1918                                  
  1919                                   	; 29/05/2024
  1920                                  	;call	delay1_4ms
  1921                                  	;call	delay1_4ms
  1922                                  	;call	delay1_4ms
  1923                                  	;call	delay1_4ms
  1924                                  
  1925                                  	; 19/05/2024
  1926                                  	;clc
  1927                                  
  1928 00000B17 C3                              retn
  1929                                  
  1930                                  reset_ac97_controller:
  1931                                  	; 29/05/2024 (TRDOS 386)
  1932                                  	; 19/05/2024
  1933                                  	; 11/11/2023
  1934                                  	; 10/06/2017
  1935                                  	; 29/05/2017
  1936                                  	; 28/05/2017
  1937                                  	; reset AC97 audio controller registers
  1938 00000B18 31C0                    	xor	eax, eax
  1939 00000B1A 66BA0B00                        mov	dx, PI_CR_REG
  1940 00000B1E 660315[AA380000]        	add	dx, [NABMBAR]
  1941                                  	;out	dx, al
  1942                                  	; 29/05/2024
  1943                                  	; al = data, byte
  1944 00000B25 B401                    	mov	ah, 1 ; write port, byte
  1945 00000B27 CD34                    	int	34h
  1946                                  
  1947                                  	; 19/05/2024
  1948                                  	;call	delay1_4ms
  1949                                  
  1950 00000B29 66BA1B00                        mov     dx, PO_CR_REG
  1951 00000B2D 660315[AA380000]        	add	dx, [NABMBAR]
  1952                                  	;out	dx, al
  1953                                  	; 29/05/2024
  1954                                  	; al = data, byte
  1955 00000B34 B401                    	mov	ah, 1 ; write port, byte
  1956 00000B36 CD34                    	int	34h
  1957                                  
  1958                                  	; 19/05/2024
  1959                                  	;call	delay1_4ms
  1960                                  
  1961 00000B38 66BA2B00                        mov     dx, MC_CR_REG
  1962 00000B3C 660315[AA380000]        	add	dx, [NABMBAR]
  1963                                  	;out	dx, al
  1964                                  	; 29/05/2024
  1965                                  	; al = data, byte
  1966 00000B43 B401                    	mov	ah, 1 ; write port, byte
  1967 00000B45 CD34                    	int	34h
  1968                                  
  1969                                  	; 19/05/2024
  1970                                  	;call	delay1_4ms
  1971                                  
  1972 00000B47 B002                            mov	al, RR
  1973 00000B49 66BA0B00                        mov	dx, PI_CR_REG
  1974 00000B4D 660315[AA380000]        	add	dx, [NABMBAR]
  1975                                  	;out	dx, al
  1976                                  	; 29/05/2024
  1977                                  	; al = data, byte
  1978 00000B54 B401                    	mov	ah, 1 ; write port, byte
  1979 00000B56 CD34                    	int	34h
  1980                                  
  1981                                  	; 19/05/2024
  1982                                  	;call	delay1_4ms
  1983                                  
  1984 00000B58 66BA1B00                        mov	dx, PO_CR_REG
  1985 00000B5C 660315[AA380000]        	add	dx, [NABMBAR]
  1986                                  	;out	dx, al
  1987                                  	; 29/05/2024
  1988                                  	; al = data, byte
  1989 00000B63 B401                    	mov	ah, 1 ; write port, byte
  1990 00000B65 CD34                    	int	34h
  1991                                  
  1992                                  	; 19/05/2024
  1993                                  	;call	delay1_4ms
  1994                                  
  1995 00000B67 66BA2B00                        mov	dx, MC_CR_REG
  1996 00000B6B 660315[AA380000]        	add	dx, [NABMBAR]
  1997                                  	;out	dx, al
  1998                                  	; 29/05/2024
  1999                                  	; al = data, byte
  2000 00000B72 B401                    	mov	ah, 1 ; write port, byte
  2001 00000B74 CD34                    	int	34h
  2002                                  
  2003                                  	; 19/05/2024
  2004                                  	;call	delay1_4ms
  2005                                  
  2006 00000B76 C3                      	retn
  2007                                  
  2008                                  reset_ac97_codec:
  2009                                  	; 29/05/2024 (TRDOS 386)
  2010                                  	; 11/11/2023
  2011                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  2012 00000B77 66BA2C00                	mov	dx, GLOB_CNT_REG ; 2Ch
  2013 00000B7B 660315[AA380000]        	add	dx, [NABMBAR]
  2014                                  	;in	eax, dx
  2015                                  	; 29/05/2024
  2016 00000B82 B404                    	mov	ah, 4 ; read port, dword
  2017 00000B84 CD34                    	int	34h
  2018                                  
  2019                                  	;test	eax, 2
  2020                                  	; 06/08/2022
  2021 00000B86 A802                    	test	al, 2
  2022 00000B88 7407                    	jz	short _r_ac97codec_cold
  2023                                  
  2024 00000B8A E80F000000              	call	warm_ac97codec_reset
  2025 00000B8F 7308                    	jnc	short _r_ac97codec_ok
  2026                                  _r_ac97codec_cold:
  2027 00000B91 E845000000                      call	cold_ac97codec_reset
  2028 00000B96 7301                            jnc	short _r_ac97codec_ok
  2029                                  	
  2030                                  	; 16/04/2017
  2031                                          ;xor	eax, eax	; timeout error
  2032                                         	;stc
  2033 00000B98 C3                      	retn
  2034                                  
  2035                                  _r_ac97codec_ok:
  2036 00000B99 31C0                            xor     eax, eax
  2037                                          ;mov	al, VIA_ACLINK_C00_READY ; 1
  2038 00000B9B FEC0                            inc	al
  2039 00000B9D C3                      	retn
  2040                                  
  2041                                  warm_ac97codec_reset:
  2042                                  	; 29/05/2024 (TRDOS 386)
  2043                                  	; 11/11/2023
  2044                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  2045                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  2046 00000B9E B806000000              	mov	eax, 6
  2047 00000BA3 66BA2C00                	mov	dx, GLOB_CNT_REG ; 2Ch
  2048 00000BA7 660315[AA380000]        	add	dx, [NABMBAR]
  2049                                  	;out	dx, eax
  2050                                  	; 29/05/2024
  2051 00000BAE 53                      	push	ebx
  2052 00000BAF 89C3                    	mov	ebx, eax  ; ebx = data, dword
  2053 00000BB1 B405                    	mov	ah, 5 ; write port, dword
  2054 00000BB3 CD34                    	int	34h
  2055 00000BB5 5B                      	pop	ebx
  2056                                  
  2057                                  	; 30/05/2024
  2058 00000BB6 B90A000000              	mov	ecx, 10	; total 1s
  2059                                  	; 29/05/2024
  2060                                  	;mov	ecx, 4000
  2061                                  _warm_ac97c_rst_wait:
  2062                                  	; 30/05/2024
  2063 00000BBB E8C0000000              	call	delay_100ms
  2064                                  
  2065 00000BC0 66BA3000                	mov	dx, GLOB_STS_REG ; 30h
  2066 00000BC4 660315[AA380000]        	add	dx, [NABMBAR]
  2067                                  	;in	eax, dx
  2068                                  	; 29/05/2024
  2069 00000BCB B404                    	mov	ah, 4 ; read port, dword
  2070 00000BCD CD34                    	int	34h
  2071                                  
  2072 00000BCF A900030010              	test	eax, CTRL_ST_CREADY
  2073 00000BD4 7504                    	jnz	short _warm_ac97c_rst_ok
  2074                                  
  2075 00000BD6 49                      	dec	ecx
  2076 00000BD7 75E2                    	jnz	short _warm_ac97c_rst_wait
  2077                                  
  2078                                  _warm_ac97c_rst_fail:
  2079 00000BD9 F9                              stc
  2080                                  _warm_ac97c_rst_ok:
  2081 00000BDA C3                      	retn
  2082                                  
  2083                                  cold_ac97codec_reset:
  2084                                  	; 11/11/2023
  2085                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  2086                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  2087 00000BDB B802000000                      mov	eax, 2
  2088 00000BE0 66BA2C00                	mov	dx, GLOB_CNT_REG ; 2Ch
  2089 00000BE4 660315[AA380000]        	add	dx, [NABMBAR]
  2090                                  	;out	dx, eax
  2091                                  	; 29/05/2024
  2092 00000BEB 53                      	push	ebx
  2093 00000BEC 89C3                    	mov	ebx, eax  ; ebx = data, dword
  2094 00000BEE B405                    	mov	ah, 5 ; write port, dword
  2095 00000BF0 CD34                    	int	34h
  2096 00000BF2 5B                      	pop	ebx
  2097                                  
  2098                                  	; 30/05/2024
  2099 00000BF3 E888000000              	call	delay_100ms 	; wait 100 ms
  2100 00000BF8 E883000000              	call	delay_100ms 	; wait 100 ms
  2101 00000BFD E87E000000              	call	delay_100ms 	; wait 100 ms
  2102 00000C02 E879000000              	call	delay_100ms 	; wait 100 ms
  2103                                  
  2104                                  	; 30/05/2024
  2105 00000C07 B910000000              	mov	ecx, 16	; total 20*100 ms = 2s
  2106                                  	; 29/05/2024
  2107                                  	;mov	ecx, 16000
  2108                                  _cold_ac97c_rst_wait:
  2109 00000C0C 66BA3000                	mov	dx, GLOB_STS_REG ; 30h
  2110 00000C10 660315[AA380000]        	add	dx, [NABMBAR]
  2111                                  	;in	eax, dx
  2112                                  	; 29/05/2024
  2113 00000C17 B404                    	mov	ah, 4 ; read port, dword
  2114 00000C19 CD34                    	int	34h
  2115                                  
  2116 00000C1B A900030010              	test	eax, CTRL_ST_CREADY
  2117 00000C20 7509                    	jnz	short _cold_ac97c_rst_ok
  2118                                  
  2119                                  	; 30/05/2024
  2120                                  	; 29/05/2024
  2121 00000C22 E859000000              	call	delay_100ms
  2122                                  
  2123 00000C27 49                      	dec	ecx
  2124 00000C28 75E2                    	jnz	short _cold_ac97c_rst_wait
  2125                                  
  2126                                  _cold_ac97c_rst_fail:
  2127 00000C2A F9                              stc
  2128                                  _cold_ac97c_rst_ok:
  2129 00000C2B C3                      	retn
  2130                                  
  2131                                  ; 29/12/2024 (vgaplay3.s, NASM)
  2132                                  ; 18/12/2024 (ac97play.s, FASM)
  2133                                  ; 13/11/2024
  2134                                  ; 30/05/2024
  2135                                  %if 1
  2136                                  ;if 1
  2137                                  check_vra:
  2138                                  	; 29/05/2024
  2139 00000C2C C605[09380000]01        	mov	byte [VRA], 1
  2140                                  
  2141                                  	; 29/05/2024 - audio.s (TRDOS 386 Kernel) - 27/05/2024
  2142                                  	; 24/05/2024
  2143                                  	; 23/05/2024
  2144 00000C33 668B15[A8380000]        	mov	dx, [NAMBAR]
  2145 00000C3A 6683C228                	add	dx, CODEC_EXT_AUDIO_REG	; 28h
  2146                                  	;in	ax, dx
  2147                                  	; 29/05/2024
  2148 00000C3E B402                    	mov	ah, 2 ; read port, word
  2149 00000C40 CD34                    	int	34h
  2150                                  
  2151                                  	; 30/05/2024
  2152                                  	; 23/05/2024
  2153 00000C42 E848000000              	call	delay1_4ms
  2154                                  
  2155                                  	; 29/05/2024
  2156 00000C47 A801                    	test	al, BIT0
  2157                                  	;test	al, 1 ; BIT0 ; Variable Rate Audio bit
  2158 00000C49 7507                    	jnz	short check_vra_ok
  2159                                  
  2160                                  vra_not_supported:
  2161                                  	; 13/11/2023
  2162 00000C4B C605[09380000]00        	mov	byte [VRA], 0
  2163                                  check_vra_ok:
  2164 00000C52 C3                      	retn
  2165                                  ;end if
  2166                                  %endif
  2167                                  
  2168                                  ; --------------------------------------------------------
  2169                                  ; --------------------------------------------------------
  2170                                  
  2171                                  ; 29/12/2024 (vgaplay3.s)
  2172                                  ; 18/12/2024 (ac97play.s)
  2173                                  ;
  2174                                  ; 18/11/2024
  2175                                  ; Ref: TRDOS 386 v2.0.9, audio.s, Erdogan Tan, 06/06/2024
  2176                                  
  2177                                  ac97_stop: 
  2178                                  	; 18/11/2024
  2179 00000C53 C605[FC370000]02        	mov	byte [stopped], 2
  2180                                  
  2181                                  ac97_po_cmd@:
  2182 00000C5A 30C0                    	xor	al, al ; 0
  2183                                  ac97_po_cmd:
  2184 00000C5C 668B15[AA380000]        	mov     dx, [NABMBAR]
  2185 00000C63 6683C21B                        add     dx, PO_CR_REG	; PCM out control register
  2186                                  	;out	dx, al
  2187                                  	; 01/12/2024
  2188 00000C67 B401                    	mov	ah, 1 ; write port, byte
  2189 00000C69 CD34                    	int	34h
  2190 00000C6B C3                      	retn
  2191                                  
  2192                                  ac97_pause:
  2193 00000C6C C605[FC370000]01        	mov	byte [stopped], 1 ; paused
  2194                                  	;mov	al, 0
  2195                                  	;jmp	short ac97_po_cmd
  2196 00000C73 EBE5                    	jmp	short ac97_po_cmd@
  2197                                  
  2198                                  ac97_play: ; continue to play (after pause)
  2199 00000C75 C605[FC370000]00        	mov	byte [stopped], 0
  2200 00000C7C B001                    	mov	al, RPBM
  2201 00000C7E EBDC                    	jmp	short ac97_po_cmd
  2202                                  
  2203                                  ; --------------------------------------------------------
  2204                                  
  2205                                  PORTB		EQU 061h
  2206                                  REFRESH_STATUS	EQU 010h	; Refresh signal status
  2207                                  
  2208                                  	; 29/12/2024 (vgaplay3.s)
  2209                                  	; 18/12/2024
  2210                                  	; 01/12/2024 (ac97play.s)
  2211                                  delay_100ms:
  2212                                  	; 30/05/2024 (playwav7.s)
  2213 00000C80 51                      	push	ecx
  2214 00000C81 B990010000              	mov	ecx, 400  ; 400*0.25ms
  2215                                  _delay_x_ms:
  2216 00000C86 E804000000              	call	delay1_4ms
  2217 00000C8B E2F9                            loop	_delay_x_ms
  2218 00000C8D 59                      	pop	ecx
  2219 00000C8E C3                      	retn
  2220                                  
  2221                                  delay1_4ms:
  2222                                  	; 30/05/2024 (TRDOS 386)
  2223 00000C8F 50                              push    eax 
  2224 00000C90 51                              push    ecx
  2225 00000C91 53                      	push	ebx
  2226 00000C92 52                      	push	edx
  2227 00000C93 B910000000                      mov     ecx, 16			; close enough.
  2228                                  	;in	al, PORTB
  2229                                  	; 30/05/2024
  2230 00000C98 66BA6100                	mov	dx, PORTB
  2231 00000C9C B400                    	mov	ah, 0  ; read port, byte
  2232 00000C9E CD34                    	int	34h
  2233                                  
  2234 00000CA0 2410                    	and	al, REFRESH_STATUS
  2235                                  	;mov	ah, al			; Start toggle state
  2236 00000CA2 88C3                    	mov	bl, al
  2237 00000CA4 09C9                    	or	ecx, ecx
  2238 00000CA6 7401                    	jz	short _d4ms1
  2239 00000CA8 41                      	inc	ecx			; Throwaway first toggle
  2240                                  _d4ms1:	
  2241                                  	;in	al, PORTB		; Read system control port
  2242                                  	; 30/05/2024
  2243 00000CA9 66BA6100                	mov	dx, PORTB
  2244 00000CAD B400                    	mov	ah, 0  ; read port, byte
  2245 00000CAF CD34                    	int	34h
  2246                                  
  2247 00000CB1 2410                    	and	al, REFRESH_STATUS	; Refresh toggles 15.085 microseconds
  2248                                  	;cmp	ah, al
  2249 00000CB3 38C3                    	cmp	bl, al
  2250 00000CB5 74F2                    	je	short _d4ms1		; Wait for state change
  2251                                  
  2252                                  	;mov	ah, al			; Update with new state
  2253 00000CB7 88C3                    	mov	bl, al
  2254 00000CB9 49                      	dec	ecx
  2255 00000CBA 75ED                    	jnz	short _d4ms1
  2256                                  
  2257 00000CBC 5A                      	pop	edx
  2258 00000CBD 5B                              pop	ebx
  2259 00000CBE 59                      	pop	ecx
  2260 00000CBF 58                              pop	eax
  2261                                  c4ue_okk:
  2262 00000CC0 C3                              retn
  2263                                  
  2264                                  ; --------------------------------------------------------
  2265                                  
  2266                                  getCurrentIndex:
  2267                                  	; returns AL = current index value
  2268                                  	; 01/12/2024
  2269                                  	; 29/05/2024 (TRDOS 386)
  2270                                  	; 08/11/2023
  2271 00000CC1 668B15[AA380000]        	mov	dx, [NABMBAR]
  2272 00000CC8 6683C214                	add	dx, PO_CIV_REG
  2273                                  	;in	al, dx
  2274                                  	; 29/05/2024
  2275 00000CCC B400                    	mov	ah, 0 ; read port, byte
  2276 00000CCE CD34                    	int	34h
  2277                                  uLVI2:	;	06/11/2023
  2278 00000CD0 C3                      	retn
  2279                                  
  2280                                  ; --------------------------------------------------------
  2281                                  
  2282                                  updateLVI:
  2283                                  	; 01/12/2024
  2284                                  	; 29/05/2024 (TRDOS 386)
  2285                                  	; 08/11/2023
  2286                                  	; 07/11/2023
  2287                                  	; 06/11/2023
  2288 00000CD1 668B15[AA380000]        	mov	dx, [NABMBAR]
  2289 00000CD8 6683C214                	add	dx, PO_CIV_REG
  2290                                  	; (Current Index Value and Last Valid Index value)
  2291                                  	;in	ax, dx
  2292                                  	; 29/05/2024
  2293 00000CDC B402                    	mov	ah, 2 ; read port, word
  2294 00000CDE CD34                    	int	34h
  2295                                  
  2296 00000CE0 38E0                    	cmp	al, ah ; is current index = last index ?
  2297 00000CE2 75EC                    	jne	short uLVI2
  2298                                  
  2299                                  	; 08/11/2023	
  2300 00000CE4 E8D8FFFFFF              	call	getCurrentIndex
  2301                                   
  2302 00000CE9 F605[3A380000]01        	test	byte [flags], ENDOFFILE
  2303                                  	;jnz	short uLVI1
  2304 00000CF0 7418                    	jz	short uLVI0  ; 08/11/2023
  2305                                  
  2306                                  	; 08/11/2023
  2307 00000CF2 50                      	push	eax	; 29/05/2024 (32 bit)
  2308 00000CF3 668B15[AA380000]        	mov	dx, [NABMBAR]
  2309 00000CFA 6683C216                	add	dx, PO_SR_REG  ; PCM out status register
  2310                                  	;in	ax, dx
  2311                                  	; 29/05/2024
  2312 00000CFE B402                    	mov	ah, 2 ; read port, word
  2313 00000D00 CD34                    	int	34h
  2314                                  
  2315 00000D02 A803                    	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
  2316                                  		      ; (has been processed)
  2317                                  		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
  2318 00000D04 58                      	pop	eax
  2319 00000D05 7407                    	jz	short uLVI1
  2320                                  uLVI3:
  2321 00000D07 31C0                    	xor	eax, eax
  2322                                  	; zf = 1
  2323 00000D09 C3                      	retn
  2324                                  uLVI0:
  2325                                          ; not at the end of the file yet.
  2326 00000D0A FEC8                    	dec	al
  2327 00000D0C 241F                    	and	al, 1Fh
  2328                                  uLVI1:
  2329                                  	;call	setLastValidIndex
  2330                                  ;uLVI2:
  2331                                  	;retn
  2332                                  
  2333                                  ;input AL = index # to stop on
  2334                                  setLastValidIndex:
  2335                                  	; 01/12/2024
  2336                                  	; 29/05/2024 (TRDOS 386)
  2337                                  	; 08/11/2023
  2338 00000D0E 668B15[AA380000]        	mov	dx, [NABMBAR]
  2339 00000D15 6683C215                	add	dx, PO_LVI_REG
  2340                                          ;out	dx, al
  2341                                  	; 29/05/2024
  2342                                  	; al = data, byte
  2343 00000D19 B401                    	mov	ah, 1 ; write port, byte
  2344 00000D1B CD34                    	int	34h
  2345 00000D1D C3                      	retn
  2346                                  
  2347                                  ; --------------------------------------------------------
  2348                                  ; 07/12/2024
  2349                                  ; --------------------------------------------------------
  2350                                  
  2351                                  ; /////
  2352                                  	; 14/12/2024
  2353                                  	; 07/12/2024
  2354                                  	; 01/12/2024
  2355                                  	; 30/05/2024 (ich_wav4.asm, 19/05/2024)
  2356                                  loadFromFile:
  2357                                  	; 07/11/2023
  2358                                  
  2359 00000D1E F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2360                                  					; last of the file?
  2361 00000D25 7402                    	jz	short lff_0		; no
  2362 00000D27 F9                      	stc
  2363 00000D28 C3                      	retn
  2364                                  
  2365                                  lff_0:
  2366                                  	; 07/12/2024
  2367                                  	; 26/11/2023 (playwav8.s)
  2368                                  	;mov	edi, audio_buffer
  2369                                  
  2370                                  	; 01/12/2024 (TRDOS 386)
  2371                                  	; edi = audio buffer address
  2372                                  
  2373                                  	; 14/12/2024
  2374                                  	; 01/12/2024
  2375                                  	; 17/11/2024
  2376                                  	;mov	ebx, [filehandle]
  2377                                  	; 02/12/2024
  2378                                  	;mov	edx, [loadsize] 
  2379                                  
  2380                                  	; 17/11/2024
  2381 00000D29 803D[9E380000]00        	cmp	byte [fbs_shift], 0
  2382 00000D30 7677                    	jna	short lff_1 ; stereo, 16 bit
  2383                                  
  2384                                  lff_2:
  2385                                  	; 01/12/2024
  2386 00000D32 BE[00500200]            	mov	esi, temp_buffer 
  2387                                  	; 14/12/2024
  2388                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000D37 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000D3D 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00000D3F 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000D45 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00000D4A CD40                <1>  int 40h
  2389 00000D4C 0F8289000000            	jc	lff_4 ; error !
  2390                                  
  2391                                  	; 01/12/2024
  2392                                  	; 14/11/2024
  2393 00000D52 A3[C0380000]            	mov	[count], eax
  2394                                  
  2395                                  	; 01/12/2024
  2396 00000D57 21C0                    	and	eax, eax
  2397                                  	;jz	short lff_3
  2398                                  	; 14/12/2024
  2399 00000D59 0F8485000000            	jz	lff_10
  2400                                  
  2401 00000D5F 8A1D[9E380000]          	mov	bl, [fbs_shift]
  2402                                  
  2403                                  	; 14/12/2024
  2404 00000D65 89FA                    	mov	edx, edi ; audio buffer start address
  2405                                  
  2406                                  	; 01/12/2024
  2407 00000D67 89C1                    	mov	ecx, eax
  2408 00000D69 803D[2E380000]08        	cmp	byte [WAVE_BitsPerSample], 8 ; bits per sample (8 or 16)
  2409 00000D70 751E                    	jne	short lff_7 ; 16 bit samples
  2410                                  	; 8 bit samples
  2411 00000D72 FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
  2412 00000D74 740E                    	jz	short lff_6 ; 8 bit, stereo
  2413                                  	; 01/12/2024 (32bit registers)
  2414                                  lff_5:
  2415                                  	; mono & 8 bit
  2416 00000D76 AC                      	lodsb
  2417 00000D77 2C80                    	sub	al, 80h ; 08/11/2023
  2418 00000D79 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
  2419 00000D7C 66AB                    	stosw	; left channel
  2420 00000D7E 66AB                    	stosw	; right channel
  2421 00000D80 E2F4                    	loop	lff_5
  2422 00000D82 EB16                    	jmp	short lff_9
  2423                                  lff_6:
  2424                                  	; stereo & 8 bit
  2425 00000D84 AC                      	lodsb
  2426 00000D85 2C80                    	sub	al, 80h ; 08/11/2023
  2427 00000D87 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
  2428 00000D8A 66AB                    	stosw
  2429 00000D8C E2F6                    	loop	lff_6
  2430 00000D8E EB0A                    	jmp	short lff_9
  2431                                  lff_7:
  2432 00000D90 D1E9                    	shr	ecx, 1 ; word count
  2433                                  lff_8:
  2434 00000D92 66AD                    	lodsw
  2435 00000D94 66AB                    	stosw	; left channel
  2436 00000D96 66AB                    	stosw	; right channel
  2437 00000D98 E2F8                    	loop	lff_8
  2438                                  lff_9:
  2439                                  	; 14/12/2024
  2440 00000D9A 89F8                    	mov	eax, edi
  2441 00000D9C 8B0D[B4380000]          	mov	ecx, [buffersize] 
  2442 00000DA2 01D1                    	add	ecx, edx ; + buffer start address
  2443 00000DA4 39C8                    	cmp	eax, ecx	
  2444 00000DA6 7225                    	jb	short lff_3
  2445 00000DA8 C3                      	retn
  2446                                  	
  2447                                  lff_1:  
  2448                                  	; 07/12/2024
  2449                                  	; 01/12/2024
  2450                                  	;sys 	_read, [filehandle], esi, [loadsize] ; edx
  2451                                  	; 14/12/2024
  2452                                  	sys 	_read, [filehandle], edi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000DA9 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000DAF 89F9                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00000DB1 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000DB7 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00000DBC CD40                <1>  int 40h
  2453                                  	; 07/11/2023
  2454 00000DBE 721B                    	jc	short lff_4 ; error !
  2455                                  
  2456                                  	; 01/12/2024
  2457                                  	; 14/11/2024
  2458 00000DC0 A3[C0380000]            	mov	[count], eax
  2459                                  
  2460                                  	; 02/12/2024
  2461 00000DC5 39D0                    	cmp	eax, edx ; cmp eax, [loadsize]	
  2462 00000DC7 7411                    	je	short endLFF
  2463                                  	; edi = buffer (start) address
  2464 00000DC9 01C7                    	add	edi, eax
  2465 00000DCB 89D1                    	mov	ecx, edx
  2466                                  lff_3:
  2467                                  	;call	padfill			; blank pad the remainder
  2468                                  	; 21/12/2024
  2469                                  padfill:
  2470                                  	; 14/12/2024
  2471                                  	; 01/12/2024 (TRDOS 386, 32bit registers)
  2472                                  	; 17/11/2024
  2473                                  	;   di = offset (to be filled with ZEROs)
  2474                                  	;   bp = buffer segment
  2475                                  	;   ax = di = number of bytes loaded
  2476                                  	;   cx = buffer size (> loaded bytes)	
  2477                                  	; 07/11/2023
  2478                                  	; 06/11/2023
  2479                                  	; 17/02/2017
  2480                                  	; 01/12/2024
  2481 00000DCD 29C1                    	sub	ecx, eax
  2482                                  	; 01/12/2024
  2483                                  	; 25/11/2024
  2484 00000DCF 31C0                    	xor	eax, eax
  2485                                  	; 14/12/2024
  2486 00000DD1 F3AA                    	rep	stosb
  2487                                  	; 21/12/2024
  2488                                  	;retn
  2489                                  	; ----------
  2490                                          ;clc				; don't exit with CY yet.
  2491 00000DD3 800D[3A380000]01                or	byte [flags], ENDOFFILE	; end of file flag
  2492                                  endLFF:
  2493 00000DDA C3                              retn
  2494                                  lff_4:
  2495                                  	; 08/11/2023
  2496 00000DDB B021                    	mov	al, '!'  ; error
  2497 00000DDD E882F9FFFF              	call	tL0
  2498                                  
  2499                                  	; 01/12/2024
  2500 00000DE2 31C0                    	xor	eax, eax
  2501                                  lff_10:
  2502                                  	; 14/12/2024
  2503 00000DE4 8B0D[B4380000]          	mov	ecx, [buffersize]
  2504 00000DEA EBE1                    	jmp	short lff_3
  2505                                  
  2506                                  ; /////
  2507                                  
  2508                                  ; --------------------------------------------------------
  2509                                  ; --------------------------------------------------------
  2510                                  	
  2511                                  write_audio_dev_info:
  2512                                  	; 30/05/2024
  2513                                       	;sys_msg msgAudioCardInfo, 0Fh
  2514                                  	; 01/12/2024
  2515                                  	sys 	_msg, msgAudioCardInfo, 255, 0Fh
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00000DEC BB[FA2C0000]        <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00000DF1 B9FF000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00000DF6 BA0F000000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00000DFB B823000000          <1>  mov eax, %1
   104                              <1> 
   105 00000E00 CD40                <1>  int 40h
  2516 00000E02 C3                      	retn
  2517                                  
  2518                                  ; --------------------------------------------------------
  2519                                  
  2520                                  write_ac97_pci_dev_info:
  2521                                  	; 19/11/2024
  2522                                  	; 30/05/2024
  2523                                  	; 06/06/2017
  2524                                  	; 03/06/2017
  2525                                  	; BUS/DEV/FN
  2526                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  2527                                  	; DEV/VENDOR
  2528                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  2529                                  
  2530 00000E03 A1[A4380000]            	mov	eax, [dev_vendor]
  2531 00000E08 31DB                    	xor	ebx, ebx
  2532 00000E0A 88C3                    	mov	bl, al
  2533 00000E0C 88DA                    	mov	dl, bl
  2534 00000E0E 80E30F                  	and	bl, 0Fh
  2535 00000E11 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2536 00000E17 A2[672E0000]            	mov	[msgVendorId+3], al
  2537 00000E1C 88D3                    	mov	bl, dl
  2538 00000E1E C0EB04                  	shr	bl, 4
  2539 00000E21 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2540 00000E27 A2[662E0000]            	mov	[msgVendorId+2], al
  2541 00000E2C 88E3                    	mov	bl, ah
  2542 00000E2E 88DA                    	mov	dl, bl
  2543 00000E30 80E30F                  	and	bl, 0Fh
  2544 00000E33 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2545 00000E39 A2[652E0000]            	mov	[msgVendorId+1], al
  2546 00000E3E 88D3                    	mov	bl, dl
  2547 00000E40 C0EB04                  	shr	bl, 4
  2548 00000E43 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2549 00000E49 A2[642E0000]            	mov	[msgVendorId], al
  2550 00000E4E C1E810                  	shr	eax, 16
  2551 00000E51 88C3                    	mov	bl, al
  2552 00000E53 88DA                    	mov	dl, bl
  2553 00000E55 80E30F                  	and	bl, 0Fh
  2554 00000E58 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2555 00000E5E A2[782E0000]            	mov	[msgDevId+3], al
  2556 00000E63 88D3                    	mov	bl, dl
  2557 00000E65 C0EB04                  	shr	bl, 4
  2558 00000E68 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2559 00000E6E A2[772E0000]            	mov	[msgDevId+2], al
  2560 00000E73 88E3                    	mov	bl, ah
  2561 00000E75 88DA                    	mov	dl, bl
  2562 00000E77 80E30F                  	and	bl, 0Fh
  2563 00000E7A 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2564 00000E80 A2[762E0000]            	mov	[msgDevId+1], al
  2565 00000E85 88D3                    	mov	bl, dl
  2566 00000E87 C0EB04                  	shr	bl, 4
  2567 00000E8A 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2568 00000E90 A2[752E0000]            	mov	[msgDevId], al
  2569                                  
  2570 00000E95 A1[A0380000]            	mov	eax, [bus_dev_fn]
  2571 00000E9A C1E808                  	shr	eax, 8
  2572 00000E9D 88C3                    	mov	bl, al
  2573 00000E9F 88DA                    	mov	dl, bl
  2574 00000EA1 80E307                  	and	bl, 7 ; bit 0,1,2
  2575 00000EA4 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2576 00000EAA A2[9D2E0000]            	mov	[msgFncNo+1], al
  2577 00000EAF 88D3                    	mov	bl, dl
  2578 00000EB1 C0EB03                  	shr	bl, 3
  2579 00000EB4 88DA                    	mov	dl, bl
  2580 00000EB6 80E30F                  	and	bl, 0Fh
  2581 00000EB9 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2582 00000EBF A2[8F2E0000]            	mov	[msgDevNo+1], al
  2583 00000EC4 88D3                    	mov	bl, dl
  2584 00000EC6 C0EB04                  	shr	bl, 4
  2585 00000EC9 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2586 00000ECF A2[8E2E0000]            	mov	[msgDevNo], al
  2587 00000ED4 88E3                    	mov	bl, ah
  2588 00000ED6 88DA                    	mov	dl, bl
  2589 00000ED8 80E30F                  	and	bl, 0Fh
  2590 00000EDB 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2591 00000EE1 A2[832E0000]            	mov	[msgBusNo+1], al
  2592 00000EE6 88D3                    	mov	bl, dl
  2593 00000EE8 C0EB04                  	shr	bl, 4
  2594 00000EEB 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2595 00000EF1 A2[822E0000]            	mov	[msgBusNo], al
  2596                                  
  2597                                  	;mov	ax, [ac97_NamBar]
  2598 00000EF6 66A1[A8380000]          	mov	ax, [NAMBAR]
  2599 00000EFC 88C3                    	mov	bl, al
  2600 00000EFE 88DA                    	mov	dl, bl
  2601 00000F00 80E30F                  	and	bl, 0Fh
  2602 00000F03 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2603 00000F09 A2[AD2E0000]            	mov	[msgNamBar+3], al
  2604 00000F0E 88D3                    	mov	bl, dl
  2605 00000F10 C0EB04                  	shr	bl, 4
  2606 00000F13 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2607 00000F19 A2[AC2E0000]            	mov	[msgNamBar+2], al
  2608 00000F1E 88E3                    	mov	bl, ah
  2609 00000F20 88DA                    	mov	dl, bl
  2610 00000F22 80E30F                  	and	bl, 0Fh
  2611 00000F25 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2612 00000F2B A2[AB2E0000]            	mov	[msgNamBar+1], al
  2613 00000F30 88D3                    	mov	bl, dl
  2614 00000F32 C0EB04                  	shr	bl, 4
  2615 00000F35 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2616 00000F3B A2[AA2E0000]            	mov	[msgNamBar], al
  2617                                  
  2618                                  	;mov	ax, [ac97_NabmBar]
  2619 00000F40 66A1[AA380000]          	mov	ax, [NABMBAR]
  2620 00000F46 88C3                    	mov	bl, al
  2621 00000F48 88DA                    	mov	dl, bl
  2622 00000F4A 80E30F                  	and	bl, 0Fh
  2623 00000F4D 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2624 00000F53 A2[BD2E0000]            	mov	[msgNabmBar+3], al
  2625 00000F58 88D3                    	mov	bl, dl
  2626 00000F5A C0EB04                  	shr	bl, 4
  2627 00000F5D 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2628 00000F63 A2[BC2E0000]            	mov	[msgNabmBar+2], al
  2629 00000F68 88E3                    	mov	bl, ah
  2630 00000F6A 88DA                    	mov	dl, bl
  2631 00000F6C 80E30F                  	and	bl, 0Fh
  2632 00000F6F 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2633 00000F75 A2[BB2E0000]            	mov	[msgNabmBar+1], al
  2634 00000F7A 88D3                    	mov	bl, dl
  2635 00000F7C C0EB04                  	shr	bl, 4
  2636 00000F7F 8A83[202E0000]          	mov	al, [hex_chars+ebx]
  2637 00000F85 A2[BA2E0000]            	mov	[msgNabmBar], al
  2638                                  
  2639 00000F8A 31C0                    	xor	eax, eax
  2640 00000F8C A0[3B380000]            	mov	al, [ac97_int_ln_reg]
  2641 00000F91 B10A                    	mov	cl, 10
  2642 00000F93 F6F1                    	div	cl
  2643                                  	; 23/11/2024
  2644                                  	;add	[msgIRQ], ax
  2645 00000F95 66053030                	add	ax, 3030h
  2646 00000F99 66A3[C62E0000]          	mov	[msgIRQ], ax
  2647                                  	;and	al, al
  2648 00000F9F 3C30                    	cmp	al, 30h
  2649 00000FA1 750D                    	jnz	short _w_ac97imsg_
  2650 00000FA3 A0[C72E0000]            	mov	al, byte [msgIRQ+1]
  2651 00000FA8 B420                    	mov	ah, ' '
  2652 00000FAA 66A3[C62E0000]          	mov	[msgIRQ], ax
  2653                                  _w_ac97imsg_:
  2654                                  	; 19/11/2024
  2655 00000FB0 E88D1C0000              	call 	clear_window
  2656                                  	;mov	dh, 13
  2657                                  	; 30/12/2024 (video mode 13h)
  2658 00000FB5 B60B                    	mov	dh, 11
  2659 00000FB7 B200                    	mov	dl, 0
  2660 00000FB9 E8A9190000              	call	setCursorPosition
  2661                                  	;;;
  2662                                  	; 21/12/2024
  2663 00000FBE BD[312E0000]            	mov	ebp, msgAC97Info ; message
  2664                                  	; 22/12/2024
  2665                                  	;mov	cl, 07h ; color 
  2666 00000FC3 E81F000000              	call	sys_gmsg
  2667                                  	;
  2668                                  	; 30/05/2024
  2669                                  write_VRA_info:
  2670                                  	; 21/12/2024
  2671 00000FC8 BD[CB2E0000]            	mov	ebp, msgVRAheader ; message
  2672                                  	;mov	cl, 07h ; color 
  2673 00000FCD E815000000              	call	sys_gmsg
  2674                                  	;
  2675 00000FD2 803D[09380000]00        	cmp	byte [VRA], 0
  2676 00000FD9 7607                    	jna	short _w_VRAi_no
  2677                                  _w_VRAi_yes:
  2678 00000FDB BD[DA2E0000]            	mov	ebp, msgVRAyes
  2679 00000FE0 EB05                    	jmp	short _w_VRAi_yn_msg
  2680                                  _w_VRAi_no:
  2681 00000FE2 BD[E02E0000]            	mov	ebp, msgVRAno
  2682                                  _w_VRAi_yn_msg:
  2683                                  	;mov	cl, 07h ; color 
  2684                                  	;call	sys_msg
  2685                                  	;retn
  2686                                  	;jmp	short sys_gmsg
  2687                                  	;;;
  2688                                  ; --------------------------------------------------------
  2689                                  
  2690                                  	; 30/12/2024 (Video Mode 13h)
  2691                                  	; (write message in VGA/CGA mode)
  2692                                  	; 22/12/2024
  2693                                  	; 21/12/2024
  2694                                  	; (write message in VGA/VESA-VBE mode)
  2695                                  sys_gmsg:
  2696 00000FE7 8A4500                  	mov	al, [ebp]
  2697 00000FEA 20C0                    	and	al, al
  2698 00000FEC 7458                    	jz	short sys_gmsg_ok
  2699 00000FEE 3C20                    	cmp	al, 20h
  2700 00000FF0 731E                    	jnb	short sys_gmsg_3
  2701 00000FF2 3C0D                    	cmp	al, CR ; 13
  2702 00000FF4 750C                    	jne	short sys_gmsg_2
  2703                                  	; carriege return, move cursor to column 0
  2704 00000FF6 66C705[EC320000]00-     	mov	word [screenpos], 0
  2704 00000FFE 00                 
  2705                                  sys_gmsg_1:
  2706 00000FFF 45                      	inc	ebp
  2707 00001000 EBE5                    	jmp	short sys_gmsg
  2708                                  sys_gmsg_2:
  2709 00001002 3C0A                    	cmp	al, LF ; 10
  2710 00001004 7540                    	jne	short sys_gmsg_ok ; 22/12/2024
  2711                                  	; line feed, move cursor to next row
  2712                                  	;add	word [screenpos+2], 16
  2713                                  	; 30/12/2024
  2714 00001006 668305[EE320000]08      	add	word [screenpos+2], 8
  2715 0000100E EBEF                    	jmp	short sys_gmsg_1
  2716                                  sys_gmsg_3:
  2717 00001010 8B35[EC320000]          	mov	esi, [screenpos]
  2718                                  		; hw = (cursor) row
  2719                                  		; si = (cursor) column
  2720 00001016 B907000000              	mov	ecx, 07h ; gray (light)
  2721 0000101B E8011B0000              	call	write_character
  2722 00001020 83C608                  	add	esi, 8
  2723                                  	;;;
  2724                                  	;cmp	si, 640
  2725                                  	; 30/12/2024 (cgaplay.s)
  2726 00001023 6681FE4001              	cmp	si, 320
  2727 00001028 7213                    	jb	short sys_gmsg_5
  2728 0000102A C1EE10                  	shr	esi, 16
  2729                                  	;add	si, 16
  2730                                  	;cmp	si, 480
  2731                                  	; 30/12/2024
  2732 0000102D 6683C608                	add	si, 8
  2733 00001031 6681FEC800              	cmp	si, 200
  2734 00001036 7202                    	jb	short sys_gmsg_4
  2735 00001038 31F6                    	xor	esi, esi
  2736                                  sys_gmsg_4:
  2737 0000103A C1E610                  	shl	esi, 16
  2738                                  	;;;
  2739                                  sys_gmsg_5:
  2740 0000103D 8935[EC320000]          	mov	[screenpos], esi
  2741 00001043 45                      	inc	ebp
  2742 00001044 EBA1                    	jmp	short sys_gmsg
  2743                                  sys_gmsg_ok:
  2744 00001046 C3                      	retn
  2745                                  	;;;
  2746                                  
  2747                                  ; --------------------------------------------------------
  2748                                  
  2749                                  ; 29/12/2024 - vgaplay3.s
  2750                                  ; 18/12/2024
  2751                                  ; 01/12/2024 - ac97play.s
  2752                                  ; 29/05/2024
  2753                                  ; 26/11/2023
  2754                                  ; 25/11/2023 - playwav6.s (32 bit registers, TRDOS 386 adaption)
  2755                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  2756                                  ; 14/11/2023
  2757                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  2758                                  ; --------------------------------------------------------
  2759                                  
  2760                                  ;;Note:	At the end of every buffer load,
  2761                                  ;;	during buffer switch/swap, there will be discontinuity
  2762                                  ;;	between the last converted sample and the 1st sample
  2763                                  ;;	of the next buffer.
  2764                                  ;;	(like as a dot noises vaguely between normal sound samples)
  2765                                  ;;	-To avoid this defect, the 1st sample of
  2766                                  ;;	the next buffer may be read from the wav file but
  2767                                  ;;	the file pointer would need to be set to 1 sample back
  2768                                  ;;	again via seek system call. Time comsumption problem! -
  2769                                  ;;
  2770                                  ;;	Erdogan Tan - 15/11/2023
  2771                                  ;;
  2772                                  ;;	((If entire wav data would be loaded at once.. conversion
  2773                                  ;;	defect/noise would disappear.. but for DOS, to keep
  2774                                  ;;	64KB buffer limit is important also it is important
  2775                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  2776                                  ;;	I have tested this program by using 2-30MB wav files.))
  2777                                  ;;
  2778                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  2779                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  2780                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  2781                                  ;;			Realtek ALC850 codec.
  2782                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  2783                                  
  2784                                  load_8khz_mono_8_bit:
  2785                                  	; 15/11/2023
  2786                                  	; 14/11/2023
  2787                                  	; 13/11/2023
  2788 00001047 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2789                                  					; last of the file?
  2790 0000104E 7402                    	jz	short lff8m_0		; no
  2791 00001050 F9                      	stc
  2792 00001051 C3                      	retn
  2793                                  
  2794                                  lff8m_0:
  2795                                  	; 01/12/2024
  2796                                  	; edi = audio buffer address
  2797                                  	; 13/12/2024
  2798 00001052 893D[F8320000]          	mov	[audio_buffer], edi
  2799 00001058 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2800                                          ;mov	edx, [loadsize]
  2801                                  
  2802                                  	; esi = buffer address
  2803                                  	;; edx = buffer size
  2804                                  
  2805                                  	; load file into memory
  2806                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000105D 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001063 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001065 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000106B B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001070 CD40                <1>  int 40h
  2807 00001072 7305                    	jnc	short lff8m_6
  2808 00001074 E9B3000000              	jmp	lff8m_5  ; error !
  2809                                  
  2810                                  lff8m_6:
  2811                                  	; 01/12/2024
  2812 00001079 A3[C0380000]            	mov	[count], eax
  2813                                  	;mov	edi, audio_buffer
  2814                                  	; 29/05/2024
  2815 0000107E 8B3D[F8320000]          	mov	edi, [audio_buffer]
  2816                                  	;and	eax, eax
  2817 00001084 0F8499000000            	jz	lff8_eof
  2818                                  
  2819 0000108A 89C1                    	mov	ecx, eax		; byte count
  2820                                  lff8m_1:
  2821 0000108C AC                      	lodsb
  2822 0000108D A2[3C270000]            	mov	[previous_val], al
  2823 00001092 2C80                    	sub	al, 80h
  2824 00001094 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2825 00001098 66AB                    	stosw		; original sample (left channel)
  2826 0000109A 66AB                    	stosw		; original sample (right channel)
  2827                                  	;xor	eax, eax
  2828 0000109C B080                    	mov	al, 80h
  2829 0000109E 49                      	dec	ecx
  2830 0000109F 7402                    	jz	short lff8m_2
  2831 000010A1 8A06                    	mov	al, [esi]
  2832                                  lff8m_2:
  2833                                  	;mov	[next_val], ax
  2834 000010A3 88C7                    	mov	bh, al	; [next_val]
  2835 000010A5 8A25[3C270000]          	mov	ah, [previous_val]
  2836 000010AB 00E0                    	add	al, ah	; [previous_val]
  2837 000010AD D0D8                    	rcr	al, 1
  2838 000010AF 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  2839 000010B1 00E0                    	add	al, ah	; [previous_val]
  2840 000010B3 D0D8                    	rcr	al, 1	
  2841 000010B5 88C3                    	mov	bl, al 	; this is temporary interpolation value
  2842 000010B7 00E0                    	add	al, ah	; [previous_val]
  2843 000010B9 D0D8                    	rcr	al, 1
  2844 000010BB 2C80                    	sub	al, 80h
  2845 000010BD 66C1E008                	shl	ax, 8	
  2846 000010C1 66AB                    	stosw		; this is 1st interpolated sample (L)
  2847 000010C3 66AB                    	stosw		; this is 1st interpolated sample (R)
  2848 000010C5 88D8                    	mov	al, bl
  2849 000010C7 00D0                    	add	al, dl
  2850 000010C9 D0D8                    	rcr	al, 1
  2851 000010CB 2C80                    	sub	al, 80h
  2852 000010CD 66C1E008                	shl	ax, 8
  2853 000010D1 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2854 000010D3 66AB                    	stosw		; this is 2nd interpolated sample (R)
  2855 000010D5 88D0                    	mov	al, dl
  2856 000010D7 2C80                    	sub	al, 80h
  2857 000010D9 66C1E008                	shl	ax, 8
  2858 000010DD 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  2859 000010DF 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  2860                                  	;mov	al, [next_val]
  2861 000010E1 88F8                    	mov	al, bh
  2862 000010E3 00D0                    	add	al, dl
  2863 000010E5 D0D8                    	rcr	al, 1
  2864 000010E7 88C3                    	mov	bl, al	; this is temporary interpolation value
  2865 000010E9 00D0                    	add	al, dl
  2866 000010EB D0D8                    	rcr	al, 1
  2867 000010ED 2C80                    	sub	al, 80h
  2868 000010EF 66C1E008                	shl	ax, 8
  2869 000010F3 66AB                    	stosw		; this is 4th interpolated sample (L)
  2870 000010F5 66AB                    	stosw		; this is 4th interpolated sample (R)
  2871                                  	;mov	al, [next_val]
  2872 000010F7 88F8                    	mov	al, bh
  2873 000010F9 00D8                    	add	al, bl
  2874 000010FB D0D8                    	rcr	al, 1
  2875 000010FD 2C80                    	sub	al, 80h
  2876 000010FF 66C1E008                	shl	ax, 8
  2877 00001103 66AB                    	stosw		; this is 5th interpolated sample (L)
  2878 00001105 66AB                    	stosw		; this is 5th interpolated sample (R)
  2879                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2880 00001107 09C9                    	or	ecx, ecx
  2881 00001109 7581                    	jnz	short lff8m_1
  2882                                  
  2883                                  	; --------------
  2884                                  
  2885                                  lff8s_3:
  2886                                  lff8m_3:
  2887                                  lff8s2_3:
  2888                                  lff8m2_3:
  2889                                  lff16s_3:
  2890                                  lff16m_3:
  2891                                  lff16s2_3:
  2892                                  lff16m2_3:
  2893                                  lff24_3:
  2894                                  lff32_3:
  2895                                  lff44_3:
  2896                                  lff22_3:
  2897                                  lff11_3:
  2898                                  	; 08/12/2024 (BugFix)
  2899                                  	; 31/05/2024
  2900 0000110B 8B0D[B4380000]          	mov	ecx, [buffersize] ; buffer size in words
  2901                                  	; 29/12/2024
  2902                                  	; 08/12/2024
  2903                                  	;shl	ecx, 1 ; buffer size in bytes
  2904                                  	; 13/12/2024
  2905 00001111 030D[F8320000]          	add	ecx, [audio_buffer] ; + start address of the buffer
  2906 00001117 29F9                    	sub	ecx, edi
  2907 00001119 7607                    	jna	short lff8m_4
  2908                                  	;inc	ecx
  2909 0000111B C1E902                  	shr	ecx, 2
  2910 0000111E 31C0                    	xor	eax, eax ; fill (remain part of) buffer with zeros
  2911 00001120 F3AB                    	rep	stosd
  2912                                  lff8m_4:
  2913                                  	; 31/05/2024
  2914                                  	; cf=1
  2915                                  	; 08/12/2024
  2916                                  	;clc
  2917 00001122 C3                      	retn
  2918                                  
  2919                                  lff8_eof:
  2920                                  lff16_eof:
  2921                                  lff24_eof:
  2922                                  lff32_eof:
  2923                                  lff44_eof:
  2924                                  lff22_eof:
  2925                                  lff11_eof:
  2926                                  	; 15/11/2023
  2927 00001123 C605[3A380000]01        	mov	byte [flags], ENDOFFILE
  2928 0000112A EBDF                    	jmp	short lff8m_3
  2929                                  
  2930                                  lff8s_5:
  2931                                  lff8m_5:
  2932                                  lff8s2_5:
  2933                                  lff8m2_5:
  2934                                  lff16s_5:
  2935                                  lff16m_5:
  2936                                  lff16s2_5:
  2937                                  lff16m2_5:
  2938                                  lff24_5:
  2939                                  lff32_5:
  2940                                  lff44_5:
  2941                                  lff22_5:
  2942                                  lff11_5:
  2943 0000112C B021                    	mov	al, '!'  ; error
  2944 0000112E E831F6FFFF              	call	tL0
  2945                                  	
  2946                                  	;jmp	short lff8m_3
  2947                                  	; 15/11/2023
  2948 00001133 EBEE                    	jmp	lff8_eof
  2949                                  
  2950                                  	; --------------
  2951                                  
  2952                                  load_8khz_stereo_8_bit:
  2953                                  	; 15/11/2023
  2954                                  	; 14/11/2023
  2955                                  	; 13/11/2023
  2956 00001135 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2957                                  					; last of the file?
  2958 0000113C 7402                    	jz	short lff8s_0		; no
  2959 0000113E F9                      	stc
  2960 0000113F C3                      	retn
  2961                                  
  2962                                  lff8s_0:
  2963                                  	; 01/12/2024
  2964                                  	; edi = audio buffer address
  2965                                  	; 13/12/2024
  2966 00001140 893D[F8320000]          	mov	[audio_buffer], edi
  2967 00001146 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2968                                          ;mov	edx, [loadsize]
  2969                                  
  2970                                  	; esi = buffer address
  2971                                  	;; edx = buffer size
  2972                                  
  2973                                  	; load file into memory
  2974                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000114B 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001151 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001153 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001159 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 0000115E CD40                <1>  int 40h
  2975 00001160 72CA                    	jc	short lff8s_5 ; error !
  2976                                  
  2977                                  	; 01/12/2024
  2978 00001162 A3[C0380000]            	mov	[count], eax
  2979                                  
  2980                                  	;mov	edi, audio_buffer
  2981                                  	; 29/05/2024
  2982                                  	;mov	edi, [audio_buffer]
  2983                                  	
  2984 00001167 D1E8                    	shr	eax, 1
  2985 00001169 74B8                    	jz	short lff8_eof
  2986                                  
  2987 0000116B 89C1                    	mov	ecx, eax	; word count
  2988                                  lff8s_1:
  2989 0000116D AC                      	lodsb
  2990 0000116E A2[3C270000]            	mov	[previous_val_l], al
  2991 00001173 2C80                    	sub	al, 80h
  2992 00001175 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2993 00001179 66AB                    	stosw		; original sample (L)
  2994 0000117B AC                      	lodsb
  2995 0000117C A2[3E270000]            	mov	[previous_val_r], al
  2996 00001181 2C80                    	sub	al, 80h
  2997 00001183 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2998 00001187 66AB                    	stosw		; original sample (R)
  2999                                  
  3000                                  	;xor	eax, eax
  3001 00001189 66B88080                	mov	ax, 8080h
  3002 0000118D 49                      	dec	ecx
  3003 0000118E 7403                    	jz	short lff8s_2
  3004                                  		; convert 8 bit sample to 16 bit sample
  3005 00001190 668B06                  	mov	ax, [esi]
  3006                                  lff8s_2:
  3007 00001193 A2[40270000]            	mov	[next_val_l], al
  3008 00001198 8825[42270000]          	mov	[next_val_r], ah
  3009 0000119E 8A25[3C270000]          	mov	ah, [previous_val_l]
  3010 000011A4 00E0                    	add	al, ah
  3011 000011A6 D0D8                    	rcr	al, 1
  3012 000011A8 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  3013 000011AA 00E0                    	add	al, ah
  3014 000011AC D0D8                    	rcr	al, 1
  3015 000011AE 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  3016 000011B0 00E0                    	add	al, ah
  3017 000011B2 D0D8                    	rcr	al, 1
  3018 000011B4 2C80                    	sub	al, 80h
  3019 000011B6 66C1E008                	shl	ax, 8
  3020 000011BA 66AB                    	stosw		; this is 1st interpolated sample (L)
  3021 000011BC A0[42270000]            	mov	al, [next_val_r]
  3022 000011C1 8A25[3E270000]          	mov	ah, [previous_val_r]
  3023 000011C7 00E0                    	add	al, ah
  3024 000011C9 D0D8                    	rcr	al, 1
  3025 000011CB 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  3026 000011CD 00E0                    	add	al, ah
  3027 000011CF D0D8                    	rcr	al, 1
  3028 000011D1 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  3029 000011D3 00E0                    	add	al, ah
  3030 000011D5 D0D8                    	rcr	al, 1
  3031 000011D7 2C80                    	sub	al, 80h
  3032 000011D9 66C1E008                	shl	ax, 8
  3033 000011DD 66AB                    	stosw		; this is 1st interpolated sample (R)
  3034 000011DF 88D8                    	mov	al, bl
  3035 000011E1 00D0                    	add	al, dl
  3036 000011E3 D0D8                    	rcr	al, 1
  3037 000011E5 2C80                    	sub	al, 80h
  3038 000011E7 66C1E008                	shl	ax, 8
  3039 000011EB 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3040 000011ED 88F8                    	mov	al, bh
  3041 000011EF 00F0                    	add	al, dh
  3042 000011F1 D0D8                    	rcr	al, 1
  3043 000011F3 2C80                    	sub	al, 80h
  3044 000011F5 66C1E008                	shl	ax, 8
  3045 000011F9 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3046 000011FB 88D0                    	mov	al, dl
  3047 000011FD 2C80                    	sub	al, 80h
  3048 000011FF 66C1E008                	shl	ax, 8
  3049 00001203 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  3050 00001205 88F0                    	mov	al, dh
  3051 00001207 2C80                    	sub	al, 80h
  3052 00001209 66C1E008                	shl	ax, 8
  3053 0000120D 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  3054 0000120F A0[40270000]            	mov	al, [next_val_l]
  3055 00001214 00D0                    	add	al, dl
  3056 00001216 D0D8                    	rcr	al, 1
  3057 00001218 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  3058 0000121A 00D0                    	add	al, dl
  3059 0000121C D0D8                    	rcr	al, 1
  3060 0000121E 2C80                    	sub	al, 80h
  3061 00001220 66C1E008                	shl	ax, 8
  3062 00001224 66AB                    	stosw		; this is 4th interpolated sample (L)
  3063 00001226 A0[42270000]            	mov	al, [next_val_r]
  3064 0000122B 00F0                    	add	al, dh
  3065 0000122D D0D8                    	rcr	al, 1
  3066 0000122F 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  3067 00001231 00F0                    	add	al, dh
  3068 00001233 D0D8                    	rcr	al, 1
  3069 00001235 2C80                    	sub	al, 80h
  3070 00001237 66C1E008                	shl	ax, 8
  3071 0000123B 66AB                    	stosw		; this is 4th interpolated sample (R)
  3072 0000123D A0[40270000]            	mov	al, [next_val_l]
  3073 00001242 00D8                    	add	al, bl
  3074 00001244 D0D8                    	rcr	al, 1
  3075 00001246 2C80                    	sub	al, 80h
  3076 00001248 66C1E008                	shl	ax, 8
  3077 0000124C 66AB                    	stosw		; this is 5th interpolated sample (L)
  3078 0000124E A0[42270000]            	mov	al, [next_val_r]
  3079 00001253 00F8                    	add	al, bh
  3080 00001255 D0D8                    	rcr	al, 1
  3081 00001257 2C80                    	sub	al, 80h
  3082 00001259 66C1E008                	shl	ax, 8
  3083 0000125D 66AB                    	stosw		; this is 5th interpolated sample (R)
  3084                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3085 0000125F E305                    	jecxz	lff8s_6
  3086 00001261 E907FFFFFF              	jmp	lff8s_1
  3087                                  lff8s_6:
  3088 00001266 E9A0FEFFFF              	jmp	lff8s_3
  3089                                  
  3090                                  load_8khz_mono_16_bit:
  3091                                  	; 13/11/2023
  3092 0000126B F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3093                                  					; last of the file?
  3094 00001272 7402                    	jz	short lff8m2_0		; no
  3095 00001274 F9                      	stc
  3096 00001275 C3                      	retn
  3097                                  
  3098                                  lff8m2_0:
  3099                                  	; 01/12/2024
  3100                                  	; edi = audio buffer address
  3101                                  	; 13/12/2024
  3102 00001276 893D[F8320000]          	mov	[audio_buffer], edi
  3103 0000127C BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3104                                          ;mov	edx, [loadsize]
  3105                                  
  3106                                  	; esi = buffer address
  3107                                  	;; edx = buffer size
  3108                                  
  3109                                  	; load file into memory
  3110                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001281 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001287 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001289 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000128F B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001294 CD40                <1>  int 40h
  3111 00001296 0F82A0000000            	jc	lff8m2_7 ; error !
  3112                                  
  3113                                  	; 01/12/2024
  3114 0000129C A3[C0380000]            	mov	[count], eax
  3115                                  
  3116                                  	;mov	edi, audio_buffer
  3117                                  	; 29/05/2024
  3118                                  	;mov	edi, [audio_buffer]
  3119                                  	
  3120 000012A1 D1E8                    	shr	eax, 1
  3121 000012A3 7505                    	jnz	short lff8m2_8
  3122 000012A5 E979FEFFFF              	jmp	lff8_eof
  3123                                  
  3124                                  lff8m2_8:
  3125 000012AA 89C1                    	mov	ecx, eax	; word count
  3126                                  lff8m2_1:
  3127 000012AC 66AD                    	lodsw
  3128 000012AE 66AB                    	stosw		; original sample (left channel)
  3129 000012B0 66AB                    	stosw		; original sample (right channel)
  3130 000012B2 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3131 000012B5 66A3[3C270000]          	mov	[previous_val], ax
  3132 000012BB 31C0                    	xor	eax, eax
  3133 000012BD 49                      	dec	ecx
  3134 000012BE 7403                    	jz	short lff8m2_2
  3135 000012C0 668B06                  	mov	ax, [esi]
  3136                                  lff8m2_2:
  3137 000012C3 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  3138 000012C6 89C5                    	mov	ebp, eax	; [next_val]
  3139 000012C8 660305[3C270000]        	add	ax, [previous_val]
  3140 000012CF 66D1D8                  	rcr	ax, 1
  3141 000012D2 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample
  3142 000012D4 660305[3C270000]        	add	ax, [previous_val]
  3143 000012DB 66D1D8                  	rcr	ax, 1	; this is temporary interpolation value
  3144 000012DE 89C3                    	mov	ebx, eax 		
  3145 000012E0 660305[3C270000]        	add	ax, [previous_val]
  3146 000012E7 66D1D8                  	rcr	ax, 1
  3147 000012EA 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3148 000012ED 66AB                    	stosw		; this is 1st interpolated sample (L)
  3149 000012EF 66AB                    	stosw		; this is 1st interpolated sample (R)
  3150 000012F1 89D8                    	mov	eax, ebx
  3151 000012F3 6601D0                  	add	ax, dx
  3152 000012F6 66D1D8                  	rcr	ax, 1
  3153 000012F9 80EC80                  	sub	ah, 80h
  3154 000012FC 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3155 000012FE 66AB                    	stosw		; this is 2nd interpolated sample (R)
  3156 00001300 89D0                    	mov	eax, edx
  3157 00001302 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3158 00001305 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  3159 00001307 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  3160 00001309 89E8                    	mov	eax, ebp
  3161 0000130B 6601D0                  	add	ax, dx
  3162 0000130E 66D1D8                  	rcr	ax, 1
  3163 00001311 89C3                    	mov	ebx, eax ; this is temporary interpolation value
  3164 00001313 6601D0                  	add	ax, dx
  3165 00001316 66D1D8                  	rcr	ax, 1
  3166 00001319 80EC80                  	sub	ah, 80h
  3167 0000131C 66AB                    	stosw		; this is 4th interpolated sample (L)
  3168 0000131E 66AB                    	stosw		; this is 4th interpolated sample (R)
  3169 00001320 89E8                    	mov	eax, ebp
  3170 00001322 6601D8                  	add	ax, bx
  3171 00001325 66D1D8                  	rcr	ax, 1
  3172 00001328 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3173 0000132B 66AB                    	stosw		; this is 5th interpolated sample (L)
  3174 0000132D 66AB                    	stosw		; this is 5th interpolated sample (R)
  3175                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3176 0000132F 09C9                    	or	ecx, ecx
  3177 00001331 0F8575FFFFFF            	jnz	lff8m2_1
  3178 00001337 E9CFFDFFFF              	jmp	lff8m2_3
  3179                                  
  3180                                  lff8m2_7:
  3181                                  lff8s2_7:
  3182 0000133C E9EBFDFFFF              	jmp	lff8m2_5  ; error
  3183                                  
  3184                                  load_8khz_stereo_16_bit:
  3185                                  	; 16/11/2023
  3186                                  	; 15/11/2023
  3187                                  	; 13/11/2023
  3188 00001341 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3189                                  					; last of the file?
  3190 00001348 7402                    	jz	short lff8s2_0		; no
  3191 0000134A F9                      	stc
  3192 0000134B C3                      	retn
  3193                                  
  3194                                  lff8s2_0:
  3195                                  	; 01/12/2024
  3196                                  	; edi = audio buffer address
  3197                                  	; 13/12/2024
  3198 0000134C 893D[F8320000]          	mov	[audio_buffer], edi
  3199 00001352 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3200                                          ;mov	edx, [loadsize]
  3201                                  
  3202                                  	; esi = buffer address
  3203                                  	;; edx = buffer size
  3204                                  
  3205                                  	; load file into memory
  3206                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001357 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000135D 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000135F 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001365 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 0000136A CD40                <1>  int 40h
  3207 0000136C 72CE                    	jc	short lff8s2_7 ; error !
  3208                                  
  3209                                  	; 01/12/2024
  3210 0000136E A3[C0380000]            	mov	[count], eax
  3211                                  
  3212                                  	;mov	edi, audio_buffer
  3213                                  	; 29/05/2024
  3214                                  	;mov	edi, [audio_buffer]
  3215                                  	
  3216 00001373 C1E802                  	shr	eax, 2
  3217 00001376 7505                    	jnz	short lff8s2_8
  3218 00001378 E9A6FDFFFF              	jmp	lff8_eof
  3219                                  
  3220                                  lff8s2_8:
  3221 0000137D 89C1                    	mov	ecx, eax ; dword count
  3222                                  lff8s2_1:
  3223 0000137F 66AD                    	lodsw
  3224 00001381 66AB                    	stosw		; original sample (L)
  3225                                  	; 15/11/2023
  3226 00001383 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3227 00001386 66A3[3C270000]          	mov	[previous_val_l], ax
  3228 0000138C 66AD                    	lodsw
  3229 0000138E 66AB                    	stosw		; original sample (R)
  3230 00001390 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3231 00001393 66A3[3E270000]          	mov	[previous_val_r], ax
  3232 00001399 31D2                    	xor	edx, edx
  3233 0000139B 31C0                    	xor	eax, eax
  3234                                  	; 16/11/2023
  3235 0000139D 49                      	dec	ecx
  3236 0000139E 7407                    	jz	short lff8s2_2
  3237 000013A0 668B06                  	mov	ax, [esi]
  3238 000013A3 668B5602                	mov	dx, [esi+2]
  3239                                  lff8s2_2:
  3240 000013A7 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  3241 000013AA 66A3[40270000]          	mov	[next_val_l], ax
  3242 000013B0 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  3243 000013B3 668915[42270000]        	mov	[next_val_r], dx
  3244 000013BA 660305[3C270000]        	add	ax, [previous_val_l]
  3245 000013C1 66D1D8                  	rcr	ax, 1
  3246 000013C4 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample (L)
  3247 000013C6 660305[3C270000]        	add	ax, [previous_val_l]
  3248 000013CD 66D1D8                  	rcr	ax, 1	
  3249 000013D0 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  3250 000013D2 660305[3C270000]        	add	ax, [previous_val_l]
  3251 000013D9 66D1D8                  	rcr	ax, 1
  3252 000013DC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3253 000013DF 66AB                    	stosw		; this is 1st interpolated sample (L)
  3254 000013E1 66A1[42270000]          	mov	ax, [next_val_r]
  3255 000013E7 660305[3E270000]        	add	ax, [previous_val_r]
  3256 000013EE 66D1D8                  	rcr	ax, 1
  3257 000013F1 89C5                    	mov	ebp, eax ; this is interpolated middle (3th) sample (R)
  3258 000013F3 660305[3E270000]        	add	ax, [previous_val_r]
  3259 000013FA 66D1D8                  	rcr	ax, 1
  3260 000013FD 50                      	push	eax ; *	; this is temporary interpolation value (R)
  3261 000013FE 660305[3E270000]        	add	ax, [previous_val_r]
  3262 00001405 66D1D8                  	rcr	ax, 1
  3263 00001408 80EC80                  	sub	ah, 80h
  3264 0000140B 66AB                    	stosw		; this is 1st interpolated sample (R)
  3265 0000140D 89D8                    	mov	eax, ebx
  3266 0000140F 6601D0                  	add	ax, dx
  3267 00001412 66D1D8                  	rcr	ax, 1
  3268 00001415 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3269 00001418 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3270 0000141A 58                      	pop	eax ; *
  3271 0000141B 6601E8                  	add	ax, bp
  3272 0000141E 66D1D8                  	rcr	ax, 1
  3273 00001421 80EC80                  	sub	ah, 80h
  3274 00001424 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3275 00001426 89D0                    	mov	eax, edx
  3276 00001428 80EC80                  	sub	ah, 80h
  3277 0000142B 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  3278 0000142D 89E8                    	mov	eax, ebp
  3279 0000142F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3280 00001432 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  3281 00001434 66A1[40270000]          	mov	ax, [next_val_l]
  3282 0000143A 6601D0                  	add	ax, dx
  3283 0000143D 66D1D8                  	rcr	ax, 1
  3284 00001440 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  3285 00001442 6601D0                  	add	ax, dx
  3286 00001445 66D1D8                  	rcr	ax, 1
  3287 00001448 80EC80                  	sub	ah, 80h
  3288 0000144B 66AB                    	stosw		; this is 4th interpolated sample (L)
  3289 0000144D 66A1[42270000]          	mov	ax, [next_val_r]
  3290 00001453 6601E8                  	add	ax, bp
  3291 00001456 66D1D8                  	rcr	ax, 1
  3292 00001459 50                      	push	eax ; ** ; this is temporary interpolation value (R)
  3293 0000145A 6601E8                  	add	ax, bp
  3294 0000145D 66D1D8                  	rcr	ax, 1
  3295 00001460 80EC80                  	sub	ah, 80h
  3296 00001463 66AB                    	stosw		; this is 4th interpolated sample (R)
  3297 00001465 66A1[40270000]          	mov	ax, [next_val_l]
  3298 0000146B 6601D8                  	add	ax, bx
  3299 0000146E 66D1D8                  	rcr	ax, 1
  3300 00001471 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3301 00001474 66AB                    	stosw		; this is 5th interpolated sample (L)
  3302 00001476 58                      	pop	eax ; **
  3303 00001477 660305[42270000]        	add	ax, [next_val_r]
  3304 0000147E 66D1D8                  	rcr	ax, 1
  3305 00001481 80EC80                  	sub	ah, 80h
  3306 00001484 66AB                    	stosw		; this is 5th interpolated sample (R)
  3307                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3308 00001486 E305                    	jecxz	lff8_s2_9
  3309 00001488 E9F2FEFFFF              	jmp	lff8s2_1
  3310                                  lff8_s2_9:
  3311 0000148D E979FCFFFF              	jmp	lff8s2_3
  3312                                  
  3313                                  ; .....................
  3314                                  
  3315                                  load_16khz_mono_8_bit:
  3316                                  	; 14/11/2023
  3317                                  	; 13/11/2023
  3318 00001492 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3319                                  					; last of the file?
  3320 00001499 7402                    	jz	short lff16m_0		; no
  3321 0000149B F9                      	stc
  3322 0000149C C3                      	retn
  3323                                  
  3324                                  lff16m_0:
  3325                                  	; 01/12/2024
  3326                                  	; edi = audio buffer address
  3327                                  	; 13/12/2024
  3328 0000149D 893D[F8320000]          	mov	[audio_buffer], edi
  3329 000014A3 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3330                                          ;mov	edx, [loadsize]
  3331                                  
  3332                                  	; esi = buffer address
  3333                                  	;; edx = buffer size
  3334                                  
  3335                                  	; load file into memory
  3336                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000014A8 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000014AE 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000014B0 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000014B6 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 000014BB CD40                <1>  int 40h
  3337 000014BD 7253                    	jc	short lff16m_7 ; error !
  3338                                  
  3339                                  	; 01/12/2024
  3340 000014BF A3[C0380000]            	mov	[count], eax
  3341                                  
  3342                                  	;mov	edi, audio_buffer
  3343                                  	; 29/05/2024
  3344                                  	;mov	edi, [audio_buffer]
  3345                                  	
  3346 000014C4 21C0                    	and	eax, eax
  3347 000014C6 7505                    	jnz	short lff16m_8
  3348 000014C8 E956FCFFFF              	jmp	lff16_eof
  3349                                  
  3350                                  lff16m_8:
  3351 000014CD 89C1                    	mov	ecx, eax		; byte count
  3352                                  lff16m_1:
  3353 000014CF AC                      	lodsb
  3354                                  	;mov	[previous_val], al
  3355 000014D0 88C3                    	mov	bl, al
  3356 000014D2 2C80                    	sub	al, 80h
  3357 000014D4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3358 000014D8 66AB                    	stosw		; original sample (left channel)
  3359 000014DA 66AB                    	stosw		; original sample (right channel)
  3360                                  	;xor	ax, ax
  3361                                  	; 14/11/22023
  3362 000014DC B080                    	mov	al, 80h
  3363 000014DE 49                      	dec	ecx
  3364 000014DF 7402                    	jz	short lff16m_2
  3365 000014E1 8A06                    	mov	al, [esi]
  3366                                  lff16m_2:
  3367                                  	;mov	[next_val], al
  3368 000014E3 88C7                    	mov	bh, al
  3369                                  	;add	al, [previous_val]
  3370 000014E5 00D8                    	add	al, bl
  3371 000014E7 D0D8                    	rcr	al, 1
  3372 000014E9 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  3373                                  	;add	al, [previous_val]
  3374 000014EB 00D8                    	add	al, bl
  3375 000014ED D0D8                    	rcr	al, 1
  3376 000014EF 2C80                    	sub	al, 80h
  3377 000014F1 66C1E008                	shl	ax, 8
  3378 000014F5 66AB                    	stosw		; this is 1st interpolated sample (L)
  3379 000014F7 66AB                    	stosw		; this is 1st interpolated sample (R)
  3380                                  	;mov	al, [next_val]
  3381 000014F9 88F8                    	mov	al, bh
  3382 000014FB 00D0                    	add	al, dl
  3383 000014FD D0D8                    	rcr	al, 1
  3384 000014FF 2C80                    	sub	al, 80h
  3385 00001501 66C1E008                	shl	ax, 8
  3386 00001505 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3387 00001507 66AB                    	stosw		; this is 2nd interpolated sample (R)
  3388                                  	
  3389                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3390 00001509 09C9                    	or	ecx, ecx
  3391 0000150B 75C2                    	jnz	short lff16m_1
  3392 0000150D E9F9FBFFFF              	jmp	lff16m_3
  3393                                  
  3394                                  lff16m_7:
  3395                                  lff16s_7:
  3396 00001512 E915FCFFFF              	jmp	lff16m_5  ; error
  3397                                  
  3398                                  load_16khz_stereo_8_bit:
  3399                                  	; 14/11/2023
  3400                                  	; 13/11/2023
  3401 00001517 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3402                                  					; last of the file?
  3403 0000151E 7402                    	jz	short lff16s_0		; no
  3404 00001520 F9                      	stc
  3405 00001521 C3                      	retn
  3406                                  
  3407                                  lff16s_0:
  3408                                  	; 01/12/2024
  3409                                  	; edi = audio buffer address
  3410                                  	; 13/12/2024
  3411 00001522 893D[F8320000]          	mov	[audio_buffer], edi
  3412 00001528 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3413                                          ;mov	edx, [loadsize]
  3414                                  
  3415                                  	; esi = buffer address
  3416                                  	;; edx = buffer size
  3417                                  
  3418                                  	; load file into memory
  3419                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000152D 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001533 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001535 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000153B B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001540 CD40                <1>  int 40h
  3420 00001542 72CE                    	jc	short lff16s_7 ; error !
  3421                                  
  3422                                  	; 01/12/2024
  3423 00001544 A3[C0380000]            	mov	[count], eax
  3424                                  
  3425                                  	;mov	edi, audio_buffer
  3426                                  	; 29/05/2024
  3427                                  	;mov	edi, [audio_buffer]
  3428                                  	
  3429 00001549 D1E8                    	shr	eax, 1
  3430 0000154B 7505                    	jnz	short lff16s_8
  3431 0000154D E9D1FBFFFF              	jmp	lff16_eof
  3432                                  
  3433                                  lff16s_8:
  3434 00001552 89C1                    	mov	ecx, eax	; word count
  3435                                  lff16s_1:
  3436 00001554 AC                      	lodsb
  3437 00001555 A2[3C270000]            	mov	[previous_val_l], al
  3438 0000155A 2C80                    	sub	al, 80h
  3439 0000155C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3440 00001560 66AB                    	stosw		; original sample (L)
  3441 00001562 AC                      	lodsb
  3442 00001563 A2[3E270000]            	mov	[previous_val_r], al
  3443 00001568 2C80                    	sub	al, 80h
  3444 0000156A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3445 0000156E 66AB                    	stosw		; original sample (R)
  3446                                  
  3447                                  	;xor	eax, eax
  3448 00001570 66B88080                	mov	ax, 8080h
  3449 00001574 49                      	dec	ecx
  3450 00001575 7403                    	jz	short lff16s_2
  3451                                  		; convert 8 bit sample to 16 bit sample
  3452 00001577 668B06                  	mov	ax, [esi]
  3453                                  lff16s_2:
  3454                                  	;mov	[next_val_l], al
  3455                                  	;mov	[next_val_r], ah
  3456 0000157A 89C3                    	mov	ebx, eax
  3457 0000157C 0205[3C270000]          	add	al, [previous_val_l]
  3458 00001582 D0D8                    	rcr	al, 1
  3459 00001584 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  3460 00001586 0205[3C270000]          	add	al, [previous_val_l]
  3461 0000158C D0D8                    	rcr	al, 1
  3462 0000158E 2C80                    	sub	al, 80h
  3463 00001590 66C1E008                	shl	ax, 8
  3464 00001594 66AB                    	stosw		; this is 1st interpolated sample (L)
  3465 00001596 88F8                    	mov	al, bh	; [next_val_r]
  3466 00001598 0205[3E270000]          	add	al, [previous_val_r]
  3467 0000159E D0D8                    	rcr	al, 1
  3468 000015A0 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  3469 000015A2 0205[3E270000]          	add	al, [previous_val_r]
  3470 000015A8 D0D8                    	rcr	al, 1
  3471 000015AA 2C80                    	sub	al, 80h
  3472 000015AC 66C1E008                	shl	ax, 8
  3473 000015B0 66AB                    	stosw		; this is 1st interpolated sample (R)
  3474 000015B2 88D0                    	mov	al, dl
  3475 000015B4 00D8                    	add	al, bl	; [next_val_l]
  3476 000015B6 D0D8                    	rcr	al, 1
  3477 000015B8 2C80                    	sub	al, 80h
  3478 000015BA 66C1E008                	shl	ax, 8
  3479 000015BE 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3480 000015C0 88F0                    	mov	al, dh
  3481 000015C2 00F8                    	add	al, bh	; [next_val_r]
  3482 000015C4 D0D8                    	rcr	al, 1
  3483 000015C6 2C80                    	sub	al, 80h
  3484 000015C8 66C1E008                	shl	ax, 8
  3485 000015CC 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3486                                  	
  3487                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3488 000015CE 09C9                    	or	ecx, ecx
  3489 000015D0 7582                    	jnz	short lff16s_1
  3490 000015D2 E934FBFFFF              	jmp	lff16s_3
  3491                                  
  3492                                  load_16khz_mono_16_bit:
  3493                                  	; 15/11/2023
  3494                                  	; 13/11/2023
  3495 000015D7 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3496                                  					; last of the file?
  3497 000015DE 7402                    	jz	short lff16m2_0		; no
  3498 000015E0 F9                      	stc
  3499 000015E1 C3                      	retn
  3500                                  
  3501                                  lff16m2_0:
  3502                                  	; 01/12/2024
  3503                                  	; edi = audio buffer address
  3504                                  	; 13/12/2024
  3505 000015E2 893D[F8320000]          	mov	[audio_buffer], edi
  3506 000015E8 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3507                                          ;mov	edx, [loadsize]
  3508                                  
  3509                                  	; esi = buffer address
  3510                                  	;; edx = buffer size
  3511                                  
  3512                                  	; load file into memory
  3513                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000015ED 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000015F3 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000015F5 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000015FB B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001600 CD40                <1>  int 40h
  3514 00001602 7255                    	jc	short lff16m2_7 ; error !
  3515                                  
  3516                                  	; 01/12/2024
  3517 00001604 A3[C0380000]            	mov	[count], eax
  3518                                  
  3519                                  	;mov	edi, audio_buffer
  3520                                  	; 29/05/2024
  3521                                  	;mov	edi, [audio_buffer]
  3522                                  	
  3523 00001609 D1E8                    	shr	eax, 1
  3524 0000160B 7505                    	jnz	short lff16m2_8
  3525 0000160D E911FBFFFF              	jmp	lff16_eof
  3526                                  
  3527                                  lff16m2_8:
  3528 00001612 89C1                    	mov	ecx, eax  ; word count
  3529                                  lff16m2_1:
  3530 00001614 66AD                    	lodsw
  3531 00001616 66AB                    	stosw		; original sample (left channel)
  3532 00001618 66AB                    	stosw		; original sample (right channel)
  3533 0000161A 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3534                                  	;mov	[previous_val], ax
  3535 0000161D 89C3                    	mov	ebx, eax
  3536 0000161F 31C0                    	xor	eax, eax
  3537 00001621 49                      	dec	ecx
  3538 00001622 7403                    	jz	short lff16m2_2
  3539 00001624 668B06                  	mov	ax, [esi]
  3540                                  lff16m2_2:
  3541 00001627 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3542 0000162A 89C5                    	mov	ebp, eax	; [next_val]
  3543                                  	;add	ax, [previous_val]
  3544 0000162C 6601D8                  	add	ax, bx
  3545 0000162F 66D1D8                  	rcr	ax, 1
  3546 00001632 89C2                    	mov	edx, eax ; this is temporary interpolation value
  3547                                  	;add	ax, [previous_val]
  3548 00001634 6601D8                  	add	ax, bx
  3549 00001637 66D1D8                  	rcr	ax, 1
  3550 0000163A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3551 0000163D 66AB                    	stosw		; this is 1st interpolated sample (L)
  3552 0000163F 66AB                    	stosw		; this is 1st interpolated sample (R)
  3553 00001641 89E8                    	mov	eax, ebp
  3554 00001643 6601D0                  	add	ax, dx
  3555 00001646 66D1D8                  	rcr	ax, 1
  3556 00001649 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3557 0000164C 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3558 0000164E 66AB                    	stosw		; this is 2nd interpolated sample (R)
  3559                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3560 00001650 09C9                    	or	ecx, ecx
  3561 00001652 75C0                    	jnz	short lff16m2_1
  3562 00001654 E9B2FAFFFF              	jmp	lff16m2_3
  3563                                  
  3564                                  lff16m2_7:
  3565                                  lff16s2_7:
  3566 00001659 E9CEFAFFFF              	jmp	lff16m2_5  ; error
  3567                                  
  3568                                  load_16khz_stereo_16_bit:
  3569                                  	; 16/11/2023
  3570                                  	; 15/11/2023
  3571                                  	; 13/11/2023
  3572 0000165E F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3573                                  					; last of the file?
  3574 00001665 7402                    	jz	short lff16s2_0		; no
  3575 00001667 F9                      	stc
  3576 00001668 C3                      	retn
  3577                                  
  3578                                  lff16s2_0:
  3579                                  	; 01/12/2024
  3580                                  	; edi = audio buffer address
  3581                                  	; 13/12/2024
  3582 00001669 893D[F8320000]          	mov	[audio_buffer], edi
  3583 0000166F BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3584                                          ;mov	edx, [loadsize]
  3585                                  
  3586                                  	; esi = buffer address
  3587                                  	;; edx = buffer size
  3588                                  
  3589                                  	; load file into memory
  3590                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001674 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000167A 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000167C 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001682 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001687 CD40                <1>  int 40h
  3591 00001689 72CE                    	jc	short lff16s2_7 ; error !
  3592                                  
  3593                                  	; 01/12/2024
  3594 0000168B A3[C0380000]            	mov	[count], eax
  3595                                  
  3596                                  	;mov	edi, audio_buffer
  3597                                  	; 29/05/2024
  3598                                  	;mov	edi, [audio_buffer]
  3599                                  	
  3600 00001690 C1E802                  	shr	eax, 2
  3601 00001693 7505                    	jnz	short lff16s2_8
  3602 00001695 E989FAFFFF              	jmp	lff16_eof
  3603                                  
  3604                                  lff16s2_8:
  3605 0000169A 89C1                    	mov	ecx, eax  ; dword count
  3606                                  lff16s2_1:
  3607 0000169C 66AD                    	lodsw
  3608 0000169E 66AB                    	stosw		; original sample (L)
  3609 000016A0 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3610 000016A3 66A3[3C270000]          	mov	[previous_val_l], ax
  3611 000016A9 66AD                    	lodsw
  3612 000016AB 66AB                    	stosw		; original sample (R)
  3613 000016AD 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3614 000016B0 66A3[3E270000]          	mov	[previous_val_r], ax
  3615 000016B6 31D2                    	xor	edx, edx
  3616 000016B8 31C0                    	xor	eax, eax
  3617                                  	; 16/11/2023
  3618 000016BA 49                      	dec	ecx
  3619 000016BB 7407                    	jz	short lff16s2_2
  3620 000016BD 668B06                  	mov	ax, [esi]
  3621 000016C0 668B5602                	mov	dx, [esi+2]
  3622                                  lff16s2_2:
  3623 000016C4 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3624                                  	;mov	[next_val_l], ax
  3625 000016C7 89C5                    	mov	ebp, eax
  3626 000016C9 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  3627 000016CC 668915[42270000]        	mov	[next_val_r], dx
  3628 000016D3 660305[3C270000]        	add	ax, [previous_val_l]
  3629 000016DA 66D1D8                  	rcr	ax, 1
  3630 000016DD 89C2                    	mov	edx, eax ; this is temporary interpolation value (L)
  3631 000016DF 660305[3C270000]        	add	ax, [previous_val_l]
  3632 000016E6 66D1D8                  	rcr	ax, 1
  3633 000016E9 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  3634 000016EC 66AB                    	stosw		; this is 1st interpolated sample (L)
  3635 000016EE 66A1[42270000]          	mov	ax, [next_val_r]
  3636 000016F4 660305[3E270000]        	add	ax, [previous_val_r]
  3637 000016FB 66D1D8                  	rcr	ax, 1
  3638 000016FE 89C3                    	mov	ebx, eax ; this is temporary interpolation value (R)
  3639 00001700 660305[3E270000]        	add	ax, [previous_val_r]
  3640 00001707 66D1D8                  	rcr	ax, 1
  3641 0000170A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3642 0000170D 66AB                    	stosw		; this is 1st interpolated sample (R)
  3643                                  	;mov	ax, [next_val_l]
  3644 0000170F 89E8                    	mov	eax, ebp
  3645 00001711 6601D0                  	add	ax, dx
  3646 00001714 66D1D8                  	rcr	ax, 1
  3647 00001717 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3648 0000171A 66AB                    	stosw		; this is 2nd interpolated sample (L)
  3649 0000171C 66A1[42270000]          	mov	ax, [next_val_r]
  3650 00001722 6601D8                  	add	ax, bx
  3651 00001725 66D1D8                  	rcr	ax, 1
  3652 00001728 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3653 0000172B 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  3654                                  	
  3655                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3656 0000172D 09C9                    	or	ecx, ecx
  3657 0000172F 0F8567FFFFFF            	jnz	lff16s2_1
  3658 00001735 E9D1F9FFFF              	jmp	lff16s2_3
  3659                                  
  3660                                  ; .....................
  3661                                  
  3662                                  load_24khz_mono_8_bit:
  3663                                  	; 15/11/2023
  3664 0000173A F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3665                                  					; last of the file?
  3666 00001741 7402                    	jz	short lff24m_0		; no
  3667 00001743 F9                      	stc
  3668 00001744 C3                      	retn
  3669                                  
  3670                                  lff24m_0:
  3671                                  	; 01/12/2024
  3672                                  	; edi = audio buffer address
  3673                                  	; 13/12/2024
  3674 00001745 893D[F8320000]          	mov	[audio_buffer], edi
  3675 0000174B BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3676                                          ;mov	edx, [loadsize]
  3677                                  
  3678                                  	; esi = buffer address
  3679                                  	;; edx = buffer size
  3680                                  
  3681                                  	; load file into memory
  3682                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001750 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001756 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001758 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000175E B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001763 CD40                <1>  int 40h
  3683 00001765 723B                    	jc	short lff24m_7 ; error !
  3684                                  
  3685                                  	; 01/12/2024
  3686 00001767 A3[C0380000]            	mov	[count], eax
  3687                                  
  3688                                  	;mov	edi, audio_buffer
  3689                                  	; 29/05/2024
  3690                                  	;mov	edi, [audio_buffer]
  3691                                  	
  3692 0000176C 21C0                    	and	eax, eax
  3693 0000176E 7505                    	jnz	short lff24m_8
  3694 00001770 E9AEF9FFFF              	jmp	lff24_eof
  3695                                  
  3696                                  lff24m_8:
  3697 00001775 89C1                    	mov	ecx, eax	; byte count
  3698                                  lff24m_1:
  3699 00001777 AC                      	lodsb
  3700                                  	;mov	[previous_val], al
  3701 00001778 88C3                    	mov	bl, al
  3702 0000177A 2C80                    	sub	al, 80h
  3703 0000177C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3704 00001780 66AB                    	stosw		; original sample (left channel)
  3705 00001782 66AB                    	stosw		; original sample (right channel)
  3706                                  	;xor	eax, eax
  3707 00001784 B080                    	mov	al, 80h
  3708 00001786 49                      	dec	ecx
  3709 00001787 7402                    	jz	short lff24m_2
  3710 00001789 8A06                    	mov	al, [esi]
  3711                                  lff24m_2:
  3712                                  	;;mov	[next_val], al
  3713                                  	;mov	bh, al
  3714                                  	;add	al, [previous_val]
  3715 0000178B 00D8                    	add	al, bl
  3716 0000178D D0D8                    	rcr	al, 1
  3717 0000178F 2C80                    	sub	al, 80h
  3718 00001791 66C1E008                	shl	ax, 8
  3719 00001795 66AB                    	stosw		; this is interpolated sample (L)
  3720 00001797 66AB                    	stosw		; this is interpolated sample (R)
  3721                                  	
  3722                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3723 00001799 09C9                    	or	ecx, ecx
  3724 0000179B 75DA                    	jnz	short lff24m_1
  3725 0000179D E969F9FFFF              	jmp	lff24_3
  3726                                  
  3727                                  lff24m_7:
  3728                                  lff24s_7:
  3729 000017A2 E985F9FFFF              	jmp	lff24_5  ; error
  3730                                  
  3731                                  load_24khz_stereo_8_bit:
  3732                                  	; 15/11/2023
  3733 000017A7 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3734                                  					; last of the file?
  3735 000017AE 7402                    	jz	short lff24s_0		; no
  3736 000017B0 F9                      	stc
  3737 000017B1 C3                      	retn
  3738                                  
  3739                                  lff24s_0:
  3740                                  	; 01/12/2024
  3741                                  	; edi = audio buffer address
  3742                                  	; 13/12/2024
  3743 000017B2 893D[F8320000]          	mov	[audio_buffer], edi
  3744 000017B8 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3745                                          ;mov	edx, [loadsize]
  3746                                  
  3747                                  	; esi = buffer address
  3748                                  	;; edx = buffer size
  3749                                  
  3750                                  	; load file into memory
  3751                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000017BD 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000017C3 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000017C5 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000017CB B803000000          <1>  mov eax, %1
   104                              <1> 
   105 000017D0 CD40                <1>  int 40h
  3752 000017D2 72CE                    	jc	short lff24s_7 ; error !
  3753                                  
  3754                                  	; 01/12/2024
  3755 000017D4 A3[C0380000]            	mov	[count], eax
  3756                                  
  3757                                  	;mov	edi, audio_buffer
  3758                                  	; 29/05/2024
  3759                                  	;mov	edi, [audio_buffer]
  3760                                  	
  3761 000017D9 D1E8                    	shr	eax, 1
  3762 000017DB 7505                    	jnz	short lff24s_8
  3763 000017DD E941F9FFFF              	jmp	lff24_eof
  3764                                  
  3765                                  lff24s_8:
  3766 000017E2 89C1                    	mov	ecx, eax  ; word count
  3767                                  lff24s_1:
  3768 000017E4 AC                      	lodsb
  3769 000017E5 A2[3C270000]            	mov	[previous_val_l], al
  3770 000017EA 2C80                    	sub	al, 80h
  3771 000017EC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3772 000017F0 66AB                    	stosw		; original sample (L)
  3773 000017F2 AC                      	lodsb
  3774 000017F3 A2[3E270000]            	mov	[previous_val_r], al
  3775 000017F8 2C80                    	sub	al, 80h
  3776 000017FA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3777 000017FE 66AB                    	stosw		; original sample (R)
  3778                                  
  3779                                  	;xor	eax, eax
  3780 00001800 66B88080                	mov	ax, 8080h
  3781 00001804 49                      	dec	ecx
  3782 00001805 7403                    	jz	short lff24s_2
  3783                                  		; convert 8 bit sample to 16 bit sample
  3784 00001807 668B06                  	mov	ax, [esi]
  3785                                  lff24s_2:
  3786                                  	;;mov	[next_val_l], al
  3787                                  	;;mov	[next_val_r], ah
  3788                                  	;mov	bx, ax
  3789 0000180A 88E7                    	mov	bh, ah
  3790 0000180C 0205[3C270000]          	add	al, [previous_val_l]
  3791 00001812 D0D8                    	rcr	al, 1
  3792                                  	;mov	dl, al
  3793 00001814 2C80                    	sub	al, 80h
  3794 00001816 66C1E008                	shl	ax, 8
  3795 0000181A 66AB                    	stosw		; this is interpolated sample (L)
  3796 0000181C 88F8                    	mov	al, bh	; [next_val_r]
  3797 0000181E 0205[3E270000]          	add	al, [previous_val_r]
  3798 00001824 D0D8                    	rcr	al, 1
  3799                                  	;mov	dh, al
  3800 00001826 2C80                    	sub	al, 80h
  3801 00001828 66C1E008                	shl	ax, 8
  3802 0000182C 66AB                    	stosw		; this is interpolated sample (R)
  3803                                  		
  3804                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3805 0000182E 09C9                    	or	ecx, ecx
  3806 00001830 75B2                    	jnz	short lff24s_1
  3807 00001832 E9D4F8FFFF              	jmp	lff24_3
  3808                                  
  3809                                  load_24khz_mono_16_bit:
  3810                                  	; 15/11/2023
  3811 00001837 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3812                                  					; last of the file?
  3813 0000183E 7402                    	jz	short lff24m2_0		; no
  3814 00001840 F9                      	stc
  3815 00001841 C3                      	retn
  3816                                  
  3817                                  lff24m2_0:
  3818                                  	; 01/12/2024
  3819                                  	; edi = audio buffer address
  3820                                  	; 13/12/2024
  3821 00001842 893D[F8320000]          	mov	[audio_buffer], edi
  3822 00001848 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3823                                          ;mov	edx, [loadsize]
  3824                                  
  3825                                  	; esi = buffer address
  3826                                  	;; edx = buffer size
  3827                                  
  3828                                  	; load file into memory
  3829                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 0000184D 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001853 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001855 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000185B B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001860 CD40                <1>  int 40h
  3830 00001862 7237                    	jc	short lff24m2_7 ; error !
  3831                                  
  3832                                  	; 01/12/2024
  3833 00001864 A3[C0380000]            	mov	[count], eax
  3834                                  
  3835                                  	;mov	edi, audio_buffer
  3836                                  	; 29/05/2024
  3837                                  	;mov	edi, [audio_buffer]
  3838                                  	
  3839 00001869 D1E8                    	shr	eax, 1
  3840 0000186B 7505                    	jnz	short lff24m2_8
  3841 0000186D E9B1F8FFFF              	jmp	lff24_eof
  3842                                  
  3843                                  lff24m2_8:
  3844 00001872 89C1                    	mov	ecx, eax  ; word count
  3845                                  lff24m2_1:
  3846 00001874 66AD                    	lodsw
  3847 00001876 66AB                    	stosw		; original sample (left channel)
  3848 00001878 66AB                    	stosw		; original sample (right channel)
  3849 0000187A 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3850                                  	;mov	[previous_val], ax
  3851                                  	;mov	ebx, eax
  3852                                  	;xor	eax, eax
  3853 0000187D 31DB                    	xor	ebx, ebx
  3854 0000187F 49                      	dec	ecx
  3855 00001880 7403                    	jz	short lff24m2_2
  3856                                  	;mov	ax, [esi]
  3857 00001882 668B1E                  	mov	bx, [esi]
  3858                                  lff24m2_2:
  3859                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  3860                                  	;mov	ebp, eax	; [next_val]
  3861                                  	;add	ax, [previous_val]
  3862                                  	; ax = [previous_val]
  3863                                  	; bx = [next_val]
  3864 00001885 6601D8                  	add	ax, bx
  3865 00001888 66D1D8                  	rcr	ax, 1
  3866 0000188B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3867 0000188E 66AB                    	stosw		; this is interpolated sample (L)
  3868 00001890 66AB                    	stosw		; this is interpolated sample (R)
  3869                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  3870 00001892 09C9                    	or	ecx, ecx
  3871 00001894 75DE                    	jnz	short lff24m2_1
  3872 00001896 E970F8FFFF              	jmp	lff24_3
  3873                                  
  3874                                  lff24m2_7:
  3875                                  lff24s2_7:
  3876 0000189B E98CF8FFFF              	jmp	lff24_5  ; error
  3877                                  
  3878                                  load_24khz_stereo_16_bit:
  3879                                  	; 16/11/2023
  3880                                  	; 15/11/2023
  3881 000018A0 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3882                                  					; last of the file?
  3883 000018A7 7402                    	jz	short lff24s2_0		; no
  3884 000018A9 F9                      	stc
  3885 000018AA C3                      	retn
  3886                                  
  3887                                  lff24s2_0:
  3888                                  	; 01/12/2024
  3889                                  	; edi = audio buffer address
  3890                                  	; 13/12/2024
  3891 000018AB 893D[F8320000]          	mov	[audio_buffer], edi
  3892 000018B1 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3893                                          ;mov	edx, [loadsize]
  3894                                  
  3895                                  	; esi = buffer address
  3896                                  	;; edx = buffer size
  3897                                  
  3898                                  	; load file into memory
  3899                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000018B6 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000018BC 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000018BE 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000018C4 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 000018C9 CD40                <1>  int 40h
  3900 000018CB 72CE                    	jc	short lff24s2_7 ; error !
  3901                                  
  3902                                  	; 01/12/2024
  3903 000018CD A3[C0380000]            	mov	[count], eax
  3904                                  
  3905                                  	;mov	edi, audio_buffer
  3906                                  	; 29/05/2024
  3907                                  	;mov	edi, [audio_buffer]
  3908                                  	
  3909 000018D2 C1E802                  	shr	eax, 2
  3910 000018D5 7505                    	jnz	short lff24s2_8
  3911 000018D7 E947F8FFFF              	jmp	lff24_eof
  3912                                  
  3913                                  lff24s2_8:
  3914 000018DC 89C1                    	mov	ecx, eax  ; dword count
  3915                                  lff24s2_1:
  3916 000018DE 66AD                    	lodsw
  3917 000018E0 66AB                    	stosw		; original sample (L)
  3918 000018E2 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3919 000018E5 66A3[3C270000]          	mov	[previous_val_l], ax
  3920 000018EB 66AD                    	lodsw
  3921 000018ED 66AB                    	stosw		; original sample (R)
  3922 000018EF 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3923                                  	;mov	[previous_val_r], ax
  3924 000018F2 89C3                    	mov	ebx, eax
  3925 000018F4 31D2                    	xor	edx, edx
  3926 000018F6 31C0                    	xor	eax, eax
  3927                                  	; 16/11/2023
  3928 000018F8 49                      	dec	ecx
  3929 000018F9 7407                    	jz	short lff24s2_2
  3930 000018FB 668B06                  	mov	ax, [esi]
  3931 000018FE 668B5602                	mov	dx, [esi+2]
  3932                                  lff24s2_2:
  3933 00001902 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  3934                                  	;;mov	[next_val_l], ax
  3935                                  	;mov	ebp, eax
  3936 00001905 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  3937                                  	;mov	[next_val_r], dx
  3938 00001908 660305[3C270000]        	add	ax, [previous_val_l]
  3939 0000190F 66D1D8                  	rcr	ax, 1
  3940 00001912 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  3941 00001915 66AB                    	stosw		; this is interpolated sample (L)
  3942                                  	;mov	ax, [next_val_r]
  3943 00001917 89D0                    	mov	eax, edx
  3944                                  	;add	ax, [previous_val_r]
  3945 00001919 6601D8                  	add	ax, bx
  3946 0000191C 66D1D8                  	rcr	ax, 1
  3947 0000191F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3948 00001922 66AB                    	stosw		; this is interpolated sample (R)
  3949                                  	
  3950                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  3951 00001924 09C9                    	or	ecx, ecx
  3952 00001926 75B6                    	jnz	short lff24s2_1
  3953 00001928 E9DEF7FFFF              	jmp	lff24_3
  3954                                  
  3955                                  ; .....................
  3956                                  
  3957                                  load_32khz_mono_8_bit:
  3958                                  	; 15/11/2023
  3959 0000192D F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3960                                  					; last of the file?
  3961 00001934 7402                    	jz	short lff32m_0		; no
  3962 00001936 F9                      	stc
  3963 00001937 C3                      	retn
  3964                                  
  3965                                  lff32m_0:
  3966                                  	; 01/12/2024
  3967                                  	; edi = audio buffer address
  3968                                  	; 13/12/2024
  3969 00001938 893D[F8320000]          	mov	[audio_buffer], edi
  3970 0000193E BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3971                                          ;mov	edx, [loadsize]
  3972                                  
  3973                                  	; esi = buffer address
  3974                                  	;; edx = buffer size
  3975                                  
  3976                                  	; load file into memory
  3977                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001943 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001949 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000194B 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001951 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001956 CD40                <1>  int 40h
  3978 00001958 7247                    	jc	short lff32m_7 ; error !
  3979                                  
  3980                                  	; 01/12/2024
  3981 0000195A A3[C0380000]            	mov	[count], eax
  3982                                  
  3983                                  	;mov	edi, audio_buffer
  3984                                  	; 29/05/2024
  3985                                  	;mov	edi, [audio_buffer]
  3986                                  	
  3987 0000195F 21C0                    	and	eax, eax
  3988 00001961 7505                    	jnz	short lff32m_8
  3989 00001963 E9BBF7FFFF              	jmp	lff32_eof
  3990                                  
  3991                                  lff32m_8:
  3992 00001968 89C1                    	mov	ecx, eax	; byte count
  3993                                  lff32m_1:
  3994 0000196A AC                      	lodsb
  3995                                  	;mov	[previous_val], al
  3996 0000196B 88C3                    	mov	bl, al
  3997 0000196D 2C80                    	sub	al, 80h
  3998 0000196F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3999 00001973 66AB                    	stosw		; original sample (left channel)
  4000 00001975 66AB                    	stosw		; original sample (right channel)
  4001                                  	;xor	eax, eax
  4002 00001977 B080                    	mov	al, 80h
  4003 00001979 49                      	dec	ecx
  4004 0000197A 7402                    	jz	short lff32m_2
  4005 0000197C 8A06                    	mov	al, [esi]
  4006                                  lff32m_2:
  4007                                  	;;mov	[next_val], al
  4008                                  	;mov	bh, al
  4009                                  	;add	al, [previous_val]
  4010 0000197E 00D8                    	add	al, bl
  4011 00001980 D0D8                    	rcr	al, 1
  4012 00001982 2C80                    	sub	al, 80h
  4013 00001984 66C1E008                	shl	ax, 8
  4014 00001988 66AB                    	stosw		; this is interpolated sample (L)
  4015 0000198A 66AB                    	stosw		; this is interpolated sample (R)
  4016                                  	
  4017                                  	; different than 8-16-24 kHZ !
  4018                                  	; 'original-interpolated-original' trio samples
  4019 0000198C E30E                    	jecxz	lff32m_3
  4020                                  
  4021 0000198E AC                      	lodsb
  4022 0000198F 2C80                    	sub	al, 80h
  4023 00001991 66C1E008                	shl	ax, 8
  4024 00001995 66AB                    	stosw		; original sample (left channel)
  4025 00001997 66AB                    	stosw		; original sample (right channel)
  4026                                  
  4027                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  4028 00001999 49                      	dec	ecx
  4029 0000199A 75CE                    	jnz	short lff32m_1
  4030                                  lff32m_3:
  4031 0000199C E96AF7FFFF              	jmp	lff32_3
  4032                                  
  4033                                  lff32m_7:
  4034                                  lff32s_7:
  4035 000019A1 E986F7FFFF              	jmp	lff32_5  ; error
  4036                                  
  4037                                  load_32khz_stereo_8_bit:
  4038                                  	; 15/11/2023
  4039 000019A6 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4040                                  					; last of the file?
  4041 000019AD 7402                    	jz	short lff32s_0		; no
  4042 000019AF F9                      	stc
  4043 000019B0 C3                      	retn
  4044                                  
  4045                                  lff32s_0:
  4046                                  	; 01/12/2024
  4047                                  	; edi = audio buffer address
  4048                                  	; 13/12/2024
  4049 000019B1 893D[F8320000]          	mov	[audio_buffer], edi
  4050 000019B7 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4051                                          ;mov	edx, [loadsize]
  4052                                  
  4053                                  	; esi = buffer address
  4054                                  	;; edx = buffer size
  4055                                  
  4056                                  	; load file into memory
  4057                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 000019BC 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 000019C2 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 000019C4 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 000019CA B803000000          <1>  mov eax, %1
   104                              <1> 
   105 000019CF CD40                <1>  int 40h
  4058 000019D1 72CE                    	jc	short lff32s_7 ; error !
  4059                                  
  4060                                  	; 01/12/2024
  4061 000019D3 A3[C0380000]            	mov	[count], eax
  4062                                  
  4063                                  	;mov	edi, audio_buffer
  4064                                  	; 29/05/2024
  4065                                  	;mov	edi, [audio_buffer]
  4066                                  	
  4067 000019D8 D1E8                    	shr	eax, 1
  4068 000019DA 7505                    	jnz	short lff32s_8
  4069 000019DC E942F7FFFF              	jmp	lff32_eof
  4070                                  
  4071                                  lff32s_8:
  4072 000019E1 89C1                    	mov	ecx, eax  ; word count
  4073                                  lff32s_1:
  4074 000019E3 AC                      	lodsb
  4075 000019E4 A2[3C270000]            	mov	[previous_val_l], al
  4076 000019E9 2C80                    	sub	al, 80h
  4077 000019EB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4078 000019EF 66AB                    	stosw		; original sample (L)
  4079 000019F1 AC                      	lodsb
  4080 000019F2 A2[3E270000]            	mov	[previous_val_r], al
  4081 000019F7 2C80                    	sub	al, 80h
  4082 000019F9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4083 000019FD 66AB                    	stosw		; original sample (R)
  4084                                  
  4085                                  	;xor	eax, eax
  4086 000019FF 66B88080                	mov	ax, 8080h
  4087 00001A03 49                      	dec	ecx
  4088 00001A04 7403                    	jz	short lff32s_2
  4089                                  		; convert 8 bit sample to 16 bit sample
  4090 00001A06 668B06                  	mov	ax, [esi]
  4091                                  lff32s_2:
  4092                                  	;;mov	[next_val_l], al
  4093                                  	;;mov	[next_val_r], ah
  4094                                  	;mov	bx, ax
  4095 00001A09 88E7                    	mov	bh, ah
  4096 00001A0B 0205[3C270000]          	add	al, [previous_val_l]
  4097 00001A11 D0D8                    	rcr	al, 1
  4098                                  	;mov	dl, al
  4099 00001A13 2C80                    	sub	al, 80h
  4100 00001A15 66C1E008                	shl	ax, 8
  4101 00001A19 66AB                    	stosw		; this is interpolated sample (L)
  4102 00001A1B 88F8                    	mov	al, bh	; [next_val_r]
  4103 00001A1D 0205[3E270000]          	add	al, [previous_val_r]
  4104 00001A23 D0D8                    	rcr	al, 1
  4105                                  	;mov	dh, al
  4106 00001A25 2C80                    	sub	al, 80h
  4107 00001A27 66C1E008                	shl	ax, 8
  4108 00001A2B 66AB                    	stosw		; this is interpolated sample (R)
  4109                                  
  4110                                  	; different than 8-16-24 kHZ !
  4111                                  	; 'original-interpolated-original' trio samples
  4112 00001A2D E315                    	jecxz	lff32s_3
  4113                                  
  4114 00001A2F AC                      	lodsb
  4115 00001A30 2C80                    	sub	al, 80h
  4116 00001A32 66C1E008                	shl	ax, 8
  4117 00001A36 66AB                    	stosw		; original sample (left channel)
  4118                                  
  4119 00001A38 AC                      	lodsb
  4120 00001A39 2C80                    	sub	al, 80h
  4121 00001A3B 66C1E008                	shl	ax, 8
  4122 00001A3F 66AB                    	stosw		; original sample (right channel)
  4123                                  		
  4124                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  4125 00001A41 49                      	dec	ecx
  4126 00001A42 759F                    	jnz	short lff32s_1
  4127                                  lff32s_3:
  4128 00001A44 E9C2F6FFFF              	jmp	lff32_3
  4129                                  
  4130                                  load_32khz_mono_16_bit:
  4131                                  	; 15/11/2023
  4132 00001A49 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4133                                  					; last of the file?
  4134 00001A50 7402                    	jz	short lff32m2_0		; no
  4135 00001A52 F9                      	stc
  4136 00001A53 C3                      	retn
  4137                                  
  4138                                  lff32m2_0:
  4139                                  	; 01/12/2024
  4140                                  	; edi = audio buffer address
  4141                                  	; 13/12/2024
  4142 00001A54 893D[F8320000]          	mov	[audio_buffer], edi
  4143 00001A5A BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4144                                          ;mov	edx, [loadsize]
  4145                                  
  4146                                  	; esi = buffer address
  4147                                  	;; edx = buffer size
  4148                                  
  4149                                  	; load file into memory
  4150                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001A5F 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001A65 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001A67 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001A6D B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001A72 CD40                <1>  int 40h
  4151 00001A74 723E                    	jc	short lff32m2_7 ; error !
  4152                                  
  4153                                  	; 01/12/2024
  4154 00001A76 A3[C0380000]            	mov	[count], eax
  4155                                  
  4156                                  	;mov	edi, audio_buffer
  4157                                  	; 29/05/2024
  4158                                  	;mov	edi, [audio_buffer]
  4159                                  	
  4160 00001A7B D1E8                    	shr	eax, 1
  4161 00001A7D 7505                    	jnz	short lff32m2_8
  4162 00001A7F E99FF6FFFF              	jmp	lff32_eof
  4163                                  
  4164                                  lff32m2_8:
  4165 00001A84 89C1                    	mov	ecx, eax  ; word count
  4166                                  lff32m2_1:
  4167 00001A86 66AD                    	lodsw
  4168 00001A88 66AB                    	stosw		; original sample (left channel)
  4169 00001A8A 66AB                    	stosw		; original sample (right channel)
  4170 00001A8C 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4171                                  	;mov	[previous_val], ax
  4172                                  	;mov	ebx, eax
  4173                                  	;xor	eax, eax
  4174 00001A8F 31DB                    	xor	ebx, ebx
  4175 00001A91 49                      	dec	ecx
  4176 00001A92 7403                    	jz	short lff32m2_2
  4177                                  	;mov	ax, [esi]
  4178 00001A94 668B1E                  	mov	bx, [esi]
  4179                                  lff32m2_2:
  4180                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  4181                                  	;mov	ebp, eax	; [next_val]
  4182                                  	;add	ax, [previous_val]
  4183                                  	; ax = [previous_val]
  4184                                  	; bx = [next_val]
  4185 00001A97 6601D8                  	add	ax, bx
  4186 00001A9A 66D1D8                  	rcr	ax, 1
  4187 00001A9D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4188 00001AA0 66AB                    	stosw		; this is interpolated sample (L)
  4189 00001AA2 66AB                    	stosw		; this is interpolated sample (R)
  4190                                  
  4191                                  	; different than 8-16-24 kHZ !
  4192                                  	; 'original-interpolated-original' trio samples 
  4193 00001AA4 E309                    	jecxz	lff32m2_3
  4194                                  
  4195 00001AA6 66AD                    	lodsw
  4196 00001AA8 66AB                    	stosw		; original sample (left channel)
  4197 00001AAA 66AB                    	stosw		; original sample (right channel)
  4198                                  
  4199                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  4200 00001AAC 49                      	dec	ecx
  4201 00001AAD 75D7                    	jnz	short lff32m2_1
  4202                                  lff32m2_3:
  4203 00001AAF E957F6FFFF              	jmp	lff32_3
  4204                                  
  4205                                  lff32m2_7:
  4206                                  lff32s2_7:
  4207 00001AB4 E973F6FFFF              	jmp	lff32_5  ; error
  4208                                  
  4209                                  load_32khz_stereo_16_bit:
  4210                                  	; 16/11/2023
  4211                                  	; 15/11/2023
  4212 00001AB9 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4213                                  					; last of the file?
  4214 00001AC0 7402                    	jz	short lff32s2_0		; no
  4215 00001AC2 F9                      	stc
  4216 00001AC3 C3                      	retn
  4217                                  
  4218                                  lff32s2_0:
  4219                                  	; 01/12/2024
  4220                                  	; edi = audio buffer address
  4221                                  	; 13/12/2024
  4222 00001AC4 893D[F8320000]          	mov	[audio_buffer], edi
  4223 00001ACA BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4224                                          ;mov	edx, [loadsize]
  4225                                  
  4226                                  	; esi = buffer address
  4227                                  	;; edx = buffer size
  4228                                  
  4229                                  	; load file into memory
  4230                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001ACF 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001AD5 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001AD7 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001ADD B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001AE2 CD40                <1>  int 40h
  4231 00001AE4 72CE                    	jc	short lff32s2_7 ; error !
  4232                                  
  4233                                  	; 01/12/2024
  4234 00001AE6 A3[C0380000]            	mov	[count], eax
  4235                                  
  4236                                  	;mov	edi, audio_buffer
  4237                                  	; 29/05/2024
  4238                                  	;mov	edi, [audio_buffer]
  4239                                  	
  4240 00001AEB C1E802                  	shr	eax, 2
  4241 00001AEE 7505                    	jnz	short lff32s2_8
  4242 00001AF0 E92EF6FFFF              	jmp	lff32_eof
  4243                                  
  4244                                  lff32s2_8:
  4245 00001AF5 89C1                    	mov	ecx, eax ; dword count
  4246                                  lff32s2_1:
  4247 00001AF7 66AD                    	lodsw
  4248 00001AF9 66AB                    	stosw		; original sample (L)
  4249 00001AFB 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  4250 00001AFE 66A3[3C270000]          	mov	[previous_val_l], ax
  4251 00001B04 66AD                    	lodsw
  4252 00001B06 66AB                    	stosw		; original sample (R)
  4253 00001B08 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  4254                                  	;mov	[previous_val_r], ax
  4255 00001B0B 89C3                    	mov	ebx, eax
  4256 00001B0D 31D2                    	xor	edx, edx
  4257 00001B0F 31C0                    	xor	eax, eax
  4258                                  	; 16/11/2023
  4259 00001B11 49                      	dec	ecx
  4260 00001B12 7407                    	jz	short lff32s2_2
  4261 00001B14 668B06                  	mov	ax, [esi]
  4262 00001B17 668B5602                	mov	dx, [esi+2]
  4263                                  lff32s2_2:
  4264 00001B1B 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format
  4265                                  	;;mov	[next_val_l], ax
  4266                                  	;mov	ebp, eax
  4267 00001B1E 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format
  4268                                  	;mov	[next_val_r], dx
  4269 00001B21 660305[3C270000]        	add	ax, [previous_val_l]
  4270 00001B28 66D1D8                  	rcr	ax, 1
  4271 00001B2B 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  4272 00001B2E 66AB                    	stosw		; this is interpolated sample (L)
  4273                                  	;mov	ax, [next_val_r]
  4274 00001B30 89D0                    	mov	eax, edx
  4275                                  	;add	ax, [previous_val_r]
  4276 00001B32 6601D8                  	add	ax, bx
  4277 00001B35 66D1D8                  	rcr	ax, 1
  4278 00001B38 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4279 00001B3B 66AB                    	stosw		; this is interpolated sample (R)
  4280                                  
  4281                                  	; different than 8-16-24 kHZ !
  4282                                  	; 'original-interpolated-original' trio samples
  4283 00001B3D E30B                    	jecxz	lff32s2_3
  4284                                  
  4285 00001B3F 66AD                    	lodsw
  4286 00001B41 66AB                    	stosw	; original sample (L)
  4287 00001B43 66AD                    	lodsw
  4288 00001B45 66AB                    	stosw	; original sample (R)
  4289                                  	
  4290                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  4291 00001B47 49                      	dec	ecx
  4292 00001B48 75AD                    	jnz	short lff32s2_1
  4293                                  lff32s2_3:
  4294 00001B4A E9BCF5FFFF              	jmp	lff32_3
  4295                                  
  4296                                  ; .....................
  4297                                  
  4298                                  load_22khz_mono_8_bit:
  4299                                  	; 16/11/2023
  4300 00001B4F F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4301                                  					; last of the file?
  4302 00001B56 7402                    	jz	short lff22m_0		; no
  4303 00001B58 F9                      	stc
  4304 00001B59 C3                      	retn
  4305                                  
  4306                                  lff22m_0:
  4307                                  	; 01/12/2024
  4308                                  	; edi = audio buffer address
  4309                                  	; 13/12/2024
  4310 00001B5A 893D[F8320000]          	mov	[audio_buffer], edi
  4311 00001B60 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4312                                          ;mov	edx, [loadsize]
  4313                                  
  4314                                  	; esi = buffer address
  4315                                  	;; edx = buffer size
  4316                                  
  4317                                  	; load file into memory
  4318                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001B65 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001B6B 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001B6D 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001B73 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001B78 CD40                <1>  int 40h
  4319 00001B7A 725D                    	jc	short lff22m_7 ; error !
  4320                                  
  4321                                  	; 01/12/2024
  4322 00001B7C A3[C0380000]            	mov	[count], eax
  4323                                  
  4324                                  	;mov	edi, audio_buffer
  4325                                  	; 29/05/2024
  4326                                  	;mov	edi, [audio_buffer]
  4327                                  	
  4328 00001B81 21C0                    	and	eax, eax
  4329 00001B83 7505                    	jnz	short lff22m_8
  4330 00001B85 E999F5FFFF              	jmp	lff22_eof
  4331                                  
  4332                                  lff22m_8:
  4333 00001B8A 89C1                    	mov	ecx, eax	; byte count
  4334                                  lff22m_9:
  4335 00001B8C BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4336 00001B91 C605[44270000]03        	mov	byte [faz], 3  ; 3 steps/phases
  4337                                  lff22m_1:
  4338                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4339 00001B98 AC                      	lodsb
  4340 00001B99 B280                    	mov	dl, 80h
  4341 00001B9B 49                      	dec	ecx
  4342 00001B9C 7402                    	jz	short lff22m_2_1
  4343 00001B9E 8A16                    	mov	dl, [esi]
  4344                                  lff22m_2_1:	
  4345                                  	; al = [previous_val]
  4346                                  	; dl = [next_val]
  4347 00001BA0 E851060000              	call	interpolating_3_8bit_mono ; 1 of 17
  4348 00001BA5 E32D                    	jecxz	lff22m_3
  4349                                  lff22m_2_2:
  4350 00001BA7 AC                      	lodsb
  4351 00001BA8 B280                    	mov	dl, 80h
  4352 00001BAA 49                      	dec	ecx
  4353 00001BAB 7402                    	jz	short lff22m_2_3
  4354 00001BAD 8A16                    	mov	dl, [esi]
  4355                                  lff22m_2_3:
  4356 00001BAF E8C6060000               	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  4357 00001BB4 E31E                    	jecxz	lff22m_3
  4358 00001BB6 4D                      	dec	ebp
  4359 00001BB7 75EE                    	jnz	short lff22m_2_2
  4360                                  
  4361 00001BB9 A0[44270000]            	mov	al, [faz]
  4362 00001BBE FEC8                    	dec	al
  4363 00001BC0 74CA                    	jz	short lff22m_9
  4364 00001BC2 FE0D[44270000]          	dec	byte [faz]
  4365 00001BC8 BD04000000              	mov	ebp, 4
  4366 00001BCD FEC8                    	dec	al
  4367 00001BCF 75C7                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  4368 00001BD1 45                      	inc	ebp ; 5
  4369 00001BD2 EBC4                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4370                                  
  4371                                  lff22m_3:
  4372                                  lff22s_3:
  4373 00001BD4 E932F5FFFF              	jmp	lff22_3	; padfill
  4374                                  		; (put zeros in the remain words of the buffer)
  4375                                  lff22m_7:
  4376                                  lff22s_7:
  4377 00001BD9 E94EF5FFFF              	jmp	lff22_5  ; error
  4378                                  
  4379                                  load_22khz_stereo_8_bit:
  4380                                  	; 16/11/2023
  4381 00001BDE F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4382                                  					; last of the file?
  4383 00001BE5 7402                    	jz	short lff22s_0		; no
  4384 00001BE7 F9                      	stc
  4385 00001BE8 C3                      	retn
  4386                                  
  4387                                  lff22s_0:
  4388                                  	; 01/12/2024
  4389                                  	; edi = audio buffer address
  4390                                  	; 13/12/2024
  4391 00001BE9 893D[F8320000]          	mov	[audio_buffer], edi
  4392 00001BEF BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4393                                          ;mov	edx, [loadsize]
  4394                                  
  4395                                  	; esi = buffer address
  4396                                  	;; edx = buffer size
  4397                                  
  4398                                  	; load file into memory
  4399                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001BF4 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001BFA 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001BFC 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001C02 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001C07 CD40                <1>  int 40h
  4400 00001C09 72CE                    	jc	short lff22s_7 ; error !
  4401                                  
  4402                                  	; 01/12/2024
  4403 00001C0B A3[C0380000]            	mov	[count], eax
  4404                                  
  4405                                  	;mov	edi, audio_buffer
  4406                                  	; 29/05/2024
  4407                                  	;mov	edi, [audio_buffer]
  4408                                  	
  4409 00001C10 D1E8                    	shr	eax, 1
  4410 00001C12 7505                    	jnz	short lff22s_8
  4411 00001C14 E90AF5FFFF              	jmp	lff22_eof
  4412                                  
  4413                                  lff22s_8:
  4414 00001C19 89C1                    	mov	ecx, eax	; word count
  4415                                  lff22s_9:
  4416 00001C1B BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4417 00001C20 C605[44270000]03        	mov	byte [faz], 3  ; 3 steps/phase
  4418                                  lff22s_1:
  4419                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4420 00001C27 66AD                    	lodsw
  4421 00001C29 66BA8080                	mov	dx, 8080h
  4422 00001C2D 49                      	dec	ecx
  4423 00001C2E 7403                    	jz	short lff22s_2_1
  4424 00001C30 668B16                  	mov	dx, [esi]
  4425                                  lff22s_2_1:	
  4426                                  	; al = [previous_val_l]
  4427                                  	; ah = [previous_val_r]
  4428                                  	; dl = [next_val_l]
  4429                                  	; dh = [next_val_r]
  4430 00001C33 E8EF050000              	call	interpolating_3_8bit_stereo ; 1 of 17
  4431 00001C38 E39A                    	jecxz	lff22s_3
  4432                                  lff22s_2_2:
  4433 00001C3A 66AD                    	lodsw
  4434 00001C3C 66BA8080                	mov	dx, 8080h
  4435 00001C40 49                      	dec	ecx
  4436 00001C41 7403                    	jz	short lff22s_2_3
  4437 00001C43 668B16                  	mov	dx, [esi]
  4438                                  lff22s_2_3:
  4439 00001C46 E84C060000               	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  4440 00001C4B E387                    	jecxz	lff22s_3
  4441 00001C4D 4D                      	dec	ebp
  4442 00001C4E 75EA                    	jnz	short lff22s_2_2
  4443                                  
  4444 00001C50 A0[44270000]            	mov	al, [faz]
  4445 00001C55 FEC8                    	dec	al
  4446 00001C57 74C2                    	jz	short lff22s_9
  4447 00001C59 FE0D[44270000]          	dec	byte [faz]
  4448 00001C5F BD04000000              	mov	ebp, 4
  4449 00001C64 FEC8                    	dec	al
  4450 00001C66 75BF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  4451 00001C68 45                      	inc	ebp ; 5
  4452 00001C69 EBBC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4453                                  
  4454                                  load_22khz_mono_16_bit:
  4455                                  	; 16/11/2023
  4456 00001C6B F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4457                                  					; last of the file?
  4458 00001C72 7402                    	jz	short lff22m2_0		; no
  4459 00001C74 F9                      	stc
  4460 00001C75 C3                      	retn
  4461                                  
  4462                                  lff22m2_0:
  4463                                  	; 01/12/2024
  4464                                  	; edi = audio buffer address
  4465                                  	; 13/12/2024
  4466 00001C76 893D[F8320000]          	mov	[audio_buffer], edi
  4467 00001C7C BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4468                                          ;mov	edx, [loadsize]
  4469                                  
  4470                                  	; esi = buffer address
  4471                                  	;; edx = buffer size
  4472                                  
  4473                                  	; load file into memory
  4474                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001C81 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001C87 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001C89 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001C8F B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001C94 CD40                <1>  int 40h
  4475 00001C96 7261                    	jc	short lff22m2_7 ; error !
  4476                                  
  4477                                  	; 01/12/2024
  4478 00001C98 A3[C0380000]            	mov	[count], eax
  4479                                  
  4480                                  	;mov	edi, audio_buffer
  4481                                  	; 29/05/2024
  4482                                  	;mov	edi, [audio_buffer]
  4483                                  	
  4484 00001C9D D1E8                    	shr	eax, 1
  4485 00001C9F 7505                    	jnz	short lff22m2_8
  4486 00001CA1 E97DF4FFFF              	jmp	lff22_eof
  4487                                  
  4488                                  lff22m2_8:
  4489 00001CA6 89C1                    	mov	ecx, eax	; word count
  4490                                  lff22m2_9:
  4491 00001CA8 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4492 00001CAD C605[44270000]03        	mov	byte [faz], 3  ; 3 steps/phases
  4493                                  lff22m2_1:
  4494                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4495 00001CB4 66AD                    	lodsw
  4496 00001CB6 31D2                    	xor	edx, edx
  4497 00001CB8 49                      	dec	ecx
  4498 00001CB9 7403                    	jz	short lff22m2_2_1
  4499 00001CBB 668B16                  	mov	dx, [esi]
  4500                                  lff22m2_2_1:	
  4501                                  	; ax = [previous_val]
  4502                                  	; dx = [next_val]
  4503 00001CBE E805060000              	call	interpolating_3_16bit_mono ; 1 of 17
  4504 00001CC3 E32F                    	jecxz	lff22m2_3
  4505                                  lff22m2_2_2:
  4506 00001CC5 66AD                    	lodsw
  4507 00001CC7 31D2                    	xor	edx, edx
  4508 00001CC9 49                      	dec	ecx
  4509 00001CCA 7403                    	jz	short lff22m2_2_3
  4510 00001CCC 668B16                  	mov	dx, [esi]
  4511                                  lff22m2_2_3:
  4512 00001CCF E887060000               	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  4513 00001CD4 E31E                    	jecxz	lff22m2_3
  4514 00001CD6 4D                      	dec	ebp
  4515 00001CD7 75EC                    	jnz	short lff22m2_2_2
  4516                                  
  4517 00001CD9 A0[44270000]            	mov	al, [faz]
  4518 00001CDE FEC8                    	dec	al
  4519 00001CE0 74C6                    	jz	short lff22m2_9
  4520 00001CE2 FE0D[44270000]          	dec	byte [faz]
  4521 00001CE8 BD04000000              	mov	ebp, 4
  4522 00001CED FEC8                    	dec	al
  4523 00001CEF 75C3                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  4524 00001CF1 45                      	inc	ebp ; 5
  4525 00001CF2 EBC0                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4526                                  
  4527                                  lff22m2_3:
  4528                                  lff22s2_3:
  4529 00001CF4 E912F4FFFF              	jmp	lff22_3	; padfill
  4530                                  		; (put zeros in the remain words of the buffer)
  4531                                  lff22m2_7:
  4532                                  lff22s2_7:
  4533 00001CF9 E92EF4FFFF              	jmp	lff22_5  ; error
  4534                                  
  4535                                  load_22khz_stereo_16_bit:
  4536                                  	; 16/11/2023
  4537 00001CFE F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4538                                  					; last of the file?
  4539 00001D05 7402                    	jz	short lff22s2_0		; no
  4540 00001D07 F9                      	stc
  4541 00001D08 C3                      	retn
  4542                                  
  4543                                  lff22s2_0:
  4544                                  	; 01/12/2024
  4545                                  	; edi = audio buffer address
  4546                                  	; 13/12/2024
  4547 00001D09 893D[F8320000]          	mov	[audio_buffer], edi
  4548 00001D0F BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4549                                          ;mov	edx, [loadsize]
  4550                                  
  4551                                  	; esi = buffer address
  4552                                  	;; edx = buffer size
  4553                                  
  4554                                  	; load file into memory
  4555                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001D14 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001D1A 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001D1C 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001D22 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001D27 CD40                <1>  int 40h
  4556 00001D29 72CE                    	jc	short lff22s2_7 ; error !
  4557                                  
  4558                                  	; 01/12/2024
  4559 00001D2B A3[C0380000]            	mov	[count], eax
  4560                                  
  4561                                  	;mov	edi, audio_buffer
  4562                                  	; 29/05/2024
  4563                                  	;mov	edi, [audio_buffer]
  4564                                  	
  4565 00001D30 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  4566 00001D33 7505                    	jnz	short lff22s2_8
  4567 00001D35 E9E9F3FFFF              	jmp	lff22_eof
  4568                                  
  4569                                  lff22s2_8:
  4570 00001D3A 89C1                    	mov	ecx, eax	; dword count
  4571                                  lff22s2_9:
  4572 00001D3C BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  4573 00001D41 C605[44270000]03        	mov	byte [faz], 3  ; 3 steps/phase
  4574                                  lff22s2_1:
  4575                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  4576 00001D48 66AD                    	lodsw
  4577 00001D4A 89C3                    	mov	ebx, eax
  4578 00001D4C 66AD                    	lodsw
  4579 00001D4E 8B16                    	mov	edx, [esi]
  4580 00001D50 668915[40270000]        	mov	[next_val_l], dx
  4581                                  	; 26/11/2023
  4582 00001D57 C1EA10                  	shr	edx, 16
  4583 00001D5A 49                      	dec	ecx
  4584 00001D5B 7509                    	jnz	short lff22s2_2_1
  4585 00001D5D 31D2                    	xor	edx, edx ; 0
  4586 00001D5F 668915[40270000]        	mov	[next_val_l], dx
  4587                                  lff22s2_2_1:
  4588                                  	; bx = [previous_val_l]
  4589                                  	; ax = [previous_val_r]
  4590                                  	; [next_val_l]
  4591                                  	; dx = [next_val_r]
  4592 00001D66 E88D050000              	call	interpolating_3_16bit_stereo ; 1 of 17 
  4593 00001D6B E387                    	jecxz	lff22s2_3
  4594                                  lff22s2_2_2:
  4595 00001D6D 66AD                    	lodsw
  4596 00001D6F 89C3                    	mov	ebx, eax
  4597 00001D71 66AD                    	lodsw
  4598 00001D73 8B16                    	mov	edx, [esi]
  4599 00001D75 668915[40270000]        	mov	[next_val_l], dx
  4600                                  	; 26/11/2023
  4601 00001D7C C1EA10                  	shr	edx, 16
  4602 00001D7F 49                      	dec	ecx
  4603 00001D80 7509                    	jnz	short lff22s2_2_3
  4604 00001D82 31D2                    	xor	edx, edx ; 0
  4605 00001D84 668915[40270000]        	mov	[next_val_l], dx
  4606                                  lff22s2_2_3:
  4607 00001D8B E8E3050000               	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  4608 00001D90 E31E                    	jecxz	lff22s2_2_4
  4609                                  
  4610 00001D92 4D                      	dec	ebp
  4611 00001D93 75D8                    	jnz	short lff22s2_2_2
  4612                                  
  4613 00001D95 A0[44270000]            	mov	al, [faz]
  4614 00001D9A FEC8                    	dec	al
  4615 00001D9C 749E                    	jz	short lff22s2_9
  4616 00001D9E FE0D[44270000]          	dec	byte [faz]
  4617 00001DA4 BD04000000              	mov	ebp, 4
  4618 00001DA9 FEC8                    	dec	al
  4619 00001DAB 759B                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  4620 00001DAD 45                      	inc	ebp ; 5
  4621 00001DAE EB98                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  4622                                  
  4623                                  lff22s2_2_4:
  4624                                  	; 26/11/2023
  4625 00001DB0 E956F3FFFF              	jmp	lff22_3	; padfill
  4626                                  
  4627                                  ; .....................
  4628                                  
  4629                                  load_11khz_mono_8_bit:
  4630                                  	; 18/11/2023
  4631 00001DB5 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4632                                  					; last of the file?
  4633 00001DBC 7402                    	jz	short lff11m_0		; no
  4634 00001DBE F9                      	stc
  4635 00001DBF C3                      	retn
  4636                                  
  4637                                  lff11m_0:
  4638                                  	; 01/12/2024
  4639                                  	; edi = audio buffer address
  4640                                  	; 13/12/2024
  4641 00001DC0 893D[F8320000]          	mov	[audio_buffer], edi
  4642 00001DC6 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4643                                          ;mov	edx, [loadsize]
  4644                                  
  4645                                  	; esi = buffer address
  4646                                  	;; edx = buffer size
  4647                                  
  4648                                  	; load file into memory
  4649                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001DCB 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001DD1 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001DD3 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001DD9 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001DDE CD40                <1>  int 40h
  4650 00001DE0 7247                    	jc	short lff11m_7 ; error !
  4651                                  
  4652                                  	; 01/12/2024
  4653 00001DE2 A3[C0380000]            	mov	[count], eax
  4654                                  
  4655                                  	;mov	edi, audio_buffer
  4656                                  	; 29/05/2024
  4657                                  	;mov	edi, [audio_buffer]
  4658                                  	
  4659 00001DE7 21C0                    	and	eax, eax
  4660 00001DE9 7505                    	jnz	short lff11m_8
  4661 00001DEB E933F3FFFF              	jmp	lff11_eof
  4662                                  
  4663                                  lff11m_8:
  4664 00001DF0 89C1                    	mov	ecx, eax		; byte count
  4665                                  lff11m_9:
  4666 00001DF2 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4667                                  lff11m_1:
  4668                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4669 00001DF7 AC                      	lodsb
  4670 00001DF8 B280                    	mov	dl, 80h
  4671 00001DFA 49                      	dec	ecx
  4672 00001DFB 7402                    	jz	short lff11m_2_1
  4673 00001DFD 8A16                    	mov	dl, [esi]
  4674                                  lff11m_2_1:	
  4675                                  	; al = [previous_val]
  4676                                  	; dl = [next_val]
  4677 00001DFF E8A0050000              	call	interpolating_5_8bit_mono
  4678 00001E04 E333                    	jecxz	lff11m_3
  4679                                  lff11m_2_2:
  4680 00001E06 AC                      	lodsb
  4681 00001E07 B280                    	mov	dl, 80h
  4682 00001E09 49                      	dec	ecx
  4683 00001E0A 7402                    	jz	short lff11m_2_3
  4684 00001E0C 8A16                    	mov	dl, [esi]
  4685                                  lff11m_2_3:
  4686 00001E0E E89D060000               	call	interpolating_4_8bit_mono
  4687 00001E13 E324                    	jecxz	lff11m_3
  4688                                  
  4689 00001E15 4D                      	dec	ebp
  4690 00001E16 74DA                    	jz	short lff11m_9
  4691                                  
  4692 00001E18 AC                      	lodsb
  4693 00001E19 B280                    	mov	dl, 80h
  4694 00001E1B 49                      	dec	ecx
  4695 00001E1C 7402                    	jz	short lff11m_2_4
  4696 00001E1E 8A16                    	mov	dl, [esi]
  4697                                  lff11m_2_4:
  4698 00001E20 E88B060000              	call	interpolating_4_8bit_mono
  4699 00001E25 E312                    	jecxz	lff11m_3
  4700 00001E27 EBCE                    	jmp	short lff11m_1
  4701                                  
  4702                                  lff11m_7:
  4703                                  lff11s_7:
  4704 00001E29 E9FEF2FFFF              	jmp	lff11_5  ; error
  4705                                  
  4706                                  load_11khz_stereo_8_bit:
  4707                                  	; 18/11/2023
  4708 00001E2E F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4709                                  					; last of the file?
  4710 00001E35 7407                    	jz	short lff11s_0		; no
  4711 00001E37 F9                      	stc
  4712 00001E38 C3                      	retn
  4713                                  
  4714                                  lff11m_3:
  4715                                  lff11s_3:
  4716 00001E39 E9CDF2FFFF              	jmp	lff11_3	; padfill
  4717                                  		; (put zeros in the remain words of the buffer)
  4718                                  
  4719                                  lff11s_0:
  4720                                  	; 01/12/2024
  4721                                  	; edi = audio buffer address
  4722                                  	; 13/12/2024
  4723 00001E3E 893D[F8320000]          	mov	[audio_buffer], edi
  4724 00001E44 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4725                                          ;mov	edx, [loadsize]
  4726                                  
  4727                                  	; esi = buffer address
  4728                                  	;; edx = buffer size
  4729                                  
  4730                                  	; load file into memory
  4731                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001E49 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001E4F 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001E51 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001E57 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001E5C CD40                <1>  int 40h
  4732 00001E5E 72C9                    	jc	short lff11s_7 ; error !
  4733                                  
  4734                                  	; 01/12/2024
  4735 00001E60 A3[C0380000]            	mov	[count], eax
  4736                                  
  4737                                  	;mov	edi, audio_buffer
  4738                                  	; 29/05/2024
  4739                                  	;mov	edi, [audio_buffer]
  4740                                  	
  4741 00001E65 D1E8                    	shr	eax, 1
  4742 00001E67 7505                    	jnz	short lff11s_8
  4743 00001E69 E9B5F2FFFF              	jmp	lff11_eof
  4744                                  
  4745                                  lff11s_8:
  4746 00001E6E 89C1                    	mov	ecx, eax	; word count
  4747                                  lff11s_9:
  4748 00001E70 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4749                                  lff11s_1:
  4750                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4751 00001E75 66AD                    	lodsw
  4752 00001E77 66BA8080                	mov	dx, 8080h
  4753 00001E7B 49                      	dec	ecx
  4754 00001E7C 7403                    	jz	short lff11s_2_1
  4755 00001E7E 668B16                  	mov	dx, [esi]
  4756                                  lff11s_2_1:	
  4757                                  	; al = [previous_val_l]
  4758                                  	; ah = [previous_val_r]
  4759                                  	; dl = [next_val_l]
  4760                                  	; dh = [next_val_r]
  4761 00001E81 E87D050000              	call	interpolating_5_8bit_stereo
  4762 00001E86 E3B1                    	jecxz	lff11s_3
  4763                                  lff11s_2_2:
  4764 00001E88 66AD                    	lodsw
  4765 00001E8A 66BA8080                	mov	dx, 8080h
  4766 00001E8E 49                      	dec	ecx
  4767 00001E8F 7403                    	jz	short lff11s_2_3
  4768 00001E91 668B16                  	mov	dx, [esi]
  4769                                  lff11s_2_3:
  4770 00001E94 E856060000               	call	interpolating_4_8bit_stereo
  4771 00001E99 E39E                    	jecxz	lff11s_3
  4772                                  	
  4773 00001E9B 4D                      	dec	ebp
  4774 00001E9C 74D2                    	jz	short lff11s_9
  4775                                  
  4776 00001E9E 66AD                    	lodsw
  4777 00001EA0 66BA8080                	mov	dx, 8080h
  4778 00001EA4 49                      	dec	ecx
  4779 00001EA5 7403                    	jz	short lff11s_2_4
  4780 00001EA7 668B16                  	mov	dx, [esi]
  4781                                  lff11s_2_4:
  4782 00001EAA E840060000              	call	interpolating_4_8bit_stereo
  4783 00001EAF E388                    	jecxz	lff11s_3
  4784 00001EB1 EBC2                    	jmp	short lff11s_1
  4785                                  
  4786                                  load_11khz_mono_16_bit:
  4787                                  	; 18/11/2023
  4788 00001EB3 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4789                                  					; last of the file?
  4790 00001EBA 7402                    	jz	short lff11m2_0		; no
  4791 00001EBC F9                      	stc
  4792 00001EBD C3                      	retn
  4793                                  
  4794                                  lff11m2_0:
  4795                                  	; 01/12/2024
  4796                                  	; edi = audio buffer address
  4797                                  	; 13/12/2024
  4798 00001EBE 893D[F8320000]          	mov	[audio_buffer], edi
  4799 00001EC4 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4800                                          ;mov	edx, [loadsize]
  4801                                  
  4802                                  	; esi = buffer address
  4803                                  	;; edx = buffer size
  4804                                  
  4805                                  	; load file into memory
  4806                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001EC9 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001ECF 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001ED1 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001ED7 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001EDC CD40                <1>  int 40h
  4807 00001EDE 724D                    	jc	short lff11m2_7 ; error !
  4808                                  
  4809                                  	; 01/12/2024
  4810 00001EE0 A3[C0380000]            	mov	[count], eax
  4811                                  
  4812                                  	;mov	edi, audio_buffer
  4813                                  	; 29/05/2024
  4814                                  	;mov	edi, [audio_buffer]
  4815                                  	
  4816 00001EE5 D1E8                    	shr	eax, 1
  4817 00001EE7 7505                    	jnz	short lff11m2_8
  4818 00001EE9 E935F2FFFF              	jmp	lff11_eof
  4819                                  
  4820                                  lff11m2_8:
  4821 00001EEE 89C1                    	mov	ecx, eax	; word count
  4822                                  lff11m2_9:
  4823 00001EF0 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4824                                  lff11m2_1:
  4825                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4826 00001EF5 66AD                    	lodsw
  4827 00001EF7 31D2                    	xor	edx, edx
  4828 00001EF9 49                      	dec	ecx
  4829 00001EFA 7403                    	jz	short lff11m2_2_1
  4830 00001EFC 668B16                  	mov	dx, [esi]
  4831                                  lff11m2_2_1:	
  4832                                  	; ax = [previous_val]
  4833                                  	; dx = [next_val]
  4834 00001EFF E858060000              	call	interpolating_5_16bit_mono
  4835 00001F04 E368                    	jecxz	lff11m2_3
  4836                                  lff11m2_2_2:
  4837 00001F06 66AD                    	lodsw
  4838 00001F08 31D2                    	xor	edx, edx
  4839 00001F0A 49                      	dec	ecx
  4840 00001F0B 7403                    	jz	short lff11m2_2_3
  4841 00001F0D 668B16                  	mov	dx, [esi]
  4842                                  lff11m2_2_3:
  4843 00001F10 E871070000               	call	interpolating_4_16bit_mono
  4844 00001F15 E357                    	jecxz	lff11m2_3
  4845                                  
  4846 00001F17 4D                      	dec	ebp
  4847 00001F18 74D6                    	jz	short lff11m2_9
  4848                                  
  4849 00001F1A 66AD                    	lodsw
  4850 00001F1C 31D2                    	xor	edx, edx
  4851 00001F1E 49                      	dec	ecx
  4852 00001F1F 7403                    	jz	short lff11m2_2_4
  4853 00001F21 668B16                  	mov	dx, [esi]
  4854                                  lff11m2_2_4:
  4855 00001F24 E85D070000               	call	interpolating_4_16bit_mono
  4856 00001F29 E343                    	jecxz	lff11m2_3
  4857 00001F2B EBC8                    	jmp	short lff11m2_1
  4858                                  
  4859                                  lff11m2_7:
  4860                                  lff11s2_7:
  4861 00001F2D E9FAF1FFFF              	jmp	lff11_5  ; error
  4862                                  
  4863                                  load_11khz_stereo_16_bit:
  4864                                  	; 18/11/2023
  4865 00001F32 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4866                                  					; last of the file?
  4867 00001F39 7402                    	jz	short lff11s2_0		; no
  4868 00001F3B F9                      	stc
  4869 00001F3C C3                      	retn
  4870                                  
  4871                                  lff11s2_0:
  4872                                  	; 01/12/2024
  4873                                  	; edi = audio buffer address
  4874                                  	; 13/12/2024
  4875 00001F3D 893D[F8320000]          	mov	[audio_buffer], edi
  4876 00001F43 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4877                                          ;mov	edx, [loadsize]
  4878                                  
  4879                                  	; esi = buffer address
  4880                                  	;; edx = buffer size
  4881                                  
  4882                                  	; load file into memory
  4883                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00001F48 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00001F4E 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00001F50 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00001F56 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00001F5B CD40                <1>  int 40h
  4884 00001F5D 72CE                    	jc	short lff11s2_7 ; error !
  4885                                  
  4886                                  	; 01/12/2024
  4887 00001F5F A3[C0380000]            	mov	[count], eax
  4888                                  
  4889                                  	;mov	edi, audio_buffer
  4890                                  	; 29/05/2024
  4891                                  	;mov	edi, [audio_buffer]
  4892                                  	
  4893 00001F64 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  4894 00001F67 750A                    	jnz	short lff11s2_8
  4895 00001F69 E9B5F1FFFF              	jmp	lff11_eof
  4896                                  
  4897                                  lff11m2_3:
  4898                                  lff11s2_3:
  4899 00001F6E E998F1FFFF              	jmp	lff11_3	; padfill
  4900                                  		; (put zeros in the remain words of the buffer)
  4901                                  
  4902                                  lff11s2_8:
  4903 00001F73 89C1                    	mov	ecx, eax	; dword count
  4904                                  lff11s2_9:
  4905 00001F75 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  4906                                  lff11s2_1:
  4907                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  4908 00001F7A 66AD                    	lodsw
  4909 00001F7C 89C3                    	mov	ebx, eax
  4910 00001F7E 66AD                    	lodsw
  4911 00001F80 8B16                    	mov	edx, [esi]
  4912 00001F82 8915[40270000]          	mov	[next_val_l], edx
  4913                                  	; 26/11/2023
  4914 00001F88 C1EA10                  	shr	edx, 16
  4915                                  	;mov	[next_val_r], dx
  4916 00001F8B 49                      	dec	ecx
  4917 00001F8C 7509                    	jnz	short lff11s2_2_1
  4918 00001F8E 31D2                    	xor	edx, edx ; 0
  4919 00001F90 668915[40270000]        	mov	[next_val_l], dx
  4920                                  	;mov	[next_val_r], dx
  4921                                  lff11s2_2_1:
  4922                                  	; bx = [previous_val_l]
  4923                                  	; ax = [previous_val_r]
  4924                                  	; [next_val_l]
  4925                                  	; dx = [next_val_r]
  4926 00001F97 E81B060000              	call	interpolating_5_16bit_stereo
  4927 00001F9C E3D0                    	jecxz	lff11s2_3
  4928                                  lff11s2_2_2:
  4929 00001F9E 66AD                    	lodsw
  4930 00001FA0 89C3                    	mov	ebx, eax
  4931 00001FA2 66AD                    	lodsw
  4932 00001FA4 8B16                    	mov	edx, [esi]
  4933 00001FA6 668915[40270000]        	mov	[next_val_l], dx
  4934                                  	; 26/11/2023
  4935 00001FAD C1EA10                  	shr	edx, 16
  4936                                  	;mov	[next_val_r], dx
  4937 00001FB0 49                      	dec	ecx
  4938 00001FB1 7509                    	jnz	short lff11s2_2_3
  4939 00001FB3 31D2                    	xor	edx, edx ; 0
  4940 00001FB5 668915[40270000]        	mov	[next_val_l], dx
  4941                                  	;mov	[next_val_r], dx
  4942                                  lff11s2_2_3:
  4943 00001FBC E8FE060000               	call	interpolating_4_16bit_stereo
  4944 00001FC1 E3AB                    	jecxz	lff11s2_3
  4945                                  	
  4946 00001FC3 4D                      	dec	ebp
  4947 00001FC4 74AF                    	jz	short lff11s2_9
  4948                                  
  4949 00001FC6 66AD                    	lodsw
  4950 00001FC8 89C3                    	mov	ebx, eax
  4951 00001FCA 66AD                    	lodsw
  4952 00001FCC 8B16                    	mov	edx, [esi]
  4953 00001FCE 668915[40270000]        	mov	[next_val_l], dx
  4954                                  	; 26/11/2023
  4955 00001FD5 C1EA10                  	shr	edx, 16
  4956                                  	;mov	[next_val_r], dx
  4957 00001FD8 49                      	dec	ecx
  4958 00001FD9 7509                    	jnz	short lff11s2_2_4
  4959 00001FDB 31D2                    	xor	edx, edx ; 0
  4960 00001FDD 668915[40270000]        	mov	[next_val_l], dx
  4961                                  	;mov	[next_val_r], dx
  4962                                  lff11s2_2_4:
  4963 00001FE4 E8D6060000               	call	interpolating_4_16bit_stereo
  4964 00001FE9 E383                    	jecxz	lff11s2_3
  4965 00001FEB EB8D                    	jmp	short lff11s2_1
  4966                                  
  4967                                  ; .....................
  4968                                  
  4969                                  load_44khz_mono_8_bit:
  4970                                  	; 18/11/2023
  4971 00001FED F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  4972                                  					; last of the file?
  4973 00001FF4 7402                    	jz	short lff44m_0		; no
  4974 00001FF6 F9                      	stc
  4975 00001FF7 C3                      	retn
  4976                                  
  4977                                  lff44m_0:
  4978                                  	; 01/12/2024
  4979                                  	; edi = audio buffer address
  4980                                  	; 13/12/2024
  4981 00001FF8 893D[F8320000]          	mov	[audio_buffer], edi
  4982 00001FFE BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  4983                                          ;mov	edx, [loadsize]
  4984                                  
  4985                                  	; esi = buffer address
  4986                                  	;; edx = buffer size
  4987                                  
  4988                                  	; load file into memory
  4989                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00002003 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00002009 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000200B 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00002011 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00002016 CD40                <1>  int 40h
  4990 00002018 7250                    	jc	short lff44m_7 ; error !
  4991                                  
  4992                                  	; 01/12/2024
  4993 0000201A A3[C0380000]            	mov	[count], eax
  4994                                  
  4995                                  	;mov	edi, audio_buffer
  4996                                  	; 29/05/2024
  4997                                  	;mov	edi, [audio_buffer]
  4998                                  	
  4999 0000201F 21C0                    	and	eax, eax
  5000 00002021 7505                    	jnz	short lff44m_8
  5001 00002023 E9FBF0FFFF              	jmp	lff44_eof
  5002                                  
  5003                                  lff44m_8:
  5004 00002028 89C1                    	mov	ecx, eax	; byte count
  5005                                  lff44m_9:
  5006 0000202A BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5007 0000202F C605[44270000]02        	mov	byte [faz], 2  ; 2 steps/phases
  5008                                  lff44m_1:
  5009                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5010                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5011 00002036 AC                      	lodsb
  5012 00002037 B280                    	mov	dl, 80h
  5013 00002039 49                      	dec	ecx
  5014 0000203A 7402                    	jz	short lff44m_2_1
  5015 0000203C 8A16                    	mov	dl, [esi]
  5016                                  lff44m_2_1:	
  5017                                  	; al = [previous_val]
  5018                                  	; dl = [next_val]
  5019 0000203E E837020000              	call	interpolating_2_8bit_mono
  5020 00002043 E320                    	jecxz	lff44m_3
  5021                                  lff44m_2_2:
  5022 00002045 AC                      	lodsb
  5023 00002046 2C80                    	sub	al, 80h
  5024 00002048 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5025 0000204C 66AB                    	stosw		; (L)
  5026 0000204E 66AB                    	stosw		; (R)
  5027                                  
  5028 00002050 49                      	dec	ecx
  5029 00002051 7412                    	jz	short lff44m_3
  5030 00002053 4D                      	dec	ebp
  5031 00002054 75EF                    	jnz	short lff44m_2_2
  5032                                  	
  5033 00002056 FE0D[44270000]          	dec	byte [faz]
  5034 0000205C 74CC                    	jz	short lff44m_9 
  5035 0000205E BD0B000000              	mov	ebp, 11
  5036 00002063 EBD1                    	jmp	short lff44m_1
  5037                                  
  5038                                  lff44m_3:
  5039                                  lff44s_3:
  5040 00002065 E9A1F0FFFF              	jmp	lff44_3	; padfill
  5041                                  		; (put zeros in the remain words of the buffer)
  5042                                  lff44m_7:
  5043                                  lff44s_7:
  5044 0000206A E9BDF0FFFF              	jmp	lff44_5  ; error
  5045                                  
  5046                                  load_44khz_stereo_8_bit:
  5047                                  	; 16/11/2023
  5048 0000206F F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  5049                                  					; last of the file?
  5050 00002076 7402                    	jz	short lff44s_0		; no
  5051 00002078 F9                      	stc
  5052 00002079 C3                      	retn
  5053                                  
  5054                                  lff44s_0:
  5055                                  	; 01/12/2024
  5056                                  	; edi = audio buffer address
  5057                                  	; 13/12/2024
  5058 0000207A 893D[F8320000]          	mov	[audio_buffer], edi
  5059 00002080 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5060                                          ;mov	edx, [loadsize]
  5061                                  
  5062                                  	; esi = buffer address
  5063                                  	;; edx = buffer size
  5064                                  
  5065                                  	; load file into memory
  5066                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00002085 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000208B 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000208D 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00002093 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 00002098 CD40                <1>  int 40h
  5067 0000209A 72CE                    	jc	short lff44s_7 ; error !
  5068                                  
  5069                                  	; 01/12/2024
  5070 0000209C A3[C0380000]            	mov	[count], eax
  5071                                  
  5072                                  	;mov	edi, audio_buffer
  5073                                  	; 29/05/2024
  5074                                  	;mov	edi, [audio_buffer]
  5075                                  	
  5076 000020A1 D1E8                    	shr	eax, 1
  5077 000020A3 7505                    	jnz	short lff44s_8
  5078 000020A5 E979F0FFFF              	jmp	lff44_eof
  5079                                  
  5080                                  lff44s_8:
  5081 000020AA 89C1                    	mov	ecx, eax	; word count
  5082                                  lff44s_9:
  5083 000020AC BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5084 000020B1 C605[44270000]02        	mov	byte [faz], 2  ; 2 steps/phase
  5085                                  lff44s_1:
  5086                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5087                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5088 000020B8 66AD                    	lodsw
  5089 000020BA 66BA8080                	mov	dx, 8080h
  5090 000020BE 49                      	dec	ecx
  5091 000020BF 7403                    	jz	short lff44s_2_1
  5092 000020C1 668B16                  	mov	dx, [esi]
  5093                                  lff44s_2_1:	
  5094                                  	; al = [previous_val_l]
  5095                                  	; ah = [previous_val_r]
  5096                                  	; dl = [next_val_l]
  5097                                  	; dh = [next_val_r]
  5098 000020C4 E8CE010000              	call	interpolating_2_8bit_stereo
  5099 000020C9 E39A                    	jecxz	lff44s_3
  5100                                  lff44s_2_2:
  5101 000020CB AC                      	lodsb
  5102 000020CC 2C80                    	sub	al, 80h
  5103 000020CE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5104 000020D2 66AB                    	stosw		; (L)
  5105 000020D4 AC                      	lodsb
  5106 000020D5 2C80                    	sub	al, 80h
  5107 000020D7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5108 000020DB 66AB                    	stosw		; (R)
  5109                                  
  5110 000020DD 49                      	dec	ecx
  5111 000020DE 7485                    	jz	short lff44s_3	
  5112 000020E0 4D                      	dec	ebp
  5113 000020E1 75E8                    	jnz	short lff44s_2_2
  5114                                  	
  5115 000020E3 FE0D[44270000]          	dec	byte [faz]
  5116 000020E9 74C1                    	jz	short lff44s_9 
  5117 000020EB BD0B000000              	mov	ebp, 11
  5118 000020F0 EBC6                    	jmp	short lff44s_1
  5119                                  
  5120                                  load_44khz_mono_16_bit:
  5121                                  	; 18/11/2023
  5122 000020F2 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  5123                                  					; last of the file?
  5124 000020F9 7402                    	jz	short lff44m2_0		; no
  5125 000020FB F9                      	stc
  5126 000020FC C3                      	retn
  5127                                  
  5128                                  lff44m2_0:
  5129                                  	; 01/12/2024
  5130                                  	; edi = audio buffer address
  5131                                  	; 13/12/2024
  5132 000020FD 893D[F8320000]          	mov	[audio_buffer], edi
  5133 00002103 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5134                                          ;mov	edx, [loadsize]
  5135                                  
  5136                                  	; esi = buffer address
  5137                                  	;; edx = buffer size
  5138                                  
  5139                                  	; load file into memory
  5140                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00002108 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000210E 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00002110 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00002116 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 0000211B CD40                <1>  int 40h
  5141 0000211D 724D                    	jc	short lff44m2_7 ; error !
  5142                                  
  5143                                  	; 01/12/2024
  5144 0000211F A3[C0380000]            	mov	[count], eax
  5145                                  
  5146                                  	;mov	edi, audio_buffer
  5147                                  	; 29/05/2024
  5148                                  	;mov	edi, [audio_buffer]
  5149                                  	
  5150 00002124 D1E8                    	shr	eax, 1
  5151 00002126 7505                    	jnz	short lff44m2_8
  5152 00002128 E9F6EFFFFF              	jmp	lff44_eof
  5153                                  
  5154                                  lff44m2_8:
  5155 0000212D 89C1                    	mov	ecx, eax	; word count
  5156                                  lff44m2_9:
  5157 0000212F BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5158 00002134 C605[44270000]02        	mov	byte [faz], 2  ; 2 steps/phases
  5159                                  lff44m2_1:
  5160                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5161                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5162 0000213B 66AD                    	lodsw
  5163 0000213D 31D2                    	xor	edx, edx
  5164 0000213F 49                      	dec	ecx
  5165 00002140 7403                    	jz	short lff44m2_2_1
  5166 00002142 668B16                  	mov	dx, [esi]
  5167                                  lff44m2_2_1:	
  5168                                  	; ax = [previous_val]
  5169                                  	; dx = [next_val]
  5170 00002145 E811020000              	call	interpolating_2_16bit_mono
  5171 0000214A E31B                    	jecxz	lff44m2_3
  5172                                  lff44m2_2_2:
  5173 0000214C 66AD                    	lodsw
  5174 0000214E 66AB                    	stosw		; (L)eft Channel
  5175 00002150 66AB                    	stosw		; (R)ight Channel
  5176                                  
  5177 00002152 49                      	dec	ecx
  5178 00002153 7412                    	jz	short lff44m2_3	
  5179 00002155 4D                      	dec	ebp
  5180 00002156 75F4                    	jnz	short lff44m2_2_2
  5181                                  	
  5182 00002158 FE0D[44270000]          	dec	byte [faz]
  5183 0000215E 74CF                    	jz	short lff44m2_9 
  5184 00002160 BD0B000000              	mov	ebp, 11
  5185 00002165 EBD4                    	jmp	short lff44m2_1
  5186                                  
  5187                                  lff44m2_3:
  5188                                  lff44s2_3:
  5189 00002167 E99FEFFFFF              	jmp	lff44_3	; padfill
  5190                                  		; (put zeros in the remain words of the buffer)
  5191                                  lff44m2_7:
  5192                                  lff44s2_7:
  5193 0000216C E9BBEFFFFF              	jmp	lff44_5  ; error
  5194                                  
  5195                                  load_44khz_stereo_16_bit:
  5196                                  	; 18/11/2023
  5197 00002171 F605[3A380000]01                test    byte [flags], ENDOFFILE	; have we already read the
  5198                                  					; last of the file?
  5199 00002178 7402                    	jz	short lff44s2_0		; no
  5200 0000217A F9                      	stc
  5201 0000217B C3                      	retn
  5202                                  
  5203                                  lff44s2_0:
  5204                                  	; 01/12/2024
  5205                                  	; edi = audio buffer address
  5206                                  	; 13/12/2024
  5207 0000217C 893D[F8320000]          	mov	[audio_buffer], edi
  5208 00002182 BE[00500200]            	mov	esi, temp_buffer ; temporary buffer for wav data
  5209                                          ;mov	edx, [loadsize]
  5210                                  
  5211                                  	; esi = buffer address
  5212                                  	;; edx = buffer size
  5213                                  
  5214                                  	; load file into memory
  5215                                  	sys 	_read, [filehandle], esi, [loadsize]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00002187 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 0000218D 89F1                <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 0000218F 8B15[B0380000]      <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00002195 B803000000          <1>  mov eax, %1
   104                              <1> 
   105 0000219A CD40                <1>  int 40h
  5216 0000219C 72CE                    	jc	short lff44s2_7 ; error !
  5217                                  
  5218                                  	; 01/12/2024
  5219 0000219E A3[C0380000]            	mov	[count], eax
  5220                                  
  5221                                  	;mov	edi, audio_buffer
  5222                                  	; 29/05/2024
  5223                                  	;mov	edi, [audio_buffer]
  5224                                  	
  5225 000021A3 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  5226 000021A6 7505                    	jnz	short lff44s2_8
  5227 000021A8 E976EFFFFF              	jmp	lff44_eof
  5228                                  
  5229                                  lff44s2_8:
  5230 000021AD 89C1                    	mov	ecx, eax	; dword count
  5231                                  lff44s2_9:
  5232 000021AF BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  5233 000021B4 C605[44270000]02        	mov	byte [faz], 2  ; 2 steps/phase
  5234                                  lff44s2_1:
  5235                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  5236                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  5237 000021BB 66AD                    	lodsw
  5238 000021BD 89C3                    	mov	ebx, eax
  5239 000021BF 66AD                    	lodsw
  5240                                  	;mov	dx, [esi]
  5241                                  	;mov	[next_val_l], dx
  5242                                  	;mov	dx, [esi+2]
  5243                                  	; 26/11/2023
  5244 000021C1 8B16                    	mov	edx, [esi]
  5245 000021C3 668915[40270000]        	mov	[next_val_l], dx
  5246 000021CA C1EA10                  	shr	edx, 16
  5247 000021CD 49                      	dec	ecx
  5248 000021CE 7509                    	jnz	short lff44s2_2_1
  5249 000021D0 31D2                    	xor	edx, edx ; 0
  5250 000021D2 668915[40270000]        	mov	[next_val_l], dx
  5251                                  lff44s2_2_1:
  5252                                  	; bx = [previous_val_l]
  5253                                  	; ax = [previous_val_r]
  5254                                  	; [next_val_l]
  5255                                  	; dx = [next_val_r]
  5256 000021D9 E895010000              	call	interpolating_2_16bit_stereo
  5257 000021DE E387                    	jecxz	lff44s2_3
  5258                                  lff44s2_2_2:
  5259                                  	;movsw		; (L)eft Channel
  5260                                  	;movsw		; (R)ight Channel
  5261 000021E0 A5                      	movsd
  5262                                  
  5263 000021E1 49                      	dec	ecx
  5264 000021E2 7483                    	jz	short lff44s2_3	
  5265 000021E4 4D                      	dec	ebp
  5266 000021E5 75F9                    	jnz	short lff44s2_2_2
  5267                                  	
  5268 000021E7 FE0D[44270000]          	dec	byte [faz]
  5269 000021ED 74C0                    	jz	short lff44s2_9 
  5270 000021EF BD0B000000              	mov	ebp, 11
  5271 000021F4 EBC5                    	jmp	short lff44s2_1
  5272                                  
  5273                                  ; .....................
  5274                                  
  5275                                  interpolating_3_8bit_mono:
  5276                                  	; 16/11/2023
  5277                                  	; al = [previous_val]
  5278                                  	; dl = [next_val]
  5279                                  	; original-interpolated-interpolated
  5280 000021F6 88C3                    	mov	bl, al
  5281 000021F8 2C80                    	sub	al, 80h
  5282 000021FA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5283 000021FE 66AB                    	stosw		; original sample (L)
  5284 00002200 66AB                    	stosw		; original sample (R)
  5285 00002202 88D8                    	mov	al, bl
  5286 00002204 00D0                    	add	al, dl
  5287 00002206 D0D8                    	rcr	al, 1
  5288 00002208 88C7                    	mov	bh, al	; interpolated middle (temporary)
  5289 0000220A 00D8                    	add	al, bl
  5290 0000220C D0D8                    	rcr	al, 1
  5291 0000220E 2C80                    	sub	al, 80h
  5292 00002210 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5293 00002214 66AB                    	stosw		; interpolated sample 1 (L)
  5294 00002216 66AB                    	stosw		; interpolated sample 1 (R)
  5295 00002218 88F8                    	mov	al, bh
  5296 0000221A 00D0                    	add	al, dl	; [next_val]
  5297 0000221C D0D8                    	rcr	al, 1
  5298 0000221E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5299 00002222 66AB                    	stosw		; interpolated sample 2 (L)
  5300 00002224 66AB                    	stosw		; interpolated sample 2 (R)
  5301 00002226 C3                      	retn
  5302                                  
  5303                                  interpolating_3_8bit_stereo:
  5304                                  	; 16/11/2023
  5305                                  	; al = [previous_val_l]
  5306                                  	; ah = [previous_val_r]
  5307                                  	; dl = [next_val_l]
  5308                                  	; dh = [next_val_r]
  5309                                  	; original-interpolated-interpolated
  5310 00002227 89C3                    	mov	ebx, eax
  5311 00002229 2C80                    	sub	al, 80h
  5312 0000222B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5313 0000222F 66AB                    	stosw		; original sample (L)
  5314 00002231 88F8                    	mov	al, bh
  5315 00002233 2C80                    	sub	al, 80h
  5316 00002235 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5317 00002239 66AB                    	stosw		; original sample (R)
  5318 0000223B 88D8                    	mov	al, bl
  5319 0000223D 00D0                    	add	al, dl	; [next_val_l]
  5320 0000223F D0D8                    	rcr	al, 1
  5321 00002241 50                      	push	eax ; *	; al = interpolated middle (L) (temporary)
  5322 00002242 00D8                    	add	al, bl	; [previous_val_l]
  5323 00002244 D0D8                    	rcr	al, 1
  5324 00002246 2C80                    	sub	al, 80h
  5325 00002248 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5326 0000224C 66AB                    	stosw		; interpolated sample 1 (L)
  5327 0000224E 88F8                    	mov	al, bh
  5328 00002250 00F0                    	add	al, dh	; [next_val_r]
  5329 00002252 D0D8                    	rcr	al, 1
  5330 00002254 50                      	push	eax ; ** ; al = interpolated middle (R) (temporary)
  5331 00002255 00F8                    	add	al, bh	; [previous_val_r]
  5332 00002257 D0D8                    	rcr	al, 1
  5333 00002259 2C80                    	sub	al, 80h
  5334 0000225B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5335 0000225F 66AB                    	stosw		; interpolated sample 1 (R)
  5336 00002261 5B                      	pop	ebx ; **
  5337 00002262 58                      	pop	eax ; *
  5338 00002263 00D0                    	add	al, dl	; [next_val_l]
  5339 00002265 D0D8                    	rcr	al, 1
  5340 00002267 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5341 0000226B 66AB                    	stosw		; interpolated sample 2 (L)
  5342 0000226D 88D8                    	mov	al, bl
  5343 0000226F 00F0                    	add	al, dh	; [next_val_r]
  5344 00002271 D0D8                    	rcr	al, 1
  5345 00002273 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5346 00002277 66AB                    	stosw		; interpolated sample 2 (R)
  5347 00002279 C3                      	retn
  5348                                  
  5349                                  interpolating_2_8bit_mono:
  5350                                  	; 16/11/2023
  5351                                  	; al = [previous_val]
  5352                                  	; dl = [next_val]
  5353                                  	; original-interpolated
  5354 0000227A 88C3                    	mov	bl, al
  5355 0000227C 2C80                    	sub	al, 80h
  5356 0000227E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5357 00002282 66AB                    	stosw		; original sample (L)
  5358 00002284 66AB                    	stosw		; original sample (R)
  5359 00002286 88D8                    	mov	al, bl
  5360 00002288 00D0                    	add	al, dl
  5361 0000228A D0D8                    	rcr	al, 1
  5362 0000228C 2C80                    	sub	al, 80h
  5363 0000228E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5364 00002292 66AB                    	stosw		; interpolated sample (L)
  5365 00002294 66AB                    	stosw		; interpolated sample (R)
  5366 00002296 C3                      	retn
  5367                                  
  5368                                  interpolating_2_8bit_stereo:
  5369                                  	; 16/11/2023
  5370                                  	; al = [previous_val_l]
  5371                                  	; ah = [previous_val_r]
  5372                                  	; dl = [next_val_l]
  5373                                  	; dh = [next_val_r]
  5374                                  	; original-interpolated
  5375 00002297 89C3                    	mov	ebx, eax
  5376 00002299 2C80                    	sub	al, 80h
  5377 0000229B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5378 0000229F 66AB                    	stosw		; original sample (L)
  5379 000022A1 88F8                    	mov	al, bh
  5380 000022A3 2C80                    	sub	al, 80h
  5381 000022A5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5382 000022A9 66AB                    	stosw		; original sample (R)
  5383 000022AB 88D8                    	mov	al, bl	; [previous_val_l]
  5384 000022AD 00D0                    	add	al, dl	; [next_val_l]
  5385 000022AF D0D8                    	rcr	al, 1
  5386 000022B1 2C80                    	sub	al, 80h
  5387 000022B3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5388 000022B7 66AB                    	stosw		; interpolated sample (L)
  5389 000022B9 88F8                    	mov	al, bh
  5390 000022BB 00F0                    	add	al, dh	; [next_val_r]
  5391 000022BD D0D8                    	rcr	al, 1
  5392 000022BF 2C80                    	sub	al, 80h
  5393 000022C1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5394 000022C5 66AB                    	stosw		; interpolated sample (R)
  5395 000022C7 C3                      	retn
  5396                                  
  5397                                  interpolating_3_16bit_mono:
  5398                                  	; 16/11/2023
  5399                                  	; ax = [previous_val]
  5400                                  	; dx = [next_val]
  5401                                  	; original-interpolated-interpolated
  5402                                  
  5403 000022C8 66AB                    	stosw		; original sample (L)
  5404 000022CA 66AB                    	stosw		; original sample (R)
  5405 000022CC 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5406 000022CF 50                      	push	eax ; *	; [previous_val]
  5407 000022D0 80C680                  	add	dh, 80h
  5408 000022D3 6601D0                  	add	ax, dx
  5409 000022D6 66D1D8                  	rcr	ax, 1
  5410 000022D9 5B                      	pop	ebx ; *
  5411 000022DA 93                      	xchg	ebx, eax ; bx  = interpolated middle (temporary)
  5412 000022DB 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  5413 000022DE 66D1D8                  	rcr	ax, 1
  5414 000022E1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5415 000022E4 66AB                    	stosw 		; interpolated sample 1 (L)
  5416 000022E6 66AB                    	stosw		; interpolated sample 1 (R)
  5417 000022E8 89D8                    	mov	eax, ebx
  5418 000022EA 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  5419 000022ED 66D1D8                  	rcr	ax, 1
  5420 000022F0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5421 000022F3 66AB                    	stosw		; interpolated sample 2 (L)
  5422 000022F5 66AB                    	stosw		; interpolated sample 2 (R)
  5423 000022F7 C3                      	retn
  5424                                  
  5425                                  interpolating_3_16bit_stereo:
  5426                                  	; 16/11/2023
  5427                                  	; bx = [previous_val_l]
  5428                                  	; ax = [previous_val_r]
  5429                                  	; [next_val_l]
  5430                                  	; dx = [next_val_r]
  5431                                  	; original-interpolated-interpolated
  5432                                  
  5433 000022F8 93                      	xchg	eax, ebx
  5434 000022F9 66AB                    	stosw		; original sample (L)
  5435 000022FB 93                      	xchg	eax, ebx
  5436 000022FC 66AB                    	stosw		; original sample (R)
  5437 000022FE 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5438 00002301 50                      	push	eax ; *	; [previous_val_r]
  5439 00002302 80C780                  	add	bh, 80h
  5440 00002305 8005[41270000]80        	add	byte [next_val_l+1], 80h
  5441 0000230C 66A1[40270000]          	mov	ax, [next_val_l]
  5442 00002312 6601D8                  	add	ax, bx	; [previous_val_l]
  5443 00002315 66D1D8                  	rcr	ax, 1
  5444 00002318 93                      	xchg	eax, ebx ; ax = [previous_val_l]
  5445 00002319 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  5446 0000231C 66D1D8                  	rcr	ax, 1
  5447 0000231F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5448 00002322 66AB                    	stosw 		; interpolated sample 1 (L)
  5449 00002324 58                      	pop	eax  ; *
  5450 00002325 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  5451 00002328 52                      	push	edx  ; * ; [next_val_r]
  5452 00002329 92                      	xchg	eax, edx
  5453 0000232A 6601D0                  	add	ax, dx	; [next_val_r] + [previous_val_r]
  5454 0000232D 66D1D8                  	rcr	ax, 1	; / 2
  5455 00002330 50                      	push	eax ; ** ; interpolated middle (R)
  5456 00002331 6601D0                  	add	ax, dx	; + [previous_val_r]
  5457 00002334 66D1D8                  	rcr	ax, 1
  5458 00002337 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5459 0000233A 66AB                    	stosw 		; interpolated sample 1 (R)
  5460 0000233C 66A1[40270000]          	mov	ax, [next_val_l]
  5461 00002342 6601D8                  	add	ax, bx	; + interpolated middle (L)
  5462 00002345 66D1D8                  	rcr	ax, 1
  5463 00002348 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5464 0000234B 66AB                    	stosw 		; interpolated sample 2 (L)
  5465 0000234D 58                      	pop	eax ; **
  5466 0000234E 5A                      	pop	edx ; *
  5467 0000234F 6601D0                  	add	ax, dx	; interpolated middle + [next_val_r]
  5468 00002352 66D1D8                  	rcr	ax, 1	; / 2
  5469 00002355 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5470 00002358 66AB                    	stosw 		; interpolated sample 2 (L)
  5471 0000235A C3                      	retn
  5472                                  
  5473                                  interpolating_2_16bit_mono:
  5474                                  	; 16/11/2023
  5475                                  	; ax = [previous_val]
  5476                                  	; dx = [next_val]
  5477                                  	; original-interpolated
  5478                                  
  5479 0000235B 66AB                    	stosw		; original sample (L)
  5480 0000235D 66AB                    	stosw		; original sample (R)
  5481 0000235F 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5482 00002362 80C680                  	add	dh, 80h
  5483 00002365 6601D0                  	add	ax, dx
  5484 00002368 66D1D8                  	rcr	ax, 1
  5485 0000236B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5486 0000236E 66AB                    	stosw		; interpolated sample (L)
  5487 00002370 66AB                    	stosw		; interpolated sample (R)
  5488 00002372 C3                      	retn
  5489                                  
  5490                                  interpolating_2_16bit_stereo:
  5491                                  	; 16/11/2023
  5492                                  	; bx = [previous_val_l]
  5493                                  	; ax = [previous_val_r]
  5494                                  	; [next_val_l]
  5495                                  	; dx = [next_val_r]
  5496                                  	; original-interpolated
  5497                                  
  5498 00002373 93                      	xchg	eax, ebx
  5499 00002374 66AB                    	stosw		; original sample (L)
  5500 00002376 93                      	xchg	eax, ebx
  5501 00002377 66AB                    	stosw		; original sample (R)
  5502 00002379 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5503 0000237C 80C680                  	add	dh, 80h
  5504 0000237F 6601D0                  	add	ax, dx	; [previous_val_r] + [next_val_r]
  5505 00002382 66D1D8                  	rcr	ax, 1	; / 2
  5506 00002385 50                      	push	eax ; *	; interpolated sample (R)
  5507 00002386 66A1[40270000]          	mov	ax, [next_val_l]
  5508 0000238C 80C480                  	add	ah, 80h
  5509 0000238F 80C780                  	add	bh, 80h
  5510 00002392 6601D8                  	add	ax, bx	; [next_val_l] + [previous_val_l]
  5511 00002395 66D1D8                  	rcr	ax, 1	; / 2
  5512 00002398 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5513 0000239B 66AB                    	stosw 		; interpolated sample (L)
  5514 0000239D 58                      	pop	eax ; *	
  5515 0000239E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5516 000023A1 66AB                    	stosw 		; interpolated sample (R)
  5517 000023A3 C3                      	retn
  5518                                  
  5519                                  interpolating_5_8bit_mono:
  5520                                  	; 17/11/2023
  5521                                  	; al = [previous_val]
  5522                                  	; dl = [next_val]
  5523                                  	; original-interpltd-interpltd-interpltd-interpltd
  5524 000023A4 88C3                    	mov	bl, al
  5525 000023A6 2C80                    	sub	al, 80h
  5526 000023A8 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5527 000023AC 66AB                    	stosw		; original sample (L)
  5528 000023AE 66AB                    	stosw		; original sample (R)
  5529 000023B0 88D8                    	mov	al, bl
  5530 000023B2 00D0                    	add	al, dl
  5531 000023B4 D0D8                    	rcr	al, 1
  5532 000023B6 88C7                    	mov	bh, al	; interpolated middle (temporary)
  5533 000023B8 00D8                    	add	al, bl  ; [previous_val]
  5534 000023BA D0D8                    	rcr	al, 1 	
  5535 000023BC 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  5536 000023BE 00D8                    	add	al, bl
  5537 000023C0 D0D8                    	rcr	al, 1
  5538 000023C2 2C80                    	sub	al, 80h
  5539 000023C4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5540 000023C8 66AB                    	stosw		; interpolated sample 1 (L)
  5541 000023CA 66AB                    	stosw		; interpolated sample 1 (R)
  5542 000023CC 88F8                    	mov	al, bh
  5543 000023CE 00F0                    	add	al, dh
  5544 000023D0 D0D8                    	rcr	al, 1
  5545 000023D2 2C80                    	sub	al, 80h
  5546 000023D4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5547 000023D8 66AB                    	stosw		; interpolated sample 2 (L)
  5548 000023DA 66AB                    	stosw		; interpolated sample 2 (R)
  5549 000023DC 88F8                    	mov	al, bh
  5550 000023DE 00D0                    	add	al, dl	; [next_val]
  5551 000023E0 D0D8                    	rcr	al, 1
  5552 000023E2 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  5553 000023E4 00F8                    	add	al, bh
  5554 000023E6 D0D8                    	rcr	al, 1
  5555 000023E8 2C80                    	sub	al, 80h
  5556 000023EA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5557 000023EE 66AB                    	stosw		; interpolated sample 3 (L)
  5558 000023F0 66AB                    	stosw		; interpolated sample 3 (R)
  5559 000023F2 88F0                    	mov	al, dh
  5560 000023F4 00D0                    	add	al, dl
  5561 000023F6 D0D8                    	rcr	al, 1
  5562 000023F8 2C80                    	sub	al, 80h
  5563 000023FA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5564 000023FE 66AB                    	stosw		; interpolated sample 4 (L)
  5565 00002400 66AB                    	stosw		; interpolated sample 4 (R)
  5566 00002402 C3                      	retn
  5567                                  
  5568                                  interpolating_5_8bit_stereo:
  5569                                  	; 17/11/2023
  5570                                  	; al = [previous_val_l]
  5571                                  	; ah = [previous_val_r]
  5572                                  	; dl = [next_val_l]
  5573                                  	; dh = [next_val_r]
  5574                                  	; original-interpltd-interpltd-interpltd-interpltd
  5575 00002403 89C3                    	mov	ebx, eax
  5576 00002405 2C80                    	sub	al, 80h
  5577 00002407 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5578 0000240B 66AB                    	stosw		; original sample (L)
  5579 0000240D 88F8                    	mov	al, bh
  5580 0000240F 2C80                    	sub	al, 80h
  5581 00002411 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5582 00002415 66AB                    	stosw		; original sample (R)
  5583 00002417 52                      	push	edx ; *
  5584 00002418 88D8                    	mov	al, bl
  5585 0000241A 00D0                    	add	al, dl	; [next_val_l]
  5586 0000241C D0D8                    	rcr	al, 1
  5587 0000241E 50                      	push	eax ; **	; al = interpolated middle (L) (temporary)
  5588 0000241F 00D8                    	add	al, bl	; [previous_val_l]
  5589 00002421 D0D8                    	rcr	al, 1
  5590 00002423 86D8                    	xchg	al, bl
  5591 00002425 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  5592 00002427 D0D8                    	rcr	al, 1
  5593 00002429 2C80                    	sub	al, 80h
  5594 0000242B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5595 0000242F 66AB                    	stosw		; interpolated sample 1 (L)
  5596 00002431 88F8                    	mov	al, bh
  5597 00002433 00F0                    	add	al, dh	; [next_val_r]
  5598 00002435 D0D8                    	rcr	al, 1
  5599 00002437 50                      	push	eax ; *** ; al = interpolated middle (R) (temporary)
  5600 00002438 00F8                    	add	al, bh	; [previous_val_r]
  5601 0000243A D0D8                    	rcr	al, 1
  5602 0000243C 86F8                    	xchg	al, bh
  5603 0000243E 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  5604 00002440 D0D8                    	rcr	al, 1
  5605 00002442 2C80                    	sub	al, 80h
  5606 00002444 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5607 00002448 66AB                    	stosw		; interpolated sample 1 (R)
  5608 0000244A 5A                      	pop	edx ; ***
  5609 0000244B 58                      	pop	eax ; **	; al = interpolated middle (L) (temporary)
  5610 0000244C 86D8                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  5611 0000244E 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  5612 00002450 D0D8                    	rcr	al, 1
  5613 00002452 2C80                    	sub	al, 80h
  5614 00002454 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5615 00002458 66AB                    	stosw		; interpolated sample 2 (L)
  5616 0000245A 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  5617 0000245C 86F8                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  5618 0000245E 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  5619 00002460 D0D8                    	rcr	al, 1
  5620 00002462 2C80                    	sub	al, 80h
  5621 00002464 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5622 00002468 66AB                    	stosw		; interpolated sample 2 (R)
  5623 0000246A 5A                      	pop	edx ; *
  5624 0000246B 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  5625 0000246D 00D0                    	add	al, dl	; [next_val_l]
  5626 0000246F D0D8                    	rcr	al, 1
  5627 00002471 86D8                    	xchg	al, bl	; al = interpolated middle (R) (temporary)
  5628 00002473 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp)
  5629 00002475 D0D8                    	rcr	al, 1
  5630 00002477 2C80                    	sub	al, 80h
  5631 00002479 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5632 0000247D 66AB                    	stosw		; interpolated sample 3 (L)
  5633 0000247F 88F8                    	mov	al, bh	
  5634 00002481 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  5635 00002483 D0D8                    	rcr	al, 1
  5636 00002485 86F8                    	xchg	al, bh	; al = interpolated middle (R)
  5637 00002487 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  5638 00002489 D0D8                    	rcr	al, 1
  5639 0000248B 2C80                    	sub	al, 80h
  5640 0000248D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5641 00002491 66AB                    	stosw		; interpolated sample 3 (R)
  5642 00002493 88D8                    	mov	al, bl
  5643 00002495 00D0                    	add	al, dl	; [next_val_l]
  5644 00002497 D0D8                    	rcr	al, 1
  5645 00002499 2C80                    	sub	al, 80h
  5646 0000249B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5647 0000249F 66AB                    	stosw		; interpolated sample 4 (L)
  5648 000024A1 88F8                    	mov	al, bh
  5649 000024A3 00F0                    	add	al, dh	; [next_val_r]
  5650 000024A5 D0D8                    	rcr	al, 1
  5651 000024A7 2C80                    	sub	al, 80h
  5652 000024A9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5653 000024AD 66AB                    	stosw		; interpolated sample 4 (R)
  5654 000024AF C3                      	retn
  5655                                  
  5656                                  interpolating_4_8bit_mono:
  5657                                  	; 17/11/2023
  5658                                  	; al = [previous_val]
  5659                                  	; dl = [next_val]
  5660                                  	; original-interpolated-interpolated-interpolated
  5661 000024B0 88C3                    	mov	bl, al
  5662 000024B2 2C80                    	sub	al, 80h
  5663 000024B4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5664 000024B8 66AB                    	stosw		; original sample (L)
  5665 000024BA 66AB                    	stosw		; original sample (R)
  5666 000024BC 88D8                    	mov	al, bl
  5667 000024BE 00D0                    	add	al, dl	
  5668 000024C0 D0D8                    	rcr	al, 1
  5669 000024C2 86D8                    	xchg	al, bl  ; al = [previous_val]
  5670 000024C4 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  5671 000024C6 D0D8                    	rcr	al, 1 	
  5672 000024C8 2C80                    	sub	al, 80h
  5673 000024CA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5674 000024CE 66AB                    	stosw		; interpolated sample 1 (L)
  5675 000024D0 66AB                    	stosw		; interpolated sample 1 (R)
  5676 000024D2 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  5677 000024D4 2C80                    	sub	al, 80h
  5678 000024D6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5679 000024DA 66AB                    	stosw		; interpolated sample 2 (L)
  5680 000024DC 66AB                    	stosw		; interpolated sample 2 (R)
  5681 000024DE 88D8                    	mov	al, bl
  5682 000024E0 00D0                    	add	al, dl	; [next_val]
  5683 000024E2 D0D8                    	rcr	al, 1
  5684 000024E4 2C80                    	sub	al, 80h
  5685 000024E6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5686 000024EA 66AB                    	stosw		; interpolated sample 3 (L)
  5687 000024EC 66AB                    	stosw		; interpolated sample 3 (R)
  5688 000024EE C3                      	retn
  5689                                  
  5690                                  interpolating_4_8bit_stereo:
  5691                                  	; 17/11/2023
  5692                                  	; al = [previous_val_l]
  5693                                  	; ah = [previous_val_r]
  5694                                  	; dl = [next_val_l]
  5695                                  	; dh = [next_val_r]	
  5696                                  	; original-interpolated-interpolated-interpolated
  5697 000024EF 89C3                    	mov	ebx, eax
  5698 000024F1 2C80                    	sub	al, 80h
  5699 000024F3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5700 000024F7 66AB                    	stosw		; original sample (L)
  5701 000024F9 88F8                    	mov	al, bh
  5702 000024FB 2C80                    	sub	al, 80h
  5703 000024FD 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5704 00002501 66AB                    	stosw		; original sample (R)
  5705 00002503 88D8                    	mov	al, bl
  5706 00002505 00D0                    	add	al, dl	; [next_val_l]
  5707 00002507 D0D8                    	rcr	al, 1
  5708 00002509 86D8                    	xchg	al, bl	; al = [previous_val_l]
  5709 0000250B 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  5710 0000250D D0D8                    	rcr	al, 1
  5711 0000250F 2C80                    	sub	al, 80h
  5712 00002511 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5713 00002515 66AB                    	stosw		; interpolated sample 1 (L)
  5714 00002517 88F8                    	mov	al, bh
  5715 00002519 00F0                    	add	al, dh	; [next_val_r]
  5716 0000251B D0D8                    	rcr	al, 1
  5717 0000251D 86F8                    	xchg	al, bh	; al = [previous_val_h]
  5718 0000251F 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  5719 00002521 D0D8                    	rcr	al, 1
  5720 00002523 2C80                    	sub	al, 80h
  5721 00002525 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5722 00002529 66AB                    	stosw		; interpolated sample 1 (R)
  5723 0000252B 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  5724 0000252D 2C80                    	sub	al, 80h
  5725 0000252F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5726 00002533 66AB                    	stosw		; interpolated sample 2 (L)
  5727 00002535 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  5728 00002537 2C80                    	sub	al, 80h
  5729 00002539 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5730 0000253D 66AB                    	stosw		; interpolated sample 2 (L)
  5731 0000253F 88D8                    	mov	al, bl
  5732 00002541 00D0                    	add	al, dl	; [next_val_l]
  5733 00002543 D0D8                    	rcr	al, 1
  5734 00002545 2C80                    	sub	al, 80h
  5735 00002547 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5736 0000254B 66AB                    	stosw		; interpolated sample 3 (L)
  5737 0000254D 88F8                    	mov	al, bh
  5738 0000254F 00F0                    	add	al, dh	; [next_val_r]
  5739 00002551 D0D8                    	rcr	al, 1
  5740 00002553 2C80                    	sub	al, 80h
  5741 00002555 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  5742 00002559 66AB                    	stosw		; interpolated sample 3 (R)
  5743 0000255B C3                      	retn
  5744                                  
  5745                                  interpolating_5_16bit_mono:
  5746                                  	; 18/11/2023
  5747                                  	; ax = [previous_val]
  5748                                  	; dx = [next_val]
  5749                                  	; original-interpltd-interpltd-interpltd-interpltd
  5750 0000255C 66AB                    	stosw		; original sample (L)
  5751 0000255E 66AB                    	stosw		; original sample (R)
  5752 00002560 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5753 00002563 89C3                    	mov	ebx, eax ; [previous_val]
  5754 00002565 80C680                  	add	dh, 80h
  5755 00002568 6601D0                  	add	ax, dx
  5756 0000256B 66D1D8                  	rcr	ax, 1
  5757 0000256E 50                      	push	eax ; *	; interpolated middle (temporary)
  5758 0000256F 6601D8                  	add	ax, bx	; interpolated middle + [previous_val] 
  5759 00002572 66D1D8                  	rcr	ax, 1
  5760 00002575 50                      	push	eax ; **	; interpolated 1st quarter (temporary)
  5761 00002576 6601D8                  	add	ax, bx	; 1st quarter + [previous_val]
  5762 00002579 66D1D8                  	rcr	ax, 1	
  5763 0000257C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5764 0000257F 66AB                    	stosw 		; interpolated sample 1 (L)
  5765 00002581 66AB                    	stosw		; interpolated sample 1 (R)
  5766 00002583 58                      	pop	eax ; **
  5767 00002584 5B                      	pop	ebx ; *
  5768 00002585 6601D8                  	add	ax, bx	; 1st quarter + middle
  5769 00002588 66D1D8                  	rcr	ax, 1	; / 2
  5770 0000258B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  5771 0000258E 66AB                    	stosw		; interpolated sample 2 (L)
  5772 00002590 66AB                    	stosw		; interpolated sample 2 (R)
  5773 00002592 89D8                    	mov	eax, ebx
  5774 00002594 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  5775 00002597 66D1D8                  	rcr	ax, 1
  5776 0000259A 50                      	push	eax ; *	; interpolated 3rd quarter (temporary)
  5777 0000259B 6601D8                  	add	ax, bx	; + interpolated middle
  5778 0000259E 66D1D8                  	rcr	ax, 1
  5779 000025A1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5780 000025A4 66AB                    	stosw		; interpolated sample 3 (L)
  5781 000025A6 66AB                    	stosw		; interpolated sample 3 (R)
  5782 000025A8 58                      	pop	eax ; *	
  5783 000025A9 6601D0                  	add	ax, dx	; 3rd quarter + [next_val]
  5784 000025AC 66D1D8                  	rcr	ax, 1	; / 2
  5785 000025AF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5786 000025B2 66AB                    	stosw		; interpolated sample 4 (L)
  5787 000025B4 66AB                    	stosw		; interpolated sample 4 (R)
  5788 000025B6 C3                      	retn
  5789                                  
  5790                                  interpolating_5_16bit_stereo:
  5791                                  	; 18/11/2023
  5792                                  	; bx = [previous_val_l]
  5793                                  	; ax = [previous_val_r]
  5794                                  	; [next_val_l]
  5795                                  	; [next_val_r]
  5796                                  	; original-interpltd-interpltd-interpltd-interpltd
  5797 000025B7 51                      	push	ecx ; !
  5798 000025B8 93                      	xchg	eax, ebx
  5799 000025B9 66AB                    	stosw		; original sample (L)
  5800 000025BB 93                      	xchg	eax, ebx
  5801 000025BC 66AB                    	stosw		; original sample (R)
  5802 000025BE 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5803 000025C1 50                      	push	eax ; *	; [previous_val_r]
  5804 000025C2 80C780                  	add	bh, 80h
  5805 000025C5 8005[41270000]80        	add	byte [next_val_l+1], 80h
  5806 000025CC 66A1[40270000]          	mov	ax, [next_val_l]
  5807 000025D2 6601D8                  	add	ax, bx	; [previous_val_l]
  5808 000025D5 66D1D8                  	rcr	ax, 1
  5809 000025D8 89C1                    	mov	ecx, eax ; interpolated middle (L)
  5810 000025DA 6601D8                  	add	ax, bx	
  5811 000025DD 66D1D8                  	rcr	ax, 1
  5812 000025E0 89C2                    	mov	edx, eax ; interpolated 1st quarter (L)
  5813 000025E2 6601D8                  	add	ax, bx	; [previous_val_l]
  5814 000025E5 66D1D8                  	rcr	ax, 1
  5815 000025E8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5816 000025EB 66AB                    	stosw 		; interpolated sample 1 (L)
  5817 000025ED 89C8                    	mov	eax, ecx
  5818 000025EF 6601D0                  	add	ax, dx	; middle (L) + 1st quarter (L)
  5819 000025F2 66D1D8                  	rcr	ax, 1	; / 2
  5820 000025F5 89C3                    	mov	ebx, eax  ; interpolated sample 2 (L)
  5821 000025F7 5A                      	pop	edx ; *	; [previous_val_r]
  5822 000025F8 89D0                    	mov	eax, edx
  5823 000025FA 8005[43270000]80        	add	byte [next_val_r+1], 80h
  5824 00002601 660305[42270000]        	add	ax, [next_val_r]
  5825 00002608 66D1D8                  	rcr	ax, 1
  5826 0000260B 50                      	push	eax ; *	; interpolated middle (R)
  5827 0000260C 6601D0                  	add	ax, dx
  5828 0000260F 66D1D8                  	rcr	ax, 1
  5829 00002612 50                      	push	eax ; ** ; interpolated 1st quarter (R)
  5830 00002613 6601D0                  	add	ax, dx	; [previous_val_r]
  5831 00002616 66D1D8                  	rcr	ax, 1
  5832 00002619 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5833 0000261C 66AB                    	stosw 		; interpolated sample 1 (R)
  5834 0000261E 89D8                    	mov	eax, ebx
  5835 00002620 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5836 00002623 66AB                    	stosw 		; interpolated sample 2 (L)
  5837 00002625 58                      	pop	eax ; **
  5838 00002626 5A                      	pop	edx ; *
  5839 00002627 6601D0                  	add	ax, dx	; 1st quarter (R) + middle (R)
  5840 0000262A 66D1D8                  	rcr	ax, 1	; / 2
  5841 0000262D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5842 00002630 66AB                    	stosw 		; interpolated sample 2 (R)
  5843 00002632 89C8                    	mov	eax, ecx
  5844 00002634 660305[40270000]        	add	ax, [next_val_l]
  5845 0000263B 66D1D8                  	rcr	ax, 1
  5846 0000263E 50                      	push	eax ; * ; interpolated 3rd quarter (L)
  5847 0000263F 6601C8                  	add	ax, cx	; interpolated middle (L)
  5848 00002642 66D1D8                  	rcr	ax, 1
  5849 00002645 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5850 00002648 66AB                    	stosw 		; interpolated sample 3 (L)
  5851 0000264A 89D0                    	mov	eax, edx
  5852 0000264C 660305[42270000]        	add	ax, [next_val_r]
  5853 00002653 66D1D8                  	rcr	ax, 1
  5854 00002656 50                      	push	eax ; ** ; interpolated 3rd quarter (R)
  5855 00002657 6601D0                  	add	ax, dx	; interpolated middle (R)
  5856 0000265A 66D1D8                  	rcr	ax, 1
  5857 0000265D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5858 00002660 66AB                    	stosw 		; interpolated sample 3 (R)
  5859 00002662 5B                      	pop	ebx ; **
  5860 00002663 58                      	pop	eax ; *
  5861 00002664 660305[40270000]        	add	ax, [next_val_l]
  5862 0000266B 66D1D8                  	rcr	ax, 1
  5863 0000266E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5864 00002671 66AB                    	stosw 		; interpolated sample 4 (L)
  5865 00002673 89D8                    	mov	eax, ebx
  5866 00002675 660305[42270000]        	add	ax, [next_val_r]
  5867 0000267C 66D1D8                  	rcr	ax, 1
  5868 0000267F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5869 00002682 66AB                    	stosw 		; interpolated sample 4 (R)
  5870 00002684 59                      	pop	ecx ; !
  5871 00002685 C3                      	retn
  5872                                  
  5873                                  interpolating_4_16bit_mono:
  5874                                  	; 18/11/2023
  5875                                  	; ax = [previous_val]
  5876                                  	; dx = [next_val]
  5877                                  	; original-interpolated
  5878                                  
  5879 00002686 66AB                    	stosw		; original sample (L)
  5880 00002688 66AB                    	stosw		; original sample (R)
  5881 0000268A 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5882 0000268D 89C3                    	mov	ebx, eax ; [previous_val]
  5883 0000268F 80C680                  	add	dh, 80h
  5884 00002692 6601D0                  	add	ax, dx	; [previous_val] + [next_val]
  5885 00002695 66D1D8                  	rcr	ax, 1
  5886 00002698 93                      	xchg	eax, ebx
  5887 00002699 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  5888 0000269C 66D1D8                  	rcr	ax, 1
  5889 0000269F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5890 000026A2 66AB                    	stosw 		; interpolated sample 1 (L)
  5891 000026A4 66AB                    	stosw		; interpolated sample 1 (R)
  5892 000026A6 89D8                    	mov	eax, ebx ; interpolated middle
  5893 000026A8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5894 000026AB 66AB                    	stosw 		; interpolated sample 2 (L)
  5895 000026AD 66AB                    	stosw		; interpolated sample 2 (R)
  5896 000026AF 89D8                    	mov	eax, ebx
  5897 000026B1 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  5898 000026B4 66D1D8                  	rcr	ax, 1
  5899 000026B7 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5900 000026BA 66AB                    	stosw		; interpolated sample 3 (L)
  5901 000026BC 66AB                    	stosw		; interpolated sample 3 (R)
  5902 000026BE C3                      	retn
  5903                                  
  5904                                  interpolating_4_16bit_stereo:
  5905                                  	; 18/11/2023
  5906                                  	; bx = [previous_val_l]
  5907                                  	; ax = [previous_val_r]
  5908                                  	; [next_val_l]
  5909                                  	; [next_val_r]
  5910                                  	; original-interpolated-interpolated-interpolated
  5911 000026BF 93                      	xchg	eax, ebx
  5912 000026C0 66AB                    	stosw		; original sample (L)
  5913 000026C2 93                      	xchg	eax, ebx
  5914 000026C3 66AB                    	stosw		; original sample (R)
  5915 000026C5 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  5916 000026C8 89C2                    	mov	edx, eax ; [previous_val_r]
  5917 000026CA 80C780                  	add	bh, 80h
  5918 000026CD 8005[41270000]80        	add	byte [next_val_l+1], 80h
  5919 000026D4 66A1[40270000]          	mov	ax, [next_val_l]
  5920 000026DA 6601D8                  	add	ax, bx	; [previous_val_l]
  5921 000026DD 66D1D8                  	rcr	ax, 1
  5922 000026E0 93                      	xchg	eax, ebx
  5923 000026E1 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  5924 000026E4 66D1D8                  	rcr	ax, 1
  5925 000026E7 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5926 000026EA 66AB                    	stosw 		; interpolated sample 1 (L)
  5927 000026EC 8005[43270000]80        	add	byte [next_val_r+1], 80h
  5928 000026F3 89D0                    	mov	eax, edx ; [previous_val_r]
  5929 000026F5 660305[42270000]        	add	ax, [next_val_r]
  5930 000026FC 66D1D8                  	rcr	ax, 1
  5931 000026FF 92                      	xchg	eax, edx
  5932 00002700 6601D0                  	add	ax, dx	; dx = interpolated middle (R)
  5933 00002703 66D1D8                  	rcr	ax, 1
  5934 00002706 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5935 00002709 66AB                    	stosw 		; interpolated sample 1 (R)
  5936 0000270B 89D8                    	mov	eax, ebx
  5937 0000270D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5938 00002710 66AB                    	stosw 		; interpolated sample 2 (L)
  5939 00002712 89D0                    	mov	eax, edx
  5940 00002714 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5941 00002717 66AB                    	stosw 		; interpolated sample 2 (R)
  5942 00002719 89D8                    	mov	eax, ebx
  5943 0000271B 660305[40270000]        	add	ax, [next_val_l]
  5944 00002722 66D1D8                  	rcr	ax, 1
  5945 00002725 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5946 00002728 66AB                    	stosw 		; interpolated sample 3 (L)
  5947 0000272A 89D0                    	mov	eax, edx
  5948 0000272C 660305[42270000]        	add	ax, [next_val_r]
  5949 00002733 66D1D8                  	rcr	ax, 1
  5950 00002736 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  5951 00002739 66AB                    	stosw 		; interpolated sample 3 (R)
  5952 0000273B C3                      	retn
  5953                                  
  5954                                  ; 13/11/2023
  5955                                  previous_val:
  5956 0000273C 0000                    previous_val_l: dw 0
  5957 0000273E 0000                    previous_val_r: dw 0
  5958                                  next_val:
  5959 00002740 0000                    next_val_l: dw 0
  5960 00002742 0000                    next_val_r: dw 0
  5961                                  
  5962                                  ; 16/11/2023
  5963 00002744 00                      faz:	db 0
  5964                                  
  5965                                  ; --------------------------------------------------------
  5966                                  ; 14/11/2024 - Erdogan Tan
  5967                                  ; --------------------------------------------------------
  5968                                  
  5969                                  	; 07/12/2024
  5970                                  	; 01/12/2024 (32bit registers)
  5971                                  	; 29/11/2024
  5972                                  checkUpdateEvents:
  5973 00002745 E8B9010000              	call	check4keyboardstop
  5974 0000274A 7272                    	jc	short c4ue_ok
  5975                                  
  5976                                  	; 18/11/2024
  5977 0000274C 50                      	push	eax ; *
  5978 0000274D 09C0                    	or	eax, eax
  5979 0000274F 0F84D1000000            	jz	c4ue_cpt
  5980                                  
  5981                                  	; 18/11/2024
  5982 00002755 3C20                    	cmp	al, 20h ; SPACE (spacebar) ; pause/play
  5983 00002757 7543                    	jne	short c4ue_chk_s
  5984 00002759 803D[FC370000]00        	cmp	byte [stopped], 0
  5985 00002760 7714                    	ja	short c4ue_chk_ps
  5986                                  	; pause
  5987 00002762 E805E5FFFF              	call	ac97_pause
  5988                                  	; 21/11/2024
  5989 00002767 A0[FD370000]            	mov	al, [tLO]
  5990 0000276C A2[FE370000]            	mov	byte [tLP], al
  5991 00002771 E9B0000000              	jmp	c4ue_cpt
  5992                                  c4ue_chk_ps:
  5993 00002776 803D[FC370000]01        	cmp	byte [stopped], 1
  5994 0000277D 770A                    	ja	short c4ue_replay
  5995                                  	; continue to play (after a pause)
  5996 0000277F E8F1E4FFFF              	call	ac97_play 
  5997 00002784 E99D000000              	jmp	c4ue_cpt
  5998                                  c4ue_replay:
  5999                                  	; 19/11/2024
  6000 00002789 58                      	pop	eax ; *
  6001 0000278A 58                      	pop	eax ; return address
  6002                                  	; 07/02/2024
  6003                                  	;mov	al, [volume]
  6004                                  	;call	SetmasterVolume
  6005 0000278B C605[FC370000]00        	mov	byte [stopped], 0
  6006 00002792 E87C040000              	call	move_to_beginning
  6007                                  	;jmp	PlayWav
  6008                                  	; 07/12/2024
  6009 00002797 E94CDEFFFF              	jmp	RePlayWav
  6010                                  
  6011                                  c4ue_chk_s:
  6012 0000279C 3C53                    	cmp	al, 'S'	; stop
  6013 0000279E 751F                    	jne	short c4ue_chk_fb
  6014 000027A0 803D[FC370000]00        	cmp	byte [stopped], 0
  6015 000027A7 777D                    	ja	c4ue_cpt ; Already stopped/paused
  6016 000027A9 E8A5E4FFFF              	call	ac97_stop
  6017                                  	; 19/11/2024
  6018 000027AE C605[FD370000]00        	mov	byte [tLO], 0
  6019                                  	; 21/11/2024
  6020 000027B5 C605[FE370000]30        	mov	byte [tLP], '0'
  6021 000027BC EB68                    	jmp	c4ue_cpt
  6022                                  
  6023                                  	; 01/12/2024
  6024                                  	; 18/11/2024
  6025                                  c4ue_ok:
  6026 000027BE C3                      	retn
  6027                                  
  6028                                  c4ue_chk_fb:
  6029                                  	; 17/11/2024
  6030 000027BF 3C46                    	cmp	al, 'F'
  6031 000027C1 7507                    	jne	short c4ue_chk_b
  6032 000027C3 E823040000              	call 	Player_ProcessKey_Forwards
  6033 000027C8 EB5C                    	jmp	c4ue_cpt
  6034                                  
  6035                                  c4ue_chk_b:
  6036 000027CA 3C42                    	cmp	al, 'B'
  6037                                  	;;jne	short c4ue_cpt
  6038                                  	; 19/11/2024
  6039                                  	;jne	short c4ue_chk_h
  6040                                  	; 25/12/2024
  6041                                  	; 29/11/2024
  6042 000027CC 7507                    	jne	short c4ue_chk_n
  6043 000027CE E814040000              	call 	Player_ProcessKey_Backwards
  6044 000027D3 EB51                    	jmp	short c4ue_cpt
  6045                                  
  6046                                  	;;;
  6047                                  	; 25/12/2024
  6048                                  	; 29/11/2024
  6049                                  c4ue_chk_n:
  6050 000027D5 3C4E                    	cmp	al, 'N'
  6051 000027D7 7404                    	je	short c4ue_nps
  6052                                  c4ue_chk_p:
  6053 000027D9 3C50                    	cmp	al, 'P'
  6054 000027DB 7509                    	jne	short c4ue_chk_h
  6055                                  c4ue_nps:
  6056 000027DD C605[FC370000]03        	mov	byte [stopped], 3
  6057 000027E4 EB40                    	jmp	short c4ue_cpt
  6058                                  	;;;
  6059                                  
  6060                                  c4ue_chk_h:
  6061                                  	; 19/11/2024
  6062 000027E6 3C48                    	cmp	al, 'H'
  6063 000027E8 750E                    	jne	short c4ue_chk_cr
  6064 000027EA C605[FF370000]00        	mov	byte [wpoints], 0
  6065 000027F1 E80DE6FFFF              	call 	write_ac97_pci_dev_info
  6066                                  	; 30/12/2024
  6067 000027F6 EB2E                    	jmp	short c4ue_cpt
  6068                                  c4ue_chk_cr:
  6069                                  	;;;
  6070                                  	; 24/12/2024 (wave lighting points option)
  6071                                  	;mov	ah, [wpoints]
  6072                                  	; 30/12/2024
  6073 000027F8 31DB                    	xor	ebx, ebx
  6074 000027FA 8A1D[FF370000]          	mov	bl, [wpoints]
  6075 00002800 3C47                    	cmp	al, 'G'
  6076 00002802 7406                    	je	short c4ue_g
  6077                                  	; 19/11/2024
  6078 00002804 3C0D                    	cmp	al, 0Dh ; ENTER/CR key
  6079 00002806 751E                    	jne	short c4ue_cpt
  6080                                  	; 23/11/2024
  6081                                  	;xor	ebx, ebx
  6082                                  	; 30/12/2024
  6083                                  	;mov	bl, ah ; 24/12/2024
  6084 00002808 FEC3                    	inc	bl
  6085                                  c4ue_g:	; 30/12/2024
  6086 0000280A 80E307                  	and	bl, 07h
  6087 0000280D 7501                    	jnz	short c4ue_sc
  6088 0000280F 43                      	inc	ebx
  6089                                  c4ue_sc:
  6090 00002810 881D[FF370000]          	mov	[wpoints], bl
  6091                                  	; 30/12/2024
  6092 00002816 8A83[D9320000]          	mov	al, [ebx+colors-1] ; 1 to 7
  6093                                  	; 24/12/2024
  6094 0000281C A2[E1320000]            	mov	[ccolor], al
  6095                                  	; 30/12/2024
  6096 00002821 E81C040000              	call	clear_window
  6097                                  	;;;
  6098                                  c4ue_cpt:
  6099                                  	; 24/12/2024
  6100                                  	; 18/11/2024
  6101 00002826 59                      	pop	ecx ; *
  6102                                  	;;;
  6103                                  	; 29/12/2024
  6104                                  	; 24/12/2024 (skip wave lighting if data is not loaded yet)
  6105                                  	;cmp	byte [SRB], 0
  6106                                  	;ja	short c4ue_vb_ok
  6107                                  	;;;
  6108                                  	; 01/12/2024 (TRDOS 386)
  6109                                  	sys	_time, 4 ; get timer ticks (18.2 ticks/second),
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00002827 BB04000000          <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97                              <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 0000282C B80D000000          <1>  mov eax, %1
   104                              <1> 
   105 00002831 CD40                <1>  int 40h
  6110                                  	; 24/12/2024
  6111                                  	; 18/11/2024
  6112                                  	;pop	ecx ; *
  6113                                  	; 01/12/2024
  6114 00002833 3B05[C8380000]          	cmp	eax, [timerticks]
  6115                                  	;je	short c4ue_ok
  6116                                  	; 18/11/2024
  6117 00002839 7408                    	je	short c4ue_skip_utt
  6118                                  c4ue_utt:	
  6119                                  	; 01/12/2024
  6120 0000283B A3[C8380000]            	mov	[timerticks], eax
  6121 00002840 EB05                    	jmp	short c4ue_cpt_@
  6122                                  
  6123                                  	; 30/12/2024
  6124                                  c4ue_vb_ok:
  6125 00002842 C3                      	retn
  6126                                  
  6127                                  c4ue_skip_utt:
  6128                                  	; 18/11/2024
  6129 00002843 21C9                    	and	ecx, ecx
  6130 00002845 74FB                    	jz	short c4ue_vb_ok
  6131                                  c4ue_cpt_@:
  6132                                  	; 18/11/2024
  6133 00002847 803D[FC370000]00        	cmp	byte [stopped], 0
  6134 0000284E 77F2                    	ja	short c4ue_vb_ok
  6135                                  	
  6136 00002850 E8E0010000              	call	CalcProgressTime
  6137                                  
  6138                                  	;cmp	ax, [ProgressTime]
  6139                                  	; 01/12/2024
  6140 00002855 3B05[BC380000]          	cmp	eax, [ProgressTime]
  6141                                  	;je	short c4ue_vb_ok
  6142                                  			; same second, no need to update
  6143                                  	; 23/11/2024
  6144 0000285B 7405                    	je	short c4ue_uvb
  6145                                  
  6146                                  	;call	UpdateProgressTime
  6147                                  	;call	UpdateProgressBar@
  6148 0000285D E8F9020000              	call	UpdateProgressBar
  6149                                  
  6150                                  	; 23/11/2024
  6151                                  c4ue_uvb:
  6152 00002862 803D[FF370000]00        	cmp	byte [wpoints], 0
  6153 00002869 76D7                    	jna	short c4ue_vb_ok
  6154                                  
  6155                                  	; 30/12/2024
  6156                                  	;call	UpdateWavePoints
  6157                                  	;retn
  6158                                  
  6159                                  ; --------------------------------------------------------
  6160                                  ; 27/12/2024 - Erdogan Tan
  6161                                  ; --------------------------------------------------------
  6162                                  
  6163                                  	; 30/12/2024 (cgaplay.s)
  6164                                  	;  * 320*200 pixels, 256 colors
  6165                                  	;  * 64 volume levels
  6166                                  	; 29/12/2024
  6167                                  	; 27/12/2024 (DMA Buffer Tracking)
  6168                                  	; 26/12/2024
  6169                                  	; 24/12/2024
  6170                                  UpdateWavePoints:
  6171 0000286B BE[FC320000]            	mov	esi, prev_points
  6172 00002870 833E00                  	cmp	dword [esi], 0
  6173 00002873 740B                    	jz	short lights_off_ok
  6174                                  	;mov	ecx, 640
  6175                                  	; 30/12/2024
  6176 00002875 B940010000              	mov	ecx, 320
  6177                                  light_off:
  6178 0000287A AD                      	lodsd
  6179                                  	; eax = wave point (lighting point) address
  6180 0000287B C60000                  	mov	byte [eax], 0 ; black point (light off)
  6181 0000287E E2FA                    	loop	light_off	
  6182                                  
  6183                                  lights_off_ok:
  6184                                  	; 29/12/2024
  6185 00002880 803D[FD370000]32        	cmp	byte [tLO],'2'
  6186 00002887 7507                    	jne	short lights_on_buff_1
  6187                                  lights_on_buff_2:
  6188 00002889 BA[00500100]            	mov	edx, WAVBUFFER_2
  6189 0000288E EB05                    	jmp	short lights_on
  6190                                  lights_on_buff_1:
  6191 00002890 BA[00500000]            	mov	edx, WAVBUFFER_1
  6192                                  lights_on:
  6193 00002895 3915[04380000]          	cmp	[pbuf_s], edx
  6194 0000289B 7520                    	jne	short lights_on_2
  6195 0000289D 8B1D[E4320000]          	mov	ebx, [wpoints_dif]
  6196 000028A3 8B35[00380000]          	mov	esi, [pbuf_o]
  6197 000028A9 8B0D[B4380000]          	mov	ecx, [buffersize] ; bytes
  6198 000028AF 29D9                    	sub	ecx, ebx ; sub ecx, [wpoints_dif]
  6199 000028B1 01DE                    	add	esi, ebx
  6200 000028B3 7204                    	jc	short lights_on_1
  6201 000028B5 39CE                    	cmp	esi, ecx
  6202 000028B7 760C                    	jna	short lights_on_3
  6203                                  lights_on_1:
  6204 000028B9 89CE                    	mov	esi, ecx
  6205 000028BB EB08                    	jmp	short lights_on_3
  6206                                  
  6207                                  lights_on_2:
  6208                                  	; 29/12/2024
  6209 000028BD 8915[04380000]          	mov	[pbuf_s], edx
  6210 000028C3 31F6                    	xor	esi, esi ; 0
  6211                                  lights_on_3:
  6212 000028C5 8935[00380000]          	mov	[pbuf_o], esi
  6213                                  	; 29/12/2024
  6214                                  	;add	esi, [pbuf_s]
  6215 000028CB 01D6                    	add	esi, edx
  6216                                  	;mov	ecx, 640
  6217                                  	; 30/12/2024
  6218 000028CD B940010000              	mov	ecx, 320
  6219 000028D2 89CD                    	mov	ebp, ecx
  6220                                  	; 26/12/2024
  6221 000028D4 BF[FC320000]            	mov	edi, prev_points
  6222 000028D9 8B1D[E8320000]          	mov	ebx, [graphstart] ; start (top) line
  6223                                  lights_on_4:
  6224 000028DF 31C0                    	xor	eax, eax ; 0
  6225 000028E1 66AD                    	lodsw	; left
  6226 000028E3 80C480                  	add	ah, 80h
  6227 000028E6 89C2                    	mov	edx, eax
  6228 000028E8 66AD                    	lodsw	; right
  6229                                  	;add	ax, dx
  6230 000028EA 80C480                  	add	ah, 80h
  6231                                  	;;shr	eax, 9	; 128 volume levels
  6232                                  	; 01/01/2025
  6233 000028ED 01D0                    	add	eax, edx
  6234                                  	;;shr	eax, 10	; (L+R/2) & 128 volume levels
  6235                                  	;shr	eax, 9	; (L+R/2) & 256 volume levels
  6236                                  	; 30/12/2024
  6237 000028EF C1E80B                  	shr	eax, 11	; (L+R/2) & 64 volume levels
  6238                                  	; * 320 row  ; 30/12/2024
  6239 000028F2 F7E5                    	mul	ebp	; * 640 (row) 
  6240 000028F4 01D8                    	add	eax, ebx ; + column
  6241 000028F6 8A15[E1320000]          	mov	dl, [ccolor]
  6242 000028FC 8810                    	mov	[eax], dl ; pixel (light on) color
  6243 000028FE AB                      	stosd		; save light on addr in prev_points
  6244 000028FF 43                      	inc	ebx
  6245 00002900 E2DD                    	loop	lights_on_4
  6246 00002902 C3                      	retn
  6247                                  
  6248                                  ; --------------------------------------------------------
  6249                                  ; 19/05/2024 - (playwav4.asm) ich_wav4.asm
  6250                                  ; --------------------------------------------------------
  6251                                  
  6252                                  	; 29/12/2024
  6253                                  	; 25/12/2024
  6254                                  	; 07/12/2024
  6255                                  	; 01/12/2024 (TRDOS 386)
  6256                                  	; 29/11/2024
  6257                                  check4keyboardstop:
  6258                                  	; 19/05/2024
  6259                                  	; 08/11/2023
  6260                                  	; 04/11/2023
  6261 00002903 B401                    	mov	ah, 1
  6262                                  	;int	16h
  6263                                  	; 01/12/2024 (TRDOS 386 keyboard interrupt)
  6264 00002905 CD32                    	int	32h
  6265                                  	;clc
  6266 00002907 7433                    	jz	short _cksr
  6267                                  
  6268 00002909 30E4                    	xor	ah, ah
  6269                                  	;int	16h
  6270                                  	; 01/12/2024 (TRDOS 386 keyboard interrupt)
  6271 0000290B CD32                    	int	32h
  6272                                  
  6273                                  	; 25/12/2024
  6274                                  	; 29/11/2024
  6275                                  	;mov	[command], al
  6276                                  
  6277                                  	;;;
  6278                                  	; 19/05/2024 (change PCM out volume)
  6279 0000290D 3C2B                    	cmp	al, '+'
  6280 0000290F 750D                    	jne	short p_1
  6281                                  	
  6282 00002911 A0[66290000]            	mov	al, [volume]
  6283 00002916 3C00                    	cmp	al, 0
  6284 00002918 7624                    	jna	short p_3
  6285 0000291A FEC8                    	dec	al
  6286 0000291C EB0F                    	jmp	short p_2
  6287                                  p_1:
  6288 0000291E 3C2D                    	cmp	al, '-'
  6289 00002920 751D                    	jne	short p_4
  6290                                  
  6291 00002922 A0[66290000]            	mov	al, [volume]
  6292 00002927 3C1F                    	cmp	al, 31
  6293 00002929 7313                    	jnb	short p_3
  6294 0000292B FEC0                    	inc	al
  6295                                  p_2:
  6296 0000292D A2[66290000]            	mov	[volume], al
  6297                                  	; 29/12/2024
  6298                                  	; 14/11/2024
  6299 00002932 E865DEFFFF              	call	SetPCMOutVolume
  6300                                  	; 15/11/2024 (QEMU)
  6301                                  	; 07/12/2024
  6302                                  	;call	SetMasterVolume
  6303                                  	;call	UpdateVolume
  6304                                  	;;clc
  6305                                  	;retn
  6306 00002937 E99A010000              	jmp	UpdateVolume
  6307                                  	;mov	ah, al
  6308                                  	;mov    dx, [NAMBAR]
  6309                                    	;;add   dx, CODEC_MASTER_VOL_REG
  6310                                  	;add	dx, CODEC_PCM_OUT_REG
  6311                                  	;out    dx, ax
  6312                                  	;
  6313                                  	;call   delay1_4ms
  6314                                          ;call   delay1_4ms
  6315                                          ;call   delay1_4ms
  6316                                          ;call   delay1_4ms
  6317                                  _cksr:		; 19/05/2024
  6318                                  	; 18/12/2024
  6319 0000293C 31C0                    	xor	eax, eax
  6320                                  	;clc
  6321                                  p_3:
  6322 0000293E C3                      	retn
  6323                                  p_4:
  6324                                  	; 17/11/2024
  6325 0000293F 80FC01                  	cmp	ah, 01h  ; ESC
  6326 00002942 7419                        	je	short p_q
  6327                                  	;cmp	ax, 2E03h ; 21/12/2024 
  6328 00002944 3C03                    	cmp	al, 03h  ; CTRL+C
  6329 00002946 7415                    	je	short p_q
  6330                                  
  6331                                  	; 18/11/2024
  6332 00002948 3C20                    	cmp	al, 20h
  6333 0000294A 7419                    	je	short p_r
  6334                                  
  6335                                  	; 19/11/2024
  6336 0000294C 3C0D                    	cmp	al, 0Dh ; CR/ENTER
  6337 0000294E 7415                    	je	short p_r
  6338                                  
  6339 00002950 24DF                    	and	al, 0DFh
  6340                                  
  6341                                  	; 25/12/2024
  6342                                  	; 29/11/2024
  6343 00002952 A2[0A380000]            	mov	[command], al
  6344                                  
  6345                                  	;cmp	al, 'B'
  6346                                  	;je	short p_r
  6347                                  	;cmp	al, 'F'
  6348                                  	;je	short p_r
  6349                                  
  6350                                  	; 29/11/2024
  6351                                  	;cmp	al, 'N'
  6352                                  	;je	short p_r
  6353                                  	;cmp	al, 'P'
  6354                                  	;je	short p_r
  6355                                  
  6356 00002957 3C51                    	cmp	al, 'Q'
  6357                                  	;je	short p_q
  6358 00002959 7409                    	je	short p_quit ; 29/11/2024
  6359                                  
  6360 0000295B F8                      	clc
  6361 0000295C C3                      	retn
  6362                                  
  6363                                  	;;;
  6364                                  ;_cskr:	
  6365                                  p_q:
  6366                                  	; 27/12/2024
  6367 0000295D C605[0A380000]51        	mov	byte [command], 'Q'
  6368                                  p_quit:
  6369 00002964 F9                      	stc
  6370                                  p_r:
  6371 00002965 C3                      	retn
  6372                                  
  6373                                  ; 29/05/2024
  6374                                  ; 19/05/2024
  6375                                  volume: 
  6376                                  	;db	02h
  6377                                  ; 26/12/2024
  6378 00002966 03                      	db	03h
  6379                                  
  6380                                  ; --------------------------------------------------------
  6381                                  
  6382                                  	; 30/12/2024
  6383                                  	; simulate cursor position in VGA mode 13h
  6384                                  	; ! for 320*200, 256 colors (1 byte/pixel) !
  6385                                  setCursorPosition:
  6386                                  	; dh = Row
  6387                                  	; dl = Column
  6388                                  	
  6389 00002967 31C0                    	xor	eax, eax
  6390                                  	; row height is 8 pixels (8*8)
  6391 00002969 88F0                    	mov	al, dh
  6392 0000296B C1E003                  	shl	eax, 3
  6393 0000296E 6683C002                	add	ax, 2	; top margin
  6394 00002972 C1E010                  	shl	eax, 16
  6395 00002975 88D0                    	mov	al, dl	; * 8 ; character width = 8 pixels
  6396 00002977 66C1E003                	shl	ax, 3
  6397                                  			; hw = row, ax = column
  6398 0000297B A3[EC320000]            	mov	[screenpos], eax
  6399                                  	; 22/12/2024
  6400 00002980 31C0                    	xor	eax, eax
  6401 00002982 C3                      	retn
  6402                                  	
  6403                                  ; --------------------------------------------------------
  6404                                  ; 14/11/2024
  6405                                  ; (Ref: player.asm, out_cs.asm, Matan Alfasi, 2017)
  6406                                  
  6407                                  ;; NAME:	SetTotalTime
  6408                                  ;; DESCRIPTION: Calculates the total time in seconds in file
  6409                                  ;; INPUT:	DATA_SubchunkSize, WAVE_SampleRate, WAVE_BlockAlign
  6410                                  ;; OUTPUT:	CurrentTotalTime=Total time in seconds in file,
  6411                                  ;; 		Output on the screen of the total time in seconds
  6412                                  
  6413                                  	; 01/12/2024 (32 bit registers)
  6414                                  SetTotalTime:
  6415                                  	;; Calculate total seconds in file
  6416                                  	;mov	ax, [DATA_SubchunkSize]
  6417                                  	;mov	dx, [DATA_SubchunkSize + 2]
  6418                                  	;mov	bx, [WAVE_SampleRate]
  6419                                  	;div	bx
  6420                                  	;xor	dx, dx
  6421                                  	; 01/12/2024
  6422 00002983 A1[34380000]            	mov	eax, [DATA_SubchunkSize]
  6423 00002988 0FB71D[24380000]        	movzx	ebx, word [WAVE_SampleRate]
  6424 0000298F 31D2                    	xor	edx, edx
  6425 00002991 F7F3                    	div	ebx
  6426                                  
  6427                                  	;mov	bx, [WAVE_BlockAlign]
  6428                                  	;div	bx
  6429                                  	; 01/12/2024
  6430 00002993 668B1D[2C380000]        	mov	bx, [WAVE_BlockAlign]
  6431 0000299A 31D2                    	xor	edx, edx
  6432 0000299C F7F3                    	div	ebx
  6433                                  
  6434                                  	;mov	[TotalTime], ax
  6435 0000299E A3[B8380000]            	mov	[TotalTime], eax
  6436                                  
  6437 000029A3 B33C                    	mov	bl, 60
  6438 000029A5 F6F3                    	div	bl
  6439                                  
  6440                                  	;; al = minutes, ah = seconds
  6441 000029A7 50                      	push	eax ; **
  6442 000029A8 50                      	push	eax ; *
  6443                                  
  6444                                  	;mov	dh, 24
  6445                                  	; 21/12/2024 (640*480)
  6446                                  	;mov	dh, 32
  6447                                  	;mov	dl, 42
  6448                                  	; 30/12/2024 (320*200)
  6449 000029A9 B617                    	mov	dh, 23
  6450 000029AB B216                    	mov	dl, 22
  6451 000029AD E8B5FFFFFF              	call	setCursorPosition
  6452                                  
  6453 000029B2 58                      	pop	eax ; *
  6454 000029B3 30E4                    	xor	ah, ah
  6455 000029B5 BD02000000              	mov	ebp, 2
  6456 000029BA E812000000              	call	PrintNumber
  6457                                  	
  6458                                  	;mov	dh, 24
  6459                                  	; 21/12/2024 (640*480)
  6460                                  	;mov	dh, 32
  6461                                  	;mov	dl, 45
  6462                                  	; 30/12/2024 (320*200)
  6463 000029BF B617                    	mov	dh, 23
  6464 000029C1 B219                    	mov	dl, 25
  6465 000029C3 E89FFFFFFF              	call	setCursorPosition
  6466                                  
  6467 000029C8 58                      	pop	eax ; **
  6468 000029C9 88E0                    	mov	al, ah
  6469 000029CB 30E4                    	xor	ah, ah
  6470                                  	; 21/12/2024
  6471 000029CD 66BD0200                	mov	bp, 2
  6472                                  	;jmp	short PrintNumber
  6473                                  
  6474                                  ; --------------------------------------------------------
  6475                                  
  6476                                  	; 21/12/2024 (write numbers in VESA VBE graphics mode)
  6477                                  	; 01/12/2024 (32bit registers)
  6478                                  PrintNumber:
  6479                                  	; eax = binary number
  6480                                  	; ebp = digits
  6481 000029D1 8B35[EC320000]          	mov	esi, [screenpos]
  6482                                  		; hw = row, si = column
  6483 000029D7 BB0A000000              	mov	ebx, 10
  6484 000029DC 31C9                    	xor	ecx, ecx
  6485                                  printNumber_CutNumber:
  6486 000029DE 41                      	inc	ecx
  6487 000029DF 31D2                    	xor	edx, edx
  6488 000029E1 F7F3                    	div	ebx
  6489 000029E3 52                      	push	edx
  6490 000029E4 39E9                    	cmp	ecx, ebp
  6491 000029E6 7402                    	je	short printNumber_printloop
  6492 000029E8 EBF4                    	jmp	printNumber_CutNumber
  6493                                  
  6494                                  printNumber_printloop:
  6495 000029EA 58                      	pop	eax
  6496                                  	; 21/12/2024
  6497                                  	; ebp = count of digits
  6498                                  	; eax <= 9
  6499                                  
  6500 000029EB 0430                    	add	al, '0'
  6501                                  	
  6502                                  	; esi = pixel position (hw = row, si = column)
  6503                                  	; eax = al = character
  6504                                  	;call	write_character
  6505                                  	; 22/12/2024
  6506 000029ED E82A010000              	call	write_character_white
  6507                                  
  6508 000029F2 4D                      	dec	ebp
  6509 000029F3 7405                     	jz	short printNumber_ok
  6510 000029F5 83C608                  	add	esi, 8	; next column
  6511 000029F8 EBF0                    	jmp	short printNumber_printloop
  6512                                  printNumber_ok:
  6513 000029FA C3                      	retn
  6514                                  
  6515                                  ; --------------------------------------------------------
  6516                                  
  6517                                  	; 14/11/2024 - Erdogan Tan
  6518                                  SetProgressTime:
  6519                                  	;; Calculate playing/progress seconds in file
  6520 000029FB E835000000              	call	CalcProgressTime
  6521                                  
  6522                                  	; 01/12/2024 (32bit registers)
  6523                                  UpdateProgressTime:
  6524                                  	; eax = (new) progress time 
  6525                                  
  6526 00002A00 A3[BC380000]            	mov	[ProgressTime], eax
  6527                                  
  6528 00002A05 B33C                    	mov	bl, 60
  6529 00002A07 F6F3                    	div	bl
  6530                                  
  6531                                  	;; al = minutes, ah = seconds
  6532 00002A09 50                      	push	eax ; **
  6533 00002A0A 50                      	push	eax ; *
  6534                                  
  6535                                  	;mov	dh, 24
  6536                                  	; 21/12/2024 (640*480)
  6537                                  	;mov	dh, 32
  6538                                  	;mov	dl, 33
  6539                                  	; 30/12/2024 (320*200)
  6540 00002A0B B617                    	mov	dh, 23
  6541 00002A0D B20D                    	mov	dl, 13
  6542 00002A0F E853FFFFFF              	call	setCursorPosition
  6543                                  
  6544 00002A14 58                      	pop	eax ; *
  6545 00002A15 30E4                    	xor	ah, ah
  6546 00002A17 BD02000000              	mov	ebp, 2
  6547 00002A1C E8B0FFFFFF              	call	PrintNumber
  6548                                  	
  6549                                  	;mov	dh, 24
  6550                                  	; 21/12/2024 (640*480)
  6551                                  	;mov	dh, 32
  6552                                  	;mov	dl, 36
  6553                                  	; 30/12/2024 (320*200)
  6554 00002A21 B617                    	mov	dh, 23
  6555 00002A23 B210                    	mov	dl, 16
  6556 00002A25 E83DFFFFFF              	call	setCursorPosition
  6557                                  
  6558 00002A2A 58                      	pop	eax ; **
  6559 00002A2B 88E0                    	mov	al, ah
  6560 00002A2D 30E4                    	xor	ah, ah
  6561                                  	; 21/12/2024
  6562 00002A2F 66BD0200                	mov	bp, 2
  6563 00002A33 EB9C                    	jmp	short PrintNumber
  6564                                  
  6565                                  ; --------------------------------------------------------
  6566                                  
  6567                                  	; 01/12/2024 (32bit registers)
  6568                                  	; 17/11/2024
  6569                                  	; 14/11/2024
  6570                                  CalcProgressTime:
  6571                                  	;mov	ax, [LoadedDataBytes]
  6572                                  	;mov	dx, [LoadedDataBytes+2]
  6573                                  	;mov	bx, ax
  6574                                  	;or	bx, dx
  6575                                  	;jz	short cpt_ok
  6576                                  	; 01/12/2024
  6577 00002A35 A1[C4380000]            	mov	eax, [LoadedDataBytes]
  6578 00002A3A 09C0                    	or	eax, eax
  6579 00002A3C 7416                    	jz	short cpt_ok
  6580                                  
  6581                                  	;mov	bx, [WAVE_SampleRate]
  6582                                  	;div	bx
  6583                                  	;xor	dx, dx
  6584                                  	;mov	bx, [WAVE_BlockAlign]
  6585                                  	;div	bx
  6586                                  	; 01/12/2024
  6587 00002A3E 0FB71D[24380000]        	movzx	ebx, word [WAVE_SampleRate]
  6588 00002A45 31D2                    	xor	edx, edx
  6589 00002A47 F7F3                    	div	ebx
  6590 00002A49 31D2                    	xor	edx, edx
  6591 00002A4B 668B1D[2C380000]        	mov	bx, [WAVE_BlockAlign]
  6592 00002A52 F7F3                    	div	ebx
  6593                                  cpt_ok:
  6594                                  	; eax = (new) progress time
  6595 00002A54 C3                      	retn
  6596                                  
  6597                                  ; --------------------------------------------------------
  6598                                  ; 14/11/2024
  6599                                  ; (Ref: player.asm, out_cs.asm, Matan Alfasi, 2017)
  6600                                  
  6601                                  ;; DESCRIPTION: Update file information on template
  6602                                  ;; PARAMS:	WAVE parameters and other variables
  6603                                  ;; REGS:	AX(RW)
  6604                                  ;; VARS:	CurrentFileName, WAVE_SampleRate, 
  6605                                  ;; RETURNS:	On-screen file info is updated.
  6606                                  
  6607                                  	; 01/12/2024 (32bit registers)
  6608                                  UpdateFileInfo:
  6609                                  	;; Print File Name
  6610                                  	;mov	dh, 9
  6611                                  	; 21/12/2024 (640*480 graphics display)
  6612                                  	;mov	dh, 8
  6613                                  	;mov	dl, 23
  6614                                  	; 30/12/2024 (320*200, video mode 13h)
  6615 00002A55 B607                    	mov	dh, 7
  6616 00002A57 B208                    	mov	dl, 8
  6617 00002A59 E809FFFFFF              	call	setCursorPosition
  6618                                  	
  6619 00002A5E BE[4C380000]            	mov	esi, wav_file_name
  6620                                  	
  6621                                  	;;;
  6622                                  	; 14/11/2024
  6623                                  	; skip directory separators
  6624                                  	; (note: asciiz string, max. 79 bytes except zero tail)
  6625 00002A63 89F3                    	mov	ebx, esi
  6626                                  chk4_nxt_sep:
  6627 00002A65 AC                      	lodsb
  6628 00002A66 3C2F                    	cmp	al, '/'	; 14/12/2024
  6629 00002A68 7406                    	je	short chg_fpos
  6630 00002A6A 20C0                    	and	al, al
  6631 00002A6C 7406                    	jz	short chg_fpos_ok
  6632 00002A6E EBF5                    	jmp	short chk4_nxt_sep
  6633                                  chg_fpos:
  6634 00002A70 89F3                    	mov	ebx, esi
  6635 00002A72 EBF1                    	jmp	short chk4_nxt_sep
  6636                                  chg_fpos_ok:
  6637 00002A74 89DE                    	mov	esi, ebx ; file name (without its path/directory)
  6638                                  	;;;
  6639                                  _fnl_chk:
  6640                                  	; 30/12/2024 (cgaplay.s)
  6641                                  	; ????????.wav
  6642                                  	; 26/12/2024 (file name length limit -display-)
  6643 00002A76 BB0C000000              	mov	ebx, 12
  6644                                  	;mov	ebx, 17 ; ????????.wav?????
  6645 00002A7B 56                      	push	esi
  6646                                  _fnl_chk_loop:
  6647 00002A7C AC                      	lodsb
  6648 00002A7D 20C0                    	and	al, al
  6649 00002A7F 7406                    	jz	short _fnl_ok
  6650 00002A81 4B                       	dec	ebx
  6651 00002A82 75F8                    	jnz	short _fnl_chk_loop
  6652 00002A84 C60600                  	mov	byte [esi], 0
  6653                                  _fnl_ok:
  6654 00002A87 5E                      	pop	esi
  6655                                  	;;;
  6656                                  
  6657 00002A88 E870000000              	call	PrintString
  6658                                  	
  6659                                  	;; Print Frequency
  6660                                  	;mov	dh, 10
  6661                                  	; 21/12/2024 (640*480 graphics display)
  6662                                  	;mov	dh, 9
  6663                                  	;mov	dl, 23
  6664                                  	; 30/12/2024 (320*200, video mode 13h)
  6665 00002A8D B608                    	mov	dh, 8
  6666 00002A8F B208                    	mov	dl, 8
  6667 00002A91 E8D1FEFFFF              	call	setCursorPosition
  6668                                  	;movzx	eax, word [WAVE_SampleRate]
  6669                                  	; 22/12/2024
  6670                                  	; eax = 0
  6671 00002A96 66A1[24380000]          	mov	ax, [WAVE_SampleRate]
  6672 00002A9C BD05000000              	mov	ebp, 5
  6673 00002AA1 E82BFFFFFF              	call	PrintNumber
  6674                                  
  6675                                  	;; Print BitRate
  6676                                  	;mov	dh, 9
  6677                                  	; 21/12/2024 (640*480 graphics display)
  6678                                  	;mov	dh, 8
  6679                                  	;mov	dl, 57
  6680                                  	; 30/12/2024 (320*200, video mode 13h)
  6681 00002AA6 B607                    	mov	dh, 7
  6682 00002AA8 B21F                    	mov	dl, 31
  6683 00002AAA E8B8FEFFFF              	call	setCursorPosition
  6684 00002AAF 66A1[2E380000]          	mov	ax, [WAVE_BitsPerSample]
  6685 00002AB5 66BD0200                	mov	bp, 2
  6686 00002AB9 E813FFFFFF              	call	PrintNumber
  6687                                  
  6688                                  	;; Print Channel Number
  6689                                  	;mov	dh, 10
  6690                                  	; 21/12/2024 (640*480 graphics display)
  6691                                  	;mov	dh, 9
  6692                                  	;mov	dl, 57
  6693                                  	; 30/12/2024 (320*200, video mode 13h)
  6694 00002ABE B608                    	mov	dh, 8
  6695 00002AC0 B21F                    	mov	dl, 31
  6696 00002AC2 E8A0FEFFFF              	call	setCursorPosition
  6697 00002AC7 66A1[22380000]          	mov	ax, [WAVE_NumChannels]
  6698 00002ACD 66BD0100                	mov	bp, 1
  6699 00002AD1 E8FBFEFFFF              	call	PrintNumber
  6700                                  
  6701                                  	;call	UpdateVolume
  6702                                  	;retn
  6703                                  
  6704                                  ; --------------------------------------------------------
  6705                                  
  6706                                  	; 14/11/2024
  6707                                  UpdateVolume:
  6708                                  	;; Print Volume
  6709                                  	;mov	dh, 24
  6710                                  	; 21/12/2024 (640*480)
  6711                                  	;mov	dh, 32
  6712                                  	;mov	dl, 75
  6713                                  	; 30/12/2024 (320*200, video mode 13h)
  6714 00002AD6 B617                    	mov	dh, 23
  6715 00002AD8 B223                    	mov	dl, 35
  6716 00002ADA E888FEFFFF              	call	setCursorPosition
  6717                                  	; 22/12/2024
  6718                                  	; eax = 0
  6719                                  
  6720 00002ADF A0[66290000]            	mov	al, [volume]
  6721                                  
  6722 00002AE4 B364                    	mov	bl, 100
  6723 00002AE6 F6E3                    	mul	bl
  6724                                  
  6725 00002AE8 B31F                    	mov	bl, 31
  6726 00002AEA F6F3                    	div	bl
  6727                                  
  6728                                  	;neg	ax
  6729                                  	;add	ax, 100	
  6730                                  	; 01/12/2024
  6731 00002AEC B464                    	mov	ah, 100
  6732 00002AEE 28C4                    	sub	ah, al
  6733 00002AF0 0FB6C4                  	movzx	eax, ah
  6734                                  	;xor	ah, ah
  6735                                  	;mov	bp, 3
  6736 00002AF3 BD03000000              	mov	ebp, 3
  6737                                  	;call	PrintNumber
  6738                                  	;retn
  6739 00002AF8 E9D4FEFFFF              	jmp	PrintNumber	
  6740                                  
  6741                                  ; --------------------------------------------------------
  6742                                  
  6743                                  	; 21/12/2024
  6744                                  	; write text in VESA VBE graphics mode
  6745                                  PrintString:
  6746                                  	; esi = string address
  6747                                  printstr_loop:
  6748 00002AFD 31C0                    	xor	eax, eax
  6749 00002AFF AC                      	lodsb
  6750 00002B00 08C0                    	or	al, al
  6751 00002B02 7417                    	jz	short printstr_ok
  6752                                  
  6753 00002B04 56                      	push	esi
  6754                                  
  6755 00002B05 8B35[EC320000]          	mov	esi, [screenpos]
  6756                                  
  6757                                  	; esi = pixel position (hw = row, si = column)
  6758                                  	; eax = al = character
  6759                                  	;call	write_character
  6760                                  	; 22/12/2024
  6761 00002B0B E80C000000              	call	write_character_white
  6762                                  
  6763 00002B10 668305[EC320000]08      	add	word [screenpos], 8 ; update column (only, not row)
  6764                                  
  6765 00002B18 5E                      	pop	esi
  6766 00002B19 EBE2                    	jmp	short printstr_loop
  6767                                  
  6768                                  printstr_ok:
  6769 00002B1B C3                      	retn
  6770                                  
  6771                                  ; --------------------------------------------------------
  6772                                  
  6773                                  	; 30/12/2024
  6774                                  	; write character (at cursor position)
  6775                                  	; in video mode 13h (320*200, 256 colors)
  6776                                  	; 21/12/2024
  6777                                  	; write character (at cursor position)
  6778                                  	; in graphics mode (640*480, 256 colors)
  6779                                  	; 22/12/2024
  6780                                  write_character_white:
  6781 00002B1C B90F000000              	mov	ecx, 0Fh
  6782                                  	; 26/12/2024
  6783                                  	;movzx	ecx, byte [tcolor]
  6784                                  write_character:
  6785                                  	; esi = pixel position (hw = row, si = column)
  6786                                  	; eax = al = character
  6787                                  	; cl = color
  6788 00002B21 890D[F0320000]          	mov	[wcolor], ecx ; 22/12/2024
  6789                                  
  6790                                  	; 30/12/2024
  6791                                  	; 22/12/2024
  6792 00002B27 50                      	push	eax
  6793                                  	; clear previous character pixels
  6794 00002B28 BF[D0320000]            	mov	edi, fillblock
  6795                                  	;;sys	_video, 020Fh, 0, 8001h
  6796                                  	; 30/12/2024
  6797                                  	sys	_video, 010Fh, 0, 8000h ; 8*8 userfont
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00002B2D BB0F010000          <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00002B32 B900000000          <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00002B37 BA00800000          <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00002B3C B81F000000          <1>  mov eax, %1
   104                              <1> 
   105 00002B41 CD40                <1>  int 40h
  6798 00002B43 58                      	pop	eax
  6799                                  
  6800                                  	; 30/12/2024
  6801                                  	;shl	eax, 4 ; 8*16 pixel user font
  6802                                  	;mov	edi, fontbuff2 ; start of user font data
  6803                                  	;add	edi, eax
  6804                                  
  6805                                  	; 21/12/2024
  6806                                  	; NOTE:
  6807                                  	; TRDOS 386 does not use 8*14 pixel fonts in sysvideo
  6808                                  	; system calls -in graphics mode-
  6809                                  	; because 8*16 pixel operations are faster
  6810                                  	;			than 8*14 pixel operations.
  6811                                  	; ((so, 8*14 fonts can be converted to 8*16 fonts by
  6812                                  	; adding 2 empty lines))
  6813                                  	; (8*14 characters can be written via pixel operations)
  6814                                    	
  6815                                  	; 21/12/2024 (TRDOS 386 v2.0.9, trdosk6.s, 27/09/2024)
  6816                                  	;;;;;;;;;;;;;;;;; ; sysvideo system call
  6817                                  	;sysvideo:
  6818                                  	;   function in BH
  6819                                  	;	02h: Super VGA, LINEAR FRAME BUFFER data transfers
  6820                                  	;   sub function in BL
  6821                                  	;	0Fh: WRITE CHARACTER (FONT)
  6822                                  	;          CL = char's color (8 bit, 256 colors)
  6823                                  	;	If DH bit 7 = 1
  6824                                  	;	   USER FONT (from user buffer)
  6825                                  	;	         DL = 1 -> 8x16 pixel font
  6826                                   	;	   EDI = user's font buffer address
  6827                                  	;		(NOTE: byte order is as row0,row1,row2..)
  6828                                  	;	   ESI = start position (row, column)
  6829                                  	;		(HW = row, SI = column)
  6830                                  	;;;;;;;;;;;;;;;;;
  6831                                  
  6832                                  	;sys	_video, 020Fh, [wcolor], 8001h
  6833                                  
  6834                                  	; 30/12/2024
  6835                                  	; sysvideo system call
  6836                                  	; BH = 01h = VGA graphics (0A0000h) data transfers
  6837                                  	; BL = 0Fh = write character/font
  6838                                  	; DH = 01h = 8*8 system font 
  6839                                  	; CL = [wcolor] = color
  6840                                  	; ESI = cursor/writing position (pixels)
  6841                                  	;	HW = row, SI = column
  6842                                  	; DL = character (ASCII code)
  6843                                  
  6844 00002B44 B401                    	mov	ah, 01h ; 8*8 pixels
  6845                                  
  6846                                  	sys	_video, 010Fh, [wcolor], eax
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00002B46 BB0F010000          <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97 00002B4B 8B0D[F0320000]      <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99 00002B51 89C2                <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00002B53 B81F000000          <1>  mov eax, %1
   104                              <1> 
   105 00002B58 CD40                <1>  int 40h
  6847                                  
  6848 00002B5A C3                      	retn
  6849                                  
  6850                                  ; --------------------------------------------------------
  6851                                  
  6852                                  	; 30/12/2024
  6853                                  	; write characters in video mode 13h
  6854                                  	; (320*200 pixels, 256 colors)
  6855                                  	; 22/12/2024
  6856                                  	; 21/12/2024
  6857                                  	; (write chars in VESA VBE graphics mode)
  6858                                  	; 14/11/2024
  6859                                  	; (Ref: player.asm, Matan Alfasi, 2017)
  6860                                  	; (Modification: Erdogan Tan, 14/11/2024)
  6861                                  
  6862                                  	;PROGRESSBAR_ROW equ 23
  6863                                  	; 21/12/2024 (640*480)
  6864                                  	;PROGRESSBAR_ROW equ 31
  6865                                  	; 30/12/2024 (320*200)
  6866                                  	PROGRESSBAR_ROW equ 22
  6867                                  
  6868                                  UpdateProgressBar:
  6869 00002B5B E89BFEFFFF              	call	SetProgressTime	; 14/11/2024
  6870                                  
  6871                                  	; 01/12/2024 (32bit registers)
  6872 00002B60 A1[BC380000]            	mov	eax, [ProgressTime]
  6873                                  UpdateProgressBar@:
  6874                                  	;mov	edx, 80
  6875                                  	; 30/12/2024
  6876 00002B65 BA28000000              	mov	edx, 40 ; 320*200 pixels, 40 columns 
  6877 00002B6A F7E2                    	mul	edx
  6878 00002B6C 8B1D[B8380000]          	mov	ebx, [TotalTime]
  6879 00002B72 F7F3                    	div	ebx
  6880                                  
  6881                                  	; 22/12/2024
  6882                                  	; check progress bar indicator position if it is same 
  6883 00002B74 3A05[F5320000]          	cmp	al, [pbprev]
  6884 00002B7A 7430                    	je	short UpdateProgressBar_ok
  6885 00002B7C A2[F5320000]            	mov	[pbprev], al
  6886                                  
  6887                                  UpdateProgressBar@@:
  6888                                  	;; Push for the 'Clean' part
  6889 00002B81 50                      	push	eax ; **
  6890 00002B82 50                      	push	eax ; *
  6891                                  
  6892                                  	;; Set cursor position
  6893 00002B83 B616                    	mov	dh, PROGRESSBAR_ROW
  6894 00002B85 B200                    	mov	dl, 0
  6895 00002B87 E8DBFDFFFF              	call	setCursorPosition
  6896                                  
  6897 00002B8C 58                      	pop	eax ; *
  6898 00002B8D 09C0                    	or	eax, eax
  6899 00002B8F 742D                    	jz	short UpdateProgressBar_Clean
  6900                                  
  6901                                  UpdateProgressBar_DrawProgress:
  6902                                  	; 22/12/2024
  6903                                  	; 21/12/2024
  6904                                  	; (write progress bar chars in graphics mode)
  6905                                  	;;;;
  6906 00002B91 89C5                    	mov	ebp, eax
  6907 00002B93 50                      	push	eax ; ***
  6908 00002B94 8B35[EC320000]          	mov	esi, [screenpos]
  6909                                  UpdateProgressBar_DrawProgress_@:
  6910 00002B9A B8DF000000              	mov	eax, 223
  6911                                  	
  6912                                  	; esi = pixel position (hw = row, si = column)
  6913                                  	; eax = al = character
  6914                                  	;call	write_character
  6915                                  	; 22/12/2024
  6916 00002B9F E878FFFFFF              	call	write_character_white
  6917                                  
  6918 00002BA4 4D                      	dec	ebp
  6919 00002BA5 7406                    	jz	short UpdateProgressBar_DrawCursor
  6920                                  
  6921 00002BA7 83C608                  	add	esi, 8 ; next column
  6922 00002BAA EBEE                    	jmp	short UpdateProgressBar_DrawProgress_@
  6923                                  	;;;
  6924                                  
  6925                                  UpdateProgressBar_ok:
  6926 00002BAC C3                      	retn
  6927                                  
  6928                                  UpdateProgressBar_DrawCursor:
  6929                                  	; 22/12/2024
  6930 00002BAD 5A                      	pop	edx ; ***
  6931 00002BAE B616                    	mov	dh, PROGRESSBAR_ROW
  6932 00002BB0 E8B2FDFFFF              	call	setCursorPosition
  6933                                  
  6934                                  	; 21/12/2024
  6935                                  	; (write progress bar character in graphics mode)
  6936                                  	;;;;
  6937                                  	;;;mov	eax, 223
  6938                                  	;;;shl	eax, 4 ; 8*16 pixel user font
  6939                                  	;;mov	eax, 223*16
  6940                                  	;;mov	edi, fontbuff2 ; start of user font data
  6941                                  	;;add	edi, eax
  6942                                  	;mov	edi, fontbuff2+(223*16)
  6943                                  	;
  6944                                  	;sys	_video, 020Fh, 0Ch, 8001h
  6945                                  	; 22/12/2024
  6946                                  	;mov	eax, 223
  6947                                  	; eax = 0
  6948 00002BB5 B0DF                    	mov	al, 223
  6949 00002BB7 B10C                    	mov	cl, 0Ch ; red
  6950 00002BB9 E863FFFFFF              	call	write_character
  6951                                  	;;;;
  6952                                  
  6953                                  UpdateProgressBar_Clean:
  6954                                  	;pop	eax  ; **
  6955                                  	; 22/12/2024
  6956 00002BBE 5A                      	pop	edx  ; **
  6957                                  	; 30/12/2024
  6958                                  	; 21/12/2024
  6959                                  	;mov	ebp, 80
  6960                                  	; 30/12/2024
  6961 00002BBF BD28000000              	mov	ebp, 40 ; 40 columns (320*200 pixels)
  6962                                  	;sub	bp, ax
  6963 00002BC4 6629D5                  	sub	bp, dx ; 22/12/2024
  6964 00002BC7 74E3                    	jz	short UpdateProgressBar_ok
  6965                                  
  6966 00002BC9 B616                    	mov	dh, PROGRESSBAR_ROW
  6967                                  	;mov	dl, al ; 22/12/2024
  6968 00002BCB E897FDFFFF              	call	setCursorPosition
  6969                                  
  6970                                  	; 21/12/2024
  6971                                  	; (write progress bar chars in graphics mode)
  6972                                  	;;;;
  6973 00002BD0 8B35[EC320000]          	mov	esi, [screenpos]
  6974                                  UpdateProgressBar_Clean_@:
  6975                                  	;;;mov	eax, 223
  6976                                  	;;;shl	eax, 4 ; 8*16 pixel user font
  6977                                  	;;mov	eax, 223*16
  6978                                  	;mov	edi, fontbuff2 ; start of user font data
  6979                                  	;add	edi, eax
  6980                                  	;mov	edi, fontbuff2+(223*16)
  6981                                  	;
  6982                                  	;sys	_video, 020Fh, 08h, 8001h
  6983                                  	; 22/12/2024
  6984                                  	;mov	eax, 223
  6985                                  	; eax = 0
  6986 00002BD6 B0DF                    	mov	al, 223
  6987 00002BD8 B108                    	mov	cl, 08h ; gray (dark)
  6988 00002BDA E842FFFFFF              	call	write_character
  6989                                  	;;;;
  6990                                  
  6991 00002BDF 4D                      	dec	ebp
  6992 00002BE0 74CA                    	jz	short UpdateProgressBar_ok
  6993                                  
  6994 00002BE2 83C608                  	add	esi, 8 ; next column
  6995 00002BE5 EBEF                    	jmp	short UpdateProgressBar_Clean_@
  6996                                  	;;;;
  6997                                  
  6998                                  ; --------------------------------------------------------
  6999                                  ; 17/11/2024
  7000                                  
  7001                                  Player_ProcessKey_Backwards:
  7002                                  	;; In order to go backwards 5 seconds:
  7003                                  	;; Update file pointer to the beginning, skip headers
  7004 00002BE7 B142                    	mov	cl, 'B'
  7005 00002BE9 EB02                    	jmp	short Player_ProcessKey_B_or_F
  7006                                  
  7007                                  Player_ProcessKey_Forwards:
  7008                                  	;; In order to fast-forward 5 seconds, set the file pointer
  7009                                  	;; to CUR_SEEK + 5 * Freq
  7010                                  
  7011 00002BEB B146                    	mov	cl, 'F'
  7012                                  	;jmp	short Player_ProcessKey_B_or_F
  7013                                  
  7014                                  	; 01/12/2024 (32bit regsisters)
  7015                                  Player_ProcessKey_B_or_F:
  7016                                  	; 17/11/2024
  7017                                  	; 04/11/2024
  7018                                  	; (Ref: player.asm, Matan Alfasi, 2017)
  7019                                    
  7020                                  	; 04/11/2024
  7021 00002BED B805000000              	mov	eax, 5
  7022 00002BF2 0FB71D[2C380000]        	movzx	ebx, word [WAVE_BlockAlign]
  7023 00002BF9 F7E3                    	mul	ebx
  7024 00002BFB 668B1D[24380000]        	mov	bx, [WAVE_SampleRate]
  7025 00002C02 F7E3                    	mul	ebx
  7026                                  	; eax = transfer byte count for 5 seconds
  7027                                  	
  7028                                  	; 17/11/2024
  7029 00002C04 80F942                  	cmp	cl, 'B'
  7030                                  	;mov	bx, [LoadedDataBytes]
  7031                                  	;mov	cx, [LoadedDataBytes+2]
  7032                                  	; 01/12/2024
  7033 00002C07 8B0D[C4380000]          	mov	ecx, [LoadedDataBytes]
  7034 00002C0D 7508                    	jne	short move_forward ; cl = 'F'
  7035                                  move_backward:
  7036                                  	;sub	bx, ax
  7037                                  	;sbb	cx, dx
  7038 00002C0F 29C1                    	sub	ecx, eax
  7039 00002C11 7316                    	jnc	short move_file_pointer
  7040                                  move_to_beginning:
  7041                                  	;xor	cx, cx ; 0
  7042                                  	;xor	bx, bx ; 0
  7043 00002C13 31C9                    	xor	ecx, ecx
  7044 00002C15 EB12                    	jmp	short move_file_pointer
  7045                                  move_forward: 
  7046                                  	;add	bx, ax
  7047                                  	;adc	cx, dx
  7048 00002C17 01C1                    	add	ecx, eax
  7049 00002C19 7208                    	jc	short move_to_end
  7050                                  	;cmp	cx, [DATA_SubchunkSize+2]
  7051                                  	;ja	short move_to_end
  7052                                  	;jb	short move_file_pointer
  7053                                  	;cmp	bx, [DATA_SubchunkSize]
  7054                                  	;jna	short move_file_pointer
  7055 00002C1B 3B0D[34380000]          	cmp	ecx, [DATA_SubchunkSize]
  7056 00002C21 7606                    	jna	short move_file_pointer
  7057                                  move_to_end:
  7058                                  	;mov	bx, [DATA_SubchunkSize]
  7059                                  	;mov	cx, [DATA_SubchunkSize+2]
  7060 00002C23 8B0D[34380000]          	mov	ecx, [DATA_SubchunkSize]
  7061                                  move_file_pointer:
  7062                                  	;mov	dx, bx    
  7063                                  	;mov	[LoadedDataBytes], dx
  7064                                  	;mov	[LoadedDataBytes+2], cx
  7065 00002C29 890D[C4380000]          	mov	[LoadedDataBytes], ecx
  7066                                  	;add	dx, 44 ; + header
  7067                                  	;adc	cx, 0
  7068 00002C2F 83C12C                  	add	ecx, 44 
  7069                                  
  7070                                  	; seek
  7071                                  	;mov	bx, [filehandle]
  7072                                  	;mov	ax, 4200h
  7073                                  	;int	21h
  7074                                  	; 01/12/2024
  7075 00002C32 31D2                    	xor	edx, edx ; offset from beginning of the file
  7076                                  	; ecx = offset	
  7077                                  	; ebx = file handle
  7078                                  	; edx = 0
  7079                                  	sys	_seek, [filehandle]
    90                              <1> 
    91                              <1> 
    92                              <1> 
    93                              <1> 
    94                              <1>  %if %0 >= 2
    95 00002C34 8B1D[3C380000]      <1>  mov ebx, %2
    96                              <1>  %if %0 >= 3
    97                              <1>  mov ecx, %3
    98                              <1>  %if %0 = 4
    99                              <1>  mov edx, %4
   100                              <1>  %endif
   101                              <1>  %endif
   102                              <1>  %endif
   103 00002C3A B813000000          <1>  mov eax, %1
   104                              <1> 
   105 00002C3F CD40                <1>  int 40h
  7080 00002C41 C3                      	retn
  7081                                  
  7082                                  ; --------------------------------------------------------
  7083                                  
  7084                                  	; 30/12/2024 (video mode 13h)
  7085                                  	; (320*200, 256 colors)
  7086                                  	; 25/12/2024
  7087                                  	; 22/12/2024 (VESA VBE mode graphics) 
  7088                                  	; (640*480, 256 colors)
  7089                                  clear_window:
  7090                                  	;mov	edi, [LFB_ADDR]
  7091                                  	; 30/12/2024
  7092                                  	;mov	edi, 0A0000h
  7093                                  	;;add	edi, (13*80*8*14)
  7094                                  	; 25/12/2024
  7095                                  	;;add	edi, 164*640
  7096                                  	;add	edi, 12*8*320
  7097                                  	; 30/12/2024
  7098                                  	;mov	edi, [graphstart] ; 12*8*320
  7099 00002C42 BF80700A00              	mov	edi, 0A0000h+(11*8*320)+(2*320) ; *
  7100                                  				; AC97 info start 
  7101 00002C47 29C0                    	sub	eax, eax
  7102                                  	;;mov	ecx, (16*640*14)/4 ; 16 rows
  7103                                  	;mov	ecx, 64*640 ; 256 volume level points
  7104                                  	; 30/12/2024
  7105                                  	;mov	ecx, (8*8*320)/4 ; 8 rows 
  7106 00002C49 B900190000              	mov	ecx, (10*8*320)/4 ; *
  7107 00002C4E F3AB                    	rep	stosd
  7108                                  	; 24/12/2024
  7109 00002C50 A3[FC320000]            	mov	[prev_points], eax ; 0
  7110                                  	;
  7111 00002C55 C3                      	retn
  7112                                  
  7113                                  ; -------------------------------------------------------------
  7114                                  ; ac97.inc (11/11/2023)
  7115                                  ; -------------------------------------------------------------
  7116                                  
  7117                                  ; special characters
  7118                                  LF      EQU 10
  7119                                  CR      EQU 13
  7120                                  
  7121                                  ; PCI stuff
  7122                                  
  7123                                  BIT0  EQU 1
  7124                                  BIT1  EQU 2
  7125                                  BIT2  EQU 4
  7126                                  BIT8  EQU 100h
  7127                                  BIT9  EQU 200h
  7128                                  BIT28 EQU 10000000h
  7129                                  BIT30 EQU 40000000h
  7130                                  BIT31 EQU 80000000h
  7131                                  
  7132                                  BUP		equ	BIT30		; Buffer Underrun Policy.
  7133                                  					; if this buffer is the last buffer
  7134                                  					; in a playback, fill the remaining
  7135                                  					; samples with 0 (silence) or not.
  7136                                  					; It's a good idea to set this to 1
  7137                                  					; for the last buffer in playback,
  7138                                  					; otherwise you're likely to get a lot
  7139                                  					; of noise at the end of the sound.
  7140                                  
  7141                                  RR		equ	BIT1		; reset registers. Nukes all regs
  7142                                                                          ; except bits 4:2 of this register.
  7143                                                                          ; Only set this bit if BIT 0 is 0
  7144                                  RPBM		equ	BIT0		; Run/Pause
  7145                                  					; set this bit to start the codec!
  7146                                  IO_ENA		EQU	BIT0		; i/o decode enable
  7147                                  BM_ENA		EQU	BIT2		; bus master enable
  7148                                  
  7149                                  PCI_INDEX_PORT  EQU     0CF8h
  7150                                  PCI_DATA_PORT   EQU     0CFCh
  7151                                  PCI32           EQU     BIT31           ; bitflag to signal 32bit access
  7152                                  PCI16           EQU     BIT30           ; bitflag for 16bit access
  7153                                  
  7154                                  AC97_INT_LINE	equ	3Ch		; AC97 Interrupt Line register offset
  7155                                  
  7156                                  ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
  7157                                  
  7158                                  INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
  7159                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  7160                                  SIS_VID		equ	1039h
  7161                                  NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
  7162                                  AMD_VID		equ	1022h
  7163                                  
  7164                                  ICH_DID         equ     2415h           ; ICH device ID
  7165                                  ICH0_DID        equ     2425h           ; ICH0
  7166                                  ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
  7167                                                                          ; they all should be compatible.
  7168                                  
  7169                                  ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
  7170                                  ICH3_DID	equ     2485h           ; ICH3
  7171                                  ICH4_DID        equ     24C5h           ; ICH4
  7172                                  ICH5_DID	equ     24D5h           ; ICH5
  7173                                  ICH6_DID	equ     266Eh           ; ICH6
  7174                                  ESB6300_DID	equ     25A6h           ; 6300ESB
  7175                                  ESB631X_DID	equ     2698h           ; 631XESB
  7176                                  ICH7_DID	equ	27DEh		; ICH7
  7177                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  7178                                  MX82440_DID	equ	7195h
  7179                                  SI7012_DID	equ	7012h
  7180                                  NFORCE_DID	equ	01B1h
  7181                                  NFORCE2_DID	equ	006Ah
  7182                                  AMD8111_DID	equ	746Dh
  7183                                  AMD768_DID	equ	7445h
  7184                                  ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
  7185                                  CK804_DID	equ	0059h
  7186                                  MCP04_DID	equ	003Ah
  7187                                  CK8_DID		equ	008Ah
  7188                                  NFORCE3_DID	equ	00DAh
  7189                                  CK8S_DID	equ	00EAh
  7190                                  
  7191                                  NAMBAR_REG	equ	10h		; native audio mixer BAR
  7192                                  NABMBAR_REG	equ	14h		; native audio bus mastering BAR
  7193                                  
  7194                                  CODEC_MASTER_VOL_REG	equ	02h	; master volume
  7195                                  CODEC_MASTER_TONE_REG	equ	08h	; master tone (R+L)
  7196                                  CODEC_PCM_OUT_REG 	equ	18h     ; PCM output volume
  7197                                  CODEC_EXT_AUDIO_REG	equ	28h	; extended audio
  7198                                  CODEC_EXT_AUDIO_CTRL_REG equ	2Ah	; extended audio control
  7199                                  CODEC_PCM_FRONT_DACRATE_REG equ	2Ch	; PCM out sample rate
  7200                                  
  7201                                  ; ICH supports 3 different types of register sets for three types of things
  7202                                  ; it can do, thus:
  7203                                  ;
  7204                                  ; PCM in (for recording) aka PI
  7205                                  ; PCM out (for playback) aka PO
  7206                                  ; MIC in (for recording) aka MC
  7207                                  
  7208                                  PI_BDBAR_REG	equ	0		; PCM in buffer descriptor BAR
  7209                                  PO_BDBAR_REG	equ	10h		; PCM out buffer descriptor BAR
  7210                                  
  7211                                  GLOB_CNT_REG	equ	2Ch		; Global control register
  7212                                  GLOB_STS_REG 	equ	30h		; Global Status register (RO)
  7213                                  
  7214                                  PI_CR_REG 	equ	0Bh		; PCM in Control Register
  7215                                  PO_CR_REG	equ	1Bh		; PCM out Control Register
  7216                                  MC_CR_REG	equ	2Bh		; MIC in Control Register
  7217                                  
  7218                                  PCI_CMD_REG	EQU	04h		; reg 04h, command register
  7219                                  
  7220                                  CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
  7221                                  CODEC_REG_POWERDOWN	equ	26h
  7222                                  
  7223                                  PO_CIV_REG	equ	14h		; PCM out current Index value (RO)
  7224                                  PO_LVI_REG	equ	15h		; PCM out Last Valid Index
  7225                                  PO_SR_REG	equ	16h		; PCM out Status register
  7226                                  
  7227                                  ; -------------------------------------------------------------
  7228                                  
  7229                                  ; 22/12/2024
  7230 00002C56 90<rep 2h>              align 4
  7231                                  
  7232                                  ; 13/11/2024
  7233                                  ; ('<<' to 'shl' conversion for FASM)
  7234                                  ;
  7235                                  ; 29/05/2024 (TRDOS 386)
  7236                                  ; 17/02/2017
  7237                                  ; Valid ICH device IDs
  7238                                  
  7239                                  valid_ids:
  7240                                  	;dd (ICH_DID shl 16) + INTEL_VID	; 8086h:2415h
  7241 00002C58 86801524                	dd (ICH_DID << 16) + INTEL_VID		; 8086h:2415h
  7242 00002C5C 86802524                	dd (ICH0_DID << 16) + INTEL_VID		; 8086h:2425h
  7243 00002C60 86804524                	dd (ICH2_DID << 16) + INTEL_VID		; 8086h:2445h
  7244 00002C64 86808524                	dd (ICH3_DID << 16) + INTEL_VID		; 8086h:2485h
  7245 00002C68 8680C524                	dd (ICH4_DID << 16) + INTEL_VID		; 8086h:24C5h
  7246 00002C6C 8680D524                	dd (ICH5_DID << 16) + INTEL_VID		; 8086h:24D5h
  7247 00002C70 86806E26                	dd (ICH6_DID << 16) + INTEL_VID		; 8086h:266Eh
  7248 00002C74 8680A625                	dd (ESB6300_DID << 16) + INTEL_VID	; 8086h:25A6h
  7249 00002C78 86809826                	dd (ESB631X_DID << 16) + INTEL_VID	; 8086h:2698h
  7250 00002C7C 8680DE27                	dd (ICH7_DID << 16) + INTEL_VID		; 8086h:27DEh
  7251                                  	; 03/11/2023 - Erdogan Tan
  7252 00002C80 86809571                	dd (MX82440_DID << 16) + INTEL_VID	; 8086h:7195h
  7253 00002C84 39101270                	dd (SI7012_DID << 16)  + SIS_VID	; 1039h:7012h
  7254 00002C88 DE10B101                	dd (NFORCE_DID << 16)  + NVIDIA_VID	; 10DEh:01B1h
  7255 00002C8C DE106A00                	dd (NFORCE2_DID << 16) + NVIDIA_VID	; 10DEh:006Ah
  7256 00002C90 22106D74                	dd (AMD8111_DID << 16) + AMD_VID	; 1022h:746Dh
  7257 00002C94 22104574                	dd (AMD768_DID << 16)  + AMD_VID	; 1022h:7445h
  7258 00002C98 DE105900                	dd (CK804_DID << 16) + NVIDIA_VID	; 10DEh:0059h
  7259 00002C9C DE103A00                	dd (MCP04_DID << 16) + NVIDIA_VID	; 10DEh:003Ah
  7260 00002CA0 DE108A00                	dd (CK8_DID << 16) + NVIDIA_VID		; 1022h:008Ah
  7261 00002CA4 DE10DA00                	dd (NFORCE3_DID << 16) + NVIDIA_VID	; 10DEh:00DAh
  7262 00002CA8 DE10EA00                	dd (CK8S_DID << 16) + NVIDIA_VID	; 10DEh:00EAh
  7263                                  
  7264                                  valid_id_count equ (($ - valid_ids)>>2)	; 05/11/2023
  7265                                  ; 13/11/2024
  7266                                  ;valid_id_count = ($ - valid_ids) shr 2	; 05/11/2023
  7267                                  
  7268 00002CAC 00000000                	dd 0
  7269                                  
  7270                                  Credits:
  7271 00002CB0 564741205741562050-     	db 'VGA WAV Player for TRDOS 386 by Erdogan Tan. '
  7271 00002CB9 6C6179657220666F72-
  7271 00002CC2 205452444F53203338-
  7271 00002CCB 36206279204572646F-
  7271 00002CD4 67616E2054616E2E20 
  7272 00002CDD 4A616E756172792032-     	db 'January 2025.',10,13,0
  7272 00002CE6 3032352E0A0D00     
  7273 00002CED 30312F30312F323032-     	db '01/01/2025', 10,13
  7273 00002CF6 350A0D             
  7274                                  ; 15/11/2024
  7275                                  reset:
  7276 00002CF9 00                      	db 0
  7277                                  
  7278                                  msgAudioCardInfo:
  7279 00002CFA 666F7220496E74656C-     	db 'for Intel AC97 (ICH) Audio Controller.', 10,13,0
  7279 00002D03 204143393720284943-
  7279 00002D0C 482920417564696F20-
  7279 00002D15 436F6E74726F6C6C65-
  7279 00002D1E 722E0A0D00         
  7280                                  
  7281                                  	; 30/12/2024
  7282                                  msg_usage:
  7283 00002D23 75736167653A204347-     	db 'usage: CGAPLAY <FileName1> <FileName2> <...>',10,13,0
  7283 00002D2C 41504C4159203C4669-
  7283 00002D35 6C654E616D65313E20-
  7283 00002D3E 3C46696C654E616D65-
  7283 00002D47 323E203C2E2E2E3E0A-
  7283 00002D50 0D00               
  7284                                  
  7285                                  noDevMsg:
  7286 00002D52 4572726F723A20556E-     	db 'Error: Unable to find AC97 audio device!'
  7286 00002D5B 61626C6520746F2066-
  7286 00002D64 696E64204143393720-
  7286 00002D6D 617564696F20646576-
  7286 00002D76 69636521           
  7287 00002D7A 0A0D00                  	db 10,13,0
  7288                                  
  7289                                  noFileErrMsg:
  7290 00002D7D 4572726F723A206669-     	db 'Error: file not found.',10,13,0
  7290 00002D86 6C65206E6F7420666F-
  7290 00002D8F 756E642E0A0D00     
  7291                                  
  7292                                  ; 07/12/2024
  7293                                  trdos386_err_msg:
  7294 00002D96 5452444F5320333836-     	db 'TRDOS 386 System call error !',10,13,0
  7294 00002D9F 2053797374656D2063-
  7294 00002DA8 616C6C206572726F72-
  7294 00002DB1 20210A0D00         
  7295                                  
  7296                                  ; 29/05/2024
  7297                                  ; 11/11/2023
  7298                                  msg_init_err:
  7299 00002DB6 0D0A                    	db CR, LF
  7300 00002DB8 4143393720436F6E74-     	db 'AC97 Controller/Codec initialization error !'
  7300 00002DC1 726F6C6C65722F436F-
  7300 00002DCA 64656320696E697469-
  7300 00002DD3 616C697A6174696F6E-
  7300 00002DDC 206572726F722021   
  7301 00002DE4 0D0A00                  	db CR, LF, 0 ; 07/12/2024
  7302                                  
  7303                                  ; 25/11/2023
  7304                                  msg_no_vra:
  7305 00002DE7 0A0D                    	db 10,13
  7306 00002DE9 4E6F20565241207375-     	db 'No VRA support ! Only 48 kHZ sample rate supported !'
  7306 00002DF2 70706F72742021204F-
  7306 00002DFB 6E6C79203438206B48-
  7306 00002E04 5A2073616D706C6520-
  7306 00002E0D 726174652073757070-
  7306 00002E16 6F727465642021     
  7307 00002E1D 0A0D00                  	db 10,13,0
  7308                                  
  7309                                  ; 19/11/2024
  7310                                  ; 03/06/2017
  7311                                  hex_chars:
  7312 00002E20 303132333435363738-     	db '0123456789ABCDEF', 0
  7312 00002E29 3941424344454600   
  7313                                  msgAC97Info:
  7314 00002E31 0D0A                    	db 0Dh, 0Ah
  7315 00002E33 204143393720417564-     	db ' AC97 Audio Controller & Codec Info', 0Dh, 0Ah 
  7315 00002E3C 696F20436F6E74726F-
  7315 00002E45 6C6C6572202620436F-
  7315 00002E4E 64656320496E666F0D-
  7315 00002E57 0A                 
  7316 00002E58 2056656E646F722049-     	db ' Vendor ID: '
  7316 00002E61 443A20             
  7317                                  msgVendorId:
  7318 00002E64 303030306820446576-     	db '0000h Device ID: '
  7318 00002E6D 6963652049443A20   
  7319                                  msgDevId:
  7320 00002E75 30303030680D0A          	db '0000h', 0Dh, 0Ah
  7321 00002E7C 204275733A20            	db ' Bus: '
  7322                                  msgBusNo:
  7323 00002E82 303068204465766963-     	db '00h Device: '
  7323 00002E8B 653A20             
  7324                                  msgDevNo:
  7325 00002E8E 3030682046756E6374-     	db '00h Function: '
  7325 00002E97 696F6E3A20         
  7326                                  msgFncNo:
  7327 00002E9C 303068                  	db '00h'
  7328 00002E9F 0D0A                    	db 0Dh, 0Ah
  7329 00002EA1 204E414D4241523A20      	db ' NAMBAR: '
  7330                                  msgNamBar:
  7331 00002EAA 30303030682020          	db '0000h  '
  7332 00002EB1 4E41424D4241523A20      	db 'NABMBAR: '
  7333                                  msgNabmBar:
  7334 00002EBA 303030306820204952-     	db '0000h  IRQ: '
  7334 00002EC3 513A20             
  7335                                  msgIRQ:
  7336 00002EC6 3030                    	dw 3030h
  7337 00002EC8 0D0A00                  	db 0Dh, 0Ah, 0
  7338                                  ; 25/11/2023
  7339                                  msgVRAheader:
  7340 00002ECB 205652412073757070-     	db ' VRA support: '
  7340 00002ED4 6F72743A20         
  7341 00002ED9 00                      	db 0	
  7342                                  msgVRAyes:
  7343 00002EDA 5945530D0A00            	db 'YES', 0Dh, 0Ah, 0
  7344                                  msgVRAno:
  7345 00002EE0 4E4F200D0A              	db 'NO ', 0Dh, 0Ah
  7346                                  	;db ' (Interpolated sample rate playing method)'
  7347                                  	; 30/12/2024
  7348 00002EE5 2028496E746572706F-     	db ' (Interpolated samplerate play method)'
  7348 00002EEE 6C617465642073616D-
  7348 00002EF7 706C65726174652070-
  7348 00002F00 6C6179206D6574686F-
  7348 00002F09 6429               
  7349 00002F0B 0D0A00                  	db 0Dh, 0Ah, 0
  7350                                  
  7351 00002F0E 90<rep 2h>              align 4
  7352                                  
  7353                                  ; -------------------------------------------------------------
  7354                                  
  7355                                  	; 30/12/2024
  7356                                  PlayingScreen:
  7357 00002F10 DBDBDBDBDBDBDBDBDB-     	db  14 dup(219), " DOS Player ", 14 dup(219)
  7357 00002F19 DBDBDBDBDB20444F53-
  7357 00002F22 20506C6179657220DB-
  7357 00002F2B DBDBDBDBDBDBDBDBDB-
  7357 00002F34 DBDBDBDB           
  7358 00002F38 C9CDCDCDCDCDCDCDCD-     	db  201, 38 dup(205), 187
  7358 00002F41 CDCDCDCDCDCDCDCDCD-
  7358 00002F4A CDCDCDCDCDCDCDCDCD-
  7358 00002F53 CDCDCDCDCDCDCDCDCD-
  7358 00002F5C CDCDCDBB           
  7359 00002F60 BA203C53706163653E-     	db  186, " <Space> Play/Pause <N>/<P> Next/Prev ", 186
  7359 00002F69 20506C61792F506175-
  7359 00002F72 7365203C4E3E2F3C50-
  7359 00002F7B 3E204E6578742F5072-
  7359 00002F84 657620BA           
  7360 00002F88 BA203C533E20202020-     	db  186, " <S>     Stop       <Enter> Color     ", 186
  7360 00002F91 2053746F7020202020-
  7360 00002F9A 2020203C456E746572-
  7360 00002FA3 3E20436F6C6F722020-
  7360 00002FAC 202020BA           
  7361 00002FB0 BA203C463E20202020-     	db  186, " <F>     Forwards   <+>/<-> Volume    ", 186
  7361 00002FB9 20466F727761726473-
  7361 00002FC2 2020203C2B3E2F3C2D-
  7361 00002FCB 3E20566F6C756D6520-
  7361 00002FD4 202020BA           
  7362 00002FD8 BA203C423E20202020-     	db  186, " <B>     Backwards  <Q>     Quit Prg  ", 186
  7362 00002FE1 204261636B77617264-
  7362 00002FEA 7320203C513E202020-
  7362 00002FF3 202051756974205072-
  7362 00002FFC 672020BA           
  7363 00003000 CCCDCDCDCDCDCDCDCD-     	db  204, 38 dup(205), 185
  7363 00003009 CDCDCDCDCDCDCDCDCD-
  7363 00003012 CDCDCDCDCDCDCDCDCD-
  7363 0000301B CDCDCDCDCDCDCDCDCD-
  7363 00003024 CDCDCDB9           
  7364 00003028 BA2046696C653A2020-     	db  186, " File:              Bits:     0       ", 186
  7364 00003031 202020202020202020-
  7364 0000303A 202020426974733A20-
  7364 00003043 202020203020202020-
  7364 0000304C 202020BA           
  7365 00003050 BA20467265713A2030-     	db  186, " Freq: 0     Hz     Channels: 0       ", 186
  7365 00003059 2020202020487A2020-
  7365 00003062 2020204368616E6E65-
  7365 0000306B 6C733A203020202020-
  7365 00003074 202020BA           
  7366 00003078 C8CDCDCDCDCDCDCDCD-     	db  200, 38 dup(205), 188
  7366 00003081 CDCDCDCDCDCDCDCDCD-
  7366 0000308A CDCDCDCDCDCDCDCDCD-
  7366 00003093 CDCDCDCDCDCDCDCDCD-
  7366 0000309C CDCDCDBC           
  7367 000030A0 202020202020202020-     	db  40 dup(32)
  7367 000030A9 202020202020202020-
  7367 000030B2 202020202020202020-
  7367 000030BB 202020202020202020-
  7367 000030C4 20202020           
  7368                                  improper_samplerate_txt:
  7369                                  read_error_txt:
  7370 000030C8 202020202020202020-     	db  40 dup(32)
  7370 000030D1 202020202020202020-
  7370 000030DA 202020202020202020-
  7370 000030E3 202020202020202020-
  7370 000030EC 20202020           
  7371 000030F0 202020202020202020-     	db  40 dup(32)
  7371 000030F9 202020202020202020-
  7371 00003102 202020202020202020-
  7371 0000310B 202020202020202020-
  7371 00003114 20202020           
  7372 00003118 202020202020202020-     	db  40 dup(32)
  7372 00003121 202020202020202020-
  7372 0000312A 202020202020202020-
  7372 00003133 202020202020202020-
  7372 0000313C 20202020           
  7373 00003140 202020202020202020-     	db  40 dup(32)
  7373 00003149 202020202020202020-
  7373 00003152 202020202020202020-
  7373 0000315B 202020202020202020-
  7373 00003164 20202020           
  7374 00003168 202020202020202020-     	db  40 dup(32)
  7374 00003171 202020202020202020-
  7374 0000317A 202020202020202020-
  7374 00003183 202020202020202020-
  7374 0000318C 20202020           
  7375 00003190 202020202020202020-     	db  40 dup(32)
  7375 00003199 202020202020202020-
  7375 000031A2 202020202020202020-
  7375 000031AB 202020202020202020-
  7375 000031B4 20202020           
  7376 000031B8 202020202020202020-     	db  40 dup(32)
  7376 000031C1 202020202020202020-
  7376 000031CA 202020202020202020-
  7376 000031D3 202020202020202020-
  7376 000031DC 20202020           
  7377 000031E0 202020202020202020-     	db  40 dup(32)
  7377 000031E9 202020202020202020-
  7377 000031F2 202020202020202020-
  7377 000031FB 202020202020202020-
  7377 00003204 20202020           
  7378 00003208 202020202020202020-     	db  40 dup(32)
  7378 00003211 202020202020202020-
  7378 0000321A 202020202020202020-
  7378 00003223 202020202020202020-
  7378 0000322C 20202020           
  7379 00003230 202020202020202020-     	db  40 dup(32)
  7379 00003239 202020202020202020-
  7379 00003242 202020202020202020-
  7379 0000324B 202020202020202020-
  7379 00003254 20202020           
  7380 00003258 CDCDCDCDCDCDCDCDCD-     	db  40 dup(205)
  7380 00003261 CDCDCDCDCDCDCDCDCD-
  7380 0000326A CDCDCDCDCDCDCDCDCD-
  7380 00003273 CDCDCDCDCDCDCDCDCD-
  7380 0000327C CDCDCDCD           
  7381 00003280 202020202020202020-     	db  40 dup(32)
  7381 00003289 202020202020202020-
  7381 00003292 202020202020202020-
  7381 0000329B 202020202020202020-
  7381 000032A4 20202020           
  7382 000032A8 202020202020202020-     	db  13 dup(32), "00:00 ", 174, 175, " 00:00", 4 dup(32), "VOL 000%"
  7382 000032B1 2020202030303A3030-
  7382 000032BA 20AEAF2030303A3030-
  7382 000032C3 20202020564F4C2030-
  7382 000032CC 303025             
  7383                                  	;db  40 dup(32) ; not necessary
  7384 000032CF 00                      	db 0
  7385                                  
  7386                                  ; -------------------------------------------------------------
  7387                                  
  7388                                  	; 30/12/2024
  7389                                  fillblock:
  7390 000032D0 FF<rep 8h>              	times 8 db 0FFh
  7391 000032D8 0000                    	dw 0
  7392                                  
  7393                                  ; -------------------------------------------------------------
  7394                                  
  7395                                  ; 30/12/2024
  7396                                  ; 23/11/2024
  7397                                  colors:
  7398 000032DA 0F0B0A0C0E090D          	db 0Fh, 0Bh, 0Ah, 0Ch, 0Eh, 09h, 0Dh
  7399                                  	; white, cyan, green, red, yellow, blue, magenta
  7400 000032E1 0B                      ccolor:	db 0Bh	; cyan
  7401                                  
  7402                                  EOF: 
  7403                                  
  7404                                  ; -------------------------------------------------------------
  7405                                  
  7406                                  bss:
  7407                                  
  7408                                  ABSOLUTE bss
  7409                                  
  7410 000032E2 ????                    alignb 4
  7411                                  
  7412                                  ; 24/12/2024
  7413                                  wpoints_dif:	; wave lighting points factor (differential) 
  7414 000032E4 ????????                	resd 1	; required bytes for 1/18 second wave lighting
  7415                                  graphstart:
  7416 000032E8 ????????                	resd 1	; start (top) line/row for wave lighting points 	 
  7417                                  
  7418                                  ; 30/12/2024
  7419                                  ;LFB_ADDR:
  7420                                  ;	resd 1
  7421                                  
  7422                                  ;nextrow:
  7423                                  	;resd 1
  7424                                  screenpos: ; hw = (cursor) row, lw = (cursor) column
  7425 000032EC ????????                	resd 1
  7426 000032F0 ????????                wcolor:	resd 1
  7427                                  ; 26/12/2024
  7428                                  ;tcolor: resb 1 ; text color
  7429                                  columns:
  7430 000032F4 ??                      	resb 1
  7431 000032F5 ??                      pbprev:	resb 1 ; previous progress bar indicator position
  7432                                  
  7433 000032F6 ????                    alignb 4
  7434                                  
  7435                                  bss_start:
  7436                                  
  7437                                  ; 29/12/2024
  7438                                  audio_buffer:
  7439 000032F8 ????????                	resd 1
  7440                                  
  7441                                  ; 30/12/2024
  7442                                  prev_points:
  7443 000032FC <res 500h>              	resd 320 ; previous wave points (which are lighting)	
  7444                                  
  7445                                  ; 18/11/2024
  7446                                  stopped:
  7447 000037FC ??                      	resb 1
  7448 000037FD ??                      tLO:	resb 1
  7449                                  ; 21/11/2024
  7450 000037FE ??                      tLP:	resb 1
  7451                                  ; 30/12/2024
  7452                                  wpoints:
  7453 000037FF ??                      	resb 1
  7454 00003800 ????????                pbuf_o:	resd 1
  7455                                  ; 29/12/2024
  7456 00003804 ????????                pbuf_s:	resd 1
  7457                                  
  7458                                  ; 07/12/2024
  7459                                  ; 24/11/2024
  7460                                  half_buffer:
  7461 00003808 ??                      	resb 1	; dma half buffer 1 or 2 (0 or 1)
  7462                                  
  7463                                  ; 30/05/2024
  7464 00003809 ??                      VRA:	resb 1	; Variable Rate Audio Support Status
  7465                                  
  7466                                  ; 25/12/2024
  7467                                  ; 29/11/2024
  7468                                  command:
  7469 0000380A ??                      	resb 1
  7470                                  filecount:
  7471 0000380B ??                      	resb 1
  7472                                  
  7473                                  ; 30/11/2024
  7474                                  alignb 4
  7475                                  
  7476                                  ;;;;;;;;;;;;;;
  7477                                  ; 14/11/2024
  7478                                  ; (Ref: player.asm, Matan Alfasi, 2017)  
  7479                                  WAVFILEHEADERbuff:
  7480                                  RIFF_ChunkID:
  7481 0000380C ????????                	resd 1	; Must be equal to "RIFF" - big-endian
  7482                                  		; 0x52494646
  7483                                  RIFF_ChunkSize:
  7484 00003810 ????????                	resd 1	; Represents total file size, not 
  7485                                          	; including the first 2 fields 
  7486                                  		; (Total_File_Size - 8), little-endian
  7487                                  RIFF_Format:
  7488 00003814 ????????                	resd 1	; Must be equal to "WAVE" - big-endian
  7489                                  		; 0x57415645
  7490                                  
  7491                                  ;; WAVE header parameters ("Sub-chunk")
  7492                                  WAVE_SubchunkID:
  7493 00003818 ????????                	resd 1	; Must be equal to "fmt " - big-endian
  7494                                  		; 0x666d7420
  7495                                  WAVE_SubchunkSize:
  7496 0000381C ????????                	resd 1	; Represents total chunk size
  7497                                  WAVE_AudioFormat:
  7498 00003820 ????                    	resw 1	; PCM (Raw) - is 1, other - is a form 
  7499                                  		; of compression, not supported.
  7500                                  WAVE_NumChannels:
  7501 00003822 ????                    	resw 1	; Number of channels, Mono-1, Stereo-2
  7502                                  WAVE_SampleRate:
  7503 00003824 ????????                	resd 1	; Frequency rate, in Hz (8000, 44100 ...)
  7504                                  WAVE_ByteRate:
  7505 00003828 ????????                	resd 1	; SampleRate * NumChannels * BytesPerSample
  7506                                  WAVE_BlockAlign:
  7507 0000382C ????                    	resw 1	; NumChannels * BytesPerSample
  7508                                  		; Number of bytes for one sample.
  7509                                  WAVE_BitsPerSample:
  7510 0000382E ????                    	resw 1	; 8 = 8 bits, 16 = 16 bits, etc.
  7511                                  
  7512                                  ;; DATA header parameters
  7513                                  DATA_SubchunkID:
  7514 00003830 ????????                	resd 1	; Must be equal to "data" - big-endian
  7515                                          	; 0x64617461
  7516                                  DATA_SubchunkSize:
  7517 00003834 ????????                	resd 1	; NumSamples * NumChannels * BytesPerSample
  7518                                          	; Number of bytes in the data.
  7519                                  ;;;;;;;;;;;;;;
  7520                                  
  7521                                  ; 28/12/2024
  7522                                  ; 15/11/2024
  7523                                  ;cursortype:
  7524 00003838 ????                    	resw 1
  7525 0000383A ??                      flags:	resb 1
  7526                                  ; 06/11/2023
  7527                                  ac97_int_ln_reg:
  7528 0000383B ??                      	resb 1
  7529                                  filehandle:
  7530 0000383C ????????                	resd 1
  7531                                  
  7532                                  ; 25/12/2024
  7533                                  ; 30/11/2024
  7534                                  ;argc:	resb 1	; argument count
  7535 00003840 ????????                argv:	resd 1	; current argument (wav file) ptr
  7536 00003844 ????????                argvf:	resd 1	; 1st argument (wav file) ptr
  7537 00003848 ????????                argvl:	resd 1	; last argument (wav file) ptr
  7538                                  
  7539                                  ; 30/05/2024
  7540                                  wav_file_name:
  7541 0000384C <res 50h>               	resb 80	; wave file, path name (<= 80 bytes)
  7542 0000389C ????                    	resw 1	; 30/11/2024
  7543                                  
  7544                                  ; 08/11/2023
  7545                                  ; 07/11/2023
  7546                                  fbs_shift:
  7547 0000389E ??                      	resb 1
  7548                                  ; 07/12/2024
  7549 0000389F ??                      SRB:	resb 1
  7550                                  
  7551                                  ; 12/11/2016 - Erdogan Tan
  7552                                  bus_dev_fn:
  7553 000038A0 ????????                	resd 1
  7554                                  dev_vendor:
  7555 000038A4 ????????                	resd 1
  7556                                  
  7557                                  ; 17/02/2017
  7558                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  7559                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  7560                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  7561                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  7562 000038A8 ????                    NAMBAR:	resw 1	; BAR for mixer
  7563                                  NABMBAR:
  7564 000038AA ????                    	resw 1	; BAR for bus master regs
  7565                                  
  7566                                  ; 15/11/2024
  7567                                  loadfromwavfile:
  7568 000038AC ????????                	resd 1	; 'loadfromfile' or load+conversion proc address
  7569                                  loadsize:
  7570 000038B0 ????????                	resd 1	; (.wav file) read count (bytes) per one time
  7571                                  buffersize:
  7572 000038B4 ????????                	resd 1	; 16 bit samples (not bytes)
  7573                                  		
  7574                                  ; 14/11/2024
  7575                                  TotalTime:
  7576 000038B8 ????????                	resd 1	; Total (WAV File) Playing Time in seconds
  7577                                  ProgressTime:
  7578 000038BC ????????                	resd 1
  7579 000038C0 ????????                count:	resd 1	; byte count of one (wav file) read
  7580                                  LoadedDataBytes:
  7581 000038C4 ????????                	resd 1	; total read/load count
  7582                                  
  7583                                  timerticks:
  7584 000038C8 ????????                	resd 1	; (to eliminate excessive lookup of events in tuneloop)
  7585                                  		; (in order to get the emulator/qemu to run correctly)
  7586                                  ; 01/12/2024
  7587                                  _bdl_buffer:
  7588 000038CC ????????                	resd 1
  7589                                  
  7590                                  ; 14/11/2024
  7591                                  bss_end:
  7592                                  
  7593                                  ; 29/12/2024
  7594 000038D0 <res 730h>              alignb 4096
  7595                                  
  7596                                  ; 01/12/2024
  7597                                  BDL_BUFFER:
  7598 00004000 <res 100h>              	resb 256
  7599                                  	; 02/12/2024
  7600 00004100 <res F00h>              	resb 4096-256
  7601                                  
  7602                                  ;alignb 4096
  7603                                  
  7604                                  ; 29/05/2024
  7605                                  WAVBUFFER_1:
  7606 00005000 <res 10000h>            	resb 65536
  7607                                  WAVBUFFER_2:
  7608 00015000 <res 10000h>            	resb 65536
  7609                                  
  7610                                  ; 01/12/2024
  7611                                  ; 26/11/2023
  7612                                  temp_buffer:
  7613 00025000 <res 10000h>            	resb 65536  ;  resb BUFFERSIZE
