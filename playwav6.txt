     1                                  ; ****************************************************************************
     2                                  ; playwav6.s (for TRDOS 386)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYWAV6.PRG ! AC'97 (ICH) .WAV PLAYER program by Erdogan TAN
     5                                  ;
     6                                  ; 25/11/2023
     7                                  ;
     8                                  ; [ Last Modification: 17/01/2025 ]
     9                                  ;
    10                                  ; Modified from PLAYWAV5.PRG .wav player program by Erdogan Tan, 18/08/2020
    11                                  ;
    12                                  ; Assembler: NASM version 2.15
    13                                  ;	     nasm playwav6.s -l playwav6.txt -o PLAYWAV6.PRG	
    14                                  ; ----------------------------------------------------------------------------
    15                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002
    16                                  
    17                                  ; previous version: playwav3.s (17/06/2017)
    18                                  
    19                                  ; CODE
    20                                  
    21                                  ; 14/07/2020
    22                                  ; 31/12/2017
    23                                  ; TRDOS 386 (v2.0) system calls
    24                                  _ver 	equ 0
    25                                  _exit 	equ 1
    26                                  _fork 	equ 2
    27                                  _read 	equ 3
    28                                  _write	equ 4
    29                                  _open	equ 5
    30                                  _close 	equ 6
    31                                  _wait 	equ 7
    32                                  _create	equ 8
    33                                  _rename	equ 9
    34                                  _delete	equ 10
    35                                  _exec	equ 11
    36                                  _chdir	equ 12
    37                                  _time 	equ 13
    38                                  _mkdir 	equ 14
    39                                  _chmod	equ 15
    40                                  _rmdir	equ 16
    41                                  _break	equ 17
    42                                  _drive	equ 18
    43                                  _seek	equ 19
    44                                  _tell 	equ 20
    45                                  _memory	equ 21
    46                                  _prompt	equ 22
    47                                  _path	equ 23
    48                                  _env	equ 24
    49                                  _stime	equ 25
    50                                  _quit	equ 26
    51                                  _intr	equ 27
    52                                  _dir	equ 28
    53                                  _emt 	equ 29
    54                                  _ldrvt 	equ 30
    55                                  _video 	equ 31
    56                                  _audio	equ 32
    57                                  _timer	equ 33
    58                                  _sleep	equ 34
    59                                  _msg    equ 35
    60                                  _geterr	equ 36
    61                                  _fpstat	equ 37
    62                                  _pri	equ 38
    63                                  _rele	equ 39
    64                                  _fff	equ 40
    65                                  _fnf	equ 41
    66                                  _alloc	equ 42
    67                                  _dalloc equ 43
    68                                  _calbac equ 44
    69                                  _dma	equ 45
    70                                  
    71                                  %macro sys 1-4
    72                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)	
    73                                      ; 03/09/2015	
    74                                      ; 13/04/2015
    75                                      ; Retro UNIX 386 v1 system call.	
    76                                      %if %0 >= 2   
    77                                          mov ebx, %2
    78                                          %if %0 >= 3    
    79                                              mov ecx, %3
    80                                              %if %0 = 4
    81                                                 mov edx, %4   
    82                                              %endif
    83                                          %endif
    84                                      %endif
    85                                      mov eax, %1
    86                                      ;int 30h
    87                                      int 40h ; TRDOS 386 (TRDOS v2.0)	   
    88                                  %endmacro
    89                                  
    90                                  ; TRDOS 386 (and Retro UNIX 386 v1) system call format:
    91                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
    92                                  
    93                                  BUFFERSIZE	equ	32768	; audio buffer size 
    94                                  ENDOFFILE       equ     1	; flag for knowing end of file
    95                                  
    96                                  [BITS 32]
    97                                  
    98                                  [ORG 0] 
    99                                  
   100                                  _STARTUP:
   101                                  	; Prints the Credits Text.
   102                                  	sys	_msg, Credits, 255, 0Bh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000000 BB[48200000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000005 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000000A BA0B000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000000F B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000014 CD40                <1>  int 40h
   103                                  
   104                                  	; clear bss
   105 00000016 B9[B1230000]            	mov	ecx, bss_end
   106 0000001B BF[25230000]            	mov	edi, bss_start
   107 00000020 29F9                    	sub	ecx, edi
   108 00000022 D1E9                    	shr	ecx, 1
   109 00000024 31C0                    	xor	eax, eax
   110 00000026 F366AB                  	rep	stosw
   111                                  
   112                                  	; Detect (& Enable) AC'97 Audio Device
   113 00000029 E892040000              	call	DetectAC97
   114 0000002E 731B                    	jnc     short GetFileName
   115                                  
   116                                  _dev_not_ready:
   117                                  ; couldn't find the audio device!
   118                                  	sys	_msg, noDevMsg, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000030 BB[1C210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000035 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000003A BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000003F B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000044 CD40                <1>  int 40h
   119 00000046 E94F040000                      jmp     Exit
   120                                  
   121                                  GetFileName:  
   122 0000004B 89E6                    	mov	esi, esp
   123 0000004D AD                      	lodsd
   124 0000004E 83F802                  	cmp	eax, 2 ; two arguments 
   125                                  	       ; (program file name & mod file name)
   126 00000051 0F8251040000            	jb	pmsg_usage ; nothing to do
   127                                  
   128 00000057 AD                      	lodsd ; program file name address 
   129 00000058 AD                      	lodsd ; mod file name address (file to be read)
   130 00000059 89C6                    	mov	esi, eax
   131 0000005B BF[51230000]            	mov	edi, wav_file_name
   132                                  ScanName:       
   133 00000060 AC                      	lodsb
   134 00000061 84C0                    	test	al, al
   135 00000063 0F843F040000            	je	pmsg_usage
   136 00000069 3C20                    	cmp	al, 20h
   137 0000006B 74F3                    	je	short ScanName	; scan start of name.
   138 0000006D AA                      	stosb
   139 0000006E B4FF                    	mov	ah, 0FFh
   140                                  a_0:	
   141 00000070 FEC4                    	inc	ah
   142                                  a_1:
   143 00000072 AC                      	lodsb
   144 00000073 AA                      	stosb
   145 00000074 3C2E                    	cmp	al, '.'
   146 00000076 74F8                    	je	short a_0	
   147 00000078 20C0                    	and	al, al
   148 0000007A 75F6                    	jnz	short a_1
   149                                  
   150 0000007C 08E4                    	or	ah, ah		; if period NOT found,
   151 0000007E 750B                    	jnz	short _1 	; then add a .WAV extension.
   152                                  SetExt:
   153 00000080 4F                      	dec	edi
   154 00000081 C7072E574156            	mov	dword [edi], '.WAV'
   155 00000087 C6470400                	mov	byte [edi+4], 0
   156                                  
   157                                  _1:
   158                                  
   159                                  ; 26/11/2023
   160                                  %if 0
   161                                  	; Allocate Audio Buffer (for user)
   162                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   163                                  	; 26/11/2023
   164                                  	sys	_audio, 0200h, [buffersize], audio_buffer
   165                                  	jnc	short _2
   166                                  error_exit:
   167                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
   168                                  	jmp	Exit
   169                                  _2:
   170                                  	; DIRECT CGA (TEXT MODE) MEMORY ACCESS
   171                                  	; bl = 0, bh = 4
   172                                  	; Direct access/map to CGA (Text) memory (0B8000h)
   173                                  
   174                                  	sys	_video, 0400h
   175                                  	cmp	eax, 0B8000h
   176                                  	jne	short error_exit
   177                                  
   178                                  	; Initialize Audio Device (bh = 3)
   179                                  	sys	_audio, 0301h, 0, audio_int_handler 
   180                                  ;	jc	short error_exit
   181                                  _3:
   182                                  
   183                                  %endif
   184 0000008B E88E060000              	call	write_audio_dev_info 
   185                                  
   186                                  ; open the file
   187                                          ; open existing file
   188 00000090 E838040000                      call    openFile ; no error? ok.
   189 00000095 731B                            jnc     short _gsr
   190                                  
   191                                  ; file not found!
   192                                  	sys	_msg, noFileErrMsg, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000097 BB[47210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000009C B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000000A1 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000000A6 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000000AB CD40                <1>  int 40h
   193                                  _exit_:
   194 000000AD E9E8030000                      jmp     Exit
   195                                  
   196                                  _gsr:  
   197 000000B2 E850040000                     	call    getSampleRate		; read the sample rate
   198                                                                          ; pass it onto codec.
   199                                  	;jc	Exit
   200                                  	; 25/11/2023
   201 000000B7 72F4                    	jc	short _exit_
   202                                  
   203 000000B9 66A3[2A230000]          	mov	[sample_rate], ax
   204 000000BF 880D[28230000]          	mov	[stmo], cl
   205 000000C5 8815[29230000]          	mov	[bps], dl
   206                                  
   207                                  	; 26/11/2023
   208 000000CB C605[A4230000]00        	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   209 000000D2 FEC9                    	dec	cl
   210 000000D4 7506                    	jnz	short _gsr_1 ; stereo
   211 000000D6 FE05[A4230000]          	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   212                                  _gsr_1:	
   213 000000DC 80FA08                  	cmp	dl, 8 
   214 000000DF 7706                    	ja	short _gsr_2 ; 16 bit samples
   215 000000E1 FE05[A4230000]          	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   216                                  _gsr_2:	
   217                                  	; 06/06/2017
   218                                  	sys	_audio, 0E00h ; get audio controller info
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000000E7 BB000E0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000000EC B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000000F1 CD40                <1>  int 40h
   219 000000F3 0F82F5020000            	jc	error_exit ; 25/11/2023
   220                                  
   221                                  	;cmp	ah, 2 ; ICH ? (Intel AC'97 Audio Controller)
   222                                  	;jne	_dev_not_ready	
   223                                  
   224                                  	; EAX = IRQ Number in AL
   225                                  	;	Audio Device Number in AH 
   226                                  	; EBX = DEV/VENDOR ID
   227                                  	;       (DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV)
   228                                  	; ECX = BUS/DEV/FN 
   229                                  	;       (00000000BBBBBBBBDDDDDFFF00000000)
   230                                  	; EDX = NABMBAR/NAMBAR (for AC97)
   231                                  	;      (Low word, DX = NAMBAR address)
   232                                  	; EDX = Base IO Addr (DX) for SB16 & VT8233
   233                                  
   234 000000F9 A2[A3230000]            	mov	[ac97_int_ln_reg], al
   235 000000FE 891D[A5230000]          	mov	[dev_vendor], ebx
   236 00000104 890D[A9230000]          	mov	[bus_dev_fn], ecx
   237                                  	;mov	[ac97_NamBar], dx
   238                                  	;shr	dx, 16
   239                                  	;mov	[ac97_NabmBar], dx
   240 0000010A 8915[AD230000]          	mov	[ac97_NamBar], edx	
   241                                    
   242                                  	; 01/06/2024
   243                                  	; Reset Audio Device (bh = 8)
   244                                  	sys	_audio, 0800h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000110 BB00080000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000115 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000011A CD40                <1>  int 40h
   245                                  	;jc	error_exit	
   246 0000011C 7230                    	jc	short init_err
   247                                  
   248 0000011E E8DD060000              	call	write_ac97_pci_dev_info
   249                                  
   250                                  	; 01/06/2024
   251                                  	; 25/11/2023
   252                                  	; Get AC'97 Codec info
   253                                  	; (Function 14, sub function 1)
   254                                  	sys	_audio, 0E01h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000123 BB010E0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000128 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000012D CD40                <1>  int 40h
   255                                  	; Save Variable Rate Audio support bit
   256 0000012F 2401                    	and	al, 1
   257 00000131 A2[34230000]            	mov	[VRA], al
   258                                  
   259                                  	; 25/11/2023
   260 00000136 E88C080000              	call	write_VRA_info
   261                                  
   262                                  	; 01/05/2017
   263 0000013B E8F5050000              	call	write_wav_file_info
   264                                  
   265                                  	; 25/11/2023
   266                                  	; ------------------------------------------
   267                                  
   268 00000140 803D[34230000]01        	cmp	byte [VRA], 1
   269 00000147 7220                    	jb	short chk_sample_rate
   270                                  
   271                                  playwav_48_khz:	
   272                                  	;mov	dword [loadfromwavfile], loadFromFile
   273                                  	;mov	dword [buffersize], 65536
   274 00000149 E987020000              	jmp	PlayNow
   275                                  
   276                                  	; 01/06/2024
   277                                  init_err:
   278                                  	sys	_msg, msg_init_err, 255, 0Eh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000014E BB[80210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000153 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000158 BA0E000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000015D B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000162 CD40                <1>  int 40h
   279 00000164 E931030000              	jmp	Exit
   280                                  
   281                                  chk_sample_rate:
   282                                  	; set conversion parameters
   283                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   284 00000169 66A1[2A230000]          	mov	ax, [sample_rate]
   285 0000016F 663D80BB                	cmp	ax, 48000
   286 00000173 74D4                    	je	short playwav_48_khz
   287                                  chk_22khz:
   288 00000175 663D2256                	cmp	ax, 22050
   289 00000179 7545                    	jne	short chk_11khz
   290 0000017B 803D[29230000]08        	cmp	byte [bps], 8
   291 00000182 7615                    	jna	short chk_22khz_1
   292 00000184 BB[55160000]            	mov	ebx, load_22khz_stereo_16_bit
   293 00000189 803D[28230000]01        	cmp	byte [stmo], 1 
   294 00000190 751A                    	jne	short chk_22khz_2
   295 00000192 BB[C8150000]            	mov	ebx, load_22khz_mono_16_bit
   296 00000197 EB13                    	jmp	short chk_22khz_2
   297                                  chk_22khz_1:
   298 00000199 BB[41150000]            	mov	ebx, load_22khz_stereo_8_bit
   299 0000019E 803D[28230000]01        	cmp	byte [stmo], 1 
   300 000001A5 7505                    	jne	short chk_22khz_2
   301 000001A7 BB[B8140000]            	mov	ebx, load_22khz_mono_8_bit
   302                                  chk_22khz_2:
   303 000001AC B85A1D0000              	mov	eax, 7514  ; (442*17)
   304 000001B1 BA25000000              	mov	edx, 37
   305 000001B6 B911000000              	mov	ecx, 17 
   306 000001BB E9BA010000              	jmp	set_sizes	
   307                                  chk_11khz:
   308 000001C0 663D112B                	cmp	ax, 11025
   309 000001C4 7545                    	jne	short chk_44khz
   310 000001C6 803D[29230000]08        	cmp	byte [bps], 8
   311 000001CD 7615                    	jna	short chk_11khz_1
   312 000001CF BB[71180000]            	mov	ebx, load_11khz_stereo_16_bit
   313 000001D4 803D[28230000]01        	cmp	byte [stmo], 1 
   314 000001DB 751A                    	jne	short chk_11khz_2
   315 000001DD BB[F8170000]            	mov	ebx, load_11khz_mono_16_bit
   316 000001E2 EB13                    	jmp	short chk_11khz_2
   317                                  chk_11khz_1:
   318 000001E4 BB[7E170000]            	mov	ebx, load_11khz_stereo_8_bit
   319 000001E9 803D[28230000]01        	cmp	byte [stmo], 1 
   320 000001F0 7505                    	jne	short chk_11khz_2
   321 000001F2 BB[06170000]            	mov	ebx, load_11khz_mono_8_bit
   322                                  chk_11khz_2:
   323 000001F7 B8AD0E0000              	mov	eax, 3757  ; (221*17)
   324 000001FC BA4A000000              	mov	edx, 74
   325 00000201 B911000000              	mov	ecx, 17
   326 00000206 E96F010000              	jmp	set_sizes 
   327                                  chk_44khz:
   328 0000020B 663D44AC                	cmp	ax, 44100
   329 0000020F 7545                    	jne	short chk_16khz
   330 00000211 803D[29230000]08        	cmp	byte [bps], 8
   331 00000218 7615                    	jna	short chk_44khz_1
   332 0000021A BB[781A0000]            	mov	ebx, load_44khz_stereo_16_bit
   333 0000021F 803D[28230000]01        	cmp	byte [stmo], 1 
   334 00000226 751A                    	jne	short chk_44khz_2
   335 00000228 BB[FF190000]            	mov	ebx, load_44khz_mono_16_bit
   336 0000022D EB13                    	jmp	short chk_44khz_2
   337                                  chk_44khz_1:
   338 0000022F BB[82190000]            	mov	ebx, load_44khz_stereo_8_bit
   339 00000234 803D[28230000]01        	cmp	byte [stmo], 1 
   340 0000023B 7505                    	jne	short chk_44khz_2
   341 0000023D BB[06190000]            	mov	ebx, load_44khz_mono_8_bit
   342                                  chk_44khz_2:
   343 00000242 B8D93A0000              	mov	eax, 15065 ; (655*23)
   344 00000247 BA19000000              	mov	edx, 25
   345 0000024C B917000000              	mov	ecx, 23
   346 00000251 E924010000              	jmp	set_sizes 
   347                                  chk_16khz:
   348 00000256 663D803E                	cmp	ax, 16000
   349 0000025A 7545                    	jne	short chk_8khz
   350 0000025C 803D[29230000]08        	cmp	byte [bps], 8
   351 00000263 7615                    	jna	short chk_16khz_1
   352 00000265 BB[FD0F0000]            	mov	ebx, load_16khz_stereo_16_bit
   353 0000026A 803D[28230000]01        	cmp	byte [stmo], 1 
   354 00000271 751A                    	jne	short chk_16khz_2
   355 00000273 BB[7C0F0000]            	mov	ebx, load_16khz_mono_16_bit
   356 00000278 EB13                    	jmp	short chk_16khz_2
   357                                  chk_16khz_1:
   358 0000027A BB[C20E0000]            	mov	ebx, load_16khz_stereo_8_bit
   359 0000027F 803D[28230000]01        	cmp	byte [stmo], 1 
   360 00000286 7505                    	jne	short chk_16khz_2
   361 00000288 BB[430E0000]            	mov	ebx, load_16khz_mono_8_bit
   362                                  chk_16khz_2:
   363 0000028D B855150000              	mov	eax, 5461
   364 00000292 BA03000000              	mov	edx, 3
   365 00000297 B901000000              	mov	ecx, 1
   366 0000029C E9D9000000              	jmp	set_sizes 
   367                                  chk_8khz:
   368 000002A1 663D401F                	cmp	ax, 8000
   369 000002A5 7545                    	jne	short chk_24khz
   370 000002A7 803D[29230000]08        	cmp	byte [bps], 8
   371 000002AE 7615                    	jna	short chk_8khz_1
   372 000002B0 BB[F80C0000]            	mov	ebx, load_8khz_stereo_16_bit
   373 000002B5 803D[28230000]01        	cmp	byte [stmo], 1 
   374 000002BC 751A                    	jne	short chk_8khz_2
   375 000002BE BB[280C0000]            	mov	ebx, load_8khz_mono_16_bit
   376 000002C3 EB13                    	jmp	short chk_8khz_2
   377                                  chk_8khz_1:
   378 000002C5 BB[F80A0000]            	mov	ebx, load_8khz_stereo_8_bit
   379 000002CA 803D[28230000]01        	cmp	byte [stmo], 1 
   380 000002D1 7505                    	jne	short chk_8khz_2
   381 000002D3 BB[140A0000]            	mov	ebx, load_8khz_mono_8_bit
   382                                  chk_8khz_2:
   383 000002D8 B8AA0A0000              	mov	eax, 2730
   384 000002DD BA06000000              	mov	edx, 6
   385 000002E2 B901000000              	mov	ecx, 1
   386 000002E7 E98E000000              	jmp	set_sizes 
   387                                  chk_24khz:
   388 000002EC 663DC05D                	cmp	ax, 24000
   389 000002F0 7542                    	jne	short chk_32khz
   390 000002F2 803D[29230000]08        	cmp	byte [bps], 8
   391 000002F9 7615                    	jna	short chk_24khz_1
   392 000002FB BB[27120000]            	mov	ebx, load_24khz_stereo_16_bit
   393 00000300 803D[28230000]01        	cmp	byte [stmo], 1 
   394 00000307 751A                    	jne	short chk_24khz_2
   395 00000309 BB[C4110000]            	mov	ebx, load_24khz_mono_16_bit
   396 0000030E EB13                    	jmp	short chk_24khz_2
   397                                  chk_24khz_1:
   398 00000310 BB[3A110000]            	mov	ebx, load_24khz_stereo_8_bit
   399 00000315 803D[28230000]01        	cmp	byte [stmo], 1 
   400 0000031C 7505                    	jne	short chk_24khz_2
   401 0000031E BB[D3100000]            	mov	ebx, load_24khz_mono_8_bit
   402                                  chk_24khz_2:
   403 00000323 B800200000              	mov	eax, 8192
   404 00000328 BA02000000              	mov	edx, 2
   405 0000032D B901000000              	mov	ecx, 1
   406 00000332 EB46                    	jmp	short set_sizes 
   407                                  chk_32khz:
   408 00000334 663D007D                	cmp	ax, 32000
   409 00000338 7574                    	jne	short vra_needed
   410 0000033A 803D[29230000]08        	cmp	byte [bps], 8
   411 00000341 7615                    	jna	short chk_32khz_1
   412 00000343 BB[28140000]            	mov	ebx, load_32khz_stereo_16_bit
   413 00000348 803D[28230000]01        	cmp	byte [stmo], 1 
   414 0000034F 751A                    	jne	short chk_32khz_2
   415 00000351 BB[BE130000]            	mov	ebx, load_32khz_mono_16_bit
   416 00000356 EB13                    	jmp	short chk_32khz_2
   417                                  chk_32khz_1:
   418 00000358 BB[21130000]            	mov	ebx, load_32khz_stereo_8_bit
   419 0000035D 803D[28230000]01        	cmp	byte [stmo], 1 
   420 00000364 7505                    	jne	short chk_32khz_2
   421 00000366 BB[AE120000]            	mov	ebx, load_32khz_mono_8_bit
   422                                  chk_32khz_2:
   423 0000036B B8AA2A0000              	mov	eax, 10922
   424 00000370 BA03000000              	mov	edx, 3
   425 00000375 B902000000              	mov	ecx, 2
   426                                  	;jmp	short set_sizes 
   427                                  set_sizes:
   428 0000037A 803D[28230000]01        	cmp	byte [stmo], 1
   429 00000381 7402                    	je	short ss_1
   430 00000383 D1E0                    	shl	eax, 1
   431                                  ss_1:
   432 00000385 803D[29230000]08        	cmp	byte [bps], 8
   433 0000038C 7602                    	jna	short ss_2
   434                                  	; 16 bit samples
   435 0000038E D1E0                    	shl	eax, 1
   436                                  ss_2:
   437 00000390 A3[CD030000]            	mov	[loadsize], eax
   438 00000395 F7E2                    	mul	edx
   439                                  	;cmp	ecx, 1
   440                                  	;je	short ss_3
   441                                  ;ss_3:
   442 00000397 F7F1                    	div	ecx
   443 00000399 8A0D[A4230000]          	mov	cl, [fbs_shift]
   444 0000039F D3E0                    	shl	eax, cl
   445                                  	; 26/11/2023
   446                                  	;shr	eax, 1	; buffer size is 16 bit sample count
   447 000003A1 A3[D1030000]            	mov	[buffersize], eax ; buffer size in bytes 
   448 000003A6 891D[C9030000]          	mov	[loadfromwavfile], ebx
   449 000003AC EB27                    	jmp	short PlayNow
   450                                  
   451                                  vra_needed:
   452                                  	sys	_msg, msg_no_vra, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003AE BB[B1210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003B3 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000003B8 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000003BD B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000003C2 CD40                <1>  int 40h
   453 000003C4 E9D1000000              	jmp	Exit
   454                                  
   455                                  	; 26/11/2023
   456                                  	; 13/11/2023
   457                                  loadfromwavfile:
   458 000003C9 [79050000]              	dd	loadFromFile
   459                                  loadsize:	; read from wav file
   460 000003CD 00000000                	dd	0
   461                                  buffersize:	; write to DMA buffer
   462 000003D1 00000100                	dd	65536 ; bytes
   463                                  
   464                                  PlayNow: 
   465                                  
   466                                  ; 26/11/2023
   467                                  %if 1
   468                                  	; Allocate Audio Buffer (for user)
   469                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   470                                  	; 26/11/2023
   471                                  	sys	_audio, 0200h, [buffersize], audio_buffer
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003D5 BB00020000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003DA 8B0D[D1030000]      <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000003E0 BA[00300000]        <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000003E5 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000003EA CD40                <1>  int 40h
   472 000003EC 731B                    	jnc	short _2
   473                                  
   474                                  	; 26/11/2023 - temporary
   475                                  	;sys	_msg, test_1, 255, 0Ch
   476                                  
   477                                  error_exit:
   478                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003EE BB[60210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003F3 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000003F8 BA0E000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000003FD B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000402 CD40                <1>  int 40h
   479 00000404 E991000000              	jmp	Exit
   480                                  _2:
   481                                  	; DIRECT CGA (TEXT MODE) MEMORY ACCESS
   482                                  	; bl = 0, bh = 4
   483                                  	; Direct access/map to CGA (Text) memory (0B8000h)
   484                                  
   485                                  	sys	_video, 0400h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000409 BB00040000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000040E B81F000000          <1>  mov eax, %1
    86                              <1> 
    87 00000413 CD40                <1>  int 40h
   486 00000415 3D00800B00              	cmp	eax, 0B8000h
   487 0000041A 75D2                    	jne	short error_exit
   488                                  
   489                                  	; 01/06/2024
   490                                  	; Initialize Audio Device (bh = 3)
   491                                  	sys	_audio, 0301h, 0, audio_int_handler 
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000041C BB01030000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000421 B900000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000426 BA[65050000]        <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000042B B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000430 CD40                <1>  int 40h
   492                                  	;jc	short error_exit
   493 00000432 0F8216FDFFFF            	jc	init_err
   494                                  _3:
   495                                  
   496                                  %endif
   497                                  
   498                                  ;
   499                                  ; position file pointer to start in actual wav data
   500                                  ; MUCH improvement should really be done here to check if sample size is
   501                                  ; supported, make sure there are 2 channels, etc.  
   502                                  ;
   503                                          ;mov     ah, 42h
   504                                          ;mov     al, 0	; from start of file
   505                                          ;mov     bx, [FileHandle]
   506                                          ;xor     cx, cx
   507                                          ;mov     dx, 44	; jump past .wav/riff header
   508                                          ;int     21h
   509                                  
   510                                  	sys	_seek, [FileHandle], 44, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000438 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000043E B92C000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000443 BA00000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000448 B813000000          <1>  mov eax, %1
    86                              <1> 
    87 0000044D CD40                <1>  int 40h
   511                                  
   512                                  	sys	_msg, nextline, 255, 07h ; 01/05/2017
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000044F BB[36220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000454 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000459 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000045E B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000463 CD40                <1>  int 40h
   513                                  
   514                                  ; play the .wav file. Most of the good stuff is in here.
   515                                  
   516 00000465 E8C2010000                      call    PlayWav
   517                                  
   518                                  ; close the .wav file and exit.
   519                                  
   520                                  StopPlaying:
   521                                  	; Stop Playing
   522                                  	sys	_audio, 0700h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000046A BB00070000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000046F B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000474 CD40                <1>  int 40h
   523                                  	; Cancel callback service (for user)
   524                                  	sys	_audio, 0900h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000476 BB00090000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000047B B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000480 CD40                <1>  int 40h
   525                                  	; Deallocate Audio Buffer (for user)
   526                                  	sys	_audio, 0A00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000482 BB000A0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000487 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000048C CD40                <1>  int 40h
   527                                  	; Disable Audio Device
   528                                  	sys	_audio, 0C00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000048E BB000C0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000493 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000498 CD40                <1>  int 40h
   529                                  Exit:  
   530 0000049A E847000000                      call    closeFile
   531                                           
   532                                  	sys	_exit	; Bye!
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000049F B801000000          <1>  mov eax, %1
    86                              <1> 
    87 000004A4 CD40                <1>  int 40h
   533                                  here:
   534 000004A6 EBFE                    	jmp	short here
   535                                  
   536                                  pmsg_usage:
   537                                  	sys	_msg, msg_usage, 255, 0Bh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004A8 BB[FD200000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000004AD B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000004B2 BA0B000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004B7 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000004BC CD40                <1>  int 40h
   538 000004BE EBDA                    	jmp	short Exit
   539                                  
   540                                  	; 25/11/2023
   541                                  DetectAC97:
   542                                  	; Detect (BH=1) AC'97 (BL=2) Audio Device
   543                                          sys	_audio, 0102h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004C0 BB02010000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004C5 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000004CA CD40                <1>  int 40h
   544                                  
   545                                  ; 01/06/2024
   546                                  %if 0
   547                                  	jc	short DetectAC97_retn
   548                                  
   549                                  	; 25/11/2023
   550                                  	; Get AC'97 Codec info
   551                                  	; (Function 14, sub function 1)
   552                                  	sys	_audio, 0E01h
   553                                  	; Save Variable Rate Audio support bit
   554                                  	and	al, 1
   555                                  	mov	[VRA], al
   556                                  %endif
   557                                  
   558                                  DetectAC97_retn:
   559 000004CC C3                      	retn
   560                                  
   561                                  ;open or create file
   562                                  ;
   563                                  ;input: ds:dx-->filename (asciiz)
   564                                  ;       al=file Mode (create or open)
   565                                  ;output: none  cs:[FileHandle] filled
   566                                  ;
   567                                  openFile:
   568                                  	;mov	ah, 3Bh	; start with a mode
   569                                  	;add	ah, al	; add in create or open mode
   570                                  	;xor	ecx, ecx
   571                                  	;int	21h
   572                                  	;jc	short _of1
   573                                  	;;mov	[cs:FileHandle], ax
   574                                  
   575                                  	sys	_open, wav_file_name, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004CD BB[51230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000004D2 B900000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004D7 B805000000          <1>  mov eax, %1
    86                              <1> 
    87 000004DC CD40                <1>  int 40h
   576 000004DE 7205                    	jc	short _of1
   577                                  
   578 000004E0 A3[44200000]            	mov	[FileHandle], eax
   579                                  _of1:
   580 000004E5 C3                      	retn
   581                                  
   582                                  ; close the currently open file
   583                                  ; input: none, uses cs:[FileHandle]
   584                                  closeFile:
   585 000004E6 833D[44200000]FF        	cmp	dword [FileHandle], -1
   586 000004ED 7417                    	je	short _cf1
   587                                  	;mov    bx, [FileHandle]  
   588                                  	;mov    ax, 3E00h
   589                                          ;int    21h              ;close file
   590                                  
   591                                  	sys	_close, [FileHandle]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004EF 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004F5 B806000000          <1>  mov eax, %1
    86                              <1> 
    87 000004FA CD40                <1>  int 40h
   592 000004FC C705[44200000]FFFF-     	mov 	dword [FileHandle], -1
   592 00000504 FFFF               
   593                                  _cf1:
   594 00000506 C3                      	retn
   595                                  
   596                                  getSampleRate:
   597                                  	
   598                                  ; reads the sample rate from the .wav file.
   599                                  ; entry: none - assumes file is already open
   600                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   601                                  ;	cx = number of channels (mono=1, stereo=2)
   602                                  ;	dx = bits per sample (8, 16)
   603                                  
   604 00000507 53                      	push    ebx
   605                                  
   606                                          ;mov	ah, 42h
   607                                          ;mov	al, 0	; from start of file
   608                                          ;mov	bx, [FileHandle]
   609                                          ;xor	ecx, ecx
   610                                          ;mov	dx, 08h	; "WAVE"
   611                                          ;int	21h
   612                                  	
   613                                  	sys	_seek, [FileHandle], 8, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000508 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000050E B908000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000513 BA00000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000518 B813000000          <1>  mov eax, %1
    86                              <1> 
    87 0000051D CD40                <1>  int 40h
   614                                  
   615                                          ;mov	dx, smpRBuff
   616                                          ;mov	cx, 28	; 28 bytes
   617                                  	;mov	ah, 3fh
   618                                          ;int	21h
   619                                  
   620                                  	sys	_read, [FileHandle], smpRBuff, 28
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000051F 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000525 B9[35230000]        <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000052A BA1C000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000052F B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000534 CD40                <1>  int 40h
   621                                  
   622 00000536 813D[35230000]5741-     	cmp	dword [smpRBuff], 'WAVE'
   622 0000053E 5645               
   623 00000540 7520                    	jne	short gsr_stc
   624                                  
   625 00000542 66833D[41230000]01      	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   626 0000054A 7516                    	jne	short gsr_stc
   627                                  
   628 0000054C 668B0D[43230000]        	mov	cx, [smpRBuff+14]	; return num of channels in CX
   629 00000553 66A1[45230000]                  mov     ax, [smpRBuff+16]	; return sample rate in AX
   630 00000559 668B15[4F230000]        	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   631                                  gsr_retn:
   632 00000560 5B                              pop     ebx
   633 00000561 C3                              retn
   634                                  gsr_stc:
   635 00000562 F9                      	stc
   636 00000563 EBFB                    	jmp	short gsr_retn
   637                                  
   638                                  audio_int_handler:
   639                                  	; 13/12/2024
   640                                  	; 18/08/2020 (14/10/2020, 'wavplay2.s')
   641                                  
   642                                  	;mov	byte [srb], 1 ; interrupt (or signal response byte)
   643                                  	
   644                                  	;cmp	byte [cbs_busy], 1
   645                                  	;jnb	short _callback_bsy_retn
   646                                  	
   647                                  	;mov	byte [cbs_busy], 1
   648                                  
   649                                  	; 13/12/2024
   650                                  	;mov	al, [half_buff]
   651                                  	;
   652                                  	;cmp	al, 1
   653                                  	;jb	short _callback_retn
   654                                  
   655                                  	; 18/08/2020
   656                                  	;mov	byte [srb], 1
   657                                  	; 13/12/2024
   658 00000565 FE05[32230000]          	inc	byte [srb]
   659                                  
   660                                  	; 13/12/2024
   661                                  	;xor	byte [half_buff], 3 ; 2->1, 1->2
   662                                  
   663                                  	; 13/12/2024
   664                                  	;add	al, '0'
   665                                  ;tL0:	; 26/11/2023
   666                                  	;mov	ah, 4Eh
   667                                  	;mov	ebx, 0B8000h ; video display page address
   668                                  	;mov	[ebx], ax ; show playing buffer (1, 2)
   669                                  ;_callback_retn:
   670                                  	;;mov	byte [cbs_busy], 0
   671                                  ;_callback_bsy_retn:
   672                                  	sys	_rele ; return from callback service 
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000056B B827000000          <1>  mov eax, %1
    86                              <1> 
    87 00000570 CD40                <1>  int 40h
   673                                  	; we must not come here !
   674                                  	sys	_exit
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000572 B801000000          <1>  mov eax, %1
    86                              <1> 
    87 00000577 CD40                <1>  int 40h
   675                                  	
   676                                  loadFromFile:
   677                                  	; 26/11/2023
   678 00000579 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
   679                                  					; last of the file?
   680 00000580 7402                    	jz	short lff_0		; no
   681 00000582 F9                      	stc
   682 00000583 C3                      	retn
   683                                  lff_0:
   684                                  	; 13/06/2017
   685                                  	;mov	edx, BUFFERSIZE
   686                                  	; 26/11/2023
   687 00000584 BF[00300000]            	mov	edi, audio_buffer
   688 00000589 8B15[D1030000]          	mov	edx, [buffersize]	; bytes
   689 0000058F 8A0D[A4230000]          	mov	cl, [fbs_shift]   
   690 00000595 20C9                    	and	cl, cl
   691 00000597 7409                    	jz	short lff_1 ; stereo, 16 bit
   692                                  
   693                                  	; fbs_shift =
   694                                  	;	2 for mono and 8 bit sample (multiplier = 4)
   695                                  	;	1 for mono or 8 bit sample (multiplier = 2)
   696 00000599 D3EA                    	shr	edx, cl
   697                                  	;inc	edx
   698                                  
   699 0000059B BE[00300100]            	mov     esi, temp_buffer
   700 000005A0 EB02                    	jmp	short lff_2
   701                                  lff_1:
   702                                  	;mov	esi, audio_buffer
   703 000005A2 89FE                    	mov	esi, edi ; audio_buffer
   704                                  lff_2:
   705                                  	; 17/03/2017
   706                                  	; esi = buffer address
   707                                  	; edx = buffer size
   708                                   
   709                                  	; 26/11/2023
   710                                  	; load file into memory
   711                                  	sys 	_read, [FileHandle], esi
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000005A4 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000005AA 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000005AC B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000005B1 CD40                <1>  int 40h
   712                                  	; 14/12/2024
   713 000005B3 8B0D[D1030000]          	mov	ecx, [buffersize]
   714                                  	;jc	short padfill ; error !
   715                                  	; 14/12/2024
   716 000005B9 7255                    	jc	short lff_10
   717                                  
   718 000005BB 21C0                    	and	eax, eax
   719 000005BD 7453                    	jz	short padfill
   720                                  lff_3:
   721                                  	; 26/11/2023
   722 000005BF 8A1D[A4230000]          	mov	bl, [fbs_shift]
   723 000005C5 20DB                    	and	bl, bl
   724 000005C7 7456                    	jz	short lff_11
   725                                  
   726                                  	; 14/12/2024
   727                                  	;sub	ecx, eax
   728                                  	;mov	ebp, ecx
   729                                  	; 14/12/2024
   730 000005C9 29C2                    	sub	edx, eax
   731                                  
   732                                  	;mov	esi, temp_buffer
   733                                  	;mov	edi, audio_buffer
   734 000005CB 89C1                    	mov	ecx, eax   ; byte count
   735                                  
   736 000005CD 803D[29230000]08        	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   737 000005D4 751E                    	jne	short lff_6 ; 16 bit samples
   738                                  	; 8 bit samples
   739 000005D6 FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
   740 000005D8 740E                    	jz	short lff_5 ; 8 bit, stereo
   741                                  lff_4:
   742                                  	; mono & 8 bit
   743 000005DA AC                      	lodsb
   744 000005DB 2C80                    	sub	al, 80h ; 08/11/2023
   745 000005DD C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   746 000005E0 66AB                    	stosw	; left channel
   747 000005E2 66AB                    	stosw	; right channel
   748 000005E4 E2F4                    	loop	lff_4
   749 000005E6 EB16                    	jmp	short lff_8
   750                                  lff_5:
   751                                  	; stereo & 8 bit
   752 000005E8 AC                      	lodsb
   753 000005E9 2C80                    	sub	al, 80h ; 08/11/2023
   754 000005EB C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   755 000005EE 66AB                    	stosw
   756 000005F0 E2F6                    	loop	lff_5			
   757 000005F2 EB0A                    	jmp	short lff_8
   758                                  lff_6:
   759 000005F4 D1E9                    	shr	ecx, 1 ; word count
   760                                  lff_7:
   761 000005F6 66AD                    	lodsw
   762 000005F8 66AB                    	stosw	; left channel
   763 000005FA 66AB                    	stosw	; right channel
   764 000005FC E2F8                    	loop	lff_7
   765                                  lff_8:
   766                                  	; 27/11/2023
   767 000005FE F8                      	clc
   768                                  	; 14/12/2024
   769                                  	;mov	ecx, ebp
   770                                  	;jecxz	endLFF_retn
   771 000005FF 09D2                    	or	edx, edx
   772 00000601 741B                    	jz	short endLFF_retn
   773                                  	
   774                                  	; 14/12/2024
   775 00000603 B9[00300000]            	mov	ecx, audio_buffer
   776 00000608 030D[D1030000]          	add	ecx, [buffersize]
   777 0000060E 29F9                    	sub	ecx, edi
   778                                  
   779                                  	; 14/12/2024
   780                                  lff_10:
   781 00000610 31C0                    	xor	eax, eax ; silence
   782                                  padfill:
   783 00000612 D1E9                    	shr	ecx, 1 
   784 00000614 F366AB                  	rep	stosw
   785                                  lff_9:
   786 00000617 800D[30230000]01                or	byte [flags], ENDOFFILE	; end of file flag
   787                                  endLFF_retn:
   788 0000061E C3                              retn
   789                                  
   790                                  lff_11:
   791                                  	; 16 bit stereo
   792                                  	; ecx = buffer size
   793                                  	; eax = read count
   794 0000061F 29C1                    	sub	ecx, eax
   795 00000621 76FB                    	jna	short endLFF_retn
   796 00000623 01C7                    	add	edi, eax  ; audio_buffer + eax
   797 00000625 EBE9                    	jmp	short lff_10 ; padfill
   798                                  
   799                                  error_exit_2:
   800                                  	; 26/11/2023 - temporary
   801                                  	;sys	_msg, test_2, 255, 0Ch
   802                                  
   803 00000627 E9C2FDFFFF              	jmp	error_exit
   804                                  	
   805                                  	; 26/11/2023 - temporary
   806                                  ;test_1:
   807                                  ;	db 13, 10, 'Test 1', 13,10, 0
   808                                  ;test_2:
   809                                  ;	db 13, 10, 'Test 2', 13,10, 0
   810                                  	
   811                                  PlayWav:
   812                                  	; 26/11/2023
   813                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   814                                  	; 13/06/2017
   815                                  	; Convert 8 bit samples to 16 bit samples
   816                                  	; and convert mono samples to stereo samples
   817                                  
   818                                  	; 26/11/2023
   819                                  	; load 32768 bytes into audio buffer
   820                                  	;mov	edi, audio_buffer
   821                                  	;;mov	edx, BUFFERSIZE
   822                                  	; 26/11/2023
   823                                  	;mov	edx, [buffersize]
   824                                  	;call	loadFromFile
   825                                  	; 26/11/2023
   826 0000062C FF15[C9030000]          	call	dword [loadfromwavfile]
   827 00000632 72F3                    	jc	short error_exit_2
   828 00000634 C605[31230000]01        	mov	byte [half_buff], 1 ; (DMA) Buffer 1
   829                                  
   830                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   831 0000063B F605[30230000]01        	test    byte [flags], ENDOFFILE  ; end of file
   832 00000642 7512                    	jnz	short _6 ; yes
   833                                  			 ; bypass filling dma half buffer 2
   834                                  
   835                                  	; bh = 16 : update (current, first) dma half buffer
   836                                  	; bl = 0  : then switch to the next (second) half buffer
   837                                  	sys	_audio, 1000h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000644 BB00100000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000649 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000064E CD40                <1>  int 40h
   838                                  
   839                                  	; 18/08/2020
   840                                  	; [audio_flag] = 1 (in TRDOS 386 kernel)
   841                                  
   842                                  	; audio_buffer must be filled again after above system call 
   843                                  	; (Because audio interrupt will be generated by AC97 hardware
   844                                  	; at the end of the first half of dma buffer.. so, 
   845                                  	; the second half must be ready. 'sound_play' will use it.)
   846                                  
   847                                  	; 26/11/2023
   848                                  	;mov	edi, audio_buffer
   849                                  	;;mov	edx, BUFFERSIZE
   850                                  	; 26/11/2023
   851                                  	;mov	edx, [buffersize]
   852                                  	;call	loadFromFile
   853                                  	; 26/11/2023
   854 00000650 FF15[C9030000]          	call	dword [loadfromwavfile]
   855                                  	;jc	short p_return
   856                                  _6:
   857                                  	; Set Master Volume Level (BL=0 or 80h)
   858                                  	; 	for next playing (BL>=80h)
   859                                  	;sys	_audio, 0B80h, 1D1Dh
   860                                  	sys	_audio, 0B00h, 1D1Dh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000656 BB000B0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000065B B91D1D0000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000660 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000665 CD40                <1>  int 40h
   861                                  
   862                                  	; 18/08/2020
   863                                  	;mov	byte [volume_level], 1Dh
   864 00000667 880D[33230000]          	mov	[volume_level], cl
   865                                  
   866                                  	; Start	to play
   867 0000066D A0[29230000]            	mov	al, [bps]
   868 00000672 C0E804                  	shr	al, 4 ; 8 -> 0, 16 -> 1
   869 00000675 D0E0                    	shl	al, 1 ; 16 -> 2, 8 -> 0
   870 00000677 8A1D[28230000]          	mov	bl, [stmo]
   871 0000067D FECB                    	dec	bl
   872 0000067F 08C3                    	or	bl, al
   873 00000681 668B0D[2A230000]        	mov	cx, [sample_rate] 
   874 00000688 B704                    	mov	bh, 4 ; start to play
   875                                  	sys	_audio
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000068A B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000068F CD40                <1>  int 40h
   876                                  
   877                                  	;mov	ebx, 0B8000h ; video display page address
   878                                  	;mov	ah, 4Eh
   879                                  	;mov	al, [half_buffer]
   880                                  	;mov	[ebx], ax ; show playing buffer (1, 2)
   881                                  
   882                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   883                                  	; Here..
   884                                  	; If byte [flags] <> ENDOFFILE ...
   885                                  	; user's audio_buffer has been copied to dma half buffer 2
   886                                  
   887                                  	; [audio_flag] = 0 (in TRDOS 386 kernel)
   888                                  
   889                                  	; audio_buffer must be filled again after above system call 
   890                                  	; (Because, audio interrupt will be generated by VT8237R
   891                                  	; at the end of the first half of dma buffer.. so, 
   892                                  	; the 2nd half of dma buffer is ready but the 1st half
   893                                  	; must be filled again.)
   894                                  
   895                                  ; 14/12/2024
   896                                  %if 0
   897                                  	; 18/08/2020
   898                                  	test    byte [flags], ENDOFFILE  ; end of file
   899                                  	jnz	short p_loop ; yes
   900                                  
   901                                  	; 18/08/2020
   902                                  	; load 32768 bytes into audio buffer
   903                                  	;; (for the second half of DMA buffer)
   904                                  	; 27/11/2023
   905                                  	; 20/05/2017
   906                                  	;mov	edi, audio_buffer
   907                                  	;mov	edx, BUFFERSIZE
   908                                  	; 26/11/2023
   909                                  	;mov	edx, [buffersize]
   910                                  	;call	loadFromFile
   911                                  	; 26/11/2023
   912                                  	call	dword [loadfromwavfile]
   913                                  	;jc	short p_return
   914                                  	;mov	byte [half_buff], 2 ; (DMA) Buffer 2
   915                                  %endif
   916                                  
   917                                  	; we need to wait for 'SRB' (audio interrupt)
   918                                  	; (we can not return from 'PlayWav' here 
   919                                  	;  even if we have got an error from file reading)
   920                                  	; ((!!current audio data must be played!!))
   921                                  
   922                                  	; 18/08/2020
   923                                  	;mov	byte [srb], 1
   924                                  
   925                                  p_loop:
   926                                  	;mov	ah, 1		; any key pressed?
   927                                  	;int	32h		; no, Loop.
   928                                  	;jz	short q_loop
   929                                  	;
   930                                  	;mov	ah, 0		; flush key buffer...
   931                                  	;int	32h
   932                                  
   933                                  	; 18/08/2020 (14/10/2017, 'wavplay2.s')
   934 00000691 803D[32230000]00        	cmp	byte [srb], 0
   935 00000698 7627                    	jna	short q_loop
   936 0000069A C605[32230000]00        	mov	byte [srb], 0
   937                                  	; 13/12/2024
   938 000006A1 8035[31230000]03        	xor	byte [half_buff], 3 ; 2->1, 1->2
   939                                  
   940                                  	; 27/11/2023
   941                                  	;mov	edi, audio_buffer
   942                                  	;mov	edx, BUFFERSIZE
   943                                  	; 26/11/2023
   944                                  	;mov	edx, [buffersize]
   945                                  	;call	loadFromFile
   946                                  	; 26/11/2023
   947 000006A8 FF15[C9030000]          	call	dword [loadfromwavfile]
   948 000006AE 7223                    	jc	short p_return
   949                                  
   950                                  	; 14/12/2024
   951                                  	;;;
   952                                  	; bh = 16 : update (current, first) dma half buffer
   953                                  	; bl = 0  : then switch to the other half buffer
   954                                  	sys	_audio, 1000h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000006B0 BB00100000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000006B5 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000006BA CD40                <1>  int 40h
   955                                  	;;;;
   956                                  
   957                                  	; 13/12/2024
   958 000006BC E819000000              	call	tL0
   959                                  q_loop:
   960 000006C1 B401                    	mov     ah, 1		; any key pressed?
   961 000006C3 CD32                    	int     32h		; no, Loop.
   962 000006C5 74CA                    	jz	short p_loop
   963                                  
   964 000006C7 B400                    	mov     ah, 0		; flush key buffer...
   965 000006C9 CD32                    	int     32h
   966                                  
   967 000006CB 3C2B                    	cmp	al, '+' ; increase sound volume
   968 000006CD 741D                    	je	short inc_volume_level
   969 000006CF 3C2D                    	cmp	al, '-'
   970 000006D1 743C                    	je	short dec_volume_level
   971                                  
   972                                  p_return:
   973 000006D3 C605[31230000]00        	mov	byte [half_buff], 0
   974                                  	; 13/12/2024
   975                                  	;call	tL0
   976                                  	;retn
   977                                  
   978                                  	; 13/12/2024
   979                                  tL0:
   980 000006DA A0[31230000]            	mov	al, [half_buff]
   981 000006DF 0430                    	add	al, '0'
   982 000006E1 B44E                    	mov	ah, 4Eh
   983 000006E3 BB00800B00              	mov	ebx, 0B8000h	; video display page address
   984 000006E8 668903                  	mov	[ebx], ax	; show playing buffer (1, 2)
   985 000006EB C3                      	retn
   986                                  	
   987                                  	; 18/08/2020 (14/10/2017, 'wavplay2.s')
   988                                  inc_volume_level:
   989 000006EC 8A0D[33230000]          	mov	cl, [volume_level]
   990 000006F2 80F91F                  	cmp	cl, 1Fh ; 31
   991 000006F5 73CA                    	jnb	short q_loop
   992 000006F7 FEC1                    	inc	cl
   993                                  change_volume_level:
   994 000006F9 880D[33230000]          	mov	[volume_level], cl
   995 000006FF 88CD                    	mov	ch, cl
   996                                  	; Set Master Volume Level
   997                                  	sys	_audio, 0B00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000701 BB000B0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000706 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000070B CD40                <1>  int 40h
   998 0000070D EB82                    	jmp	short p_loop
   999                                  dec_volume_level:
  1000 0000070F 8A0D[33230000]          	mov	cl, [volume_level]
  1001 00000715 80F901                  	cmp	cl, 1 ; 1
  1002                                  	;jna	short p_loop
  1003                                  	; 14/12/2024
  1004 00000718 76A7                    	jna	short q_loop
  1005 0000071A FEC9                    	dec	cl
  1006 0000071C EBDB                    	jmp	short change_volume_level
  1007                                  
  1008                                  write_audio_dev_info:
  1009                                  	; EBX = Message address
  1010                                  	; ECX = Max. message length (or stop on ZERO character)
  1011                                  	;	(1 to 255)
  1012                                  	; DL  = Message color (07h = light gray, 0Fh = white) 
  1013                                       	sys 	_msg, msgAudioCardInfo, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000071E BB[D4200000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000723 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000728 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000072D B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000732 CD40                <1>  int 40h
  1014 00000734 C3                      	retn
  1015                                  
  1016                                  write_wav_file_info:
  1017                                  	; 01/05/2017
  1018                                  	sys	_msg, msgWavFileName, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000735 BB[EA210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000073A B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000073F BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000744 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000749 CD40                <1>  int 40h
  1019                                  	sys	_msg, wav_file_name, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000074B BB[51230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000750 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000755 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000075A B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000075F CD40                <1>  int 40h
  1020                                  
  1021                                  write_sample_rate:
  1022                                  	; 01/05/2017
  1023 00000761 66A1[2A230000]          	mov	ax, [sample_rate]
  1024                                  	; ax = sample rate (hertz)
  1025 00000767 31D2                    	xor	edx, edx
  1026 00000769 66B90A00                	mov	cx, 10
  1027 0000076D 66F7F1                  	div	cx
  1028 00000770 0015[0F220000]          	add	[msgHertz+4], dl
  1029 00000776 29D2                    	sub	edx, edx
  1030 00000778 66F7F1                  	div	cx
  1031 0000077B 0015[0E220000]          	add	[msgHertz+3], dl
  1032 00000781 29D2                    	sub	edx, edx
  1033 00000783 66F7F1                  	div	cx
  1034 00000786 0015[0D220000]          	add	[msgHertz+2], dl
  1035 0000078C 29D2                    	sub	edx, edx
  1036 0000078E 66F7F1                  	div	cx
  1037 00000791 0015[0C220000]          	add	[msgHertz+1], dl
  1038 00000797 0005[0B220000]          	add	[msgHertz], al
  1039                                  	
  1040                                  	sys	_msg, msgSampleRate, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000079D BB[FC210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007A2 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000007A7 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000007AC B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000007B1 CD40                <1>  int 40h
  1041                                  
  1042 000007B3 BE[26220000]            	mov	esi, msg16Bits
  1043 000007B8 803D[29230000]10        	cmp	byte [bps], 16
  1044 000007BF 7405                    	je	short wsr_1
  1045 000007C1 BE[16220000]            	mov	esi, msg8Bits
  1046                                  wsr_1:
  1047                                  	sys	_msg, esi, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000007C6 89F3                <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007C8 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000007CD BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000007D2 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000007D7 CD40                <1>  int 40h
  1048                                  
  1049 000007D9 BE[1F220000]            	mov	esi, msgMono
  1050 000007DE 803D[28230000]01        	cmp	byte [stmo], 1
  1051 000007E5 7405                    	je	short wsr_2
  1052 000007E7 BE[30220000]            	mov	esi, msgStereo		
  1053                                  wsr_2:
  1054                                  	sys	_msg, esi, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000007EC 89F3                <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007EE B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000007F3 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000007F8 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000007FD CD40                <1>  int 40h
  1055 000007FF C3                              retn
  1056                                  
  1057                                  write_ac97_pci_dev_info:
  1058                                  	; 06/06/2017
  1059                                  	; 03/06/2017
  1060                                  	; BUS/DEV/FN
  1061                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1062                                  	; DEV/VENDOR
  1063                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1064                                  
  1065 00000800 8B35[A5230000]          	mov	esi, [dev_vendor]
  1066 00000806 89F0                    	mov	eax, esi
  1067 00000808 0FB6D8                  	movzx	ebx, al
  1068 0000080B 88DA                    	mov	dl, bl
  1069 0000080D 80E30F                  	and	bl, 0Fh
  1070 00000810 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1071 00000816 A2[7E220000]            	mov	[msgVendorId+3], al
  1072 0000081B 88D3                    	mov	bl, dl
  1073 0000081D C0EB04                  	shr	bl, 4
  1074 00000820 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1075 00000826 A2[7D220000]            	mov	[msgVendorId+2], al
  1076 0000082B 88E3                    	mov	bl, ah
  1077 0000082D 88DA                    	mov	dl, bl
  1078 0000082F 80E30F                  	and	bl, 0Fh
  1079 00000832 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1080 00000838 A2[7C220000]            	mov	[msgVendorId+1], al
  1081 0000083D 88D3                    	mov	bl, dl
  1082 0000083F C0EB04                  	shr	bl, 4
  1083 00000842 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1084 00000848 A2[7B220000]            	mov	[msgVendorId], al
  1085 0000084D C1E810                  	shr	eax, 16
  1086 00000850 88C3                    	mov	bl, al
  1087 00000852 88DA                    	mov	dl, bl
  1088 00000854 80E30F                  	and	bl, 0Fh
  1089 00000857 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1090 0000085D A2[8F220000]            	mov	[msgDevId+3], al
  1091 00000862 88D3                    	mov	bl, dl
  1092 00000864 C0EB04                  	shr	bl, 4
  1093 00000867 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1094 0000086D A2[8E220000]            	mov	[msgDevId+2], al
  1095 00000872 88E3                    	mov	bl, ah
  1096 00000874 88DA                    	mov	dl, bl
  1097 00000876 80E30F                  	and	bl, 0Fh
  1098 00000879 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1099 0000087F A2[8D220000]            	mov	[msgDevId+1], al
  1100 00000884 88D3                    	mov	bl, dl
  1101 00000886 C0EB04                  	shr	bl, 4
  1102 00000889 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1103 0000088F A2[8C220000]            	mov	[msgDevId], al
  1104                                  
  1105 00000894 8B35[A9230000]          	mov	esi, [bus_dev_fn]
  1106 0000089A C1EE08                  	shr	esi, 8
  1107 0000089D 6689F0                  	mov	ax, si
  1108 000008A0 88C3                    	mov	bl, al
  1109 000008A2 88DA                    	mov	dl, bl
  1110 000008A4 80E307                  	and	bl, 7 ; bit 0,1,2
  1111 000008A7 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1112 000008AD A2[B3220000]            	mov	[msgFncNo+1], al
  1113 000008B2 88D3                    	mov	bl, dl
  1114 000008B4 C0EB03                  	shr	bl, 3
  1115 000008B7 88DA                    	mov	dl, bl
  1116 000008B9 80E30F                  	and	bl, 0Fh
  1117 000008BC 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1118 000008C2 A2[A5220000]            	mov	[msgDevNo+1], al
  1119 000008C7 88D3                    	mov	bl, dl
  1120 000008C9 C0EB04                  	shr	bl, 4
  1121 000008CC 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1122 000008D2 A2[A4220000]            	mov	[msgDevNo], al
  1123 000008D7 88E3                    	mov	bl, ah
  1124 000008D9 88DA                    	mov	dl, bl
  1125 000008DB 80E30F                  	and	bl, 0Fh
  1126 000008DE 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1127 000008E4 A2[99220000]            	mov	[msgBusNo+1], al
  1128 000008E9 88D3                    	mov	bl, dl
  1129 000008EB C0EB04                  	shr	bl, 4
  1130 000008EE 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1131 000008F4 A2[98220000]            	mov	[msgBusNo], al
  1132                                  
  1133 000008F9 66A1[AD230000]          	mov	ax, [ac97_NamBar]
  1134 000008FF 88C3                    	mov	bl, al
  1135 00000901 88DA                    	mov	dl, bl
  1136 00000903 80E30F                  	and	bl, 0Fh
  1137 00000906 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1138 0000090C A2[C2220000]            	mov	[msgNamBar+3], al
  1139 00000911 88D3                    	mov	bl, dl
  1140 00000913 C0EB04                  	shr	bl, 4
  1141 00000916 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1142 0000091C A2[C1220000]            	mov	[msgNamBar+2], al
  1143 00000921 88E3                    	mov	bl, ah
  1144 00000923 88DA                    	mov	dl, bl
  1145 00000925 80E30F                  	and	bl, 0Fh
  1146 00000928 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1147 0000092E A2[C0220000]            	mov	[msgNamBar+1], al
  1148 00000933 88D3                    	mov	bl, dl
  1149 00000935 C0EB04                  	shr	bl, 4
  1150 00000938 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1151 0000093E A2[BF220000]            	mov	[msgNamBar], al
  1152                                  
  1153 00000943 66A1[AF230000]          	mov	ax, [ac97_NabmBar]
  1154 00000949 88C3                    	mov	bl, al
  1155 0000094B 88DA                    	mov	dl, bl
  1156 0000094D 80E30F                  	and	bl, 0Fh
  1157 00000950 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1158 00000956 A2[D2220000]            	mov	[msgNabmBar+3], al
  1159 0000095B 88D3                    	mov	bl, dl
  1160 0000095D C0EB04                  	shr	bl, 4
  1161 00000960 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1162 00000966 A2[D1220000]            	mov	[msgNabmBar+2], al
  1163 0000096B 88E3                    	mov	bl, ah
  1164 0000096D 88DA                    	mov	dl, bl
  1165 0000096F 80E30F                  	and	bl, 0Fh
  1166 00000972 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1167 00000978 A2[D0220000]            	mov	[msgNabmBar+1], al
  1168 0000097D 88D3                    	mov	bl, dl
  1169 0000097F C0EB04                  	shr	bl, 4
  1170 00000982 8A83[39220000]          	mov	al, [ebx+hex_chars]
  1171 00000988 A2[CF220000]            	mov	[msgNabmBar], al
  1172                                  
  1173 0000098D 30E4                    	xor	ah, ah
  1174 0000098F A0[A3230000]            	mov	al, [ac97_int_ln_reg]
  1175 00000994 B10A                    	mov	cl, 10
  1176 00000996 F6F1                    	div	cl
  1177 00000998 660105[DB220000]        	add	[msgIRQ], ax
  1178 0000099F 20C0                    	and	al, al
  1179 000009A1 750D                    	jnz	short _w_ac97imsg_
  1180 000009A3 A0[DC220000]            	mov	al, [msgIRQ+1]
  1181 000009A8 B420                    	mov	ah, ' '
  1182 000009AA 66A3[DB220000]          	mov	[msgIRQ], ax
  1183                                  _w_ac97imsg_:
  1184                                  	sys	_msg, msgAC97Info, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009B0 BB[4A220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009B5 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009BA BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000009BF B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000009C4 CD40                <1>  int 40h
  1185                                  
  1186 000009C6 C3                              retn
  1187                                  
  1188                                  write_VRA_info:
  1189                                  	; 25/11/2023
  1190                                  	sys	_msg, msgVRAheader, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009C7 BB[E0220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009CC B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009D1 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000009D6 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000009DB CD40                <1>  int 40h
  1191 000009DD 803D[34230000]00        	cmp	byte [VRA], 0
  1192 000009E4 7617                    	jna	short _w_VRAi_no
  1193                                  _w_VRAi_yes:
  1194                                  	sys	_msg, msgVRAyes, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009E6 BB[EE220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009EB B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009F0 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000009F5 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000009FA CD40                <1>  int 40h
  1195 000009FC C3                      	retn
  1196                                  _w_VRAi_no:
  1197                                  	sys	_msg, msgVRAno, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009FD BB[F4220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000A02 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000A07 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000A0C B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000A11 CD40                <1>  int 40h
  1198 00000A13 C3                      	retn
  1199                                  
  1200                                  ; 26/11/2023
  1201                                  ; 25/11/2023 - playwav6.s (32 bit registers, TRDOS 386 adaption)
  1202                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  1203                                  ; 14/11/2023
  1204                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1205                                  ; --------------------------------------------------------
  1206                                  
  1207                                  ;;Note:	At the end of every buffer load,
  1208                                  ;;	during buffer switch/swap, there will be discontinuity
  1209                                  ;;	between the last converted sample and the 1st sample
  1210                                  ;;	of the next buffer.
  1211                                  ;;	(like as a dot noises vaguely between normal sound samples)
  1212                                  ;;	-To avoid this defect, the 1st sample of
  1213                                  ;;	the next buffer may be read from the wav file but
  1214                                  ;;	the file pointer would need to be set to 1 sample back
  1215                                  ;;	again via seek system call. Time comsumption problem! -
  1216                                  ;;
  1217                                  ;;	Erdogan Tan - 15/11/2023
  1218                                  ;;
  1219                                  ;;	((If entire wav data would be loaded at once.. conversion
  1220                                  ;;	defect/noise would disappear.. but for DOS, to keep
  1221                                  ;;	64KB buffer limit is important also it is important
  1222                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1223                                  ;;	I have tested this program by using 2-30MB wav files.))
  1224                                  ;;
  1225                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1226                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1227                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1228                                  ;;			Realtek ALC850 codec.
  1229                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1230                                  
  1231                                  load_8khz_mono_8_bit:
  1232                                  	; 15/11/2023
  1233                                  	; 14/11/2023
  1234                                  	; 13/11/2023
  1235 00000A14 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1236                                  					; last of the file?
  1237 00000A1B 7402                    	jz	short lff8m_0		; no
  1238 00000A1D F9                      	stc
  1239 00000A1E C3                      	retn
  1240                                  
  1241                                  lff8m_0:
  1242 00000A1F BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1243                                          ;mov	edx, [loadsize]
  1244                                  
  1245                                  	; esi = buffer address
  1246                                  	;; edx = buffer size
  1247                                  
  1248                                  	; load file into memory
  1249                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000A24 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000A2A 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000A2C 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000A32 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000A37 CD40                <1>  int 40h
  1250 00000A39 7305                    	jnc	short lff8m_6
  1251 00000A3B E9AF000000              	jmp	lff8m_5  ; error !
  1252                                  
  1253                                  lff8m_6:
  1254 00000A40 BF[00300000]            	mov	edi, audio_buffer
  1255 00000A45 21C0                    	and	eax, eax
  1256 00000A47 0F8499000000            	jz	lff8_eof
  1257                                  
  1258 00000A4D 89C1                    	mov	ecx, eax		; byte count
  1259                                  lff8m_1:
  1260 00000A4F AC                      	lodsb
  1261 00000A50 A2[3B200000]            	mov	[previous_val], al
  1262 00000A55 2C80                    	sub	al, 80h
  1263 00000A57 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1264 00000A5B 66AB                    	stosw		; original sample (left channel)
  1265 00000A5D 66AB                    	stosw		; original sample (right channel)
  1266                                  	;xor	eax, eax
  1267 00000A5F B080                    	mov	al, 80h
  1268 00000A61 49                      	dec	ecx
  1269 00000A62 7402                    	jz	short lff8m_2
  1270 00000A64 8A06                    	mov	al, [esi]
  1271                                  lff8m_2:
  1272                                  	;mov	[next_val], ax
  1273 00000A66 88C7                    	mov	bh, al	; [next_val]
  1274 00000A68 8A25[3B200000]          	mov	ah, [previous_val]
  1275 00000A6E 00E0                    	add	al, ah	; [previous_val]
  1276 00000A70 D0D8                    	rcr	al, 1
  1277 00000A72 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  1278 00000A74 00E0                    	add	al, ah	; [previous_val]
  1279 00000A76 D0D8                    	rcr	al, 1	
  1280 00000A78 88C3                    	mov	bl, al 	; this is temporary interpolation value	
  1281 00000A7A 00E0                    	add	al, ah	; [previous_val]
  1282 00000A7C D0D8                    	rcr	al, 1
  1283 00000A7E 2C80                    	sub	al, 80h
  1284 00000A80 66C1E008                	shl	ax, 8	
  1285 00000A84 66AB                    	stosw		; this is 1st interpolated sample (L)
  1286 00000A86 66AB                    	stosw		; this is 1st interpolated sample (R)
  1287 00000A88 88D8                    	mov	al, bl
  1288 00000A8A 00D0                    	add	al, dl
  1289 00000A8C D0D8                    	rcr	al, 1
  1290 00000A8E 2C80                    	sub	al, 80h
  1291 00000A90 66C1E008                	shl	ax, 8
  1292 00000A94 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1293 00000A96 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1294 00000A98 88D0                    	mov	al, dl
  1295 00000A9A 2C80                    	sub	al, 80h
  1296 00000A9C 66C1E008                	shl	ax, 8
  1297 00000AA0 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1298 00000AA2 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1299                                  	;mov	al, [next_val]
  1300 00000AA4 88F8                    	mov	al, bh
  1301 00000AA6 00D0                    	add	al, dl
  1302 00000AA8 D0D8                    	rcr	al, 1
  1303 00000AAA 88C3                    	mov	bl, al	; this is temporary interpolation value
  1304 00000AAC 00D0                    	add	al, dl
  1305 00000AAE D0D8                    	rcr	al, 1
  1306 00000AB0 2C80                    	sub	al, 80h
  1307 00000AB2 66C1E008                	shl	ax, 8
  1308 00000AB6 66AB                    	stosw		; this is 4th interpolated sample (L)
  1309 00000AB8 66AB                    	stosw		; this is 4th interpolated sample (R)
  1310                                  	;mov	al, [next_val]
  1311 00000ABA 88F8                    	mov	al, bh
  1312 00000ABC 00D8                    	add	al, bl
  1313 00000ABE D0D8                    	rcr	al, 1
  1314 00000AC0 2C80                    	sub	al, 80h
  1315 00000AC2 66C1E008                	shl	ax, 8
  1316 00000AC6 66AB                    	stosw		; this is 5th interpolated sample (L)
  1317 00000AC8 66AB                    	stosw		; this is 5th interpolated sample (R)
  1318                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1319 00000ACA 09C9                    	or	ecx, ecx
  1320 00000ACC 7581                    	jnz	short lff8m_1
  1321                                  
  1322                                  	; --------------
  1323                                  
  1324                                  lff8s_3:
  1325                                  lff8m_3:
  1326                                  lff8s2_3:
  1327                                  lff8m2_3:
  1328                                  lff16s_3:
  1329                                  lff16m_3:
  1330                                  lff16s2_3:
  1331                                  lff16m2_3:
  1332                                  lff24_3:
  1333                                  lff32_3:
  1334                                  lff44_3:
  1335                                  lff22_3:
  1336                                  lff11_3:
  1337                                  	; 08/12/2024 (BugFix)
  1338                                  	; 01/06/2024 (BugFix)
  1339 00000ACE 8B0D[D1030000]          	mov	ecx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1340                                  	;shl	ecx, 1	; byte count ; Bug !
  1341                                  	; 08/12/2024
  1342 00000AD4 81C1[00300000]          	add	ecx, audio_buffer
  1343 00000ADA 29F9                    	sub	ecx, edi
  1344 00000ADC 7607                    	jna	short lff8m_4
  1345                                  	;inc	ecx
  1346 00000ADE C1E902                  	shr	ecx, 2
  1347 00000AE1 31C0                    	xor	eax, eax ; fill (remain part of) buffer with zeros
  1348 00000AE3 F3AB                    	rep	stosd
  1349                                  lff8m_4:
  1350                                  	; 01/06/2024 (BugFix)
  1351                                  	; cf=1 ; Bug !
  1352                                  	; 08/12/2024
  1353                                  	;clc
  1354 00000AE5 C3                      	retn
  1355                                  
  1356                                  lff8_eof:
  1357                                  lff16_eof:
  1358                                  lff24_eof:
  1359                                  lff32_eof:
  1360                                  lff44_eof:
  1361                                  lff22_eof:
  1362                                  lff11_eof:
  1363                                  	; 15/11/2023
  1364 00000AE6 C605[30230000]01        	mov	byte [flags], ENDOFFILE
  1365 00000AED EBDF                    	jmp	short lff8m_3
  1366                                  
  1367                                  lff8s_5:
  1368                                  lff8m_5:
  1369                                  lff8s2_5:
  1370                                  lff8m2_5:
  1371                                  lff16s_5:
  1372                                  lff16m_5:
  1373                                  lff16s2_5:
  1374                                  lff16m2_5:
  1375                                  lff24_5:
  1376                                  lff32_5:
  1377                                  lff44_5:
  1378                                  lff22_5:
  1379                                  lff11_5:
  1380 00000AEF B021                    	mov	al, '!'  ; error
  1381 00000AF1 E8E4FBFFFF              	call	tL0
  1382                                  	
  1383                                  	;jmp	short lff8m_3
  1384                                  	; 15/11/2023
  1385 00000AF6 EBEE                    	jmp	lff8_eof
  1386                                  
  1387                                  	; --------------
  1388                                  
  1389                                  load_8khz_stereo_8_bit:
  1390                                  	; 15/11/2023
  1391                                  	; 14/11/2023
  1392                                  	; 13/11/2023
  1393 00000AF8 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1394                                  					; last of the file?
  1395 00000AFF 7402                    	jz	short lff8s_0		; no
  1396 00000B01 F9                      	stc
  1397 00000B02 C3                      	retn
  1398                                  
  1399                                  lff8s_0:
  1400 00000B03 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1401                                          ;mov	edx, [loadsize]
  1402                                  
  1403                                  	; esi = buffer address
  1404                                  	;; edx = buffer size
  1405                                  
  1406                                  	; load file into memory
  1407                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000B08 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000B0E 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000B10 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000B16 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000B1B CD40                <1>  int 40h
  1408 00000B1D 72D0                    	jc	short lff8s_5 ; error !
  1409                                  
  1410 00000B1F BF[00300000]            	mov	edi, audio_buffer
  1411                                  	
  1412 00000B24 D1E8                    	shr	eax, 1
  1413 00000B26 74BE                    	jz	short lff8_eof
  1414                                  
  1415 00000B28 89C1                    	mov	ecx, eax	; word count
  1416                                  lff8s_1:
  1417 00000B2A AC                      	lodsb
  1418 00000B2B A2[3B200000]            	mov	[previous_val_l], al
  1419 00000B30 2C80                    	sub	al, 80h
  1420 00000B32 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1421 00000B36 66AB                    	stosw		; original sample (L)
  1422 00000B38 AC                      	lodsb
  1423 00000B39 A2[3D200000]            	mov	[previous_val_r], al
  1424 00000B3E 2C80                    	sub	al, 80h
  1425 00000B40 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1426 00000B44 66AB                    	stosw		; original sample (R)
  1427                                  
  1428                                  	;xor	eax, eax
  1429 00000B46 66B88080                	mov	ax, 8080h
  1430 00000B4A 49                      	dec	ecx
  1431 00000B4B 7403                    	jz	short lff8s_2
  1432                                  		; convert 8 bit sample to 16 bit sample
  1433 00000B4D 668B06                  	mov	ax, [esi]
  1434                                  lff8s_2:
  1435 00000B50 A2[3F200000]            	mov	[next_val_l], al
  1436 00000B55 8825[41200000]          	mov	[next_val_r], ah
  1437 00000B5B 8A25[3B200000]          	mov	ah, [previous_val_l]
  1438 00000B61 00E0                    	add	al, ah
  1439 00000B63 D0D8                    	rcr	al, 1
  1440 00000B65 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1441 00000B67 00E0                    	add	al, ah
  1442 00000B69 D0D8                    	rcr	al, 1	
  1443 00000B6B 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1444 00000B6D 00E0                    	add	al, ah
  1445 00000B6F D0D8                    	rcr	al, 1
  1446 00000B71 2C80                    	sub	al, 80h
  1447 00000B73 66C1E008                	shl	ax, 8
  1448 00000B77 66AB                    	stosw		; this is 1st interpolated sample (L)
  1449 00000B79 A0[41200000]            	mov	al, [next_val_r]
  1450 00000B7E 8A25[3D200000]          	mov	ah, [previous_val_r]
  1451 00000B84 00E0                    	add	al, ah
  1452 00000B86 D0D8                    	rcr	al, 1
  1453 00000B88 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1454 00000B8A 00E0                    	add	al, ah
  1455 00000B8C D0D8                    	rcr	al, 1
  1456 00000B8E 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1457 00000B90 00E0                    	add	al, ah
  1458 00000B92 D0D8                    	rcr	al, 1
  1459 00000B94 2C80                    	sub	al, 80h
  1460 00000B96 66C1E008                	shl	ax, 8
  1461 00000B9A 66AB                    	stosw		; this is 1st interpolated sample (R)
  1462 00000B9C 88D8                    	mov	al, bl
  1463 00000B9E 00D0                    	add	al, dl
  1464 00000BA0 D0D8                    	rcr	al, 1
  1465 00000BA2 2C80                    	sub	al, 80h
  1466 00000BA4 66C1E008                	shl	ax, 8
  1467 00000BA8 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1468 00000BAA 88F8                    	mov	al, bh
  1469 00000BAC 00F0                    	add	al, dh
  1470 00000BAE D0D8                    	rcr	al, 1
  1471 00000BB0 2C80                    	sub	al, 80h
  1472 00000BB2 66C1E008                	shl	ax, 8
  1473 00000BB6 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1474 00000BB8 88D0                    	mov	al, dl
  1475 00000BBA 2C80                    	sub	al, 80h
  1476 00000BBC 66C1E008                	shl	ax, 8
  1477 00000BC0 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1478 00000BC2 88F0                    	mov	al, dh
  1479 00000BC4 2C80                    	sub	al, 80h
  1480 00000BC6 66C1E008                	shl	ax, 8
  1481 00000BCA 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1482 00000BCC A0[3F200000]            	mov	al, [next_val_l]
  1483 00000BD1 00D0                    	add	al, dl
  1484 00000BD3 D0D8                    	rcr	al, 1
  1485 00000BD5 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1486 00000BD7 00D0                    	add	al, dl
  1487 00000BD9 D0D8                    	rcr	al, 1
  1488 00000BDB 2C80                    	sub	al, 80h
  1489 00000BDD 66C1E008                	shl	ax, 8
  1490 00000BE1 66AB                    	stosw		; this is 4th interpolated sample (L)
  1491 00000BE3 A0[41200000]            	mov	al, [next_val_r]
  1492 00000BE8 00F0                    	add	al, dh
  1493 00000BEA D0D8                    	rcr	al, 1
  1494 00000BEC 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1495 00000BEE 00F0                    	add	al, dh
  1496 00000BF0 D0D8                    	rcr	al, 1
  1497 00000BF2 2C80                    	sub	al, 80h
  1498 00000BF4 66C1E008                	shl	ax, 8
  1499 00000BF8 66AB                    	stosw		; this is 4th interpolated sample (R)
  1500 00000BFA A0[3F200000]            	mov	al, [next_val_l]
  1501 00000BFF 00D8                    	add	al, bl
  1502 00000C01 D0D8                    	rcr	al, 1
  1503 00000C03 2C80                    	sub	al, 80h
  1504 00000C05 66C1E008                	shl	ax, 8
  1505 00000C09 66AB                    	stosw		; this is 5th interpolated sample (L)
  1506 00000C0B A0[41200000]            	mov	al, [next_val_r]
  1507 00000C10 00F8                    	add	al, bh
  1508 00000C12 D0D8                    	rcr	al, 1
  1509 00000C14 2C80                    	sub	al, 80h
  1510 00000C16 66C1E008                	shl	ax, 8
  1511 00000C1A 66AB                    	stosw		; this is 5th interpolated sample (R)
  1512                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1513 00000C1C E305                    	jecxz	lff8s_6
  1514 00000C1E E907FFFFFF              	jmp	lff8s_1
  1515                                  lff8s_6:
  1516 00000C23 E9A6FEFFFF              	jmp	lff8s_3
  1517                                  
  1518                                  load_8khz_mono_16_bit:
  1519                                  	; 13/11/2023
  1520 00000C28 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1521                                  					; last of the file?
  1522 00000C2F 7402                    	jz	short lff8m2_0		; no
  1523 00000C31 F9                      	stc
  1524 00000C32 C3                      	retn
  1525                                  
  1526                                  lff8m2_0:
  1527 00000C33 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1528                                          ;mov	edx, [loadsize]
  1529                                  
  1530                                  	; esi = buffer address
  1531                                  	;; edx = buffer size
  1532                                  
  1533                                  	; load file into memory
  1534                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000C38 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000C3E 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000C40 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000C46 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000C4B CD40                <1>  int 40h
  1535 00000C4D 0F82A0000000            	jc	lff8m2_7 ; error !
  1536                                  
  1537 00000C53 BF[00300000]            	mov	edi, audio_buffer
  1538                                  	
  1539 00000C58 D1E8                    	shr	eax, 1
  1540 00000C5A 7505                    	jnz	short lff8m2_8
  1541 00000C5C E985FEFFFF              	jmp	lff8_eof
  1542                                  
  1543                                  lff8m2_8:
  1544 00000C61 89C1                    	mov	ecx, eax	; word count
  1545                                  lff8m2_1:
  1546 00000C63 66AD                    	lodsw
  1547 00000C65 66AB                    	stosw		; original sample (left channel)
  1548 00000C67 66AB                    	stosw		; original sample (right channel)
  1549 00000C69 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1550 00000C6C 66A3[3B200000]          	mov	[previous_val], ax
  1551 00000C72 31C0                    	xor	eax, eax
  1552 00000C74 49                      	dec	ecx
  1553 00000C75 7403                    	jz	short lff8m2_2
  1554 00000C77 668B06                  	mov	ax, [esi]
  1555                                  lff8m2_2:
  1556 00000C7A 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  1557 00000C7D 89C5                    	mov	ebp, eax	; [next_val]
  1558 00000C7F 660305[3B200000]        	add	ax, [previous_val]
  1559 00000C86 66D1D8                  	rcr	ax, 1
  1560 00000C89 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample
  1561 00000C8B 660305[3B200000]        	add	ax, [previous_val]
  1562 00000C92 66D1D8                  	rcr	ax, 1	; this is temporary interpolation value
  1563 00000C95 89C3                    	mov	ebx, eax 		
  1564 00000C97 660305[3B200000]        	add	ax, [previous_val]
  1565 00000C9E 66D1D8                  	rcr	ax, 1
  1566 00000CA1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1567 00000CA4 66AB                    	stosw		; this is 1st interpolated sample (L)
  1568 00000CA6 66AB                    	stosw		; this is 1st interpolated sample (R)
  1569 00000CA8 89D8                    	mov	eax, ebx
  1570 00000CAA 6601D0                  	add	ax, dx
  1571 00000CAD 66D1D8                  	rcr	ax, 1
  1572 00000CB0 80EC80                  	sub	ah, 80h
  1573 00000CB3 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1574 00000CB5 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1575 00000CB7 89D0                    	mov	eax, edx
  1576 00000CB9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1577 00000CBC 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1578 00000CBE 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1579 00000CC0 89E8                    	mov	eax, ebp
  1580 00000CC2 6601D0                  	add	ax, dx
  1581 00000CC5 66D1D8                  	rcr	ax, 1
  1582 00000CC8 89C3                    	mov	ebx, eax ; this is temporary interpolation value
  1583 00000CCA 6601D0                  	add	ax, dx
  1584 00000CCD 66D1D8                  	rcr	ax, 1
  1585 00000CD0 80EC80                  	sub	ah, 80h
  1586 00000CD3 66AB                    	stosw		; this is 4th interpolated sample (L)
  1587 00000CD5 66AB                    	stosw		; this is 4th interpolated sample (R)
  1588 00000CD7 89E8                    	mov	eax, ebp
  1589 00000CD9 6601D8                  	add	ax, bx
  1590 00000CDC 66D1D8                  	rcr	ax, 1
  1591 00000CDF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1592 00000CE2 66AB                    	stosw		; this is 5th interpolated sample (L)
  1593 00000CE4 66AB                    	stosw		; this is 5th interpolated sample (R)
  1594                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1595 00000CE6 09C9                    	or	ecx, ecx
  1596 00000CE8 0F8575FFFFFF            	jnz	lff8m2_1
  1597 00000CEE E9DBFDFFFF              	jmp	lff8m2_3
  1598                                  
  1599                                  lff8m2_7:
  1600                                  lff8s2_7:
  1601 00000CF3 E9F7FDFFFF              	jmp	lff8m2_5  ; error
  1602                                  
  1603                                  load_8khz_stereo_16_bit:
  1604                                  	; 16/11/2023
  1605                                  	; 15/11/2023
  1606                                  	; 13/11/2023
  1607 00000CF8 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1608                                  					; last of the file?
  1609 00000CFF 7402                    	jz	short lff8s2_0		; no
  1610 00000D01 F9                      	stc
  1611 00000D02 C3                      	retn
  1612                                  
  1613                                  lff8s2_0:
  1614 00000D03 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1615                                          ;mov	edx, [loadsize]
  1616                                  
  1617                                  	; esi = buffer address
  1618                                  	;; edx = buffer size
  1619                                  
  1620                                  	; load file into memory
  1621                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000D08 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000D0E 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000D10 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000D16 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000D1B CD40                <1>  int 40h
  1622 00000D1D 72D4                    	jc	short lff8s2_7 ; error !
  1623                                  
  1624 00000D1F BF[00300000]            	mov	edi, audio_buffer
  1625                                  	
  1626 00000D24 C1E802                  	shr	eax, 2
  1627 00000D27 7505                    	jnz	short lff8s2_8
  1628 00000D29 E9B8FDFFFF              	jmp	lff8_eof
  1629                                  
  1630                                  lff8s2_8:
  1631 00000D2E 89C1                    	mov	ecx, eax ; dword count
  1632                                  lff8s2_1:
  1633 00000D30 66AD                    	lodsw
  1634 00000D32 66AB                    	stosw		; original sample (L)
  1635                                  	; 15/11/2023
  1636 00000D34 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1637 00000D37 66A3[3B200000]          	mov	[previous_val_l], ax
  1638 00000D3D 66AD                    	lodsw
  1639 00000D3F 66AB                    	stosw		; original sample (R)
  1640 00000D41 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1641 00000D44 66A3[3D200000]          	mov	[previous_val_r], ax
  1642 00000D4A 31D2                    	xor	edx, edx
  1643 00000D4C 31C0                    	xor	eax, eax
  1644                                  	; 16/11/2023
  1645 00000D4E 49                      	dec	ecx
  1646 00000D4F 7407                    	jz	short lff8s2_2
  1647 00000D51 668B06                  	mov	ax, [esi]
  1648 00000D54 668B5602                	mov	dx, [esi+2]
  1649                                  lff8s2_2:
  1650 00000D58 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1651 00000D5B 66A3[3F200000]          	mov	[next_val_l], ax
  1652 00000D61 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  1653 00000D64 668915[41200000]        	mov	[next_val_r], dx
  1654 00000D6B 660305[3B200000]        	add	ax, [previous_val_l]
  1655 00000D72 66D1D8                  	rcr	ax, 1
  1656 00000D75 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample (L)
  1657 00000D77 660305[3B200000]        	add	ax, [previous_val_l]
  1658 00000D7E 66D1D8                  	rcr	ax, 1	
  1659 00000D81 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1660 00000D83 660305[3B200000]        	add	ax, [previous_val_l]
  1661 00000D8A 66D1D8                  	rcr	ax, 1
  1662 00000D8D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1663 00000D90 66AB                    	stosw		; this is 1st interpolated sample (L)
  1664 00000D92 66A1[41200000]          	mov	ax, [next_val_r]
  1665 00000D98 660305[3D200000]        	add	ax, [previous_val_r]
  1666 00000D9F 66D1D8                  	rcr	ax, 1
  1667 00000DA2 89C5                    	mov	ebp, eax ; this is interpolated middle (3th) sample (R)
  1668 00000DA4 660305[3D200000]        	add	ax, [previous_val_r]
  1669 00000DAB 66D1D8                  	rcr	ax, 1
  1670 00000DAE 50                      	push	eax ; *	; this is temporary interpolation value (R)
  1671 00000DAF 660305[3D200000]        	add	ax, [previous_val_r]
  1672 00000DB6 66D1D8                  	rcr	ax, 1
  1673 00000DB9 80EC80                  	sub	ah, 80h
  1674 00000DBC 66AB                    	stosw		; this is 1st interpolated sample (R)
  1675 00000DBE 89D8                    	mov	eax, ebx
  1676 00000DC0 6601D0                  	add	ax, dx
  1677 00000DC3 66D1D8                  	rcr	ax, 1
  1678 00000DC6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1679 00000DC9 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1680 00000DCB 58                      	pop	eax ; *
  1681 00000DCC 6601E8                  	add	ax, bp
  1682 00000DCF 66D1D8                  	rcr	ax, 1
  1683 00000DD2 80EC80                  	sub	ah, 80h
  1684 00000DD5 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1685 00000DD7 89D0                    	mov	eax, edx
  1686 00000DD9 80EC80                  	sub	ah, 80h
  1687 00000DDC 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1688 00000DDE 89E8                    	mov	eax, ebp
  1689 00000DE0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1690 00000DE3 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1691 00000DE5 66A1[3F200000]          	mov	ax, [next_val_l]
  1692 00000DEB 6601D0                  	add	ax, dx
  1693 00000DEE 66D1D8                  	rcr	ax, 1
  1694 00000DF1 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1695 00000DF3 6601D0                  	add	ax, dx
  1696 00000DF6 66D1D8                  	rcr	ax, 1
  1697 00000DF9 80EC80                  	sub	ah, 80h
  1698 00000DFC 66AB                    	stosw		; this is 4th interpolated sample (L)
  1699 00000DFE 66A1[41200000]          	mov	ax, [next_val_r]
  1700 00000E04 6601E8                  	add	ax, bp
  1701 00000E07 66D1D8                  	rcr	ax, 1
  1702 00000E0A 50                      	push	eax ; ** ; this is temporary interpolation value (R)
  1703 00000E0B 6601E8                  	add	ax, bp
  1704 00000E0E 66D1D8                  	rcr	ax, 1
  1705 00000E11 80EC80                  	sub	ah, 80h
  1706 00000E14 66AB                    	stosw		; this is 4th interpolated sample (R)
  1707 00000E16 66A1[3F200000]          	mov	ax, [next_val_l]
  1708 00000E1C 6601D8                  	add	ax, bx
  1709 00000E1F 66D1D8                  	rcr	ax, 1
  1710 00000E22 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1711 00000E25 66AB                    	stosw		; this is 5th interpolated sample (L)
  1712 00000E27 58                      	pop	eax ; **
  1713 00000E28 660305[41200000]        	add	ax, [next_val_r]
  1714 00000E2F 66D1D8                  	rcr	ax, 1
  1715 00000E32 80EC80                  	sub	ah, 80h
  1716 00000E35 66AB                    	stosw		; this is 5th interpolated sample (R)
  1717                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1718 00000E37 E305                    	jecxz	lff8_s2_9
  1719 00000E39 E9F2FEFFFF              	jmp	lff8s2_1
  1720                                  lff8_s2_9:
  1721 00000E3E E98BFCFFFF              	jmp	lff8s2_3
  1722                                  
  1723                                  ; .....................
  1724                                  
  1725                                  load_16khz_mono_8_bit:
  1726                                  	; 14/11/2023
  1727                                  	; 13/11/2023
  1728 00000E43 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1729                                  					; last of the file?
  1730 00000E4A 7402                    	jz	short lff16m_0		; no
  1731 00000E4C F9                      	stc
  1732 00000E4D C3                      	retn
  1733                                  
  1734                                  lff16m_0:
  1735 00000E4E BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1736                                          ;mov	edx, [loadsize]
  1737                                  
  1738                                  	; esi = buffer address
  1739                                  	;; edx = buffer size
  1740                                  
  1741                                  	; load file into memory
  1742                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000E53 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000E59 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000E5B 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000E61 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000E66 CD40                <1>  int 40h
  1743 00000E68 7253                    	jc	short lff16m_7 ; error !
  1744                                  
  1745 00000E6A BF[00300000]            	mov	edi, audio_buffer
  1746                                  	
  1747 00000E6F 21C0                    	and	eax, eax
  1748 00000E71 7505                    	jnz	short lff16m_8
  1749 00000E73 E96EFCFFFF              	jmp	lff16_eof
  1750                                  
  1751                                  lff16m_8:
  1752 00000E78 89C1                    	mov	ecx, eax		; byte count
  1753                                  lff16m_1:
  1754 00000E7A AC                      	lodsb
  1755                                  	;mov	[previous_val], al
  1756 00000E7B 88C3                    	mov	bl, al
  1757 00000E7D 2C80                    	sub	al, 80h
  1758 00000E7F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1759 00000E83 66AB                    	stosw		; original sample (left channel)
  1760 00000E85 66AB                    	stosw		; original sample (right channel)
  1761                                  	;xor	ax, ax
  1762                                  	; 14/11/22023
  1763 00000E87 B080                    	mov	al, 80h
  1764 00000E89 49                      	dec	ecx
  1765 00000E8A 7402                    	jz	short lff16m_2
  1766 00000E8C 8A06                    	mov	al, [esi]
  1767                                  lff16m_2:
  1768                                  	;mov	[next_val], al
  1769 00000E8E 88C7                    	mov	bh, al
  1770                                  	;add	al, [previous_val]
  1771 00000E90 00D8                    	add	al, bl
  1772 00000E92 D0D8                    	rcr	al, 1
  1773 00000E94 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  1774                                  	;add	al, [previous_val]
  1775 00000E96 00D8                    	add	al, bl
  1776 00000E98 D0D8                    	rcr	al, 1
  1777 00000E9A 2C80                    	sub	al, 80h
  1778 00000E9C 66C1E008                	shl	ax, 8
  1779 00000EA0 66AB                    	stosw		; this is 1st interpolated sample (L)
  1780 00000EA2 66AB                    	stosw		; this is 1st interpolated sample (R)
  1781                                  	;mov	al, [next_val]
  1782 00000EA4 88F8                    	mov	al, bh
  1783 00000EA6 00D0                    	add	al, dl
  1784 00000EA8 D0D8                    	rcr	al, 1
  1785 00000EAA 2C80                    	sub	al, 80h
  1786 00000EAC 66C1E008                	shl	ax, 8
  1787 00000EB0 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1788 00000EB2 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1789                                  	
  1790                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1791 00000EB4 09C9                    	or	ecx, ecx
  1792 00000EB6 75C2                    	jnz	short lff16m_1
  1793 00000EB8 E911FCFFFF              	jmp	lff16m_3
  1794                                  
  1795                                  lff16m_7:
  1796                                  lff16s_7:
  1797 00000EBD E92DFCFFFF              	jmp	lff16m_5  ; error
  1798                                  
  1799                                  load_16khz_stereo_8_bit:
  1800                                  	; 14/11/2023
  1801                                  	; 13/11/2023
  1802 00000EC2 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1803                                  					; last of the file?
  1804 00000EC9 7402                    	jz	short lff16s_0		; no
  1805 00000ECB F9                      	stc
  1806 00000ECC C3                      	retn
  1807                                  
  1808                                  lff16s_0:
  1809 00000ECD BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1810                                          ;mov	edx, [loadsize]
  1811                                  
  1812                                  	; esi = buffer address
  1813                                  	;; edx = buffer size
  1814                                  
  1815                                  	; load file into memory
  1816                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000ED2 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000ED8 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000EDA 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000EE0 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000EE5 CD40                <1>  int 40h
  1817 00000EE7 72D4                    	jc	short lff16s_7 ; error !
  1818                                  
  1819 00000EE9 BF[00300000]            	mov	edi, audio_buffer
  1820                                  	
  1821 00000EEE D1E8                    	shr	eax, 1
  1822 00000EF0 7505                    	jnz	short lff16s_8
  1823 00000EF2 E9EFFBFFFF              	jmp	lff16_eof
  1824                                  
  1825                                  lff16s_8:
  1826 00000EF7 89C1                    	mov	ecx, eax	; word count
  1827                                  lff16s_1:
  1828 00000EF9 AC                      	lodsb
  1829 00000EFA A2[3B200000]            	mov	[previous_val_l], al
  1830 00000EFF 2C80                    	sub	al, 80h
  1831 00000F01 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1832 00000F05 66AB                    	stosw		; original sample (L)
  1833 00000F07 AC                      	lodsb
  1834 00000F08 A2[3D200000]            	mov	[previous_val_r], al
  1835 00000F0D 2C80                    	sub	al, 80h
  1836 00000F0F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1837 00000F13 66AB                    	stosw		; original sample (R)
  1838                                  
  1839                                  	;xor	eax, eax
  1840 00000F15 66B88080                	mov	ax, 8080h
  1841 00000F19 49                      	dec	ecx
  1842 00000F1A 7403                    	jz	short lff16s_2
  1843                                  		; convert 8 bit sample to 16 bit sample
  1844 00000F1C 668B06                  	mov	ax, [esi]
  1845                                  lff16s_2:
  1846                                  	;mov	[next_val_l], al
  1847                                  	;mov	[next_val_r], ah
  1848 00000F1F 89C3                    	mov	ebx, eax
  1849 00000F21 0205[3B200000]          	add	al, [previous_val_l]
  1850 00000F27 D0D8                    	rcr	al, 1
  1851 00000F29 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  1852 00000F2B 0205[3B200000]          	add	al, [previous_val_l]
  1853 00000F31 D0D8                    	rcr	al, 1
  1854 00000F33 2C80                    	sub	al, 80h
  1855 00000F35 66C1E008                	shl	ax, 8
  1856 00000F39 66AB                    	stosw		; this is 1st interpolated sample (L)
  1857 00000F3B 88F8                    	mov	al, bh	; [next_val_r]
  1858 00000F3D 0205[3D200000]          	add	al, [previous_val_r]
  1859 00000F43 D0D8                    	rcr	al, 1
  1860 00000F45 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  1861 00000F47 0205[3D200000]          	add	al, [previous_val_r]
  1862 00000F4D D0D8                    	rcr	al, 1
  1863 00000F4F 2C80                    	sub	al, 80h
  1864 00000F51 66C1E008                	shl	ax, 8
  1865 00000F55 66AB                    	stosw		; this is 1st interpolated sample (R)
  1866 00000F57 88D0                    	mov	al, dl
  1867 00000F59 00D8                    	add	al, bl	; [next_val_l]
  1868 00000F5B D0D8                    	rcr	al, 1
  1869 00000F5D 2C80                    	sub	al, 80h
  1870 00000F5F 66C1E008                	shl	ax, 8
  1871 00000F63 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1872 00000F65 88F0                    	mov	al, dh
  1873 00000F67 00F8                    	add	al, bh	; [next_val_r]
  1874 00000F69 D0D8                    	rcr	al, 1
  1875 00000F6B 2C80                    	sub	al, 80h
  1876 00000F6D 66C1E008                	shl	ax, 8
  1877 00000F71 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1878                                  	
  1879                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1880 00000F73 09C9                    	or	ecx, ecx
  1881 00000F75 7582                    	jnz	short lff16s_1
  1882 00000F77 E952FBFFFF              	jmp	lff16s_3
  1883                                  
  1884                                  load_16khz_mono_16_bit:
  1885                                  	; 15/11/2023
  1886                                  	; 13/11/2023
  1887 00000F7C F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1888                                  					; last of the file?
  1889 00000F83 7402                    	jz	short lff16m2_0		; no
  1890 00000F85 F9                      	stc
  1891 00000F86 C3                      	retn
  1892                                  
  1893                                  lff16m2_0:
  1894 00000F87 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1895                                          ;mov	edx, [loadsize]
  1896                                  
  1897                                  	; esi = buffer address
  1898                                  	;; edx = buffer size
  1899                                  
  1900                                  	; load file into memory
  1901                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000F8C 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000F92 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000F94 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000F9A B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000F9F CD40                <1>  int 40h
  1902 00000FA1 7255                    	jc	short lff16m2_7 ; error !
  1903                                  
  1904 00000FA3 BF[00300000]            	mov	edi, audio_buffer
  1905                                  	
  1906 00000FA8 D1E8                    	shr	eax, 1
  1907 00000FAA 7505                    	jnz	short lff16m2_8
  1908 00000FAC E935FBFFFF              	jmp	lff16_eof
  1909                                  
  1910                                  lff16m2_8:
  1911 00000FB1 89C1                    	mov	ecx, eax  ; word count
  1912                                  lff16m2_1:
  1913 00000FB3 66AD                    	lodsw
  1914 00000FB5 66AB                    	stosw		; original sample (left channel)
  1915 00000FB7 66AB                    	stosw		; original sample (right channel)
  1916 00000FB9 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  1917                                  	;mov	[previous_val], ax
  1918 00000FBC 89C3                    	mov	ebx, eax	
  1919 00000FBE 31C0                    	xor	eax, eax
  1920 00000FC0 49                      	dec	ecx
  1921 00000FC1 7403                    	jz	short lff16m2_2
  1922 00000FC3 668B06                  	mov	ax, [esi]
  1923                                  lff16m2_2:
  1924 00000FC6 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  1925 00000FC9 89C5                    	mov	ebp, eax	; [next_val]
  1926                                  	;add	ax, [previous_val]
  1927 00000FCB 6601D8                  	add	ax, bx
  1928 00000FCE 66D1D8                  	rcr	ax, 1
  1929 00000FD1 89C2                    	mov	edx, eax ; this is temporary interpolation value
  1930                                  	;add	ax, [previous_val]
  1931 00000FD3 6601D8                  	add	ax, bx
  1932 00000FD6 66D1D8                  	rcr	ax, 1
  1933 00000FD9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1934 00000FDC 66AB                    	stosw		; this is 1st interpolated sample (L)
  1935 00000FDE 66AB                    	stosw		; this is 1st interpolated sample (R)
  1936 00000FE0 89E8                    	mov	eax, ebp 
  1937 00000FE2 6601D0                  	add	ax, dx
  1938 00000FE5 66D1D8                  	rcr	ax, 1
  1939 00000FE8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1940 00000FEB 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1941 00000FED 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1942                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1943 00000FEF 09C9                    	or	ecx, ecx
  1944 00000FF1 75C0                    	jnz	short lff16m2_1
  1945 00000FF3 E9D6FAFFFF              	jmp	lff16m2_3
  1946                                  
  1947                                  lff16m2_7:
  1948                                  lff16s2_7:
  1949 00000FF8 E9F2FAFFFF              	jmp	lff16m2_5  ; error
  1950                                  
  1951                                  load_16khz_stereo_16_bit:
  1952                                  	; 16/11/2023
  1953                                  	; 15/11/2023
  1954                                  	; 13/11/2023
  1955 00000FFD F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1956                                  					; last of the file?
  1957 00001004 7402                    	jz	short lff16s2_0		; no
  1958 00001006 F9                      	stc
  1959 00001007 C3                      	retn
  1960                                  
  1961                                  lff16s2_0:
  1962 00001008 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1963                                          ;mov	edx, [loadsize]
  1964                                  
  1965                                  	; esi = buffer address
  1966                                  	;; edx = buffer size
  1967                                  
  1968                                  	; load file into memory
  1969                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000100D 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001013 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001015 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000101B B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001020 CD40                <1>  int 40h
  1970 00001022 72D4                    	jc	short lff16s2_7 ; error !
  1971                                  
  1972 00001024 BF[00300000]            	mov	edi, audio_buffer
  1973                                  	
  1974 00001029 C1E802                  	shr	eax, 2
  1975 0000102C 7505                    	jnz	short lff16s2_8
  1976 0000102E E9B3FAFFFF              	jmp	lff16_eof
  1977                                  
  1978                                  lff16s2_8:
  1979 00001033 89C1                    	mov	ecx, eax  ; dword count
  1980                                  lff16s2_1:
  1981 00001035 66AD                    	lodsw
  1982 00001037 66AB                    	stosw		; original sample (L)
  1983 00001039 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  1984 0000103C 66A3[3B200000]          	mov	[previous_val_l], ax
  1985 00001042 66AD                    	lodsw
  1986 00001044 66AB                    	stosw		; original sample (R)
  1987 00001046 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  1988 00001049 66A3[3D200000]          	mov	[previous_val_r], ax
  1989 0000104F 31D2                    	xor	edx, edx
  1990 00001051 31C0                    	xor	eax, eax
  1991                                  	; 16/11/2023
  1992 00001053 49                      	dec	ecx
  1993 00001054 7407                    	jz	short lff16s2_2
  1994 00001056 668B06                  	mov	ax, [esi]
  1995 00001059 668B5602                	mov	dx, [esi+2]
  1996                                  lff16s2_2:
  1997 0000105D 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  1998                                  	;mov	[next_val_l], ax
  1999 00001060 89C5                    	mov	ebp, eax
  2000 00001062 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2001 00001065 668915[41200000]        	mov	[next_val_r], dx
  2002 0000106C 660305[3B200000]        	add	ax, [previous_val_l]
  2003 00001073 66D1D8                  	rcr	ax, 1
  2004 00001076 89C2                    	mov	edx, eax ; this is temporary interpolation value (L)
  2005 00001078 660305[3B200000]        	add	ax, [previous_val_l]
  2006 0000107F 66D1D8                  	rcr	ax, 1
  2007 00001082 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2008 00001085 66AB                    	stosw		; this is 1st interpolated sample (L)
  2009 00001087 66A1[41200000]          	mov	ax, [next_val_r]
  2010 0000108D 660305[3D200000]        	add	ax, [previous_val_r]
  2011 00001094 66D1D8                  	rcr	ax, 1
  2012 00001097 89C3                    	mov	ebx, eax ; this is temporary interpolation value (R)
  2013 00001099 660305[3D200000]        	add	ax, [previous_val_r]
  2014 000010A0 66D1D8                  	rcr	ax, 1
  2015 000010A3 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2016 000010A6 66AB                    	stosw		; this is 1st interpolated sample (R)
  2017                                  	;mov	ax, [next_val_l]
  2018 000010A8 89E8                    	mov	eax, ebp
  2019 000010AA 6601D0                  	add	ax, dx
  2020 000010AD 66D1D8                  	rcr	ax, 1
  2021 000010B0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2022 000010B3 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2023 000010B5 66A1[41200000]          	mov	ax, [next_val_r]
  2024 000010BB 6601D8                  	add	ax, bx
  2025 000010BE 66D1D8                  	rcr	ax, 1
  2026 000010C1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2027 000010C4 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  2028                                  	
  2029                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2030 000010C6 09C9                    	or	ecx, ecx
  2031 000010C8 0F8567FFFFFF            	jnz	lff16s2_1
  2032 000010CE E9FBF9FFFF              	jmp	lff16s2_3
  2033                                  
  2034                                  ; .....................
  2035                                  
  2036                                  load_24khz_mono_8_bit:
  2037                                  	; 15/11/2023
  2038 000010D3 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2039                                  					; last of the file?
  2040 000010DA 7402                    	jz	short lff24m_0		; no
  2041 000010DC F9                      	stc
  2042 000010DD C3                      	retn
  2043                                  
  2044                                  lff24m_0:
  2045 000010DE BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2046                                          ;mov	edx, [loadsize]
  2047                                  
  2048                                  	; esi = buffer address
  2049                                  	;; edx = buffer size
  2050                                  
  2051                                  	; load file into memory
  2052                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000010E3 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000010E9 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000010EB 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000010F1 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000010F6 CD40                <1>  int 40h
  2053 000010F8 723B                    	jc	short lff24m_7 ; error !
  2054                                  
  2055 000010FA BF[00300000]            	mov	edi, audio_buffer
  2056                                  	
  2057 000010FF 21C0                    	and	eax, eax
  2058 00001101 7505                    	jnz	short lff24m_8
  2059 00001103 E9DEF9FFFF              	jmp	lff24_eof
  2060                                  
  2061                                  lff24m_8:
  2062 00001108 89C1                    	mov	ecx, eax	; byte count
  2063                                  lff24m_1:
  2064 0000110A AC                      	lodsb
  2065                                  	;mov	[previous_val], al
  2066 0000110B 88C3                    	mov	bl, al
  2067 0000110D 2C80                    	sub	al, 80h
  2068 0000110F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2069 00001113 66AB                    	stosw		; original sample (left channel)
  2070 00001115 66AB                    	stosw		; original sample (right channel)
  2071                                  	;xor	eax, eax
  2072 00001117 B080                    	mov	al, 80h
  2073 00001119 49                      	dec	ecx
  2074 0000111A 7402                    	jz	short lff24m_2
  2075 0000111C 8A06                    	mov	al, [esi]
  2076                                  lff24m_2:
  2077                                  	;;mov	[next_val], al
  2078                                  	;mov	bh, al
  2079                                  	;add	al, [previous_val]
  2080 0000111E 00D8                    	add	al, bl
  2081 00001120 D0D8                    	rcr	al, 1
  2082 00001122 2C80                    	sub	al, 80h
  2083 00001124 66C1E008                	shl	ax, 8
  2084 00001128 66AB                    	stosw		; this is interpolated sample (L)
  2085 0000112A 66AB                    	stosw		; this is interpolated sample (R)
  2086                                  	
  2087                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2088 0000112C 09C9                    	or	ecx, ecx
  2089 0000112E 75DA                    	jnz	short lff24m_1
  2090 00001130 E999F9FFFF              	jmp	lff24_3
  2091                                  
  2092                                  lff24m_7:
  2093                                  lff24s_7:
  2094 00001135 E9B5F9FFFF              	jmp	lff24_5  ; error
  2095                                  
  2096                                  load_24khz_stereo_8_bit:
  2097                                  	; 15/11/2023
  2098 0000113A F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2099                                  					; last of the file?
  2100 00001141 7402                    	jz	short lff24s_0		; no
  2101 00001143 F9                      	stc
  2102 00001144 C3                      	retn
  2103                                  
  2104                                  lff24s_0:
  2105 00001145 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2106                                          ;mov	edx, [loadsize]
  2107                                  
  2108                                  	; esi = buffer address
  2109                                  	;; edx = buffer size
  2110                                  
  2111                                  	; load file into memory
  2112                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000114A 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001150 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001152 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001158 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000115D CD40                <1>  int 40h
  2113 0000115F 72D4                    	jc	short lff24s_7 ; error !
  2114                                  
  2115 00001161 BF[00300000]            	mov	edi, audio_buffer
  2116                                  	
  2117 00001166 D1E8                    	shr	eax, 1
  2118 00001168 7505                    	jnz	short lff24s_8
  2119 0000116A E977F9FFFF              	jmp	lff24_eof
  2120                                  
  2121                                  lff24s_8:
  2122 0000116F 89C1                    	mov	ecx, eax  ; word count
  2123                                  lff24s_1:
  2124 00001171 AC                      	lodsb
  2125 00001172 A2[3B200000]            	mov	[previous_val_l], al
  2126 00001177 2C80                    	sub	al, 80h
  2127 00001179 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2128 0000117D 66AB                    	stosw		; original sample (L)
  2129 0000117F AC                      	lodsb
  2130 00001180 A2[3D200000]            	mov	[previous_val_r], al
  2131 00001185 2C80                    	sub	al, 80h
  2132 00001187 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2133 0000118B 66AB                    	stosw		; original sample (R)
  2134                                  
  2135                                  	;xor	eax, eax
  2136 0000118D 66B88080                	mov	ax, 8080h
  2137 00001191 49                      	dec	ecx
  2138 00001192 7403                    	jz	short lff24s_2
  2139                                  		; convert 8 bit sample to 16 bit sample
  2140 00001194 668B06                  	mov	ax, [esi]
  2141                                  lff24s_2:
  2142                                  	;;mov	[next_val_l], al
  2143                                  	;;mov	[next_val_r], ah
  2144                                  	;mov	bx, ax
  2145 00001197 88E7                    	mov	bh, ah
  2146 00001199 0205[3B200000]          	add	al, [previous_val_l]
  2147 0000119F D0D8                    	rcr	al, 1
  2148                                  	;mov	dl, al
  2149 000011A1 2C80                    	sub	al, 80h
  2150 000011A3 66C1E008                	shl	ax, 8
  2151 000011A7 66AB                    	stosw		; this is interpolated sample (L)
  2152 000011A9 88F8                    	mov	al, bh	; [next_val_r]
  2153 000011AB 0205[3D200000]          	add	al, [previous_val_r]
  2154 000011B1 D0D8                    	rcr	al, 1
  2155                                  	;mov	dh, al
  2156 000011B3 2C80                    	sub	al, 80h
  2157 000011B5 66C1E008                	shl	ax, 8
  2158 000011B9 66AB                    	stosw		; this is interpolated sample (R)
  2159                                  		
  2160                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2161 000011BB 09C9                    	or	ecx, ecx
  2162 000011BD 75B2                    	jnz	short lff24s_1
  2163 000011BF E90AF9FFFF              	jmp	lff24_3
  2164                                  
  2165                                  load_24khz_mono_16_bit:
  2166                                  	; 15/11/2023
  2167 000011C4 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2168                                  					; last of the file?
  2169 000011CB 7402                    	jz	short lff24m2_0		; no
  2170 000011CD F9                      	stc
  2171 000011CE C3                      	retn
  2172                                  
  2173                                  lff24m2_0:
  2174 000011CF BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2175                                          ;mov	edx, [loadsize]
  2176                                  
  2177                                  	; esi = buffer address
  2178                                  	;; edx = buffer size
  2179                                  
  2180                                  	; load file into memory
  2181                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000011D4 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000011DA 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000011DC 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000011E2 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000011E7 CD40                <1>  int 40h
  2182 000011E9 7237                    	jc	short lff24m2_7 ; error !
  2183                                  
  2184 000011EB BF[00300000]            	mov	edi, audio_buffer
  2185                                  	
  2186 000011F0 D1E8                    	shr	eax, 1
  2187 000011F2 7505                    	jnz	short lff24m2_8
  2188 000011F4 E9EDF8FFFF              	jmp	lff24_eof
  2189                                  
  2190                                  lff24m2_8:
  2191 000011F9 89C1                    	mov	ecx, eax  ; word count
  2192                                  lff24m2_1:
  2193 000011FB 66AD                    	lodsw
  2194 000011FD 66AB                    	stosw		; original sample (left channel)
  2195 000011FF 66AB                    	stosw		; original sample (right channel)
  2196 00001201 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2197                                  	;mov	[previous_val], ax
  2198                                  	;mov	ebx, eax	
  2199                                  	;xor	eax, eax
  2200 00001204 31DB                    	xor	ebx, ebx
  2201 00001206 49                      	dec	ecx
  2202 00001207 7403                    	jz	short lff24m2_2
  2203                                  	;mov	ax, [esi]
  2204 00001209 668B1E                  	mov	bx, [esi]
  2205                                  lff24m2_2:
  2206                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2207                                  	;mov	ebp, eax	; [next_val]
  2208                                  	;add	ax, [previous_val]
  2209                                  	; ax = [previous_val]
  2210                                  	; bx = [next_val]
  2211 0000120C 6601D8                  	add	ax, bx
  2212 0000120F 66D1D8                  	rcr	ax, 1
  2213 00001212 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2214 00001215 66AB                    	stosw		; this is interpolated sample (L)
  2215 00001217 66AB                    	stosw		; this is interpolated sample (R)
  2216                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2217 00001219 09C9                    	or	ecx, ecx
  2218 0000121B 75DE                    	jnz	short lff24m2_1
  2219 0000121D E9ACF8FFFF              	jmp	lff24_3
  2220                                  
  2221                                  lff24m2_7:
  2222                                  lff24s2_7:
  2223 00001222 E9C8F8FFFF              	jmp	lff24_5  ; error
  2224                                  
  2225                                  load_24khz_stereo_16_bit:
  2226                                  	; 16/11/2023
  2227                                  	; 15/11/2023
  2228 00001227 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2229                                  					; last of the file?
  2230 0000122E 7402                    	jz	short lff24s2_0		; no
  2231 00001230 F9                      	stc
  2232 00001231 C3                      	retn
  2233                                  
  2234                                  lff24s2_0:
  2235 00001232 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2236                                          ;mov	edx, [loadsize]
  2237                                  
  2238                                  	; esi = buffer address
  2239                                  	;; edx = buffer size
  2240                                  
  2241                                  	; load file into memory
  2242                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001237 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000123D 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000123F 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001245 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000124A CD40                <1>  int 40h
  2243 0000124C 72D4                    	jc	short lff24s2_7 ; error !
  2244                                  
  2245 0000124E BF[00300000]            	mov	edi, audio_buffer
  2246                                  	
  2247 00001253 C1E802                  	shr	eax, 2
  2248 00001256 7505                    	jnz	short lff24s2_8
  2249 00001258 E989F8FFFF              	jmp	lff24_eof
  2250                                  
  2251                                  lff24s2_8:
  2252 0000125D 89C1                    	mov	ecx, eax  ; dword count
  2253                                  lff24s2_1:
  2254 0000125F 66AD                    	lodsw
  2255 00001261 66AB                    	stosw		; original sample (L)
  2256 00001263 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2257 00001266 66A3[3B200000]          	mov	[previous_val_l], ax
  2258 0000126C 66AD                    	lodsw
  2259 0000126E 66AB                    	stosw		; original sample (R)
  2260 00001270 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2261                                  	;mov	[previous_val_r], ax
  2262 00001273 89C3                    	mov	ebx, eax
  2263 00001275 31D2                    	xor	edx, edx
  2264 00001277 31C0                    	xor	eax, eax
  2265                                  	; 16/11/2023
  2266 00001279 49                      	dec	ecx
  2267 0000127A 7407                    	jz	short lff24s2_2
  2268 0000127C 668B06                  	mov	ax, [esi]
  2269 0000127F 668B5602                	mov	dx, [esi+2]
  2270                                  lff24s2_2:
  2271 00001283 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2272                                  	;;mov	[next_val_l], ax
  2273                                  	;mov	ebp, eax
  2274 00001286 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2275                                  	;mov	[next_val_r], dx
  2276 00001289 660305[3B200000]        	add	ax, [previous_val_l]
  2277 00001290 66D1D8                  	rcr	ax, 1
  2278 00001293 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2279 00001296 66AB                    	stosw		; this is interpolated sample (L)
  2280                                  	;mov	ax, [next_val_r]
  2281 00001298 89D0                    	mov	eax, edx
  2282                                  	;add	ax, [previous_val_r]
  2283 0000129A 6601D8                  	add	ax, bx
  2284 0000129D 66D1D8                  	rcr	ax, 1
  2285 000012A0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2286 000012A3 66AB                    	stosw		; this is interpolated sample (R)
  2287                                  	
  2288                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2289 000012A5 09C9                    	or	ecx, ecx
  2290 000012A7 75B6                    	jnz	short lff24s2_1
  2291 000012A9 E920F8FFFF              	jmp	lff24_3
  2292                                  
  2293                                  ; .....................
  2294                                  
  2295                                  load_32khz_mono_8_bit:
  2296                                  	; 15/11/2023
  2297 000012AE F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2298                                  					; last of the file?
  2299 000012B5 7402                    	jz	short lff32m_0		; no
  2300 000012B7 F9                      	stc
  2301 000012B8 C3                      	retn
  2302                                  
  2303                                  lff32m_0:
  2304 000012B9 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2305                                          ;mov	edx, [loadsize]
  2306                                  
  2307                                  	; esi = buffer address
  2308                                  	;; edx = buffer size
  2309                                  
  2310                                  	; load file into memory
  2311                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000012BE 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000012C4 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000012C6 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000012CC B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000012D1 CD40                <1>  int 40h
  2312 000012D3 7247                    	jc	short lff32m_7 ; error !
  2313                                  
  2314 000012D5 BF[00300000]            	mov	edi, audio_buffer
  2315                                  	
  2316 000012DA 21C0                    	and	eax, eax
  2317 000012DC 7505                    	jnz	short lff32m_8
  2318 000012DE E903F8FFFF              	jmp	lff32_eof
  2319                                  
  2320                                  lff32m_8:
  2321 000012E3 89C1                    	mov	ecx, eax	; byte count
  2322                                  lff32m_1:
  2323 000012E5 AC                      	lodsb
  2324                                  	;mov	[previous_val], al
  2325 000012E6 88C3                    	mov	bl, al
  2326 000012E8 2C80                    	sub	al, 80h
  2327 000012EA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2328 000012EE 66AB                    	stosw		; original sample (left channel)
  2329 000012F0 66AB                    	stosw		; original sample (right channel)
  2330                                  	;xor	eax, eax
  2331 000012F2 B080                    	mov	al, 80h
  2332 000012F4 49                      	dec	ecx
  2333 000012F5 7402                    	jz	short lff32m_2
  2334 000012F7 8A06                    	mov	al, [esi]
  2335                                  lff32m_2:
  2336                                  	;;mov	[next_val], al
  2337                                  	;mov	bh, al
  2338                                  	;add	al, [previous_val]
  2339 000012F9 00D8                    	add	al, bl
  2340 000012FB D0D8                    	rcr	al, 1
  2341 000012FD 2C80                    	sub	al, 80h
  2342 000012FF 66C1E008                	shl	ax, 8
  2343 00001303 66AB                    	stosw		; this is interpolated sample (L)
  2344 00001305 66AB                    	stosw		; this is interpolated sample (R)
  2345                                  	
  2346                                  	; different than 8-16-24 kHZ !
  2347                                  	; 'original-interpolated-original' trio samples 
  2348 00001307 E30E                    	jecxz	lff32m_3
  2349                                  
  2350 00001309 AC                      	lodsb
  2351 0000130A 2C80                    	sub	al, 80h
  2352 0000130C 66C1E008                	shl	ax, 8
  2353 00001310 66AB                    	stosw		; original sample (left channel)
  2354 00001312 66AB                    	stosw		; original sample (right channel)
  2355                                  
  2356                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2357 00001314 49                      	dec	ecx
  2358 00001315 75CE                    	jnz	short lff32m_1
  2359                                  lff32m_3:
  2360 00001317 E9B2F7FFFF              	jmp	lff32_3
  2361                                  
  2362                                  lff32m_7:
  2363                                  lff32s_7:
  2364 0000131C E9CEF7FFFF              	jmp	lff32_5  ; error
  2365                                  
  2366                                  load_32khz_stereo_8_bit:
  2367                                  	; 15/11/2023
  2368 00001321 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2369                                  					; last of the file?
  2370 00001328 7402                    	jz	short lff32s_0		; no
  2371 0000132A F9                      	stc
  2372 0000132B C3                      	retn
  2373                                  
  2374                                  lff32s_0:
  2375 0000132C BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2376                                          ;mov	edx, [loadsize]
  2377                                  
  2378                                  	; esi = buffer address
  2379                                  	;; edx = buffer size
  2380                                  
  2381                                  	; load file into memory
  2382                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001331 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001337 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001339 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000133F B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001344 CD40                <1>  int 40h
  2383 00001346 72D4                    	jc	short lff32s_7 ; error !
  2384                                  
  2385 00001348 BF[00300000]            	mov	edi, audio_buffer
  2386                                  	
  2387 0000134D D1E8                    	shr	eax, 1
  2388 0000134F 7505                    	jnz	short lff32s_8
  2389 00001351 E990F7FFFF              	jmp	lff32_eof
  2390                                  
  2391                                  lff32s_8:
  2392 00001356 89C1                    	mov	ecx, eax  ; word count
  2393                                  lff32s_1:
  2394 00001358 AC                      	lodsb
  2395 00001359 A2[3B200000]            	mov	[previous_val_l], al
  2396 0000135E 2C80                    	sub	al, 80h
  2397 00001360 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2398 00001364 66AB                    	stosw		; original sample (L)
  2399 00001366 AC                      	lodsb
  2400 00001367 A2[3D200000]            	mov	[previous_val_r], al
  2401 0000136C 2C80                    	sub	al, 80h
  2402 0000136E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2403 00001372 66AB                    	stosw		; original sample (R)
  2404                                  
  2405                                  	;xor	eax, eax
  2406 00001374 66B88080                	mov	ax, 8080h
  2407 00001378 49                      	dec	ecx
  2408 00001379 7403                    	jz	short lff32s_2
  2409                                  		; convert 8 bit sample to 16 bit sample
  2410 0000137B 668B06                  	mov	ax, [esi]
  2411                                  lff32s_2:
  2412                                  	;;mov	[next_val_l], al
  2413                                  	;;mov	[next_val_r], ah
  2414                                  	;mov	bx, ax
  2415 0000137E 88E7                    	mov	bh, ah
  2416 00001380 0205[3B200000]          	add	al, [previous_val_l]
  2417 00001386 D0D8                    	rcr	al, 1
  2418                                  	;mov	dl, al
  2419 00001388 2C80                    	sub	al, 80h
  2420 0000138A 66C1E008                	shl	ax, 8
  2421 0000138E 66AB                    	stosw		; this is interpolated sample (L)
  2422 00001390 88F8                    	mov	al, bh	; [next_val_r]
  2423 00001392 0205[3D200000]          	add	al, [previous_val_r]
  2424 00001398 D0D8                    	rcr	al, 1
  2425                                  	;mov	dh, al
  2426 0000139A 2C80                    	sub	al, 80h
  2427 0000139C 66C1E008                	shl	ax, 8
  2428 000013A0 66AB                    	stosw		; this is interpolated sample (R)
  2429                                  
  2430                                  	; different than 8-16-24 kHZ !
  2431                                  	; 'original-interpolated-original' trio samples 
  2432 000013A2 E315                    	jecxz	lff32s_3
  2433                                  
  2434 000013A4 AC                      	lodsb
  2435 000013A5 2C80                    	sub	al, 80h
  2436 000013A7 66C1E008                	shl	ax, 8
  2437 000013AB 66AB                    	stosw		; original sample (left channel)
  2438                                  
  2439 000013AD AC                      	lodsb
  2440 000013AE 2C80                    	sub	al, 80h
  2441 000013B0 66C1E008                	shl	ax, 8
  2442 000013B4 66AB                    	stosw		; original sample (right channel)
  2443                                  		
  2444                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2445 000013B6 49                      	dec	ecx
  2446 000013B7 759F                    	jnz	short lff32s_1
  2447                                  lff32s_3:
  2448 000013B9 E910F7FFFF              	jmp	lff32_3
  2449                                  
  2450                                  load_32khz_mono_16_bit:
  2451                                  	; 15/11/2023
  2452 000013BE F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2453                                  					; last of the file?
  2454 000013C5 7402                    	jz	short lff32m2_0		; no
  2455 000013C7 F9                      	stc
  2456 000013C8 C3                      	retn
  2457                                  
  2458                                  lff32m2_0:
  2459 000013C9 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2460                                          ;mov	edx, [loadsize]
  2461                                  
  2462                                  	; esi = buffer address
  2463                                  	;; edx = buffer size
  2464                                  
  2465                                  	; load file into memory
  2466                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000013CE 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000013D4 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000013D6 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000013DC B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000013E1 CD40                <1>  int 40h
  2467 000013E3 723E                    	jc	short lff32m2_7 ; error !
  2468                                  
  2469 000013E5 BF[00300000]            	mov	edi, audio_buffer
  2470                                  	
  2471 000013EA D1E8                    	shr	eax, 1
  2472 000013EC 7505                    	jnz	short lff32m2_8
  2473 000013EE E9F3F6FFFF              	jmp	lff32_eof
  2474                                  
  2475                                  lff32m2_8:
  2476 000013F3 89C1                    	mov	ecx, eax  ; word count
  2477                                  lff32m2_1:
  2478 000013F5 66AD                    	lodsw
  2479 000013F7 66AB                    	stosw		; original sample (left channel)
  2480 000013F9 66AB                    	stosw		; original sample (right channel)
  2481 000013FB 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2482                                  	;mov	[previous_val], ax
  2483                                  	;mov	ebx, eax	
  2484                                  	;xor	eax, eax
  2485 000013FE 31DB                    	xor	ebx, ebx
  2486 00001400 49                      	dec	ecx
  2487 00001401 7403                    	jz	short lff32m2_2
  2488                                  	;mov	ax, [esi]
  2489 00001403 668B1E                  	mov	bx, [esi]
  2490                                  lff32m2_2:
  2491                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2492                                  	;mov	ebp, eax	; [next_val]
  2493                                  	;add	ax, [previous_val]
  2494                                  	; ax = [previous_val]
  2495                                  	; bx = [next_val]
  2496 00001406 6601D8                  	add	ax, bx
  2497 00001409 66D1D8                  	rcr	ax, 1
  2498 0000140C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2499 0000140F 66AB                    	stosw		; this is interpolated sample (L)
  2500 00001411 66AB                    	stosw		; this is interpolated sample (R)
  2501                                  
  2502                                  	; different than 8-16-24 kHZ !
  2503                                  	; 'original-interpolated-original' trio samples 
  2504 00001413 E309                    	jecxz	lff32m2_3
  2505                                  
  2506 00001415 66AD                    	lodsw
  2507 00001417 66AB                    	stosw		; original sample (left channel)
  2508 00001419 66AB                    	stosw		; original sample (right channel)
  2509                                  
  2510                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2511 0000141B 49                      	dec	ecx
  2512 0000141C 75D7                    	jnz	short lff32m2_1
  2513                                  lff32m2_3:
  2514 0000141E E9ABF6FFFF              	jmp	lff32_3
  2515                                  
  2516                                  lff32m2_7:
  2517                                  lff32s2_7:
  2518 00001423 E9C7F6FFFF              	jmp	lff32_5  ; error
  2519                                  
  2520                                  load_32khz_stereo_16_bit:
  2521                                  	; 16/11/2023
  2522                                  	; 15/11/2023
  2523 00001428 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2524                                  					; last of the file?
  2525 0000142F 7402                    	jz	short lff32s2_0		; no
  2526 00001431 F9                      	stc
  2527 00001432 C3                      	retn
  2528                                  
  2529                                  lff32s2_0:
  2530 00001433 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2531                                          ;mov	edx, [loadsize]
  2532                                  
  2533                                  	; esi = buffer address
  2534                                  	;; edx = buffer size
  2535                                  
  2536                                  	; load file into memory
  2537                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001438 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000143E 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001440 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001446 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000144B CD40                <1>  int 40h
  2538 0000144D 72D4                    	jc	short lff32s2_7 ; error !
  2539                                  
  2540 0000144F BF[00300000]            	mov	edi, audio_buffer
  2541                                  	
  2542 00001454 C1E802                  	shr	eax, 2
  2543 00001457 7505                    	jnz	short lff32s2_8
  2544 00001459 E988F6FFFF              	jmp	lff32_eof
  2545                                  
  2546                                  lff32s2_8:
  2547 0000145E 89C1                    	mov	ecx, eax ; dword count
  2548                                  lff32s2_1:
  2549 00001460 66AD                    	lodsw
  2550 00001462 66AB                    	stosw		; original sample (L)
  2551 00001464 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2552 00001467 66A3[3B200000]          	mov	[previous_val_l], ax
  2553 0000146D 66AD                    	lodsw
  2554 0000146F 66AB                    	stosw		; original sample (R)
  2555 00001471 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2556                                  	;mov	[previous_val_r], ax
  2557 00001474 89C3                    	mov	ebx, eax
  2558 00001476 31D2                    	xor	edx, edx
  2559 00001478 31C0                    	xor	eax, eax
  2560                                  	; 16/11/2023
  2561 0000147A 49                      	dec	ecx
  2562 0000147B 7407                    	jz	short lff32s2_2
  2563 0000147D 668B06                  	mov	ax, [esi]
  2564 00001480 668B5602                	mov	dx, [esi+2]
  2565                                  lff32s2_2:
  2566 00001484 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2567                                  	;;mov	[next_val_l], ax
  2568                                  	;mov	ebp, eax
  2569 00001487 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2570                                  	;mov	[next_val_r], dx
  2571 0000148A 660305[3B200000]        	add	ax, [previous_val_l]
  2572 00001491 66D1D8                  	rcr	ax, 1
  2573 00001494 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2574 00001497 66AB                    	stosw		; this is interpolated sample (L)
  2575                                  	;mov	ax, [next_val_r]
  2576 00001499 89D0                    	mov	eax, edx
  2577                                  	;add	ax, [previous_val_r]
  2578 0000149B 6601D8                  	add	ax, bx
  2579 0000149E 66D1D8                  	rcr	ax, 1
  2580 000014A1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2581 000014A4 66AB                    	stosw		; this is interpolated sample (R)
  2582                                  
  2583                                  	; different than 8-16-24 kHZ !
  2584                                  	; 'original-interpolated-original' trio samples 
  2585 000014A6 E30B                    	jecxz	lff32s2_3
  2586                                  
  2587 000014A8 66AD                    	lodsw
  2588 000014AA 66AB                    	stosw	; original sample (L)
  2589 000014AC 66AD                    	lodsw
  2590 000014AE 66AB                    	stosw	; original sample (R)
  2591                                  	
  2592                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2593 000014B0 49                      	dec	ecx
  2594 000014B1 75AD                    	jnz	short lff32s2_1
  2595                                  lff32s2_3:
  2596 000014B3 E916F6FFFF              	jmp	lff32_3
  2597                                  
  2598                                  ; .....................
  2599                                  
  2600                                  load_22khz_mono_8_bit:
  2601                                  	; 16/11/2023
  2602 000014B8 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2603                                  					; last of the file?
  2604 000014BF 7402                    	jz	short lff22m_0		; no
  2605 000014C1 F9                      	stc
  2606 000014C2 C3                      	retn
  2607                                  
  2608                                  lff22m_0:
  2609 000014C3 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2610                                          ;mov	edx, [loadsize]
  2611                                  
  2612                                  	; esi = buffer address
  2613                                  	;; edx = buffer size
  2614                                  
  2615                                  	; load file into memory
  2616                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000014C8 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000014CE 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000014D0 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000014D6 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000014DB CD40                <1>  int 40h
  2617 000014DD 725D                    	jc	short lff22m_7 ; error !
  2618                                  
  2619 000014DF BF[00300000]            	mov	edi, audio_buffer
  2620                                  	
  2621 000014E4 21C0                    	and	eax, eax
  2622 000014E6 7505                    	jnz	short lff22m_8
  2623 000014E8 E9F9F5FFFF              	jmp	lff22_eof
  2624                                  
  2625                                  lff22m_8:
  2626 000014ED 89C1                    	mov	ecx, eax	; byte count
  2627                                  lff22m_9:
  2628 000014EF BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2629 000014F4 C605[43200000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2630                                  lff22m_1:
  2631                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2632 000014FB AC                      	lodsb
  2633 000014FC B280                    	mov	dl, 80h
  2634 000014FE 49                      	dec	ecx
  2635 000014FF 7402                    	jz	short lff22m_2_1
  2636 00001501 8A16                    	mov	dl, [esi]
  2637                                  lff22m_2_1:	
  2638                                  	; al = [previous_val]
  2639                                  	; dl = [next_val]
  2640 00001503 E8EF050000              	call	interpolating_3_8bit_mono ; 1 of 17
  2641 00001508 E32D                    	jecxz	lff22m_3
  2642                                  lff22m_2_2:
  2643 0000150A AC                      	lodsb
  2644 0000150B B280                    	mov	dl, 80h
  2645 0000150D 49                      	dec	ecx
  2646 0000150E 7402                    	jz	short lff22m_2_3
  2647 00001510 8A16                    	mov	dl, [esi]
  2648                                  lff22m_2_3:
  2649 00001512 E864060000               	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2650 00001517 E31E                    	jecxz	lff22m_3
  2651 00001519 4D                      	dec	ebp
  2652 0000151A 75EE                    	jnz	short lff22m_2_2
  2653                                  
  2654 0000151C A0[43200000]            	mov	al, [faz]
  2655 00001521 FEC8                    	dec	al
  2656 00001523 74CA                    	jz	short lff22m_9
  2657 00001525 FE0D[43200000]          	dec	byte [faz]
  2658 0000152B BD04000000              	mov	ebp, 4
  2659 00001530 FEC8                    	dec	al
  2660 00001532 75C7                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2661 00001534 45                      	inc	ebp ; 5
  2662 00001535 EBC4                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2663                                  
  2664                                  lff22m_3:
  2665                                  lff22s_3:
  2666 00001537 E992F5FFFF              	jmp	lff22_3	; padfill
  2667                                  		; (put zeros in the remain words of the buffer)
  2668                                  lff22m_7:
  2669                                  lff22s_7:
  2670 0000153C E9AEF5FFFF              	jmp	lff22_5  ; error
  2671                                  
  2672                                  load_22khz_stereo_8_bit:
  2673                                  	; 16/11/2023
  2674 00001541 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2675                                  					; last of the file?
  2676 00001548 7402                    	jz	short lff22s_0		; no
  2677 0000154A F9                      	stc
  2678 0000154B C3                      	retn
  2679                                  
  2680                                  lff22s_0:
  2681 0000154C BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2682                                          ;mov	edx, [loadsize]
  2683                                  
  2684                                  	; esi = buffer address
  2685                                  	;; edx = buffer size
  2686                                  
  2687                                  	; load file into memory
  2688                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001551 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001557 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001559 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000155F B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001564 CD40                <1>  int 40h
  2689 00001566 72D4                    	jc	short lff22s_7 ; error !
  2690                                  
  2691 00001568 BF[00300000]            	mov	edi, audio_buffer
  2692                                  	
  2693 0000156D D1E8                    	shr	eax, 1
  2694 0000156F 7505                    	jnz	short lff22s_8
  2695 00001571 E970F5FFFF              	jmp	lff22_eof
  2696                                  
  2697                                  lff22s_8:
  2698 00001576 89C1                    	mov	ecx, eax	; word count
  2699                                  lff22s_9:
  2700 00001578 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2701 0000157D C605[43200000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2702                                  lff22s_1:
  2703                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2704 00001584 66AD                    	lodsw
  2705 00001586 66BA8080                	mov	dx, 8080h
  2706 0000158A 49                      	dec	ecx
  2707 0000158B 7403                    	jz	short lff22s_2_1 
  2708 0000158D 668B16                  	mov	dx, [esi]
  2709                                  lff22s_2_1:	
  2710                                  	; al = [previous_val_l]
  2711                                  	; ah = [previous_val_r]
  2712                                  	; dl = [next_val_l]
  2713                                  	; dh = [next_val_r]	
  2714 00001590 E893050000              	call	interpolating_3_8bit_stereo ; 1 of 17 
  2715 00001595 E3A0                    	jecxz	lff22s_3
  2716                                  lff22s_2_2:
  2717 00001597 66AD                    	lodsw
  2718 00001599 66BA8080                	mov	dx, 8080h
  2719 0000159D 49                      	dec	ecx
  2720 0000159E 7403                    	jz	short lff22s_2_3
  2721 000015A0 668B16                  	mov	dx, [esi]
  2722                                  lff22s_2_3:
  2723 000015A3 E8F0050000               	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2724 000015A8 E38D                    	jecxz	lff22s_3
  2725 000015AA 4D                      	dec	ebp
  2726 000015AB 75EA                    	jnz	short lff22s_2_2
  2727                                  
  2728 000015AD A0[43200000]            	mov	al, [faz]
  2729 000015B2 FEC8                    	dec	al
  2730 000015B4 74C2                    	jz	short lff22s_9
  2731 000015B6 FE0D[43200000]          	dec	byte [faz]
  2732 000015BC BD04000000              	mov	ebp, 4
  2733 000015C1 FEC8                    	dec	al
  2734 000015C3 75BF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2735 000015C5 45                      	inc	ebp ; 5
  2736 000015C6 EBBC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2737                                  
  2738                                  load_22khz_mono_16_bit:
  2739                                  	; 16/11/2023
  2740 000015C8 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2741                                  					; last of the file?
  2742 000015CF 7402                    	jz	short lff22m2_0		; no
  2743 000015D1 F9                      	stc
  2744 000015D2 C3                      	retn
  2745                                  
  2746                                  lff22m2_0:
  2747 000015D3 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2748                                          ;mov	edx, [loadsize]
  2749                                  
  2750                                  	; esi = buffer address
  2751                                  	;; edx = buffer size
  2752                                  
  2753                                  	; load file into memory
  2754                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000015D8 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000015DE 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000015E0 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000015E6 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000015EB CD40                <1>  int 40h
  2755 000015ED 7261                    	jc	short lff22m2_7 ; error !
  2756                                  
  2757 000015EF BF[00300000]            	mov	edi, audio_buffer
  2758                                  	
  2759 000015F4 D1E8                    	shr	eax, 1
  2760 000015F6 7505                    	jnz	short lff22m2_8
  2761 000015F8 E9E9F4FFFF              	jmp	lff22_eof
  2762                                  
  2763                                  lff22m2_8:
  2764 000015FD 89C1                    	mov	ecx, eax	; word count
  2765                                  lff22m2_9:
  2766 000015FF BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2767 00001604 C605[43200000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2768                                  lff22m2_1:
  2769                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2770 0000160B 66AD                    	lodsw
  2771 0000160D 31D2                    	xor	edx, edx
  2772 0000160F 49                      	dec	ecx
  2773 00001610 7403                    	jz	short lff22m2_2_1
  2774 00001612 668B16                  	mov	dx, [esi]
  2775                                  lff22m2_2_1:	
  2776                                  	; ax = [previous_val]
  2777                                  	; dx = [next_val]
  2778 00001615 E8AF050000              	call	interpolating_3_16bit_mono ; 1 of 17
  2779 0000161A E32F                    	jecxz	lff22m2_3
  2780                                  lff22m2_2_2:
  2781 0000161C 66AD                    	lodsw
  2782 0000161E 31D2                    	xor	edx, edx
  2783 00001620 49                      	dec	ecx
  2784 00001621 7403                    	jz	short lff22m2_2_3
  2785 00001623 668B16                  	mov	dx, [esi]
  2786                                  lff22m2_2_3:
  2787 00001626 E831060000               	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2788 0000162B E31E                    	jecxz	lff22m2_3
  2789 0000162D 4D                      	dec	ebp
  2790 0000162E 75EC                    	jnz	short lff22m2_2_2
  2791                                  
  2792 00001630 A0[43200000]            	mov	al, [faz]
  2793 00001635 FEC8                    	dec	al
  2794 00001637 74C6                    	jz	short lff22m2_9
  2795 00001639 FE0D[43200000]          	dec	byte [faz]
  2796 0000163F BD04000000              	mov	ebp, 4
  2797 00001644 FEC8                    	dec	al
  2798 00001646 75C3                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2799 00001648 45                      	inc	ebp ; 5
  2800 00001649 EBC0                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2801                                  
  2802                                  lff22m2_3:
  2803                                  lff22s2_3:
  2804 0000164B E97EF4FFFF              	jmp	lff22_3	; padfill
  2805                                  		; (put zeros in the remain words of the buffer)
  2806                                  lff22m2_7:
  2807                                  lff22s2_7:
  2808 00001650 E99AF4FFFF              	jmp	lff22_5  ; error
  2809                                  
  2810                                  load_22khz_stereo_16_bit:
  2811                                  	; 16/11/2023
  2812 00001655 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2813                                  					; last of the file?
  2814 0000165C 7402                    	jz	short lff22s2_0		; no
  2815 0000165E F9                      	stc
  2816 0000165F C3                      	retn
  2817                                  
  2818                                  lff22s2_0:
  2819 00001660 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2820                                          ;mov	edx, [loadsize]
  2821                                  
  2822                                  	; esi = buffer address
  2823                                  	;; edx = buffer size
  2824                                  
  2825                                  	; load file into memory
  2826                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001665 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000166B 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000166D 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001673 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001678 CD40                <1>  int 40h
  2827 0000167A 72D4                    	jc	short lff22s2_7 ; error !
  2828                                  
  2829 0000167C BF[00300000]            	mov	edi, audio_buffer
  2830                                  	
  2831 00001681 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  2832 00001684 7505                    	jnz	short lff22s2_8
  2833 00001686 E95BF4FFFF              	jmp	lff22_eof
  2834                                  
  2835                                  lff22s2_8:
  2836 0000168B 89C1                    	mov	ecx, eax	; dword count
  2837                                  lff22s2_9:
  2838 0000168D BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2839 00001692 C605[43200000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2840                                  lff22s2_1:
  2841                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2842 00001699 66AD                    	lodsw
  2843 0000169B 89C3                    	mov	ebx, eax
  2844 0000169D 66AD                    	lodsw
  2845 0000169F 8B16                    	mov	edx, [esi]
  2846 000016A1 668915[3F200000]        	mov	[next_val_l], dx
  2847                                  	; 26/11/2023
  2848 000016A8 C1EA10                  	shr	edx, 16
  2849 000016AB 49                      	dec	ecx
  2850 000016AC 7509                    	jnz	short lff22s2_2_1
  2851 000016AE 31D2                    	xor	edx, edx ; 0
  2852 000016B0 668915[3F200000]        	mov	[next_val_l], dx
  2853                                  lff22s2_2_1:
  2854                                  	; bx = [previous_val_l]
  2855                                  	; ax = [previous_val_r]
  2856                                  	; [next_val_l]
  2857                                  	; dx = [next_val_r]
  2858 000016B7 E83D050000              	call	interpolating_3_16bit_stereo ; 1 of 17 
  2859 000016BC E38D                    	jecxz	lff22s2_3
  2860                                  lff22s2_2_2:
  2861 000016BE 66AD                    	lodsw
  2862 000016C0 89C3                    	mov	ebx, eax
  2863 000016C2 66AD                    	lodsw
  2864 000016C4 8B16                    	mov	edx, [esi]
  2865 000016C6 668915[3F200000]        	mov	[next_val_l], dx
  2866                                  	; 26/11/2023
  2867 000016CD C1EA10                  	shr	edx, 16
  2868 000016D0 49                      	dec	ecx
  2869 000016D1 7509                    	jnz	short lff22s2_2_3
  2870 000016D3 31D2                    	xor	edx, edx ; 0
  2871 000016D5 668915[3F200000]        	mov	[next_val_l], dx
  2872                                  lff22s2_2_3:
  2873 000016DC E893050000               	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  2874 000016E1 E31E                    	jecxz	lff22s2_2_4
  2875                                  
  2876 000016E3 4D                      	dec	ebp
  2877 000016E4 75D8                    	jnz	short lff22s2_2_2
  2878                                  
  2879 000016E6 A0[43200000]            	mov	al, [faz]
  2880 000016EB FEC8                    	dec	al
  2881 000016ED 749E                    	jz	short lff22s2_9
  2882 000016EF FE0D[43200000]          	dec	byte [faz]
  2883 000016F5 BD04000000              	mov	ebp, 4
  2884 000016FA FEC8                    	dec	al
  2885 000016FC 759B                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2886 000016FE 45                      	inc	ebp ; 5
  2887 000016FF EB98                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2888                                  
  2889                                  lff22s2_2_4:
  2890                                  	; 26/11/2023
  2891 00001701 E9C8F3FFFF              	jmp	lff22_3	; padfill
  2892                                  
  2893                                  ; .....................
  2894                                  
  2895                                  load_11khz_mono_8_bit:
  2896                                  	; 18/11/2023
  2897 00001706 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2898                                  					; last of the file?
  2899 0000170D 7402                    	jz	short lff11m_0		; no
  2900 0000170F F9                      	stc
  2901 00001710 C3                      	retn
  2902                                  
  2903                                  lff11m_0:
  2904 00001711 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2905                                          ;mov	edx, [loadsize]
  2906                                  
  2907                                  	; esi = buffer address
  2908                                  	;; edx = buffer size
  2909                                  
  2910                                  	; load file into memory
  2911                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001716 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000171C 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000171E 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001724 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001729 CD40                <1>  int 40h
  2912 0000172B 7247                    	jc	short lff11m_7 ; error !
  2913                                  
  2914 0000172D BF[00300000]            	mov	edi, audio_buffer
  2915                                  	
  2916 00001732 21C0                    	and	eax, eax
  2917 00001734 7505                    	jnz	short lff11m_8
  2918 00001736 E9ABF3FFFF              	jmp	lff11_eof
  2919                                  
  2920                                  lff11m_8:
  2921 0000173B 89C1                    	mov	ecx, eax		; byte count
  2922                                  lff11m_9:
  2923 0000173D BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  2924                                  lff11m_1:
  2925                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2926 00001742 AC                      	lodsb
  2927 00001743 B280                    	mov	dl, 80h
  2928 00001745 49                      	dec	ecx
  2929 00001746 7402                    	jz	short lff11m_2_1
  2930 00001748 8A16                    	mov	dl, [esi]
  2931                                  lff11m_2_1:	
  2932                                  	; al = [previous_val]
  2933                                  	; dl = [next_val]
  2934 0000174A E854050000              	call	interpolating_5_8bit_mono
  2935 0000174F E328                    	jecxz	lff11m_3
  2936                                  lff11m_2_2:
  2937 00001751 AC                      	lodsb
  2938 00001752 B280                    	mov	dl, 80h
  2939 00001754 49                      	dec	ecx
  2940 00001755 7402                    	jz	short lff11m_2_3
  2941 00001757 8A16                    	mov	dl, [esi]
  2942                                  lff11m_2_3:
  2943 00001759 E851060000               	call	interpolating_4_8bit_mono
  2944 0000175E E319                    	jecxz	lff11m_3
  2945                                  
  2946 00001760 4D                      	dec	ebp
  2947 00001761 74DA                    	jz	short lff11m_9
  2948                                  
  2949 00001763 AC                      	lodsb
  2950 00001764 B280                    	mov	dl, 80h
  2951 00001766 49                      	dec	ecx
  2952 00001767 7402                    	jz	short lff11m_2_4
  2953 00001769 8A16                    	mov	dl, [esi]
  2954                                  lff11m_2_4:
  2955 0000176B E83F060000              	call	interpolating_4_8bit_mono
  2956 00001770 E307                    	jecxz	lff11m_3
  2957 00001772 EBCE                    	jmp	short lff11m_1
  2958                                  
  2959                                  lff11m_7:
  2960                                  lff11s_7:
  2961 00001774 E976F3FFFF              	jmp	lff11_5  ; error
  2962                                  
  2963                                  lff11m_3:
  2964                                  lff11s_3:
  2965 00001779 E950F3FFFF              	jmp	lff11_3	; padfill
  2966                                  		; (put zeros in the remain words of the buffer)
  2967                                  
  2968                                  load_11khz_stereo_8_bit:
  2969                                  	; 18/11/2023
  2970 0000177E F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2971                                  					; last of the file?
  2972 00001785 7402                    	jz	short lff11s_0		; no
  2973 00001787 F9                      	stc
  2974 00001788 C3                      	retn
  2975                                  
  2976                                  lff11s_0:
  2977 00001789 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2978                                          ;mov	edx, [loadsize]
  2979                                  
  2980                                  	; esi = buffer address
  2981                                  	;; edx = buffer size
  2982                                  
  2983                                  	; load file into memory
  2984                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000178E 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001794 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001796 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000179C B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000017A1 CD40                <1>  int 40h
  2985 000017A3 72CF                    	jc	short lff11s_7 ; error !
  2986                                  
  2987 000017A5 BF[00300000]            	mov	edi, audio_buffer
  2988                                  	
  2989 000017AA D1E8                    	shr	eax, 1
  2990 000017AC 7505                    	jnz	short lff11s_8
  2991 000017AE E933F3FFFF              	jmp	lff11_eof
  2992                                  
  2993                                  lff11s_8:
  2994 000017B3 89C1                    	mov	ecx, eax	; word count
  2995                                  lff11s_9:
  2996 000017B5 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  2997                                  lff11s_1:
  2998                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2999 000017BA 66AD                    	lodsw
  3000 000017BC 66BA8080                	mov	dx, 8080h
  3001 000017C0 49                      	dec	ecx
  3002 000017C1 7403                    	jz	short lff11s_2_1 
  3003 000017C3 668B16                  	mov	dx, [esi]
  3004                                  lff11s_2_1:	
  3005                                  	; al = [previous_val_l]
  3006                                  	; ah = [previous_val_r]
  3007                                  	; dl = [next_val_l]
  3008                                  	; dh = [next_val_r]	
  3009 000017C6 E837050000              	call	interpolating_5_8bit_stereo
  3010 000017CB E3AC                    	jecxz	lff11s_3
  3011                                  lff11s_2_2:
  3012 000017CD 66AD                    	lodsw
  3013 000017CF 66BA8080                	mov	dx, 8080h
  3014 000017D3 49                      	dec	ecx
  3015 000017D4 7403                    	jz	short lff11s_2_3
  3016 000017D6 668B16                  	mov	dx, [esi]
  3017                                  lff11s_2_3:
  3018 000017D9 E810060000               	call	interpolating_4_8bit_stereo
  3019 000017DE E399                    	jecxz	lff11s_3
  3020                                  	
  3021 000017E0 4D                      	dec	ebp
  3022 000017E1 74D2                    	jz	short lff11s_9
  3023                                  
  3024 000017E3 66AD                    	lodsw
  3025 000017E5 66BA8080                	mov	dx, 8080h
  3026 000017E9 49                      	dec	ecx
  3027 000017EA 7403                    	jz	short lff11s_2_4
  3028 000017EC 668B16                  	mov	dx, [esi]
  3029                                  lff11s_2_4:
  3030 000017EF E8FA050000              	call	interpolating_4_8bit_stereo
  3031 000017F4 E383                    	jecxz	lff11s_3
  3032 000017F6 EBC2                    	jmp	short lff11s_1
  3033                                  
  3034                                  load_11khz_mono_16_bit:
  3035                                  	; 18/11/2023
  3036 000017F8 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3037                                  					; last of the file?
  3038 000017FF 7402                    	jz	short lff11m2_0		; no
  3039 00001801 F9                      	stc
  3040 00001802 C3                      	retn
  3041                                  
  3042                                  lff11m2_0:
  3043 00001803 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3044                                          ;mov	edx, [loadsize]
  3045                                  
  3046                                  	; esi = buffer address
  3047                                  	;; edx = buffer size
  3048                                  
  3049                                  	; load file into memory
  3050                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001808 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000180E 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001810 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001816 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000181B CD40                <1>  int 40h
  3051 0000181D 724D                    	jc	short lff11m2_7 ; error !
  3052                                  
  3053 0000181F BF[00300000]            	mov	edi, audio_buffer
  3054                                  	
  3055 00001824 D1E8                    	shr	eax, 1
  3056 00001826 7505                    	jnz	short lff11m2_8
  3057 00001828 E9B9F2FFFF              	jmp	lff11_eof
  3058                                  
  3059                                  lff11m2_8:
  3060 0000182D 89C1                    	mov	ecx, eax	; word count
  3061                                  lff11m2_9:
  3062 0000182F BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3063                                  lff11m2_1:
  3064                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3065 00001834 66AD                    	lodsw
  3066 00001836 31D2                    	xor	edx, edx
  3067 00001838 49                      	dec	ecx
  3068 00001839 7403                    	jz	short lff11m2_2_1
  3069 0000183B 668B16                  	mov	dx, [esi]
  3070                                  lff11m2_2_1:	
  3071                                  	; ax = [previous_val]
  3072                                  	; dx = [next_val]
  3073 0000183E E818060000              	call	interpolating_5_16bit_mono
  3074 00001843 E362                    	jecxz	lff11m2_3
  3075                                  lff11m2_2_2:
  3076 00001845 66AD                    	lodsw
  3077 00001847 31D2                    	xor	edx, edx
  3078 00001849 49                      	dec	ecx
  3079 0000184A 7403                    	jz	short lff11m2_2_3
  3080 0000184C 668B16                  	mov	dx, [esi]
  3081                                  lff11m2_2_3:
  3082 0000184F E831070000               	call	interpolating_4_16bit_mono
  3083 00001854 E351                    	jecxz	lff11m2_3
  3084                                  
  3085 00001856 4D                      	dec	ebp
  3086 00001857 74D6                    	jz	short lff11m2_9
  3087                                  
  3088 00001859 66AD                    	lodsw
  3089 0000185B 31D2                    	xor	edx, edx
  3090 0000185D 49                      	dec	ecx
  3091 0000185E 7403                    	jz	short lff11m2_2_4
  3092 00001860 668B16                  	mov	dx, [esi]
  3093                                  lff11m2_2_4:
  3094 00001863 E81D070000               	call	interpolating_4_16bit_mono
  3095 00001868 E33D                    	jecxz	lff11m2_3
  3096 0000186A EBC8                    	jmp	short lff11m2_1
  3097                                  
  3098                                  lff11m2_7:
  3099                                  lff11s2_7:
  3100 0000186C E97EF2FFFF              	jmp	lff11_5  ; error
  3101                                  
  3102                                  load_11khz_stereo_16_bit:
  3103                                  	; 17/01/2025
  3104                                  	; 18/11/2023
  3105 00001871 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3106                                  					; last of the file?
  3107 00001878 7402                    	jz	short lff11s2_0		; no
  3108 0000187A F9                      	stc
  3109 0000187B C3                      	retn
  3110                                  
  3111                                  lff11s2_0:
  3112 0000187C BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3113                                          ;mov	edx, [loadsize]
  3114                                  
  3115                                  	; esi = buffer address
  3116                                  	;; edx = buffer size
  3117                                  
  3118                                  	; load file into memory
  3119                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001881 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001887 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001889 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000188F B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001894 CD40                <1>  int 40h
  3120 00001896 72D4                    	jc	short lff11s2_7 ; error !
  3121                                  
  3122 00001898 BF[00300000]            	mov	edi, audio_buffer
  3123                                  	
  3124 0000189D C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3125 000018A0 750A                    	jnz	short lff11s2_8
  3126 000018A2 E93FF2FFFF              	jmp	lff11_eof
  3127                                  
  3128                                  lff11m2_3:
  3129                                  lff11s2_3:
  3130 000018A7 E922F2FFFF              	jmp	lff11_3	; padfill
  3131                                  		; (put zeros in the remain words of the buffer)
  3132                                  
  3133                                  lff11s2_8:
  3134 000018AC 89C1                    	mov	ecx, eax	; dword count
  3135                                  lff11s2_9:
  3136 000018AE BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3137                                  lff11s2_1:
  3138                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3139 000018B3 66AD                    	lodsw
  3140 000018B5 89C3                    	mov	ebx, eax
  3141 000018B7 66AD                    	lodsw
  3142 000018B9 8B16                    	mov	edx, [esi]
  3143                                  	; 17/01/2025
  3144                                  	;mov	[next_val_l], edx
  3145                                  	; 26/11/2023
  3146                                  	;shr	edx, 16
  3147                                  	;mov	[next_val_r], dx
  3148 000018BB 49                      	dec	ecx
  3149 000018BC 7502                    	jnz	short lff11s2_2_1
  3150 000018BE 31D2                    	xor	edx, edx ; 0
  3151                                  	;mov	[next_val_l], dx
  3152                                  	;mov	[next_val_r], dx
  3153                                  lff11s2_2_1:
  3154                                  	; bx = [previous_val_l]
  3155                                  	; ax = [previous_val_r]
  3156                                  	; [next_val_l]
  3157                                  	; dx = [next_val_r]
  3158                                  	;;;
  3159                                  	; 17/01/2025 (BugFix)
  3160 000018C0 8915[3F200000]          	mov	[next_val_l], edx
  3161                                  	;;;
  3162 000018C6 E8EB050000              	call	interpolating_5_16bit_stereo
  3163 000018CB E3DA                    	jecxz	lff11s2_3
  3164                                  lff11s2_2_2:
  3165 000018CD 66AD                    	lodsw
  3166 000018CF 89C3                    	mov	ebx, eax
  3167 000018D1 66AD                    	lodsw
  3168 000018D3 8B16                    	mov	edx, [esi]
  3169                                  	; 17/01/2025
  3170                                  	;mov	[next_val_l], dx
  3171                                  	; 26/11/2023
  3172                                  	;shr	edx, 16
  3173                                  	;mov	[next_val_r], dx
  3174 000018D5 49                      	dec	ecx
  3175 000018D6 7502                    	jnz	short lff11s2_2_3
  3176 000018D8 31D2                    	xor	edx, edx ; 0
  3177                                  	;mov	[next_val_l], dx
  3178                                  	;mov	[next_val_r], dx
  3179                                  lff11s2_2_3:
  3180                                  	;;;
  3181                                  	; 17/01/2025 (BugFix)
  3182 000018DA 8915[3F200000]          	mov	[next_val_l], edx
  3183                                  	;;;
  3184 000018E0 E8D9060000              	call	interpolating_4_16bit_stereo
  3185 000018E5 E3C0                    	jecxz	lff11s2_3
  3186                                  	
  3187 000018E7 4D                      	dec	ebp
  3188 000018E8 74C4                    	jz	short lff11s2_9
  3189                                  
  3190 000018EA 66AD                    	lodsw
  3191 000018EC 89C3                    	mov	ebx, eax
  3192 000018EE 66AD                    	lodsw
  3193 000018F0 8B16                    	mov	edx, [esi]
  3194                                  	; 17/01/2025
  3195                                  	;mov	[next_val_l], dx
  3196                                  	; 26/11/2023
  3197                                  	;shr	edx, 16
  3198                                  	;mov	[next_val_r], dx
  3199 000018F2 49                      	dec	ecx
  3200 000018F3 7502                    	jnz	short lff11s2_2_4
  3201 000018F5 31D2                    	xor	edx, edx ; 0
  3202                                  	;mov	[next_val_l], dx
  3203                                  	;mov	[next_val_r], dx
  3204                                  lff11s2_2_4:
  3205                                  	;;;
  3206                                  	; 17/01/2025 (BugFix)
  3207 000018F7 8915[3F200000]          	mov	[next_val_l], edx
  3208                                  	;;;
  3209 000018FD E8BC060000               	call	interpolating_4_16bit_stereo
  3210 00001902 E3A3                    	jecxz	lff11s2_3
  3211 00001904 EBAD                    	jmp	short lff11s2_1
  3212                                  
  3213                                  ; .....................
  3214                                  
  3215                                  load_44khz_mono_8_bit:
  3216                                  	; 18/11/2023
  3217 00001906 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3218                                  					; last of the file?
  3219 0000190D 7402                    	jz	short lff44m_0		; no
  3220 0000190F F9                      	stc
  3221 00001910 C3                      	retn
  3222                                  
  3223                                  lff44m_0:
  3224 00001911 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3225                                          ;mov	edx, [loadsize]
  3226                                  
  3227                                  	; esi = buffer address
  3228                                  	;; edx = buffer size
  3229                                  
  3230                                  	; load file into memory
  3231                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001916 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000191C 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000191E 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001924 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001929 CD40                <1>  int 40h
  3232 0000192B 7250                    	jc	short lff44m_7 ; error !
  3233                                  
  3234 0000192D BF[00300000]            	mov	edi, audio_buffer
  3235                                  	
  3236 00001932 21C0                    	and	eax, eax
  3237 00001934 7505                    	jnz	short lff44m_8
  3238 00001936 E9ABF1FFFF              	jmp	lff44_eof
  3239                                  
  3240                                  lff44m_8:
  3241 0000193B 89C1                    	mov	ecx, eax	; byte count
  3242                                  lff44m_9:
  3243 0000193D BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3244 00001942 C605[43200000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3245                                  lff44m_1:
  3246                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3247                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3248 00001949 AC                      	lodsb
  3249 0000194A B280                    	mov	dl, 80h
  3250 0000194C 49                      	dec	ecx
  3251 0000194D 7402                    	jz	short lff44m_2_1
  3252 0000194F 8A16                    	mov	dl, [esi]
  3253                                  lff44m_2_1:	
  3254                                  	; al = [previous_val]
  3255                                  	; dl = [next_val]
  3256 00001951 E825020000              	call	interpolating_2_8bit_mono
  3257 00001956 E320                    	jecxz	lff44m_3
  3258                                  lff44m_2_2:
  3259 00001958 AC                      	lodsb
  3260 00001959 2C80                    	sub	al, 80h
  3261 0000195B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3262 0000195F 66AB                    	stosw		; (L)
  3263 00001961 66AB                    	stosw		; (R)	
  3264                                  
  3265 00001963 49                      	dec	ecx
  3266 00001964 7412                    	jz	short lff44m_3	
  3267 00001966 4D                      	dec	ebp
  3268 00001967 75EF                    	jnz	short lff44m_2_2
  3269                                  	
  3270 00001969 FE0D[43200000]          	dec	byte [faz]
  3271 0000196F 74CC                    	jz	short lff44m_9 
  3272 00001971 BD0B000000              	mov	ebp, 11
  3273 00001976 EBD1                    	jmp	short lff44m_1
  3274                                  
  3275                                  lff44m_3:
  3276                                  lff44s_3:
  3277 00001978 E951F1FFFF              	jmp	lff44_3	; padfill
  3278                                  		; (put zeros in the remain words of the buffer)
  3279                                  lff44m_7:
  3280                                  lff44s_7:
  3281 0000197D E96DF1FFFF              	jmp	lff44_5  ; error
  3282                                  
  3283                                  load_44khz_stereo_8_bit:
  3284                                  	; 16/11/2023
  3285 00001982 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3286                                  					; last of the file?
  3287 00001989 7402                    	jz	short lff44s_0		; no
  3288 0000198B F9                      	stc
  3289 0000198C C3                      	retn
  3290                                  
  3291                                  lff44s_0:
  3292 0000198D BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3293                                          ;mov	edx, [loadsize]
  3294                                  
  3295                                  	; esi = buffer address
  3296                                  	;; edx = buffer size
  3297                                  
  3298                                  	; load file into memory
  3299                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001992 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001998 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000199A 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000019A0 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000019A5 CD40                <1>  int 40h
  3300 000019A7 72D4                    	jc	short lff44s_7 ; error !
  3301                                  
  3302 000019A9 BF[00300000]            	mov	edi, audio_buffer
  3303                                  	
  3304 000019AE D1E8                    	shr	eax, 1
  3305 000019B0 7505                    	jnz	short lff44s_8
  3306 000019B2 E92FF1FFFF              	jmp	lff44_eof
  3307                                  
  3308                                  lff44s_8:
  3309 000019B7 89C1                    	mov	ecx, eax	; word count
  3310                                  lff44s_9:
  3311 000019B9 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3312 000019BE C605[43200000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3313                                  lff44s_1:
  3314                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3315                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3316 000019C5 66AD                    	lodsw
  3317 000019C7 66BA8080                	mov	dx, 8080h
  3318 000019CB 49                      	dec	ecx
  3319 000019CC 7403                    	jz	short lff44s_2_1 
  3320 000019CE 668B16                  	mov	dx, [esi]
  3321                                  lff44s_2_1:	
  3322                                  	; al = [previous_val_l]
  3323                                  	; ah = [previous_val_r]
  3324                                  	; dl = [next_val_l]
  3325                                  	; dh = [next_val_r]	
  3326 000019D1 E8C2010000              	call	interpolating_2_8bit_stereo
  3327 000019D6 E3A0                    	jecxz	lff44s_3
  3328                                  lff44s_2_2:
  3329 000019D8 AC                      	lodsb
  3330 000019D9 2C80                    	sub	al, 80h
  3331 000019DB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3332 000019DF 66AB                    	stosw		; (L)
  3333 000019E1 AC                      	lodsb
  3334 000019E2 2C80                    	sub	al, 80h
  3335 000019E4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3336 000019E8 66AB                    	stosw		; (R)
  3337                                  
  3338 000019EA 49                      	dec	ecx
  3339 000019EB 748B                    	jz	short lff44s_3	
  3340 000019ED 4D                      	dec	ebp
  3341 000019EE 75E8                    	jnz	short lff44s_2_2
  3342                                  	
  3343 000019F0 FE0D[43200000]          	dec	byte [faz]
  3344 000019F6 74C1                    	jz	short lff44s_9 
  3345 000019F8 BD0B000000              	mov	ebp, 11
  3346 000019FD EBC6                    	jmp	short lff44s_1
  3347                                  
  3348                                  load_44khz_mono_16_bit:
  3349                                  	; 18/11/2023
  3350 000019FF F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3351                                  					; last of the file?
  3352 00001A06 7402                    	jz	short lff44m2_0		; no
  3353 00001A08 F9                      	stc
  3354 00001A09 C3                      	retn
  3355                                  
  3356                                  lff44m2_0:
  3357 00001A0A BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3358                                          ;mov	edx, [loadsize]
  3359                                  
  3360                                  	; esi = buffer address
  3361                                  	;; edx = buffer size
  3362                                  
  3363                                  	; load file into memory
  3364                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001A0F 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001A15 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001A17 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001A1D B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001A22 CD40                <1>  int 40h
  3365 00001A24 724D                    	jc	short lff44m2_7 ; error !
  3366                                  
  3367 00001A26 BF[00300000]            	mov	edi, audio_buffer
  3368                                  	
  3369 00001A2B D1E8                    	shr	eax, 1
  3370 00001A2D 7505                    	jnz	short lff44m2_8
  3371 00001A2F E9B2F0FFFF              	jmp	lff44_eof
  3372                                  
  3373                                  lff44m2_8:
  3374 00001A34 89C1                    	mov	ecx, eax	; word count
  3375                                  lff44m2_9:
  3376 00001A36 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3377 00001A3B C605[43200000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3378                                  lff44m2_1:
  3379                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3380                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3381 00001A42 66AD                    	lodsw
  3382 00001A44 31D2                    	xor	edx, edx
  3383 00001A46 49                      	dec	ecx
  3384 00001A47 7403                    	jz	short lff44m2_2_1
  3385 00001A49 668B16                  	mov	dx, [esi]
  3386                                  lff44m2_2_1:	
  3387                                  	; ax = [previous_val]
  3388                                  	; dx = [next_val]
  3389 00001A4C E80B020000              	call	interpolating_2_16bit_mono
  3390 00001A51 E31B                    	jecxz	lff44m2_3
  3391                                  lff44m2_2_2:
  3392 00001A53 66AD                    	lodsw
  3393 00001A55 66AB                    	stosw		; (L)eft Channel
  3394 00001A57 66AB                    	stosw		; (R)ight Channel
  3395                                  
  3396 00001A59 49                      	dec	ecx
  3397 00001A5A 7412                    	jz	short lff44m2_3	
  3398 00001A5C 4D                      	dec	ebp
  3399 00001A5D 75F4                    	jnz	short lff44m2_2_2
  3400                                  	
  3401 00001A5F FE0D[43200000]          	dec	byte [faz]
  3402 00001A65 74CF                    	jz	short lff44m2_9 
  3403 00001A67 BD0B000000              	mov	ebp, 11
  3404 00001A6C EBD4                    	jmp	short lff44m2_1
  3405                                  
  3406                                  lff44m2_3:
  3407                                  lff44s2_3:
  3408 00001A6E E95BF0FFFF              	jmp	lff44_3	; padfill
  3409                                  		; (put zeros in the remain words of the buffer)
  3410                                  lff44m2_7:
  3411                                  lff44s2_7:
  3412 00001A73 E977F0FFFF              	jmp	lff44_5  ; error
  3413                                  
  3414                                  load_44khz_stereo_16_bit:
  3415                                  	; 18/11/2023
  3416 00001A78 F605[30230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3417                                  					; last of the file?
  3418 00001A7F 7402                    	jz	short lff44s2_0		; no
  3419 00001A81 F9                      	stc
  3420 00001A82 C3                      	retn
  3421                                  
  3422                                  lff44s2_0:
  3423 00001A83 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3424                                          ;mov	edx, [loadsize]
  3425                                  
  3426                                  	; esi = buffer address
  3427                                  	;; edx = buffer size
  3428                                  
  3429                                  	; load file into memory
  3430                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001A88 8B1D[44200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001A8E 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001A90 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001A96 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001A9B CD40                <1>  int 40h
  3431 00001A9D 72D4                    	jc	short lff44s2_7 ; error !
  3432                                  
  3433 00001A9F BF[00300000]            	mov	edi, audio_buffer
  3434                                  	
  3435 00001AA4 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3436 00001AA7 7505                    	jnz	short lff44s2_8
  3437 00001AA9 E938F0FFFF              	jmp	lff44_eof
  3438                                  
  3439                                  lff44s2_8:
  3440 00001AAE 89C1                    	mov	ecx, eax	; dword count
  3441                                  lff44s2_9:
  3442 00001AB0 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3443 00001AB5 C605[43200000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3444                                  lff44s2_1:
  3445                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3446                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3447 00001ABC 66AD                    	lodsw
  3448 00001ABE 89C3                    	mov	ebx, eax
  3449 00001AC0 66AD                    	lodsw
  3450                                  	;mov	dx, [esi]
  3451                                  	;mov	[next_val_l], dx
  3452                                  	;mov	dx, [esi+2]
  3453                                  	; 26/11/2023
  3454 00001AC2 8B16                    	mov	edx, [esi]
  3455 00001AC4 668915[3F200000]        	mov	[next_val_l], dx
  3456 00001ACB C1EA10                  	shr	edx, 16
  3457 00001ACE 49                      	dec	ecx
  3458 00001ACF 7509                    	jnz	short lff44s2_2_1
  3459 00001AD1 31D2                    	xor	edx, edx ; 0
  3460 00001AD3 668915[3F200000]        	mov	[next_val_l], dx
  3461                                  lff44s2_2_1:
  3462                                  	; bx = [previous_val_l]
  3463                                  	; ax = [previous_val_r]
  3464                                  	; [next_val_l]
  3465                                  	; dx = [next_val_r]
  3466 00001ADA E895010000              	call	interpolating_2_16bit_stereo
  3467 00001ADF E38D                    	jecxz	lff44s2_3
  3468                                  lff44s2_2_2:
  3469                                  	;movsw		; (L)eft Channel
  3470                                  	;movsw		; (R)ight Channel
  3471 00001AE1 A5                      	movsd
  3472                                  
  3473 00001AE2 49                      	dec	ecx
  3474 00001AE3 7489                    	jz	short lff44s2_3	
  3475 00001AE5 4D                      	dec	ebp
  3476 00001AE6 75F9                    	jnz	short lff44s2_2_2
  3477                                  	
  3478 00001AE8 FE0D[43200000]          	dec	byte [faz]
  3479 00001AEE 74C0                    	jz	short lff44s2_9 
  3480 00001AF0 BD0B000000              	mov	ebp, 11
  3481 00001AF5 EBC5                    	jmp	short lff44s2_1
  3482                                  
  3483                                  ; .....................
  3484                                  
  3485                                  interpolating_3_8bit_mono:
  3486                                  	; 16/11/2023
  3487                                  	; al = [previous_val]
  3488                                  	; dl = [next_val]
  3489                                  	; original-interpolated-interpolated
  3490 00001AF7 88C3                    	mov	bl, al
  3491 00001AF9 2C80                    	sub	al, 80h
  3492 00001AFB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3493 00001AFF 66AB                    	stosw		; original sample (L)
  3494 00001B01 66AB                    	stosw		; original sample (R)
  3495 00001B03 88D8                    	mov	al, bl
  3496 00001B05 00D0                    	add	al, dl	
  3497 00001B07 D0D8                    	rcr	al, 1
  3498 00001B09 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3499 00001B0B 00D8                    	add	al, bl
  3500 00001B0D D0D8                    	rcr	al, 1
  3501 00001B0F 2C80                    	sub	al, 80h
  3502 00001B11 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3503 00001B15 66AB                    	stosw		; interpolated sample 1 (L)
  3504 00001B17 66AB                    	stosw		; interpolated sample 1 (R)
  3505 00001B19 88F8                    	mov	al, bh
  3506 00001B1B 00D0                    	add	al, dl	; [next_val]
  3507 00001B1D D0D8                    	rcr	al, 1
  3508 00001B1F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3509 00001B23 66AB                    	stosw		; interpolated sample 2 (L)
  3510 00001B25 66AB                    	stosw		; interpolated sample 2 (R)
  3511 00001B27 C3                      	retn
  3512                                  
  3513                                  interpolating_3_8bit_stereo:
  3514                                  	; 16/11/2023
  3515                                  	; al = [previous_val_l]
  3516                                  	; ah = [previous_val_r]
  3517                                  	; dl = [next_val_l]
  3518                                  	; dh = [next_val_r]	
  3519                                  	; original-interpolated-interpolated
  3520 00001B28 89C3                    	mov	ebx, eax
  3521 00001B2A 2C80                    	sub	al, 80h
  3522 00001B2C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3523 00001B30 66AB                    	stosw		; original sample (L)
  3524 00001B32 88F8                    	mov	al, bh
  3525 00001B34 2C80                    	sub	al, 80h
  3526 00001B36 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3527 00001B3A 66AB                    	stosw		; original sample (R)
  3528 00001B3C 88D8                    	mov	al, bl
  3529 00001B3E 00D0                    	add	al, dl	; [next_val_l]	
  3530 00001B40 D0D8                    	rcr	al, 1
  3531 00001B42 50                      	push	eax ; *	; al = interpolated middle (L) (temporary)
  3532 00001B43 00D8                    	add	al, bl	; [previous_val_l]
  3533 00001B45 D0D8                    	rcr	al, 1
  3534 00001B47 2C80                    	sub	al, 80h
  3535 00001B49 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3536 00001B4D 66AB                    	stosw		; interpolated sample 1 (L)
  3537 00001B4F 88F8                    	mov	al, bh
  3538 00001B51 00F0                    	add	al, dh	; [next_val_r]
  3539 00001B53 D0D8                    	rcr	al, 1
  3540 00001B55 50                      	push	eax ; ** ; al = interpolated middle (R) (temporary)
  3541 00001B56 00F8                    	add	al, bh	; [previous_val_r]
  3542 00001B58 D0D8                    	rcr	al, 1
  3543 00001B5A 2C80                    	sub	al, 80h
  3544 00001B5C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3545 00001B60 66AB                    	stosw		; interpolated sample 1 (R)
  3546 00001B62 5B                      	pop	ebx ; **
  3547 00001B63 58                      	pop	eax ; *
  3548 00001B64 00D0                    	add	al, dl	; [next_val_l]
  3549 00001B66 D0D8                    	rcr	al, 1
  3550 00001B68 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3551 00001B6C 66AB                    	stosw		; interpolated sample 2 (L)
  3552 00001B6E 88D8                    	mov	al, bl
  3553 00001B70 00F0                    	add	al, dh	; [next_val_r]
  3554 00001B72 D0D8                    	rcr	al, 1
  3555 00001B74 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3556 00001B78 66AB                    	stosw		; interpolated sample 2 (R)
  3557 00001B7A C3                      	retn
  3558                                  
  3559                                  interpolating_2_8bit_mono:
  3560                                  	; 16/11/2023
  3561                                  	; al = [previous_val]
  3562                                  	; dl = [next_val]
  3563                                  	; original-interpolated
  3564 00001B7B 88C3                    	mov	bl, al
  3565 00001B7D 2C80                    	sub	al, 80h
  3566 00001B7F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3567 00001B83 66AB                    	stosw		; original sample (L)
  3568 00001B85 66AB                    	stosw		; original sample (R)
  3569 00001B87 88D8                    	mov	al, bl
  3570 00001B89 00D0                    	add	al, dl	
  3571 00001B8B D0D8                    	rcr	al, 1
  3572 00001B8D 2C80                    	sub	al, 80h
  3573 00001B8F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3574 00001B93 66AB                    	stosw		; interpolated sample (L)
  3575 00001B95 66AB                    	stosw		; interpolated sample (R)
  3576 00001B97 C3                      	retn
  3577                                  
  3578                                  interpolating_2_8bit_stereo:
  3579                                  	; 16/11/2023
  3580                                  	; al = [previous_val_l]
  3581                                  	; ah = [previous_val_r]
  3582                                  	; dl = [next_val_l]
  3583                                  	; dh = [next_val_r]	
  3584                                  	; original-interpolated
  3585 00001B98 89C3                    	mov	ebx, eax
  3586 00001B9A 2C80                    	sub	al, 80h
  3587 00001B9C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3588 00001BA0 66AB                    	stosw		; original sample (L)
  3589 00001BA2 88F8                    	mov	al, bh
  3590 00001BA4 2C80                    	sub	al, 80h
  3591 00001BA6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3592 00001BAA 66AB                    	stosw		; original sample (R)
  3593 00001BAC 88D8                    	mov	al, bl	; [previous_val_l]
  3594 00001BAE 00D0                    	add	al, dl	; [next_val_l]	
  3595 00001BB0 D0D8                    	rcr	al, 1
  3596 00001BB2 2C80                    	sub	al, 80h
  3597 00001BB4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3598 00001BB8 66AB                    	stosw		; interpolated sample (L)
  3599 00001BBA 88F8                    	mov	al, bh
  3600 00001BBC 00F0                    	add	al, dh	; [next_val_r]
  3601 00001BBE D0D8                    	rcr	al, 1
  3602 00001BC0 2C80                    	sub	al, 80h
  3603 00001BC2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3604 00001BC6 66AB                    	stosw		; interpolated sample (R)
  3605 00001BC8 C3                      	retn
  3606                                  
  3607                                  interpolating_3_16bit_mono:
  3608                                  	; 16/11/2023
  3609                                  	; ax = [previous_val]
  3610                                  	; dx = [next_val]
  3611                                  	; original-interpolated-interpolated
  3612                                  
  3613 00001BC9 66AB                    	stosw		; original sample (L)
  3614 00001BCB 66AB                    	stosw		; original sample (R)
  3615 00001BCD 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3616 00001BD0 50                      	push	eax ; *	; [previous_val]
  3617 00001BD1 80C680                  	add	dh, 80h
  3618 00001BD4 6601D0                  	add	ax, dx
  3619 00001BD7 66D1D8                  	rcr	ax, 1
  3620 00001BDA 5B                      	pop	ebx ; *		
  3621 00001BDB 93                      	xchg	ebx, eax ; bx  = interpolated middle (temporary)
  3622 00001BDC 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  3623 00001BDF 66D1D8                  	rcr	ax, 1
  3624 00001BE2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3625 00001BE5 66AB                    	stosw 		; interpolated sample 1 (L)
  3626 00001BE7 66AB                    	stosw		; interpolated sample 1 (R)
  3627 00001BE9 89D8                    	mov	eax, ebx
  3628 00001BEB 6601D0                  	add	ax, dx	 ;interpolated middle + [next_val]
  3629 00001BEE 66D1D8                  	rcr	ax, 1
  3630 00001BF1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3631 00001BF4 66AB                    	stosw		; interpolated sample 2 (L)
  3632 00001BF6 66AB                    	stosw		; interpolated sample 2 (R)
  3633 00001BF8 C3                      	retn
  3634                                  
  3635                                  interpolating_3_16bit_stereo:
  3636                                  	; 16/11/2023
  3637                                  	; bx = [previous_val_l]
  3638                                  	; ax = [previous_val_r]
  3639                                  	; [next_val_l]
  3640                                  	; dx = [next_val_r]
  3641                                  	; original-interpolated-interpolated
  3642                                  
  3643 00001BF9 93                      	xchg	eax, ebx
  3644 00001BFA 66AB                    	stosw		; original sample (L)
  3645 00001BFC 93                      	xchg	eax, ebx
  3646 00001BFD 66AB                    	stosw		; original sample (R)
  3647 00001BFF 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3648 00001C02 50                      	push	eax ; *	; [previous_val_r]
  3649 00001C03 80C780                  	add	bh, 80h
  3650 00001C06 8005[40200000]80        	add	byte [next_val_l+1], 80h
  3651 00001C0D 66A1[3F200000]          	mov	ax, [next_val_l]
  3652 00001C13 6601D8                  	add	ax, bx	; [previous_val_l]
  3653 00001C16 66D1D8                  	rcr	ax, 1
  3654 00001C19 93                      	xchg	eax, ebx ; ax = [previous_val_l]
  3655 00001C1A 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  3656 00001C1D 66D1D8                  	rcr	ax, 1
  3657 00001C20 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3658 00001C23 66AB                    	stosw 		; interpolated sample 1 (L)
  3659 00001C25 58                      	pop	eax  ; *
  3660 00001C26 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  3661 00001C29 52                      	push	edx  ; * ; [next_val_r]
  3662 00001C2A 92                      	xchg	eax, edx
  3663 00001C2B 6601D0                  	add	ax, dx	; [next_val_r] + [previous_val_r]
  3664 00001C2E 66D1D8                  	rcr	ax, 1	; / 2
  3665 00001C31 50                      	push	eax ; ** ; interpolated middle (R)
  3666 00001C32 6601D0                  	add	ax, dx	; + [previous_val_r]
  3667 00001C35 66D1D8                  	rcr	ax, 1
  3668 00001C38 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3669 00001C3B 66AB                    	stosw 		; interpolated sample 1 (R)
  3670 00001C3D 66A1[3F200000]          	mov	ax, [next_val_l]
  3671 00001C43 6601D8                  	add	ax, bx	; + interpolated middle (L)
  3672 00001C46 66D1D8                  	rcr	ax, 1
  3673 00001C49 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3674 00001C4C 66AB                    	stosw 		; interpolated sample 2 (L)
  3675 00001C4E 58                      	pop	eax ; **
  3676 00001C4F 5A                      	pop	edx ; *	
  3677 00001C50 6601D0                  	add	ax, dx	; interpolated middle + [next_val_r]
  3678 00001C53 66D1D8                  	rcr	ax, 1	; / 2
  3679 00001C56 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3680 00001C59 66AB                    	stosw 		; interpolated sample 2 (L)
  3681 00001C5B C3                      	retn
  3682                                  
  3683                                  interpolating_2_16bit_mono:
  3684                                  	; 16/11/2023
  3685                                  	; ax = [previous_val]
  3686                                  	; dx = [next_val]
  3687                                  	; original-interpolated
  3688                                  
  3689 00001C5C 66AB                    	stosw		; original sample (L)
  3690 00001C5E 66AB                    	stosw		; original sample (R)
  3691 00001C60 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3692 00001C63 80C680                  	add	dh, 80h
  3693 00001C66 6601D0                  	add	ax, dx
  3694 00001C69 66D1D8                  	rcr	ax, 1
  3695 00001C6C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3696 00001C6F 66AB                    	stosw		; interpolated sample (L)
  3697 00001C71 66AB                    	stosw		; interpolated sample (R)
  3698 00001C73 C3                      	retn
  3699                                  
  3700                                  interpolating_2_16bit_stereo:
  3701                                  	; 17/01/2025
  3702                                  	; 16/11/2023
  3703                                  	; bx = [previous_val_l]
  3704                                  	; ax = [previous_val_r]
  3705                                  	; [next_val_l]
  3706                                  	; dx = [next_val_r]
  3707                                  	; original-interpolated
  3708                                  
  3709 00001C74 93                      	xchg	eax, ebx
  3710 00001C75 66AB                    	stosw		; original sample (L)
  3711 00001C77 93                      	xchg	eax, ebx
  3712 00001C78 66AB                    	stosw		; original sample (R)
  3713 00001C7A 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3714 00001C7D 80C680                  	add	dh, 80h
  3715 00001C80 6601D0                  	add	ax, dx	; [previous_val_r] + [next_val_r]
  3716 00001C83 66D1D8                  	rcr	ax, 1	; / 2
  3717                                  	; 17/01/2025
  3718 00001C86 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3719                                  	;push	eax ; *	; interpolated sample (R)
  3720                                  	; 17/01/2025
  3721 00001C89 C1E010                  	shl	eax, 16
  3722 00001C8C 66A1[3F200000]          	mov	ax, [next_val_l]
  3723 00001C92 80C480                  	add	ah, 80h
  3724 00001C95 80C780                  	add	bh, 80h
  3725 00001C98 6601D8                  	add	ax, bx	; [next_val_l] + [previous_val_l]
  3726 00001C9B 66D1D8                  	rcr	ax, 1	; / 2
  3727 00001C9E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3728                                  	; 17/01/2025
  3729                                  	;stosw 		; interpolated sample (L)
  3730                                  	;pop	eax ; *	
  3731                                  	;sub	ah, 80h	; -32768 to +32767 format again
  3732                                  	;stosw 		; interpolated sample (R)
  3733                                  	; 17/01/2025
  3734 00001CA1 AB                      	stosd
  3735 00001CA2 C3                      	retn
  3736                                  
  3737                                  interpolating_5_8bit_mono:
  3738                                  	; 17/11/2023
  3739                                  	; al = [previous_val]
  3740                                  	; dl = [next_val]
  3741                                  	; original-interpltd-interpltd-interpltd-interpltd
  3742 00001CA3 88C3                    	mov	bl, al
  3743 00001CA5 2C80                    	sub	al, 80h
  3744 00001CA7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3745 00001CAB 66AB                    	stosw		; original sample (L)
  3746 00001CAD 66AB                    	stosw		; original sample (R)
  3747 00001CAF 88D8                    	mov	al, bl
  3748 00001CB1 00D0                    	add	al, dl	
  3749 00001CB3 D0D8                    	rcr	al, 1
  3750 00001CB5 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3751 00001CB7 00D8                    	add	al, bl  ; [previous_val]
  3752 00001CB9 D0D8                    	rcr	al, 1 	
  3753 00001CBB 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  3754 00001CBD 00D8                    	add	al, bl
  3755 00001CBF D0D8                    	rcr	al, 1
  3756 00001CC1 2C80                    	sub	al, 80h
  3757 00001CC3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3758 00001CC7 66AB                    	stosw		; interpolated sample 1 (L)
  3759 00001CC9 66AB                    	stosw		; interpolated sample 1 (R)
  3760 00001CCB 88F8                    	mov	al, bh
  3761 00001CCD 00F0                    	add	al, dh
  3762 00001CCF D0D8                    	rcr	al, 1
  3763 00001CD1 2C80                    	sub	al, 80h
  3764 00001CD3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3765 00001CD7 66AB                    	stosw		; interpolated sample 2 (L)
  3766 00001CD9 66AB                    	stosw		; interpolated sample 2 (R)
  3767 00001CDB 88F8                    	mov	al, bh
  3768 00001CDD 00D0                    	add	al, dl	; [next_val]
  3769 00001CDF D0D8                    	rcr	al, 1
  3770 00001CE1 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  3771 00001CE3 00F8                    	add	al, bh
  3772 00001CE5 D0D8                    	rcr	al, 1
  3773 00001CE7 2C80                    	sub	al, 80h
  3774 00001CE9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3775 00001CED 66AB                    	stosw		; interpolated sample 3 (L)
  3776 00001CEF 66AB                    	stosw		; interpolated sample 3 (R)
  3777 00001CF1 88F0                    	mov	al, dh
  3778 00001CF3 00D0                    	add	al, dl
  3779 00001CF5 D0D8                    	rcr	al, 1
  3780 00001CF7 2C80                    	sub	al, 80h
  3781 00001CF9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3782 00001CFD 66AB                    	stosw		; interpolated sample 4 (L)
  3783 00001CFF 66AB                    	stosw		; interpolated sample 4 (R)
  3784 00001D01 C3                      	retn
  3785                                  
  3786                                  interpolating_5_8bit_stereo:
  3787                                  	; 17/11/2023
  3788                                  	; al = [previous_val_l]
  3789                                  	; ah = [previous_val_r]
  3790                                  	; dl = [next_val_l]
  3791                                  	; dh = [next_val_r]	
  3792                                  	; original-interpltd-interpltd-interpltd-interpltd
  3793 00001D02 89C3                    	mov	ebx, eax
  3794 00001D04 2C80                    	sub	al, 80h
  3795 00001D06 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3796 00001D0A 66AB                    	stosw		; original sample (L)
  3797 00001D0C 88F8                    	mov	al, bh
  3798 00001D0E 2C80                    	sub	al, 80h
  3799 00001D10 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3800 00001D14 66AB                    	stosw		; original sample (R)
  3801 00001D16 52                      	push	edx ; *
  3802 00001D17 88D8                    	mov	al, bl
  3803 00001D19 00D0                    	add	al, dl	; [next_val_l]
  3804 00001D1B D0D8                    	rcr	al, 1
  3805 00001D1D 50                      	push	eax ; **	; al = interpolated middle (L) (temporary)
  3806 00001D1E 00D8                    	add	al, bl	; [previous_val_l]
  3807 00001D20 D0D8                    	rcr	al, 1
  3808 00001D22 86D8                    	xchg	al, bl	
  3809 00001D24 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3810 00001D26 D0D8                    	rcr	al, 1
  3811 00001D28 2C80                    	sub	al, 80h
  3812 00001D2A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3813 00001D2E 66AB                    	stosw		; interpolated sample 1 (L)
  3814 00001D30 88F8                    	mov	al, bh
  3815 00001D32 00F0                    	add	al, dh	; [next_val_r]
  3816 00001D34 D0D8                    	rcr	al, 1
  3817 00001D36 50                      	push	eax ; *** ; al = interpolated middle (R) (temporary)
  3818 00001D37 00F8                    	add	al, bh	; [previous_val_r]
  3819 00001D39 D0D8                    	rcr	al, 1
  3820 00001D3B 86F8                    	xchg	al, bh	
  3821 00001D3D 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3822 00001D3F D0D8                    	rcr	al, 1
  3823 00001D41 2C80                    	sub	al, 80h
  3824 00001D43 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3825 00001D47 66AB                    	stosw		; interpolated sample 1 (R)
  3826 00001D49 5A                      	pop	edx ; ***
  3827 00001D4A 58                      	pop	eax ; **	; al = interpolated middle (L) (temporary)
  3828 00001D4B 86D8                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3829 00001D4D 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  3830 00001D4F D0D8                    	rcr	al, 1
  3831 00001D51 2C80                    	sub	al, 80h
  3832 00001D53 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3833 00001D57 66AB                    	stosw		; interpolated sample 2 (L)	
  3834 00001D59 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  3835 00001D5B 86F8                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  3836 00001D5D 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  3837 00001D5F D0D8                    	rcr	al, 1
  3838 00001D61 2C80                    	sub	al, 80h
  3839 00001D63 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3840 00001D67 66AB                    	stosw		; interpolated sample 2 (R)
  3841 00001D69 5A                      	pop	edx ; *
  3842 00001D6A 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  3843 00001D6C 00D0                    	add	al, dl	; [next_val_l]
  3844 00001D6E D0D8                    	rcr	al, 1
  3845 00001D70 86D8                    	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  3846 00001D72 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  3847 00001D74 D0D8                    	rcr	al, 1
  3848 00001D76 2C80                    	sub	al, 80h
  3849 00001D78 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3850 00001D7C 66AB                    	stosw		; interpolated sample 3 (L)
  3851 00001D7E 88F8                    	mov	al, bh	
  3852 00001D80 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  3853 00001D82 D0D8                    	rcr	al, 1
  3854 00001D84 86F8                    	xchg	al, bh	; al = interpolated middle (R)
  3855 00001D86 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  3856 00001D88 D0D8                    	rcr	al, 1
  3857 00001D8A 2C80                    	sub	al, 80h
  3858 00001D8C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3859 00001D90 66AB                    	stosw		; interpolated sample 3 (R)
  3860 00001D92 88D8                    	mov	al, bl
  3861 00001D94 00D0                    	add	al, dl	; [next_val_l]
  3862 00001D96 D0D8                    	rcr	al, 1
  3863 00001D98 2C80                    	sub	al, 80h
  3864 00001D9A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3865 00001D9E 66AB                    	stosw		; interpolated sample 4 (L)
  3866 00001DA0 88F8                    	mov	al, bh
  3867 00001DA2 00F0                    	add	al, dh	; [next_val_r]
  3868 00001DA4 D0D8                    	rcr	al, 1
  3869 00001DA6 2C80                    	sub	al, 80h
  3870 00001DA8 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3871 00001DAC 66AB                    	stosw		; interpolated sample 4 (R)
  3872 00001DAE C3                      	retn
  3873                                  
  3874                                  interpolating_4_8bit_mono:
  3875                                  	; 17/11/2023
  3876                                  	; al = [previous_val]
  3877                                  	; dl = [next_val]
  3878                                  	; original-interpolated-interpolated-interpolated
  3879 00001DAF 88C3                    	mov	bl, al
  3880 00001DB1 2C80                    	sub	al, 80h
  3881 00001DB3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3882 00001DB7 66AB                    	stosw		; original sample (L)
  3883 00001DB9 66AB                    	stosw		; original sample (R)
  3884 00001DBB 88D8                    	mov	al, bl
  3885 00001DBD 00D0                    	add	al, dl	
  3886 00001DBF D0D8                    	rcr	al, 1
  3887 00001DC1 86D8                    	xchg	al, bl  ; al = [previous_val]
  3888 00001DC3 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  3889 00001DC5 D0D8                    	rcr	al, 1 	
  3890 00001DC7 2C80                    	sub	al, 80h
  3891 00001DC9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3892 00001DCD 66AB                    	stosw		; interpolated sample 1 (L)
  3893 00001DCF 66AB                    	stosw		; interpolated sample 1 (R)
  3894 00001DD1 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  3895 00001DD3 2C80                    	sub	al, 80h
  3896 00001DD5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3897 00001DD9 66AB                    	stosw		; interpolated sample 2 (L)
  3898 00001DDB 66AB                    	stosw		; interpolated sample 2 (R)
  3899 00001DDD 88D8                    	mov	al, bl
  3900 00001DDF 00D0                    	add	al, dl	; [next_val]
  3901 00001DE1 D0D8                    	rcr	al, 1
  3902 00001DE3 2C80                    	sub	al, 80h
  3903 00001DE5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3904 00001DE9 66AB                    	stosw		; interpolated sample 3 (L)
  3905 00001DEB 66AB                    	stosw		; interpolated sample 3 (R)
  3906 00001DED C3                      	retn
  3907                                  
  3908                                  interpolating_4_8bit_stereo:
  3909                                  	; 17/11/2023
  3910                                  	; al = [previous_val_l]
  3911                                  	; ah = [previous_val_r]
  3912                                  	; dl = [next_val_l]
  3913                                  	; dh = [next_val_r]	
  3914                                  	; original-interpolated-interpolated-interpolated
  3915 00001DEE 89C3                    	mov	ebx, eax
  3916 00001DF0 2C80                    	sub	al, 80h
  3917 00001DF2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3918 00001DF6 66AB                    	stosw		; original sample (L)
  3919 00001DF8 88F8                    	mov	al, bh
  3920 00001DFA 2C80                    	sub	al, 80h
  3921 00001DFC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3922 00001E00 66AB                    	stosw		; original sample (R)
  3923 00001E02 88D8                    	mov	al, bl
  3924 00001E04 00D0                    	add	al, dl	; [next_val_l]
  3925 00001E06 D0D8                    	rcr	al, 1
  3926 00001E08 86D8                    	xchg	al, bl	; al = [previous_val_l]
  3927 00001E0A 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  3928 00001E0C D0D8                    	rcr	al, 1
  3929 00001E0E 2C80                    	sub	al, 80h
  3930 00001E10 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3931 00001E14 66AB                    	stosw		; interpolated sample 1 (L)
  3932 00001E16 88F8                    	mov	al, bh
  3933 00001E18 00F0                    	add	al, dh	; [next_val_r]
  3934 00001E1A D0D8                    	rcr	al, 1
  3935 00001E1C 86F8                    	xchg	al, bh	; al = [previous_val_h]
  3936 00001E1E 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  3937 00001E20 D0D8                    	rcr	al, 1
  3938 00001E22 2C80                    	sub	al, 80h
  3939 00001E24 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3940 00001E28 66AB                    	stosw		; interpolated sample 1 (R)
  3941 00001E2A 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  3942 00001E2C 2C80                    	sub	al, 80h
  3943 00001E2E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3944 00001E32 66AB                    	stosw		; interpolated sample 2 (L)
  3945 00001E34 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  3946 00001E36 2C80                    	sub	al, 80h
  3947 00001E38 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3948 00001E3C 66AB                    	stosw		; interpolated sample 2 (L)
  3949 00001E3E 88D8                    	mov	al, bl
  3950 00001E40 00D0                    	add	al, dl	; [next_val_l]
  3951 00001E42 D0D8                    	rcr	al, 1
  3952 00001E44 2C80                    	sub	al, 80h
  3953 00001E46 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3954 00001E4A 66AB                    	stosw		; interpolated sample 3 (L)
  3955 00001E4C 88F8                    	mov	al, bh
  3956 00001E4E 00F0                    	add	al, dh	; [next_val_r]
  3957 00001E50 D0D8                    	rcr	al, 1
  3958 00001E52 2C80                    	sub	al, 80h
  3959 00001E54 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3960 00001E58 66AB                    	stosw		; interpolated sample 3 (R)
  3961 00001E5A C3                      	retn
  3962                                  
  3963                                  interpolating_5_16bit_mono:
  3964                                  	; 18/11/2023
  3965                                  	; ax = [previous_val]
  3966                                  	; dx = [next_val]
  3967                                  	; original-interpltd-interpltd-interpltd-interpltd
  3968 00001E5B 66AB                    	stosw		; original sample (L)
  3969 00001E5D 66AB                    	stosw		; original sample (R)
  3970 00001E5F 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3971 00001E62 89C3                    	mov	ebx, eax ; [previous_val]
  3972 00001E64 80C680                  	add	dh, 80h
  3973 00001E67 6601D0                  	add	ax, dx
  3974 00001E6A 66D1D8                  	rcr	ax, 1
  3975 00001E6D 50                      	push	eax ; *	; interpolated middle (temporary)
  3976 00001E6E 6601D8                  	add	ax, bx	; interpolated middle + [previous_val] 
  3977 00001E71 66D1D8                  	rcr	ax, 1
  3978 00001E74 50                      	push	eax ; **	; interpolated 1st quarter (temporary)
  3979 00001E75 6601D8                  	add	ax, bx	; 1st quarter + [previous_val]
  3980 00001E78 66D1D8                  	rcr	ax, 1	
  3981 00001E7B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3982 00001E7E 66AB                    	stosw 		; interpolated sample 1 (L)
  3983 00001E80 66AB                    	stosw		; interpolated sample 1 (R)
  3984 00001E82 58                      	pop	eax ; **	
  3985 00001E83 5B                      	pop	ebx ; *
  3986 00001E84 6601D8                  	add	ax, bx	; 1st quarter + middle
  3987 00001E87 66D1D8                  	rcr	ax, 1	; / 2
  3988 00001E8A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  3989 00001E8D 66AB                    	stosw		; interpolated sample 2 (L)
  3990 00001E8F 66AB                    	stosw		; interpolated sample 2 (R)		
  3991 00001E91 89D8                    	mov	eax, ebx
  3992 00001E93 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  3993 00001E96 66D1D8                  	rcr	ax, 1
  3994 00001E99 50                      	push	eax ; *	; interpolated 3rd quarter (temporary)
  3995 00001E9A 6601D8                  	add	ax, bx	; + interpolated middle
  3996 00001E9D 66D1D8                  	rcr	ax, 1
  3997 00001EA0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3998 00001EA3 66AB                    	stosw		; interpolated sample 3 (L)
  3999 00001EA5 66AB                    	stosw		; interpolated sample 3 (R)
  4000 00001EA7 58                      	pop	eax ; *	
  4001 00001EA8 6601D0                  	add	ax, dx	; 3rd quarter + [next_val]
  4002 00001EAB 66D1D8                  	rcr	ax, 1	; / 2
  4003 00001EAE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4004 00001EB1 66AB                    	stosw		; interpolated sample 4 (L)
  4005 00001EB3 66AB                    	stosw		; interpolated sample 4 (R)
  4006 00001EB5 C3                      	retn
  4007                                  
  4008                                  interpolating_5_16bit_stereo:
  4009                                  	; 18/11/2023
  4010                                  	; bx = [previous_val_l]
  4011                                  	; ax = [previous_val_r]
  4012                                  	; [next_val_l]
  4013                                  	; [next_val_r]
  4014                                  	; original-interpltd-interpltd-interpltd-interpltd
  4015 00001EB6 51                      	push	ecx ; !
  4016 00001EB7 93                      	xchg	eax, ebx
  4017 00001EB8 66AB                    	stosw		; original sample (L)
  4018 00001EBA 93                      	xchg	eax, ebx
  4019 00001EBB 66AB                    	stosw		; original sample (R)
  4020 00001EBD 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4021 00001EC0 50                      	push	eax ; *	; [previous_val_r]
  4022 00001EC1 80C780                  	add	bh, 80h
  4023 00001EC4 8005[40200000]80        	add	byte [next_val_l+1], 80h
  4024 00001ECB 66A1[3F200000]          	mov	ax, [next_val_l]
  4025 00001ED1 6601D8                  	add	ax, bx	; [previous_val_l]
  4026 00001ED4 66D1D8                  	rcr	ax, 1
  4027 00001ED7 89C1                    	mov	ecx, eax ; interpolated middle (L)
  4028 00001ED9 6601D8                  	add	ax, bx	
  4029 00001EDC 66D1D8                  	rcr	ax, 1
  4030 00001EDF 89C2                    	mov	edx, eax ; interpolated 1st quarter (L)	
  4031 00001EE1 6601D8                  	add	ax, bx	; [previous_val_l]
  4032 00001EE4 66D1D8                  	rcr	ax, 1
  4033 00001EE7 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4034 00001EEA 66AB                    	stosw 		; interpolated sample 1 (L)
  4035 00001EEC 89C8                    	mov	eax, ecx
  4036 00001EEE 6601D0                  	add	ax, dx	; middle (L) + 1st quarter (L) 
  4037 00001EF1 66D1D8                  	rcr	ax, 1	; / 2
  4038 00001EF4 89C3                    	mov	ebx, eax  ; interpolated sample 2 (L)
  4039 00001EF6 5A                      	pop	edx ; *	; [previous_val_r]
  4040 00001EF7 89D0                    	mov	eax, edx
  4041 00001EF9 8005[42200000]80        	add	byte [next_val_r+1], 80h
  4042 00001F00 660305[41200000]        	add	ax, [next_val_r]
  4043 00001F07 66D1D8                  	rcr	ax, 1
  4044 00001F0A 50                      	push	eax ; *	; interpolated middle (R)
  4045 00001F0B 6601D0                  	add	ax, dx
  4046 00001F0E 66D1D8                  	rcr	ax, 1
  4047 00001F11 50                      	push	eax ; ** ; interpolated 1st quarter (R)
  4048 00001F12 6601D0                  	add	ax, dx	; [previous_val_r]
  4049 00001F15 66D1D8                  	rcr	ax, 1
  4050 00001F18 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4051 00001F1B 66AB                    	stosw 		; interpolated sample 1 (R)
  4052 00001F1D 89D8                    	mov	eax, ebx
  4053 00001F1F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4054 00001F22 66AB                    	stosw 		; interpolated sample 2 (L)
  4055 00001F24 58                      	pop	eax ; **
  4056 00001F25 5A                      	pop	edx ; *
  4057 00001F26 6601D0                  	add	ax, dx	; 1st quarter (R) + middle (R)
  4058 00001F29 66D1D8                  	rcr	ax, 1	; / 2
  4059 00001F2C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4060 00001F2F 66AB                    	stosw 		; interpolated sample 2 (R)
  4061 00001F31 89C8                    	mov	eax, ecx
  4062 00001F33 660305[3F200000]        	add	ax, [next_val_l]
  4063 00001F3A 66D1D8                  	rcr	ax, 1
  4064 00001F3D 50                      	push	eax ; * ; interpolated 3rd quarter (L)
  4065 00001F3E 6601C8                  	add	ax, cx	; interpolated middle (L)
  4066 00001F41 66D1D8                  	rcr	ax, 1
  4067 00001F44 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4068 00001F47 66AB                    	stosw 		; interpolated sample 3 (L)
  4069 00001F49 89D0                    	mov	eax, edx
  4070 00001F4B 660305[41200000]        	add	ax, [next_val_r]
  4071 00001F52 66D1D8                  	rcr	ax, 1
  4072 00001F55 50                      	push	eax ; ** ; interpolated 3rd quarter (R)
  4073 00001F56 6601D0                  	add	ax, dx	; interpolated middle (R)
  4074 00001F59 66D1D8                  	rcr	ax, 1
  4075 00001F5C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4076 00001F5F 66AB                    	stosw 		; interpolated sample 3 (R)
  4077 00001F61 5B                      	pop	ebx ; **
  4078 00001F62 58                      	pop	eax ; *
  4079 00001F63 660305[3F200000]        	add	ax, [next_val_l]
  4080 00001F6A 66D1D8                  	rcr	ax, 1
  4081 00001F6D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4082 00001F70 66AB                    	stosw 		; interpolated sample 4 (L)
  4083 00001F72 89D8                    	mov	eax, ebx	
  4084 00001F74 660305[41200000]        	add	ax, [next_val_r]
  4085 00001F7B 66D1D8                  	rcr	ax, 1
  4086 00001F7E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4087 00001F81 66AB                    	stosw 		; interpolated sample 4 (R)
  4088 00001F83 59                      	pop	ecx ; !
  4089 00001F84 C3                      	retn
  4090                                  
  4091                                  interpolating_4_16bit_mono:
  4092                                  	; 18/11/2023
  4093                                  	; ax = [previous_val]
  4094                                  	; dx = [next_val]
  4095                                  	; original-interpolated
  4096                                  
  4097 00001F85 66AB                    	stosw		; original sample (L)
  4098 00001F87 66AB                    	stosw		; original sample (R)
  4099 00001F89 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4100 00001F8C 89C3                    	mov	ebx, eax ; [previous_val]
  4101 00001F8E 80C680                  	add	dh, 80h
  4102 00001F91 6601D0                  	add	ax, dx	; [previous_val] + [next_val]
  4103 00001F94 66D1D8                  	rcr	ax, 1
  4104 00001F97 93                      	xchg	eax, ebx	
  4105 00001F98 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  4106 00001F9B 66D1D8                  	rcr	ax, 1
  4107 00001F9E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4108 00001FA1 66AB                    	stosw 		; interpolated sample 1 (L)
  4109 00001FA3 66AB                    	stosw		; interpolated sample 1 (R)
  4110 00001FA5 89D8                    	mov	eax, ebx ; interpolated middle
  4111 00001FA7 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4112 00001FAA 66AB                    	stosw 		; interpolated sample 2 (L)
  4113 00001FAC 66AB                    	stosw		; interpolated sample 2 (R)
  4114 00001FAE 89D8                    	mov	eax, ebx
  4115 00001FB0 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4116 00001FB3 66D1D8                  	rcr	ax, 1
  4117 00001FB6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4118 00001FB9 66AB                    	stosw		; interpolated sample 3 (L)
  4119 00001FBB 66AB                    	stosw		; interpolated sample 3 (R)
  4120 00001FBD C3                      	retn
  4121                                  
  4122                                  interpolating_4_16bit_stereo:
  4123                                  	; 18/11/2023
  4124                                  	; bx = [previous_val_l]
  4125                                  	; ax = [previous_val_r]
  4126                                  	; [next_val_l]
  4127                                  	; [next_val_r]
  4128                                  	; original-interpolated-interpolated-interpolated
  4129 00001FBE 93                      	xchg	eax, ebx
  4130 00001FBF 66AB                    	stosw		; original sample (L)
  4131 00001FC1 93                      	xchg	eax, ebx
  4132 00001FC2 66AB                    	stosw		; original sample (R)
  4133 00001FC4 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4134 00001FC7 89C2                    	mov	edx, eax ; [previous_val_r]
  4135 00001FC9 80C780                  	add	bh, 80h
  4136 00001FCC 8005[40200000]80        	add	byte [next_val_l+1], 80h
  4137 00001FD3 66A1[3F200000]          	mov	ax, [next_val_l]
  4138 00001FD9 6601D8                  	add	ax, bx	; [previous_val_l]
  4139 00001FDC 66D1D8                  	rcr	ax, 1
  4140 00001FDF 93                      	xchg	eax, ebx	
  4141 00001FE0 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  4142 00001FE3 66D1D8                  	rcr	ax, 1
  4143 00001FE6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4144 00001FE9 66AB                    	stosw 		; interpolated sample 1 (L)
  4145 00001FEB 8005[42200000]80        	add	byte [next_val_r+1], 80h
  4146 00001FF2 89D0                    	mov	eax, edx ; [previous_val_r]
  4147 00001FF4 660305[41200000]        	add	ax, [next_val_r]
  4148 00001FFB 66D1D8                  	rcr	ax, 1
  4149 00001FFE 92                      	xchg	eax, edx	
  4150 00001FFF 6601D0                  	add	ax, dx	; dx = interpolated middle (R)
  4151 00002002 66D1D8                  	rcr	ax, 1
  4152 00002005 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4153 00002008 66AB                    	stosw 		; interpolated sample 1 (R)
  4154 0000200A 89D8                    	mov	eax, ebx
  4155 0000200C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4156 0000200F 66AB                    	stosw 		; interpolated sample 2 (L)
  4157 00002011 89D0                    	mov	eax, edx
  4158 00002013 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4159 00002016 66AB                    	stosw 		; interpolated sample 2 (R)
  4160 00002018 89D8                    	mov	eax, ebx
  4161 0000201A 660305[3F200000]        	add	ax, [next_val_l]
  4162 00002021 66D1D8                  	rcr	ax, 1
  4163 00002024 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4164 00002027 66AB                    	stosw 		; interpolated sample 3 (L)
  4165 00002029 89D0                    	mov	eax, edx
  4166 0000202B 660305[41200000]        	add	ax, [next_val_r]
  4167 00002032 66D1D8                  	rcr	ax, 1
  4168 00002035 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4169 00002038 66AB                    	stosw 		; interpolated sample 3 (R)
  4170 0000203A C3                      	retn
  4171                                  
  4172                                  ; 13/11/2023
  4173                                  previous_val:
  4174 0000203B 0000                    previous_val_l: dw 0
  4175 0000203D 0000                    previous_val_r: dw 0
  4176                                  next_val:
  4177 0000203F 0000                    next_val_l: dw 0
  4178 00002041 0000                    next_val_r: dw 0
  4179                                  
  4180                                  ; 16/11/2023
  4181 00002043 00                      faz:	db 0	
  4182                                  	
  4183                                  ; --------------------------------------------------------
  4184                                  
  4185                                  ; DATA
  4186                                  
  4187                                  FileHandle:	
  4188 00002044 FFFFFFFF                	dd	-1
  4189                                  
  4190                                  Credits:
  4191 00002048 54696E792057415620-     	db	'Tiny WAV Player for TRDOS 386 by Erdogan Tan. '
  4191 00002051 506C6179657220666F-
  4191 0000205A 72205452444F532033-
  4191 00002063 383620627920457264-
  4191 0000206C 6F67616E2054616E2E-
  4191 00002075 20                 
  4192                                  	;;;;db	'August 2020.',10,13,0
  4193                                  	;;;db	'November 2023.',10,13,0
  4194                                  	;;db	'June 2024.', 10,13,0
  4195                                  	;db	'December 2024.', 10,13,0
  4196 00002076 4A616E756172792032-     	db	'January 2025.', 10,13,0
  4196 0000207F 3032352E0A0D00     
  4197 00002086 31372F30362F323031-     	db	'17/06/2017', 10,13,0
  4197 0000208F 370A0D00           
  4198 00002093 31382F30382F323032-     	db	'18/08/2020', 10,13,0
  4198 0000209C 300A0D00           
  4199 000020A0 32372F31312F323032-     	db	'27/11/2023', 10,13,0
  4199 000020A9 330A0D00           
  4200 000020AD 30312F30362F323032-     	db	'01/06/2024', 10,13,0
  4200 000020B6 340A0D00           
  4201 000020BA 31342F31322F323032-     	db	'14/12/2024', 10,13,0
  4201 000020C3 340A0D00           
  4202 000020C7 31372F30312F323032-     	db	'17/01/2025', 10,13,0
  4202 000020D0 350A0D00           
  4203                                  
  4204                                  msgAudioCardInfo:
  4205 000020D4 666F7220496E74656C-     	db 	'for Intel AC97 (ICH) Audio Controller.', 10,13,0
  4205 000020DD 204143393720284943-
  4205 000020E6 482920417564696F20-
  4205 000020EF 436F6E74726F6C6C65-
  4205 000020F8 722E0A0D00         
  4206                                  
  4207                                  msg_usage:
  4208 000020FD 75736167653A20706C-     	db	'usage: playwav6 filename.wav',10,13,0
  4208 00002106 617977617636206669-
  4208 0000210F 6C656E616D652E7761-
  4208 00002118 760A0D00           
  4209                                  
  4210                                  noDevMsg:
  4211 0000211C 4572726F723A20556E-     	db	'Error: Unable to find AC97 audio device!'
  4211 00002125 61626C6520746F2066-
  4211 0000212E 696E64204143393720-
  4211 00002137 617564696F20646576-
  4211 00002140 69636521           
  4212 00002144 0A0D00                  	db	10,13,0
  4213                                  
  4214                                  noFileErrMsg:
  4215 00002147 4572726F723A206669-     	db	'Error: file not found.',10,13,0
  4215 00002150 6C65206E6F7420666F-
  4215 00002159 756E642E0A0D00     
  4216                                  
  4217                                  trdos386_err_msg:
  4218 00002160 5452444F5320333836-     	db	'TRDOS 386 System call error !',10,13,0
  4218 00002169 2053797374656D2063-
  4218 00002172 616C6C206572726F72-
  4218 0000217B 20210A0D00         
  4219                                  
  4220                                  ; 01/06/2024
  4221                                  msg_init_err:
  4222 00002180 0A0D                    	db	10,13
  4223 00002182 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  4223 0000218B 726F6C6C65722F436F-
  4223 00002194 64656320696E697469-
  4223 0000219D 616C697A6174696F6E-
  4223 000021A6 206572726F722021   
  4224 000021AE 0A0D00                  	db	10,13,0
  4225                                  
  4226                                  ; 25/11/2023
  4227                                  msg_no_vra:
  4228 000021B1 0A0D                    	db	10,13
  4229 000021B3 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  4229 000021BC 70706F72742021204F-
  4229 000021C5 6E6C79203438206B48-
  4229 000021CE 5A2073616D706C6520-
  4229 000021D7 726174652073757070-
  4229 000021E0 6F727465642021     
  4230 000021E7 0A0D00                  	db	10,13,0
  4231                                  
  4232 000021EA 0D0A5741562046696C-     msgWavFileName:	db 0Dh, 0Ah, "WAV File Name: ",0
  4232 000021F3 65204E616D653A2000 
  4233 000021FC 0D0A53616D706C6520-     msgSampleRate:	db 0Dh, 0Ah, "Sample Rate: "
  4233 00002205 526174653A20       
  4234 0000220B 303030303020487A2C-     msgHertz:	db "00000 Hz, ", 0 
  4234 00002214 2000               
  4235 00002216 3820626974732C2000      msg8Bits:	db "8 bits, ", 0 
  4236 0000221F 4D6F6E6F0D0A00          msgMono:	db "Mono", 0Dh, 0Ah, 0
  4237 00002226 313620626974732C20-     msg16Bits:	db "16 bits, ", 0 
  4237 0000222F 00                 
  4238 00002230 53746572656F            msgStereo:	db "Stereo"
  4239 00002236 0D0A00                  nextline:	db 0Dh, 0Ah, 0
  4240                                  
  4241                                  ; 03/06/2017
  4242 00002239 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  4242 00002242 3941424344454600   
  4243 0000224A 0D0A                    msgAC97Info	db 0Dh, 0Ah
  4244 0000224C 414339372041756469-     		db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  4244 00002255 6F20436F6E74726F6C-
  4244 0000225E 6C6572202620436F64-
  4244 00002267 656320496E666F0D0A 
  4245 00002270 56656E646F72204944-     		db "Vendor ID: "
  4245 00002279 3A20               
  4246 0000227B 303030306820446576-     msgVendorId	db "0000h Device ID: "
  4246 00002284 6963652049443A20   
  4247 0000228C 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  4248 00002293 4275733A20              		db "Bus: "
  4249 00002298 303068204465766963-     msgBusNo	db "00h Device: "
  4249 000022A1 653A20             
  4250 000022A4 3030682046756E6374-     msgDevNo	db "00h Function: "
  4250 000022AD 696F6E3A20         
  4251 000022B2 303068                  msgFncNo	db "00h"
  4252 000022B5 0D0A                    		db 0Dh, 0Ah
  4253 000022B7 4E414D4241523A20        		db "NAMBAR: "
  4254 000022BF 30303030682020          msgNamBar	db "0000h  "
  4255 000022C6 4E41424D4241523A20      		db "NABMBAR: "
  4256 000022CF 303030306820204952-     msgNabmBar	db "0000h  IRQ: "
  4256 000022D8 513A20             
  4257 000022DB 3030                    msgIRQ		dw 3030h
  4258 000022DD 0D0A00                  		db 0Dh, 0Ah, 0
  4259                                  ; 25/11/2023
  4260 000022E0 56524120737570706F-     msgVRAheader:	db "VRA support: "
  4260 000022E9 72743A20           
  4261 000022ED 00                      		db 0	
  4262 000022EE 5945530D0A00            msgVRAyes:	db "YES", 0Dh, 0Ah, 0
  4263 000022F4 4E4F200D0A              msgVRAno:	db "NO ", 0Dh, 0Ah
  4264 000022F9 28496E746572706F6C-     		db "(Interpolated sample rate playing method)"
  4264 00002302 617465642073616D70-
  4264 0000230B 6C6520726174652070-
  4264 00002314 6C6179696E67206D65-
  4264 0000231D 74686F6429         
  4265 00002322 0D0A00                  		db 0Dh, 0Ah, 0	
  4266                                  EOF: 
  4267                                  
  4268                                  ; BSS
  4269                                  
  4270                                  bss_start:
  4271                                  
  4272                                  ABSOLUTE bss_start
  4273                                  
  4274 00002325 ??????                  alignb 4
  4275                                  
  4276 00002328 ??                      stmo:		resb 1 ; stereo or mono (1=stereo) 
  4277 00002329 ??                      bps:		resb 1 ; bits per sample (8,16)
  4278 0000232A ????                    sample_rate:	resw 1 ; Sample Frequency (Hz)
  4279                                  
  4280                                  ; 25/11/2023
  4281 0000232C ????????                bufferSize:	resd 1
  4282                                  
  4283 00002330 ??                      flags:		resb 1
  4284                                  ;cbs_busy:	resb 1 
  4285 00002331 ??                      half_buff:	resb 1
  4286 00002332 ??                      srb:		resb 1
  4287                                  ; 18/08/2020
  4288 00002333 ??                      volume_level:	resb 1
  4289                                  ; 25/11/2023
  4290 00002334 ??                      VRA:		resb 1	; Variable Rate Audio Support Status
  4291                                  
  4292 00002335 <res 1Ch>               smpRBuff:	resw 14 
  4293                                  
  4294                                  wav_file_name:
  4295 00002351 <res 50h>               		resb 80 ; wave file, path name (<= 80 bytes)
  4296                                  
  4297 000023A1 ????                    		resw 1
  4298 000023A3 ??                      ac97_int_ln_reg: resb 1
  4299 000023A4 ??                      fbs_shift:	resb 1 ; 26/11/2023
  4300 000023A5 ????????                dev_vendor:	resd 1
  4301 000023A9 ????????                bus_dev_fn:	resd 1
  4302 000023AD ????                    ac97_NamBar:	resw 1
  4303 000023AF ????                    ac97_NabmBar:	resw 1
  4304                                  
  4305                                  bss_end:
  4306 000023B1 <res C4Fh>              alignb 4096
  4307                                  ;audio_buffer:	resb BUFFERSIZE ; DMA Buffer Size / 2 (32768)
  4308                                  ; 26/11/2023
  4309 00003000 <res 10000h>            audio_buffer:	resb 65536
  4310                                  ; 13/06/2017
  4311                                  ;temp_buffer:	resb BUFFERSIZE
  4312                                  ; 26/11/2023
  4313 00013000 <res 10000h>            temp_buffer:	resb 65536
