     1                                  ; ****************************************************************************
     2                                  ; playwav6.s (for TRDOS 386)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYWAV6.PRG ! AC'97 (ICH) .WAV PLAYER program by Erdogan TAN
     5                                  ;
     6                                  ; 25/11/2023
     7                                  ;
     8                                  ; [ Last Modification: 08/12/2024 ]
     9                                  ;
    10                                  ; Modified from PLAYWAV5.PRG .wav player program by Erdogan Tan, 18/08/2020
    11                                  ;
    12                                  ; Assembler: NASM version 2.15
    13                                  ;	     nasm playwav6.s -l playwav6.txt -o PLAYWAV6.PRG	
    14                                  ; ----------------------------------------------------------------------------
    15                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002
    16                                  
    17                                  ; previous version: playwav3.s (17/06/2017)
    18                                  
    19                                  ; CODE
    20                                  
    21                                  ; 14/07/2020
    22                                  ; 31/12/2017
    23                                  ; TRDOS 386 (v2.0) system calls
    24                                  _ver 	equ 0
    25                                  _exit 	equ 1
    26                                  _fork 	equ 2
    27                                  _read 	equ 3
    28                                  _write	equ 4
    29                                  _open	equ 5
    30                                  _close 	equ 6
    31                                  _wait 	equ 7
    32                                  _create	equ 8
    33                                  _rename	equ 9
    34                                  _delete	equ 10
    35                                  _exec	equ 11
    36                                  _chdir	equ 12
    37                                  _time 	equ 13
    38                                  _mkdir 	equ 14
    39                                  _chmod	equ 15
    40                                  _rmdir	equ 16
    41                                  _break	equ 17
    42                                  _drive	equ 18
    43                                  _seek	equ 19
    44                                  _tell 	equ 20
    45                                  _memory	equ 21
    46                                  _prompt	equ 22
    47                                  _path	equ 23
    48                                  _env	equ 24
    49                                  _stime	equ 25
    50                                  _quit	equ 26
    51                                  _intr	equ 27
    52                                  _dir	equ 28
    53                                  _emt 	equ 29
    54                                  _ldrvt 	equ 30
    55                                  _video 	equ 31
    56                                  _audio	equ 32
    57                                  _timer	equ 33
    58                                  _sleep	equ 34
    59                                  _msg    equ 35
    60                                  _geterr	equ 36
    61                                  _fpstat	equ 37
    62                                  _pri	equ 38
    63                                  _rele	equ 39
    64                                  _fff	equ 40
    65                                  _fnf	equ 41
    66                                  _alloc	equ 42
    67                                  _dalloc equ 43
    68                                  _calbac equ 44
    69                                  _dma	equ 45
    70                                  
    71                                  %macro sys 1-4
    72                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)	
    73                                      ; 03/09/2015	
    74                                      ; 13/04/2015
    75                                      ; Retro UNIX 386 v1 system call.	
    76                                      %if %0 >= 2   
    77                                          mov ebx, %2
    78                                          %if %0 >= 3    
    79                                              mov ecx, %3
    80                                              %if %0 = 4
    81                                                 mov edx, %4   
    82                                              %endif
    83                                          %endif
    84                                      %endif
    85                                      mov eax, %1
    86                                      ;int 30h
    87                                      int 40h ; TRDOS 386 (TRDOS v2.0)	   
    88                                  %endmacro
    89                                  
    90                                  ; TRDOS 386 (and Retro UNIX 386 v1) system call format:
    91                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
    92                                  
    93                                  BUFFERSIZE	equ	32768	; audio buffer size 
    94                                  ENDOFFILE       equ     1	; flag for knowing end of file
    95                                  
    96                                  [BITS 32]
    97                                  
    98                                  [ORG 0] 
    99                                  
   100                                  _STARTUP:
   101                                  	; Prints the Credits Text.
   102                                  	sys	_msg, Credits, 255, 0Bh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000000 BB[6F200000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000005 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000000A BA0B000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000000F B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000014 CD40                <1>  int 40h
   103                                  
   104                                  	; clear bss
   105 00000016 B9[C9230000]            	mov	ecx, bss_end
   106 0000001B BF[40230000]            	mov	edi, bss_start
   107 00000020 29F9                    	sub	ecx, edi
   108 00000022 D1E9                    	shr	ecx, 1
   109 00000024 31C0                    	xor	eax, eax
   110 00000026 F366AB                  	rep	stosw
   111                                  
   112                                  	; Detect (& Enable) AC'97 Audio Device
   113 00000029 E892040000              	call	DetectAC97
   114 0000002E 731B                    	jnc     short GetFileName
   115                                  
   116                                  _dev_not_ready:
   117                                  ; couldn't find the audio device!
   118                                  	sys	_msg, noDevMsg, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000030 BB[37210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000035 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000003A BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000003F B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000044 CD40                <1>  int 40h
   119 00000046 E94F040000                      jmp     Exit
   120                                  
   121                                  GetFileName:  
   122 0000004B 89E6                    	mov	esi, esp
   123 0000004D AD                      	lodsd
   124 0000004E 83F802                  	cmp	eax, 2 ; two arguments 
   125                                  	       ; (program file name & mod file name)
   126 00000051 0F8251040000            	jb	pmsg_usage ; nothing to do
   127                                  
   128 00000057 AD                      	lodsd ; program file name address 
   129 00000058 AD                      	lodsd ; mod file name address (file to be read)
   130 00000059 89C6                    	mov	esi, eax
   131 0000005B BF[69230000]            	mov	edi, wav_file_name
   132                                  ScanName:       
   133 00000060 AC                      	lodsb
   134 00000061 84C0                    	test	al, al
   135 00000063 0F843F040000            	je	pmsg_usage
   136 00000069 3C20                    	cmp	al, 20h
   137 0000006B 74F3                    	je	short ScanName	; scan start of name.
   138 0000006D AA                      	stosb
   139 0000006E B4FF                    	mov	ah, 0FFh
   140                                  a_0:	
   141 00000070 FEC4                    	inc	ah
   142                                  a_1:
   143 00000072 AC                      	lodsb
   144 00000073 AA                      	stosb
   145 00000074 3C2E                    	cmp	al, '.'
   146 00000076 74F8                    	je	short a_0	
   147 00000078 20C0                    	and	al, al
   148 0000007A 75F6                    	jnz	short a_1
   149                                  
   150 0000007C 08E4                    	or	ah, ah		; if period NOT found,
   151 0000007E 750B                    	jnz	short _1 	; then add a .WAV extension.
   152                                  SetExt:
   153 00000080 4F                      	dec	edi
   154 00000081 C7072E574156            	mov	dword [edi], '.WAV'
   155 00000087 C6470400                	mov	byte [edi+4], 0
   156                                  
   157                                  _1:
   158                                  
   159                                  ; 26/11/2023
   160                                  %if 0
   161                                  	; Allocate Audio Buffer (for user)
   162                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   163                                  	; 26/11/2023
   164                                  	sys	_audio, 0200h, [buffersize], audio_buffer
   165                                  	jnc	short _2
   166                                  error_exit:
   167                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
   168                                  	jmp	Exit
   169                                  _2:
   170                                  	; DIRECT CGA (TEXT MODE) MEMORY ACCESS
   171                                  	; bl = 0, bh = 4
   172                                  	; Direct access/map to CGA (Text) memory (0B8000h)
   173                                  
   174                                  	sys	_video, 0400h
   175                                  	cmp	eax, 0B8000h
   176                                  	jne	short error_exit
   177                                  
   178                                  	; Initialize Audio Device (bh = 3)
   179                                  	sys	_audio, 0301h, 0, audio_int_handler 
   180                                  ;	jc	short error_exit
   181                                  _3:
   182                                  
   183                                  %endif
   184 0000008B E893060000              	call	write_audio_dev_info 
   185                                  
   186                                  ; open the file
   187                                          ; open existing file
   188 00000090 E838040000                      call    openFile ; no error? ok.
   189 00000095 731B                            jnc     short _gsr
   190                                  
   191                                  ; file not found!
   192                                  	sys	_msg, noFileErrMsg, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000097 BB[62210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000009C B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000000A1 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000000A6 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000000AB CD40                <1>  int 40h
   193                                  _exit_:
   194 000000AD E9E8030000                      jmp     Exit
   195                                  
   196                                  _gsr:  
   197 000000B2 E850040000                     	call    getSampleRate		; read the sample rate
   198                                                                          ; pass it onto codec.
   199                                  	;jc	Exit
   200                                  	; 25/11/2023
   201 000000B7 72F4                    	jc	short _exit_
   202                                  
   203 000000B9 66A3[42230000]          	mov	[sample_rate], ax
   204 000000BF 880D[40230000]          	mov	[stmo], cl
   205 000000C5 8815[41230000]          	mov	[bps], dl
   206                                  
   207                                  	; 26/11/2023
   208 000000CB C605[BC230000]00        	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   209 000000D2 FEC9                    	dec	cl
   210 000000D4 7506                    	jnz	short _gsr_1 ; stereo
   211 000000D6 FE05[BC230000]          	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   212                                  _gsr_1:	
   213 000000DC 80FA08                  	cmp	dl, 8 
   214 000000DF 7706                    	ja	short _gsr_2 ; 16 bit samples
   215 000000E1 FE05[BC230000]          	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   216                                  _gsr_2:	
   217                                  	; 06/06/2017
   218                                  	sys	_audio, 0E00h ; get audio controller info
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000000E7 BB000E0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000000EC B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000000F1 CD40                <1>  int 40h
   219 000000F3 0F82F5020000            	jc	error_exit ; 25/11/2023
   220                                  
   221                                  	;cmp	ah, 2 ; ICH ? (Intel AC'97 Audio Controller)
   222                                  	;jne	_dev_not_ready	
   223                                  
   224                                  	; EAX = IRQ Number in AL
   225                                  	;	Audio Device Number in AH 
   226                                  	; EBX = DEV/VENDOR ID
   227                                  	;       (DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV)
   228                                  	; ECX = BUS/DEV/FN 
   229                                  	;       (00000000BBBBBBBBDDDDDFFF00000000)
   230                                  	; EDX = NABMBAR/NAMBAR (for AC97)
   231                                  	;      (Low word, DX = NAMBAR address)
   232                                  	; EDX = Base IO Addr (DX) for SB16 & VT8233
   233                                  
   234 000000F9 A2[BB230000]            	mov	[ac97_int_ln_reg], al
   235 000000FE 891D[BD230000]          	mov	[dev_vendor], ebx
   236 00000104 890D[C1230000]          	mov	[bus_dev_fn], ecx
   237                                  	;mov	[ac97_NamBar], dx
   238                                  	;shr	dx, 16
   239                                  	;mov	[ac97_NabmBar], dx
   240 0000010A 8915[C5230000]          	mov	[ac97_NamBar], edx	
   241                                    
   242                                  	; 01/06/2024
   243                                  	; Reset Audio Device (bh = 8)
   244                                  	sys	_audio, 0800h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000110 BB00080000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000115 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000011A CD40                <1>  int 40h
   245                                  	;jc	error_exit	
   246 0000011C 7230                    	jc	short init_err
   247                                  
   248 0000011E E8E2060000              	call	write_ac97_pci_dev_info
   249                                  
   250                                  	; 01/06/2024
   251                                  	; 25/11/2023
   252                                  	; Get AC'97 Codec info
   253                                  	; (Function 14, sub function 1)
   254                                  	sys	_audio, 0E01h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000123 BB010E0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000128 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000012D CD40                <1>  int 40h
   255                                  	; Save Variable Rate Audio support bit
   256 0000012F 2401                    	and	al, 1
   257 00000131 A2[4C230000]            	mov	[VRA], al
   258                                  
   259                                  	; 25/11/2023
   260 00000136 E891080000              	call	write_VRA_info
   261                                  
   262                                  	; 01/05/2017
   263 0000013B E8FA050000              	call	write_wav_file_info
   264                                  
   265                                  	; 25/11/2023
   266                                  	; ------------------------------------------
   267                                  
   268 00000140 803D[4C230000]01        	cmp	byte [VRA], 1
   269 00000147 7220                    	jb	short chk_sample_rate
   270                                  
   271                                  playwav_48_khz:	
   272                                  	;mov	dword [loadfromwavfile], loadFromFile
   273                                  	;mov	dword [buffersize], 65536
   274 00000149 E987020000              	jmp	PlayNow
   275                                  
   276                                  	; 01/06/2024
   277                                  init_err:
   278                                  	sys	_msg, msg_init_err, 255, 0Eh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000014E BB[9B210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000153 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000158 BA0E000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000015D B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000162 CD40                <1>  int 40h
   279 00000164 E931030000              	jmp	Exit
   280                                  
   281                                  chk_sample_rate:
   282                                  	; set conversion parameters
   283                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   284 00000169 66A1[42230000]          	mov	ax, [sample_rate]
   285 0000016F 663D80BB                	cmp	ax, 48000
   286 00000173 74D4                    	je	short playwav_48_khz
   287                                  chk_22khz:
   288 00000175 663D2256                	cmp	ax, 22050
   289 00000179 7545                    	jne	short chk_11khz
   290 0000017B 803D[41230000]08        	cmp	byte [bps], 8
   291 00000182 7615                    	jna	short chk_22khz_1
   292 00000184 BB[5A160000]            	mov	ebx, load_22khz_stereo_16_bit
   293 00000189 803D[40230000]01        	cmp	byte [stmo], 1 
   294 00000190 751A                    	jne	short chk_22khz_2
   295 00000192 BB[CD150000]            	mov	ebx, load_22khz_mono_16_bit
   296 00000197 EB13                    	jmp	short chk_22khz_2
   297                                  chk_22khz_1:
   298 00000199 BB[46150000]            	mov	ebx, load_22khz_stereo_8_bit
   299 0000019E 803D[40230000]01        	cmp	byte [stmo], 1 
   300 000001A5 7505                    	jne	short chk_22khz_2
   301 000001A7 BB[BD140000]            	mov	ebx, load_22khz_mono_8_bit
   302                                  chk_22khz_2:
   303 000001AC B85A1D0000              	mov	eax, 7514  ; (442*17)
   304 000001B1 BA25000000              	mov	edx, 37
   305 000001B6 B911000000              	mov	ecx, 17 
   306 000001BB E9BA010000              	jmp	set_sizes	
   307                                  chk_11khz:
   308 000001C0 663D112B                	cmp	ax, 11025
   309 000001C4 7545                    	jne	short chk_44khz
   310 000001C6 803D[41230000]08        	cmp	byte [bps], 8
   311 000001CD 7615                    	jna	short chk_11khz_1
   312 000001CF BB[76180000]            	mov	ebx, load_11khz_stereo_16_bit
   313 000001D4 803D[40230000]01        	cmp	byte [stmo], 1 
   314 000001DB 751A                    	jne	short chk_11khz_2
   315 000001DD BB[FD170000]            	mov	ebx, load_11khz_mono_16_bit
   316 000001E2 EB13                    	jmp	short chk_11khz_2
   317                                  chk_11khz_1:
   318 000001E4 BB[83170000]            	mov	ebx, load_11khz_stereo_8_bit
   319 000001E9 803D[40230000]01        	cmp	byte [stmo], 1 
   320 000001F0 7505                    	jne	short chk_11khz_2
   321 000001F2 BB[0B170000]            	mov	ebx, load_11khz_mono_8_bit
   322                                  chk_11khz_2:
   323 000001F7 B8AD0E0000              	mov	eax, 3757  ; (221*17)
   324 000001FC BA4A000000              	mov	edx, 74
   325 00000201 B911000000              	mov	ecx, 17
   326 00000206 E96F010000              	jmp	set_sizes 
   327                                  chk_44khz:
   328 0000020B 663D44AC                	cmp	ax, 44100
   329 0000020F 7545                    	jne	short chk_16khz
   330 00000211 803D[41230000]08        	cmp	byte [bps], 8
   331 00000218 7615                    	jna	short chk_44khz_1
   332 0000021A BB[9D1A0000]            	mov	ebx, load_44khz_stereo_16_bit
   333 0000021F 803D[40230000]01        	cmp	byte [stmo], 1 
   334 00000226 751A                    	jne	short chk_44khz_2
   335 00000228 BB[241A0000]            	mov	ebx, load_44khz_mono_16_bit
   336 0000022D EB13                    	jmp	short chk_44khz_2
   337                                  chk_44khz_1:
   338 0000022F BB[A7190000]            	mov	ebx, load_44khz_stereo_8_bit
   339 00000234 803D[40230000]01        	cmp	byte [stmo], 1 
   340 0000023B 7505                    	jne	short chk_44khz_2
   341 0000023D BB[2B190000]            	mov	ebx, load_44khz_mono_8_bit
   342                                  chk_44khz_2:
   343 00000242 B8D93A0000              	mov	eax, 15065 ; (655*23)
   344 00000247 BA19000000              	mov	edx, 25
   345 0000024C B917000000              	mov	ecx, 23
   346 00000251 E924010000              	jmp	set_sizes 
   347                                  chk_16khz:
   348 00000256 663D803E                	cmp	ax, 16000
   349 0000025A 7545                    	jne	short chk_8khz
   350 0000025C 803D[41230000]08        	cmp	byte [bps], 8
   351 00000263 7615                    	jna	short chk_16khz_1
   352 00000265 BB[02100000]            	mov	ebx, load_16khz_stereo_16_bit
   353 0000026A 803D[40230000]01        	cmp	byte [stmo], 1 
   354 00000271 751A                    	jne	short chk_16khz_2
   355 00000273 BB[810F0000]            	mov	ebx, load_16khz_mono_16_bit
   356 00000278 EB13                    	jmp	short chk_16khz_2
   357                                  chk_16khz_1:
   358 0000027A BB[C70E0000]            	mov	ebx, load_16khz_stereo_8_bit
   359 0000027F 803D[40230000]01        	cmp	byte [stmo], 1 
   360 00000286 7505                    	jne	short chk_16khz_2
   361 00000288 BB[480E0000]            	mov	ebx, load_16khz_mono_8_bit
   362                                  chk_16khz_2:
   363 0000028D B855150000              	mov	eax, 5461
   364 00000292 BA03000000              	mov	edx, 3
   365 00000297 B901000000              	mov	ecx, 1
   366 0000029C E9D9000000              	jmp	set_sizes 
   367                                  chk_8khz:
   368 000002A1 663D401F                	cmp	ax, 8000
   369 000002A5 7545                    	jne	short chk_24khz
   370 000002A7 803D[41230000]08        	cmp	byte [bps], 8
   371 000002AE 7615                    	jna	short chk_8khz_1
   372 000002B0 BB[FD0C0000]            	mov	ebx, load_8khz_stereo_16_bit
   373 000002B5 803D[40230000]01        	cmp	byte [stmo], 1 
   374 000002BC 751A                    	jne	short chk_8khz_2
   375 000002BE BB[2D0C0000]            	mov	ebx, load_8khz_mono_16_bit
   376 000002C3 EB13                    	jmp	short chk_8khz_2
   377                                  chk_8khz_1:
   378 000002C5 BB[FD0A0000]            	mov	ebx, load_8khz_stereo_8_bit
   379 000002CA 803D[40230000]01        	cmp	byte [stmo], 1 
   380 000002D1 7505                    	jne	short chk_8khz_2
   381 000002D3 BB[190A0000]            	mov	ebx, load_8khz_mono_8_bit
   382                                  chk_8khz_2:
   383 000002D8 B8AA0A0000              	mov	eax, 2730
   384 000002DD BA06000000              	mov	edx, 6
   385 000002E2 B901000000              	mov	ecx, 1
   386 000002E7 E98E000000              	jmp	set_sizes 
   387                                  chk_24khz:
   388 000002EC 663DC05D                	cmp	ax, 24000
   389 000002F0 7542                    	jne	short chk_32khz
   390 000002F2 803D[41230000]08        	cmp	byte [bps], 8
   391 000002F9 7615                    	jna	short chk_24khz_1
   392 000002FB BB[2C120000]            	mov	ebx, load_24khz_stereo_16_bit
   393 00000300 803D[40230000]01        	cmp	byte [stmo], 1 
   394 00000307 751A                    	jne	short chk_24khz_2
   395 00000309 BB[C9110000]            	mov	ebx, load_24khz_mono_16_bit
   396 0000030E EB13                    	jmp	short chk_24khz_2
   397                                  chk_24khz_1:
   398 00000310 BB[3F110000]            	mov	ebx, load_24khz_stereo_8_bit
   399 00000315 803D[40230000]01        	cmp	byte [stmo], 1 
   400 0000031C 7505                    	jne	short chk_24khz_2
   401 0000031E BB[D8100000]            	mov	ebx, load_24khz_mono_8_bit
   402                                  chk_24khz_2:
   403 00000323 B800200000              	mov	eax, 8192
   404 00000328 BA02000000              	mov	edx, 2
   405 0000032D B901000000              	mov	ecx, 1
   406 00000332 EB46                    	jmp	short set_sizes 
   407                                  chk_32khz:
   408 00000334 663D007D                	cmp	ax, 32000
   409 00000338 7574                    	jne	short vra_needed
   410 0000033A 803D[41230000]08        	cmp	byte [bps], 8
   411 00000341 7615                    	jna	short chk_32khz_1
   412 00000343 BB[2D140000]            	mov	ebx, load_32khz_stereo_16_bit
   413 00000348 803D[40230000]01        	cmp	byte [stmo], 1 
   414 0000034F 751A                    	jne	short chk_32khz_2
   415 00000351 BB[C3130000]            	mov	ebx, load_32khz_mono_16_bit
   416 00000356 EB13                    	jmp	short chk_32khz_2
   417                                  chk_32khz_1:
   418 00000358 BB[26130000]            	mov	ebx, load_32khz_stereo_8_bit
   419 0000035D 803D[40230000]01        	cmp	byte [stmo], 1 
   420 00000364 7505                    	jne	short chk_32khz_2
   421 00000366 BB[B3120000]            	mov	ebx, load_32khz_mono_8_bit
   422                                  chk_32khz_2:
   423 0000036B B8AA2A0000              	mov	eax, 10922
   424 00000370 BA03000000              	mov	edx, 3
   425 00000375 B902000000              	mov	ecx, 2
   426                                  	;jmp	short set_sizes 
   427                                  set_sizes:
   428 0000037A 803D[40230000]01        	cmp	byte [stmo], 1
   429 00000381 7402                    	je	short ss_1
   430 00000383 D1E0                    	shl	eax, 1
   431                                  ss_1:
   432 00000385 803D[41230000]08        	cmp	byte [bps], 8
   433 0000038C 7602                    	jna	short ss_2
   434                                  	; 16 bit samples
   435 0000038E D1E0                    	shl	eax, 1
   436                                  ss_2:
   437 00000390 A3[CD030000]            	mov	[loadsize], eax
   438 00000395 F7E2                    	mul	edx
   439                                  	;cmp	ecx, 1
   440                                  	;je	short ss_3
   441                                  ;ss_3:
   442 00000397 F7F1                    	div	ecx
   443 00000399 8A0D[BC230000]          	mov	cl, [fbs_shift]
   444 0000039F D3E0                    	shl	eax, cl
   445                                  	; 26/11/2023
   446                                  	;shr	eax, 1	; buffer size is 16 bit sample count
   447 000003A1 A3[D1030000]            	mov	[buffersize], eax ; buffer size in bytes 
   448 000003A6 891D[C9030000]          	mov	[loadfromwavfile], ebx
   449 000003AC EB27                    	jmp	short PlayNow
   450                                  
   451                                  vra_needed:
   452                                  	sys	_msg, msg_no_vra, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003AE BB[CC210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003B3 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000003B8 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000003BD B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000003C2 CD40                <1>  int 40h
   453 000003C4 E9D1000000              	jmp	Exit
   454                                  
   455                                  	; 26/11/2023
   456                                  	; 13/11/2023
   457                                  loadfromwavfile:
   458 000003C9 [96050000]              	dd	loadFromFile
   459                                  loadsize:	; read from wav file
   460 000003CD 00000000                	dd	0
   461                                  buffersize:	; write to DMA buffer
   462 000003D1 00000100                	dd	65536 ; bytes
   463                                  
   464                                  PlayNow: 
   465                                  
   466                                  ; 26/11/2023
   467                                  %if 1
   468                                  	; Allocate Audio Buffer (for user)
   469                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   470                                  	; 26/11/2023
   471                                  	sys	_audio, 0200h, [buffersize], audio_buffer
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003D5 BB00020000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003DA 8B0D[D1030000]      <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000003E0 BA[00300000]        <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000003E5 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000003EA CD40                <1>  int 40h
   472 000003EC 731B                    	jnc	short _2
   473                                  
   474                                  	; 26/11/2023 - temporary
   475                                  	;sys	_msg, test_1, 255, 0Ch
   476                                  
   477                                  error_exit:
   478                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003EE BB[7B210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003F3 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000003F8 BA0E000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000003FD B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000402 CD40                <1>  int 40h
   479 00000404 E991000000              	jmp	Exit
   480                                  _2:
   481                                  	; DIRECT CGA (TEXT MODE) MEMORY ACCESS
   482                                  	; bl = 0, bh = 4
   483                                  	; Direct access/map to CGA (Text) memory (0B8000h)
   484                                  
   485                                  	sys	_video, 0400h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000409 BB00040000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000040E B81F000000          <1>  mov eax, %1
    86                              <1> 
    87 00000413 CD40                <1>  int 40h
   486 00000415 3D00800B00              	cmp	eax, 0B8000h
   487 0000041A 75D2                    	jne	short error_exit
   488                                  
   489                                  	; 01/06/2024
   490                                  	; Initialize Audio Device (bh = 3)
   491                                  	sys	_audio, 0301h, 0, audio_int_handler 
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000041C BB01030000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000421 B900000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000426 BA[65050000]        <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000042B B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000430 CD40                <1>  int 40h
   492                                  	;jc	short error_exit
   493 00000432 0F8216FDFFFF            	jc	init_err
   494                                  _3:
   495                                  
   496                                  %endif
   497                                  
   498                                  ;
   499                                  ; position file pointer to start in actual wav data
   500                                  ; MUCH improvement should really be done here to check if sample size is
   501                                  ; supported, make sure there are 2 channels, etc.  
   502                                  ;
   503                                          ;mov     ah, 42h
   504                                          ;mov     al, 0	; from start of file
   505                                          ;mov     bx, [FileHandle]
   506                                          ;xor     cx, cx
   507                                          ;mov     dx, 44	; jump past .wav/riff header
   508                                          ;int     21h
   509                                  
   510                                  	sys	_seek, [FileHandle], 44, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000438 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000043E B92C000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000443 BA00000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000448 B813000000          <1>  mov eax, %1
    86                              <1> 
    87 0000044D CD40                <1>  int 40h
   511                                  
   512                                  	sys	_msg, nextline, 255, 07h ; 01/05/2017
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000044F BB[51220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000454 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000459 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000045E B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000463 CD40                <1>  int 40h
   513                                  
   514                                  ; play the .wav file. Most of the good stuff is in here.
   515                                  
   516 00000465 E8E1010000                      call    PlayWav
   517                                  
   518                                  ; close the .wav file and exit.
   519                                  
   520                                  StopPlaying:
   521                                  	; Stop Playing
   522                                  	sys	_audio, 0700h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000046A BB00070000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000046F B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000474 CD40                <1>  int 40h
   523                                  	; Cancel callback service (for user)
   524                                  	sys	_audio, 0900h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000476 BB00090000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000047B B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000480 CD40                <1>  int 40h
   525                                  	; Deallocate Audio Buffer (for user)
   526                                  	sys	_audio, 0A00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000482 BB000A0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000487 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000048C CD40                <1>  int 40h
   527                                  	; Disable Audio Device
   528                                  	sys	_audio, 0C00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000048E BB000C0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000493 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000498 CD40                <1>  int 40h
   529                                  Exit:  
   530 0000049A E847000000                      call    closeFile
   531                                           
   532                                  	sys	_exit	; Bye!
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000049F B801000000          <1>  mov eax, %1
    86                              <1> 
    87 000004A4 CD40                <1>  int 40h
   533                                  here:
   534 000004A6 EBFE                    	jmp	short here
   535                                  
   536                                  pmsg_usage:
   537                                  	sys	_msg, msg_usage, 255, 0Bh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004A8 BB[18210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000004AD B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000004B2 BA0B000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004B7 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000004BC CD40                <1>  int 40h
   538 000004BE EBDA                    	jmp	short Exit
   539                                  
   540                                  	; 25/11/2023
   541                                  DetectAC97:
   542                                  	; Detect (BH=1) AC'97 (BL=2) Audio Device
   543                                          sys	_audio, 0102h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004C0 BB02010000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004C5 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000004CA CD40                <1>  int 40h
   544                                  
   545                                  ; 01/06/2024
   546                                  %if 0
   547                                  	jc	short DetectAC97_retn
   548                                  
   549                                  	; 25/11/2023
   550                                  	; Get AC'97 Codec info
   551                                  	; (Function 14, sub function 1)
   552                                  	sys	_audio, 0E01h
   553                                  	; Save Variable Rate Audio support bit
   554                                  	and	al, 1
   555                                  	mov	[VRA], al
   556                                  %endif
   557                                  
   558                                  DetectAC97_retn:
   559 000004CC C3                      	retn
   560                                  
   561                                  ;open or create file
   562                                  ;
   563                                  ;input: ds:dx-->filename (asciiz)
   564                                  ;       al=file Mode (create or open)
   565                                  ;output: none  cs:[FileHandle] filled
   566                                  ;
   567                                  openFile:
   568                                  	;mov	ah, 3Bh	; start with a mode
   569                                  	;add	ah, al	; add in create or open mode
   570                                  	;xor	ecx, ecx
   571                                  	;int	21h
   572                                  	;jc	short _of1
   573                                  	;;mov	[cs:FileHandle], ax
   574                                  
   575                                  	sys	_open, wav_file_name, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004CD BB[69230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000004D2 B900000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004D7 B805000000          <1>  mov eax, %1
    86                              <1> 
    87 000004DC CD40                <1>  int 40h
   576 000004DE 7205                    	jc	short _of1
   577                                  
   578 000004E0 A3[6B200000]            	mov	[FileHandle], eax
   579                                  _of1:
   580 000004E5 C3                      	retn
   581                                  
   582                                  ; close the currently open file
   583                                  ; input: none, uses cs:[FileHandle]
   584                                  closeFile:
   585 000004E6 833D[6B200000]FF        	cmp	dword [FileHandle], -1
   586 000004ED 7417                    	je	short _cf1
   587                                  	;mov    bx, [FileHandle]  
   588                                  	;mov    ax, 3E00h
   589                                          ;int    21h              ;close file
   590                                  
   591                                  	sys	_close, [FileHandle]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004EF 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004F5 B806000000          <1>  mov eax, %1
    86                              <1> 
    87 000004FA CD40                <1>  int 40h
   592 000004FC C705[6B200000]FFFF-     	mov 	dword [FileHandle], -1
   592 00000504 FFFF               
   593                                  _cf1:
   594 00000506 C3                      	retn
   595                                  
   596                                  getSampleRate:
   597                                  	
   598                                  ; reads the sample rate from the .wav file.
   599                                  ; entry: none - assumes file is already open
   600                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   601                                  ;	cx = number of channels (mono=1, stereo=2)
   602                                  ;	dx = bits per sample (8, 16)
   603                                  
   604 00000507 53                      	push    ebx
   605                                  
   606                                          ;mov	ah, 42h
   607                                          ;mov	al, 0	; from start of file
   608                                          ;mov	bx, [FileHandle]
   609                                          ;xor	ecx, ecx
   610                                          ;mov	dx, 08h	; "WAVE"
   611                                          ;int	21h
   612                                  	
   613                                  	sys	_seek, [FileHandle], 8, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000508 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000050E B908000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000513 BA00000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000518 B813000000          <1>  mov eax, %1
    86                              <1> 
    87 0000051D CD40                <1>  int 40h
   614                                  
   615                                          ;mov	dx, smpRBuff
   616                                          ;mov	cx, 28	; 28 bytes
   617                                  	;mov	ah, 3fh
   618                                          ;int	21h
   619                                  
   620                                  	sys	_read, [FileHandle], smpRBuff, 28
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000051F 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000525 B9[4D230000]        <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000052A BA1C000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000052F B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000534 CD40                <1>  int 40h
   621                                  
   622 00000536 813D[4D230000]5741-     	cmp	dword [smpRBuff], 'WAVE'
   622 0000053E 5645               
   623 00000540 7520                    	jne	short gsr_stc
   624                                  
   625 00000542 66833D[59230000]01      	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   626 0000054A 7516                    	jne	short gsr_stc
   627                                  
   628 0000054C 668B0D[5B230000]        	mov	cx, [smpRBuff+14]	; return num of channels in CX
   629 00000553 66A1[5D230000]                  mov     ax, [smpRBuff+16]	; return sample rate in AX
   630 00000559 668B15[67230000]        	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   631                                  gsr_retn:
   632 00000560 5B                              pop     ebx
   633 00000561 C3                              retn
   634                                  gsr_stc:
   635 00000562 F9                      	stc
   636 00000563 EBFB                    	jmp	short gsr_retn
   637                                  
   638                                  audio_int_handler:
   639                                  	; 18/08/2020 (14/10/2020, 'wavplay2.s')
   640                                  
   641                                  	;mov	byte [srb], 1 ; interrupt (or signal response byte)
   642                                  	
   643                                  	;cmp	byte [cbs_busy], 1
   644                                  	;jnb	short _callback_bsy_retn
   645                                  	
   646                                  	;mov	byte [cbs_busy], 1
   647                                  
   648 00000565 A0[49230000]            	mov	al, [half_buff]
   649                                  
   650 0000056A 3C01                    	cmp	al, 1
   651 0000056C 721A                    	jb	short _callback_retn
   652                                  
   653                                  	; 18/08/2020
   654 0000056E C605[4A230000]01        	mov	byte [srb], 1
   655                                  
   656 00000575 8035[49230000]03        	xor	byte [half_buff], 3 ; 2->1, 1->2
   657                                  
   658 0000057C 0430                    	add	al, '0'
   659                                  tL0:	; 26/11/2023
   660 0000057E B44E                    	mov	ah, 4Eh
   661 00000580 BB00800B00              	mov	ebx, 0B8000h ; video display page address
   662 00000585 668903                  	mov	[ebx], ax ; show playing buffer (1, 2)
   663                                  _callback_retn:
   664                                  	;mov	byte [cbs_busy], 0
   665                                  _callback_bsy_retn:
   666                                  	sys	_rele ; return from callback service 
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000588 B827000000          <1>  mov eax, %1
    86                              <1> 
    87 0000058D CD40                <1>  int 40h
   667                                  	; we must not come here !
   668                                  	sys	_exit
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000058F B801000000          <1>  mov eax, %1
    86                              <1> 
    87 00000594 CD40                <1>  int 40h
   669                                  	
   670                                  loadFromFile:
   671                                  	; 26/11/2023
   672 00000596 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
   673                                  					; last of the file?
   674 0000059D 7402                    	jz	short lff_0		; no
   675 0000059F F9                      	stc
   676 000005A0 C3                      	retn
   677                                  lff_0:
   678                                  	; 13/06/2017
   679                                  	;mov	edx, BUFFERSIZE
   680                                  	; 26/11/2023
   681 000005A1 BF[00300000]            	mov	edi, audio_buffer
   682 000005A6 8B15[D1030000]          	mov	edx, [buffersize]	; bytes
   683 000005AC 8A0D[BC230000]          	mov	cl, [fbs_shift]   
   684 000005B2 20C9                    	and	cl, cl
   685 000005B4 7409                    	jz	short lff_1 ; stereo, 16 bit
   686                                  
   687                                  	; fbs_shift =
   688                                  	;	2 for mono and 8 bit sample (multiplier = 4)
   689                                  	;	1 for mono or 8 bit sample (multiplier = 2)
   690 000005B6 D3EA                    	shr	edx, cl
   691                                  	;inc	edx
   692                                  
   693 000005B8 BE[00300100]            	mov     esi, temp_buffer
   694 000005BD EB02                    	jmp	short lff_2
   695                                  lff_1:
   696                                  	;mov	esi, audio_buffer
   697 000005BF 89FE                    	mov	esi, edi ; audio_buffer
   698                                  lff_2:
   699                                  	; 17/03/2017
   700                                  	; esi = buffer address
   701                                  	; edx = buffer size
   702                                   
   703                                  	; 26/11/2023
   704                                  	; load file into memory
   705                                  	sys 	_read, [FileHandle], esi
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000005C1 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000005C7 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000005C9 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000005CE CD40                <1>  int 40h
   706 000005D0 89D1                    	mov	ecx, edx
   707 000005D2 724A                    	jc	short padfill ; error !
   708                                  
   709 000005D4 21C0                    	and	eax, eax
   710 000005D6 7446                    	jz	short padfill
   711                                  lff_3:
   712                                  	; 26/11/2023
   713 000005D8 8A1D[BC230000]          	mov	bl, [fbs_shift]
   714 000005DE 20DB                    	and	bl, bl
   715 000005E0 745C                    	jz	short lff_11
   716                                  
   717 000005E2 29C1                    	sub	ecx, eax
   718 000005E4 89CD                    	mov	ebp, ecx
   719                                  
   720                                  	;mov	esi, temp_buffer
   721                                  	;mov	edi, audio_buffer
   722 000005E6 89C1                    	mov	ecx, eax   ; byte count
   723                                  
   724 000005E8 803D[41230000]08        	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   725 000005EF 751E                    	jne	short lff_6 ; 16 bit samples
   726                                  	; 8 bit samples
   727 000005F1 FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
   728 000005F3 740E                    	jz	short lff_5 ; 8 bit, stereo
   729                                  lff_4:
   730                                  	; mono & 8 bit
   731 000005F5 AC                      	lodsb
   732 000005F6 2C80                    	sub	al, 80h ; 08/11/2023
   733 000005F8 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   734 000005FB 66AB                    	stosw	; left channel
   735 000005FD 66AB                    	stosw	; right channel
   736 000005FF E2F4                    	loop	lff_4
   737 00000601 EB16                    	jmp	short lff_8
   738                                  lff_5:
   739                                  	; stereo & 8 bit
   740 00000603 AC                      	lodsb
   741 00000604 2C80                    	sub	al, 80h ; 08/11/2023
   742 00000606 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   743 00000609 66AB                    	stosw
   744 0000060B E2F6                    	loop	lff_5			
   745 0000060D EB0A                    	jmp	short lff_8
   746                                  lff_6:
   747 0000060F D1E9                    	shr	ecx, 1 ; word count
   748                                  lff_7:
   749 00000611 66AD                    	lodsw
   750 00000613 66AB                    	stosw	; left channel
   751 00000615 66AB                    	stosw	; right channel
   752 00000617 E2F8                    	loop	lff_7
   753                                  lff_8:
   754                                  	; 27/11/2023
   755 00000619 F8                      	clc
   756 0000061A 89E9                    	mov	ecx, ebp
   757 0000061C E314                    	jecxz	endLFF_retn
   758                                  	
   759                                  padfill:
   760 0000061E 803D[41230000]10        	cmp 	byte [bps], 16
   761 00000625 740C                    	je	short lff_10
   762                                  	; Minimum Value = 0
   763 00000627 30C0                            xor     al, al
   764 00000629 F3AA                    	rep	stosb
   765                                  lff_9:
   766 0000062B 800D[48230000]01                or	byte [flags], ENDOFFILE	; end of file flag
   767                                  endLFF_retn:
   768 00000632 C3                              retn
   769                                  lff_10:
   770 00000633 31C0                    	xor	eax, eax
   771                                  	; Minimum value = 8000h (-32768)
   772 00000635 D1E9                    	shr	ecx, 1 
   773 00000637 B480                    	mov	ah, 80h ; ax = -32768
   774 00000639 F366AB                  	rep	stosw
   775 0000063C EBED                    	jmp	short lff_9
   776                                  
   777                                  lff_11:
   778                                  	; 16 bit stereo
   779                                  	; ecx = buffer size
   780                                  	; eax = read count
   781 0000063E 29C1                    	sub	ecx, eax
   782 00000640 76F0                    	jna	short endLFF_retn
   783 00000642 01C7                    	add	edi, eax  ; audio_buffer + eax
   784 00000644 EBED                    	jmp	short lff_10 ; padfill
   785                                  
   786                                  error_exit_2:
   787                                  	; 26/11/2023 - temporary
   788                                  	;sys	_msg, test_2, 255, 0Ch
   789                                  
   790 00000646 E9A3FDFFFF              	jmp	error_exit
   791                                  	
   792                                  	; 26/11/2023 - temporary
   793                                  ;test_1:
   794                                  ;	db 13, 10, 'Test 1', 13,10, 0
   795                                  ;test_2:
   796                                  ;	db 13, 10, 'Test 2', 13,10, 0
   797                                  	
   798                                  PlayWav:
   799                                  	; 26/11/2023
   800                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   801                                  	; 13/06/2017
   802                                  	; Convert 8 bit samples to 16 bit samples
   803                                  	; and convert mono samples to stereo samples
   804                                  
   805                                  	; 26/11/2023
   806                                  	; load 32768 bytes into audio buffer
   807                                  	;mov	edi, audio_buffer
   808                                  	;;mov	edx, BUFFERSIZE
   809                                  	; 26/11/2023
   810                                  	;mov	edx, [buffersize]
   811                                  	;call	loadFromFile
   812                                  	; 26/11/2023
   813 0000064B FF15[C9030000]          	call	dword [loadfromwavfile]
   814 00000651 72F3                    	jc	short error_exit_2
   815 00000653 C605[49230000]01        	mov	byte [half_buff], 1 ; (DMA) Buffer 1
   816                                  
   817                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   818 0000065A F605[48230000]01        	test    byte [flags], ENDOFFILE  ; end of file
   819 00000661 7512                    	jnz	short _6 ; yes
   820                                  			 ; bypass filling dma half buffer 2
   821                                  
   822                                  	; bh = 16 : update (current, first) dma half buffer
   823                                  	; bl = 0  : then switch to the next (second) half buffer
   824                                  	sys	_audio, 1000h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000663 BB00100000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000668 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000066D CD40                <1>  int 40h
   825                                  
   826                                  	; 18/08/2020
   827                                  	; [audio_flag] = 1 (in TRDOS 386 kernel)
   828                                  
   829                                  	; audio_buffer must be filled again after above system call 
   830                                  	; (Because audio interrupt will be generated by AC97 hardware
   831                                  	; at the end of the first half of dma buffer.. so, 
   832                                  	; the second half must be ready. 'sound_play' will use it.)
   833                                  
   834                                  	; 26/11/2023
   835                                  	;mov	edi, audio_buffer
   836                                  	;;mov	edx, BUFFERSIZE
   837                                  	; 26/11/2023
   838                                  	;mov	edx, [buffersize]
   839                                  	;call	loadFromFile
   840                                  	; 26/11/2023
   841 0000066F FF15[C9030000]          	call	dword [loadfromwavfile]
   842                                  	;jc	short p_return
   843                                  _6:
   844                                  	; Set Master Volume Level (BL=0 or 80h)
   845                                  	; 	for next playing (BL>=80h)
   846                                  	;sys	_audio, 0B80h, 1D1Dh
   847                                  	sys	_audio, 0B00h, 1D1Dh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000675 BB000B0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000067A B91D1D0000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000067F B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000684 CD40                <1>  int 40h
   848                                  
   849                                  	; 18/08/2020
   850                                  	;mov	byte [volume_level], 1Dh
   851 00000686 880D[4B230000]          	mov	[volume_level], cl
   852                                  
   853                                  	; Start	to play
   854 0000068C A0[41230000]            	mov	al, [bps]
   855 00000691 C0E804                  	shr	al, 4 ; 8 -> 0, 16 -> 1
   856 00000694 D0E0                    	shl	al, 1 ; 16 -> 2, 8 -> 0
   857 00000696 8A1D[40230000]          	mov	bl, [stmo]
   858 0000069C FECB                    	dec	bl
   859 0000069E 08C3                    	or	bl, al
   860 000006A0 668B0D[42230000]        	mov	cx, [sample_rate] 
   861 000006A7 B704                    	mov	bh, 4 ; start to play
   862                                  	sys	_audio
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000006A9 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000006AE CD40                <1>  int 40h
   863                                  
   864                                  	;mov	ebx, 0B8000h ; video display page address
   865                                  	;mov	ah, 4Eh
   866                                  	;mov	al, [half_buffer]
   867                                  	;mov	[ebx], ax ; show playing buffer (1, 2)
   868                                  
   869                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   870                                  	; Here..
   871                                  	; If byte [flags] <> ENDOFFILE ...
   872                                  	; user's audio_buffer has been copied to dma half buffer 2
   873                                  
   874                                  	; [audio_flag] = 0 (in TRDOS 386 kernel)
   875                                  
   876                                  	; audio_buffer must be filled again after above system call 
   877                                  	; (Because, audio interrupt will be generated by VT8237R
   878                                  	; at the end of the first half of dma buffer.. so, 
   879                                  	; the 2nd half of dma buffer is ready but the 1st half
   880                                  	; must be filled again.)
   881                                  
   882                                  	; 18/08/2020
   883 000006B0 F605[48230000]01        	test    byte [flags], ENDOFFILE  ; end of file
   884 000006B7 7506                    	jnz	short p_loop ; yes
   885                                  
   886                                  	; 18/08/2020
   887                                  	; load 32768 bytes into audio buffer
   888                                  	;; (for the second half of DMA buffer)
   889                                  	; 27/11/2023
   890                                  	; 20/05/2017
   891                                  	;mov	edi, audio_buffer
   892                                  	;mov	edx, BUFFERSIZE
   893                                  	; 26/11/2023
   894                                  	;mov	edx, [buffersize]
   895                                  	;call	loadFromFile
   896                                  	; 26/11/2023
   897 000006B9 FF15[C9030000]          	call	dword [loadfromwavfile]
   898                                  	;jc	short p_return
   899                                  	;mov	byte [half_buff], 2 ; (DMA) Buffer 2
   900                                  
   901                                  	; we need to wait for 'SRB' (audio interrupt)
   902                                  	; (we can not return from 'PlayWav' here 
   903                                  	;  even if we have got an error from file reading)
   904                                  	; ((!!current audio data must be played!!))
   905                                  
   906                                  	; 18/08/2020
   907                                  	;mov	byte [srb], 1
   908                                  
   909                                  p_loop:
   910                                  	;mov	ah, 1		; any key pressed?
   911                                  	;int	32h		; no, Loop.
   912                                  	;jz	short q_loop
   913                                  	;
   914                                  	;mov	ah, 0		; flush key buffer...
   915                                  	;int	32h
   916                                  
   917                                  	; 18/08/2020 (14/10/2017, 'wavplay2.s')
   918 000006BF 803D[4A230000]00        	cmp	byte [srb], 0
   919 000006C6 760F                    	jna	short q_loop
   920 000006C8 C605[4A230000]00        	mov	byte [srb], 0
   921                                  	; 27/11/2023
   922                                  	;mov	edi, audio_buffer
   923                                  	;mov	edx, BUFFERSIZE
   924                                  	; 26/11/2023
   925                                  	;mov	edx, [buffersize]
   926                                  	;call	loadFromFile
   927                                  	; 26/11/2023
   928 000006CF FF15[C9030000]          	call	dword [loadfromwavfile]
   929 000006D5 7212                    	jc	short p_return
   930                                  q_loop:
   931 000006D7 B401                    	mov     ah, 1		; any key pressed?
   932 000006D9 CD32                    	int     32h		; no, Loop.
   933 000006DB 74E2                    	jz	short p_loop
   934                                  
   935 000006DD B400                    	mov     ah, 0		; flush key buffer...
   936 000006DF CD32                    	int     32h
   937                                  	
   938 000006E1 3C2B                    	cmp	al, '+' ; increase sound volume
   939 000006E3 740C                    	je	short inc_volume_level
   940 000006E5 3C2D                    	cmp	al, '-'
   941 000006E7 742B                    	je	short dec_volume_level
   942                                  
   943                                  p_return:
   944 000006E9 C605[49230000]00        	mov	byte [half_buff], 0
   945 000006F0 C3                      	retn
   946                                  
   947                                  	; 18/08/2020 (14/10/2017, 'wavplay2.s')
   948                                  inc_volume_level:
   949 000006F1 8A0D[4B230000]          	mov	cl, [volume_level]
   950 000006F7 80F91F                  	cmp	cl, 1Fh ; 31
   951 000006FA 73DB                    	jnb	short q_loop
   952 000006FC FEC1                    	inc	cl
   953                                  change_volume_level:
   954 000006FE 880D[4B230000]          	mov	[volume_level], cl
   955 00000704 88CD                    	mov	ch, cl
   956                                  	; Set Master Volume Level
   957                                  	sys	_audio, 0B00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000706 BB000B0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000070B B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000710 CD40                <1>  int 40h
   958 00000712 EBAB                    	jmp	short p_loop
   959                                  dec_volume_level:
   960 00000714 8A0D[4B230000]          	mov	cl, [volume_level]
   961 0000071A 80F901                  	cmp	cl, 1 ; 1
   962 0000071D 76A0                    	jna	short p_loop
   963 0000071F FEC9                    	dec	cl
   964 00000721 EBDB                    	jmp	short change_volume_level
   965                                  
   966                                  write_audio_dev_info:
   967                                  	; EBX = Message address
   968                                  	; ECX = Max. message length (or stop on ZERO character)
   969                                  	;	(1 to 255)
   970                                  	; DL  = Message color (07h = light gray, 0Fh = white) 
   971                                       	sys 	_msg, msgAudioCardInfo, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000723 BB[EF200000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000728 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000072D BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000732 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000737 CD40                <1>  int 40h
   972 00000739 C3                      	retn
   973                                  
   974                                  write_wav_file_info:
   975                                  	; 01/05/2017
   976                                  	sys	_msg, msgWavFileName, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000073A BB[05220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000073F B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000744 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000749 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000074E CD40                <1>  int 40h
   977                                  	sys	_msg, wav_file_name, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000750 BB[69230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000755 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000075A BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000075F B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000764 CD40                <1>  int 40h
   978                                  
   979                                  write_sample_rate:
   980                                  	; 01/05/2017
   981 00000766 66A1[42230000]          	mov	ax, [sample_rate]
   982                                  	; ax = sample rate (hertz)
   983 0000076C 31D2                    	xor	edx, edx
   984 0000076E 66B90A00                	mov	cx, 10
   985 00000772 66F7F1                  	div	cx
   986 00000775 0015[2A220000]          	add	[msgHertz+4], dl
   987 0000077B 29D2                    	sub	edx, edx
   988 0000077D 66F7F1                  	div	cx
   989 00000780 0015[29220000]          	add	[msgHertz+3], dl
   990 00000786 29D2                    	sub	edx, edx
   991 00000788 66F7F1                  	div	cx
   992 0000078B 0015[28220000]          	add	[msgHertz+2], dl
   993 00000791 29D2                    	sub	edx, edx
   994 00000793 66F7F1                  	div	cx
   995 00000796 0015[27220000]          	add	[msgHertz+1], dl
   996 0000079C 0005[26220000]          	add	[msgHertz], al
   997                                  	
   998                                  	sys	_msg, msgSampleRate, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000007A2 BB[17220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007A7 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000007AC BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000007B1 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000007B6 CD40                <1>  int 40h
   999                                  
  1000 000007B8 BE[41220000]            	mov	esi, msg16Bits
  1001 000007BD 803D[41230000]10        	cmp	byte [bps], 16
  1002 000007C4 7405                    	je	short wsr_1
  1003 000007C6 BE[31220000]            	mov	esi, msg8Bits
  1004                                  wsr_1:
  1005                                  	sys	_msg, esi, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000007CB 89F3                <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007CD B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000007D2 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000007D7 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000007DC CD40                <1>  int 40h
  1006                                  
  1007 000007DE BE[3A220000]            	mov	esi, msgMono
  1008 000007E3 803D[40230000]01        	cmp	byte [stmo], 1
  1009 000007EA 7405                    	je	short wsr_2
  1010 000007EC BE[4B220000]            	mov	esi, msgStereo		
  1011                                  wsr_2:
  1012                                  	sys	_msg, esi, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000007F1 89F3                <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007F3 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000007F8 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000007FD B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000802 CD40                <1>  int 40h
  1013 00000804 C3                              retn
  1014                                  
  1015                                  write_ac97_pci_dev_info:
  1016                                  	; 06/06/2017
  1017                                  	; 03/06/2017
  1018                                  	; BUS/DEV/FN
  1019                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1020                                  	; DEV/VENDOR
  1021                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1022                                  
  1023 00000805 8B35[BD230000]          	mov	esi, [dev_vendor]
  1024 0000080B 89F0                    	mov	eax, esi
  1025 0000080D 0FB6D8                  	movzx	ebx, al
  1026 00000810 88DA                    	mov	dl, bl
  1027 00000812 80E30F                  	and	bl, 0Fh
  1028 00000815 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1029 0000081B A2[99220000]            	mov	[msgVendorId+3], al
  1030 00000820 88D3                    	mov	bl, dl
  1031 00000822 C0EB04                  	shr	bl, 4
  1032 00000825 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1033 0000082B A2[98220000]            	mov	[msgVendorId+2], al
  1034 00000830 88E3                    	mov	bl, ah
  1035 00000832 88DA                    	mov	dl, bl
  1036 00000834 80E30F                  	and	bl, 0Fh
  1037 00000837 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1038 0000083D A2[97220000]            	mov	[msgVendorId+1], al
  1039 00000842 88D3                    	mov	bl, dl
  1040 00000844 C0EB04                  	shr	bl, 4
  1041 00000847 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1042 0000084D A2[96220000]            	mov	[msgVendorId], al
  1043 00000852 C1E810                  	shr	eax, 16
  1044 00000855 88C3                    	mov	bl, al
  1045 00000857 88DA                    	mov	dl, bl
  1046 00000859 80E30F                  	and	bl, 0Fh
  1047 0000085C 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1048 00000862 A2[AA220000]            	mov	[msgDevId+3], al
  1049 00000867 88D3                    	mov	bl, dl
  1050 00000869 C0EB04                  	shr	bl, 4
  1051 0000086C 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1052 00000872 A2[A9220000]            	mov	[msgDevId+2], al
  1053 00000877 88E3                    	mov	bl, ah
  1054 00000879 88DA                    	mov	dl, bl
  1055 0000087B 80E30F                  	and	bl, 0Fh
  1056 0000087E 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1057 00000884 A2[A8220000]            	mov	[msgDevId+1], al
  1058 00000889 88D3                    	mov	bl, dl
  1059 0000088B C0EB04                  	shr	bl, 4
  1060 0000088E 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1061 00000894 A2[A7220000]            	mov	[msgDevId], al
  1062                                  
  1063 00000899 8B35[C1230000]          	mov	esi, [bus_dev_fn]
  1064 0000089F C1EE08                  	shr	esi, 8
  1065 000008A2 6689F0                  	mov	ax, si
  1066 000008A5 88C3                    	mov	bl, al
  1067 000008A7 88DA                    	mov	dl, bl
  1068 000008A9 80E307                  	and	bl, 7 ; bit 0,1,2
  1069 000008AC 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1070 000008B2 A2[CE220000]            	mov	[msgFncNo+1], al
  1071 000008B7 88D3                    	mov	bl, dl
  1072 000008B9 C0EB03                  	shr	bl, 3
  1073 000008BC 88DA                    	mov	dl, bl
  1074 000008BE 80E30F                  	and	bl, 0Fh
  1075 000008C1 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1076 000008C7 A2[C0220000]            	mov	[msgDevNo+1], al
  1077 000008CC 88D3                    	mov	bl, dl
  1078 000008CE C0EB04                  	shr	bl, 4
  1079 000008D1 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1080 000008D7 A2[BF220000]            	mov	[msgDevNo], al
  1081 000008DC 88E3                    	mov	bl, ah
  1082 000008DE 88DA                    	mov	dl, bl
  1083 000008E0 80E30F                  	and	bl, 0Fh
  1084 000008E3 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1085 000008E9 A2[B4220000]            	mov	[msgBusNo+1], al
  1086 000008EE 88D3                    	mov	bl, dl
  1087 000008F0 C0EB04                  	shr	bl, 4
  1088 000008F3 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1089 000008F9 A2[B3220000]            	mov	[msgBusNo], al
  1090                                  
  1091 000008FE 66A1[C5230000]          	mov	ax, [ac97_NamBar]
  1092 00000904 88C3                    	mov	bl, al
  1093 00000906 88DA                    	mov	dl, bl
  1094 00000908 80E30F                  	and	bl, 0Fh
  1095 0000090B 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1096 00000911 A2[DD220000]            	mov	[msgNamBar+3], al
  1097 00000916 88D3                    	mov	bl, dl
  1098 00000918 C0EB04                  	shr	bl, 4
  1099 0000091B 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1100 00000921 A2[DC220000]            	mov	[msgNamBar+2], al
  1101 00000926 88E3                    	mov	bl, ah
  1102 00000928 88DA                    	mov	dl, bl
  1103 0000092A 80E30F                  	and	bl, 0Fh
  1104 0000092D 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1105 00000933 A2[DB220000]            	mov	[msgNamBar+1], al
  1106 00000938 88D3                    	mov	bl, dl
  1107 0000093A C0EB04                  	shr	bl, 4
  1108 0000093D 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1109 00000943 A2[DA220000]            	mov	[msgNamBar], al
  1110                                  
  1111 00000948 66A1[C7230000]          	mov	ax, [ac97_NabmBar]
  1112 0000094E 88C3                    	mov	bl, al
  1113 00000950 88DA                    	mov	dl, bl
  1114 00000952 80E30F                  	and	bl, 0Fh
  1115 00000955 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1116 0000095B A2[ED220000]            	mov	[msgNabmBar+3], al
  1117 00000960 88D3                    	mov	bl, dl
  1118 00000962 C0EB04                  	shr	bl, 4
  1119 00000965 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1120 0000096B A2[EC220000]            	mov	[msgNabmBar+2], al
  1121 00000970 88E3                    	mov	bl, ah
  1122 00000972 88DA                    	mov	dl, bl
  1123 00000974 80E30F                  	and	bl, 0Fh
  1124 00000977 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1125 0000097D A2[EB220000]            	mov	[msgNabmBar+1], al
  1126 00000982 88D3                    	mov	bl, dl
  1127 00000984 C0EB04                  	shr	bl, 4
  1128 00000987 8A83[54220000]          	mov	al, [ebx+hex_chars]
  1129 0000098D A2[EA220000]            	mov	[msgNabmBar], al
  1130                                  
  1131 00000992 30E4                    	xor	ah, ah
  1132 00000994 A0[BB230000]            	mov	al, [ac97_int_ln_reg]
  1133 00000999 B10A                    	mov	cl, 10
  1134 0000099B F6F1                    	div	cl
  1135 0000099D 660105[F6220000]        	add	[msgIRQ], ax
  1136 000009A4 20C0                    	and	al, al
  1137 000009A6 750D                    	jnz	short _w_ac97imsg_
  1138 000009A8 A0[F7220000]            	mov	al, [msgIRQ+1]
  1139 000009AD B420                    	mov	ah, ' '
  1140 000009AF 66A3[F6220000]          	mov	[msgIRQ], ax
  1141                                  _w_ac97imsg_:
  1142                                  	sys	_msg, msgAC97Info, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009B5 BB[65220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009BA B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009BF BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000009C4 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000009C9 CD40                <1>  int 40h
  1143                                  
  1144 000009CB C3                              retn
  1145                                  
  1146                                  write_VRA_info:
  1147                                  	; 25/11/2023
  1148                                  	sys	_msg, msgVRAheader, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009CC BB[FB220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009D1 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009D6 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000009DB B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000009E0 CD40                <1>  int 40h
  1149 000009E2 803D[4C230000]00        	cmp	byte [VRA], 0
  1150 000009E9 7617                    	jna	short _w_VRAi_no
  1151                                  _w_VRAi_yes:
  1152                                  	sys	_msg, msgVRAyes, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009EB BB[09230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009F0 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009F5 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000009FA B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000009FF CD40                <1>  int 40h
  1153 00000A01 C3                      	retn
  1154                                  _w_VRAi_no:
  1155                                  	sys	_msg, msgVRAno, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000A02 BB[0F230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000A07 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000A0C BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000A11 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000A16 CD40                <1>  int 40h
  1156 00000A18 C3                      	retn
  1157                                  
  1158                                  ; 26/11/2023
  1159                                  ; 25/11/2023 - playwav6.s (32 bit registers, TRDOS 386 adaption)
  1160                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  1161                                  ; 14/11/2023
  1162                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1163                                  ; --------------------------------------------------------
  1164                                  
  1165                                  ;;Note:	At the end of every buffer load,
  1166                                  ;;	during buffer switch/swap, there will be discontinuity
  1167                                  ;;	between the last converted sample and the 1st sample
  1168                                  ;;	of the next buffer.
  1169                                  ;;	(like as a dot noises vaguely between normal sound samples)
  1170                                  ;;	-To avoid this defect, the 1st sample of
  1171                                  ;;	the next buffer may be read from the wav file but
  1172                                  ;;	the file pointer would need to be set to 1 sample back
  1173                                  ;;	again via seek system call. Time comsumption problem! -
  1174                                  ;;
  1175                                  ;;	Erdogan Tan - 15/11/2023
  1176                                  ;;
  1177                                  ;;	((If entire wav data would be loaded at once.. conversion
  1178                                  ;;	defect/noise would disappear.. but for DOS, to keep
  1179                                  ;;	64KB buffer limit is important also it is important
  1180                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1181                                  ;;	I have tested this program by using 2-30MB wav files.))
  1182                                  ;;
  1183                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1184                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1185                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1186                                  ;;			Realtek ALC850 codec.
  1187                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1188                                  
  1189                                  load_8khz_mono_8_bit:
  1190                                  	; 15/11/2023
  1191                                  	; 14/11/2023
  1192                                  	; 13/11/2023
  1193 00000A19 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1194                                  					; last of the file?
  1195 00000A20 7402                    	jz	short lff8m_0		; no
  1196 00000A22 F9                      	stc
  1197 00000A23 C3                      	retn
  1198                                  
  1199                                  lff8m_0:
  1200 00000A24 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1201                                          ;mov	edx, [loadsize]
  1202                                  
  1203                                  	; esi = buffer address
  1204                                  	;; edx = buffer size
  1205                                  
  1206                                  	; load file into memory
  1207                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000A29 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000A2F 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000A31 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000A37 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000A3C CD40                <1>  int 40h
  1208 00000A3E 7305                    	jnc	short lff8m_6
  1209 00000A40 E9AF000000              	jmp	lff8m_5  ; error !
  1210                                  
  1211                                  lff8m_6:
  1212 00000A45 BF[00300000]            	mov	edi, audio_buffer
  1213 00000A4A 21C0                    	and	eax, eax
  1214 00000A4C 0F8499000000            	jz	lff8_eof
  1215                                  
  1216 00000A52 89C1                    	mov	ecx, eax		; byte count
  1217                                  lff8m_1:
  1218 00000A54 AC                      	lodsb
  1219 00000A55 A2[62200000]            	mov	[previous_val], al
  1220 00000A5A 2C80                    	sub	al, 80h
  1221 00000A5C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1222 00000A60 66AB                    	stosw		; original sample (left channel)
  1223 00000A62 66AB                    	stosw		; original sample (right channel)
  1224                                  	;xor	eax, eax
  1225 00000A64 B080                    	mov	al, 80h
  1226 00000A66 49                      	dec	ecx
  1227 00000A67 7402                    	jz	short lff8m_2
  1228 00000A69 8A06                    	mov	al, [esi]
  1229                                  lff8m_2:
  1230                                  	;mov	[next_val], ax
  1231 00000A6B 88C7                    	mov	bh, al	; [next_val]
  1232 00000A6D 8A25[62200000]          	mov	ah, [previous_val]
  1233 00000A73 00E0                    	add	al, ah	; [previous_val]
  1234 00000A75 D0D8                    	rcr	al, 1
  1235 00000A77 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  1236 00000A79 00E0                    	add	al, ah	; [previous_val]
  1237 00000A7B D0D8                    	rcr	al, 1	
  1238 00000A7D 88C3                    	mov	bl, al 	; this is temporary interpolation value	
  1239 00000A7F 00E0                    	add	al, ah	; [previous_val]
  1240 00000A81 D0D8                    	rcr	al, 1
  1241 00000A83 2C80                    	sub	al, 80h
  1242 00000A85 66C1E008                	shl	ax, 8	
  1243 00000A89 66AB                    	stosw		; this is 1st interpolated sample (L)
  1244 00000A8B 66AB                    	stosw		; this is 1st interpolated sample (R)
  1245 00000A8D 88D8                    	mov	al, bl
  1246 00000A8F 00D0                    	add	al, dl
  1247 00000A91 D0D8                    	rcr	al, 1
  1248 00000A93 2C80                    	sub	al, 80h
  1249 00000A95 66C1E008                	shl	ax, 8
  1250 00000A99 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1251 00000A9B 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1252 00000A9D 88D0                    	mov	al, dl
  1253 00000A9F 2C80                    	sub	al, 80h
  1254 00000AA1 66C1E008                	shl	ax, 8
  1255 00000AA5 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1256 00000AA7 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1257                                  	;mov	al, [next_val]
  1258 00000AA9 88F8                    	mov	al, bh
  1259 00000AAB 00D0                    	add	al, dl
  1260 00000AAD D0D8                    	rcr	al, 1
  1261 00000AAF 88C3                    	mov	bl, al	; this is temporary interpolation value
  1262 00000AB1 00D0                    	add	al, dl
  1263 00000AB3 D0D8                    	rcr	al, 1
  1264 00000AB5 2C80                    	sub	al, 80h
  1265 00000AB7 66C1E008                	shl	ax, 8
  1266 00000ABB 66AB                    	stosw		; this is 4th interpolated sample (L)
  1267 00000ABD 66AB                    	stosw		; this is 4th interpolated sample (R)
  1268                                  	;mov	al, [next_val]
  1269 00000ABF 88F8                    	mov	al, bh
  1270 00000AC1 00D8                    	add	al, bl
  1271 00000AC3 D0D8                    	rcr	al, 1
  1272 00000AC5 2C80                    	sub	al, 80h
  1273 00000AC7 66C1E008                	shl	ax, 8
  1274 00000ACB 66AB                    	stosw		; this is 5th interpolated sample (L)
  1275 00000ACD 66AB                    	stosw		; this is 5th interpolated sample (R)
  1276                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1277 00000ACF 09C9                    	or	ecx, ecx
  1278 00000AD1 7581                    	jnz	short lff8m_1
  1279                                  
  1280                                  	; --------------
  1281                                  
  1282                                  lff8s_3:
  1283                                  lff8m_3:
  1284                                  lff8s2_3:
  1285                                  lff8m2_3:
  1286                                  lff16s_3:
  1287                                  lff16m_3:
  1288                                  lff16s2_3:
  1289                                  lff16m2_3:
  1290                                  lff24_3:
  1291                                  lff32_3:
  1292                                  lff44_3:
  1293                                  lff22_3:
  1294                                  lff11_3:
  1295                                  	; 08/12/2024 (BugFix)
  1296                                  	; 01/06/2024 (BugFix)
  1297 00000AD3 8B0D[D1030000]          	mov	ecx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1298                                  	;shl	ecx, 1	; byte count ; Bug !
  1299                                  	; 08/12/2024
  1300 00000AD9 81C1[00300000]          	add	ecx, audio_buffer
  1301 00000ADF 29F9                    	sub	ecx, edi
  1302 00000AE1 7607                    	jna	short lff8m_4
  1303                                  	;inc	ecx
  1304 00000AE3 C1E902                  	shr	ecx, 2
  1305 00000AE6 31C0                    	xor	eax, eax ; fill (remain part of) buffer with zeros	
  1306 00000AE8 F3AB                    	rep	stosd
  1307                                  lff8m_4:
  1308                                  	; 01/06/2024 (BugFix)
  1309                                  	; cf=1 ; Bug !
  1310                                  	; 08/12/2024
  1311                                  	;clc
  1312 00000AEA C3                      	retn
  1313                                  
  1314                                  lff8_eof:
  1315                                  lff16_eof:
  1316                                  lff24_eof:
  1317                                  lff32_eof:
  1318                                  lff44_eof:
  1319                                  lff22_eof:
  1320                                  lff11_eof:
  1321                                  	; 15/11/2023
  1322 00000AEB C605[48230000]01        	mov	byte [flags], ENDOFFILE
  1323 00000AF2 EBDF                    	jmp	short lff8m_3
  1324                                  
  1325                                  lff8s_5:
  1326                                  lff8m_5:
  1327                                  lff8s2_5:
  1328                                  lff8m2_5:
  1329                                  lff16s_5:
  1330                                  lff16m_5:
  1331                                  lff16s2_5:
  1332                                  lff16m2_5:
  1333                                  lff24_5:
  1334                                  lff32_5:
  1335                                  lff44_5:
  1336                                  lff22_5:
  1337                                  lff11_5:
  1338 00000AF4 B021                    	mov	al, '!'  ; error
  1339 00000AF6 E883FAFFFF              	call	tL0
  1340                                  	
  1341                                  	;jmp	short lff8m_3
  1342                                  	; 15/11/2023
  1343 00000AFB EBEE                    	jmp	lff8_eof
  1344                                  
  1345                                  	; --------------
  1346                                  
  1347                                  load_8khz_stereo_8_bit:
  1348                                  	; 15/11/2023
  1349                                  	; 14/11/2023
  1350                                  	; 13/11/2023
  1351 00000AFD F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1352                                  					; last of the file?
  1353 00000B04 7402                    	jz	short lff8s_0		; no
  1354 00000B06 F9                      	stc
  1355 00000B07 C3                      	retn
  1356                                  
  1357                                  lff8s_0:
  1358 00000B08 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1359                                          ;mov	edx, [loadsize]
  1360                                  
  1361                                  	; esi = buffer address
  1362                                  	;; edx = buffer size
  1363                                  
  1364                                  	; load file into memory
  1365                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000B0D 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000B13 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000B15 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000B1B B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000B20 CD40                <1>  int 40h
  1366 00000B22 72D0                    	jc	short lff8s_5 ; error !
  1367                                  
  1368 00000B24 BF[00300000]            	mov	edi, audio_buffer
  1369                                  	
  1370 00000B29 D1E8                    	shr	eax, 1
  1371 00000B2B 74BE                    	jz	short lff8_eof
  1372                                  
  1373 00000B2D 89C1                    	mov	ecx, eax	; word count
  1374                                  lff8s_1:
  1375 00000B2F AC                      	lodsb
  1376 00000B30 A2[62200000]            	mov	[previous_val_l], al
  1377 00000B35 2C80                    	sub	al, 80h
  1378 00000B37 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1379 00000B3B 66AB                    	stosw		; original sample (L)
  1380 00000B3D AC                      	lodsb
  1381 00000B3E A2[64200000]            	mov	[previous_val_r], al
  1382 00000B43 2C80                    	sub	al, 80h
  1383 00000B45 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1384 00000B49 66AB                    	stosw		; original sample (R)
  1385                                  
  1386                                  	;xor	eax, eax
  1387 00000B4B 66B88080                	mov	ax, 8080h
  1388 00000B4F 49                      	dec	ecx
  1389 00000B50 7403                    	jz	short lff8s_2
  1390                                  		; convert 8 bit sample to 16 bit sample
  1391 00000B52 668B06                  	mov	ax, [esi]
  1392                                  lff8s_2:
  1393 00000B55 A2[66200000]            	mov	[next_val_l], al
  1394 00000B5A 8825[68200000]          	mov	[next_val_r], ah
  1395 00000B60 8A25[62200000]          	mov	ah, [previous_val_l]
  1396 00000B66 00E0                    	add	al, ah
  1397 00000B68 D0D8                    	rcr	al, 1
  1398 00000B6A 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1399 00000B6C 00E0                    	add	al, ah
  1400 00000B6E D0D8                    	rcr	al, 1	
  1401 00000B70 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1402 00000B72 00E0                    	add	al, ah
  1403 00000B74 D0D8                    	rcr	al, 1
  1404 00000B76 2C80                    	sub	al, 80h
  1405 00000B78 66C1E008                	shl	ax, 8
  1406 00000B7C 66AB                    	stosw		; this is 1st interpolated sample (L)
  1407 00000B7E A0[68200000]            	mov	al, [next_val_r]
  1408 00000B83 8A25[64200000]          	mov	ah, [previous_val_r]
  1409 00000B89 00E0                    	add	al, ah
  1410 00000B8B D0D8                    	rcr	al, 1
  1411 00000B8D 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1412 00000B8F 00E0                    	add	al, ah
  1413 00000B91 D0D8                    	rcr	al, 1
  1414 00000B93 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1415 00000B95 00E0                    	add	al, ah
  1416 00000B97 D0D8                    	rcr	al, 1
  1417 00000B99 2C80                    	sub	al, 80h
  1418 00000B9B 66C1E008                	shl	ax, 8
  1419 00000B9F 66AB                    	stosw		; this is 1st interpolated sample (R)
  1420 00000BA1 88D8                    	mov	al, bl
  1421 00000BA3 00D0                    	add	al, dl
  1422 00000BA5 D0D8                    	rcr	al, 1
  1423 00000BA7 2C80                    	sub	al, 80h
  1424 00000BA9 66C1E008                	shl	ax, 8
  1425 00000BAD 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1426 00000BAF 88F8                    	mov	al, bh
  1427 00000BB1 00F0                    	add	al, dh
  1428 00000BB3 D0D8                    	rcr	al, 1
  1429 00000BB5 2C80                    	sub	al, 80h
  1430 00000BB7 66C1E008                	shl	ax, 8
  1431 00000BBB 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1432 00000BBD 88D0                    	mov	al, dl
  1433 00000BBF 2C80                    	sub	al, 80h
  1434 00000BC1 66C1E008                	shl	ax, 8
  1435 00000BC5 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1436 00000BC7 88F0                    	mov	al, dh
  1437 00000BC9 2C80                    	sub	al, 80h
  1438 00000BCB 66C1E008                	shl	ax, 8
  1439 00000BCF 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1440 00000BD1 A0[66200000]            	mov	al, [next_val_l]
  1441 00000BD6 00D0                    	add	al, dl
  1442 00000BD8 D0D8                    	rcr	al, 1
  1443 00000BDA 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1444 00000BDC 00D0                    	add	al, dl
  1445 00000BDE D0D8                    	rcr	al, 1
  1446 00000BE0 2C80                    	sub	al, 80h
  1447 00000BE2 66C1E008                	shl	ax, 8
  1448 00000BE6 66AB                    	stosw		; this is 4th interpolated sample (L)
  1449 00000BE8 A0[68200000]            	mov	al, [next_val_r]
  1450 00000BED 00F0                    	add	al, dh
  1451 00000BEF D0D8                    	rcr	al, 1
  1452 00000BF1 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1453 00000BF3 00F0                    	add	al, dh
  1454 00000BF5 D0D8                    	rcr	al, 1
  1455 00000BF7 2C80                    	sub	al, 80h
  1456 00000BF9 66C1E008                	shl	ax, 8
  1457 00000BFD 66AB                    	stosw		; this is 4th interpolated sample (R)
  1458 00000BFF A0[66200000]            	mov	al, [next_val_l]
  1459 00000C04 00D8                    	add	al, bl
  1460 00000C06 D0D8                    	rcr	al, 1
  1461 00000C08 2C80                    	sub	al, 80h
  1462 00000C0A 66C1E008                	shl	ax, 8
  1463 00000C0E 66AB                    	stosw		; this is 5th interpolated sample (L)
  1464 00000C10 A0[68200000]            	mov	al, [next_val_r]
  1465 00000C15 00F8                    	add	al, bh
  1466 00000C17 D0D8                    	rcr	al, 1
  1467 00000C19 2C80                    	sub	al, 80h
  1468 00000C1B 66C1E008                	shl	ax, 8
  1469 00000C1F 66AB                    	stosw		; this is 5th interpolated sample (R)
  1470                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1471 00000C21 E305                    	jecxz	lff8s_6
  1472 00000C23 E907FFFFFF              	jmp	lff8s_1
  1473                                  lff8s_6:
  1474 00000C28 E9A6FEFFFF              	jmp	lff8s_3
  1475                                  
  1476                                  load_8khz_mono_16_bit:
  1477                                  	; 13/11/2023
  1478 00000C2D F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1479                                  					; last of the file?
  1480 00000C34 7402                    	jz	short lff8m2_0		; no
  1481 00000C36 F9                      	stc
  1482 00000C37 C3                      	retn
  1483                                  
  1484                                  lff8m2_0:
  1485 00000C38 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1486                                          ;mov	edx, [loadsize]
  1487                                  
  1488                                  	; esi = buffer address
  1489                                  	;; edx = buffer size
  1490                                  
  1491                                  	; load file into memory
  1492                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000C3D 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000C43 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000C45 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000C4B B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000C50 CD40                <1>  int 40h
  1493 00000C52 0F82A0000000            	jc	lff8m2_7 ; error !
  1494                                  
  1495 00000C58 BF[00300000]            	mov	edi, audio_buffer
  1496                                  	
  1497 00000C5D D1E8                    	shr	eax, 1
  1498 00000C5F 7505                    	jnz	short lff8m2_8
  1499 00000C61 E985FEFFFF              	jmp	lff8_eof
  1500                                  
  1501                                  lff8m2_8:
  1502 00000C66 89C1                    	mov	ecx, eax	; word count
  1503                                  lff8m2_1:
  1504 00000C68 66AD                    	lodsw
  1505 00000C6A 66AB                    	stosw		; original sample (left channel)
  1506 00000C6C 66AB                    	stosw		; original sample (right channel)
  1507 00000C6E 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1508 00000C71 66A3[62200000]          	mov	[previous_val], ax
  1509 00000C77 31C0                    	xor	eax, eax
  1510 00000C79 49                      	dec	ecx
  1511 00000C7A 7403                    	jz	short lff8m2_2
  1512 00000C7C 668B06                  	mov	ax, [esi]
  1513                                  lff8m2_2:
  1514 00000C7F 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  1515 00000C82 89C5                    	mov	ebp, eax	; [next_val]
  1516 00000C84 660305[62200000]        	add	ax, [previous_val]
  1517 00000C8B 66D1D8                  	rcr	ax, 1
  1518 00000C8E 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample
  1519 00000C90 660305[62200000]        	add	ax, [previous_val]
  1520 00000C97 66D1D8                  	rcr	ax, 1	; this is temporary interpolation value
  1521 00000C9A 89C3                    	mov	ebx, eax 		
  1522 00000C9C 660305[62200000]        	add	ax, [previous_val]
  1523 00000CA3 66D1D8                  	rcr	ax, 1
  1524 00000CA6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1525 00000CA9 66AB                    	stosw		; this is 1st interpolated sample (L)
  1526 00000CAB 66AB                    	stosw		; this is 1st interpolated sample (R)
  1527 00000CAD 89D8                    	mov	eax, ebx
  1528 00000CAF 6601D0                  	add	ax, dx
  1529 00000CB2 66D1D8                  	rcr	ax, 1
  1530 00000CB5 80EC80                  	sub	ah, 80h
  1531 00000CB8 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1532 00000CBA 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1533 00000CBC 89D0                    	mov	eax, edx
  1534 00000CBE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1535 00000CC1 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1536 00000CC3 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1537 00000CC5 89E8                    	mov	eax, ebp
  1538 00000CC7 6601D0                  	add	ax, dx
  1539 00000CCA 66D1D8                  	rcr	ax, 1
  1540 00000CCD 89C3                    	mov	ebx, eax ; this is temporary interpolation value
  1541 00000CCF 6601D0                  	add	ax, dx
  1542 00000CD2 66D1D8                  	rcr	ax, 1
  1543 00000CD5 80EC80                  	sub	ah, 80h
  1544 00000CD8 66AB                    	stosw		; this is 4th interpolated sample (L)
  1545 00000CDA 66AB                    	stosw		; this is 4th interpolated sample (R)
  1546 00000CDC 89E8                    	mov	eax, ebp
  1547 00000CDE 6601D8                  	add	ax, bx
  1548 00000CE1 66D1D8                  	rcr	ax, 1
  1549 00000CE4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1550 00000CE7 66AB                    	stosw		; this is 5th interpolated sample (L)
  1551 00000CE9 66AB                    	stosw		; this is 5th interpolated sample (R)
  1552                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1553 00000CEB 09C9                    	or	ecx, ecx
  1554 00000CED 0F8575FFFFFF            	jnz	lff8m2_1
  1555 00000CF3 E9DBFDFFFF              	jmp	lff8m2_3
  1556                                  
  1557                                  lff8m2_7:
  1558                                  lff8s2_7:
  1559 00000CF8 E9F7FDFFFF              	jmp	lff8m2_5  ; error
  1560                                  
  1561                                  load_8khz_stereo_16_bit:
  1562                                  	; 16/11/2023
  1563                                  	; 15/11/2023
  1564                                  	; 13/11/2023
  1565 00000CFD F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1566                                  					; last of the file?
  1567 00000D04 7402                    	jz	short lff8s2_0		; no
  1568 00000D06 F9                      	stc
  1569 00000D07 C3                      	retn
  1570                                  
  1571                                  lff8s2_0:
  1572 00000D08 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1573                                          ;mov	edx, [loadsize]
  1574                                  
  1575                                  	; esi = buffer address
  1576                                  	;; edx = buffer size
  1577                                  
  1578                                  	; load file into memory
  1579                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000D0D 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000D13 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000D15 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000D1B B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000D20 CD40                <1>  int 40h
  1580 00000D22 72D4                    	jc	short lff8s2_7 ; error !
  1581                                  
  1582 00000D24 BF[00300000]            	mov	edi, audio_buffer
  1583                                  	
  1584 00000D29 C1E802                  	shr	eax, 2
  1585 00000D2C 7505                    	jnz	short lff8s2_8
  1586 00000D2E E9B8FDFFFF              	jmp	lff8_eof
  1587                                  
  1588                                  lff8s2_8:
  1589 00000D33 89C1                    	mov	ecx, eax ; dword count
  1590                                  lff8s2_1:
  1591 00000D35 66AD                    	lodsw
  1592 00000D37 66AB                    	stosw		; original sample (L)
  1593                                  	; 15/11/2023
  1594 00000D39 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1595 00000D3C 66A3[62200000]          	mov	[previous_val_l], ax
  1596 00000D42 66AD                    	lodsw
  1597 00000D44 66AB                    	stosw		; original sample (R)
  1598 00000D46 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1599 00000D49 66A3[64200000]          	mov	[previous_val_r], ax
  1600 00000D4F 31D2                    	xor	edx, edx
  1601 00000D51 31C0                    	xor	eax, eax
  1602                                  	; 16/11/2023
  1603 00000D53 49                      	dec	ecx
  1604 00000D54 7407                    	jz	short lff8s2_2
  1605 00000D56 668B06                  	mov	ax, [esi]
  1606 00000D59 668B5602                	mov	dx, [esi+2]
  1607                                  lff8s2_2:
  1608 00000D5D 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1609 00000D60 66A3[66200000]          	mov	[next_val_l], ax
  1610 00000D66 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  1611 00000D69 668915[68200000]        	mov	[next_val_r], dx
  1612 00000D70 660305[62200000]        	add	ax, [previous_val_l]
  1613 00000D77 66D1D8                  	rcr	ax, 1
  1614 00000D7A 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample (L)
  1615 00000D7C 660305[62200000]        	add	ax, [previous_val_l]
  1616 00000D83 66D1D8                  	rcr	ax, 1	
  1617 00000D86 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1618 00000D88 660305[62200000]        	add	ax, [previous_val_l]
  1619 00000D8F 66D1D8                  	rcr	ax, 1
  1620 00000D92 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1621 00000D95 66AB                    	stosw		; this is 1st interpolated sample (L)
  1622 00000D97 66A1[68200000]          	mov	ax, [next_val_r]
  1623 00000D9D 660305[64200000]        	add	ax, [previous_val_r]
  1624 00000DA4 66D1D8                  	rcr	ax, 1
  1625 00000DA7 89C5                    	mov	ebp, eax ; this is interpolated middle (3th) sample (R)
  1626 00000DA9 660305[64200000]        	add	ax, [previous_val_r]
  1627 00000DB0 66D1D8                  	rcr	ax, 1
  1628 00000DB3 50                      	push	eax ; *	; this is temporary interpolation value (R)
  1629 00000DB4 660305[64200000]        	add	ax, [previous_val_r]
  1630 00000DBB 66D1D8                  	rcr	ax, 1
  1631 00000DBE 80EC80                  	sub	ah, 80h
  1632 00000DC1 66AB                    	stosw		; this is 1st interpolated sample (R)
  1633 00000DC3 89D8                    	mov	eax, ebx
  1634 00000DC5 6601D0                  	add	ax, dx
  1635 00000DC8 66D1D8                  	rcr	ax, 1
  1636 00000DCB 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1637 00000DCE 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1638 00000DD0 58                      	pop	eax ; *
  1639 00000DD1 6601E8                  	add	ax, bp
  1640 00000DD4 66D1D8                  	rcr	ax, 1
  1641 00000DD7 80EC80                  	sub	ah, 80h
  1642 00000DDA 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1643 00000DDC 89D0                    	mov	eax, edx
  1644 00000DDE 80EC80                  	sub	ah, 80h
  1645 00000DE1 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1646 00000DE3 89E8                    	mov	eax, ebp
  1647 00000DE5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1648 00000DE8 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1649 00000DEA 66A1[66200000]          	mov	ax, [next_val_l]
  1650 00000DF0 6601D0                  	add	ax, dx
  1651 00000DF3 66D1D8                  	rcr	ax, 1
  1652 00000DF6 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1653 00000DF8 6601D0                  	add	ax, dx
  1654 00000DFB 66D1D8                  	rcr	ax, 1
  1655 00000DFE 80EC80                  	sub	ah, 80h
  1656 00000E01 66AB                    	stosw		; this is 4th interpolated sample (L)
  1657 00000E03 66A1[68200000]          	mov	ax, [next_val_r]
  1658 00000E09 6601E8                  	add	ax, bp
  1659 00000E0C 66D1D8                  	rcr	ax, 1
  1660 00000E0F 50                      	push	eax ; ** ; this is temporary interpolation value (R)
  1661 00000E10 6601E8                  	add	ax, bp
  1662 00000E13 66D1D8                  	rcr	ax, 1
  1663 00000E16 80EC80                  	sub	ah, 80h
  1664 00000E19 66AB                    	stosw		; this is 4th interpolated sample (R)
  1665 00000E1B 66A1[66200000]          	mov	ax, [next_val_l]
  1666 00000E21 6601D8                  	add	ax, bx
  1667 00000E24 66D1D8                  	rcr	ax, 1
  1668 00000E27 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1669 00000E2A 66AB                    	stosw		; this is 5th interpolated sample (L)
  1670 00000E2C 58                      	pop	eax ; **
  1671 00000E2D 660305[68200000]        	add	ax, [next_val_r]
  1672 00000E34 66D1D8                  	rcr	ax, 1
  1673 00000E37 80EC80                  	sub	ah, 80h
  1674 00000E3A 66AB                    	stosw		; this is 5th interpolated sample (R)
  1675                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1676 00000E3C E305                    	jecxz	lff8_s2_9
  1677 00000E3E E9F2FEFFFF              	jmp	lff8s2_1
  1678                                  lff8_s2_9:
  1679 00000E43 E98BFCFFFF              	jmp	lff8s2_3
  1680                                  
  1681                                  ; .....................
  1682                                  
  1683                                  load_16khz_mono_8_bit:
  1684                                  	; 14/11/2023
  1685                                  	; 13/11/2023
  1686 00000E48 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1687                                  					; last of the file?
  1688 00000E4F 7402                    	jz	short lff16m_0		; no
  1689 00000E51 F9                      	stc
  1690 00000E52 C3                      	retn
  1691                                  
  1692                                  lff16m_0:
  1693 00000E53 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1694                                          ;mov	edx, [loadsize]
  1695                                  
  1696                                  	; esi = buffer address
  1697                                  	;; edx = buffer size
  1698                                  
  1699                                  	; load file into memory
  1700                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000E58 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000E5E 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000E60 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000E66 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000E6B CD40                <1>  int 40h
  1701 00000E6D 7253                    	jc	short lff16m_7 ; error !
  1702                                  
  1703 00000E6F BF[00300000]            	mov	edi, audio_buffer
  1704                                  	
  1705 00000E74 21C0                    	and	eax, eax
  1706 00000E76 7505                    	jnz	short lff16m_8
  1707 00000E78 E96EFCFFFF              	jmp	lff16_eof
  1708                                  
  1709                                  lff16m_8:
  1710 00000E7D 89C1                    	mov	ecx, eax		; byte count
  1711                                  lff16m_1:
  1712 00000E7F AC                      	lodsb
  1713                                  	;mov	[previous_val], al
  1714 00000E80 88C3                    	mov	bl, al
  1715 00000E82 2C80                    	sub	al, 80h
  1716 00000E84 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1717 00000E88 66AB                    	stosw		; original sample (left channel)
  1718 00000E8A 66AB                    	stosw		; original sample (right channel)
  1719                                  	;xor	ax, ax
  1720                                  	; 14/11/22023
  1721 00000E8C B080                    	mov	al, 80h
  1722 00000E8E 49                      	dec	ecx
  1723 00000E8F 7402                    	jz	short lff16m_2
  1724 00000E91 8A06                    	mov	al, [esi]
  1725                                  lff16m_2:
  1726                                  	;mov	[next_val], al
  1727 00000E93 88C7                    	mov	bh, al
  1728                                  	;add	al, [previous_val]
  1729 00000E95 00D8                    	add	al, bl
  1730 00000E97 D0D8                    	rcr	al, 1
  1731 00000E99 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  1732                                  	;add	al, [previous_val]
  1733 00000E9B 00D8                    	add	al, bl
  1734 00000E9D D0D8                    	rcr	al, 1
  1735 00000E9F 2C80                    	sub	al, 80h
  1736 00000EA1 66C1E008                	shl	ax, 8
  1737 00000EA5 66AB                    	stosw		; this is 1st interpolated sample (L)
  1738 00000EA7 66AB                    	stosw		; this is 1st interpolated sample (R)
  1739                                  	;mov	al, [next_val]
  1740 00000EA9 88F8                    	mov	al, bh
  1741 00000EAB 00D0                    	add	al, dl
  1742 00000EAD D0D8                    	rcr	al, 1
  1743 00000EAF 2C80                    	sub	al, 80h
  1744 00000EB1 66C1E008                	shl	ax, 8
  1745 00000EB5 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1746 00000EB7 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1747                                  	
  1748                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1749 00000EB9 09C9                    	or	ecx, ecx
  1750 00000EBB 75C2                    	jnz	short lff16m_1
  1751 00000EBD E911FCFFFF              	jmp	lff16m_3
  1752                                  
  1753                                  lff16m_7:
  1754                                  lff16s_7:
  1755 00000EC2 E92DFCFFFF              	jmp	lff16m_5  ; error
  1756                                  
  1757                                  load_16khz_stereo_8_bit:
  1758                                  	; 14/11/2023
  1759                                  	; 13/11/2023
  1760 00000EC7 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1761                                  					; last of the file?
  1762 00000ECE 7402                    	jz	short lff16s_0		; no
  1763 00000ED0 F9                      	stc
  1764 00000ED1 C3                      	retn
  1765                                  
  1766                                  lff16s_0:
  1767 00000ED2 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1768                                          ;mov	edx, [loadsize]
  1769                                  
  1770                                  	; esi = buffer address
  1771                                  	;; edx = buffer size
  1772                                  
  1773                                  	; load file into memory
  1774                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000ED7 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000EDD 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000EDF 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000EE5 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000EEA CD40                <1>  int 40h
  1775 00000EEC 72D4                    	jc	short lff16s_7 ; error !
  1776                                  
  1777 00000EEE BF[00300000]            	mov	edi, audio_buffer
  1778                                  	
  1779 00000EF3 D1E8                    	shr	eax, 1
  1780 00000EF5 7505                    	jnz	short lff16s_8
  1781 00000EF7 E9EFFBFFFF              	jmp	lff16_eof
  1782                                  
  1783                                  lff16s_8:
  1784 00000EFC 89C1                    	mov	ecx, eax	; word count
  1785                                  lff16s_1:
  1786 00000EFE AC                      	lodsb
  1787 00000EFF A2[62200000]            	mov	[previous_val_l], al
  1788 00000F04 2C80                    	sub	al, 80h
  1789 00000F06 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1790 00000F0A 66AB                    	stosw		; original sample (L)
  1791 00000F0C AC                      	lodsb
  1792 00000F0D A2[64200000]            	mov	[previous_val_r], al
  1793 00000F12 2C80                    	sub	al, 80h
  1794 00000F14 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1795 00000F18 66AB                    	stosw		; original sample (R)
  1796                                  
  1797                                  	;xor	eax, eax
  1798 00000F1A 66B88080                	mov	ax, 8080h
  1799 00000F1E 49                      	dec	ecx
  1800 00000F1F 7403                    	jz	short lff16s_2
  1801                                  		; convert 8 bit sample to 16 bit sample
  1802 00000F21 668B06                  	mov	ax, [esi]
  1803                                  lff16s_2:
  1804                                  	;mov	[next_val_l], al
  1805                                  	;mov	[next_val_r], ah
  1806 00000F24 89C3                    	mov	ebx, eax
  1807 00000F26 0205[62200000]          	add	al, [previous_val_l]
  1808 00000F2C D0D8                    	rcr	al, 1
  1809 00000F2E 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  1810 00000F30 0205[62200000]          	add	al, [previous_val_l]
  1811 00000F36 D0D8                    	rcr	al, 1
  1812 00000F38 2C80                    	sub	al, 80h
  1813 00000F3A 66C1E008                	shl	ax, 8
  1814 00000F3E 66AB                    	stosw		; this is 1st interpolated sample (L)
  1815 00000F40 88F8                    	mov	al, bh	; [next_val_r]
  1816 00000F42 0205[64200000]          	add	al, [previous_val_r]
  1817 00000F48 D0D8                    	rcr	al, 1
  1818 00000F4A 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  1819 00000F4C 0205[64200000]          	add	al, [previous_val_r]
  1820 00000F52 D0D8                    	rcr	al, 1
  1821 00000F54 2C80                    	sub	al, 80h
  1822 00000F56 66C1E008                	shl	ax, 8
  1823 00000F5A 66AB                    	stosw		; this is 1st interpolated sample (R)
  1824 00000F5C 88D0                    	mov	al, dl
  1825 00000F5E 00D8                    	add	al, bl	; [next_val_l]
  1826 00000F60 D0D8                    	rcr	al, 1
  1827 00000F62 2C80                    	sub	al, 80h
  1828 00000F64 66C1E008                	shl	ax, 8
  1829 00000F68 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1830 00000F6A 88F0                    	mov	al, dh
  1831 00000F6C 00F8                    	add	al, bh	; [next_val_r]
  1832 00000F6E D0D8                    	rcr	al, 1
  1833 00000F70 2C80                    	sub	al, 80h
  1834 00000F72 66C1E008                	shl	ax, 8
  1835 00000F76 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1836                                  	
  1837                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1838 00000F78 09C9                    	or	ecx, ecx
  1839 00000F7A 7582                    	jnz	short lff16s_1
  1840 00000F7C E952FBFFFF              	jmp	lff16s_3
  1841                                  
  1842                                  load_16khz_mono_16_bit:
  1843                                  	; 15/11/2023
  1844                                  	; 13/11/2023
  1845 00000F81 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1846                                  					; last of the file?
  1847 00000F88 7402                    	jz	short lff16m2_0		; no
  1848 00000F8A F9                      	stc
  1849 00000F8B C3                      	retn
  1850                                  
  1851                                  lff16m2_0:
  1852 00000F8C BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1853                                          ;mov	edx, [loadsize]
  1854                                  
  1855                                  	; esi = buffer address
  1856                                  	;; edx = buffer size
  1857                                  
  1858                                  	; load file into memory
  1859                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000F91 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000F97 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000F99 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000F9F B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000FA4 CD40                <1>  int 40h
  1860 00000FA6 7255                    	jc	short lff16m2_7 ; error !
  1861                                  
  1862 00000FA8 BF[00300000]            	mov	edi, audio_buffer
  1863                                  	
  1864 00000FAD D1E8                    	shr	eax, 1
  1865 00000FAF 7505                    	jnz	short lff16m2_8
  1866 00000FB1 E935FBFFFF              	jmp	lff16_eof
  1867                                  
  1868                                  lff16m2_8:
  1869 00000FB6 89C1                    	mov	ecx, eax  ; word count
  1870                                  lff16m2_1:
  1871 00000FB8 66AD                    	lodsw
  1872 00000FBA 66AB                    	stosw		; original sample (left channel)
  1873 00000FBC 66AB                    	stosw		; original sample (right channel)
  1874 00000FBE 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  1875                                  	;mov	[previous_val], ax
  1876 00000FC1 89C3                    	mov	ebx, eax	
  1877 00000FC3 31C0                    	xor	eax, eax
  1878 00000FC5 49                      	dec	ecx
  1879 00000FC6 7403                    	jz	short lff16m2_2
  1880 00000FC8 668B06                  	mov	ax, [esi]
  1881                                  lff16m2_2:
  1882 00000FCB 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  1883 00000FCE 89C5                    	mov	ebp, eax	; [next_val]
  1884                                  	;add	ax, [previous_val]
  1885 00000FD0 6601D8                  	add	ax, bx
  1886 00000FD3 66D1D8                  	rcr	ax, 1
  1887 00000FD6 89C2                    	mov	edx, eax ; this is temporary interpolation value
  1888                                  	;add	ax, [previous_val]
  1889 00000FD8 6601D8                  	add	ax, bx
  1890 00000FDB 66D1D8                  	rcr	ax, 1
  1891 00000FDE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1892 00000FE1 66AB                    	stosw		; this is 1st interpolated sample (L)
  1893 00000FE3 66AB                    	stosw		; this is 1st interpolated sample (R)
  1894 00000FE5 89E8                    	mov	eax, ebp 
  1895 00000FE7 6601D0                  	add	ax, dx
  1896 00000FEA 66D1D8                  	rcr	ax, 1
  1897 00000FED 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1898 00000FF0 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1899 00000FF2 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1900                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1901 00000FF4 09C9                    	or	ecx, ecx
  1902 00000FF6 75C0                    	jnz	short lff16m2_1
  1903 00000FF8 E9D6FAFFFF              	jmp	lff16m2_3
  1904                                  
  1905                                  lff16m2_7:
  1906                                  lff16s2_7:
  1907 00000FFD E9F2FAFFFF              	jmp	lff16m2_5  ; error
  1908                                  
  1909                                  load_16khz_stereo_16_bit:
  1910                                  	; 16/11/2023
  1911                                  	; 15/11/2023
  1912                                  	; 13/11/2023
  1913 00001002 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1914                                  					; last of the file?
  1915 00001009 7402                    	jz	short lff16s2_0		; no
  1916 0000100B F9                      	stc
  1917 0000100C C3                      	retn
  1918                                  
  1919                                  lff16s2_0:
  1920 0000100D BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1921                                          ;mov	edx, [loadsize]
  1922                                  
  1923                                  	; esi = buffer address
  1924                                  	;; edx = buffer size
  1925                                  
  1926                                  	; load file into memory
  1927                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001012 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001018 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000101A 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001020 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001025 CD40                <1>  int 40h
  1928 00001027 72D4                    	jc	short lff16s2_7 ; error !
  1929                                  
  1930 00001029 BF[00300000]            	mov	edi, audio_buffer
  1931                                  	
  1932 0000102E C1E802                  	shr	eax, 2
  1933 00001031 7505                    	jnz	short lff16s2_8
  1934 00001033 E9B3FAFFFF              	jmp	lff16_eof
  1935                                  
  1936                                  lff16s2_8:
  1937 00001038 89C1                    	mov	ecx, eax  ; dword count
  1938                                  lff16s2_1:
  1939 0000103A 66AD                    	lodsw
  1940 0000103C 66AB                    	stosw		; original sample (L)
  1941 0000103E 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  1942 00001041 66A3[62200000]          	mov	[previous_val_l], ax
  1943 00001047 66AD                    	lodsw
  1944 00001049 66AB                    	stosw		; original sample (R)
  1945 0000104B 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  1946 0000104E 66A3[64200000]          	mov	[previous_val_r], ax
  1947 00001054 31D2                    	xor	edx, edx
  1948 00001056 31C0                    	xor	eax, eax
  1949                                  	; 16/11/2023
  1950 00001058 49                      	dec	ecx
  1951 00001059 7407                    	jz	short lff16s2_2
  1952 0000105B 668B06                  	mov	ax, [esi]
  1953 0000105E 668B5602                	mov	dx, [esi+2]
  1954                                  lff16s2_2:
  1955 00001062 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  1956                                  	;mov	[next_val_l], ax
  1957 00001065 89C5                    	mov	ebp, eax
  1958 00001067 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  1959 0000106A 668915[68200000]        	mov	[next_val_r], dx
  1960 00001071 660305[62200000]        	add	ax, [previous_val_l]
  1961 00001078 66D1D8                  	rcr	ax, 1
  1962 0000107B 89C2                    	mov	edx, eax ; this is temporary interpolation value (L)
  1963 0000107D 660305[62200000]        	add	ax, [previous_val_l]
  1964 00001084 66D1D8                  	rcr	ax, 1
  1965 00001087 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  1966 0000108A 66AB                    	stosw		; this is 1st interpolated sample (L)
  1967 0000108C 66A1[68200000]          	mov	ax, [next_val_r]
  1968 00001092 660305[64200000]        	add	ax, [previous_val_r]
  1969 00001099 66D1D8                  	rcr	ax, 1
  1970 0000109C 89C3                    	mov	ebx, eax ; this is temporary interpolation value (R)
  1971 0000109E 660305[64200000]        	add	ax, [previous_val_r]
  1972 000010A5 66D1D8                  	rcr	ax, 1
  1973 000010A8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1974 000010AB 66AB                    	stosw		; this is 1st interpolated sample (R)
  1975                                  	;mov	ax, [next_val_l]
  1976 000010AD 89E8                    	mov	eax, ebp
  1977 000010AF 6601D0                  	add	ax, dx
  1978 000010B2 66D1D8                  	rcr	ax, 1
  1979 000010B5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1980 000010B8 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1981 000010BA 66A1[68200000]          	mov	ax, [next_val_r]
  1982 000010C0 6601D8                  	add	ax, bx
  1983 000010C3 66D1D8                  	rcr	ax, 1
  1984 000010C6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1985 000010C9 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1986                                  	
  1987                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1988 000010CB 09C9                    	or	ecx, ecx
  1989 000010CD 0F8567FFFFFF            	jnz	lff16s2_1
  1990 000010D3 E9FBF9FFFF              	jmp	lff16s2_3
  1991                                  
  1992                                  ; .....................
  1993                                  
  1994                                  load_24khz_mono_8_bit:
  1995                                  	; 15/11/2023
  1996 000010D8 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1997                                  					; last of the file?
  1998 000010DF 7402                    	jz	short lff24m_0		; no
  1999 000010E1 F9                      	stc
  2000 000010E2 C3                      	retn
  2001                                  
  2002                                  lff24m_0:
  2003 000010E3 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2004                                          ;mov	edx, [loadsize]
  2005                                  
  2006                                  	; esi = buffer address
  2007                                  	;; edx = buffer size
  2008                                  
  2009                                  	; load file into memory
  2010                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000010E8 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000010EE 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000010F0 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000010F6 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000010FB CD40                <1>  int 40h
  2011 000010FD 723B                    	jc	short lff24m_7 ; error !
  2012                                  
  2013 000010FF BF[00300000]            	mov	edi, audio_buffer
  2014                                  	
  2015 00001104 21C0                    	and	eax, eax
  2016 00001106 7505                    	jnz	short lff24m_8
  2017 00001108 E9DEF9FFFF              	jmp	lff24_eof
  2018                                  
  2019                                  lff24m_8:
  2020 0000110D 89C1                    	mov	ecx, eax	; byte count
  2021                                  lff24m_1:
  2022 0000110F AC                      	lodsb
  2023                                  	;mov	[previous_val], al
  2024 00001110 88C3                    	mov	bl, al
  2025 00001112 2C80                    	sub	al, 80h
  2026 00001114 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2027 00001118 66AB                    	stosw		; original sample (left channel)
  2028 0000111A 66AB                    	stosw		; original sample (right channel)
  2029                                  	;xor	eax, eax
  2030 0000111C B080                    	mov	al, 80h
  2031 0000111E 49                      	dec	ecx
  2032 0000111F 7402                    	jz	short lff24m_2
  2033 00001121 8A06                    	mov	al, [esi]
  2034                                  lff24m_2:
  2035                                  	;;mov	[next_val], al
  2036                                  	;mov	bh, al
  2037                                  	;add	al, [previous_val]
  2038 00001123 00D8                    	add	al, bl
  2039 00001125 D0D8                    	rcr	al, 1
  2040 00001127 2C80                    	sub	al, 80h
  2041 00001129 66C1E008                	shl	ax, 8
  2042 0000112D 66AB                    	stosw		; this is interpolated sample (L)
  2043 0000112F 66AB                    	stosw		; this is interpolated sample (R)
  2044                                  	
  2045                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2046 00001131 09C9                    	or	ecx, ecx
  2047 00001133 75DA                    	jnz	short lff24m_1
  2048 00001135 E999F9FFFF              	jmp	lff24_3
  2049                                  
  2050                                  lff24m_7:
  2051                                  lff24s_7:
  2052 0000113A E9B5F9FFFF              	jmp	lff24_5  ; error
  2053                                  
  2054                                  load_24khz_stereo_8_bit:
  2055                                  	; 15/11/2023
  2056 0000113F F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2057                                  					; last of the file?
  2058 00001146 7402                    	jz	short lff24s_0		; no
  2059 00001148 F9                      	stc
  2060 00001149 C3                      	retn
  2061                                  
  2062                                  lff24s_0:
  2063 0000114A BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2064                                          ;mov	edx, [loadsize]
  2065                                  
  2066                                  	; esi = buffer address
  2067                                  	;; edx = buffer size
  2068                                  
  2069                                  	; load file into memory
  2070                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000114F 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001155 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001157 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000115D B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001162 CD40                <1>  int 40h
  2071 00001164 72D4                    	jc	short lff24s_7 ; error !
  2072                                  
  2073 00001166 BF[00300000]            	mov	edi, audio_buffer
  2074                                  	
  2075 0000116B D1E8                    	shr	eax, 1
  2076 0000116D 7505                    	jnz	short lff24s_8
  2077 0000116F E977F9FFFF              	jmp	lff24_eof
  2078                                  
  2079                                  lff24s_8:
  2080 00001174 89C1                    	mov	ecx, eax  ; word count
  2081                                  lff24s_1:
  2082 00001176 AC                      	lodsb
  2083 00001177 A2[62200000]            	mov	[previous_val_l], al
  2084 0000117C 2C80                    	sub	al, 80h
  2085 0000117E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2086 00001182 66AB                    	stosw		; original sample (L)
  2087 00001184 AC                      	lodsb
  2088 00001185 A2[64200000]            	mov	[previous_val_r], al
  2089 0000118A 2C80                    	sub	al, 80h
  2090 0000118C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2091 00001190 66AB                    	stosw		; original sample (R)
  2092                                  
  2093                                  	;xor	eax, eax
  2094 00001192 66B88080                	mov	ax, 8080h
  2095 00001196 49                      	dec	ecx
  2096 00001197 7403                    	jz	short lff24s_2
  2097                                  		; convert 8 bit sample to 16 bit sample
  2098 00001199 668B06                  	mov	ax, [esi]
  2099                                  lff24s_2:
  2100                                  	;;mov	[next_val_l], al
  2101                                  	;;mov	[next_val_r], ah
  2102                                  	;mov	bx, ax
  2103 0000119C 88E7                    	mov	bh, ah
  2104 0000119E 0205[62200000]          	add	al, [previous_val_l]
  2105 000011A4 D0D8                    	rcr	al, 1
  2106                                  	;mov	dl, al
  2107 000011A6 2C80                    	sub	al, 80h
  2108 000011A8 66C1E008                	shl	ax, 8
  2109 000011AC 66AB                    	stosw		; this is interpolated sample (L)
  2110 000011AE 88F8                    	mov	al, bh	; [next_val_r]
  2111 000011B0 0205[64200000]          	add	al, [previous_val_r]
  2112 000011B6 D0D8                    	rcr	al, 1
  2113                                  	;mov	dh, al
  2114 000011B8 2C80                    	sub	al, 80h
  2115 000011BA 66C1E008                	shl	ax, 8
  2116 000011BE 66AB                    	stosw		; this is interpolated sample (R)
  2117                                  		
  2118                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2119 000011C0 09C9                    	or	ecx, ecx
  2120 000011C2 75B2                    	jnz	short lff24s_1
  2121 000011C4 E90AF9FFFF              	jmp	lff24_3
  2122                                  
  2123                                  load_24khz_mono_16_bit:
  2124                                  	; 15/11/2023
  2125 000011C9 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2126                                  					; last of the file?
  2127 000011D0 7402                    	jz	short lff24m2_0		; no
  2128 000011D2 F9                      	stc
  2129 000011D3 C3                      	retn
  2130                                  
  2131                                  lff24m2_0:
  2132 000011D4 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2133                                          ;mov	edx, [loadsize]
  2134                                  
  2135                                  	; esi = buffer address
  2136                                  	;; edx = buffer size
  2137                                  
  2138                                  	; load file into memory
  2139                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000011D9 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000011DF 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000011E1 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000011E7 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000011EC CD40                <1>  int 40h
  2140 000011EE 7237                    	jc	short lff24m2_7 ; error !
  2141                                  
  2142 000011F0 BF[00300000]            	mov	edi, audio_buffer
  2143                                  	
  2144 000011F5 D1E8                    	shr	eax, 1
  2145 000011F7 7505                    	jnz	short lff24m2_8
  2146 000011F9 E9EDF8FFFF              	jmp	lff24_eof
  2147                                  
  2148                                  lff24m2_8:
  2149 000011FE 89C1                    	mov	ecx, eax  ; word count
  2150                                  lff24m2_1:
  2151 00001200 66AD                    	lodsw
  2152 00001202 66AB                    	stosw		; original sample (left channel)
  2153 00001204 66AB                    	stosw		; original sample (right channel)
  2154 00001206 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2155                                  	;mov	[previous_val], ax
  2156                                  	;mov	ebx, eax	
  2157                                  	;xor	eax, eax
  2158 00001209 31DB                    	xor	ebx, ebx
  2159 0000120B 49                      	dec	ecx
  2160 0000120C 7403                    	jz	short lff24m2_2
  2161                                  	;mov	ax, [esi]
  2162 0000120E 668B1E                  	mov	bx, [esi]
  2163                                  lff24m2_2:
  2164                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2165                                  	;mov	ebp, eax	; [next_val]
  2166                                  	;add	ax, [previous_val]
  2167                                  	; ax = [previous_val]
  2168                                  	; bx = [next_val]
  2169 00001211 6601D8                  	add	ax, bx
  2170 00001214 66D1D8                  	rcr	ax, 1
  2171 00001217 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2172 0000121A 66AB                    	stosw		; this is interpolated sample (L)
  2173 0000121C 66AB                    	stosw		; this is interpolated sample (R)
  2174                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2175 0000121E 09C9                    	or	ecx, ecx
  2176 00001220 75DE                    	jnz	short lff24m2_1
  2177 00001222 E9ACF8FFFF              	jmp	lff24_3
  2178                                  
  2179                                  lff24m2_7:
  2180                                  lff24s2_7:
  2181 00001227 E9C8F8FFFF              	jmp	lff24_5  ; error
  2182                                  
  2183                                  load_24khz_stereo_16_bit:
  2184                                  	; 16/11/2023
  2185                                  	; 15/11/2023
  2186 0000122C F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2187                                  					; last of the file?
  2188 00001233 7402                    	jz	short lff24s2_0		; no
  2189 00001235 F9                      	stc
  2190 00001236 C3                      	retn
  2191                                  
  2192                                  lff24s2_0:
  2193 00001237 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2194                                          ;mov	edx, [loadsize]
  2195                                  
  2196                                  	; esi = buffer address
  2197                                  	;; edx = buffer size
  2198                                  
  2199                                  	; load file into memory
  2200                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000123C 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001242 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001244 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000124A B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000124F CD40                <1>  int 40h
  2201 00001251 72D4                    	jc	short lff24s2_7 ; error !
  2202                                  
  2203 00001253 BF[00300000]            	mov	edi, audio_buffer
  2204                                  	
  2205 00001258 C1E802                  	shr	eax, 2
  2206 0000125B 7505                    	jnz	short lff24s2_8
  2207 0000125D E989F8FFFF              	jmp	lff24_eof
  2208                                  
  2209                                  lff24s2_8:
  2210 00001262 89C1                    	mov	ecx, eax  ; dword count
  2211                                  lff24s2_1:
  2212 00001264 66AD                    	lodsw
  2213 00001266 66AB                    	stosw		; original sample (L)
  2214 00001268 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2215 0000126B 66A3[62200000]          	mov	[previous_val_l], ax
  2216 00001271 66AD                    	lodsw
  2217 00001273 66AB                    	stosw		; original sample (R)
  2218 00001275 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2219                                  	;mov	[previous_val_r], ax
  2220 00001278 89C3                    	mov	ebx, eax
  2221 0000127A 31D2                    	xor	edx, edx
  2222 0000127C 31C0                    	xor	eax, eax
  2223                                  	; 16/11/2023
  2224 0000127E 49                      	dec	ecx
  2225 0000127F 7407                    	jz	short lff24s2_2
  2226 00001281 668B06                  	mov	ax, [esi]
  2227 00001284 668B5602                	mov	dx, [esi+2]
  2228                                  lff24s2_2:
  2229 00001288 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2230                                  	;;mov	[next_val_l], ax
  2231                                  	;mov	ebp, eax
  2232 0000128B 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2233                                  	;mov	[next_val_r], dx
  2234 0000128E 660305[62200000]        	add	ax, [previous_val_l]
  2235 00001295 66D1D8                  	rcr	ax, 1
  2236 00001298 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2237 0000129B 66AB                    	stosw		; this is interpolated sample (L)
  2238                                  	;mov	ax, [next_val_r]
  2239 0000129D 89D0                    	mov	eax, edx
  2240                                  	;add	ax, [previous_val_r]
  2241 0000129F 6601D8                  	add	ax, bx
  2242 000012A2 66D1D8                  	rcr	ax, 1
  2243 000012A5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2244 000012A8 66AB                    	stosw		; this is interpolated sample (R)
  2245                                  	
  2246                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2247 000012AA 09C9                    	or	ecx, ecx
  2248 000012AC 75B6                    	jnz	short lff24s2_1
  2249 000012AE E920F8FFFF              	jmp	lff24_3
  2250                                  
  2251                                  ; .....................
  2252                                  
  2253                                  load_32khz_mono_8_bit:
  2254                                  	; 15/11/2023
  2255 000012B3 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2256                                  					; last of the file?
  2257 000012BA 7402                    	jz	short lff32m_0		; no
  2258 000012BC F9                      	stc
  2259 000012BD C3                      	retn
  2260                                  
  2261                                  lff32m_0:
  2262 000012BE BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2263                                          ;mov	edx, [loadsize]
  2264                                  
  2265                                  	; esi = buffer address
  2266                                  	;; edx = buffer size
  2267                                  
  2268                                  	; load file into memory
  2269                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000012C3 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000012C9 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000012CB 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000012D1 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000012D6 CD40                <1>  int 40h
  2270 000012D8 7247                    	jc	short lff32m_7 ; error !
  2271                                  
  2272 000012DA BF[00300000]            	mov	edi, audio_buffer
  2273                                  	
  2274 000012DF 21C0                    	and	eax, eax
  2275 000012E1 7505                    	jnz	short lff32m_8
  2276 000012E3 E903F8FFFF              	jmp	lff32_eof
  2277                                  
  2278                                  lff32m_8:
  2279 000012E8 89C1                    	mov	ecx, eax	; byte count
  2280                                  lff32m_1:
  2281 000012EA AC                      	lodsb
  2282                                  	;mov	[previous_val], al
  2283 000012EB 88C3                    	mov	bl, al
  2284 000012ED 2C80                    	sub	al, 80h
  2285 000012EF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2286 000012F3 66AB                    	stosw		; original sample (left channel)
  2287 000012F5 66AB                    	stosw		; original sample (right channel)
  2288                                  	;xor	eax, eax
  2289 000012F7 B080                    	mov	al, 80h
  2290 000012F9 49                      	dec	ecx
  2291 000012FA 7402                    	jz	short lff32m_2
  2292 000012FC 8A06                    	mov	al, [esi]
  2293                                  lff32m_2:
  2294                                  	;;mov	[next_val], al
  2295                                  	;mov	bh, al
  2296                                  	;add	al, [previous_val]
  2297 000012FE 00D8                    	add	al, bl
  2298 00001300 D0D8                    	rcr	al, 1
  2299 00001302 2C80                    	sub	al, 80h
  2300 00001304 66C1E008                	shl	ax, 8
  2301 00001308 66AB                    	stosw		; this is interpolated sample (L)
  2302 0000130A 66AB                    	stosw		; this is interpolated sample (R)
  2303                                  	
  2304                                  	; different than 8-16-24 kHZ !
  2305                                  	; 'original-interpolated-original' trio samples 
  2306 0000130C E30E                    	jecxz	lff32m_3
  2307                                  
  2308 0000130E AC                      	lodsb
  2309 0000130F 2C80                    	sub	al, 80h
  2310 00001311 66C1E008                	shl	ax, 8
  2311 00001315 66AB                    	stosw		; original sample (left channel)
  2312 00001317 66AB                    	stosw		; original sample (right channel)
  2313                                  
  2314                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2315 00001319 49                      	dec	ecx
  2316 0000131A 75CE                    	jnz	short lff32m_1
  2317                                  lff32m_3:
  2318 0000131C E9B2F7FFFF              	jmp	lff32_3
  2319                                  
  2320                                  lff32m_7:
  2321                                  lff32s_7:
  2322 00001321 E9CEF7FFFF              	jmp	lff32_5  ; error
  2323                                  
  2324                                  load_32khz_stereo_8_bit:
  2325                                  	; 15/11/2023
  2326 00001326 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2327                                  					; last of the file?
  2328 0000132D 7402                    	jz	short lff32s_0		; no
  2329 0000132F F9                      	stc
  2330 00001330 C3                      	retn
  2331                                  
  2332                                  lff32s_0:
  2333 00001331 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2334                                          ;mov	edx, [loadsize]
  2335                                  
  2336                                  	; esi = buffer address
  2337                                  	;; edx = buffer size
  2338                                  
  2339                                  	; load file into memory
  2340                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001336 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000133C 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000133E 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001344 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001349 CD40                <1>  int 40h
  2341 0000134B 72D4                    	jc	short lff32s_7 ; error !
  2342                                  
  2343 0000134D BF[00300000]            	mov	edi, audio_buffer
  2344                                  	
  2345 00001352 D1E8                    	shr	eax, 1
  2346 00001354 7505                    	jnz	short lff32s_8
  2347 00001356 E990F7FFFF              	jmp	lff32_eof
  2348                                  
  2349                                  lff32s_8:
  2350 0000135B 89C1                    	mov	ecx, eax  ; word count
  2351                                  lff32s_1:
  2352 0000135D AC                      	lodsb
  2353 0000135E A2[62200000]            	mov	[previous_val_l], al
  2354 00001363 2C80                    	sub	al, 80h
  2355 00001365 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2356 00001369 66AB                    	stosw		; original sample (L)
  2357 0000136B AC                      	lodsb
  2358 0000136C A2[64200000]            	mov	[previous_val_r], al
  2359 00001371 2C80                    	sub	al, 80h
  2360 00001373 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2361 00001377 66AB                    	stosw		; original sample (R)
  2362                                  
  2363                                  	;xor	eax, eax
  2364 00001379 66B88080                	mov	ax, 8080h
  2365 0000137D 49                      	dec	ecx
  2366 0000137E 7403                    	jz	short lff32s_2
  2367                                  		; convert 8 bit sample to 16 bit sample
  2368 00001380 668B06                  	mov	ax, [esi]
  2369                                  lff32s_2:
  2370                                  	;;mov	[next_val_l], al
  2371                                  	;;mov	[next_val_r], ah
  2372                                  	;mov	bx, ax
  2373 00001383 88E7                    	mov	bh, ah
  2374 00001385 0205[62200000]          	add	al, [previous_val_l]
  2375 0000138B D0D8                    	rcr	al, 1
  2376                                  	;mov	dl, al
  2377 0000138D 2C80                    	sub	al, 80h
  2378 0000138F 66C1E008                	shl	ax, 8
  2379 00001393 66AB                    	stosw		; this is interpolated sample (L)
  2380 00001395 88F8                    	mov	al, bh	; [next_val_r]
  2381 00001397 0205[64200000]          	add	al, [previous_val_r]
  2382 0000139D D0D8                    	rcr	al, 1
  2383                                  	;mov	dh, al
  2384 0000139F 2C80                    	sub	al, 80h
  2385 000013A1 66C1E008                	shl	ax, 8
  2386 000013A5 66AB                    	stosw		; this is interpolated sample (R)
  2387                                  
  2388                                  	; different than 8-16-24 kHZ !
  2389                                  	; 'original-interpolated-original' trio samples 
  2390 000013A7 E315                    	jecxz	lff32s_3
  2391                                  
  2392 000013A9 AC                      	lodsb
  2393 000013AA 2C80                    	sub	al, 80h
  2394 000013AC 66C1E008                	shl	ax, 8
  2395 000013B0 66AB                    	stosw		; original sample (left channel)
  2396                                  
  2397 000013B2 AC                      	lodsb
  2398 000013B3 2C80                    	sub	al, 80h
  2399 000013B5 66C1E008                	shl	ax, 8
  2400 000013B9 66AB                    	stosw		; original sample (right channel)
  2401                                  		
  2402                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2403 000013BB 49                      	dec	ecx
  2404 000013BC 759F                    	jnz	short lff32s_1
  2405                                  lff32s_3:
  2406 000013BE E910F7FFFF              	jmp	lff32_3
  2407                                  
  2408                                  load_32khz_mono_16_bit:
  2409                                  	; 15/11/2023
  2410 000013C3 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2411                                  					; last of the file?
  2412 000013CA 7402                    	jz	short lff32m2_0		; no
  2413 000013CC F9                      	stc
  2414 000013CD C3                      	retn
  2415                                  
  2416                                  lff32m2_0:
  2417 000013CE BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2418                                          ;mov	edx, [loadsize]
  2419                                  
  2420                                  	; esi = buffer address
  2421                                  	;; edx = buffer size
  2422                                  
  2423                                  	; load file into memory
  2424                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000013D3 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000013D9 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000013DB 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000013E1 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000013E6 CD40                <1>  int 40h
  2425 000013E8 723E                    	jc	short lff32m2_7 ; error !
  2426                                  
  2427 000013EA BF[00300000]            	mov	edi, audio_buffer
  2428                                  	
  2429 000013EF D1E8                    	shr	eax, 1
  2430 000013F1 7505                    	jnz	short lff32m2_8
  2431 000013F3 E9F3F6FFFF              	jmp	lff32_eof
  2432                                  
  2433                                  lff32m2_8:
  2434 000013F8 89C1                    	mov	ecx, eax  ; word count
  2435                                  lff32m2_1:
  2436 000013FA 66AD                    	lodsw
  2437 000013FC 66AB                    	stosw		; original sample (left channel)
  2438 000013FE 66AB                    	stosw		; original sample (right channel)
  2439 00001400 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2440                                  	;mov	[previous_val], ax
  2441                                  	;mov	ebx, eax	
  2442                                  	;xor	eax, eax
  2443 00001403 31DB                    	xor	ebx, ebx
  2444 00001405 49                      	dec	ecx
  2445 00001406 7403                    	jz	short lff32m2_2
  2446                                  	;mov	ax, [esi]
  2447 00001408 668B1E                  	mov	bx, [esi]
  2448                                  lff32m2_2:
  2449                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2450                                  	;mov	ebp, eax	; [next_val]
  2451                                  	;add	ax, [previous_val]
  2452                                  	; ax = [previous_val]
  2453                                  	; bx = [next_val]
  2454 0000140B 6601D8                  	add	ax, bx
  2455 0000140E 66D1D8                  	rcr	ax, 1
  2456 00001411 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2457 00001414 66AB                    	stosw		; this is interpolated sample (L)
  2458 00001416 66AB                    	stosw		; this is interpolated sample (R)
  2459                                  
  2460                                  	; different than 8-16-24 kHZ !
  2461                                  	; 'original-interpolated-original' trio samples 
  2462 00001418 E309                    	jecxz	lff32m2_3
  2463                                  
  2464 0000141A 66AD                    	lodsw
  2465 0000141C 66AB                    	stosw		; original sample (left channel)
  2466 0000141E 66AB                    	stosw		; original sample (right channel)
  2467                                  
  2468                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2469 00001420 49                      	dec	ecx
  2470 00001421 75D7                    	jnz	short lff32m2_1
  2471                                  lff32m2_3:
  2472 00001423 E9ABF6FFFF              	jmp	lff32_3
  2473                                  
  2474                                  lff32m2_7:
  2475                                  lff32s2_7:
  2476 00001428 E9C7F6FFFF              	jmp	lff32_5  ; error
  2477                                  
  2478                                  load_32khz_stereo_16_bit:
  2479                                  	; 16/11/2023
  2480                                  	; 15/11/2023
  2481 0000142D F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2482                                  					; last of the file?
  2483 00001434 7402                    	jz	short lff32s2_0		; no
  2484 00001436 F9                      	stc
  2485 00001437 C3                      	retn
  2486                                  
  2487                                  lff32s2_0:
  2488 00001438 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2489                                          ;mov	edx, [loadsize]
  2490                                  
  2491                                  	; esi = buffer address
  2492                                  	;; edx = buffer size
  2493                                  
  2494                                  	; load file into memory
  2495                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000143D 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001443 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001445 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000144B B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001450 CD40                <1>  int 40h
  2496 00001452 72D4                    	jc	short lff32s2_7 ; error !
  2497                                  
  2498 00001454 BF[00300000]            	mov	edi, audio_buffer
  2499                                  	
  2500 00001459 C1E802                  	shr	eax, 2
  2501 0000145C 7505                    	jnz	short lff32s2_8
  2502 0000145E E988F6FFFF              	jmp	lff32_eof
  2503                                  
  2504                                  lff32s2_8:
  2505 00001463 89C1                    	mov	ecx, eax ; dword count
  2506                                  lff32s2_1:
  2507 00001465 66AD                    	lodsw
  2508 00001467 66AB                    	stosw		; original sample (L)
  2509 00001469 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2510 0000146C 66A3[62200000]          	mov	[previous_val_l], ax
  2511 00001472 66AD                    	lodsw
  2512 00001474 66AB                    	stosw		; original sample (R)
  2513 00001476 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2514                                  	;mov	[previous_val_r], ax
  2515 00001479 89C3                    	mov	ebx, eax
  2516 0000147B 31D2                    	xor	edx, edx
  2517 0000147D 31C0                    	xor	eax, eax
  2518                                  	; 16/11/2023
  2519 0000147F 49                      	dec	ecx
  2520 00001480 7407                    	jz	short lff32s2_2
  2521 00001482 668B06                  	mov	ax, [esi]
  2522 00001485 668B5602                	mov	dx, [esi+2]
  2523                                  lff32s2_2:
  2524 00001489 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2525                                  	;;mov	[next_val_l], ax
  2526                                  	;mov	ebp, eax
  2527 0000148C 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2528                                  	;mov	[next_val_r], dx
  2529 0000148F 660305[62200000]        	add	ax, [previous_val_l]
  2530 00001496 66D1D8                  	rcr	ax, 1
  2531 00001499 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2532 0000149C 66AB                    	stosw		; this is interpolated sample (L)
  2533                                  	;mov	ax, [next_val_r]
  2534 0000149E 89D0                    	mov	eax, edx
  2535                                  	;add	ax, [previous_val_r]
  2536 000014A0 6601D8                  	add	ax, bx
  2537 000014A3 66D1D8                  	rcr	ax, 1
  2538 000014A6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2539 000014A9 66AB                    	stosw		; this is interpolated sample (R)
  2540                                  
  2541                                  	; different than 8-16-24 kHZ !
  2542                                  	; 'original-interpolated-original' trio samples 
  2543 000014AB E30B                    	jecxz	lff32s2_3
  2544                                  
  2545 000014AD 66AD                    	lodsw
  2546 000014AF 66AB                    	stosw	; original sample (L)
  2547 000014B1 66AD                    	lodsw
  2548 000014B3 66AB                    	stosw	; original sample (R)
  2549                                  	
  2550                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2551 000014B5 49                      	dec	ecx
  2552 000014B6 75AD                    	jnz	short lff32s2_1
  2553                                  lff32s2_3:
  2554 000014B8 E916F6FFFF              	jmp	lff32_3
  2555                                  
  2556                                  ; .....................
  2557                                  
  2558                                  load_22khz_mono_8_bit:
  2559                                  	; 16/11/2023
  2560 000014BD F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2561                                  					; last of the file?
  2562 000014C4 7402                    	jz	short lff22m_0		; no
  2563 000014C6 F9                      	stc
  2564 000014C7 C3                      	retn
  2565                                  
  2566                                  lff22m_0:
  2567 000014C8 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2568                                          ;mov	edx, [loadsize]
  2569                                  
  2570                                  	; esi = buffer address
  2571                                  	;; edx = buffer size
  2572                                  
  2573                                  	; load file into memory
  2574                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000014CD 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000014D3 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000014D5 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000014DB B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000014E0 CD40                <1>  int 40h
  2575 000014E2 725D                    	jc	short lff22m_7 ; error !
  2576                                  
  2577 000014E4 BF[00300000]            	mov	edi, audio_buffer
  2578                                  	
  2579 000014E9 21C0                    	and	eax, eax
  2580 000014EB 7505                    	jnz	short lff22m_8
  2581 000014ED E9F9F5FFFF              	jmp	lff22_eof
  2582                                  
  2583                                  lff22m_8:
  2584 000014F2 89C1                    	mov	ecx, eax	; byte count
  2585                                  lff22m_9:
  2586 000014F4 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2587 000014F9 C605[6A200000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2588                                  lff22m_1:
  2589                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2590 00001500 AC                      	lodsb
  2591 00001501 B280                    	mov	dl, 80h
  2592 00001503 49                      	dec	ecx
  2593 00001504 7402                    	jz	short lff22m_2_1
  2594 00001506 8A16                    	mov	dl, [esi]
  2595                                  lff22m_2_1:	
  2596                                  	; al = [previous_val]
  2597                                  	; dl = [next_val]
  2598 00001508 E80F060000              	call	interpolating_3_8bit_mono ; 1 of 17
  2599 0000150D E32D                    	jecxz	lff22m_3
  2600                                  lff22m_2_2:
  2601 0000150F AC                      	lodsb
  2602 00001510 B280                    	mov	dl, 80h
  2603 00001512 49                      	dec	ecx
  2604 00001513 7402                    	jz	short lff22m_2_3
  2605 00001515 8A16                    	mov	dl, [esi]
  2606                                  lff22m_2_3:
  2607 00001517 E884060000               	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2608 0000151C E31E                    	jecxz	lff22m_3
  2609 0000151E 4D                      	dec	ebp
  2610 0000151F 75EE                    	jnz	short lff22m_2_2
  2611                                  
  2612 00001521 A0[6A200000]            	mov	al, [faz]
  2613 00001526 FEC8                    	dec	al
  2614 00001528 74CA                    	jz	short lff22m_9
  2615 0000152A FE0D[6A200000]          	dec	byte [faz]
  2616 00001530 BD04000000              	mov	ebp, 4
  2617 00001535 FEC8                    	dec	al
  2618 00001537 75C7                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2619 00001539 45                      	inc	ebp ; 5
  2620 0000153A EBC4                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2621                                  
  2622                                  lff22m_3:
  2623                                  lff22s_3:
  2624 0000153C E992F5FFFF              	jmp	lff22_3	; padfill
  2625                                  		; (put zeros in the remain words of the buffer)
  2626                                  lff22m_7:
  2627                                  lff22s_7:
  2628 00001541 E9AEF5FFFF              	jmp	lff22_5  ; error
  2629                                  
  2630                                  load_22khz_stereo_8_bit:
  2631                                  	; 16/11/2023
  2632 00001546 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2633                                  					; last of the file?
  2634 0000154D 7402                    	jz	short lff22s_0		; no
  2635 0000154F F9                      	stc
  2636 00001550 C3                      	retn
  2637                                  
  2638                                  lff22s_0:
  2639 00001551 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2640                                          ;mov	edx, [loadsize]
  2641                                  
  2642                                  	; esi = buffer address
  2643                                  	;; edx = buffer size
  2644                                  
  2645                                  	; load file into memory
  2646                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001556 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000155C 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000155E 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001564 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001569 CD40                <1>  int 40h
  2647 0000156B 72D4                    	jc	short lff22s_7 ; error !
  2648                                  
  2649 0000156D BF[00300000]            	mov	edi, audio_buffer
  2650                                  	
  2651 00001572 D1E8                    	shr	eax, 1
  2652 00001574 7505                    	jnz	short lff22s_8
  2653 00001576 E970F5FFFF              	jmp	lff22_eof
  2654                                  
  2655                                  lff22s_8:
  2656 0000157B 89C1                    	mov	ecx, eax	; word count
  2657                                  lff22s_9:
  2658 0000157D BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2659 00001582 C605[6A200000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2660                                  lff22s_1:
  2661                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2662 00001589 66AD                    	lodsw
  2663 0000158B 66BA8080                	mov	dx, 8080h
  2664 0000158F 49                      	dec	ecx
  2665 00001590 7403                    	jz	short lff22s_2_1 
  2666 00001592 668B16                  	mov	dx, [esi]
  2667                                  lff22s_2_1:	
  2668                                  	; al = [previous_val_l]
  2669                                  	; ah = [previous_val_r]
  2670                                  	; dl = [next_val_l]
  2671                                  	; dh = [next_val_r]	
  2672 00001595 E8B3050000              	call	interpolating_3_8bit_stereo ; 1 of 17 
  2673 0000159A E3A0                    	jecxz	lff22s_3
  2674                                  lff22s_2_2:
  2675 0000159C 66AD                    	lodsw
  2676 0000159E 66BA8080                	mov	dx, 8080h
  2677 000015A2 49                      	dec	ecx
  2678 000015A3 7403                    	jz	short lff22s_2_3
  2679 000015A5 668B16                  	mov	dx, [esi]
  2680                                  lff22s_2_3:
  2681 000015A8 E810060000               	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2682 000015AD E38D                    	jecxz	lff22s_3
  2683 000015AF 4D                      	dec	ebp
  2684 000015B0 75EA                    	jnz	short lff22s_2_2
  2685                                  
  2686 000015B2 A0[6A200000]            	mov	al, [faz]
  2687 000015B7 FEC8                    	dec	al
  2688 000015B9 74C2                    	jz	short lff22s_9
  2689 000015BB FE0D[6A200000]          	dec	byte [faz]
  2690 000015C1 BD04000000              	mov	ebp, 4
  2691 000015C6 FEC8                    	dec	al
  2692 000015C8 75BF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2693 000015CA 45                      	inc	ebp ; 5
  2694 000015CB EBBC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2695                                  
  2696                                  load_22khz_mono_16_bit:
  2697                                  	; 16/11/2023
  2698 000015CD F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2699                                  					; last of the file?
  2700 000015D4 7402                    	jz	short lff22m2_0		; no
  2701 000015D6 F9                      	stc
  2702 000015D7 C3                      	retn
  2703                                  
  2704                                  lff22m2_0:
  2705 000015D8 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2706                                          ;mov	edx, [loadsize]
  2707                                  
  2708                                  	; esi = buffer address
  2709                                  	;; edx = buffer size
  2710                                  
  2711                                  	; load file into memory
  2712                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000015DD 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000015E3 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000015E5 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000015EB B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000015F0 CD40                <1>  int 40h
  2713 000015F2 7261                    	jc	short lff22m2_7 ; error !
  2714                                  
  2715 000015F4 BF[00300000]            	mov	edi, audio_buffer
  2716                                  	
  2717 000015F9 D1E8                    	shr	eax, 1
  2718 000015FB 7505                    	jnz	short lff22m2_8
  2719 000015FD E9E9F4FFFF              	jmp	lff22_eof
  2720                                  
  2721                                  lff22m2_8:
  2722 00001602 89C1                    	mov	ecx, eax	; word count
  2723                                  lff22m2_9:
  2724 00001604 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2725 00001609 C605[6A200000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2726                                  lff22m2_1:
  2727                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2728 00001610 66AD                    	lodsw
  2729 00001612 31D2                    	xor	edx, edx
  2730 00001614 49                      	dec	ecx
  2731 00001615 7403                    	jz	short lff22m2_2_1
  2732 00001617 668B16                  	mov	dx, [esi]
  2733                                  lff22m2_2_1:	
  2734                                  	; ax = [previous_val]
  2735                                  	; dx = [next_val]
  2736 0000161A E8CF050000              	call	interpolating_3_16bit_mono ; 1 of 17
  2737 0000161F E32F                    	jecxz	lff22m2_3
  2738                                  lff22m2_2_2:
  2739 00001621 66AD                    	lodsw
  2740 00001623 31D2                    	xor	edx, edx
  2741 00001625 49                      	dec	ecx
  2742 00001626 7403                    	jz	short lff22m2_2_3
  2743 00001628 668B16                  	mov	dx, [esi]
  2744                                  lff22m2_2_3:
  2745 0000162B E851060000               	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2746 00001630 E31E                    	jecxz	lff22m2_3
  2747 00001632 4D                      	dec	ebp
  2748 00001633 75EC                    	jnz	short lff22m2_2_2
  2749                                  
  2750 00001635 A0[6A200000]            	mov	al, [faz]
  2751 0000163A FEC8                    	dec	al
  2752 0000163C 74C6                    	jz	short lff22m2_9
  2753 0000163E FE0D[6A200000]          	dec	byte [faz]
  2754 00001644 BD04000000              	mov	ebp, 4
  2755 00001649 FEC8                    	dec	al
  2756 0000164B 75C3                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2757 0000164D 45                      	inc	ebp ; 5
  2758 0000164E EBC0                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2759                                  
  2760                                  lff22m2_3:
  2761                                  lff22s2_3:
  2762 00001650 E97EF4FFFF              	jmp	lff22_3	; padfill
  2763                                  		; (put zeros in the remain words of the buffer)
  2764                                  lff22m2_7:
  2765                                  lff22s2_7:
  2766 00001655 E99AF4FFFF              	jmp	lff22_5  ; error
  2767                                  
  2768                                  load_22khz_stereo_16_bit:
  2769                                  	; 16/11/2023
  2770 0000165A F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2771                                  					; last of the file?
  2772 00001661 7402                    	jz	short lff22s2_0		; no
  2773 00001663 F9                      	stc
  2774 00001664 C3                      	retn
  2775                                  
  2776                                  lff22s2_0:
  2777 00001665 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2778                                          ;mov	edx, [loadsize]
  2779                                  
  2780                                  	; esi = buffer address
  2781                                  	;; edx = buffer size
  2782                                  
  2783                                  	; load file into memory
  2784                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000166A 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001670 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001672 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001678 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000167D CD40                <1>  int 40h
  2785 0000167F 72D4                    	jc	short lff22s2_7 ; error !
  2786                                  
  2787 00001681 BF[00300000]            	mov	edi, audio_buffer
  2788                                  	
  2789 00001686 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  2790 00001689 7505                    	jnz	short lff22s2_8
  2791 0000168B E95BF4FFFF              	jmp	lff22_eof
  2792                                  
  2793                                  lff22s2_8:
  2794 00001690 89C1                    	mov	ecx, eax	; dword count
  2795                                  lff22s2_9:
  2796 00001692 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2797 00001697 C605[6A200000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2798                                  lff22s2_1:
  2799                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2800 0000169E 66AD                    	lodsw
  2801 000016A0 89C3                    	mov	ebx, eax
  2802 000016A2 66AD                    	lodsw
  2803 000016A4 8B16                    	mov	edx, [esi]
  2804 000016A6 668915[66200000]        	mov	[next_val_l], dx
  2805                                  	; 26/11/2023
  2806 000016AD C1EA10                  	shr	edx, 16
  2807 000016B0 49                      	dec	ecx
  2808 000016B1 7509                    	jnz	short lff22s2_2_1
  2809 000016B3 31D2                    	xor	edx, edx ; 0
  2810 000016B5 668915[66200000]        	mov	[next_val_l], dx
  2811                                  lff22s2_2_1:
  2812                                  	; bx = [previous_val_l]
  2813                                  	; ax = [previous_val_r]
  2814                                  	; [next_val_l]
  2815                                  	; dx = [next_val_r]
  2816 000016BC E85D050000              	call	interpolating_3_16bit_stereo ; 1 of 17 
  2817 000016C1 E38D                    	jecxz	lff22s2_3
  2818                                  lff22s2_2_2:
  2819 000016C3 66AD                    	lodsw
  2820 000016C5 89C3                    	mov	ebx, eax
  2821 000016C7 66AD                    	lodsw
  2822 000016C9 8B16                    	mov	edx, [esi]
  2823 000016CB 668915[66200000]        	mov	[next_val_l], dx
  2824                                  	; 26/11/2023
  2825 000016D2 C1EA10                  	shr	edx, 16
  2826 000016D5 49                      	dec	ecx
  2827 000016D6 7509                    	jnz	short lff22s2_2_3
  2828 000016D8 31D2                    	xor	edx, edx ; 0
  2829 000016DA 668915[66200000]        	mov	[next_val_l], dx
  2830                                  lff22s2_2_3:
  2831 000016E1 E8B3050000               	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  2832 000016E6 E31E                    	jecxz	lff22s2_2_4
  2833                                  
  2834 000016E8 4D                      	dec	ebp
  2835 000016E9 75D8                    	jnz	short lff22s2_2_2
  2836                                  
  2837 000016EB A0[6A200000]            	mov	al, [faz]
  2838 000016F0 FEC8                    	dec	al
  2839 000016F2 749E                    	jz	short lff22s2_9
  2840 000016F4 FE0D[6A200000]          	dec	byte [faz]
  2841 000016FA BD04000000              	mov	ebp, 4
  2842 000016FF FEC8                    	dec	al
  2843 00001701 759B                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2844 00001703 45                      	inc	ebp ; 5
  2845 00001704 EB98                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2846                                  
  2847                                  lff22s2_2_4:
  2848                                  	; 26/11/2023
  2849 00001706 E9C8F3FFFF              	jmp	lff22_3	; padfill
  2850                                  
  2851                                  ; .....................
  2852                                  
  2853                                  load_11khz_mono_8_bit:
  2854                                  	; 18/11/2023
  2855 0000170B F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2856                                  					; last of the file?
  2857 00001712 7402                    	jz	short lff11m_0		; no
  2858 00001714 F9                      	stc
  2859 00001715 C3                      	retn
  2860                                  
  2861                                  lff11m_0:
  2862 00001716 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2863                                          ;mov	edx, [loadsize]
  2864                                  
  2865                                  	; esi = buffer address
  2866                                  	;; edx = buffer size
  2867                                  
  2868                                  	; load file into memory
  2869                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000171B 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001721 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001723 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001729 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000172E CD40                <1>  int 40h
  2870 00001730 7247                    	jc	short lff11m_7 ; error !
  2871                                  
  2872 00001732 BF[00300000]            	mov	edi, audio_buffer
  2873                                  	
  2874 00001737 21C0                    	and	eax, eax
  2875 00001739 7505                    	jnz	short lff11m_8
  2876 0000173B E9ABF3FFFF              	jmp	lff11_eof
  2877                                  
  2878                                  lff11m_8:
  2879 00001740 89C1                    	mov	ecx, eax		; byte count
  2880                                  lff11m_9:
  2881 00001742 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  2882                                  lff11m_1:
  2883                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2884 00001747 AC                      	lodsb
  2885 00001748 B280                    	mov	dl, 80h
  2886 0000174A 49                      	dec	ecx
  2887 0000174B 7402                    	jz	short lff11m_2_1
  2888 0000174D 8A16                    	mov	dl, [esi]
  2889                                  lff11m_2_1:	
  2890                                  	; al = [previous_val]
  2891                                  	; dl = [next_val]
  2892 0000174F E876050000              	call	interpolating_5_8bit_mono
  2893 00001754 E328                    	jecxz	lff11m_3
  2894                                  lff11m_2_2:
  2895 00001756 AC                      	lodsb
  2896 00001757 B280                    	mov	dl, 80h
  2897 00001759 49                      	dec	ecx
  2898 0000175A 7402                    	jz	short lff11m_2_3
  2899 0000175C 8A16                    	mov	dl, [esi]
  2900                                  lff11m_2_3:
  2901 0000175E E873060000               	call	interpolating_4_8bit_mono
  2902 00001763 E319                    	jecxz	lff11m_3
  2903                                  
  2904 00001765 4D                      	dec	ebp
  2905 00001766 74DA                    	jz	short lff11m_9
  2906                                  
  2907 00001768 AC                      	lodsb
  2908 00001769 B280                    	mov	dl, 80h
  2909 0000176B 49                      	dec	ecx
  2910 0000176C 7402                    	jz	short lff11m_2_4
  2911 0000176E 8A16                    	mov	dl, [esi]
  2912                                  lff11m_2_4:
  2913 00001770 E861060000              	call	interpolating_4_8bit_mono
  2914 00001775 E307                    	jecxz	lff11m_3
  2915 00001777 EBCE                    	jmp	short lff11m_1
  2916                                  
  2917                                  lff11m_7:
  2918                                  lff11s_7:
  2919 00001779 E976F3FFFF              	jmp	lff11_5  ; error
  2920                                  
  2921                                  lff11m_3:
  2922                                  lff11s_3:
  2923 0000177E E950F3FFFF              	jmp	lff11_3	; padfill
  2924                                  		; (put zeros in the remain words of the buffer)
  2925                                  
  2926                                  load_11khz_stereo_8_bit:
  2927                                  	; 18/11/2023
  2928 00001783 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2929                                  					; last of the file?
  2930 0000178A 7402                    	jz	short lff11s_0		; no
  2931 0000178C F9                      	stc
  2932 0000178D C3                      	retn
  2933                                  
  2934                                  lff11s_0:
  2935 0000178E BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2936                                          ;mov	edx, [loadsize]
  2937                                  
  2938                                  	; esi = buffer address
  2939                                  	;; edx = buffer size
  2940                                  
  2941                                  	; load file into memory
  2942                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001793 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001799 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000179B 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000017A1 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000017A6 CD40                <1>  int 40h
  2943 000017A8 72CF                    	jc	short lff11s_7 ; error !
  2944                                  
  2945 000017AA BF[00300000]            	mov	edi, audio_buffer
  2946                                  	
  2947 000017AF D1E8                    	shr	eax, 1
  2948 000017B1 7505                    	jnz	short lff11s_8
  2949 000017B3 E933F3FFFF              	jmp	lff11_eof
  2950                                  
  2951                                  lff11s_8:
  2952 000017B8 89C1                    	mov	ecx, eax	; word count
  2953                                  lff11s_9:
  2954 000017BA BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  2955                                  lff11s_1:
  2956                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2957 000017BF 66AD                    	lodsw
  2958 000017C1 66BA8080                	mov	dx, 8080h
  2959 000017C5 49                      	dec	ecx
  2960 000017C6 7403                    	jz	short lff11s_2_1 
  2961 000017C8 668B16                  	mov	dx, [esi]
  2962                                  lff11s_2_1:	
  2963                                  	; al = [previous_val_l]
  2964                                  	; ah = [previous_val_r]
  2965                                  	; dl = [next_val_l]
  2966                                  	; dh = [next_val_r]	
  2967 000017CB E859050000              	call	interpolating_5_8bit_stereo
  2968 000017D0 E3AC                    	jecxz	lff11s_3
  2969                                  lff11s_2_2:
  2970 000017D2 66AD                    	lodsw
  2971 000017D4 66BA8080                	mov	dx, 8080h
  2972 000017D8 49                      	dec	ecx
  2973 000017D9 7403                    	jz	short lff11s_2_3
  2974 000017DB 668B16                  	mov	dx, [esi]
  2975                                  lff11s_2_3:
  2976 000017DE E832060000               	call	interpolating_4_8bit_stereo
  2977 000017E3 E399                    	jecxz	lff11s_3
  2978                                  	
  2979 000017E5 4D                      	dec	ebp
  2980 000017E6 74D2                    	jz	short lff11s_9
  2981                                  
  2982 000017E8 66AD                    	lodsw
  2983 000017EA 66BA8080                	mov	dx, 8080h
  2984 000017EE 49                      	dec	ecx
  2985 000017EF 7403                    	jz	short lff11s_2_4
  2986 000017F1 668B16                  	mov	dx, [esi]
  2987                                  lff11s_2_4:
  2988 000017F4 E81C060000              	call	interpolating_4_8bit_stereo
  2989 000017F9 E383                    	jecxz	lff11s_3
  2990 000017FB EBC2                    	jmp	short lff11s_1
  2991                                  
  2992                                  load_11khz_mono_16_bit:
  2993                                  	; 18/11/2023
  2994 000017FD F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2995                                  					; last of the file?
  2996 00001804 7402                    	jz	short lff11m2_0		; no
  2997 00001806 F9                      	stc
  2998 00001807 C3                      	retn
  2999                                  
  3000                                  lff11m2_0:
  3001 00001808 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3002                                          ;mov	edx, [loadsize]
  3003                                  
  3004                                  	; esi = buffer address
  3005                                  	;; edx = buffer size
  3006                                  
  3007                                  	; load file into memory
  3008                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000180D 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001813 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001815 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000181B B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001820 CD40                <1>  int 40h
  3009 00001822 724D                    	jc	short lff11m2_7 ; error !
  3010                                  
  3011 00001824 BF[00300000]            	mov	edi, audio_buffer
  3012                                  	
  3013 00001829 D1E8                    	shr	eax, 1
  3014 0000182B 7505                    	jnz	short lff11m2_8
  3015 0000182D E9B9F2FFFF              	jmp	lff11_eof
  3016                                  
  3017                                  lff11m2_8:
  3018 00001832 89C1                    	mov	ecx, eax	; word count
  3019                                  lff11m2_9:
  3020 00001834 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3021                                  lff11m2_1:
  3022                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3023 00001839 66AD                    	lodsw
  3024 0000183B 31D2                    	xor	edx, edx
  3025 0000183D 49                      	dec	ecx
  3026 0000183E 7403                    	jz	short lff11m2_2_1
  3027 00001840 668B16                  	mov	dx, [esi]
  3028                                  lff11m2_2_1:	
  3029                                  	; ax = [previous_val]
  3030                                  	; dx = [next_val]
  3031 00001843 E83A060000              	call	interpolating_5_16bit_mono
  3032 00001848 E362                    	jecxz	lff11m2_3
  3033                                  lff11m2_2_2:
  3034 0000184A 66AD                    	lodsw
  3035 0000184C 31D2                    	xor	edx, edx
  3036 0000184E 49                      	dec	ecx
  3037 0000184F 7403                    	jz	short lff11m2_2_3
  3038 00001851 668B16                  	mov	dx, [esi]
  3039                                  lff11m2_2_3:
  3040 00001854 E853070000               	call	interpolating_4_16bit_mono
  3041 00001859 E351                    	jecxz	lff11m2_3
  3042                                  
  3043 0000185B 4D                      	dec	ebp
  3044 0000185C 74D6                    	jz	short lff11m2_9
  3045                                  
  3046 0000185E 66AD                    	lodsw
  3047 00001860 31D2                    	xor	edx, edx
  3048 00001862 49                      	dec	ecx
  3049 00001863 7403                    	jz	short lff11m2_2_4
  3050 00001865 668B16                  	mov	dx, [esi]
  3051                                  lff11m2_2_4:
  3052 00001868 E83F070000               	call	interpolating_4_16bit_mono
  3053 0000186D E33D                    	jecxz	lff11m2_3
  3054 0000186F EBC8                    	jmp	short lff11m2_1
  3055                                  
  3056                                  lff11m2_7:
  3057                                  lff11s2_7:
  3058 00001871 E97EF2FFFF              	jmp	lff11_5  ; error
  3059                                  
  3060                                  load_11khz_stereo_16_bit:
  3061                                  	; 18/11/2023
  3062 00001876 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3063                                  					; last of the file?
  3064 0000187D 7402                    	jz	short lff11s2_0		; no
  3065 0000187F F9                      	stc
  3066 00001880 C3                      	retn
  3067                                  
  3068                                  lff11s2_0:
  3069 00001881 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3070                                          ;mov	edx, [loadsize]
  3071                                  
  3072                                  	; esi = buffer address
  3073                                  	;; edx = buffer size
  3074                                  
  3075                                  	; load file into memory
  3076                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001886 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000188C 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000188E 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001894 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001899 CD40                <1>  int 40h
  3077 0000189B 72D4                    	jc	short lff11s2_7 ; error !
  3078                                  
  3079 0000189D BF[00300000]            	mov	edi, audio_buffer
  3080                                  	
  3081 000018A2 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3082 000018A5 750A                    	jnz	short lff11s2_8
  3083 000018A7 E93FF2FFFF              	jmp	lff11_eof
  3084                                  
  3085                                  lff11m2_3:
  3086                                  lff11s2_3:
  3087 000018AC E922F2FFFF              	jmp	lff11_3	; padfill
  3088                                  		; (put zeros in the remain words of the buffer)
  3089                                  
  3090                                  lff11s2_8:
  3091 000018B1 89C1                    	mov	ecx, eax	; dword count
  3092                                  lff11s2_9:
  3093 000018B3 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3094                                  lff11s2_1:
  3095                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3096 000018B8 66AD                    	lodsw
  3097 000018BA 89C3                    	mov	ebx, eax
  3098 000018BC 66AD                    	lodsw
  3099 000018BE 8B16                    	mov	edx, [esi]
  3100 000018C0 8915[66200000]          	mov	[next_val_l], edx
  3101                                  	; 26/11/2023
  3102 000018C6 C1EA10                  	shr	edx, 16
  3103                                  	;mov	[next_val_r], dx
  3104 000018C9 49                      	dec	ecx
  3105 000018CA 7509                    	jnz	short lff11s2_2_1
  3106 000018CC 31D2                    	xor	edx, edx ; 0
  3107 000018CE 668915[66200000]        	mov	[next_val_l], dx
  3108                                  	;mov	[next_val_r], dx
  3109                                  lff11s2_2_1:
  3110                                  	; bx = [previous_val_l]
  3111                                  	; ax = [previous_val_r]
  3112                                  	; [next_val_l]
  3113                                  	; dx = [next_val_r]
  3114 000018D5 E803060000              	call	interpolating_5_16bit_stereo
  3115 000018DA E3D0                    	jecxz	lff11s2_3
  3116                                  lff11s2_2_2:
  3117 000018DC 66AD                    	lodsw
  3118 000018DE 89C3                    	mov	ebx, eax
  3119 000018E0 66AD                    	lodsw
  3120 000018E2 8B16                    	mov	edx, [esi]
  3121 000018E4 668915[66200000]        	mov	[next_val_l], dx
  3122                                  	; 26/11/2023
  3123 000018EB C1EA10                  	shr	edx, 16
  3124                                  	;mov	[next_val_r], dx
  3125 000018EE 49                      	dec	ecx
  3126 000018EF 7509                    	jnz	short lff11s2_2_3
  3127 000018F1 31D2                    	xor	edx, edx ; 0
  3128 000018F3 668915[66200000]        	mov	[next_val_l], dx
  3129                                  	;mov	[next_val_r], dx
  3130                                  lff11s2_2_3:
  3131 000018FA E8E6060000               	call	interpolating_4_16bit_stereo
  3132 000018FF E3AB                    	jecxz	lff11s2_3
  3133                                  	
  3134 00001901 4D                      	dec	ebp
  3135 00001902 74AF                    	jz	short lff11s2_9
  3136                                  
  3137 00001904 66AD                    	lodsw
  3138 00001906 89C3                    	mov	ebx, eax
  3139 00001908 66AD                    	lodsw
  3140 0000190A 8B16                    	mov	edx, [esi]
  3141 0000190C 668915[66200000]        	mov	[next_val_l], dx
  3142                                  	; 26/11/2023
  3143 00001913 C1EA10                  	shr	edx, 16
  3144                                  	;mov	[next_val_r], dx
  3145 00001916 49                      	dec	ecx
  3146 00001917 7509                    	jnz	short lff11s2_2_4
  3147 00001919 31D2                    	xor	edx, edx ; 0
  3148 0000191B 668915[66200000]        	mov	[next_val_l], dx
  3149                                  	;mov	[next_val_r], dx
  3150                                  lff11s2_2_4:
  3151 00001922 E8BE060000               	call	interpolating_4_16bit_stereo
  3152 00001927 E383                    	jecxz	lff11s2_3
  3153 00001929 EB8D                    	jmp	short lff11s2_1
  3154                                  
  3155                                  ; .....................
  3156                                  
  3157                                  load_44khz_mono_8_bit:
  3158                                  	; 18/11/2023
  3159 0000192B F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3160                                  					; last of the file?
  3161 00001932 7402                    	jz	short lff44m_0		; no
  3162 00001934 F9                      	stc
  3163 00001935 C3                      	retn
  3164                                  
  3165                                  lff44m_0:
  3166 00001936 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3167                                          ;mov	edx, [loadsize]
  3168                                  
  3169                                  	; esi = buffer address
  3170                                  	;; edx = buffer size
  3171                                  
  3172                                  	; load file into memory
  3173                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000193B 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001941 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001943 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001949 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000194E CD40                <1>  int 40h
  3174 00001950 7250                    	jc	short lff44m_7 ; error !
  3175                                  
  3176 00001952 BF[00300000]            	mov	edi, audio_buffer
  3177                                  	
  3178 00001957 21C0                    	and	eax, eax
  3179 00001959 7505                    	jnz	short lff44m_8
  3180 0000195B E98BF1FFFF              	jmp	lff44_eof
  3181                                  
  3182                                  lff44m_8:
  3183 00001960 89C1                    	mov	ecx, eax	; byte count
  3184                                  lff44m_9:
  3185 00001962 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3186 00001967 C605[6A200000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3187                                  lff44m_1:
  3188                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3189                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3190 0000196E AC                      	lodsb
  3191 0000196F B280                    	mov	dl, 80h
  3192 00001971 49                      	dec	ecx
  3193 00001972 7402                    	jz	short lff44m_2_1
  3194 00001974 8A16                    	mov	dl, [esi]
  3195                                  lff44m_2_1:	
  3196                                  	; al = [previous_val]
  3197                                  	; dl = [next_val]
  3198 00001976 E825020000              	call	interpolating_2_8bit_mono
  3199 0000197B E320                    	jecxz	lff44m_3
  3200                                  lff44m_2_2:
  3201 0000197D AC                      	lodsb
  3202 0000197E 2C80                    	sub	al, 80h
  3203 00001980 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3204 00001984 66AB                    	stosw		; (L)
  3205 00001986 66AB                    	stosw		; (R)	
  3206                                  
  3207 00001988 49                      	dec	ecx
  3208 00001989 7412                    	jz	short lff44m_3	
  3209 0000198B 4D                      	dec	ebp
  3210 0000198C 75EF                    	jnz	short lff44m_2_2
  3211                                  	
  3212 0000198E FE0D[6A200000]          	dec	byte [faz]
  3213 00001994 74CC                    	jz	short lff44m_9 
  3214 00001996 BD0B000000              	mov	ebp, 11
  3215 0000199B EBD1                    	jmp	short lff44m_1
  3216                                  
  3217                                  lff44m_3:
  3218                                  lff44s_3:
  3219 0000199D E931F1FFFF              	jmp	lff44_3	; padfill
  3220                                  		; (put zeros in the remain words of the buffer)
  3221                                  lff44m_7:
  3222                                  lff44s_7:
  3223 000019A2 E94DF1FFFF              	jmp	lff44_5  ; error
  3224                                  
  3225                                  load_44khz_stereo_8_bit:
  3226                                  	; 16/11/2023
  3227 000019A7 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3228                                  					; last of the file?
  3229 000019AE 7402                    	jz	short lff44s_0		; no
  3230 000019B0 F9                      	stc
  3231 000019B1 C3                      	retn
  3232                                  
  3233                                  lff44s_0:
  3234 000019B2 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3235                                          ;mov	edx, [loadsize]
  3236                                  
  3237                                  	; esi = buffer address
  3238                                  	;; edx = buffer size
  3239                                  
  3240                                  	; load file into memory
  3241                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000019B7 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000019BD 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000019BF 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000019C5 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000019CA CD40                <1>  int 40h
  3242 000019CC 72D4                    	jc	short lff44s_7 ; error !
  3243                                  
  3244 000019CE BF[00300000]            	mov	edi, audio_buffer
  3245                                  	
  3246 000019D3 D1E8                    	shr	eax, 1
  3247 000019D5 7505                    	jnz	short lff44s_8
  3248 000019D7 E90FF1FFFF              	jmp	lff44_eof
  3249                                  
  3250                                  lff44s_8:
  3251 000019DC 89C1                    	mov	ecx, eax	; word count
  3252                                  lff44s_9:
  3253 000019DE BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3254 000019E3 C605[6A200000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3255                                  lff44s_1:
  3256                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3257                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3258 000019EA 66AD                    	lodsw
  3259 000019EC 66BA8080                	mov	dx, 8080h
  3260 000019F0 49                      	dec	ecx
  3261 000019F1 7403                    	jz	short lff44s_2_1 
  3262 000019F3 668B16                  	mov	dx, [esi]
  3263                                  lff44s_2_1:	
  3264                                  	; al = [previous_val_l]
  3265                                  	; ah = [previous_val_r]
  3266                                  	; dl = [next_val_l]
  3267                                  	; dh = [next_val_r]	
  3268 000019F6 E8C2010000              	call	interpolating_2_8bit_stereo
  3269 000019FB E3A0                    	jecxz	lff44s_3
  3270                                  lff44s_2_2:
  3271 000019FD AC                      	lodsb
  3272 000019FE 2C80                    	sub	al, 80h
  3273 00001A00 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3274 00001A04 66AB                    	stosw		; (L)
  3275 00001A06 AC                      	lodsb
  3276 00001A07 2C80                    	sub	al, 80h
  3277 00001A09 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3278 00001A0D 66AB                    	stosw		; (R)
  3279                                  
  3280 00001A0F 49                      	dec	ecx
  3281 00001A10 748B                    	jz	short lff44s_3	
  3282 00001A12 4D                      	dec	ebp
  3283 00001A13 75E8                    	jnz	short lff44s_2_2
  3284                                  	
  3285 00001A15 FE0D[6A200000]          	dec	byte [faz]
  3286 00001A1B 74C1                    	jz	short lff44s_9 
  3287 00001A1D BD0B000000              	mov	ebp, 11
  3288 00001A22 EBC6                    	jmp	short lff44s_1
  3289                                  
  3290                                  load_44khz_mono_16_bit:
  3291                                  	; 18/11/2023
  3292 00001A24 F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3293                                  					; last of the file?
  3294 00001A2B 7402                    	jz	short lff44m2_0		; no
  3295 00001A2D F9                      	stc
  3296 00001A2E C3                      	retn
  3297                                  
  3298                                  lff44m2_0:
  3299 00001A2F BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3300                                          ;mov	edx, [loadsize]
  3301                                  
  3302                                  	; esi = buffer address
  3303                                  	;; edx = buffer size
  3304                                  
  3305                                  	; load file into memory
  3306                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001A34 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001A3A 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001A3C 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001A42 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001A47 CD40                <1>  int 40h
  3307 00001A49 724D                    	jc	short lff44m2_7 ; error !
  3308                                  
  3309 00001A4B BF[00300000]            	mov	edi, audio_buffer
  3310                                  	
  3311 00001A50 D1E8                    	shr	eax, 1
  3312 00001A52 7505                    	jnz	short lff44m2_8
  3313 00001A54 E992F0FFFF              	jmp	lff44_eof
  3314                                  
  3315                                  lff44m2_8:
  3316 00001A59 89C1                    	mov	ecx, eax	; word count
  3317                                  lff44m2_9:
  3318 00001A5B BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3319 00001A60 C605[6A200000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3320                                  lff44m2_1:
  3321                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3322                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3323 00001A67 66AD                    	lodsw
  3324 00001A69 31D2                    	xor	edx, edx
  3325 00001A6B 49                      	dec	ecx
  3326 00001A6C 7403                    	jz	short lff44m2_2_1
  3327 00001A6E 668B16                  	mov	dx, [esi]
  3328                                  lff44m2_2_1:	
  3329                                  	; ax = [previous_val]
  3330                                  	; dx = [next_val]
  3331 00001A71 E80B020000              	call	interpolating_2_16bit_mono
  3332 00001A76 E31B                    	jecxz	lff44m2_3
  3333                                  lff44m2_2_2:
  3334 00001A78 66AD                    	lodsw
  3335 00001A7A 66AB                    	stosw		; (L)eft Channel
  3336 00001A7C 66AB                    	stosw		; (R)ight Channel
  3337                                  
  3338 00001A7E 49                      	dec	ecx
  3339 00001A7F 7412                    	jz	short lff44m2_3	
  3340 00001A81 4D                      	dec	ebp
  3341 00001A82 75F4                    	jnz	short lff44m2_2_2
  3342                                  	
  3343 00001A84 FE0D[6A200000]          	dec	byte [faz]
  3344 00001A8A 74CF                    	jz	short lff44m2_9 
  3345 00001A8C BD0B000000              	mov	ebp, 11
  3346 00001A91 EBD4                    	jmp	short lff44m2_1
  3347                                  
  3348                                  lff44m2_3:
  3349                                  lff44s2_3:
  3350 00001A93 E93BF0FFFF              	jmp	lff44_3	; padfill
  3351                                  		; (put zeros in the remain words of the buffer)
  3352                                  lff44m2_7:
  3353                                  lff44s2_7:
  3354 00001A98 E957F0FFFF              	jmp	lff44_5  ; error
  3355                                  
  3356                                  load_44khz_stereo_16_bit:
  3357                                  	; 18/11/2023
  3358 00001A9D F605[48230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3359                                  					; last of the file?
  3360 00001AA4 7402                    	jz	short lff44s2_0		; no
  3361 00001AA6 F9                      	stc
  3362 00001AA7 C3                      	retn
  3363                                  
  3364                                  lff44s2_0:
  3365 00001AA8 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3366                                          ;mov	edx, [loadsize]
  3367                                  
  3368                                  	; esi = buffer address
  3369                                  	;; edx = buffer size
  3370                                  
  3371                                  	; load file into memory
  3372                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001AAD 8B1D[6B200000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001AB3 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001AB5 8B15[CD030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001ABB B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001AC0 CD40                <1>  int 40h
  3373 00001AC2 72D4                    	jc	short lff44s2_7 ; error !
  3374                                  
  3375 00001AC4 BF[00300000]            	mov	edi, audio_buffer
  3376                                  	
  3377 00001AC9 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3378 00001ACC 7505                    	jnz	short lff44s2_8
  3379 00001ACE E918F0FFFF              	jmp	lff44_eof
  3380                                  
  3381                                  lff44s2_8:
  3382 00001AD3 89C1                    	mov	ecx, eax	; dword count
  3383                                  lff44s2_9:
  3384 00001AD5 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3385 00001ADA C605[6A200000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3386                                  lff44s2_1:
  3387                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3388                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3389 00001AE1 66AD                    	lodsw
  3390 00001AE3 89C3                    	mov	ebx, eax
  3391 00001AE5 66AD                    	lodsw
  3392                                  	;mov	dx, [esi]
  3393                                  	;mov	[next_val_l], dx
  3394                                  	;mov	dx, [esi+2]
  3395                                  	; 26/11/2023
  3396 00001AE7 8B16                    	mov	edx, [esi]
  3397 00001AE9 668915[66200000]        	mov	[next_val_l], dx
  3398 00001AF0 C1EA10                  	shr	edx, 16
  3399 00001AF3 49                      	dec	ecx
  3400 00001AF4 7509                    	jnz	short lff44s2_2_1
  3401 00001AF6 31D2                    	xor	edx, edx ; 0
  3402 00001AF8 668915[66200000]        	mov	[next_val_l], dx
  3403                                  lff44s2_2_1:
  3404                                  	; bx = [previous_val_l]
  3405                                  	; ax = [previous_val_r]
  3406                                  	; [next_val_l]
  3407                                  	; dx = [next_val_r]
  3408 00001AFF E895010000              	call	interpolating_2_16bit_stereo
  3409 00001B04 E38D                    	jecxz	lff44s2_3
  3410                                  lff44s2_2_2:
  3411                                  	;movsw		; (L)eft Channel
  3412                                  	;movsw		; (R)ight Channel
  3413 00001B06 A5                      	movsd
  3414                                  
  3415 00001B07 49                      	dec	ecx
  3416 00001B08 7489                    	jz	short lff44s2_3	
  3417 00001B0A 4D                      	dec	ebp
  3418 00001B0B 75F9                    	jnz	short lff44s2_2_2
  3419                                  	
  3420 00001B0D FE0D[6A200000]          	dec	byte [faz]
  3421 00001B13 74C0                    	jz	short lff44s2_9 
  3422 00001B15 BD0B000000              	mov	ebp, 11
  3423 00001B1A EBC5                    	jmp	short lff44s2_1
  3424                                  
  3425                                  ; .....................
  3426                                  
  3427                                  interpolating_3_8bit_mono:
  3428                                  	; 16/11/2023
  3429                                  	; al = [previous_val]
  3430                                  	; dl = [next_val]
  3431                                  	; original-interpolated-interpolated
  3432 00001B1C 88C3                    	mov	bl, al
  3433 00001B1E 2C80                    	sub	al, 80h
  3434 00001B20 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3435 00001B24 66AB                    	stosw		; original sample (L)
  3436 00001B26 66AB                    	stosw		; original sample (R)
  3437 00001B28 88D8                    	mov	al, bl
  3438 00001B2A 00D0                    	add	al, dl	
  3439 00001B2C D0D8                    	rcr	al, 1
  3440 00001B2E 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3441 00001B30 00D8                    	add	al, bl
  3442 00001B32 D0D8                    	rcr	al, 1
  3443 00001B34 2C80                    	sub	al, 80h
  3444 00001B36 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3445 00001B3A 66AB                    	stosw		; interpolated sample 1 (L)
  3446 00001B3C 66AB                    	stosw		; interpolated sample 1 (R)
  3447 00001B3E 88F8                    	mov	al, bh
  3448 00001B40 00D0                    	add	al, dl	; [next_val]
  3449 00001B42 D0D8                    	rcr	al, 1
  3450 00001B44 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3451 00001B48 66AB                    	stosw		; interpolated sample 2 (L)
  3452 00001B4A 66AB                    	stosw		; interpolated sample 2 (R)
  3453 00001B4C C3                      	retn
  3454                                  
  3455                                  interpolating_3_8bit_stereo:
  3456                                  	; 16/11/2023
  3457                                  	; al = [previous_val_l]
  3458                                  	; ah = [previous_val_r]
  3459                                  	; dl = [next_val_l]
  3460                                  	; dh = [next_val_r]	
  3461                                  	; original-interpolated-interpolated
  3462 00001B4D 89C3                    	mov	ebx, eax
  3463 00001B4F 2C80                    	sub	al, 80h
  3464 00001B51 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3465 00001B55 66AB                    	stosw		; original sample (L)
  3466 00001B57 88F8                    	mov	al, bh
  3467 00001B59 2C80                    	sub	al, 80h
  3468 00001B5B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3469 00001B5F 66AB                    	stosw		; original sample (R)
  3470 00001B61 88D8                    	mov	al, bl
  3471 00001B63 00D0                    	add	al, dl	; [next_val_l]	
  3472 00001B65 D0D8                    	rcr	al, 1
  3473 00001B67 50                      	push	eax ; *	; al = interpolated middle (L) (temporary)
  3474 00001B68 00D8                    	add	al, bl	; [previous_val_l]
  3475 00001B6A D0D8                    	rcr	al, 1
  3476 00001B6C 2C80                    	sub	al, 80h
  3477 00001B6E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3478 00001B72 66AB                    	stosw		; interpolated sample 1 (L)
  3479 00001B74 88F8                    	mov	al, bh
  3480 00001B76 00F0                    	add	al, dh	; [next_val_r]
  3481 00001B78 D0D8                    	rcr	al, 1
  3482 00001B7A 50                      	push	eax ; ** ; al = interpolated middle (R) (temporary)
  3483 00001B7B 00F8                    	add	al, bh	; [previous_val_r]
  3484 00001B7D D0D8                    	rcr	al, 1
  3485 00001B7F 2C80                    	sub	al, 80h
  3486 00001B81 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3487 00001B85 66AB                    	stosw		; interpolated sample 1 (R)
  3488 00001B87 5B                      	pop	ebx ; **
  3489 00001B88 58                      	pop	eax ; *
  3490 00001B89 00D0                    	add	al, dl	; [next_val_l]
  3491 00001B8B D0D8                    	rcr	al, 1
  3492 00001B8D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3493 00001B91 66AB                    	stosw		; interpolated sample 2 (L)
  3494 00001B93 88D8                    	mov	al, bl
  3495 00001B95 00F0                    	add	al, dh	; [next_val_r]
  3496 00001B97 D0D8                    	rcr	al, 1
  3497 00001B99 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3498 00001B9D 66AB                    	stosw		; interpolated sample 2 (R)
  3499 00001B9F C3                      	retn
  3500                                  
  3501                                  interpolating_2_8bit_mono:
  3502                                  	; 16/11/2023
  3503                                  	; al = [previous_val]
  3504                                  	; dl = [next_val]
  3505                                  	; original-interpolated
  3506 00001BA0 88C3                    	mov	bl, al
  3507 00001BA2 2C80                    	sub	al, 80h
  3508 00001BA4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3509 00001BA8 66AB                    	stosw		; original sample (L)
  3510 00001BAA 66AB                    	stosw		; original sample (R)
  3511 00001BAC 88D8                    	mov	al, bl
  3512 00001BAE 00D0                    	add	al, dl	
  3513 00001BB0 D0D8                    	rcr	al, 1
  3514 00001BB2 2C80                    	sub	al, 80h
  3515 00001BB4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3516 00001BB8 66AB                    	stosw		; interpolated sample (L)
  3517 00001BBA 66AB                    	stosw		; interpolated sample (R)
  3518 00001BBC C3                      	retn
  3519                                  
  3520                                  interpolating_2_8bit_stereo:
  3521                                  	; 16/11/2023
  3522                                  	; al = [previous_val_l]
  3523                                  	; ah = [previous_val_r]
  3524                                  	; dl = [next_val_l]
  3525                                  	; dh = [next_val_r]	
  3526                                  	; original-interpolated
  3527 00001BBD 89C3                    	mov	ebx, eax
  3528 00001BBF 2C80                    	sub	al, 80h
  3529 00001BC1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3530 00001BC5 66AB                    	stosw		; original sample (L)
  3531 00001BC7 88F8                    	mov	al, bh
  3532 00001BC9 2C80                    	sub	al, 80h
  3533 00001BCB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3534 00001BCF 66AB                    	stosw		; original sample (R)
  3535 00001BD1 88D8                    	mov	al, bl	; [previous_val_l]
  3536 00001BD3 00D0                    	add	al, dl	; [next_val_l]	
  3537 00001BD5 D0D8                    	rcr	al, 1
  3538 00001BD7 2C80                    	sub	al, 80h
  3539 00001BD9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3540 00001BDD 66AB                    	stosw		; interpolated sample (L)
  3541 00001BDF 88F8                    	mov	al, bh
  3542 00001BE1 00F0                    	add	al, dh	; [next_val_r]
  3543 00001BE3 D0D8                    	rcr	al, 1
  3544 00001BE5 2C80                    	sub	al, 80h
  3545 00001BE7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3546 00001BEB 66AB                    	stosw		; interpolated sample (R)
  3547 00001BED C3                      	retn
  3548                                  
  3549                                  interpolating_3_16bit_mono:
  3550                                  	; 16/11/2023
  3551                                  	; ax = [previous_val]
  3552                                  	; dx = [next_val]
  3553                                  	; original-interpolated-interpolated
  3554                                  
  3555 00001BEE 66AB                    	stosw		; original sample (L)
  3556 00001BF0 66AB                    	stosw		; original sample (R)
  3557 00001BF2 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3558 00001BF5 50                      	push	eax ; *	; [previous_val]
  3559 00001BF6 80C680                  	add	dh, 80h
  3560 00001BF9 6601D0                  	add	ax, dx
  3561 00001BFC 66D1D8                  	rcr	ax, 1
  3562 00001BFF 5B                      	pop	ebx ; *		
  3563 00001C00 93                      	xchg	ebx, eax ; bx  = interpolated middle (temporary)
  3564 00001C01 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  3565 00001C04 66D1D8                  	rcr	ax, 1
  3566 00001C07 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3567 00001C0A 66AB                    	stosw 		; interpolated sample 1 (L)
  3568 00001C0C 66AB                    	stosw		; interpolated sample 1 (R)
  3569 00001C0E 89D8                    	mov	eax, ebx
  3570 00001C10 6601D0                  	add	ax, dx	 ;interpolated middle + [next_val]
  3571 00001C13 66D1D8                  	rcr	ax, 1
  3572 00001C16 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3573 00001C19 66AB                    	stosw		; interpolated sample 2 (L)
  3574 00001C1B 66AB                    	stosw		; interpolated sample 2 (R)
  3575 00001C1D C3                      	retn
  3576                                  
  3577                                  interpolating_3_16bit_stereo:
  3578                                  	; 16/11/2023
  3579                                  	; bx = [previous_val_l]
  3580                                  	; ax = [previous_val_r]
  3581                                  	; [next_val_l]
  3582                                  	; dx = [next_val_r]
  3583                                  	; original-interpolated-interpolated
  3584                                  
  3585 00001C1E 93                      	xchg	eax, ebx
  3586 00001C1F 66AB                    	stosw		; original sample (L)
  3587 00001C21 93                      	xchg	eax, ebx
  3588 00001C22 66AB                    	stosw		; original sample (R)
  3589 00001C24 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3590 00001C27 50                      	push	eax ; *	; [previous_val_r]
  3591 00001C28 80C780                  	add	bh, 80h
  3592 00001C2B 8005[67200000]80        	add	byte [next_val_l+1], 80h
  3593 00001C32 66A1[66200000]          	mov	ax, [next_val_l]
  3594 00001C38 6601D8                  	add	ax, bx	; [previous_val_l]
  3595 00001C3B 66D1D8                  	rcr	ax, 1
  3596 00001C3E 93                      	xchg	eax, ebx ; ax = [previous_val_l]
  3597 00001C3F 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  3598 00001C42 66D1D8                  	rcr	ax, 1
  3599 00001C45 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3600 00001C48 66AB                    	stosw 		; interpolated sample 1 (L)
  3601 00001C4A 58                      	pop	eax  ; *
  3602 00001C4B 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  3603 00001C4E 52                      	push	edx  ; * ; [next_val_r]
  3604 00001C4F 92                      	xchg	eax, edx
  3605 00001C50 6601D0                  	add	ax, dx	; [next_val_r] + [previous_val_r]
  3606 00001C53 66D1D8                  	rcr	ax, 1	; / 2
  3607 00001C56 50                      	push	eax ; ** ; interpolated middle (R)
  3608 00001C57 6601D0                  	add	ax, dx	; + [previous_val_r]
  3609 00001C5A 66D1D8                  	rcr	ax, 1
  3610 00001C5D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3611 00001C60 66AB                    	stosw 		; interpolated sample 1 (R)
  3612 00001C62 66A1[66200000]          	mov	ax, [next_val_l]
  3613 00001C68 6601D8                  	add	ax, bx	; + interpolated middle (L)
  3614 00001C6B 66D1D8                  	rcr	ax, 1
  3615 00001C6E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3616 00001C71 66AB                    	stosw 		; interpolated sample 2 (L)
  3617 00001C73 58                      	pop	eax ; **
  3618 00001C74 5A                      	pop	edx ; *	
  3619 00001C75 6601D0                  	add	ax, dx	; interpolated middle + [next_val_r]
  3620 00001C78 66D1D8                  	rcr	ax, 1	; / 2
  3621 00001C7B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3622 00001C7E 66AB                    	stosw 		; interpolated sample 2 (L)
  3623 00001C80 C3                      	retn
  3624                                  
  3625                                  interpolating_2_16bit_mono:
  3626                                  	; 16/11/2023
  3627                                  	; ax = [previous_val]
  3628                                  	; dx = [next_val]
  3629                                  	; original-interpolated
  3630                                  
  3631 00001C81 66AB                    	stosw		; original sample (L)
  3632 00001C83 66AB                    	stosw		; original sample (R)
  3633 00001C85 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3634 00001C88 80C680                  	add	dh, 80h
  3635 00001C8B 6601D0                  	add	ax, dx
  3636 00001C8E 66D1D8                  	rcr	ax, 1
  3637 00001C91 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3638 00001C94 66AB                    	stosw		; interpolated sample (L)
  3639 00001C96 66AB                    	stosw		; interpolated sample (R)
  3640 00001C98 C3                      	retn
  3641                                  
  3642                                  interpolating_2_16bit_stereo:
  3643                                  	; 16/11/2023
  3644                                  	; bx = [previous_val_l]
  3645                                  	; ax = [previous_val_r]
  3646                                  	; [next_val_l]
  3647                                  	; dx = [next_val_r]
  3648                                  	; original-interpolated
  3649                                  
  3650 00001C99 93                      	xchg	eax, ebx
  3651 00001C9A 66AB                    	stosw		; original sample (L)
  3652 00001C9C 93                      	xchg	eax, ebx
  3653 00001C9D 66AB                    	stosw		; original sample (R)
  3654 00001C9F 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3655 00001CA2 80C680                  	add	dh, 80h
  3656 00001CA5 6601D0                  	add	ax, dx	; [previous_val_r] + [next_val_r]
  3657 00001CA8 66D1D8                  	rcr	ax, 1	; / 2
  3658 00001CAB 50                      	push	eax ; *	; interpolated sample (R)
  3659 00001CAC 66A1[66200000]          	mov	ax, [next_val_l]
  3660 00001CB2 80C480                  	add	ah, 80h
  3661 00001CB5 80C780                  	add	bh, 80h
  3662 00001CB8 6601D8                  	add	ax, bx	; [next_val_l] + [previous_val_l]
  3663 00001CBB 66D1D8                  	rcr	ax, 1	; / 2		
  3664 00001CBE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3665 00001CC1 66AB                    	stosw 		; interpolated sample (L)
  3666 00001CC3 58                      	pop	eax ; *	
  3667 00001CC4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3668 00001CC7 66AB                    	stosw 		; interpolated sample (R)
  3669 00001CC9 C3                      	retn
  3670                                  
  3671                                  interpolating_5_8bit_mono:
  3672                                  	; 17/11/2023
  3673                                  	; al = [previous_val]
  3674                                  	; dl = [next_val]
  3675                                  	; original-interpltd-interpltd-interpltd-interpltd
  3676 00001CCA 88C3                    	mov	bl, al
  3677 00001CCC 2C80                    	sub	al, 80h
  3678 00001CCE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3679 00001CD2 66AB                    	stosw		; original sample (L)
  3680 00001CD4 66AB                    	stosw		; original sample (R)
  3681 00001CD6 88D8                    	mov	al, bl
  3682 00001CD8 00D0                    	add	al, dl	
  3683 00001CDA D0D8                    	rcr	al, 1
  3684 00001CDC 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3685 00001CDE 00D8                    	add	al, bl  ; [previous_val]
  3686 00001CE0 D0D8                    	rcr	al, 1 	
  3687 00001CE2 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  3688 00001CE4 00D8                    	add	al, bl
  3689 00001CE6 D0D8                    	rcr	al, 1
  3690 00001CE8 2C80                    	sub	al, 80h
  3691 00001CEA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3692 00001CEE 66AB                    	stosw		; interpolated sample 1 (L)
  3693 00001CF0 66AB                    	stosw		; interpolated sample 1 (R)
  3694 00001CF2 88F8                    	mov	al, bh
  3695 00001CF4 00F0                    	add	al, dh
  3696 00001CF6 D0D8                    	rcr	al, 1
  3697 00001CF8 2C80                    	sub	al, 80h
  3698 00001CFA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3699 00001CFE 66AB                    	stosw		; interpolated sample 2 (L)
  3700 00001D00 66AB                    	stosw		; interpolated sample 2 (R)
  3701 00001D02 88F8                    	mov	al, bh
  3702 00001D04 00D0                    	add	al, dl	; [next_val]
  3703 00001D06 D0D8                    	rcr	al, 1
  3704 00001D08 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  3705 00001D0A 00F8                    	add	al, bh
  3706 00001D0C D0D8                    	rcr	al, 1
  3707 00001D0E 2C80                    	sub	al, 80h
  3708 00001D10 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3709 00001D14 66AB                    	stosw		; interpolated sample 3 (L)
  3710 00001D16 66AB                    	stosw		; interpolated sample 3 (R)
  3711 00001D18 88F0                    	mov	al, dh
  3712 00001D1A 00D0                    	add	al, dl
  3713 00001D1C D0D8                    	rcr	al, 1
  3714 00001D1E 2C80                    	sub	al, 80h
  3715 00001D20 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3716 00001D24 66AB                    	stosw		; interpolated sample 4 (L)
  3717 00001D26 66AB                    	stosw		; interpolated sample 4 (R)
  3718 00001D28 C3                      	retn
  3719                                  
  3720                                  interpolating_5_8bit_stereo:
  3721                                  	; 17/11/2023
  3722                                  	; al = [previous_val_l]
  3723                                  	; ah = [previous_val_r]
  3724                                  	; dl = [next_val_l]
  3725                                  	; dh = [next_val_r]	
  3726                                  	; original-interpltd-interpltd-interpltd-interpltd
  3727 00001D29 89C3                    	mov	ebx, eax
  3728 00001D2B 2C80                    	sub	al, 80h
  3729 00001D2D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3730 00001D31 66AB                    	stosw		; original sample (L)
  3731 00001D33 88F8                    	mov	al, bh
  3732 00001D35 2C80                    	sub	al, 80h
  3733 00001D37 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3734 00001D3B 66AB                    	stosw		; original sample (R)
  3735 00001D3D 52                      	push	edx ; *
  3736 00001D3E 88D8                    	mov	al, bl
  3737 00001D40 00D0                    	add	al, dl	; [next_val_l]
  3738 00001D42 D0D8                    	rcr	al, 1
  3739 00001D44 50                      	push	eax ; **	; al = interpolated middle (L) (temporary)
  3740 00001D45 00D8                    	add	al, bl	; [previous_val_l]
  3741 00001D47 D0D8                    	rcr	al, 1
  3742 00001D49 86D8                    	xchg	al, bl	
  3743 00001D4B 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3744 00001D4D D0D8                    	rcr	al, 1
  3745 00001D4F 2C80                    	sub	al, 80h
  3746 00001D51 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3747 00001D55 66AB                    	stosw		; interpolated sample 1 (L)
  3748 00001D57 88F8                    	mov	al, bh
  3749 00001D59 00F0                    	add	al, dh	; [next_val_r]
  3750 00001D5B D0D8                    	rcr	al, 1
  3751 00001D5D 50                      	push	eax ; *** ; al = interpolated middle (R) (temporary)
  3752 00001D5E 00F8                    	add	al, bh	; [previous_val_r]
  3753 00001D60 D0D8                    	rcr	al, 1
  3754 00001D62 86F8                    	xchg	al, bh	
  3755 00001D64 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3756 00001D66 D0D8                    	rcr	al, 1
  3757 00001D68 2C80                    	sub	al, 80h
  3758 00001D6A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3759 00001D6E 66AB                    	stosw		; interpolated sample 1 (R)
  3760 00001D70 5A                      	pop	edx ; ***
  3761 00001D71 58                      	pop	eax ; **	; al = interpolated middle (L) (temporary)
  3762 00001D72 86D8                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3763 00001D74 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  3764 00001D76 D0D8                    	rcr	al, 1
  3765 00001D78 2C80                    	sub	al, 80h
  3766 00001D7A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3767 00001D7E 66AB                    	stosw		; interpolated sample 2 (L)	
  3768 00001D80 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  3769 00001D82 86F8                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  3770 00001D84 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  3771 00001D86 D0D8                    	rcr	al, 1
  3772 00001D88 2C80                    	sub	al, 80h
  3773 00001D8A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3774 00001D8E 66AB                    	stosw		; interpolated sample 2 (R)
  3775 00001D90 5A                      	pop	edx ; *
  3776 00001D91 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  3777 00001D93 00D0                    	add	al, dl	; [next_val_l]
  3778 00001D95 D0D8                    	rcr	al, 1
  3779 00001D97 86D8                    	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  3780 00001D99 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  3781 00001D9B D0D8                    	rcr	al, 1
  3782 00001D9D 2C80                    	sub	al, 80h
  3783 00001D9F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3784 00001DA3 66AB                    	stosw		; interpolated sample 3 (L)
  3785 00001DA5 88F8                    	mov	al, bh	
  3786 00001DA7 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  3787 00001DA9 D0D8                    	rcr	al, 1
  3788 00001DAB 86F8                    	xchg	al, bh	; al = interpolated middle (R)
  3789 00001DAD 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  3790 00001DAF D0D8                    	rcr	al, 1
  3791 00001DB1 2C80                    	sub	al, 80h
  3792 00001DB3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3793 00001DB7 66AB                    	stosw		; interpolated sample 3 (R)
  3794 00001DB9 88D8                    	mov	al, bl
  3795 00001DBB 00D0                    	add	al, dl	; [next_val_l]
  3796 00001DBD D0D8                    	rcr	al, 1
  3797 00001DBF 2C80                    	sub	al, 80h
  3798 00001DC1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3799 00001DC5 66AB                    	stosw		; interpolated sample 4 (L)
  3800 00001DC7 88F8                    	mov	al, bh
  3801 00001DC9 00F0                    	add	al, dh	; [next_val_r]
  3802 00001DCB D0D8                    	rcr	al, 1
  3803 00001DCD 2C80                    	sub	al, 80h
  3804 00001DCF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3805 00001DD3 66AB                    	stosw		; interpolated sample 4 (R)
  3806 00001DD5 C3                      	retn
  3807                                  
  3808                                  interpolating_4_8bit_mono:
  3809                                  	; 17/11/2023
  3810                                  	; al = [previous_val]
  3811                                  	; dl = [next_val]
  3812                                  	; original-interpolated-interpolated-interpolated
  3813 00001DD6 88C3                    	mov	bl, al
  3814 00001DD8 2C80                    	sub	al, 80h
  3815 00001DDA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3816 00001DDE 66AB                    	stosw		; original sample (L)
  3817 00001DE0 66AB                    	stosw		; original sample (R)
  3818 00001DE2 88D8                    	mov	al, bl
  3819 00001DE4 00D0                    	add	al, dl	
  3820 00001DE6 D0D8                    	rcr	al, 1
  3821 00001DE8 86D8                    	xchg	al, bl  ; al = [previous_val]
  3822 00001DEA 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  3823 00001DEC D0D8                    	rcr	al, 1 	
  3824 00001DEE 2C80                    	sub	al, 80h
  3825 00001DF0 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3826 00001DF4 66AB                    	stosw		; interpolated sample 1 (L)
  3827 00001DF6 66AB                    	stosw		; interpolated sample 1 (R)
  3828 00001DF8 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  3829 00001DFA 2C80                    	sub	al, 80h
  3830 00001DFC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3831 00001E00 66AB                    	stosw		; interpolated sample 2 (L)
  3832 00001E02 66AB                    	stosw		; interpolated sample 2 (R)
  3833 00001E04 88D8                    	mov	al, bl
  3834 00001E06 00D0                    	add	al, dl	; [next_val]
  3835 00001E08 D0D8                    	rcr	al, 1
  3836 00001E0A 2C80                    	sub	al, 80h
  3837 00001E0C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3838 00001E10 66AB                    	stosw		; interpolated sample 3 (L)
  3839 00001E12 66AB                    	stosw		; interpolated sample 3 (R)
  3840 00001E14 C3                      	retn
  3841                                  
  3842                                  interpolating_4_8bit_stereo:
  3843                                  	; 17/11/2023
  3844                                  	; al = [previous_val_l]
  3845                                  	; ah = [previous_val_r]
  3846                                  	; dl = [next_val_l]
  3847                                  	; dh = [next_val_r]	
  3848                                  	; original-interpolated-interpolated-interpolated
  3849 00001E15 89C3                    	mov	ebx, eax
  3850 00001E17 2C80                    	sub	al, 80h
  3851 00001E19 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3852 00001E1D 66AB                    	stosw		; original sample (L)
  3853 00001E1F 88F8                    	mov	al, bh
  3854 00001E21 2C80                    	sub	al, 80h
  3855 00001E23 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3856 00001E27 66AB                    	stosw		; original sample (R)
  3857 00001E29 88D8                    	mov	al, bl
  3858 00001E2B 00D0                    	add	al, dl	; [next_val_l]
  3859 00001E2D D0D8                    	rcr	al, 1
  3860 00001E2F 86D8                    	xchg	al, bl	; al = [previous_val_l]
  3861 00001E31 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  3862 00001E33 D0D8                    	rcr	al, 1
  3863 00001E35 2C80                    	sub	al, 80h
  3864 00001E37 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3865 00001E3B 66AB                    	stosw		; interpolated sample 1 (L)
  3866 00001E3D 88F8                    	mov	al, bh
  3867 00001E3F 00F0                    	add	al, dh	; [next_val_r]
  3868 00001E41 D0D8                    	rcr	al, 1
  3869 00001E43 86F8                    	xchg	al, bh	; al = [previous_val_h]
  3870 00001E45 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  3871 00001E47 D0D8                    	rcr	al, 1
  3872 00001E49 2C80                    	sub	al, 80h
  3873 00001E4B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3874 00001E4F 66AB                    	stosw		; interpolated sample 1 (R)
  3875 00001E51 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  3876 00001E53 2C80                    	sub	al, 80h
  3877 00001E55 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3878 00001E59 66AB                    	stosw		; interpolated sample 2 (L)
  3879 00001E5B 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  3880 00001E5D 2C80                    	sub	al, 80h
  3881 00001E5F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3882 00001E63 66AB                    	stosw		; interpolated sample 2 (L)
  3883 00001E65 88D8                    	mov	al, bl
  3884 00001E67 00D0                    	add	al, dl	; [next_val_l]
  3885 00001E69 D0D8                    	rcr	al, 1
  3886 00001E6B 2C80                    	sub	al, 80h
  3887 00001E6D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3888 00001E71 66AB                    	stosw		; interpolated sample 3 (L)
  3889 00001E73 88F8                    	mov	al, bh
  3890 00001E75 00F0                    	add	al, dh	; [next_val_r]
  3891 00001E77 D0D8                    	rcr	al, 1
  3892 00001E79 2C80                    	sub	al, 80h
  3893 00001E7B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3894 00001E7F 66AB                    	stosw		; interpolated sample 3 (R)
  3895 00001E81 C3                      	retn
  3896                                  
  3897                                  interpolating_5_16bit_mono:
  3898                                  	; 18/11/2023
  3899                                  	; ax = [previous_val]
  3900                                  	; dx = [next_val]
  3901                                  	; original-interpltd-interpltd-interpltd-interpltd
  3902 00001E82 66AB                    	stosw		; original sample (L)
  3903 00001E84 66AB                    	stosw		; original sample (R)
  3904 00001E86 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3905 00001E89 89C3                    	mov	ebx, eax ; [previous_val]
  3906 00001E8B 80C680                  	add	dh, 80h
  3907 00001E8E 6601D0                  	add	ax, dx
  3908 00001E91 66D1D8                  	rcr	ax, 1
  3909 00001E94 50                      	push	eax ; *	; interpolated middle (temporary)
  3910 00001E95 6601D8                  	add	ax, bx	; interpolated middle + [previous_val] 
  3911 00001E98 66D1D8                  	rcr	ax, 1
  3912 00001E9B 50                      	push	eax ; **	; interpolated 1st quarter (temporary)
  3913 00001E9C 6601D8                  	add	ax, bx	; 1st quarter + [previous_val]
  3914 00001E9F 66D1D8                  	rcr	ax, 1	
  3915 00001EA2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3916 00001EA5 66AB                    	stosw 		; interpolated sample 1 (L)
  3917 00001EA7 66AB                    	stosw		; interpolated sample 1 (R)
  3918 00001EA9 58                      	pop	eax ; **	
  3919 00001EAA 5B                      	pop	ebx ; *
  3920 00001EAB 6601D8                  	add	ax, bx	; 1st quarter + middle
  3921 00001EAE 66D1D8                  	rcr	ax, 1	; / 2
  3922 00001EB1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  3923 00001EB4 66AB                    	stosw		; interpolated sample 2 (L)
  3924 00001EB6 66AB                    	stosw		; interpolated sample 2 (R)		
  3925 00001EB8 89D8                    	mov	eax, ebx
  3926 00001EBA 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  3927 00001EBD 66D1D8                  	rcr	ax, 1
  3928 00001EC0 50                      	push	eax ; *	; interpolated 3rd quarter (temporary)
  3929 00001EC1 6601D8                  	add	ax, bx	; + interpolated middle
  3930 00001EC4 66D1D8                  	rcr	ax, 1
  3931 00001EC7 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3932 00001ECA 66AB                    	stosw		; interpolated sample 3 (L)
  3933 00001ECC 66AB                    	stosw		; interpolated sample 3 (R)
  3934 00001ECE 58                      	pop	eax ; *	
  3935 00001ECF 6601D0                  	add	ax, dx	; 3rd quarter + [next_val]
  3936 00001ED2 66D1D8                  	rcr	ax, 1	; / 2
  3937 00001ED5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3938 00001ED8 66AB                    	stosw		; interpolated sample 4 (L)
  3939 00001EDA 66AB                    	stosw		; interpolated sample 4 (R)
  3940 00001EDC C3                      	retn
  3941                                  
  3942                                  interpolating_5_16bit_stereo:
  3943                                  	; 18/11/2023
  3944                                  	; bx = [previous_val_l]
  3945                                  	; ax = [previous_val_r]
  3946                                  	; [next_val_l]
  3947                                  	; [next_val_r]
  3948                                  	; original-interpltd-interpltd-interpltd-interpltd
  3949 00001EDD 51                      	push	ecx ; !
  3950 00001EDE 93                      	xchg	eax, ebx
  3951 00001EDF 66AB                    	stosw		; original sample (L)
  3952 00001EE1 93                      	xchg	eax, ebx
  3953 00001EE2 66AB                    	stosw		; original sample (R)
  3954 00001EE4 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3955 00001EE7 50                      	push	eax ; *	; [previous_val_r]
  3956 00001EE8 80C780                  	add	bh, 80h
  3957 00001EEB 8005[67200000]80        	add	byte [next_val_l+1], 80h
  3958 00001EF2 66A1[66200000]          	mov	ax, [next_val_l]
  3959 00001EF8 6601D8                  	add	ax, bx	; [previous_val_l]
  3960 00001EFB 66D1D8                  	rcr	ax, 1
  3961 00001EFE 89C1                    	mov	ecx, eax ; interpolated middle (L)
  3962 00001F00 6601D8                  	add	ax, bx	
  3963 00001F03 66D1D8                  	rcr	ax, 1
  3964 00001F06 89C2                    	mov	edx, eax ; interpolated 1st quarter (L)	
  3965 00001F08 6601D8                  	add	ax, bx	; [previous_val_l]
  3966 00001F0B 66D1D8                  	rcr	ax, 1
  3967 00001F0E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3968 00001F11 66AB                    	stosw 		; interpolated sample 1 (L)
  3969 00001F13 89C8                    	mov	eax, ecx
  3970 00001F15 6601D0                  	add	ax, dx	; middle (L) + 1st quarter (L) 
  3971 00001F18 66D1D8                  	rcr	ax, 1	; / 2
  3972 00001F1B 89C3                    	mov	ebx, eax  ; interpolated sample 2 (L)
  3973 00001F1D 5A                      	pop	edx ; *	; [previous_val_r]
  3974 00001F1E 89D0                    	mov	eax, edx
  3975 00001F20 8005[69200000]80        	add	byte [next_val_r+1], 80h
  3976 00001F27 660305[68200000]        	add	ax, [next_val_r]
  3977 00001F2E 66D1D8                  	rcr	ax, 1
  3978 00001F31 50                      	push	eax ; *	; interpolated middle (R)
  3979 00001F32 6601D0                  	add	ax, dx
  3980 00001F35 66D1D8                  	rcr	ax, 1
  3981 00001F38 50                      	push	eax ; ** ; interpolated 1st quarter (R)
  3982 00001F39 6601D0                  	add	ax, dx	; [previous_val_r]
  3983 00001F3C 66D1D8                  	rcr	ax, 1
  3984 00001F3F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3985 00001F42 66AB                    	stosw 		; interpolated sample 1 (R)
  3986 00001F44 89D8                    	mov	eax, ebx
  3987 00001F46 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3988 00001F49 66AB                    	stosw 		; interpolated sample 2 (L)
  3989 00001F4B 58                      	pop	eax ; **
  3990 00001F4C 5A                      	pop	edx ; *
  3991 00001F4D 6601D0                  	add	ax, dx	; 1st quarter (R) + middle (R)
  3992 00001F50 66D1D8                  	rcr	ax, 1	; / 2
  3993 00001F53 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3994 00001F56 66AB                    	stosw 		; interpolated sample 2 (R)
  3995 00001F58 89C8                    	mov	eax, ecx
  3996 00001F5A 660305[66200000]        	add	ax, [next_val_l]
  3997 00001F61 66D1D8                  	rcr	ax, 1
  3998 00001F64 50                      	push	eax ; * ; interpolated 3rd quarter (L)
  3999 00001F65 6601C8                  	add	ax, cx	; interpolated middle (L)
  4000 00001F68 66D1D8                  	rcr	ax, 1
  4001 00001F6B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4002 00001F6E 66AB                    	stosw 		; interpolated sample 3 (L)
  4003 00001F70 89D0                    	mov	eax, edx
  4004 00001F72 660305[68200000]        	add	ax, [next_val_r]
  4005 00001F79 66D1D8                  	rcr	ax, 1
  4006 00001F7C 50                      	push	eax ; ** ; interpolated 3rd quarter (R)
  4007 00001F7D 6601D0                  	add	ax, dx	; interpolated middle (R)
  4008 00001F80 66D1D8                  	rcr	ax, 1
  4009 00001F83 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4010 00001F86 66AB                    	stosw 		; interpolated sample 3 (R)
  4011 00001F88 5B                      	pop	ebx ; **
  4012 00001F89 58                      	pop	eax ; *
  4013 00001F8A 660305[66200000]        	add	ax, [next_val_l]
  4014 00001F91 66D1D8                  	rcr	ax, 1
  4015 00001F94 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4016 00001F97 66AB                    	stosw 		; interpolated sample 4 (L)
  4017 00001F99 89D8                    	mov	eax, ebx	
  4018 00001F9B 660305[68200000]        	add	ax, [next_val_r]
  4019 00001FA2 66D1D8                  	rcr	ax, 1
  4020 00001FA5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4021 00001FA8 66AB                    	stosw 		; interpolated sample 4 (R)
  4022 00001FAA 59                      	pop	ecx ; !
  4023 00001FAB C3                      	retn
  4024                                  
  4025                                  interpolating_4_16bit_mono:
  4026                                  	; 18/11/2023
  4027                                  	; ax = [previous_val]
  4028                                  	; dx = [next_val]
  4029                                  	; original-interpolated
  4030                                  
  4031 00001FAC 66AB                    	stosw		; original sample (L)
  4032 00001FAE 66AB                    	stosw		; original sample (R)
  4033 00001FB0 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4034 00001FB3 89C3                    	mov	ebx, eax ; [previous_val]
  4035 00001FB5 80C680                  	add	dh, 80h
  4036 00001FB8 6601D0                  	add	ax, dx	; [previous_val] + [next_val]
  4037 00001FBB 66D1D8                  	rcr	ax, 1
  4038 00001FBE 93                      	xchg	eax, ebx	
  4039 00001FBF 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  4040 00001FC2 66D1D8                  	rcr	ax, 1
  4041 00001FC5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4042 00001FC8 66AB                    	stosw 		; interpolated sample 1 (L)
  4043 00001FCA 66AB                    	stosw		; interpolated sample 1 (R)
  4044 00001FCC 89D8                    	mov	eax, ebx ; interpolated middle
  4045 00001FCE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4046 00001FD1 66AB                    	stosw 		; interpolated sample 2 (L)
  4047 00001FD3 66AB                    	stosw		; interpolated sample 2 (R)
  4048 00001FD5 89D8                    	mov	eax, ebx
  4049 00001FD7 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4050 00001FDA 66D1D8                  	rcr	ax, 1
  4051 00001FDD 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4052 00001FE0 66AB                    	stosw		; interpolated sample 3 (L)
  4053 00001FE2 66AB                    	stosw		; interpolated sample 3 (R)
  4054 00001FE4 C3                      	retn
  4055                                  
  4056                                  interpolating_4_16bit_stereo:
  4057                                  	; 18/11/2023
  4058                                  	; bx = [previous_val_l]
  4059                                  	; ax = [previous_val_r]
  4060                                  	; [next_val_l]
  4061                                  	; [next_val_r]
  4062                                  	; original-interpolated-interpolated-interpolated
  4063 00001FE5 93                      	xchg	eax, ebx
  4064 00001FE6 66AB                    	stosw		; original sample (L)
  4065 00001FE8 93                      	xchg	eax, ebx
  4066 00001FE9 66AB                    	stosw		; original sample (R)
  4067 00001FEB 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4068 00001FEE 89C2                    	mov	edx, eax ; [previous_val_r]
  4069 00001FF0 80C780                  	add	bh, 80h
  4070 00001FF3 8005[67200000]80        	add	byte [next_val_l+1], 80h
  4071 00001FFA 66A1[66200000]          	mov	ax, [next_val_l]
  4072 00002000 6601D8                  	add	ax, bx	; [previous_val_l]
  4073 00002003 66D1D8                  	rcr	ax, 1
  4074 00002006 93                      	xchg	eax, ebx	
  4075 00002007 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  4076 0000200A 66D1D8                  	rcr	ax, 1
  4077 0000200D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4078 00002010 66AB                    	stosw 		; interpolated sample 1 (L)
  4079 00002012 8005[69200000]80        	add	byte [next_val_r+1], 80h
  4080 00002019 89D0                    	mov	eax, edx ; [previous_val_r]
  4081 0000201B 660305[68200000]        	add	ax, [next_val_r]
  4082 00002022 66D1D8                  	rcr	ax, 1
  4083 00002025 92                      	xchg	eax, edx	
  4084 00002026 6601D0                  	add	ax, dx	; dx = interpolated middle (R)
  4085 00002029 66D1D8                  	rcr	ax, 1
  4086 0000202C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4087 0000202F 66AB                    	stosw 		; interpolated sample 1 (R)
  4088 00002031 89D8                    	mov	eax, ebx
  4089 00002033 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4090 00002036 66AB                    	stosw 		; interpolated sample 2 (L)
  4091 00002038 89D0                    	mov	eax, edx
  4092 0000203A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4093 0000203D 66AB                    	stosw 		; interpolated sample 2 (R)
  4094 0000203F 89D8                    	mov	eax, ebx
  4095 00002041 660305[66200000]        	add	ax, [next_val_l]
  4096 00002048 66D1D8                  	rcr	ax, 1
  4097 0000204B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4098 0000204E 66AB                    	stosw 		; interpolated sample 3 (L)
  4099 00002050 89D0                    	mov	eax, edx
  4100 00002052 660305[68200000]        	add	ax, [next_val_r]
  4101 00002059 66D1D8                  	rcr	ax, 1
  4102 0000205C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4103 0000205F 66AB                    	stosw 		; interpolated sample 3 (R)
  4104 00002061 C3                      	retn
  4105                                  
  4106                                  ; 13/11/2023
  4107                                  previous_val:
  4108 00002062 0000                    previous_val_l: dw 0
  4109 00002064 0000                    previous_val_r: dw 0
  4110                                  next_val:
  4111 00002066 0000                    next_val_l: dw 0
  4112 00002068 0000                    next_val_r: dw 0
  4113                                  
  4114                                  ; 16/11/2023
  4115 0000206A 00                      faz:	db 0	
  4116                                  	
  4117                                  ; --------------------------------------------------------
  4118                                  
  4119                                  ; DATA
  4120                                  
  4121                                  FileHandle:	
  4122 0000206B FFFFFFFF                	dd	-1
  4123                                  
  4124                                  Credits:
  4125 0000206F 54696E792057415620-     	db	'Tiny WAV Player for TRDOS 386 by Erdogan Tan. '
  4125 00002078 506C6179657220666F-
  4125 00002081 72205452444F532033-
  4125 0000208A 383620627920457264-
  4125 00002093 6F67616E2054616E2E-
  4125 0000209C 20                 
  4126                                  	;;;db	'August 2020.',10,13,0
  4127                                  	;;db	'November 2023.',10,13,0
  4128                                  	;db	'June 2024.', 10,13,0
  4129 0000209D 446563656D62657220-     	db	'December 2024.', 10,13,0
  4129 000020A6 323032342E0A0D00   
  4130 000020AE 31372F30362F323031-     	db	'17/06/2017', 10,13,0
  4130 000020B7 370A0D00           
  4131 000020BB 31382F30382F323032-     	db	'18/08/2020', 10,13,0
  4131 000020C4 300A0D00           
  4132 000020C8 32372F31312F323032-     	db	'27/11/2023', 10,13,0
  4132 000020D1 330A0D00           
  4133 000020D5 30312F30362F323032-     	db	'01/06/2024', 10,13,0
  4133 000020DE 340A0D00           
  4134 000020E2 30382F31322F323032-     	db	'08/12/2024', 10,13,0
  4134 000020EB 340A0D00           
  4135                                  
  4136                                  msgAudioCardInfo:
  4137 000020EF 666F7220496E74656C-     	db 	'for Intel AC97 (ICH) Audio Controller.', 10,13,0
  4137 000020F8 204143393720284943-
  4137 00002101 482920417564696F20-
  4137 0000210A 436F6E74726F6C6C65-
  4137 00002113 722E0A0D00         
  4138                                  
  4139                                  msg_usage:
  4140 00002118 75736167653A20706C-     	db	'usage: playwav6 filename.wav',10,13,0
  4140 00002121 617977617636206669-
  4140 0000212A 6C656E616D652E7761-
  4140 00002133 760A0D00           
  4141                                  
  4142                                  noDevMsg:
  4143 00002137 4572726F723A20556E-     	db	'Error: Unable to find AC97 audio device!'
  4143 00002140 61626C6520746F2066-
  4143 00002149 696E64204143393720-
  4143 00002152 617564696F20646576-
  4143 0000215B 69636521           
  4144 0000215F 0A0D00                  	db	10,13,0
  4145                                  
  4146                                  noFileErrMsg:
  4147 00002162 4572726F723A206669-     	db	'Error: file not found.',10,13,0
  4147 0000216B 6C65206E6F7420666F-
  4147 00002174 756E642E0A0D00     
  4148                                  
  4149                                  trdos386_err_msg:
  4150 0000217B 5452444F5320333836-     	db	'TRDOS 386 System call error !',10,13,0
  4150 00002184 2053797374656D2063-
  4150 0000218D 616C6C206572726F72-
  4150 00002196 20210A0D00         
  4151                                  
  4152                                  ; 01/06/2024
  4153                                  msg_init_err:
  4154 0000219B 0A0D                    	db	10,13
  4155 0000219D 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  4155 000021A6 726F6C6C65722F436F-
  4155 000021AF 64656320696E697469-
  4155 000021B8 616C697A6174696F6E-
  4155 000021C1 206572726F722021   
  4156 000021C9 0A0D00                  	db	10,13,0
  4157                                  
  4158                                  ; 25/11/2023
  4159                                  msg_no_vra:
  4160 000021CC 0A0D                    	db	10,13
  4161 000021CE 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  4161 000021D7 70706F72742021204F-
  4161 000021E0 6E6C79203438206B48-
  4161 000021E9 5A2073616D706C6520-
  4161 000021F2 726174652073757070-
  4161 000021FB 6F727465642021     
  4162 00002202 0A0D00                  	db	10,13,0
  4163                                  
  4164 00002205 0D0A5741562046696C-     msgWavFileName:	db 0Dh, 0Ah, "WAV File Name: ",0
  4164 0000220E 65204E616D653A2000 
  4165 00002217 0D0A53616D706C6520-     msgSampleRate:	db 0Dh, 0Ah, "Sample Rate: "
  4165 00002220 526174653A20       
  4166 00002226 303030303020487A2C-     msgHertz:	db "00000 Hz, ", 0 
  4166 0000222F 2000               
  4167 00002231 3820626974732C2000      msg8Bits:	db "8 bits, ", 0 
  4168 0000223A 4D6F6E6F0D0A00          msgMono:	db "Mono", 0Dh, 0Ah, 0
  4169 00002241 313620626974732C20-     msg16Bits:	db "16 bits, ", 0 
  4169 0000224A 00                 
  4170 0000224B 53746572656F            msgStereo:	db "Stereo"
  4171 00002251 0D0A00                  nextline:	db 0Dh, 0Ah, 0
  4172                                  
  4173                                  ; 03/06/2017
  4174 00002254 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  4174 0000225D 3941424344454600   
  4175 00002265 0D0A                    msgAC97Info	db 0Dh, 0Ah
  4176 00002267 414339372041756469-     		db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  4176 00002270 6F20436F6E74726F6C-
  4176 00002279 6C6572202620436F64-
  4176 00002282 656320496E666F0D0A 
  4177 0000228B 56656E646F72204944-     		db "Vendor ID: "
  4177 00002294 3A20               
  4178 00002296 303030306820446576-     msgVendorId	db "0000h Device ID: "
  4178 0000229F 6963652049443A20   
  4179 000022A7 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  4180 000022AE 4275733A20              		db "Bus: "
  4181 000022B3 303068204465766963-     msgBusNo	db "00h Device: "
  4181 000022BC 653A20             
  4182 000022BF 3030682046756E6374-     msgDevNo	db "00h Function: "
  4182 000022C8 696F6E3A20         
  4183 000022CD 303068                  msgFncNo	db "00h"
  4184 000022D0 0D0A                    		db 0Dh, 0Ah
  4185 000022D2 4E414D4241523A20        		db "NAMBAR: "
  4186 000022DA 30303030682020          msgNamBar	db "0000h  "
  4187 000022E1 4E41424D4241523A20      		db "NABMBAR: "
  4188 000022EA 303030306820204952-     msgNabmBar	db "0000h  IRQ: "
  4188 000022F3 513A20             
  4189 000022F6 3030                    msgIRQ		dw 3030h
  4190 000022F8 0D0A00                  		db 0Dh, 0Ah, 0
  4191                                  ; 25/11/2023
  4192 000022FB 56524120737570706F-     msgVRAheader:	db "VRA support: "
  4192 00002304 72743A20           
  4193 00002308 00                      		db 0	
  4194 00002309 5945530D0A00            msgVRAyes:	db "YES", 0Dh, 0Ah, 0
  4195 0000230F 4E4F200D0A              msgVRAno:	db "NO ", 0Dh, 0Ah
  4196 00002314 28496E746572706F6C-     		db "(Interpolated sample rate playing method)"
  4196 0000231D 617465642073616D70-
  4196 00002326 6C6520726174652070-
  4196 0000232F 6C6179696E67206D65-
  4196 00002338 74686F6429         
  4197 0000233D 0D0A00                  		db 0Dh, 0Ah, 0	
  4198                                  EOF: 
  4199                                  
  4200                                  ; BSS
  4201                                  
  4202                                  bss_start:
  4203                                  
  4204                                  ABSOLUTE bss_start
  4205                                  
  4206                                  alignb 4
  4207                                  
  4208 00002340 ??                      stmo:		resb 1 ; stereo or mono (1=stereo) 
  4209 00002341 ??                      bps:		resb 1 ; bits per sample (8,16)
  4210 00002342 ????                    sample_rate:	resw 1 ; Sample Frequency (Hz)
  4211                                  
  4212                                  ; 25/11/2023
  4213 00002344 ????????                bufferSize:	resd 1
  4214                                  
  4215 00002348 ??                      flags:		resb 1
  4216                                  ;cbs_busy:	resb 1 
  4217 00002349 ??                      half_buff:	resb 1
  4218 0000234A ??                      srb:		resb 1
  4219                                  ; 18/08/2020
  4220 0000234B ??                      volume_level:	resb 1
  4221                                  ; 25/11/2023
  4222 0000234C ??                      VRA:		resb 1	; Variable Rate Audio Support Status
  4223                                  
  4224 0000234D <res 1Ch>               smpRBuff:	resw 14 
  4225                                  
  4226                                  wav_file_name:
  4227 00002369 <res 50h>               		resb 80 ; wave file, path name (<= 80 bytes)
  4228                                  
  4229 000023B9 ????                    		resw 1
  4230 000023BB ??                      ac97_int_ln_reg: resb 1
  4231 000023BC ??                      fbs_shift:	resb 1 ; 26/11/2023
  4232 000023BD ????????                dev_vendor:	resd 1
  4233 000023C1 ????????                bus_dev_fn:	resd 1
  4234 000023C5 ????                    ac97_NamBar:	resw 1
  4235 000023C7 ????                    ac97_NabmBar:	resw 1
  4236                                  
  4237                                  bss_end:
  4238 000023C9 <res C37h>              alignb 4096
  4239                                  ;audio_buffer:	resb BUFFERSIZE ; DMA Buffer Size / 2 (32768)
  4240                                  ; 26/11/2023
  4241 00003000 <res 10000h>            audio_buffer:	resb 65536
  4242                                  ; 13/06/2017
  4243                                  ;temp_buffer:	resb BUFFERSIZE
  4244                                  ; 26/11/2023
  4245 00013000 <res 10000h>            temp_buffer:	resb 65536
