     1                                  ; ****************************************************************************
     2                                  ; twavply2.s (for TRDOS 386)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; TWAVPLY2.PRG ! AC'97 (ICH) WAV PLAYER & VGA DEMO program by Erdogan TAN
     5                                  ;
     6                                  ; 09/12/2023
     7                                  ;
     8                                  ; [ Last Modification: 27/12/2024 ]
     9                                  ;
    10                                  ; Modified from: twavplay.s (VIA VT8237R WAV PLAYER & VGA DEMO) program
    11                                  ;	         by Erdogan Tan (24/08/2020) 
    12                                  ;
    13                                  ; Modified from: 'playwav6.s' (AC'97 WAV player) source code
    14                                  ;		 by Erdogan Tan (27/11/2023)
    15                                  ; 
    16                                  ; Assembler: NASM 2.15
    17                                  ; ----------------------------------------------------------------------------
    18                                  ;	   nasm  twavplay.s -l twavplay.txt -o TWAVPLAY.PRG	
    19                                  ; ****************************************************************************
    20                                  
    21                                  ; 09/12/2023
    22                                  ; Modified from: twavplay.s (VIA VT8237R WAV PLAYER & VGA DEMO) program
    23                                  ;	         by Erdogan Tan (24/08/2020)
    24                                  
    25                                  ; 14/07/2020
    26                                  ; 31/12/2017
    27                                  ; TRDOS 386 (v2.0) system calls
    28                                  _ver 	equ 0
    29                                  _exit 	equ 1
    30                                  _fork 	equ 2
    31                                  _read 	equ 3
    32                                  _write	equ 4
    33                                  _open	equ 5
    34                                  _close 	equ 6
    35                                  _wait 	equ 7
    36                                  _create	equ 8
    37                                  _rename	equ 9
    38                                  _delete	equ 10
    39                                  _exec	equ 11
    40                                  _chdir	equ 12
    41                                  _time 	equ 13
    42                                  _mkdir 	equ 14
    43                                  _chmod	equ 15
    44                                  _rmdir	equ 16
    45                                  _break	equ 17
    46                                  _drive	equ 18
    47                                  _seek	equ 19
    48                                  _tell 	equ 20
    49                                  _memory	equ 21
    50                                  _prompt	equ 22
    51                                  _path	equ 23
    52                                  _env	equ 24
    53                                  _stime	equ 25
    54                                  _quit	equ 26
    55                                  _intr	equ 27
    56                                  _dir	equ 28
    57                                  _emt 	equ 29
    58                                  _ldrvt 	equ 30
    59                                  _video 	equ 31
    60                                  _audio	equ 32
    61                                  _timer	equ 33
    62                                  _sleep	equ 34
    63                                  _msg    equ 35
    64                                  _geterr	equ 36
    65                                  _fpstat	equ 37
    66                                  _pri	equ 38
    67                                  _rele	equ 39
    68                                  _fff	equ 40
    69                                  _fnf	equ 41
    70                                  _alloc	equ 42
    71                                  _dalloc equ 43
    72                                  _calbac equ 44
    73                                  _dma	equ 45		
    74                                  
    75                                  %macro sys 1-4
    76                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)	
    77                                      ; 03/09/2015	
    78                                      ; 13/04/2015
    79                                      ; Retro UNIX 386 v1 system call.	
    80                                      %if %0 >= 2   
    81                                          mov ebx, %2
    82                                          %if %0 >= 3    
    83                                              mov ecx, %3
    84                                              %if %0 = 4
    85                                                 mov edx, %4   
    86                                              %endif
    87                                          %endif
    88                                      %endif
    89                                      mov eax, %1
    90                                      ;int 30h
    91                                      int 40h ; TRDOS 386 (TRDOS v2.0)	   
    92                                  %endmacro
    93                                  
    94                                  ; TRDOS 386 (and Retro UNIX 386 v1) system call format:
    95                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
    96                                  
    97                                  ; 19/06/2017
    98                                  BUFFERSIZE equ 32768
    99                                  ; 23/08/2020
   100                                  ENDOFFILE equ 1	; flag for knowing end of file
   101                                  
   102                                  ; ----------------------------------------------------------------------------
   103                                  ; Tiny MOD Player v0.1b by Carlos Hasan.
   104                                  ;	July 14th, 1993.
   105                                  
   106                                  ;=============================================================================
   107                                  ;  
   108                                  ;=============================================================================
   109                                  
   110                                  [BITS 32]
   111                                  [org 0]
   112                                  
   113                                  Start:
   114                                  	; clear bss
   115 00000000 B9[00000500]            	mov	ecx, EOF
   116 00000005 BF[EA670000]            	mov	edi, bss_start
   117 0000000A 29F9                    	sub	ecx, edi
   118 0000000C D1E9                    	shr	ecx, 1
   119 0000000E 31C0                    	xor	eax, eax
   120 00000010 F366AB                  	rep	stosw
   121                                  
   122                                  	; 09/12/2023
   123                                  	; Detect (& Enable) AC'97 Audio Device
   124 00000013 E8CE040000              	call	DetectAC97
   125 00000018 731B                    	jnc     short GetFileName
   126                                  
   127                                  _dev_not_ready:
   128                                  ; couldn't find the audio device!
   129                                  	sys	_msg, noDevMsg, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000001A BB[12660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000001F B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000024 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000029 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 0000002E CD40                <1>  int 40h
   130 00000030 E98B040000                      jmp     Exit
   131                                  
   132                                  GetFileName:
   133 00000035 89E6                    	mov	esi, esp
   134 00000037 AD                      	lodsd
   135 00000038 83F802                  	cmp	eax, 2 ; two arguments 
   136                                  		; (program file name & mod file name)
   137                                  	;jb	pmsg_usage ; nothing to do
   138                                  	; 09/12/2023
   139 0000003B 7305                    	jnb	short _x
   140 0000003D E98C040000              	jmp	pmsg_usage
   141                                  
   142                                  _x:
   143 00000042 AD                      	lodsd ; program file name address 
   144 00000043 AD                      	lodsd ; wav file name address (file to be read)
   145 00000044 89C6                    	mov	esi, eax
   146 00000046 BF[20680000]            	mov	edi, wav_file_name
   147                                  ScanName:       
   148 0000004B AC                      	lodsb
   149 0000004C 84C0                    	test	al, al
   150                                  	;jz	pmsg_usage
   151                                  	; 09/12/2023
   152 0000004E 7505                    	jnz	short _y
   153 00000050 E979040000              	jmp	pmsg_usage
   154                                  _y:
   155 00000055 3C20                    	cmp	al, 20h
   156 00000057 74F2                    	je	short ScanName	; scan start of name.
   157 00000059 AA                      	stosb
   158 0000005A B4FF                    	mov	ah, 0FFh
   159                                  a_0:	
   160 0000005C FEC4                    	inc	ah
   161                                  a_1:
   162 0000005E AC                      	lodsb
   163 0000005F AA                      	stosb
   164 00000060 3C2E                    	cmp	al, '.'
   165 00000062 74F8                    	je	short a_0	
   166 00000064 20C0                    	and	al, al
   167 00000066 75F6                    	jnz	short a_1
   168                                  
   169 00000068 08E4                    	or	ah, ah		 ; if period NOT found,
   170 0000006A 750B                    	jnz	short PrintPMesg ; then add a .MOD extension.
   171                                  SetExt:
   172 0000006C 4F                      	dec	edi
   173 0000006D C7072E574156            	mov	dword [edi], '.WAV'
   174 00000073 C6470400                	mov	byte [edi+4], 0
   175                                  PrintPMesg: 
   176                                  	; 23/08/2020
   177 00000077 C605[BD650000]00        	mov	byte [credits_zero], 0
   178                                       
   179                                  	; Prints the Credits Text.
   180                                  	sys	_msg, Credits, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000007E BB[58650000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000083 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000088 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000008D B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000092 CD40                <1>  int 40h
   181                                  _1:
   182                                  	; 19/06/2017
   183                                  	; Allocate Audio Buffer (for user)
   184                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   185                                  	; 09/12/2023
   186                                  	sys	_audio, 0200h, [buffersize], audio_buffer
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000094 BB00020000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000099 8B0D[E1030000]      <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000009F BA[00800000]        <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000A4 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000000A9 CD40                <1>  int 40h
   187 000000AB 7218                    	jc	short error_exit
   188                                  _2:
   189                                  	; 23/08/2020
   190                                  	; Initialize Audio Device (bl = 1 -> Interrupt method)
   191                                  	;sys	_audio, 0301h, 0, audio_int_handler 
   192                                  	;jc	short error_exit
   193                                  	
   194                                  	; 24/08/2020
   195                                  
   196                                  	; 20/10/2017
   197                                  	; Initialize Audio Device (bl = 0 -> SRB method)
   198                                  	sys	_audio, 0300h, 1, srb
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000000AD BB00030000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000000B2 B901000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000000B7 BA[81680000]        <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000BC B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000000C1 CD40                <1>  int 40h
   199                                  	;jc	short error_exit
   200                                  	; 09/12/2023
   201 000000C3 731B                    	jnc	short open_wav_file
   202                                  
   203                                  error_exit:
   204                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000000C5 BB[56660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000000CA B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000000CF BA0E000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000D4 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000000D9 CD40                <1>  int 40h
   205 000000DB E9E0030000              	jmp	Exit
   206                                  
   207                                  	; 09/12/2023
   208                                  open_wav_file:
   209                                  	; 23/08/2020
   210                                  
   211                                  ; open the wav file
   212                                          ; open existing file
   213 000000E0 E823040000                      call    openFile ; no error? ok.
   214 000000E5 731B                            jnc     short _3
   215                                  
   216                                  ; file not found!
   217                                  	sys	_msg, noFileErrMsg, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000000E7 BB[3D660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000000EC B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000000F1 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000F6 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000000FB CD40                <1>  int 40h
   218                                  _z:
   219 000000FD E9BE030000                      jmp	Exit
   220                                  
   221                                  _3:
   222 00000102 E83B040000                     	call    getSampleRate	; read the sample rate
   223                                                               	; pass it onto codec.
   224                                  	;jc	Exit
   225                                  	; 09/12/2023
   226 00000107 72F4                    	jc	short _z
   227                                  
   228 00000109 66A3[FE670000]          	mov	[sample_rate], ax
   229 0000010F 880D[FC670000]          	mov	[stmo], cl
   230 00000115 8815[FD670000]          	mov	[bps], dl
   231                                  
   232                                  	; 09/12/2023
   233                                  	; 'playwav6.s (27/11/2023)
   234                                  	
   235                                  	; 26/11/2023
   236 0000011B C605[73680000]00        	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit
   237 00000122 FEC9                    	dec	cl
   238 00000124 7506                    	jnz	short _gsr_1 ; stereo
   239 00000126 FE05[73680000]          	inc	byte [fbs_shift] ; 1 = mono or 8 bit
   240                                  _gsr_1:	
   241 0000012C 80FA08                  	cmp	dl, 8 
   242 0000012F 7706                    	ja	short _gsr_2 ; 16 bit samples
   243 00000131 FE05[73680000]          	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   244                                  _gsr_2:
   245                                  
   246                                  	; 10/06/2017
   247                                  	sys	_audio, 0E00h ; get audio controller info
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000137 BB000E0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000013C B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000141 CD40                <1>  int 40h
   248                                  	;jc	error_exit
   249                                  	; 09/12/2023
   250 00000143 7280                    	jc	short error_exit
   251                                  
   252                                  	; 09/12/2023
   253                                  	;cmp	ah, 2 ; ICH ? (Intel AC'97 Audio Controller)
   254                                  	;jne	_dev_not_ready		
   255                                  
   256                                  	; EAX = IRQ Number in AL
   257                                  	;	Audio Device Number in AH 
   258                                  	; EBX = DEV/VENDOR ID
   259                                  	;       (DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV)
   260                                  	; ECX = BUS/DEV/FN 
   261                                  	;       (00000000BBBBBBBBDDDDDFFF00000000)
   262                                  	; EDX = Base IO Addr (DX) for SB16 & VT8233
   263                                  	; EDX = NABMBAR/NAMBAR (for AC97)
   264                                  	;      (Low word, DX = NAMBAR address)
   265                                  
   266                                  	; 09/12/2023
   267 00000145 A2[72680000]            	mov	[ac97_int_ln_reg], al
   268 0000014A 891D[74680000]          	mov	[dev_vendor], ebx
   269 00000150 890D[78680000]          	mov	[bus_dev_fn], ecx
   270                                  	;mov	[ac97_NamBar], dx
   271                                  	;shr	dx, 16
   272                                  	;mov	[ac97_NabmBar], dx
   273 00000156 8915[7C680000]          	mov	[ac97_NamBar], edx	
   274                                  
   275                                  	; 09/12/2023  
   276 0000015C E800070000              	call	write_ac97_pci_dev_info
   277                                  	; 09/12/2023
   278 00000161 E8BB080000              	call	write_VRA_info
   279                                  
   280                                  	; 24/08/2020
   281 00000166 E82B060000              	call	write_wav_file_info
   282                                  
   283                                  ; 09/12/2023
   284                                  ; -----------------------------------
   285                                  ; 'playwav6.s' (27/11/2023)
   286                                  
   287 0000016B 803D[83680000]01        	cmp	byte [VRA], 1
   288 00000172 7205                    	jb	short chk_sample_rate
   289                                  
   290                                  playwav_48_khz:	
   291                                  	;mov	dword [loadfromwavfile], loadFromFile
   292                                  	;mov	dword [buffersize], 65536
   293 00000174 E96C020000              	jmp	PlayNow
   294                                  
   295                                  chk_sample_rate:
   296                                  	; set conversion parameters
   297                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   298 00000179 66A1[FE670000]          	mov	ax, [sample_rate]
   299 0000017F 663D80BB                	cmp	ax, 48000
   300 00000183 74EF                    	je	short playwav_48_khz
   301                                  chk_22khz:
   302 00000185 663D2256                	cmp	ax, 22050
   303 00000189 7545                    	jne	short chk_11khz
   304 0000018B 803D[FD670000]08        	cmp	byte [bps], 8
   305 00000192 7615                    	jna	short chk_22khz_1
   306 00000194 BB[A8160000]            	mov	ebx, load_22khz_stereo_16_bit
   307 00000199 803D[FC670000]01        	cmp	byte [stmo], 1 
   308 000001A0 751A                    	jne	short chk_22khz_2
   309 000001A2 BB[1B160000]            	mov	ebx, load_22khz_mono_16_bit
   310 000001A7 EB13                    	jmp	short chk_22khz_2
   311                                  chk_22khz_1:
   312 000001A9 BB[94150000]            	mov	ebx, load_22khz_stereo_8_bit
   313 000001AE 803D[FC670000]01        	cmp	byte [stmo], 1 
   314 000001B5 7505                    	jne	short chk_22khz_2
   315 000001B7 BB[0B150000]            	mov	ebx, load_22khz_mono_8_bit
   316                                  chk_22khz_2:
   317 000001BC B85A1D0000              	mov	eax, 7514  ; (442*17)
   318 000001C1 BA25000000              	mov	edx, 37
   319 000001C6 B911000000              	mov	ecx, 17 
   320 000001CB E9BA010000              	jmp	set_sizes	
   321                                  chk_11khz:
   322 000001D0 663D112B                	cmp	ax, 11025
   323 000001D4 7545                    	jne	short chk_44khz
   324 000001D6 803D[FD670000]08        	cmp	byte [bps], 8
   325 000001DD 7615                    	jna	short chk_11khz_1
   326 000001DF BB[C4180000]            	mov	ebx, load_11khz_stereo_16_bit
   327 000001E4 803D[FC670000]01        	cmp	byte [stmo], 1 
   328 000001EB 751A                    	jne	short chk_11khz_2
   329 000001ED BB[4B180000]            	mov	ebx, load_11khz_mono_16_bit
   330 000001F2 EB13                    	jmp	short chk_11khz_2
   331                                  chk_11khz_1:
   332 000001F4 BB[D1170000]            	mov	ebx, load_11khz_stereo_8_bit
   333 000001F9 803D[FC670000]01        	cmp	byte [stmo], 1 
   334 00000200 7505                    	jne	short chk_11khz_2
   335 00000202 BB[59170000]            	mov	ebx, load_11khz_mono_8_bit
   336                                  chk_11khz_2:
   337 00000207 B8AD0E0000              	mov	eax, 3757  ; (221*17)
   338 0000020C BA4A000000              	mov	edx, 74
   339 00000211 B911000000              	mov	ecx, 17
   340 00000216 E96F010000              	jmp	set_sizes 
   341                                  chk_44khz:
   342 0000021B 663D44AC                	cmp	ax, 44100
   343 0000021F 7545                    	jne	short chk_16khz
   344 00000221 803D[FD670000]08        	cmp	byte [bps], 8
   345 00000228 7615                    	jna	short chk_44khz_1
   346 0000022A BB[CB1A0000]            	mov	ebx, load_44khz_stereo_16_bit
   347 0000022F 803D[FC670000]01        	cmp	byte [stmo], 1 
   348 00000236 751A                    	jne	short chk_44khz_2
   349 00000238 BB[521A0000]            	mov	ebx, load_44khz_mono_16_bit
   350 0000023D EB13                    	jmp	short chk_44khz_2
   351                                  chk_44khz_1:
   352 0000023F BB[D5190000]            	mov	ebx, load_44khz_stereo_8_bit
   353 00000244 803D[FC670000]01        	cmp	byte [stmo], 1 
   354 0000024B 7505                    	jne	short chk_44khz_2
   355 0000024D BB[59190000]            	mov	ebx, load_44khz_mono_8_bit
   356                                  chk_44khz_2:
   357 00000252 B8D93A0000              	mov	eax, 15065 ; (655*23)
   358 00000257 BA19000000              	mov	edx, 25
   359 0000025C B917000000              	mov	ecx, 23
   360 00000261 E924010000              	jmp	set_sizes 
   361                                  chk_16khz:
   362 00000266 663D803E                	cmp	ax, 16000
   363 0000026A 7545                    	jne	short chk_8khz
   364 0000026C 803D[FD670000]08        	cmp	byte [bps], 8
   365 00000273 7615                    	jna	short chk_16khz_1
   366 00000275 BB[50100000]            	mov	ebx, load_16khz_stereo_16_bit
   367 0000027A 803D[FC670000]01        	cmp	byte [stmo], 1 
   368 00000281 751A                    	jne	short chk_16khz_2
   369 00000283 BB[CF0F0000]            	mov	ebx, load_16khz_mono_16_bit
   370 00000288 EB13                    	jmp	short chk_16khz_2
   371                                  chk_16khz_1:
   372 0000028A BB[150F0000]            	mov	ebx, load_16khz_stereo_8_bit
   373 0000028F 803D[FC670000]01        	cmp	byte [stmo], 1 
   374 00000296 7505                    	jne	short chk_16khz_2
   375 00000298 BB[960E0000]            	mov	ebx, load_16khz_mono_8_bit
   376                                  chk_16khz_2:
   377 0000029D B855150000              	mov	eax, 5461
   378 000002A2 BA03000000              	mov	edx, 3
   379 000002A7 B901000000              	mov	ecx, 1
   380 000002AC E9D9000000              	jmp	set_sizes 
   381                                  chk_8khz:
   382 000002B1 663D401F                	cmp	ax, 8000
   383 000002B5 7545                    	jne	short chk_24khz
   384 000002B7 803D[FD670000]08        	cmp	byte [bps], 8
   385 000002BE 7615                    	jna	short chk_8khz_1
   386 000002C0 BB[4B0D0000]            	mov	ebx, load_8khz_stereo_16_bit
   387 000002C5 803D[FC670000]01        	cmp	byte [stmo], 1 
   388 000002CC 751A                    	jne	short chk_8khz_2
   389 000002CE BB[7B0C0000]            	mov	ebx, load_8khz_mono_16_bit
   390 000002D3 EB13                    	jmp	short chk_8khz_2
   391                                  chk_8khz_1:
   392 000002D5 BB[4B0B0000]            	mov	ebx, load_8khz_stereo_8_bit
   393 000002DA 803D[FC670000]01        	cmp	byte [stmo], 1 
   394 000002E1 7505                    	jne	short chk_8khz_2
   395 000002E3 BB[6E0A0000]            	mov	ebx, load_8khz_mono_8_bit
   396                                  chk_8khz_2:
   397 000002E8 B8AA0A0000              	mov	eax, 2730
   398 000002ED BA06000000              	mov	edx, 6
   399 000002F2 B901000000              	mov	ecx, 1
   400 000002F7 E98E000000              	jmp	set_sizes 
   401                                  chk_24khz:
   402 000002FC 663DC05D                	cmp	ax, 24000
   403 00000300 7542                    	jne	short chk_32khz
   404 00000302 803D[FD670000]08        	cmp	byte [bps], 8
   405 00000309 7615                    	jna	short chk_24khz_1
   406 0000030B BB[7A120000]            	mov	ebx, load_24khz_stereo_16_bit
   407 00000310 803D[FC670000]01        	cmp	byte [stmo], 1 
   408 00000317 751A                    	jne	short chk_24khz_2
   409 00000319 BB[17120000]            	mov	ebx, load_24khz_mono_16_bit
   410 0000031E EB13                    	jmp	short chk_24khz_2
   411                                  chk_24khz_1:
   412 00000320 BB[8D110000]            	mov	ebx, load_24khz_stereo_8_bit
   413 00000325 803D[FC670000]01        	cmp	byte [stmo], 1 
   414 0000032C 7505                    	jne	short chk_24khz_2
   415 0000032E BB[26110000]            	mov	ebx, load_24khz_mono_8_bit
   416                                  chk_24khz_2:
   417 00000333 B800200000              	mov	eax, 8192
   418 00000338 BA02000000              	mov	edx, 2
   419 0000033D B901000000              	mov	ecx, 1
   420 00000342 EB46                    	jmp	short set_sizes 
   421                                  chk_32khz:
   422 00000344 663D007D                	cmp	ax, 32000
   423 00000348 7574                    	jne	short vra_needed
   424 0000034A 803D[FD670000]08        	cmp	byte [bps], 8
   425 00000351 7615                    	jna	short chk_32khz_1
   426 00000353 BB[7B140000]            	mov	ebx, load_32khz_stereo_16_bit
   427 00000358 803D[FC670000]01        	cmp	byte [stmo], 1 
   428 0000035F 751A                    	jne	short chk_32khz_2
   429 00000361 BB[11140000]            	mov	ebx, load_32khz_mono_16_bit
   430 00000366 EB13                    	jmp	short chk_32khz_2
   431                                  chk_32khz_1:
   432 00000368 BB[74130000]            	mov	ebx, load_32khz_stereo_8_bit
   433 0000036D 803D[FC670000]01        	cmp	byte [stmo], 1 
   434 00000374 7505                    	jne	short chk_32khz_2
   435 00000376 BB[01130000]            	mov	ebx, load_32khz_mono_8_bit
   436                                  chk_32khz_2:
   437 0000037B B8AA2A0000              	mov	eax, 10922
   438 00000380 BA03000000              	mov	edx, 3
   439 00000385 B902000000              	mov	ecx, 2
   440                                  	;jmp	short set_sizes 
   441                                  set_sizes:
   442 0000038A 803D[FC670000]01        	cmp	byte [stmo], 1
   443 00000391 7402                    	je	short ss_1
   444 00000393 D1E0                    	shl	eax, 1
   445                                  ss_1:
   446 00000395 803D[FD670000]08        	cmp	byte [bps], 8
   447 0000039C 7602                    	jna	short ss_2
   448                                  	; 16 bit samples
   449 0000039E D1E0                    	shl	eax, 1
   450                                  ss_2:
   451 000003A0 A3[DD030000]            	mov	[loadsize], eax
   452 000003A5 F7E2                    	mul	edx
   453                                  	;cmp	ecx, 1
   454                                  	;je	short ss_3
   455                                  ;ss_3:
   456 000003A7 F7F1                    	div	ecx
   457 000003A9 8A0D[73680000]          	mov	cl, [fbs_shift]
   458 000003AF D3E0                    	shl	eax, cl
   459                                  	; 26/11/2023
   460                                  	;shr	eax, 1	; buffer size is 16 bit sample count
   461 000003B1 A3[E1030000]            	mov	[buffersize], eax ; buffer size in bytes
   462 000003B6 891D[D9030000]          	mov	[loadfromwavfile], ebx
   463 000003BC EB27                    	jmp	short PlayNow
   464                                  
   465                                  vra_needed:
   466                                  	sys	_msg, msg_no_vra, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000003BE BB[76660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000003C3 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000003C8 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000003CD B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000003D2 CD40                <1>  int 40h
   467 000003D4 E9E7000000              	jmp	Exit
   468                                  
   469                                  	; 26/11/2023
   470                                  	; 13/11/2023
   471                                  loadfromwavfile:
   472 000003D9 [A0050000]              	dd	loadFromFile
   473                                  loadsize:	; read from wav file
   474 000003DD 00000000                	dd	0
   475                                  buffersize:	; write to DMA buffer
   476 000003E1 00000100                	dd	65536 ; bytes
   477                                  
   478                                  ; -----------------------------------
   479                                  
   480                                  	; 23/08/2020
   481                                  PlayNow: 
   482                                  	; 27/10/2017
   483                                  	;mov	cx, 256
   484                                  	; 27/12/2024
   485 000003E5 B900010000              	mov	ecx, 256
   486 000003EA 31DB                    	xor	ebx, ebx
   487 000003EC BF[90680000]            	mov	edi, RowOfs
   488                                  MakeOfs:
   489                                  	; 29/10/2017
   490                                  	;mov	ax, 128
   491                                  	;mul	bx
   492                                  	;mov	al, ah
   493                                  	;mov	ah, 80
   494                                  	;mul	ah
   495 000003F1 89D8                    	mov	eax, ebx
   496 000003F3 66C1E007                	shl	ax, 7 ; * 128
   497 000003F7 B050                    	mov	al, 80
   498 000003F9 F6E4                    	mul	ah
   499 000003FB 66AB                    	stosw
   500 000003FD 43                      	inc	ebx
   501 000003FE E2F1                    	loop	MakeOfs
   502                                  
   503                                  	; 23/08/2020
   504                                  
   505                                  	; DIRECT VGA MEMORY ACCESS
   506                                  	; bl = 0, bh = 5
   507                                  	; Direct access/map to VGA memory (0A0000h)
   508                                  
   509                                  	sys	_video, 0500h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000400 BB00050000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000405 B81F000000          <1>  mov eax, %1
    90                              <1> 
    91 0000040A CD40                <1>  int 40h
   510 0000040C 3D00000A00              	cmp	eax, 0A0000h
   511 00000411 7405                    	je	short _4
   512                                  	; 09/12/2023
   513 00000413 E9ADFCFFFF              	jmp	error_exit
   514                                  
   515                                  
   516                                  ; Note: Normally IRQ 0 calls the ModPlay Polling at 18.2Hz thru
   517                                  ;       the software interrupt 1Ch. If the IRQ 0 is disabled, then
   518                                  ;       the INT 1Ch MUST BE CALLED at least MixSpeed/1024 times per
   519                                  ;       second, or the module will sound "looped".
   520                                  ;       Because we need better sync with the ModPlayer to draw the scope,
   521                                  ;       the polling is called from my routine, and then the irq 0 must be
   522                                  ;       disabled. The [DmaBuffer] points to the current buffer of 8-bit
   523                                  ;       samples played by the Sound Blaster. Note that some samples are
   524                                  ;       discarded in the next code, just for fun!
   525                                  
   526                                  _4:
   527                                  	;mov     ax, 0013h	; Set Mode 320x200x256
   528                                  	;int     31h
   529                                  
   530                                  	; 21/10/2017
   531                                  	;mov	ax, 0012h	; Set Mode 640x480x16
   532                                  	;int	31h
   533                                  
   534                                  	; 22/10/2017
   535 00000418 E87A1C0000              	call	setgraphmode	; Set video mode to 640*480x16
   536                                  
   537                                  	; 22/10/2017
   538                                  	;call	loadlbm
   539                                  	;jc	short loadlbm_err
   540                                  
   541 0000041D BE[BA220000]            	mov	esi, LOGO_ADDRESS
   542 00000422 E85D1D0000              	call	putlbm
   543                                  	;jnc	short loadlbm_ok
   544 00000427 731D                    	jnc	short _5 ; 
   545                                  
   546                                  	;mov	byte [error_color], 0Eh ; Yellow
   547                                  
   548                                  loadlbm_err:
   549                                  	; 21/10/2017
   550                                  	;mov	ax, 0003h	; Set Text Mode 80x25x16
   551                                  	;int	31h
   552                                  	; 22/10/2017
   553 00000429 E8861C0000              	call	settextmode
   554                                  
   555                                  	sys	_msg, LOGO_ERROR_MSG, 255, 0Ch
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000042E BB[8E220000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000433 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000438 BA0C000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000043D B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000442 CD40                <1>  int 40h
   556 00000444 EB7A                    	jmp	short Exit
   557                                  
   558                                  loadlbm_ok: 
   559                                  	; 21/10/2017
   560                                  _5:
   561                                  	; 09/10/2017 (2*BUFFERSIZE, 64K)
   562                                  	; 23/06/2017
   563                                  	; Map DMA buffer to user's memory space
   564                                  	;sys	_audio, 0D00h, 2*BUFFERSIZE, DMA_Buffer
   565                                  	; 09/12/2023
   566 00000446 A1[E1030000]            	mov	eax, [buffersize]
   567 0000044B D1E0                    	shl	eax, 1 ; *2
   568                                  	; round up to page boundary (may not be necessary)
   569 0000044D 05FF0F0000              	add	eax, 4095
   570 00000452 2500F0FFFF              	and	eax, ~4095
   571 00000457 A3[94720000]            	mov	[DMA_buffer_size], eax
   572                                  	;;sys	_audio, 0D00h, 131072, DMA_Buffer
   573                                  	;sys	_audio, 0D00h, [DMA_buffer_size], DMA_Buffer
   574                                  	; 27/12/2024
   575                                  	sys	_audio, 0D00h, eax, DMA_Buffer
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000045C BB000D0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000461 89C1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000463 BA[00000200]        <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000468 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000046D CD40                <1>  int 40h
   576                                  	;jc	error_exit
   577                                  
   578                                  	; 23/08/2020
   579                                  
   580                                  ; position file pointer to start in actual wav data
   581                                  ; MUCH improvement should really be done here to check if sample size is
   582                                  ; supported, make sure there are 2 channels, etc.  
   583                                  ;
   584                                          ;mov     ah, 42h
   585                                          ;mov     al, 0	; from start of file
   586                                          ;mov     bx, [FileHandle]
   587                                          ;xor     cx, cx
   588                                          ;mov     dx, 44	; jump past .wav/riff header
   589                                          ;int     21h
   590                                  
   591                                  	sys	_seek, [FileHandle], 44, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000046F 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000475 B92C000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000047A BA00000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000047F B813000000          <1>  mov eax, %1
    90                              <1> 
    91 00000484 CD40                <1>  int 40h
   592                                  
   593                                  ; play the .wav file. Most of the good stuff is in here.
   594                                  
   595 00000486 E8C8010000                      call    PlayWav
   596                                  
   597                                  ; close the .wav file and exit.
   598                                  
   599                                  StopPlaying:
   600                                  	; Stop Playing
   601                                  	sys	_audio, 0700h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000048B BB00070000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000490 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000495 CD40                <1>  int 40h
   602                                  	; Cancel callback service (for user)
   603                                  	sys	_audio, 0900h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000497 BB00090000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000049C B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004A1 CD40                <1>  int 40h
   604                                  	; Deallocate Audio Buffer (for user)
   605                                  	sys	_audio, 0A00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004A3 BB000A0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004A8 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004AD CD40                <1>  int 40h
   606                                  	; Disable Audio Device
   607                                  	sys	_audio, 0C00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004AF BB000C0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004B4 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004B9 CD40                <1>  int 40h
   608                                  
   609                                  	; 23/08/2020
   610 000004BB E8F41B0000              	call	settextmode
   611                                  Exit:  
   612 000004C0 E85C000000                      call    closeFile
   613                                           
   614                                  	sys	_exit	; Bye!
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81                              <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004C5 B801000000          <1>  mov eax, %1
    90                              <1> 
    91 000004CA CD40                <1>  int 40h
   615                                  here:
   616 000004CC EBFE                    	jmp	short here
   617                                  
   618                                  pmsg_usage:
   619                                  	sys	_msg, msg_usage, 255, 0Bh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004CE BB[58650000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000004D3 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000004D8 BA0B000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004DD B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000004E2 CD40                <1>  int 40h
   620 000004E4 EBDA                    	jmp	short Exit
   621                                  
   622                                  DetectAC97:
   623                                  	; 09/12/2023
   624                                  	; Detect (BH=1) AC'97 (BL=2) Audio Device
   625                                          sys	_audio, 0102h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004E6 BB02010000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004EB B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004F0 CD40                <1>  int 40h
   626 000004F2 7213                    	jc	short DetectAC97_retn
   627                                  
   628                                  	; Get AC'97 Codec info
   629                                  	; (Function 14, sub function 1)
   630                                  	sys	_audio, 0E01h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004F4 BB010E0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004F9 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004FE CD40                <1>  int 40h
   631                                  	; Save Variable Rate Audio support bit
   632 00000500 2401                    	and	al, 1
   633 00000502 A2[83680000]            	mov	[VRA], al
   634                                  
   635                                  DetectAC97_retn:
   636 00000507 C3                      	retn
   637                                  	
   638                                  	; 23/08/2020
   639                                  
   640                                  ;open or create file
   641                                  ;
   642                                  ;input: ds:dx-->filename (asciiz)
   643                                  ;       al=file Mode (create or open)
   644                                  ;output: none  cs:[FileHandle] filled
   645                                  ;
   646                                  openFile:
   647                                  	;mov	ah, 3Bh	; start with a mode
   648                                  	;add	ah, al	; add in create or open mode
   649                                  	;xor	cx, cx
   650                                  	;int	21h
   651                                  	;jc	short _of1
   652                                  	;;mov	[cs:FileHandle], ax
   653                                  
   654                                  	sys	_open, wav_file_name, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000508 BB[20680000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000050D B900000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000512 B805000000          <1>  mov eax, %1
    90                              <1> 
    91 00000517 CD40                <1>  int 40h
   655 00000519 7205                    	jc	short _of1
   656                                  
   657 0000051B A3[53650000]            	mov	[FileHandle], eax
   658                                  _of1:
   659 00000520 C3                      	retn
   660                                  
   661                                  ; close the currently open file
   662                                  ; input: none, uses cs:[FileHandle]
   663                                  closeFile:
   664 00000521 833D[53650000]FF        	cmp	dword [FileHandle], -1
   665 00000528 7417                    	je	short _cf1
   666                                  	;mov    bx, [FileHandle]  
   667                                  	;mov    ax, 3E00h
   668                                          ;int    21h              ;close file
   669                                  
   670                                  	sys	_close, [FileHandle]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000052A 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000530 B806000000          <1>  mov eax, %1
    90                              <1> 
    91 00000535 CD40                <1>  int 40h
   671 00000537 C705[53650000]FFFF-     	mov 	dword [FileHandle], -1
   671 0000053F FFFF               
   672                                  _cf1:
   673 00000541 C3                      	retn
   674                                  
   675                                  getSampleRate:
   676                                  	
   677                                  ; reads the sample rate from the .wav file.
   678                                  ; entry: none - assumes file is already open
   679                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   680                                  ;	cx = number of channels (mono=1, stereo=2)
   681                                  ;	dx = bits per sample (8, 16)
   682                                  
   683 00000542 53                      	push    ebx
   684                                  
   685                                          ;mov	ah, 42h
   686                                          ;mov	al, 0	; from start of file
   687                                          ;mov	bx, [FileHandle]
   688                                          ;xor	cx, cx
   689                                          ;mov	dx, 08h	; "WAVE"
   690                                          ;int	21h
   691                                  	
   692                                  	sys	_seek, [FileHandle], 8, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000543 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000549 B908000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000054E BA00000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000553 B813000000          <1>  mov eax, %1
    90                              <1> 
    91 00000558 CD40                <1>  int 40h
   693                                  
   694                                          ;mov	dx, smpRBuff
   695                                          ;mov	cx, 28	; 28 bytes
   696                                  	;mov	ah, 3fh
   697                                          ;int	21h
   698                                  
   699                                  	sys	_read, [FileHandle], smpRBuff, 28
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000055A 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000560 B9[04680000]        <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000565 BA1C000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000056A B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000056F CD40                <1>  int 40h
   700                                  
   701 00000571 813D[04680000]5741-     	cmp	dword [smpRBuff], 'WAVE'
   701 00000579 5645               
   702 0000057B 7520                    	jne	short gsr_stc
   703                                  
   704 0000057D 66833D[10680000]01      	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   705 00000585 7516                    	jne	short gsr_stc
   706                                  
   707 00000587 668B0D[12680000]        	mov	cx, [smpRBuff+14]	; return num of channels in CX
   708 0000058E 66A1[14680000]                  mov     ax, [smpRBuff+16]	; return sample rate in AX
   709 00000594 668B15[1E680000]        	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   710                                  gsr_retn:
   711 0000059B 5B                              pop     ebx
   712 0000059C C3                              retn
   713                                  gsr_stc:
   714 0000059D F9                      	stc
   715 0000059E EBFB                    	jmp	short gsr_retn
   716                                  
   717                                  ;=============================================================================
   718                                  
   719                                  ; 09/12/2023	
   720                                  %if 0
   721                                  	; 'playwav6.s'  (27/11/2023)
   722                                  
   723                                  audio_int_handler:
   724                                  	; 18/08/2020 (14/10/2020, 'wavplay2.s')
   725                                  
   726                                  	;mov	byte [srb], 1 ; interrupt (or signal response byte)
   727                                  	
   728                                  	;cmp	byte [cbs_busy], 1
   729                                  	;jnb	short _callback_bsy_retn
   730                                  	
   731                                  	;mov	byte [cbs_busy], 1
   732                                  
   733                                  	mov	al, [half_buff]
   734                                  
   735                                  	cmp	al, 1
   736                                  	jb	short _callback_retn
   737                                  
   738                                  	; 18/08/2020
   739                                  	mov	byte [srb], 1
   740                                  
   741                                  	xor	byte [half_buff], 3 ; 2->1, 1->2
   742                                  
   743                                  	add	al, '0'
   744                                  tL0:	; 26/11/2023
   745                                  	mov	ah, 4Eh
   746                                  	mov	ebx, 0B8000h ; video display page address
   747                                  	mov	[ebx], ax ; show playing buffer (1, 2)
   748                                  _callback_retn:
   749                                  	;mov	byte [cbs_busy], 0
   750                                  _callback_bsy_retn:
   751                                  	sys	_rele ; return from callback service 
   752                                  	; we must not come here !
   753                                  	sys	_exit
   754                                  
   755                                  %endif
   756                                  
   757                                  ;=============================================================================
   758                                  
   759                                  ; 09/12/2023
   760                                  ; 'playwav6.s' (27/11/2023)
   761                                  
   762                                  loadFromFile:
   763                                  	; 26/11/2023
   764 000005A0 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
   765                                  					; last of the file?
   766 000005A7 7402                    	jz	short lff_0		; no
   767 000005A9 F9                      	stc
   768 000005AA C3                      	retn
   769                                  lff_0:
   770                                  	; 13/06/2017
   771                                  	;mov	edx, BUFFERSIZE
   772                                  	; 26/11/2023
   773 000005AB BF[00800000]            	mov	edi, audio_buffer
   774 000005B0 8B15[E1030000]          	mov	edx, [buffersize]	; bytes
   775 000005B6 8A0D[73680000]          	mov	cl, [fbs_shift]
   776 000005BC 20C9                    	and	cl, cl
   777 000005BE 7409                    	jz	short lff_1 ; stereo, 16 bit
   778                                  
   779                                  	; fbs_shift =
   780                                  	;	2 for mono and 8 bit sample (multiplier = 4)
   781                                  	;	1 for mono or 8 bit sample (multiplier = 2)
   782 000005C0 D3EA                    	shr	edx, cl
   783                                  	;inc	edx
   784                                  
   785 000005C2 BE[00000400]            	mov     esi, temp_buffer
   786 000005C7 EB02                    	jmp	short lff_2
   787                                  lff_1:
   788                                  	;mov	esi, audio_buffer
   789 000005C9 89FE                    	mov	esi, edi ; audio_buffer
   790                                  lff_2:
   791                                  	; 17/03/2017
   792                                  	; esi = buffer address
   793                                  	; edx = buffer size
   794                                   
   795                                  	; 26/11/2023
   796                                  	; load file into memory
   797                                  	sys 	_read, [FileHandle], esi
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000005CB 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000005D1 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000005D3 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000005D8 CD40                <1>  int 40h
   798                                  	; 14/12/2024
   799 000005DA 8B0D[E1030000]          	mov	ecx, [buffersize]
   800                                  	;jc	short padfill ; error !
   801                                  	; 14/12/2024
   802 000005E0 7255                    	jc	short lff_10
   803                                  
   804 000005E2 21C0                    	and	eax, eax
   805 000005E4 7453                    	jz	short padfill
   806                                  lff_3:
   807                                  	; 26/11/2023
   808 000005E6 8A1D[73680000]          	mov	bl, [fbs_shift]
   809 000005EC 20DB                    	and	bl, bl
   810 000005EE 7456                    	jz	short lff_11
   811                                  
   812                                  	; 14/12/2024
   813                                  	;sub	ecx, eax
   814                                  	;mov	ebp, ecx
   815                                  	; 14/12/2024
   816 000005F0 29C2                    	sub	edx, eax
   817                                  
   818                                  	;mov	esi, temp_buffer
   819                                  	;mov	edi, audio_buffer
   820 000005F2 89C1                    	mov	ecx, eax   ; byte count
   821                                  
   822 000005F4 803D[FD670000]08        	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   823 000005FB 751E                    	jne	short lff_6 ; 16 bit samples
   824                                  	; 8 bit samples
   825 000005FD FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
   826 000005FF 740E                    	jz	short lff_5 ; 8 bit, stereo
   827                                  lff_4:
   828                                  	; mono & 8 bit
   829 00000601 AC                      	lodsb
   830 00000602 2C80                    	sub	al, 80h ; 08/11/2023
   831 00000604 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   832 00000607 66AB                    	stosw	; left channel
   833 00000609 66AB                    	stosw	; right channel
   834 0000060B E2F4                    	loop	lff_4
   835 0000060D EB16                    	jmp	short lff_8
   836                                  lff_5:
   837                                  	; stereo & 8 bit
   838 0000060F AC                      	lodsb
   839 00000610 2C80                    	sub	al, 80h ; 08/11/2023
   840 00000612 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   841 00000615 66AB                    	stosw
   842 00000617 E2F6                    	loop	lff_5
   843 00000619 EB0A                    	jmp	short lff_8
   844                                  lff_6:
   845 0000061B D1E9                    	shr	ecx, 1 ; word count
   846                                  lff_7:
   847 0000061D 66AD                    	lodsw
   848 0000061F 66AB                    	stosw	; left channel
   849 00000621 66AB                    	stosw	; right channel
   850 00000623 E2F8                    	loop	lff_7
   851                                  lff_8:
   852                                  	; 27/11/2023
   853 00000625 F8                      	clc
   854                                  	; 14/12/2024
   855                                  	;mov	ecx, ebp
   856                                  	;jecxz	endLFF_retn
   857 00000626 09D2                    	or	edx, edx
   858 00000628 741B                    	jz	short endLFF_retn
   859                                  
   860                                  	; 14/12/2024
   861 0000062A B9[00800000]            	mov	ecx, audio_buffer
   862 0000062F 030D[E1030000]          	add	ecx, [buffersize]
   863 00000635 29F9                    	sub	ecx, edi
   864                                  
   865                                  	; 14/12/2024
   866                                  lff_10:
   867 00000637 31C0                    	xor	eax, eax ; silence
   868                                  padfill:
   869 00000639 D1E9                    	shr	ecx, 1
   870 0000063B F366AB                  	rep	stosw
   871                                  lff_9:
   872 0000063E 800D[80680000]01                or	byte [flags], ENDOFFILE	; end of file flag
   873                                  endLFF_retn:
   874 00000645 C3                              retn
   875                                  
   876                                  lff_11:
   877                                  	; 16 bit stereo
   878                                  	; ecx = buffer size
   879                                  	; eax = read count
   880 00000646 29C1                    	sub	ecx, eax
   881 00000648 76FB                    	jna	short endLFF_retn
   882 0000064A 01C7                    	add	edi, eax  ; audio_buffer + eax
   883 0000064C EBE9                    	jmp	short lff_10 ; padfill
   884                                  
   885                                  error_exit_2:
   886                                  	; 26/11/2023 - temporary
   887                                  	;sys	_msg, test_2, 255, 0Ch
   888 0000064E E972FAFFFF              	jmp	error_exit
   889                                  
   890                                  ;=============================================================================
   891                                  ;      
   892                                  ;=============================================================================
   893                                  
   894                                  PlayWav:
   895                                  	; 09/12/2023
   896                                  	;; 23/08/2020
   897                                  	;; load 32768 bytes into audio buffer
   898                                  	;;mov	edi, audio_buffer
   899                                  	;;mov	edx, BUFFERSIZE
   900                                  	;call	loadFromFile
   901                                  	; 09/12/2023
   902 00000653 FF15[D9030000]          	call	dword [loadfromwavfile]
   903 00000659 72F3                    	jc	short error_exit_2
   904                                  
   905                                  	;mov	byte [half_buff], 1 ; (DMA) Buffer 1
   906                                  
   907                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   908 0000065B F605[80680000]01        	test    byte [flags], ENDOFFILE  ; end of file
   909 00000662 7512                    	jnz	short _6 ; yes
   910                                  			 ; bypass filling dma half buffer 2
   911                                  
   912                                  	; bh = 16 : update (current, first) dma half buffer
   913                                  	; bl = 0  : then switch to the next (second) half buffer
   914                                  	sys	_audio, 1000h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000664 BB00100000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000669 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000066E CD40                <1>  int 40h
   915                                  
   916                                  	; 27/07/2020
   917                                  	; [audio_flag] = 1 (in TRDOS 386 kernel)
   918                                  
   919                                  	; audio_buffer must be filled again after above system call 
   920                                  	; (Because audio interrupt will be generated by VT8237R
   921                                  	; at the end of the first half of dma buffer.. so, 
   922                                  	; the second half must be ready. 'sound_play' will use it.)
   923                                  
   924                                  	; 09/12/2023
   925                                  	;; 13/10/2017
   926                                  	;;mov	edi, audio_buffer
   927                                  	;;mov	edx, BUFFERSIZE
   928                                  	;call    loadFromFile
   929                                  	; 09/12/2023
   930 00000670 FF15[D9030000]          	call	dword [loadfromwavfile]
   931                                  	;jc	short p_return
   932                                  
   933                                  _6:
   934                                  	; Set Master Volume Level
   935                                  	sys	_audio, 0B00h, 1D1Dh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000676 BB000B0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000067B B91D1D0000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000680 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000685 CD40                <1>  int 40h
   936                                  	; 24/06/2017
   937                                  	;mov	byte [volume_level], 1Dh
   938 00000687 880D[82680000]          	mov	[volume_level], cl	
   939                                  
   940                                  	;mov	byte [srb], 0
   941                                  
   942                                  	; Start	to play
   943 0000068D A0[FD670000]            	mov	al, [bps]
   944 00000692 C0E804                  	shr	al, 4 ; 8 -> 0, 16 -> 1
   945 00000695 D0E0                    	shl	al, 1 ; 16 -> 2, 8 -> 0
   946 00000697 8A1D[FC670000]          	mov	bl, [stmo]
   947 0000069D FECB                    	dec	bl
   948 0000069F 08C3                    	or	bl, al
   949 000006A1 668B0D[FE670000]        	mov	cx, [sample_rate] 
   950 000006A8 B704                    	mov	bh, 4 ; start to play	
   951                                  	sys	_audio
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81                              <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000006AA B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000006AF CD40                <1>  int 40h
   952                                  
   953                                  	; 27/07/2020
   954                                  	; Here..
   955                                  	; If byte [flags] <> ENDOFFILE ...
   956                                  	; user's audio_buffer has been copied to dma half buffer 2
   957                                  
   958                                  	; [audio_flag] = 0  (in TRDOS 386 kernel)
   959                                  
   960                                  	; audio_buffer must be filled again after above system call 
   961                                  	; (Because, audio interrupt will be generated by VT8237R
   962                                  	; at the end of the first half of dma buffer.. so, 
   963                                  	; the 2nd half of dma buffer is ready but the 1st half
   964                                  	; must be filled again.)
   965                                  
   966                                  ; 14/12/2024
   967                                  %if 0
   968                                  	; 18/08/2020
   969                                  	test    byte [flags], ENDOFFILE  ; end of file
   970                                  	jnz	short p_loop ; yes
   971                                  
   972                                  	; 18/08/2020
   973                                  	; load 32768 bytes into audio buffer
   974                                  	;; (for the second half of DMA buffer)
   975                                  	; 27/11/2023
   976                                  	; 20/05/2017
   977                                  	;mov	edi, audio_buffer
   978                                  	;mov	edx, BUFFERSIZE
   979                                  	; 26/11/2023
   980                                  	;mov	edx, [buffersize]
   981                                  	;call	loadFromFile
   982                                  	; 26/11/2023
   983                                  	call	dword [loadfromwavfile]
   984                                  	;jc	short p_return
   985                                  	;mov	byte [half_buff], 2 ; (DMA) Buffer 2
   986                                  %endif
   987                                  
   988                                  	; we need to wait for 'SRB' (audio interrupt)
   989                                  	; (we can not return from 'PlayWav' here 
   990                                  	;  even if we have got an error from file reading)
   991                                  	; ((!!current audio data must be played!!))
   992                                  
   993                                  	;mov	ebx, 0B8000h ; video display page address
   994                                  	;mov	ah, 4Eh
   995                                  	;add	al, [half_buffer]
   996                                  	;mov	[ebx], ax ; show playing buffer (1, 2)
   997                                  
   998                                  	;; load 32768 bytes into audio buffer
   999                                  	;; (for the second half of DMA buffer)
  1000                                  	;; 20/05/2017
  1001                                  	;mov	edi, audio_buffer
  1002                                  	;mov	edx, BUFFERSIZE
  1003                                  	;call	loadFromFile
  1004                                  	;jc	short p_return
  1005                                  	;mov	byte [half_buff], 2 ; (DMA) Buffer 2
  1006                                  
  1007                                  	; 23/08/2020
  1008                                  
  1009                                  	; 27/10/2017
  1010                                  	
  1011                                  	; 03/08/2020
  1012                                       	;jmp	short modp_gs ; 23/06/2017
  1013                                  
  1014                                  	; 27/12/2024
  1015                                  	; 24/08/2020
  1016                                  	;inc	byte [counter]
  1017                                  p_loop:
  1018 000006B1 803D[81680000]00        	cmp	byte [srb], 0
  1019 000006B8 761D                    	jna	short q_loop
  1020                                  
  1021 000006BA C605[81680000]00        	mov	byte [srb], 0
  1022                                  modp_gs:
  1023                                  	; 24/08/2020
  1024                                  	;mov	edi, audio_buffer
  1025                                  	;mov	edx, BUFFERSIZE
  1026                                  	; 09/12/2023
  1027                                  	;call	loadFromFile
  1028                                  	;mov	edx, [buffersize]
  1029 000006C1 FF15[D9030000]          	call	dword [loadfromwavfile]
  1030 000006C7 723D                    	jc	short q_return
  1031                                  
  1032                                  	; 14/12/2024
  1033                                  	;;;
  1034                                  	; bh = 16 : update (current, first) dma half buffer
  1035                                  	; bl = 0  : then switch to the other half buffer
  1036                                  	sys	_audio, 1000h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000006C9 BB00100000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000006CE B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000006D3 CD40                <1>  int 40h
  1037                                  	;;;
  1038                                  
  1039                                  	; 23/08/2020
  1040 000006D5 EB62                    	jmp	short r_loop
  1041                                  q_loop:
  1042                                  	; 27/12/2024
  1043                                  	; 24/08/2020
  1044                                  	;test	byte [counter], 63
  1045                                  	;jnz	short r_loop
  1046                                  k_loop:
  1047 000006D7 B401                    	mov     ah, 1		; any key pressed?
  1048 000006D9 CD32                    	int     32h		; no, Loop.
  1049 000006DB 745C                    	jz	short r_loop
  1050                                  
  1051 000006DD B400                    	mov     ah, 0		; flush key buffer...
  1052 000006DF CD32                    	int     32h
  1053                                  
  1054                                  	; 19/10/2017 (modplay6.s)
  1055 000006E1 3C20                    	cmp	al, 20h
  1056 000006E3 740E                    	je	short change_pan
  1057                                  	; 09/10/2017 (playmod5.s)
  1058 000006E5 3C2B                    	cmp	al, '+' ; increase sound volume
  1059 000006E7 741E                    	je	short inc_volume_level
  1060 000006E9 3C2D                    	cmp	al, '-'
  1061 000006EB 743D                    	je	short dec_volume_level
  1062                                  
  1063                                  	; 19/10/2017 (modplay6.s)
  1064 000006ED 24DF                    	and	al, 0DFh
  1065 000006EF 3C50                    	cmp	al, 'P'
  1066 000006F1 7513                    	jne	short q_return
  1067                                  
  1068                                  change_pan:
  1069                                  	; 19/10/2017 (modplay6.s)
  1070 000006F3 8A0D[84680000]          	mov	cl, [pan_shift]
  1071 000006F9 FEC1                    	inc	cl
  1072 000006FB 80E103                  	and	cl, 3
  1073 000006FE 880D[84680000]          	mov	[pan_shift], cl
  1074 00000704 EB33                    	jmp	short r_loop
  1075                                  
  1076                                  q_return:
  1077 00000706 C3                      	retn
  1078                                  
  1079                                  	; 09/10/2017 (playmod5.s)
  1080                                  	; 24/06/2017 (wavplay2.s)
  1081                                  inc_volume_level:
  1082 00000707 8A0D[82680000]          	mov	cl, [volume_level]
  1083 0000070D 80F91F                  	cmp	cl, 1Fh ; 31
  1084                                  	;jnb	short r_loop
  1085                                  	; 09/12/2023
  1086 00000710 73C5                    	jnb	short k_loop
  1087 00000712 FEC1                    	inc	cl
  1088                                  change_volume_level:
  1089 00000714 880D[82680000]          	mov	[volume_level], cl
  1090 0000071A 88CD                    	mov	ch, cl
  1091                                  	; Set Master Volume Level
  1092                                  	sys	_audio, 0B00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000071C BB000B0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000721 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000726 CD40                <1>  int 40h
  1093 00000728 EB0F                    	jmp	short r_loop
  1094                                  dec_volume_level:
  1095 0000072A 8A0D[82680000]          	mov	cl, [volume_level]
  1096 00000730 80F901                  	cmp	cl, 1 ; 1
  1097                                  	;jna	short r_loop
  1098                                  	; 09/12/2023
  1099 00000733 76A2                    	jna	short k_loop
  1100 00000735 FEC9                    	dec	cl
  1101 00000737 EBDB                    	jmp	short change_volume_level
  1102                                  
  1103                                  r_loop:
  1104                                  	; 27/12/2024
  1105                                  	; 24/08/2020
  1106                                  	;inc	byte [counter]
  1107                                  	;; 09/12/2023
  1108                                  	;;jnz	short q_loop
  1109                                  	;;test	byte [counter], 0Fh
  1110                                  	;jnz	short q_loop
  1111                                  _10:
  1112                                  	; 09/12/2023
  1113 00000739 F605[73680000]FF        	test	byte [fbs_shift], 0FFh
  1114 00000740 7405                    	jz	short _9
  1115                                  
  1116                                  	; 23/08/2020
  1117                                  	;test	byte [stmo], 2
  1118                                  	;;jz	p_loop
  1119                                  	;; 09/12/2023
  1120                                  	;jz	short _8
  1121                                  	;cmp	byte [bps], 16
  1122                                  	;;jne	p_loop
  1123                                  	;; 09/12/2023
  1124                                  	;je	short _9
  1125                                  _8:
  1126 00000742 E96AFFFFFF              	jmp	p_loop
  1127                                  _9:
  1128                                  	;;;
  1129                                  	; 27/12/2024
  1130                                  	sys	_time, 4 ; get timer ticks (18.2 ticks/second)
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000747 BB04000000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000074C B80D000000          <1>  mov eax, %1
    90                              <1> 
    91 00000751 CD40                <1>  int 40h
  1131 00000753 3B05[90720000]          	cmp	eax, [timerticks]
  1132 00000759 74E7                    	je	short _8
  1133 0000075B A3[90720000]            	mov	[timerticks], eax
  1134                                  	;;;
  1135                                  
  1136                                  	; 27/10/2017
  1137                                  	; Get Current DMA buffer Pointer 
  1138                                  	; 23/06/2017 ('modplay6.s')
  1139                                  	; bh = 15, get current pointer (DMA buffer offset)
  1140                                  	; bl = 0, for PCM OUT
  1141                                  	; ecx = 0
  1142                                  	;
  1143                                  	sys	_audio, 0F00h, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000760 BB000F0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000765 B900000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000076A B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000076F CD40                <1>  int 40h
  1144                                  
  1145                                  	; 28/10/2017
  1146 00000771 24FC                    	and	al, 0FCh  ; dword alignment (stereo, 16 bit)	
  1147                                  	; 23/06/2017
  1148 00000773 BE[00000200]            	mov     esi, DMA_Buffer
  1149 00000778 01C6                    	add     esi, eax	; add offset value
  1150                                  
  1151                                  	; 24/06/2017
  1152                                  	;mov	ecx, DMA_Buffer + (65536 - (256*4))
  1153                                  	; 09/12/2023
  1154 0000077A 8B0D[94720000]          	mov	ecx, [DMA_buffer_size]
  1155 00000780 81C1[00FC0100]          	add	ecx, DMA_Buffer - (256*4)
  1156                                  
  1157 00000786 39CE                    	cmp	esi, ecx 
  1158 00000788 7602                    	jna	short _7
  1159 0000078A 89CE                    	mov	esi, ecx
  1160                                  _7:
  1161                                  	; 23/10/2017 ('tmodplay.s')
  1162 0000078C E82A190000              	call	drawscopes
  1163                                  
  1164 00000791 E91BFFFFFF              	jmp	p_loop
  1165                                  
  1166                                  ;=============================================================================
  1167                                  ; 
  1168                                  ;=============================================================================
  1169                                  
  1170                                  ;dword2str:
  1171                                  ;	; 13/11/2016 - Erdogan Tan 
  1172                                  ;	; eax = dword value
  1173                                  ;	;
  1174                                  ;	call	dwordtohex
  1175                                  ;	mov	[dword_str], edx
  1176                                  ;	mov	[dword_str+4], eax
  1177                                  ;	mov	si, dword_str
  1178                                  ;	retn
  1179                                  
  1180                                  	; 05/03/2017 (TRDOS 386)
  1181                                  	; trdos386.s (unix386.s) - 10/05/2015
  1182                                  	; Convert binary number to hexadecimal string
  1183                                  
  1184                                  ;bytetohex:
  1185                                  ;	; INPUT ->
  1186                                  ;	; 	AL = byte (binary number)
  1187                                  ;	; OUTPUT ->
  1188                                  ;	;	AX = hexadecimal string
  1189                                  ;	;
  1190                                  ;	push	ebx
  1191                                  ;	movzx	ebx, al
  1192                                  ;	shr	bl, 4
  1193                                  ;	mov	bl, [ebx+hex_chars] 	 	
  1194                                  ;	xchg	bl, al
  1195                                  ;	and	bl, 0Fh
  1196                                  ;	mov	ah, [ebx+hex_chars] 
  1197                                  ;	pop	ebx	
  1198                                  ;	retn
  1199                                  
  1200                                  ;wordtohex:
  1201                                  ;	; INPUT ->
  1202                                  ;	; 	AX = word (binary number)
  1203                                  ;	; OUTPUT ->
  1204                                  ;	;	EAX = hexadecimal string
  1205                                  ;	;
  1206                                  ;	push	ebx
  1207                                  ;	xor	ebx, ebx
  1208                                  ;	xchg	ah, al
  1209                                  ;	push	eax
  1210                                  ;	mov	bl, ah
  1211                                  ;	shr	bl, 4
  1212                                  ;	mov	al, [ebx+hex_chars] 	 	
  1213                                  ;	mov	bl, ah
  1214                                  ;	and	bl, 0Fh
  1215                                  ;	mov	ah, [ebx+hex_chars]
  1216                                  ;	shl	eax, 16
  1217                                  ;	pop	eax
  1218                                  ;	pop	ebx
  1219                                  ;	jmp	short bytetohex
  1220                                  
  1221                                  ;dwordtohex:
  1222                                  ;	; INPUT ->
  1223                                  ;	; 	EAX = dword (binary number)
  1224                                  ;	; OUTPUT ->
  1225                                  ;	;	EDX:EAX = hexadecimal string
  1226                                  ;	;
  1227                                  ;	push	eax
  1228                                  ;	shr	eax, 16
  1229                                  ;	call	wordtohex
  1230                                  ;	mov	edx, eax
  1231                                  ;	pop	eax
  1232                                  ;	call	wordtohex
  1233                                  ;	retn
  1234                                  
  1235                                  ; 09/12/2023
  1236                                  ; 'playwav6.s' (27/11/2023)
  1237                                  
  1238                                  write_wav_file_info:
  1239                                  	; 01/05/2017
  1240                                  	sys	_msg, msgWavFileName, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000796 BB[56670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000079B B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000007A0 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000007A5 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000007AA CD40                <1>  int 40h
  1241                                  	sys	_msg, wav_file_name, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000007AC BB[20680000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000007B1 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000007B6 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000007BB B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000007C0 CD40                <1>  int 40h
  1242                                  
  1243                                  write_sample_rate:
  1244                                  	; 01/05/2017
  1245 000007C2 66A1[FE670000]          	mov	ax, [sample_rate]
  1246                                  	; ax = sample rate (hertz)
  1247 000007C8 31D2                    	xor	edx, edx
  1248 000007CA 66B90A00                	mov	cx, 10
  1249 000007CE 66F7F1                  	div	cx
  1250 000007D1 0015[7B670000]          	add	[msgHertz+4], dl
  1251 000007D7 29D2                    	sub	edx, edx
  1252 000007D9 66F7F1                  	div	cx
  1253 000007DC 0015[7A670000]          	add	[msgHertz+3], dl
  1254 000007E2 29D2                    	sub	edx, edx
  1255 000007E4 66F7F1                  	div	cx
  1256 000007E7 0015[79670000]          	add	[msgHertz+2], dl
  1257 000007ED 29D2                    	sub	edx, edx
  1258 000007EF 66F7F1                  	div	cx
  1259 000007F2 0015[78670000]          	add	[msgHertz+1], dl
  1260 000007F8 0005[77670000]          	add	[msgHertz], al
  1261                                  	
  1262                                  	sys	_msg, msgSampleRate, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000007FE BB[68670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000803 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000808 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000080D B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000812 CD40                <1>  int 40h
  1263                                  
  1264 00000814 BE[92670000]            	mov	esi, msg16Bits
  1265 00000819 803D[FD670000]10        	cmp	byte [bps], 16
  1266 00000820 7405                    	je	short wsr_1
  1267 00000822 BE[82670000]            	mov	esi, msg8Bits
  1268                                  wsr_1:
  1269                                  	sys	_msg, esi, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000827 89F3                <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000829 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000082E BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000833 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000838 CD40                <1>  int 40h
  1270                                  
  1271 0000083A BE[8B670000]            	mov	esi, msgMono
  1272 0000083F 803D[FC670000]01        	cmp	byte [stmo], 1
  1273 00000846 7405                    	je	short wsr_2
  1274 00000848 BE[9C670000]            	mov	esi, msgStereo		
  1275                                  wsr_2:
  1276                                  	sys	_msg, esi, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000084D 89F3                <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000084F B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000854 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000859 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 0000085E CD40                <1>  int 40h
  1277 00000860 C3                              retn
  1278                                  
  1279                                  write_ac97_pci_dev_info:
  1280                                  	; 27/12/2024
  1281                                  	; 06/06/2017
  1282                                  	; 03/06/2017
  1283                                  	; BUS/DEV/FN
  1284                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1285                                  	; DEV/VENDOR
  1286                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1287                                  
  1288                                  
  1289                                  	;mov	esi, [dev_vendor]
  1290                                  	; 27/12/2024
  1291 00000861 A1[74680000]            	mov	eax, [dev_vendor]
  1292 00000866 0FB6D8                  	movzx	ebx, al
  1293 00000869 88DA                    	mov	dl, bl
  1294 0000086B 80E30F                  	and	bl, 0Fh
  1295 0000086E 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1296 00000874 A2[F4660000]            	mov	[msgVendorId+3], al
  1297 00000879 88D3                    	mov	bl, dl
  1298 0000087B C0EB04                  	shr	bl, 4
  1299 0000087E 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1300 00000884 A2[F3660000]            	mov	[msgVendorId+2], al
  1301 00000889 88E3                    	mov	bl, ah
  1302 0000088B 88DA                    	mov	dl, bl
  1303 0000088D 80E30F                  	and	bl, 0Fh
  1304 00000890 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1305 00000896 A2[F2660000]            	mov	[msgVendorId+1], al
  1306 0000089B 88D3                    	mov	bl, dl
  1307 0000089D C0EB04                  	shr	bl, 4
  1308 000008A0 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1309 000008A6 A2[F1660000]            	mov	[msgVendorId], al
  1310                                  	;shr	esi, 16
  1311                                  	; 27/12/2024
  1312 000008AB C1E810                  	shr	eax, 16
  1313 000008AE 88C3                    	mov	bl, al
  1314 000008B0 88DA                    	mov	dl, bl
  1315 000008B2 80E30F                  	and	bl, 0Fh
  1316 000008B5 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1317 000008BB A2[05670000]            	mov	[msgDevId+3], al
  1318 000008C0 88D3                    	mov	bl, dl
  1319 000008C2 C0EB04                  	shr	bl, 4
  1320 000008C5 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1321 000008CB A2[04670000]            	mov	[msgDevId+2], al
  1322 000008D0 88E3                    	mov	bl, ah
  1323 000008D2 88DA                    	mov	dl, bl
  1324 000008D4 80E30F                  	and	bl, 0Fh
  1325 000008D7 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1326 000008DD A2[03670000]            	mov	[msgDevId+1], al
  1327 000008E2 88D3                    	mov	bl, dl
  1328 000008E4 C0EB04                  	shr	bl, 4
  1329 000008E7 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1330 000008ED A2[02670000]            	mov	[msgDevId], al
  1331                                  
  1332                                  	;mov	esi, [bus_dev_fn]
  1333                                  	;shr	esi, 8
  1334                                  	;mov	ax, si
  1335                                  	; 27/12/2024
  1336 000008F2 A1[78680000]            	mov	eax, [bus_dev_fn]
  1337 000008F7 C1E808                  	shr	eax, 8
  1338 000008FA 88C3                    	mov	bl, al
  1339 000008FC 88DA                    	mov	dl, bl
  1340 000008FE 80E307                  	and	bl, 7 ; bit 0,1,2
  1341 00000901 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1342 00000907 A2[29670000]            	mov	[msgFncNo+1], al
  1343 0000090C 88D3                    	mov	bl, dl
  1344 0000090E C0EB03                  	shr	bl, 3
  1345 00000911 88DA                    	mov	dl, bl
  1346 00000913 80E30F                  	and	bl, 0Fh
  1347 00000916 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1348 0000091C A2[1B670000]            	mov	[msgDevNo+1], al
  1349 00000921 88D3                    	mov	bl, dl
  1350 00000923 C0EB04                  	shr	bl, 4
  1351 00000926 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1352 0000092C A2[1A670000]            	mov	[msgDevNo], al
  1353 00000931 88E3                    	mov	bl, ah
  1354 00000933 88DA                    	mov	dl, bl
  1355 00000935 80E30F                  	and	bl, 0Fh
  1356 00000938 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1357 0000093E A2[0F670000]            	mov	[msgBusNo+1], al
  1358 00000943 88D3                    	mov	bl, dl
  1359 00000945 C0EB04                  	shr	bl, 4
  1360 00000948 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1361 0000094E A2[0E670000]            	mov	[msgBusNo], al
  1362                                  
  1363 00000953 66A1[7C680000]          	mov	ax, [ac97_NamBar]
  1364 00000959 88C3                    	mov	bl, al
  1365 0000095B 88DA                    	mov	dl, bl
  1366 0000095D 80E30F                  	and	bl, 0Fh
  1367 00000960 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1368 00000966 A2[38670000]            	mov	[msgNamBar+3], al
  1369 0000096B 88D3                    	mov	bl, dl
  1370 0000096D C0EB04                  	shr	bl, 4
  1371 00000970 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1372 00000976 A2[37670000]            	mov	[msgNamBar+2], al
  1373 0000097B 88E3                    	mov	bl, ah
  1374 0000097D 88DA                    	mov	dl, bl
  1375 0000097F 80E30F                  	and	bl, 0Fh
  1376 00000982 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1377 00000988 A2[36670000]            	mov	[msgNamBar+1], al
  1378 0000098D 88D3                    	mov	bl, dl
  1379 0000098F C0EB04                  	shr	bl, 4
  1380 00000992 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1381 00000998 A2[35670000]            	mov	[msgNamBar], al
  1382                                  
  1383 0000099D 66A1[7E680000]          	mov	ax, [ac97_NabmBar]
  1384 000009A3 88C3                    	mov	bl, al
  1385 000009A5 88DA                    	mov	dl, bl
  1386 000009A7 80E30F                  	and	bl, 0Fh
  1387 000009AA 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1388 000009B0 A2[48670000]            	mov	[msgNabmBar+3], al
  1389 000009B5 88D3                    	mov	bl, dl
  1390 000009B7 C0EB04                  	shr	bl, 4
  1391 000009BA 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1392 000009C0 A2[47670000]            	mov	[msgNabmBar+2], al
  1393 000009C5 88E3                    	mov	bl, ah
  1394 000009C7 88DA                    	mov	dl, bl
  1395 000009C9 80E30F                  	and	bl, 0Fh
  1396 000009CC 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1397 000009D2 A2[46670000]            	mov	[msgNabmBar+1], al
  1398 000009D7 88D3                    	mov	bl, dl
  1399 000009D9 C0EB04                  	shr	bl, 4
  1400 000009DC 8A83[AF660000]          	mov	al, [ebx+hex_chars]
  1401 000009E2 A2[45670000]            	mov	[msgNabmBar], al
  1402                                  
  1403 000009E7 30E4                    	xor	ah, ah
  1404 000009E9 A0[72680000]            	mov	al, [ac97_int_ln_reg]
  1405 000009EE B10A                    	mov	cl, 10
  1406 000009F0 F6F1                    	div	cl
  1407 000009F2 660105[51670000]        	add	[msgIRQ], ax
  1408 000009F9 20C0                    	and	al, al
  1409 000009FB 750D                    	jnz	short _w_ac97imsg_
  1410 000009FD A0[52670000]            	mov	al, [msgIRQ+1]
  1411 00000A02 B420                    	mov	ah, ' '
  1412 00000A04 66A3[51670000]          	mov	[msgIRQ], ax
  1413                                  _w_ac97imsg_:
  1414                                  	sys	_msg, msgAC97Info, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A0A BB[C0660000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A0F B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A14 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A19 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A1E CD40                <1>  int 40h
  1415                                  
  1416 00000A20 C3                              retn
  1417                                  
  1418                                  write_VRA_info:
  1419                                  	; 25/11/2023
  1420                                  	sys	_msg, msgVRAheader, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A21 BB[A5670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A26 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A2B BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A30 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A35 CD40                <1>  int 40h
  1421 00000A37 803D[83680000]00        	cmp	byte [VRA], 0
  1422 00000A3E 7617                    	jna	short _w_VRAi_no
  1423                                  _w_VRAi_yes:
  1424                                  	sys	_msg, msgVRAyes, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A40 BB[B3670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A45 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A4A BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A4F B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A54 CD40                <1>  int 40h
  1425 00000A56 C3                      	retn
  1426                                  _w_VRAi_no:
  1427                                  	sys	_msg, msgVRAno, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A57 BB[B9670000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A5C B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A61 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A66 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A6B CD40                <1>  int 40h
  1428 00000A6D C3                      	retn
  1429                                  
  1430                                  ; 09/12/2023
  1431                                  ; --------------------------------------------------------
  1432                                  ; 'playwav6.s' (27/11/2023)
  1433                                  
  1434                                  ; 26/11/2023
  1435                                  ; 25/11/2023 - playwav6.s (32 bit registers, TRDOS 386 adaption)
  1436                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  1437                                  ; 14/11/2023
  1438                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1439                                  ; --------------------------------------------------------
  1440                                  
  1441                                  ;;Note:	At the end of every buffer load,
  1442                                  ;;	during buffer switch/swap, there will be discontinuity
  1443                                  ;;	between the last converted sample and the 1st sample
  1444                                  ;;	of the next buffer.
  1445                                  ;;	(like as a dot noises vaguely between normal sound samples)
  1446                                  ;;	-To avoid this defect, the 1st sample of
  1447                                  ;;	the next buffer may be read from the wav file but
  1448                                  ;;	the file pointer would need to be set to 1 sample back
  1449                                  ;;	again via seek system call. Time comsumption problem! -
  1450                                  ;;
  1451                                  ;;	Erdogan Tan - 15/11/2023
  1452                                  ;;
  1453                                  ;;	((If entire wav data would be loaded at once.. conversion
  1454                                  ;;	defect/noise would disappear.. but for DOS, to keep
  1455                                  ;;	64KB buffer limit is important also it is important
  1456                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1457                                  ;;	I have tested this program by using 2-30MB wav files.))
  1458                                  ;;
  1459                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1460                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1461                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1462                                  ;;			Realtek ALC850 codec.
  1463                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1464                                  
  1465                                  load_8khz_mono_8_bit:
  1466                                  	; 15/11/2023
  1467                                  	; 14/11/2023
  1468                                  	; 13/11/2023
  1469 00000A6E F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1470                                  					; last of the file?
  1471 00000A75 7402                    	jz	short lff8m_0		; no
  1472 00000A77 F9                      	stc
  1473 00000A78 C3                      	retn
  1474                                  
  1475                                  lff8m_0:
  1476 00000A79 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1477                                          ;mov	edx, [loadsize]
  1478                                  
  1479                                  	; esi = buffer address
  1480                                  	;; edx = buffer size
  1481                                  
  1482                                  	; load file into memory
  1483                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000A7E 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000A84 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000A86 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000A8C B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000A91 CD40                <1>  int 40h
  1484 00000A93 7305                    	jnc	short lff8m_6
  1485 00000A95 E9AF000000              	jmp	lff8m_5  ; error !
  1486                                  
  1487                                  lff8m_6:
  1488 00000A9A BF[00800000]            	mov	edi, audio_buffer
  1489 00000A9F 21C0                    	and	eax, eax
  1490 00000AA1 0F8499000000            	jz	lff8_eof
  1491                                  
  1492 00000AA7 89C1                    	mov	ecx, eax		; byte count
  1493                                  lff8m_1:
  1494 00000AA9 AC                      	lodsb
  1495 00000AAA A2[8E200000]            	mov	[previous_val], al
  1496 00000AAF 2C80                    	sub	al, 80h
  1497 00000AB1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1498 00000AB5 66AB                    	stosw		; original sample (left channel)
  1499 00000AB7 66AB                    	stosw		; original sample (right channel)
  1500                                  	;xor	eax, eax
  1501 00000AB9 B080                    	mov	al, 80h
  1502 00000ABB 49                      	dec	ecx
  1503 00000ABC 7402                    	jz	short lff8m_2
  1504 00000ABE 8A06                    	mov	al, [esi]
  1505                                  lff8m_2:
  1506                                  	;mov	[next_val], ax
  1507 00000AC0 88C7                    	mov	bh, al	; [next_val]
  1508 00000AC2 8A25[8E200000]          	mov	ah, [previous_val]
  1509 00000AC8 00E0                    	add	al, ah	; [previous_val]
  1510 00000ACA D0D8                    	rcr	al, 1
  1511 00000ACC 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  1512 00000ACE 00E0                    	add	al, ah	; [previous_val]
  1513 00000AD0 D0D8                    	rcr	al, 1	
  1514 00000AD2 88C3                    	mov	bl, al 	; this is temporary interpolation value	
  1515 00000AD4 00E0                    	add	al, ah	; [previous_val]
  1516 00000AD6 D0D8                    	rcr	al, 1
  1517 00000AD8 2C80                    	sub	al, 80h
  1518 00000ADA 66C1E008                	shl	ax, 8	
  1519 00000ADE 66AB                    	stosw		; this is 1st interpolated sample (L)
  1520 00000AE0 66AB                    	stosw		; this is 1st interpolated sample (R)
  1521 00000AE2 88D8                    	mov	al, bl
  1522 00000AE4 00D0                    	add	al, dl
  1523 00000AE6 D0D8                    	rcr	al, 1
  1524 00000AE8 2C80                    	sub	al, 80h
  1525 00000AEA 66C1E008                	shl	ax, 8
  1526 00000AEE 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1527 00000AF0 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1528 00000AF2 88D0                    	mov	al, dl
  1529 00000AF4 2C80                    	sub	al, 80h
  1530 00000AF6 66C1E008                	shl	ax, 8
  1531 00000AFA 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1532 00000AFC 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1533                                  	;mov	al, [next_val]
  1534 00000AFE 88F8                    	mov	al, bh
  1535 00000B00 00D0                    	add	al, dl
  1536 00000B02 D0D8                    	rcr	al, 1
  1537 00000B04 88C3                    	mov	bl, al	; this is temporary interpolation value
  1538 00000B06 00D0                    	add	al, dl
  1539 00000B08 D0D8                    	rcr	al, 1
  1540 00000B0A 2C80                    	sub	al, 80h
  1541 00000B0C 66C1E008                	shl	ax, 8
  1542 00000B10 66AB                    	stosw		; this is 4th interpolated sample (L)
  1543 00000B12 66AB                    	stosw		; this is 4th interpolated sample (R)
  1544                                  	;mov	al, [next_val]
  1545 00000B14 88F8                    	mov	al, bh
  1546 00000B16 00D8                    	add	al, bl
  1547 00000B18 D0D8                    	rcr	al, 1
  1548 00000B1A 2C80                    	sub	al, 80h
  1549 00000B1C 66C1E008                	shl	ax, 8
  1550 00000B20 66AB                    	stosw		; this is 5th interpolated sample (L)
  1551 00000B22 66AB                    	stosw		; this is 5th interpolated sample (R)
  1552                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1553 00000B24 09C9                    	or	ecx, ecx
  1554 00000B26 7581                    	jnz	short lff8m_1
  1555                                  
  1556                                  	; --------------
  1557                                  
  1558                                  lff8s_3:
  1559                                  lff8m_3:
  1560                                  lff8s2_3:
  1561                                  lff8m2_3:
  1562                                  lff16s_3:
  1563                                  lff16m_3:
  1564                                  lff16s2_3:
  1565                                  lff16m2_3:
  1566                                  lff24_3:
  1567                                  lff32_3:
  1568                                  lff44_3:
  1569                                  lff22_3:
  1570                                  lff11_3:
  1571                                  	; 08/12/2024 (BugFix)
  1572                                  	; 01/06/2024 (BugFix)
  1573 00000B28 8B0D[E1030000]          	mov	ecx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1574                                  	;shl	ecx, 1	; byte count ; Bug !
  1575                                  	; 08/12/2024
  1576 00000B2E 81C1[00800000]          	add	ecx, audio_buffer
  1577 00000B34 29F9                    	sub	ecx, edi
  1578 00000B36 7607                    	jna	short lff8m_4
  1579                                  	;inc	ecx
  1580 00000B38 C1E902                  	shr	ecx, 2
  1581 00000B3B 31C0                    	xor	eax, eax ; fill (remain part of) buffer with zeros
  1582 00000B3D F3AB                    	rep	stosd
  1583                                  lff8m_4:
  1584                                  	; 01/06/2024 (BugFix)
  1585                                  	; cf=1 ; Bug !
  1586                                  	; 08/12/2024
  1587                                  	;clc
  1588 00000B3F C3                      	retn
  1589                                  
  1590                                  lff8_eof:
  1591                                  lff16_eof:
  1592                                  lff24_eof:
  1593                                  lff32_eof:
  1594                                  lff44_eof:
  1595                                  lff22_eof:
  1596                                  lff11_eof:
  1597                                  	; 15/11/2023
  1598 00000B40 C605[80680000]01        	mov	byte [flags], ENDOFFILE
  1599 00000B47 EBDF                    	jmp	short lff8m_3
  1600                                  
  1601                                  lff8s_5:
  1602                                  lff8m_5:
  1603                                  lff8s2_5:
  1604                                  lff8m2_5:
  1605                                  lff16s_5:
  1606                                  lff16m_5:
  1607                                  lff16s2_5:
  1608                                  lff16m2_5:
  1609                                  lff24_5:
  1610                                  lff32_5:
  1611                                  lff44_5:
  1612                                  lff22_5:
  1613                                  lff11_5:
  1614                                  	; 09/12/2023	
  1615                                  	;mov	al, '!'  ; error
  1616                                  	;call	tL0
  1617                                  	
  1618                                  	;jmp	short lff8m_3
  1619                                  	; 15/11/2023
  1620 00000B49 EBF5                    	jmp	lff8_eof
  1621                                  
  1622                                  	; --------------
  1623                                  
  1624                                  load_8khz_stereo_8_bit:
  1625                                  	; 15/11/2023
  1626                                  	; 14/11/2023
  1627                                  	; 13/11/2023
  1628 00000B4B F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1629                                  					; last of the file?
  1630 00000B52 7402                    	jz	short lff8s_0		; no
  1631 00000B54 F9                      	stc
  1632 00000B55 C3                      	retn
  1633                                  
  1634                                  lff8s_0:
  1635 00000B56 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1636                                          ;mov	edx, [loadsize]
  1637                                  
  1638                                  	; esi = buffer address
  1639                                  	;; edx = buffer size
  1640                                  
  1641                                  	; load file into memory
  1642                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000B5B 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000B61 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000B63 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000B69 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000B6E CD40                <1>  int 40h
  1643 00000B70 72D7                    	jc	short lff8s_5 ; error !
  1644                                  
  1645 00000B72 BF[00800000]            	mov	edi, audio_buffer
  1646                                  	
  1647 00000B77 D1E8                    	shr	eax, 1
  1648 00000B79 74C5                    	jz	short lff8_eof
  1649                                  
  1650 00000B7B 89C1                    	mov	ecx, eax	; word count
  1651                                  lff8s_1:
  1652 00000B7D AC                      	lodsb
  1653 00000B7E A2[8E200000]            	mov	[previous_val_l], al
  1654 00000B83 2C80                    	sub	al, 80h
  1655 00000B85 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1656 00000B89 66AB                    	stosw		; original sample (L)
  1657 00000B8B AC                      	lodsb
  1658 00000B8C A2[90200000]            	mov	[previous_val_r], al
  1659 00000B91 2C80                    	sub	al, 80h
  1660 00000B93 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1661 00000B97 66AB                    	stosw		; original sample (R)
  1662                                  
  1663                                  	;xor	eax, eax
  1664 00000B99 66B88080                	mov	ax, 8080h
  1665 00000B9D 49                      	dec	ecx
  1666 00000B9E 7403                    	jz	short lff8s_2
  1667                                  		; convert 8 bit sample to 16 bit sample
  1668 00000BA0 668B06                  	mov	ax, [esi]
  1669                                  lff8s_2:
  1670 00000BA3 A2[92200000]            	mov	[next_val_l], al
  1671 00000BA8 8825[94200000]          	mov	[next_val_r], ah
  1672 00000BAE 8A25[8E200000]          	mov	ah, [previous_val_l]
  1673 00000BB4 00E0                    	add	al, ah
  1674 00000BB6 D0D8                    	rcr	al, 1
  1675 00000BB8 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1676 00000BBA 00E0                    	add	al, ah
  1677 00000BBC D0D8                    	rcr	al, 1	
  1678 00000BBE 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1679 00000BC0 00E0                    	add	al, ah
  1680 00000BC2 D0D8                    	rcr	al, 1
  1681 00000BC4 2C80                    	sub	al, 80h
  1682 00000BC6 66C1E008                	shl	ax, 8
  1683 00000BCA 66AB                    	stosw		; this is 1st interpolated sample (L)
  1684 00000BCC A0[94200000]            	mov	al, [next_val_r]
  1685 00000BD1 8A25[90200000]          	mov	ah, [previous_val_r]
  1686 00000BD7 00E0                    	add	al, ah
  1687 00000BD9 D0D8                    	rcr	al, 1
  1688 00000BDB 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1689 00000BDD 00E0                    	add	al, ah
  1690 00000BDF D0D8                    	rcr	al, 1
  1691 00000BE1 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1692 00000BE3 00E0                    	add	al, ah
  1693 00000BE5 D0D8                    	rcr	al, 1
  1694 00000BE7 2C80                    	sub	al, 80h
  1695 00000BE9 66C1E008                	shl	ax, 8
  1696 00000BED 66AB                    	stosw		; this is 1st interpolated sample (R)
  1697 00000BEF 88D8                    	mov	al, bl
  1698 00000BF1 00D0                    	add	al, dl
  1699 00000BF3 D0D8                    	rcr	al, 1
  1700 00000BF5 2C80                    	sub	al, 80h
  1701 00000BF7 66C1E008                	shl	ax, 8
  1702 00000BFB 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1703 00000BFD 88F8                    	mov	al, bh
  1704 00000BFF 00F0                    	add	al, dh
  1705 00000C01 D0D8                    	rcr	al, 1
  1706 00000C03 2C80                    	sub	al, 80h
  1707 00000C05 66C1E008                	shl	ax, 8
  1708 00000C09 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1709 00000C0B 88D0                    	mov	al, dl
  1710 00000C0D 2C80                    	sub	al, 80h
  1711 00000C0F 66C1E008                	shl	ax, 8
  1712 00000C13 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1713 00000C15 88F0                    	mov	al, dh
  1714 00000C17 2C80                    	sub	al, 80h
  1715 00000C19 66C1E008                	shl	ax, 8
  1716 00000C1D 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1717 00000C1F A0[92200000]            	mov	al, [next_val_l]
  1718 00000C24 00D0                    	add	al, dl
  1719 00000C26 D0D8                    	rcr	al, 1
  1720 00000C28 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1721 00000C2A 00D0                    	add	al, dl
  1722 00000C2C D0D8                    	rcr	al, 1
  1723 00000C2E 2C80                    	sub	al, 80h
  1724 00000C30 66C1E008                	shl	ax, 8
  1725 00000C34 66AB                    	stosw		; this is 4th interpolated sample (L)
  1726 00000C36 A0[94200000]            	mov	al, [next_val_r]
  1727 00000C3B 00F0                    	add	al, dh
  1728 00000C3D D0D8                    	rcr	al, 1
  1729 00000C3F 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1730 00000C41 00F0                    	add	al, dh
  1731 00000C43 D0D8                    	rcr	al, 1
  1732 00000C45 2C80                    	sub	al, 80h
  1733 00000C47 66C1E008                	shl	ax, 8
  1734 00000C4B 66AB                    	stosw		; this is 4th interpolated sample (R)
  1735 00000C4D A0[92200000]            	mov	al, [next_val_l]
  1736 00000C52 00D8                    	add	al, bl
  1737 00000C54 D0D8                    	rcr	al, 1
  1738 00000C56 2C80                    	sub	al, 80h
  1739 00000C58 66C1E008                	shl	ax, 8
  1740 00000C5C 66AB                    	stosw		; this is 5th interpolated sample (L)
  1741 00000C5E A0[94200000]            	mov	al, [next_val_r]
  1742 00000C63 00F8                    	add	al, bh
  1743 00000C65 D0D8                    	rcr	al, 1
  1744 00000C67 2C80                    	sub	al, 80h
  1745 00000C69 66C1E008                	shl	ax, 8
  1746 00000C6D 66AB                    	stosw		; this is 5th interpolated sample (R)
  1747                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1748 00000C6F E305                    	jecxz	lff8s_6
  1749 00000C71 E907FFFFFF              	jmp	lff8s_1
  1750                                  lff8s_6:
  1751 00000C76 E9ADFEFFFF              	jmp	lff8s_3
  1752                                  
  1753                                  load_8khz_mono_16_bit:
  1754                                  	; 13/11/2023
  1755 00000C7B F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1756                                  					; last of the file?
  1757 00000C82 7402                    	jz	short lff8m2_0		; no
  1758 00000C84 F9                      	stc
  1759 00000C85 C3                      	retn
  1760                                  
  1761                                  lff8m2_0:
  1762 00000C86 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1763                                          ;mov	edx, [loadsize]
  1764                                  
  1765                                  	; esi = buffer address
  1766                                  	;; edx = buffer size
  1767                                  
  1768                                  	; load file into memory
  1769                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000C8B 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000C91 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000C93 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000C99 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000C9E CD40                <1>  int 40h
  1770 00000CA0 0F82A0000000            	jc	lff8m2_7 ; error !
  1771                                  
  1772 00000CA6 BF[00800000]            	mov	edi, audio_buffer
  1773                                  	
  1774 00000CAB D1E8                    	shr	eax, 1
  1775 00000CAD 7505                    	jnz	short lff8m2_8
  1776 00000CAF E98CFEFFFF              	jmp	lff8_eof
  1777                                  
  1778                                  lff8m2_8:
  1779 00000CB4 89C1                    	mov	ecx, eax	; word count
  1780                                  lff8m2_1:
  1781 00000CB6 66AD                    	lodsw
  1782 00000CB8 66AB                    	stosw		; original sample (left channel)
  1783 00000CBA 66AB                    	stosw		; original sample (right channel)
  1784 00000CBC 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1785 00000CBF 66A3[8E200000]          	mov	[previous_val], ax
  1786 00000CC5 31C0                    	xor	eax, eax
  1787 00000CC7 49                      	dec	ecx
  1788 00000CC8 7403                    	jz	short lff8m2_2
  1789 00000CCA 668B06                  	mov	ax, [esi]
  1790                                  lff8m2_2:
  1791 00000CCD 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  1792 00000CD0 89C5                    	mov	ebp, eax	; [next_val]
  1793 00000CD2 660305[8E200000]        	add	ax, [previous_val]
  1794 00000CD9 66D1D8                  	rcr	ax, 1
  1795 00000CDC 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample
  1796 00000CDE 660305[8E200000]        	add	ax, [previous_val]
  1797 00000CE5 66D1D8                  	rcr	ax, 1	; this is temporary interpolation value
  1798 00000CE8 89C3                    	mov	ebx, eax 		
  1799 00000CEA 660305[8E200000]        	add	ax, [previous_val]
  1800 00000CF1 66D1D8                  	rcr	ax, 1
  1801 00000CF4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1802 00000CF7 66AB                    	stosw		; this is 1st interpolated sample (L)
  1803 00000CF9 66AB                    	stosw		; this is 1st interpolated sample (R)
  1804 00000CFB 89D8                    	mov	eax, ebx
  1805 00000CFD 6601D0                  	add	ax, dx
  1806 00000D00 66D1D8                  	rcr	ax, 1
  1807 00000D03 80EC80                  	sub	ah, 80h
  1808 00000D06 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1809 00000D08 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1810 00000D0A 89D0                    	mov	eax, edx
  1811 00000D0C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1812 00000D0F 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1813 00000D11 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1814 00000D13 89E8                    	mov	eax, ebp
  1815 00000D15 6601D0                  	add	ax, dx
  1816 00000D18 66D1D8                  	rcr	ax, 1
  1817 00000D1B 89C3                    	mov	ebx, eax ; this is temporary interpolation value
  1818 00000D1D 6601D0                  	add	ax, dx
  1819 00000D20 66D1D8                  	rcr	ax, 1
  1820 00000D23 80EC80                  	sub	ah, 80h
  1821 00000D26 66AB                    	stosw		; this is 4th interpolated sample (L)
  1822 00000D28 66AB                    	stosw		; this is 4th interpolated sample (R)
  1823 00000D2A 89E8                    	mov	eax, ebp
  1824 00000D2C 6601D8                  	add	ax, bx
  1825 00000D2F 66D1D8                  	rcr	ax, 1
  1826 00000D32 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1827 00000D35 66AB                    	stosw		; this is 5th interpolated sample (L)
  1828 00000D37 66AB                    	stosw		; this is 5th interpolated sample (R)
  1829                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1830 00000D39 09C9                    	or	ecx, ecx
  1831 00000D3B 0F8575FFFFFF            	jnz	lff8m2_1
  1832 00000D41 E9E2FDFFFF              	jmp	lff8m2_3
  1833                                  
  1834                                  lff8m2_7:
  1835                                  lff8s2_7:
  1836 00000D46 E9FEFDFFFF              	jmp	lff8m2_5  ; error
  1837                                  
  1838                                  load_8khz_stereo_16_bit:
  1839                                  	; 16/11/2023
  1840                                  	; 15/11/2023
  1841                                  	; 13/11/2023
  1842 00000D4B F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1843                                  					; last of the file?
  1844 00000D52 7402                    	jz	short lff8s2_0		; no
  1845 00000D54 F9                      	stc
  1846 00000D55 C3                      	retn
  1847                                  
  1848                                  lff8s2_0:
  1849 00000D56 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1850                                          ;mov	edx, [loadsize]
  1851                                  
  1852                                  	; esi = buffer address
  1853                                  	;; edx = buffer size
  1854                                  
  1855                                  	; load file into memory
  1856                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000D5B 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000D61 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000D63 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000D69 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000D6E CD40                <1>  int 40h
  1857 00000D70 72D4                    	jc	short lff8s2_7 ; error !
  1858                                  
  1859 00000D72 BF[00800000]            	mov	edi, audio_buffer
  1860                                  	
  1861 00000D77 C1E802                  	shr	eax, 2
  1862 00000D7A 7505                    	jnz	short lff8s2_8
  1863 00000D7C E9BFFDFFFF              	jmp	lff8_eof
  1864                                  
  1865                                  lff8s2_8:
  1866 00000D81 89C1                    	mov	ecx, eax ; dword count
  1867                                  lff8s2_1:
  1868 00000D83 66AD                    	lodsw
  1869 00000D85 66AB                    	stosw		; original sample (L)
  1870                                  	; 15/11/2023
  1871 00000D87 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1872 00000D8A 66A3[8E200000]          	mov	[previous_val_l], ax
  1873 00000D90 66AD                    	lodsw
  1874 00000D92 66AB                    	stosw		; original sample (R)
  1875 00000D94 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1876 00000D97 66A3[90200000]          	mov	[previous_val_r], ax
  1877 00000D9D 31D2                    	xor	edx, edx
  1878 00000D9F 31C0                    	xor	eax, eax
  1879                                  	; 16/11/2023
  1880 00000DA1 49                      	dec	ecx
  1881 00000DA2 7407                    	jz	short lff8s2_2
  1882 00000DA4 668B06                  	mov	ax, [esi]
  1883 00000DA7 668B5602                	mov	dx, [esi+2]
  1884                                  lff8s2_2:
  1885 00000DAB 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1886 00000DAE 66A3[92200000]          	mov	[next_val_l], ax
  1887 00000DB4 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  1888 00000DB7 668915[94200000]        	mov	[next_val_r], dx
  1889 00000DBE 660305[8E200000]        	add	ax, [previous_val_l]
  1890 00000DC5 66D1D8                  	rcr	ax, 1
  1891 00000DC8 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample (L)
  1892 00000DCA 660305[8E200000]        	add	ax, [previous_val_l]
  1893 00000DD1 66D1D8                  	rcr	ax, 1	
  1894 00000DD4 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1895 00000DD6 660305[8E200000]        	add	ax, [previous_val_l]
  1896 00000DDD 66D1D8                  	rcr	ax, 1
  1897 00000DE0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1898 00000DE3 66AB                    	stosw		; this is 1st interpolated sample (L)
  1899 00000DE5 66A1[94200000]          	mov	ax, [next_val_r]
  1900 00000DEB 660305[90200000]        	add	ax, [previous_val_r]
  1901 00000DF2 66D1D8                  	rcr	ax, 1
  1902 00000DF5 89C5                    	mov	ebp, eax ; this is interpolated middle (3th) sample (R)
  1903 00000DF7 660305[90200000]        	add	ax, [previous_val_r]
  1904 00000DFE 66D1D8                  	rcr	ax, 1
  1905 00000E01 50                      	push	eax ; *	; this is temporary interpolation value (R)
  1906 00000E02 660305[90200000]        	add	ax, [previous_val_r]
  1907 00000E09 66D1D8                  	rcr	ax, 1
  1908 00000E0C 80EC80                  	sub	ah, 80h
  1909 00000E0F 66AB                    	stosw		; this is 1st interpolated sample (R)
  1910 00000E11 89D8                    	mov	eax, ebx
  1911 00000E13 6601D0                  	add	ax, dx
  1912 00000E16 66D1D8                  	rcr	ax, 1
  1913 00000E19 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1914 00000E1C 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1915 00000E1E 58                      	pop	eax ; *
  1916 00000E1F 6601E8                  	add	ax, bp
  1917 00000E22 66D1D8                  	rcr	ax, 1
  1918 00000E25 80EC80                  	sub	ah, 80h
  1919 00000E28 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1920 00000E2A 89D0                    	mov	eax, edx
  1921 00000E2C 80EC80                  	sub	ah, 80h
  1922 00000E2F 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1923 00000E31 89E8                    	mov	eax, ebp
  1924 00000E33 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1925 00000E36 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1926 00000E38 66A1[92200000]          	mov	ax, [next_val_l]
  1927 00000E3E 6601D0                  	add	ax, dx
  1928 00000E41 66D1D8                  	rcr	ax, 1
  1929 00000E44 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1930 00000E46 6601D0                  	add	ax, dx
  1931 00000E49 66D1D8                  	rcr	ax, 1
  1932 00000E4C 80EC80                  	sub	ah, 80h
  1933 00000E4F 66AB                    	stosw		; this is 4th interpolated sample (L)
  1934 00000E51 66A1[94200000]          	mov	ax, [next_val_r]
  1935 00000E57 6601E8                  	add	ax, bp
  1936 00000E5A 66D1D8                  	rcr	ax, 1
  1937 00000E5D 50                      	push	eax ; ** ; this is temporary interpolation value (R)
  1938 00000E5E 6601E8                  	add	ax, bp
  1939 00000E61 66D1D8                  	rcr	ax, 1
  1940 00000E64 80EC80                  	sub	ah, 80h
  1941 00000E67 66AB                    	stosw		; this is 4th interpolated sample (R)
  1942 00000E69 66A1[92200000]          	mov	ax, [next_val_l]
  1943 00000E6F 6601D8                  	add	ax, bx
  1944 00000E72 66D1D8                  	rcr	ax, 1
  1945 00000E75 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1946 00000E78 66AB                    	stosw		; this is 5th interpolated sample (L)
  1947 00000E7A 58                      	pop	eax ; **
  1948 00000E7B 660305[94200000]        	add	ax, [next_val_r]
  1949 00000E82 66D1D8                  	rcr	ax, 1
  1950 00000E85 80EC80                  	sub	ah, 80h
  1951 00000E88 66AB                    	stosw		; this is 5th interpolated sample (R)
  1952                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1953 00000E8A E305                    	jecxz	lff8_s2_9
  1954 00000E8C E9F2FEFFFF              	jmp	lff8s2_1
  1955                                  lff8_s2_9:
  1956 00000E91 E992FCFFFF              	jmp	lff8s2_3
  1957                                  
  1958                                  ; .....................
  1959                                  
  1960                                  load_16khz_mono_8_bit:
  1961                                  	; 14/11/2023
  1962                                  	; 13/11/2023
  1963 00000E96 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1964                                  					; last of the file?
  1965 00000E9D 7402                    	jz	short lff16m_0		; no
  1966 00000E9F F9                      	stc
  1967 00000EA0 C3                      	retn
  1968                                  
  1969                                  lff16m_0:
  1970 00000EA1 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1971                                          ;mov	edx, [loadsize]
  1972                                  
  1973                                  	; esi = buffer address
  1974                                  	;; edx = buffer size
  1975                                  
  1976                                  	; load file into memory
  1977                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000EA6 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000EAC 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000EAE 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000EB4 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000EB9 CD40                <1>  int 40h
  1978 00000EBB 7253                    	jc	short lff16m_7 ; error !
  1979                                  
  1980 00000EBD BF[00800000]            	mov	edi, audio_buffer
  1981                                  	
  1982 00000EC2 21C0                    	and	eax, eax
  1983 00000EC4 7505                    	jnz	short lff16m_8
  1984 00000EC6 E975FCFFFF              	jmp	lff16_eof
  1985                                  
  1986                                  lff16m_8:
  1987 00000ECB 89C1                    	mov	ecx, eax		; byte count
  1988                                  lff16m_1:
  1989 00000ECD AC                      	lodsb
  1990                                  	;mov	[previous_val], al
  1991 00000ECE 88C3                    	mov	bl, al
  1992 00000ED0 2C80                    	sub	al, 80h
  1993 00000ED2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1994 00000ED6 66AB                    	stosw		; original sample (left channel)
  1995 00000ED8 66AB                    	stosw		; original sample (right channel)
  1996                                  	;xor	ax, ax
  1997                                  	; 14/11/22023
  1998 00000EDA B080                    	mov	al, 80h
  1999 00000EDC 49                      	dec	ecx
  2000 00000EDD 7402                    	jz	short lff16m_2
  2001 00000EDF 8A06                    	mov	al, [esi]
  2002                                  lff16m_2:
  2003                                  	;mov	[next_val], al
  2004 00000EE1 88C7                    	mov	bh, al
  2005                                  	;add	al, [previous_val]
  2006 00000EE3 00D8                    	add	al, bl
  2007 00000EE5 D0D8                    	rcr	al, 1
  2008 00000EE7 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  2009                                  	;add	al, [previous_val]
  2010 00000EE9 00D8                    	add	al, bl
  2011 00000EEB D0D8                    	rcr	al, 1
  2012 00000EED 2C80                    	sub	al, 80h
  2013 00000EEF 66C1E008                	shl	ax, 8
  2014 00000EF3 66AB                    	stosw		; this is 1st interpolated sample (L)
  2015 00000EF5 66AB                    	stosw		; this is 1st interpolated sample (R)
  2016                                  	;mov	al, [next_val]
  2017 00000EF7 88F8                    	mov	al, bh
  2018 00000EF9 00D0                    	add	al, dl
  2019 00000EFB D0D8                    	rcr	al, 1
  2020 00000EFD 2C80                    	sub	al, 80h
  2021 00000EFF 66C1E008                	shl	ax, 8
  2022 00000F03 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2023 00000F05 66AB                    	stosw		; this is 2nd interpolated sample (R)
  2024                                  	
  2025                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2026 00000F07 09C9                    	or	ecx, ecx
  2027 00000F09 75C2                    	jnz	short lff16m_1
  2028 00000F0B E918FCFFFF              	jmp	lff16m_3
  2029                                  
  2030                                  lff16m_7:
  2031                                  lff16s_7:
  2032 00000F10 E934FCFFFF              	jmp	lff16m_5  ; error
  2033                                  
  2034                                  load_16khz_stereo_8_bit:
  2035                                  	; 14/11/2023
  2036                                  	; 13/11/2023
  2037 00000F15 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2038                                  					; last of the file?
  2039 00000F1C 7402                    	jz	short lff16s_0		; no
  2040 00000F1E F9                      	stc
  2041 00000F1F C3                      	retn
  2042                                  
  2043                                  lff16s_0:
  2044 00000F20 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2045                                          ;mov	edx, [loadsize]
  2046                                  
  2047                                  	; esi = buffer address
  2048                                  	;; edx = buffer size
  2049                                  
  2050                                  	; load file into memory
  2051                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000F25 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000F2B 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000F2D 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000F33 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000F38 CD40                <1>  int 40h
  2052 00000F3A 72D4                    	jc	short lff16s_7 ; error !
  2053                                  
  2054 00000F3C BF[00800000]            	mov	edi, audio_buffer
  2055                                  	
  2056 00000F41 D1E8                    	shr	eax, 1
  2057 00000F43 7505                    	jnz	short lff16s_8
  2058 00000F45 E9F6FBFFFF              	jmp	lff16_eof
  2059                                  
  2060                                  lff16s_8:
  2061 00000F4A 89C1                    	mov	ecx, eax	; word count
  2062                                  lff16s_1:
  2063 00000F4C AC                      	lodsb
  2064 00000F4D A2[8E200000]            	mov	[previous_val_l], al
  2065 00000F52 2C80                    	sub	al, 80h
  2066 00000F54 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2067 00000F58 66AB                    	stosw		; original sample (L)
  2068 00000F5A AC                      	lodsb
  2069 00000F5B A2[90200000]            	mov	[previous_val_r], al
  2070 00000F60 2C80                    	sub	al, 80h
  2071 00000F62 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2072 00000F66 66AB                    	stosw		; original sample (R)
  2073                                  
  2074                                  	;xor	eax, eax
  2075 00000F68 66B88080                	mov	ax, 8080h
  2076 00000F6C 49                      	dec	ecx
  2077 00000F6D 7403                    	jz	short lff16s_2
  2078                                  		; convert 8 bit sample to 16 bit sample
  2079 00000F6F 668B06                  	mov	ax, [esi]
  2080                                  lff16s_2:
  2081                                  	;mov	[next_val_l], al
  2082                                  	;mov	[next_val_r], ah
  2083 00000F72 89C3                    	mov	ebx, eax
  2084 00000F74 0205[8E200000]          	add	al, [previous_val_l]
  2085 00000F7A D0D8                    	rcr	al, 1
  2086 00000F7C 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  2087 00000F7E 0205[8E200000]          	add	al, [previous_val_l]
  2088 00000F84 D0D8                    	rcr	al, 1
  2089 00000F86 2C80                    	sub	al, 80h
  2090 00000F88 66C1E008                	shl	ax, 8
  2091 00000F8C 66AB                    	stosw		; this is 1st interpolated sample (L)
  2092 00000F8E 88F8                    	mov	al, bh	; [next_val_r]
  2093 00000F90 0205[90200000]          	add	al, [previous_val_r]
  2094 00000F96 D0D8                    	rcr	al, 1
  2095 00000F98 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  2096 00000F9A 0205[90200000]          	add	al, [previous_val_r]
  2097 00000FA0 D0D8                    	rcr	al, 1
  2098 00000FA2 2C80                    	sub	al, 80h
  2099 00000FA4 66C1E008                	shl	ax, 8
  2100 00000FA8 66AB                    	stosw		; this is 1st interpolated sample (R)
  2101 00000FAA 88D0                    	mov	al, dl
  2102 00000FAC 00D8                    	add	al, bl	; [next_val_l]
  2103 00000FAE D0D8                    	rcr	al, 1
  2104 00000FB0 2C80                    	sub	al, 80h
  2105 00000FB2 66C1E008                	shl	ax, 8
  2106 00000FB6 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2107 00000FB8 88F0                    	mov	al, dh
  2108 00000FBA 00F8                    	add	al, bh	; [next_val_r]
  2109 00000FBC D0D8                    	rcr	al, 1
  2110 00000FBE 2C80                    	sub	al, 80h
  2111 00000FC0 66C1E008                	shl	ax, 8
  2112 00000FC4 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  2113                                  	
  2114                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2115 00000FC6 09C9                    	or	ecx, ecx
  2116 00000FC8 7582                    	jnz	short lff16s_1
  2117 00000FCA E959FBFFFF              	jmp	lff16s_3
  2118                                  
  2119                                  load_16khz_mono_16_bit:
  2120                                  	; 15/11/2023
  2121                                  	; 13/11/2023
  2122 00000FCF F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2123                                  					; last of the file?
  2124 00000FD6 7402                    	jz	short lff16m2_0		; no
  2125 00000FD8 F9                      	stc
  2126 00000FD9 C3                      	retn
  2127                                  
  2128                                  lff16m2_0:
  2129 00000FDA BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2130                                          ;mov	edx, [loadsize]
  2131                                  
  2132                                  	; esi = buffer address
  2133                                  	;; edx = buffer size
  2134                                  
  2135                                  	; load file into memory
  2136                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000FDF 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000FE5 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000FE7 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000FED B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000FF2 CD40                <1>  int 40h
  2137 00000FF4 7255                    	jc	short lff16m2_7 ; error !
  2138                                  
  2139 00000FF6 BF[00800000]            	mov	edi, audio_buffer
  2140                                  	
  2141 00000FFB D1E8                    	shr	eax, 1
  2142 00000FFD 7505                    	jnz	short lff16m2_8
  2143 00000FFF E93CFBFFFF              	jmp	lff16_eof
  2144                                  
  2145                                  lff16m2_8:
  2146 00001004 89C1                    	mov	ecx, eax  ; word count
  2147                                  lff16m2_1:
  2148 00001006 66AD                    	lodsw
  2149 00001008 66AB                    	stosw		; original sample (left channel)
  2150 0000100A 66AB                    	stosw		; original sample (right channel)
  2151 0000100C 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2152                                  	;mov	[previous_val], ax
  2153 0000100F 89C3                    	mov	ebx, eax	
  2154 00001011 31C0                    	xor	eax, eax
  2155 00001013 49                      	dec	ecx
  2156 00001014 7403                    	jz	short lff16m2_2
  2157 00001016 668B06                  	mov	ax, [esi]
  2158                                  lff16m2_2:
  2159 00001019 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2160 0000101C 89C5                    	mov	ebp, eax	; [next_val]
  2161                                  	;add	ax, [previous_val]
  2162 0000101E 6601D8                  	add	ax, bx
  2163 00001021 66D1D8                  	rcr	ax, 1
  2164 00001024 89C2                    	mov	edx, eax ; this is temporary interpolation value
  2165                                  	;add	ax, [previous_val]
  2166 00001026 6601D8                  	add	ax, bx
  2167 00001029 66D1D8                  	rcr	ax, 1
  2168 0000102C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2169 0000102F 66AB                    	stosw		; this is 1st interpolated sample (L)
  2170 00001031 66AB                    	stosw		; this is 1st interpolated sample (R)
  2171 00001033 89E8                    	mov	eax, ebp 
  2172 00001035 6601D0                  	add	ax, dx
  2173 00001038 66D1D8                  	rcr	ax, 1
  2174 0000103B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2175 0000103E 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2176 00001040 66AB                    	stosw		; this is 2nd interpolated sample (R)
  2177                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2178 00001042 09C9                    	or	ecx, ecx
  2179 00001044 75C0                    	jnz	short lff16m2_1
  2180 00001046 E9DDFAFFFF              	jmp	lff16m2_3
  2181                                  
  2182                                  lff16m2_7:
  2183                                  lff16s2_7:
  2184 0000104B E9F9FAFFFF              	jmp	lff16m2_5  ; error
  2185                                  
  2186                                  load_16khz_stereo_16_bit:
  2187                                  	; 16/11/2023
  2188                                  	; 15/11/2023
  2189                                  	; 13/11/2023
  2190 00001050 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2191                                  					; last of the file?
  2192 00001057 7402                    	jz	short lff16s2_0		; no
  2193 00001059 F9                      	stc
  2194 0000105A C3                      	retn
  2195                                  
  2196                                  lff16s2_0:
  2197 0000105B BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2198                                          ;mov	edx, [loadsize]
  2199                                  
  2200                                  	; esi = buffer address
  2201                                  	;; edx = buffer size
  2202                                  
  2203                                  	; load file into memory
  2204                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001060 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001066 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001068 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000106E B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001073 CD40                <1>  int 40h
  2205 00001075 72D4                    	jc	short lff16s2_7 ; error !
  2206                                  
  2207 00001077 BF[00800000]            	mov	edi, audio_buffer
  2208                                  	
  2209 0000107C C1E802                  	shr	eax, 2
  2210 0000107F 7505                    	jnz	short lff16s2_8
  2211 00001081 E9BAFAFFFF              	jmp	lff16_eof
  2212                                  
  2213                                  lff16s2_8:
  2214 00001086 89C1                    	mov	ecx, eax  ; dword count
  2215                                  lff16s2_1:
  2216 00001088 66AD                    	lodsw
  2217 0000108A 66AB                    	stosw		; original sample (L)
  2218 0000108C 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2219 0000108F 66A3[8E200000]          	mov	[previous_val_l], ax
  2220 00001095 66AD                    	lodsw
  2221 00001097 66AB                    	stosw		; original sample (R)
  2222 00001099 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2223 0000109C 66A3[90200000]          	mov	[previous_val_r], ax
  2224 000010A2 31D2                    	xor	edx, edx
  2225 000010A4 31C0                    	xor	eax, eax
  2226                                  	; 16/11/2023
  2227 000010A6 49                      	dec	ecx
  2228 000010A7 7407                    	jz	short lff16s2_2
  2229 000010A9 668B06                  	mov	ax, [esi]
  2230 000010AC 668B5602                	mov	dx, [esi+2]
  2231                                  lff16s2_2:
  2232 000010B0 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2233                                  	;mov	[next_val_l], ax
  2234 000010B3 89C5                    	mov	ebp, eax
  2235 000010B5 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2236 000010B8 668915[94200000]        	mov	[next_val_r], dx
  2237 000010BF 660305[8E200000]        	add	ax, [previous_val_l]
  2238 000010C6 66D1D8                  	rcr	ax, 1
  2239 000010C9 89C2                    	mov	edx, eax ; this is temporary interpolation value (L)
  2240 000010CB 660305[8E200000]        	add	ax, [previous_val_l]
  2241 000010D2 66D1D8                  	rcr	ax, 1
  2242 000010D5 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2243 000010D8 66AB                    	stosw		; this is 1st interpolated sample (L)
  2244 000010DA 66A1[94200000]          	mov	ax, [next_val_r]
  2245 000010E0 660305[90200000]        	add	ax, [previous_val_r]
  2246 000010E7 66D1D8                  	rcr	ax, 1
  2247 000010EA 89C3                    	mov	ebx, eax ; this is temporary interpolation value (R)
  2248 000010EC 660305[90200000]        	add	ax, [previous_val_r]
  2249 000010F3 66D1D8                  	rcr	ax, 1
  2250 000010F6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2251 000010F9 66AB                    	stosw		; this is 1st interpolated sample (R)
  2252                                  	;mov	ax, [next_val_l]
  2253 000010FB 89E8                    	mov	eax, ebp
  2254 000010FD 6601D0                  	add	ax, dx
  2255 00001100 66D1D8                  	rcr	ax, 1
  2256 00001103 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2257 00001106 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2258 00001108 66A1[94200000]          	mov	ax, [next_val_r]
  2259 0000110E 6601D8                  	add	ax, bx
  2260 00001111 66D1D8                  	rcr	ax, 1
  2261 00001114 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2262 00001117 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  2263                                  	
  2264                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2265 00001119 09C9                    	or	ecx, ecx
  2266 0000111B 0F8567FFFFFF            	jnz	lff16s2_1
  2267 00001121 E902FAFFFF              	jmp	lff16s2_3
  2268                                  
  2269                                  ; .....................
  2270                                  
  2271                                  load_24khz_mono_8_bit:
  2272                                  	; 15/11/2023
  2273 00001126 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2274                                  					; last of the file?
  2275 0000112D 7402                    	jz	short lff24m_0		; no
  2276 0000112F F9                      	stc
  2277 00001130 C3                      	retn
  2278                                  
  2279                                  lff24m_0:
  2280 00001131 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2281                                          ;mov	edx, [loadsize]
  2282                                  
  2283                                  	; esi = buffer address
  2284                                  	;; edx = buffer size
  2285                                  
  2286                                  	; load file into memory
  2287                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001136 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000113C 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000113E 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001144 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001149 CD40                <1>  int 40h
  2288 0000114B 723B                    	jc	short lff24m_7 ; error !
  2289                                  
  2290 0000114D BF[00800000]            	mov	edi, audio_buffer
  2291                                  	
  2292 00001152 21C0                    	and	eax, eax
  2293 00001154 7505                    	jnz	short lff24m_8
  2294 00001156 E9E5F9FFFF              	jmp	lff24_eof
  2295                                  
  2296                                  lff24m_8:
  2297 0000115B 89C1                    	mov	ecx, eax	; byte count
  2298                                  lff24m_1:
  2299 0000115D AC                      	lodsb
  2300                                  	;mov	[previous_val], al
  2301 0000115E 88C3                    	mov	bl, al
  2302 00001160 2C80                    	sub	al, 80h
  2303 00001162 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2304 00001166 66AB                    	stosw		; original sample (left channel)
  2305 00001168 66AB                    	stosw		; original sample (right channel)
  2306                                  	;xor	eax, eax
  2307 0000116A B080                    	mov	al, 80h
  2308 0000116C 49                      	dec	ecx
  2309 0000116D 7402                    	jz	short lff24m_2
  2310 0000116F 8A06                    	mov	al, [esi]
  2311                                  lff24m_2:
  2312                                  	;;mov	[next_val], al
  2313                                  	;mov	bh, al
  2314                                  	;add	al, [previous_val]
  2315 00001171 00D8                    	add	al, bl
  2316 00001173 D0D8                    	rcr	al, 1
  2317 00001175 2C80                    	sub	al, 80h
  2318 00001177 66C1E008                	shl	ax, 8
  2319 0000117B 66AB                    	stosw		; this is interpolated sample (L)
  2320 0000117D 66AB                    	stosw		; this is interpolated sample (R)
  2321                                  	
  2322                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2323 0000117F 09C9                    	or	ecx, ecx
  2324 00001181 75DA                    	jnz	short lff24m_1
  2325 00001183 E9A0F9FFFF              	jmp	lff24_3
  2326                                  
  2327                                  lff24m_7:
  2328                                  lff24s_7:
  2329 00001188 E9BCF9FFFF              	jmp	lff24_5  ; error
  2330                                  
  2331                                  load_24khz_stereo_8_bit:
  2332                                  	; 15/11/2023
  2333 0000118D F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2334                                  					; last of the file?
  2335 00001194 7402                    	jz	short lff24s_0		; no
  2336 00001196 F9                      	stc
  2337 00001197 C3                      	retn
  2338                                  
  2339                                  lff24s_0:
  2340 00001198 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2341                                          ;mov	edx, [loadsize]
  2342                                  
  2343                                  	; esi = buffer address
  2344                                  	;; edx = buffer size
  2345                                  
  2346                                  	; load file into memory
  2347                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000119D 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000011A3 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000011A5 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000011AB B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000011B0 CD40                <1>  int 40h
  2348 000011B2 72D4                    	jc	short lff24s_7 ; error !
  2349                                  
  2350 000011B4 BF[00800000]            	mov	edi, audio_buffer
  2351                                  	
  2352 000011B9 D1E8                    	shr	eax, 1
  2353 000011BB 7505                    	jnz	short lff24s_8
  2354 000011BD E97EF9FFFF              	jmp	lff24_eof
  2355                                  
  2356                                  lff24s_8:
  2357 000011C2 89C1                    	mov	ecx, eax  ; word count
  2358                                  lff24s_1:
  2359 000011C4 AC                      	lodsb
  2360 000011C5 A2[8E200000]            	mov	[previous_val_l], al
  2361 000011CA 2C80                    	sub	al, 80h
  2362 000011CC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2363 000011D0 66AB                    	stosw		; original sample (L)
  2364 000011D2 AC                      	lodsb
  2365 000011D3 A2[90200000]            	mov	[previous_val_r], al
  2366 000011D8 2C80                    	sub	al, 80h
  2367 000011DA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2368 000011DE 66AB                    	stosw		; original sample (R)
  2369                                  
  2370                                  	;xor	eax, eax
  2371 000011E0 66B88080                	mov	ax, 8080h
  2372 000011E4 49                      	dec	ecx
  2373 000011E5 7403                    	jz	short lff24s_2
  2374                                  		; convert 8 bit sample to 16 bit sample
  2375 000011E7 668B06                  	mov	ax, [esi]
  2376                                  lff24s_2:
  2377                                  	;;mov	[next_val_l], al
  2378                                  	;;mov	[next_val_r], ah
  2379                                  	;mov	bx, ax
  2380 000011EA 88E7                    	mov	bh, ah
  2381 000011EC 0205[8E200000]          	add	al, [previous_val_l]
  2382 000011F2 D0D8                    	rcr	al, 1
  2383                                  	;mov	dl, al
  2384 000011F4 2C80                    	sub	al, 80h
  2385 000011F6 66C1E008                	shl	ax, 8
  2386 000011FA 66AB                    	stosw		; this is interpolated sample (L)
  2387 000011FC 88F8                    	mov	al, bh	; [next_val_r]
  2388 000011FE 0205[90200000]          	add	al, [previous_val_r]
  2389 00001204 D0D8                    	rcr	al, 1
  2390                                  	;mov	dh, al
  2391 00001206 2C80                    	sub	al, 80h
  2392 00001208 66C1E008                	shl	ax, 8
  2393 0000120C 66AB                    	stosw		; this is interpolated sample (R)
  2394                                  		
  2395                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2396 0000120E 09C9                    	or	ecx, ecx
  2397 00001210 75B2                    	jnz	short lff24s_1
  2398 00001212 E911F9FFFF              	jmp	lff24_3
  2399                                  
  2400                                  load_24khz_mono_16_bit:
  2401                                  	; 15/11/2023
  2402 00001217 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2403                                  					; last of the file?
  2404 0000121E 7402                    	jz	short lff24m2_0		; no
  2405 00001220 F9                      	stc
  2406 00001221 C3                      	retn
  2407                                  
  2408                                  lff24m2_0:
  2409 00001222 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2410                                          ;mov	edx, [loadsize]
  2411                                  
  2412                                  	; esi = buffer address
  2413                                  	;; edx = buffer size
  2414                                  
  2415                                  	; load file into memory
  2416                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001227 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000122D 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000122F 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001235 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000123A CD40                <1>  int 40h
  2417 0000123C 7237                    	jc	short lff24m2_7 ; error !
  2418                                  
  2419 0000123E BF[00800000]            	mov	edi, audio_buffer
  2420                                  	
  2421 00001243 D1E8                    	shr	eax, 1
  2422 00001245 7505                    	jnz	short lff24m2_8
  2423 00001247 E9F4F8FFFF              	jmp	lff24_eof
  2424                                  
  2425                                  lff24m2_8:
  2426 0000124C 89C1                    	mov	ecx, eax  ; word count
  2427                                  lff24m2_1:
  2428 0000124E 66AD                    	lodsw
  2429 00001250 66AB                    	stosw		; original sample (left channel)
  2430 00001252 66AB                    	stosw		; original sample (right channel)
  2431 00001254 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2432                                  	;mov	[previous_val], ax
  2433                                  	;mov	ebx, eax	
  2434                                  	;xor	eax, eax
  2435 00001257 31DB                    	xor	ebx, ebx
  2436 00001259 49                      	dec	ecx
  2437 0000125A 7403                    	jz	short lff24m2_2
  2438                                  	;mov	ax, [esi]
  2439 0000125C 668B1E                  	mov	bx, [esi]
  2440                                  lff24m2_2:
  2441                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2442                                  	;mov	ebp, eax	; [next_val]
  2443                                  	;add	ax, [previous_val]
  2444                                  	; ax = [previous_val]
  2445                                  	; bx = [next_val]
  2446 0000125F 6601D8                  	add	ax, bx
  2447 00001262 66D1D8                  	rcr	ax, 1
  2448 00001265 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2449 00001268 66AB                    	stosw		; this is interpolated sample (L)
  2450 0000126A 66AB                    	stosw		; this is interpolated sample (R)
  2451                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2452 0000126C 09C9                    	or	ecx, ecx
  2453 0000126E 75DE                    	jnz	short lff24m2_1
  2454 00001270 E9B3F8FFFF              	jmp	lff24_3
  2455                                  
  2456                                  lff24m2_7:
  2457                                  lff24s2_7:
  2458 00001275 E9CFF8FFFF              	jmp	lff24_5  ; error
  2459                                  
  2460                                  load_24khz_stereo_16_bit:
  2461                                  	; 16/11/2023
  2462                                  	; 15/11/2023
  2463 0000127A F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2464                                  					; last of the file?
  2465 00001281 7402                    	jz	short lff24s2_0		; no
  2466 00001283 F9                      	stc
  2467 00001284 C3                      	retn
  2468                                  
  2469                                  lff24s2_0:
  2470 00001285 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2471                                          ;mov	edx, [loadsize]
  2472                                  
  2473                                  	; esi = buffer address
  2474                                  	;; edx = buffer size
  2475                                  
  2476                                  	; load file into memory
  2477                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000128A 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001290 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001292 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001298 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000129D CD40                <1>  int 40h
  2478 0000129F 72D4                    	jc	short lff24s2_7 ; error !
  2479                                  
  2480 000012A1 BF[00800000]            	mov	edi, audio_buffer
  2481                                  	
  2482 000012A6 C1E802                  	shr	eax, 2
  2483 000012A9 7505                    	jnz	short lff24s2_8
  2484 000012AB E990F8FFFF              	jmp	lff24_eof
  2485                                  
  2486                                  lff24s2_8:
  2487 000012B0 89C1                    	mov	ecx, eax  ; dword count
  2488                                  lff24s2_1:
  2489 000012B2 66AD                    	lodsw
  2490 000012B4 66AB                    	stosw		; original sample (L)
  2491 000012B6 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2492 000012B9 66A3[8E200000]          	mov	[previous_val_l], ax
  2493 000012BF 66AD                    	lodsw
  2494 000012C1 66AB                    	stosw		; original sample (R)
  2495 000012C3 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2496                                  	;mov	[previous_val_r], ax
  2497 000012C6 89C3                    	mov	ebx, eax
  2498 000012C8 31D2                    	xor	edx, edx
  2499 000012CA 31C0                    	xor	eax, eax
  2500                                  	; 16/11/2023
  2501 000012CC 49                      	dec	ecx
  2502 000012CD 7407                    	jz	short lff24s2_2
  2503 000012CF 668B06                  	mov	ax, [esi]
  2504 000012D2 668B5602                	mov	dx, [esi+2]
  2505                                  lff24s2_2:
  2506 000012D6 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2507                                  	;;mov	[next_val_l], ax
  2508                                  	;mov	ebp, eax
  2509 000012D9 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2510                                  	;mov	[next_val_r], dx
  2511 000012DC 660305[8E200000]        	add	ax, [previous_val_l]
  2512 000012E3 66D1D8                  	rcr	ax, 1
  2513 000012E6 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2514 000012E9 66AB                    	stosw		; this is interpolated sample (L)
  2515                                  	;mov	ax, [next_val_r]
  2516 000012EB 89D0                    	mov	eax, edx
  2517                                  	;add	ax, [previous_val_r]
  2518 000012ED 6601D8                  	add	ax, bx
  2519 000012F0 66D1D8                  	rcr	ax, 1
  2520 000012F3 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2521 000012F6 66AB                    	stosw		; this is interpolated sample (R)
  2522                                  	
  2523                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2524 000012F8 09C9                    	or	ecx, ecx
  2525 000012FA 75B6                    	jnz	short lff24s2_1
  2526 000012FC E927F8FFFF              	jmp	lff24_3
  2527                                  
  2528                                  ; .....................
  2529                                  
  2530                                  load_32khz_mono_8_bit:
  2531                                  	; 15/11/2023
  2532 00001301 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2533                                  					; last of the file?
  2534 00001308 7402                    	jz	short lff32m_0		; no
  2535 0000130A F9                      	stc
  2536 0000130B C3                      	retn
  2537                                  
  2538                                  lff32m_0:
  2539 0000130C BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2540                                          ;mov	edx, [loadsize]
  2541                                  
  2542                                  	; esi = buffer address
  2543                                  	;; edx = buffer size
  2544                                  
  2545                                  	; load file into memory
  2546                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001311 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001317 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001319 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000131F B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001324 CD40                <1>  int 40h
  2547 00001326 7247                    	jc	short lff32m_7 ; error !
  2548                                  
  2549 00001328 BF[00800000]            	mov	edi, audio_buffer
  2550                                  	
  2551 0000132D 21C0                    	and	eax, eax
  2552 0000132F 7505                    	jnz	short lff32m_8
  2553 00001331 E90AF8FFFF              	jmp	lff32_eof
  2554                                  
  2555                                  lff32m_8:
  2556 00001336 89C1                    	mov	ecx, eax	; byte count
  2557                                  lff32m_1:
  2558 00001338 AC                      	lodsb
  2559                                  	;mov	[previous_val], al
  2560 00001339 88C3                    	mov	bl, al
  2561 0000133B 2C80                    	sub	al, 80h
  2562 0000133D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2563 00001341 66AB                    	stosw		; original sample (left channel)
  2564 00001343 66AB                    	stosw		; original sample (right channel)
  2565                                  	;xor	eax, eax
  2566 00001345 B080                    	mov	al, 80h
  2567 00001347 49                      	dec	ecx
  2568 00001348 7402                    	jz	short lff32m_2
  2569 0000134A 8A06                    	mov	al, [esi]
  2570                                  lff32m_2:
  2571                                  	;;mov	[next_val], al
  2572                                  	;mov	bh, al
  2573                                  	;add	al, [previous_val]
  2574 0000134C 00D8                    	add	al, bl
  2575 0000134E D0D8                    	rcr	al, 1
  2576 00001350 2C80                    	sub	al, 80h
  2577 00001352 66C1E008                	shl	ax, 8
  2578 00001356 66AB                    	stosw		; this is interpolated sample (L)
  2579 00001358 66AB                    	stosw		; this is interpolated sample (R)
  2580                                  	
  2581                                  	; different than 8-16-24 kHZ !
  2582                                  	; 'original-interpolated-original' trio samples 
  2583 0000135A E30E                    	jecxz	lff32m_3
  2584                                  
  2585 0000135C AC                      	lodsb
  2586 0000135D 2C80                    	sub	al, 80h
  2587 0000135F 66C1E008                	shl	ax, 8
  2588 00001363 66AB                    	stosw		; original sample (left channel)
  2589 00001365 66AB                    	stosw		; original sample (right channel)
  2590                                  
  2591                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2592 00001367 49                      	dec	ecx
  2593 00001368 75CE                    	jnz	short lff32m_1
  2594                                  lff32m_3:
  2595 0000136A E9B9F7FFFF              	jmp	lff32_3
  2596                                  
  2597                                  lff32m_7:
  2598                                  lff32s_7:
  2599 0000136F E9D5F7FFFF              	jmp	lff32_5  ; error
  2600                                  
  2601                                  load_32khz_stereo_8_bit:
  2602                                  	; 15/11/2023
  2603 00001374 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2604                                  					; last of the file?
  2605 0000137B 7402                    	jz	short lff32s_0		; no
  2606 0000137D F9                      	stc
  2607 0000137E C3                      	retn
  2608                                  
  2609                                  lff32s_0:
  2610 0000137F BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2611                                          ;mov	edx, [loadsize]
  2612                                  
  2613                                  	; esi = buffer address
  2614                                  	;; edx = buffer size
  2615                                  
  2616                                  	; load file into memory
  2617                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001384 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000138A 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000138C 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001392 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001397 CD40                <1>  int 40h
  2618 00001399 72D4                    	jc	short lff32s_7 ; error !
  2619                                  
  2620 0000139B BF[00800000]            	mov	edi, audio_buffer
  2621                                  	
  2622 000013A0 D1E8                    	shr	eax, 1
  2623 000013A2 7505                    	jnz	short lff32s_8
  2624 000013A4 E997F7FFFF              	jmp	lff32_eof
  2625                                  
  2626                                  lff32s_8:
  2627 000013A9 89C1                    	mov	ecx, eax  ; word count
  2628                                  lff32s_1:
  2629 000013AB AC                      	lodsb
  2630 000013AC A2[8E200000]            	mov	[previous_val_l], al
  2631 000013B1 2C80                    	sub	al, 80h
  2632 000013B3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2633 000013B7 66AB                    	stosw		; original sample (L)
  2634 000013B9 AC                      	lodsb
  2635 000013BA A2[90200000]            	mov	[previous_val_r], al
  2636 000013BF 2C80                    	sub	al, 80h
  2637 000013C1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2638 000013C5 66AB                    	stosw		; original sample (R)
  2639                                  
  2640                                  	;xor	eax, eax
  2641 000013C7 66B88080                	mov	ax, 8080h
  2642 000013CB 49                      	dec	ecx
  2643 000013CC 7403                    	jz	short lff32s_2
  2644                                  		; convert 8 bit sample to 16 bit sample
  2645 000013CE 668B06                  	mov	ax, [esi]
  2646                                  lff32s_2:
  2647                                  	;;mov	[next_val_l], al
  2648                                  	;;mov	[next_val_r], ah
  2649                                  	;mov	bx, ax
  2650 000013D1 88E7                    	mov	bh, ah
  2651 000013D3 0205[8E200000]          	add	al, [previous_val_l]
  2652 000013D9 D0D8                    	rcr	al, 1
  2653                                  	;mov	dl, al
  2654 000013DB 2C80                    	sub	al, 80h
  2655 000013DD 66C1E008                	shl	ax, 8
  2656 000013E1 66AB                    	stosw		; this is interpolated sample (L)
  2657 000013E3 88F8                    	mov	al, bh	; [next_val_r]
  2658 000013E5 0205[90200000]          	add	al, [previous_val_r]
  2659 000013EB D0D8                    	rcr	al, 1
  2660                                  	;mov	dh, al
  2661 000013ED 2C80                    	sub	al, 80h
  2662 000013EF 66C1E008                	shl	ax, 8
  2663 000013F3 66AB                    	stosw		; this is interpolated sample (R)
  2664                                  
  2665                                  	; different than 8-16-24 kHZ !
  2666                                  	; 'original-interpolated-original' trio samples 
  2667 000013F5 E315                    	jecxz	lff32s_3
  2668                                  
  2669 000013F7 AC                      	lodsb
  2670 000013F8 2C80                    	sub	al, 80h
  2671 000013FA 66C1E008                	shl	ax, 8
  2672 000013FE 66AB                    	stosw		; original sample (left channel)
  2673                                  
  2674 00001400 AC                      	lodsb
  2675 00001401 2C80                    	sub	al, 80h
  2676 00001403 66C1E008                	shl	ax, 8
  2677 00001407 66AB                    	stosw		; original sample (right channel)
  2678                                  		
  2679                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2680 00001409 49                      	dec	ecx
  2681 0000140A 759F                    	jnz	short lff32s_1
  2682                                  lff32s_3:
  2683 0000140C E917F7FFFF              	jmp	lff32_3
  2684                                  
  2685                                  load_32khz_mono_16_bit:
  2686                                  	; 15/11/2023
  2687 00001411 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2688                                  					; last of the file?
  2689 00001418 7402                    	jz	short lff32m2_0		; no
  2690 0000141A F9                      	stc
  2691 0000141B C3                      	retn
  2692                                  
  2693                                  lff32m2_0:
  2694 0000141C BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2695                                          ;mov	edx, [loadsize]
  2696                                  
  2697                                  	; esi = buffer address
  2698                                  	;; edx = buffer size
  2699                                  
  2700                                  	; load file into memory
  2701                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001421 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001427 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001429 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000142F B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001434 CD40                <1>  int 40h
  2702 00001436 723E                    	jc	short lff32m2_7 ; error !
  2703                                  
  2704 00001438 BF[00800000]            	mov	edi, audio_buffer
  2705                                  	
  2706 0000143D D1E8                    	shr	eax, 1
  2707 0000143F 7505                    	jnz	short lff32m2_8
  2708 00001441 E9FAF6FFFF              	jmp	lff32_eof
  2709                                  
  2710                                  lff32m2_8:
  2711 00001446 89C1                    	mov	ecx, eax  ; word count
  2712                                  lff32m2_1:
  2713 00001448 66AD                    	lodsw
  2714 0000144A 66AB                    	stosw		; original sample (left channel)
  2715 0000144C 66AB                    	stosw		; original sample (right channel)
  2716 0000144E 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2717                                  	;mov	[previous_val], ax
  2718                                  	;mov	ebx, eax	
  2719                                  	;xor	eax, eax
  2720 00001451 31DB                    	xor	ebx, ebx
  2721 00001453 49                      	dec	ecx
  2722 00001454 7403                    	jz	short lff32m2_2
  2723                                  	;mov	ax, [esi]
  2724 00001456 668B1E                  	mov	bx, [esi]
  2725                                  lff32m2_2:
  2726                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2727                                  	;mov	ebp, eax	; [next_val]
  2728                                  	;add	ax, [previous_val]
  2729                                  	; ax = [previous_val]
  2730                                  	; bx = [next_val]
  2731 00001459 6601D8                  	add	ax, bx
  2732 0000145C 66D1D8                  	rcr	ax, 1
  2733 0000145F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2734 00001462 66AB                    	stosw		; this is interpolated sample (L)
  2735 00001464 66AB                    	stosw		; this is interpolated sample (R)
  2736                                  
  2737                                  	; different than 8-16-24 kHZ !
  2738                                  	; 'original-interpolated-original' trio samples 
  2739 00001466 E309                    	jecxz	lff32m2_3
  2740                                  
  2741 00001468 66AD                    	lodsw
  2742 0000146A 66AB                    	stosw		; original sample (left channel)
  2743 0000146C 66AB                    	stosw		; original sample (right channel)
  2744                                  
  2745                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2746 0000146E 49                      	dec	ecx
  2747 0000146F 75D7                    	jnz	short lff32m2_1
  2748                                  lff32m2_3:
  2749 00001471 E9B2F6FFFF              	jmp	lff32_3
  2750                                  
  2751                                  lff32m2_7:
  2752                                  lff32s2_7:
  2753 00001476 E9CEF6FFFF              	jmp	lff32_5  ; error
  2754                                  
  2755                                  load_32khz_stereo_16_bit:
  2756                                  	; 16/11/2023
  2757                                  	; 15/11/2023
  2758 0000147B F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2759                                  					; last of the file?
  2760 00001482 7402                    	jz	short lff32s2_0		; no
  2761 00001484 F9                      	stc
  2762 00001485 C3                      	retn
  2763                                  
  2764                                  lff32s2_0:
  2765 00001486 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2766                                          ;mov	edx, [loadsize]
  2767                                  
  2768                                  	; esi = buffer address
  2769                                  	;; edx = buffer size
  2770                                  
  2771                                  	; load file into memory
  2772                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000148B 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001491 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001493 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001499 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000149E CD40                <1>  int 40h
  2773 000014A0 72D4                    	jc	short lff32s2_7 ; error !
  2774                                  
  2775 000014A2 BF[00800000]            	mov	edi, audio_buffer
  2776                                  	
  2777 000014A7 C1E802                  	shr	eax, 2
  2778 000014AA 7505                    	jnz	short lff32s2_8
  2779 000014AC E98FF6FFFF              	jmp	lff32_eof
  2780                                  
  2781                                  lff32s2_8:
  2782 000014B1 89C1                    	mov	ecx, eax ; dword count
  2783                                  lff32s2_1:
  2784 000014B3 66AD                    	lodsw
  2785 000014B5 66AB                    	stosw		; original sample (L)
  2786 000014B7 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2787 000014BA 66A3[8E200000]          	mov	[previous_val_l], ax
  2788 000014C0 66AD                    	lodsw
  2789 000014C2 66AB                    	stosw		; original sample (R)
  2790 000014C4 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2791                                  	;mov	[previous_val_r], ax
  2792 000014C7 89C3                    	mov	ebx, eax
  2793 000014C9 31D2                    	xor	edx, edx
  2794 000014CB 31C0                    	xor	eax, eax
  2795                                  	; 16/11/2023
  2796 000014CD 49                      	dec	ecx
  2797 000014CE 7407                    	jz	short lff32s2_2
  2798 000014D0 668B06                  	mov	ax, [esi]
  2799 000014D3 668B5602                	mov	dx, [esi+2]
  2800                                  lff32s2_2:
  2801 000014D7 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2802                                  	;;mov	[next_val_l], ax
  2803                                  	;mov	ebp, eax
  2804 000014DA 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2805                                  	;mov	[next_val_r], dx
  2806 000014DD 660305[8E200000]        	add	ax, [previous_val_l]
  2807 000014E4 66D1D8                  	rcr	ax, 1
  2808 000014E7 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2809 000014EA 66AB                    	stosw		; this is interpolated sample (L)
  2810                                  	;mov	ax, [next_val_r]
  2811 000014EC 89D0                    	mov	eax, edx
  2812                                  	;add	ax, [previous_val_r]
  2813 000014EE 6601D8                  	add	ax, bx
  2814 000014F1 66D1D8                  	rcr	ax, 1
  2815 000014F4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2816 000014F7 66AB                    	stosw		; this is interpolated sample (R)
  2817                                  
  2818                                  	; different than 8-16-24 kHZ !
  2819                                  	; 'original-interpolated-original' trio samples 
  2820 000014F9 E30B                    	jecxz	lff32s2_3
  2821                                  
  2822 000014FB 66AD                    	lodsw
  2823 000014FD 66AB                    	stosw	; original sample (L)
  2824 000014FF 66AD                    	lodsw
  2825 00001501 66AB                    	stosw	; original sample (R)
  2826                                  	
  2827                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2828 00001503 49                      	dec	ecx
  2829 00001504 75AD                    	jnz	short lff32s2_1
  2830                                  lff32s2_3:
  2831 00001506 E91DF6FFFF              	jmp	lff32_3
  2832                                  
  2833                                  ; .....................
  2834                                  
  2835                                  load_22khz_mono_8_bit:
  2836                                  	; 16/11/2023
  2837 0000150B F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2838                                  					; last of the file?
  2839 00001512 7402                    	jz	short lff22m_0		; no
  2840 00001514 F9                      	stc
  2841 00001515 C3                      	retn
  2842                                  
  2843                                  lff22m_0:
  2844 00001516 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2845                                          ;mov	edx, [loadsize]
  2846                                  
  2847                                  	; esi = buffer address
  2848                                  	;; edx = buffer size
  2849                                  
  2850                                  	; load file into memory
  2851                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000151B 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001521 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001523 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001529 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000152E CD40                <1>  int 40h
  2852 00001530 725D                    	jc	short lff22m_7 ; error !
  2853                                  
  2854 00001532 BF[00800000]            	mov	edi, audio_buffer
  2855                                  	
  2856 00001537 21C0                    	and	eax, eax
  2857 00001539 7505                    	jnz	short lff22m_8
  2858 0000153B E900F6FFFF              	jmp	lff22_eof
  2859                                  
  2860                                  lff22m_8:
  2861 00001540 89C1                    	mov	ecx, eax	; byte count
  2862                                  lff22m_9:
  2863 00001542 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2864 00001547 C605[96200000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2865                                  lff22m_1:
  2866                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2867 0000154E AC                      	lodsb
  2868 0000154F B280                    	mov	dl, 80h
  2869 00001551 49                      	dec	ecx
  2870 00001552 7402                    	jz	short lff22m_2_1
  2871 00001554 8A16                    	mov	dl, [esi]
  2872                                  lff22m_2_1:	
  2873                                  	; al = [previous_val]
  2874                                  	; dl = [next_val]
  2875 00001556 E8EF050000              	call	interpolating_3_8bit_mono ; 1 of 17
  2876 0000155B E32D                    	jecxz	lff22m_3
  2877                                  lff22m_2_2:
  2878 0000155D AC                      	lodsb
  2879 0000155E B280                    	mov	dl, 80h
  2880 00001560 49                      	dec	ecx
  2881 00001561 7402                    	jz	short lff22m_2_3
  2882 00001563 8A16                    	mov	dl, [esi]
  2883                                  lff22m_2_3:
  2884 00001565 E864060000               	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2885 0000156A E31E                    	jecxz	lff22m_3
  2886 0000156C 4D                      	dec	ebp
  2887 0000156D 75EE                    	jnz	short lff22m_2_2
  2888                                  
  2889 0000156F A0[96200000]            	mov	al, [faz]
  2890 00001574 FEC8                    	dec	al
  2891 00001576 74CA                    	jz	short lff22m_9
  2892 00001578 FE0D[96200000]          	dec	byte [faz]
  2893 0000157E BD04000000              	mov	ebp, 4
  2894 00001583 FEC8                    	dec	al
  2895 00001585 75C7                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2896 00001587 45                      	inc	ebp ; 5
  2897 00001588 EBC4                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2898                                  
  2899                                  lff22m_3:
  2900                                  lff22s_3:
  2901 0000158A E999F5FFFF              	jmp	lff22_3	; padfill
  2902                                  		; (put zeros in the remain words of the buffer)
  2903                                  lff22m_7:
  2904                                  lff22s_7:
  2905 0000158F E9B5F5FFFF              	jmp	lff22_5  ; error
  2906                                  
  2907                                  load_22khz_stereo_8_bit:
  2908                                  	; 16/11/2023
  2909 00001594 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2910                                  					; last of the file?
  2911 0000159B 7402                    	jz	short lff22s_0		; no
  2912 0000159D F9                      	stc
  2913 0000159E C3                      	retn
  2914                                  
  2915                                  lff22s_0:
  2916 0000159F BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2917                                          ;mov	edx, [loadsize]
  2918                                  
  2919                                  	; esi = buffer address
  2920                                  	;; edx = buffer size
  2921                                  
  2922                                  	; load file into memory
  2923                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000015A4 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000015AA 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000015AC 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000015B2 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000015B7 CD40                <1>  int 40h
  2924 000015B9 72D4                    	jc	short lff22s_7 ; error !
  2925                                  
  2926 000015BB BF[00800000]            	mov	edi, audio_buffer
  2927                                  	
  2928 000015C0 D1E8                    	shr	eax, 1
  2929 000015C2 7505                    	jnz	short lff22s_8
  2930 000015C4 E977F5FFFF              	jmp	lff22_eof
  2931                                  
  2932                                  lff22s_8:
  2933 000015C9 89C1                    	mov	ecx, eax	; word count
  2934                                  lff22s_9:
  2935 000015CB BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2936 000015D0 C605[96200000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2937                                  lff22s_1:
  2938                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2939 000015D7 66AD                    	lodsw
  2940 000015D9 66BA8080                	mov	dx, 8080h
  2941 000015DD 49                      	dec	ecx
  2942 000015DE 7403                    	jz	short lff22s_2_1 
  2943 000015E0 668B16                  	mov	dx, [esi]
  2944                                  lff22s_2_1:	
  2945                                  	; al = [previous_val_l]
  2946                                  	; ah = [previous_val_r]
  2947                                  	; dl = [next_val_l]
  2948                                  	; dh = [next_val_r]	
  2949 000015E3 E893050000              	call	interpolating_3_8bit_stereo ; 1 of 17 
  2950 000015E8 E3A0                    	jecxz	lff22s_3
  2951                                  lff22s_2_2:
  2952 000015EA 66AD                    	lodsw
  2953 000015EC 66BA8080                	mov	dx, 8080h
  2954 000015F0 49                      	dec	ecx
  2955 000015F1 7403                    	jz	short lff22s_2_3
  2956 000015F3 668B16                  	mov	dx, [esi]
  2957                                  lff22s_2_3:
  2958 000015F6 E8F0050000               	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2959 000015FB E38D                    	jecxz	lff22s_3
  2960 000015FD 4D                      	dec	ebp
  2961 000015FE 75EA                    	jnz	short lff22s_2_2
  2962                                  
  2963 00001600 A0[96200000]            	mov	al, [faz]
  2964 00001605 FEC8                    	dec	al
  2965 00001607 74C2                    	jz	short lff22s_9
  2966 00001609 FE0D[96200000]          	dec	byte [faz]
  2967 0000160F BD04000000              	mov	ebp, 4
  2968 00001614 FEC8                    	dec	al
  2969 00001616 75BF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2970 00001618 45                      	inc	ebp ; 5
  2971 00001619 EBBC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2972                                  
  2973                                  load_22khz_mono_16_bit:
  2974                                  	; 16/11/2023
  2975 0000161B F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2976                                  					; last of the file?
  2977 00001622 7402                    	jz	short lff22m2_0		; no
  2978 00001624 F9                      	stc
  2979 00001625 C3                      	retn
  2980                                  
  2981                                  lff22m2_0:
  2982 00001626 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2983                                          ;mov	edx, [loadsize]
  2984                                  
  2985                                  	; esi = buffer address
  2986                                  	;; edx = buffer size
  2987                                  
  2988                                  	; load file into memory
  2989                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000162B 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001631 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001633 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001639 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000163E CD40                <1>  int 40h
  2990 00001640 7261                    	jc	short lff22m2_7 ; error !
  2991                                  
  2992 00001642 BF[00800000]            	mov	edi, audio_buffer
  2993                                  	
  2994 00001647 D1E8                    	shr	eax, 1
  2995 00001649 7505                    	jnz	short lff22m2_8
  2996 0000164B E9F0F4FFFF              	jmp	lff22_eof
  2997                                  
  2998                                  lff22m2_8:
  2999 00001650 89C1                    	mov	ecx, eax	; word count
  3000                                  lff22m2_9:
  3001 00001652 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  3002 00001657 C605[96200000]03        	mov	byte [faz], 3  ; 3 steps/phases
  3003                                  lff22m2_1:
  3004                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  3005 0000165E 66AD                    	lodsw
  3006 00001660 31D2                    	xor	edx, edx
  3007 00001662 49                      	dec	ecx
  3008 00001663 7403                    	jz	short lff22m2_2_1
  3009 00001665 668B16                  	mov	dx, [esi]
  3010                                  lff22m2_2_1:	
  3011                                  	; ax = [previous_val]
  3012                                  	; dx = [next_val]
  3013 00001668 E8AF050000              	call	interpolating_3_16bit_mono ; 1 of 17
  3014 0000166D E32F                    	jecxz	lff22m2_3
  3015                                  lff22m2_2_2:
  3016 0000166F 66AD                    	lodsw
  3017 00001671 31D2                    	xor	edx, edx
  3018 00001673 49                      	dec	ecx
  3019 00001674 7403                    	jz	short lff22m2_2_3
  3020 00001676 668B16                  	mov	dx, [esi]
  3021                                  lff22m2_2_3:
  3022 00001679 E831060000               	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  3023 0000167E E31E                    	jecxz	lff22m2_3
  3024 00001680 4D                      	dec	ebp
  3025 00001681 75EC                    	jnz	short lff22m2_2_2
  3026                                  
  3027 00001683 A0[96200000]            	mov	al, [faz]
  3028 00001688 FEC8                    	dec	al
  3029 0000168A 74C6                    	jz	short lff22m2_9
  3030 0000168C FE0D[96200000]          	dec	byte [faz]
  3031 00001692 BD04000000              	mov	ebp, 4
  3032 00001697 FEC8                    	dec	al
  3033 00001699 75C3                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  3034 0000169B 45                      	inc	ebp ; 5
  3035 0000169C EBC0                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  3036                                  
  3037                                  lff22m2_3:
  3038                                  lff22s2_3:
  3039 0000169E E985F4FFFF              	jmp	lff22_3	; padfill
  3040                                  		; (put zeros in the remain words of the buffer)
  3041                                  lff22m2_7:
  3042                                  lff22s2_7:
  3043 000016A3 E9A1F4FFFF              	jmp	lff22_5  ; error
  3044                                  
  3045                                  load_22khz_stereo_16_bit:
  3046                                  	; 16/11/2023
  3047 000016A8 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3048                                  					; last of the file?
  3049 000016AF 7402                    	jz	short lff22s2_0		; no
  3050 000016B1 F9                      	stc
  3051 000016B2 C3                      	retn
  3052                                  
  3053                                  lff22s2_0:
  3054 000016B3 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3055                                          ;mov	edx, [loadsize]
  3056                                  
  3057                                  	; esi = buffer address
  3058                                  	;; edx = buffer size
  3059                                  
  3060                                  	; load file into memory
  3061                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000016B8 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000016BE 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000016C0 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000016C6 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000016CB CD40                <1>  int 40h
  3062 000016CD 72D4                    	jc	short lff22s2_7 ; error !
  3063                                  
  3064 000016CF BF[00800000]            	mov	edi, audio_buffer
  3065                                  	
  3066 000016D4 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3067 000016D7 7505                    	jnz	short lff22s2_8
  3068 000016D9 E962F4FFFF              	jmp	lff22_eof
  3069                                  
  3070                                  lff22s2_8:
  3071 000016DE 89C1                    	mov	ecx, eax	; dword count
  3072                                  lff22s2_9:
  3073 000016E0 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  3074 000016E5 C605[96200000]03        	mov	byte [faz], 3  ; 3 steps/phase
  3075                                  lff22s2_1:
  3076                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  3077 000016EC 66AD                    	lodsw
  3078 000016EE 89C3                    	mov	ebx, eax
  3079 000016F0 66AD                    	lodsw
  3080 000016F2 8B16                    	mov	edx, [esi]
  3081 000016F4 668915[92200000]        	mov	[next_val_l], dx
  3082                                  	; 26/11/2023
  3083 000016FB C1EA10                  	shr	edx, 16
  3084 000016FE 49                      	dec	ecx
  3085 000016FF 7509                    	jnz	short lff22s2_2_1
  3086 00001701 31D2                    	xor	edx, edx ; 0
  3087 00001703 668915[92200000]        	mov	[next_val_l], dx
  3088                                  lff22s2_2_1:
  3089                                  	; bx = [previous_val_l]
  3090                                  	; ax = [previous_val_r]
  3091                                  	; [next_val_l]
  3092                                  	; dx = [next_val_r]
  3093 0000170A E83D050000              	call	interpolating_3_16bit_stereo ; 1 of 17 
  3094 0000170F E38D                    	jecxz	lff22s2_3
  3095                                  lff22s2_2_2:
  3096 00001711 66AD                    	lodsw
  3097 00001713 89C3                    	mov	ebx, eax
  3098 00001715 66AD                    	lodsw
  3099 00001717 8B16                    	mov	edx, [esi]
  3100 00001719 668915[92200000]        	mov	[next_val_l], dx
  3101                                  	; 26/11/2023
  3102 00001720 C1EA10                  	shr	edx, 16
  3103 00001723 49                      	dec	ecx
  3104 00001724 7509                    	jnz	short lff22s2_2_3
  3105 00001726 31D2                    	xor	edx, edx ; 0
  3106 00001728 668915[92200000]        	mov	[next_val_l], dx
  3107                                  lff22s2_2_3:
  3108 0000172F E893050000               	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  3109 00001734 E31E                    	jecxz	lff22s2_2_4
  3110                                  
  3111 00001736 4D                      	dec	ebp
  3112 00001737 75D8                    	jnz	short lff22s2_2_2
  3113                                  
  3114 00001739 A0[96200000]            	mov	al, [faz]
  3115 0000173E FEC8                    	dec	al
  3116 00001740 749E                    	jz	short lff22s2_9
  3117 00001742 FE0D[96200000]          	dec	byte [faz]
  3118 00001748 BD04000000              	mov	ebp, 4
  3119 0000174D FEC8                    	dec	al
  3120 0000174F 759B                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  3121 00001751 45                      	inc	ebp ; 5
  3122 00001752 EB98                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  3123                                  
  3124                                  lff22s2_2_4:
  3125                                  	; 26/11/2023
  3126 00001754 E9CFF3FFFF              	jmp	lff22_3	; padfill
  3127                                  
  3128                                  ; .....................
  3129                                  
  3130                                  load_11khz_mono_8_bit:
  3131                                  	; 18/11/2023
  3132 00001759 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3133                                  					; last of the file?
  3134 00001760 7402                    	jz	short lff11m_0		; no
  3135 00001762 F9                      	stc
  3136 00001763 C3                      	retn
  3137                                  
  3138                                  lff11m_0:
  3139 00001764 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3140                                          ;mov	edx, [loadsize]
  3141                                  
  3142                                  	; esi = buffer address
  3143                                  	;; edx = buffer size
  3144                                  
  3145                                  	; load file into memory
  3146                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001769 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000176F 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001771 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001777 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000177C CD40                <1>  int 40h
  3147 0000177E 7247                    	jc	short lff11m_7 ; error !
  3148                                  
  3149 00001780 BF[00800000]            	mov	edi, audio_buffer
  3150                                  	
  3151 00001785 21C0                    	and	eax, eax
  3152 00001787 7505                    	jnz	short lff11m_8
  3153 00001789 E9B2F3FFFF              	jmp	lff11_eof
  3154                                  
  3155                                  lff11m_8:
  3156 0000178E 89C1                    	mov	ecx, eax		; byte count
  3157                                  lff11m_9:
  3158 00001790 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3159                                  lff11m_1:
  3160                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3161 00001795 AC                      	lodsb
  3162 00001796 B280                    	mov	dl, 80h
  3163 00001798 49                      	dec	ecx
  3164 00001799 7402                    	jz	short lff11m_2_1
  3165 0000179B 8A16                    	mov	dl, [esi]
  3166                                  lff11m_2_1:	
  3167                                  	; al = [previous_val]
  3168                                  	; dl = [next_val]
  3169 0000179D E854050000              	call	interpolating_5_8bit_mono
  3170 000017A2 E328                    	jecxz	lff11m_3
  3171                                  lff11m_2_2:
  3172 000017A4 AC                      	lodsb
  3173 000017A5 B280                    	mov	dl, 80h
  3174 000017A7 49                      	dec	ecx
  3175 000017A8 7402                    	jz	short lff11m_2_3
  3176 000017AA 8A16                    	mov	dl, [esi]
  3177                                  lff11m_2_3:
  3178 000017AC E851060000               	call	interpolating_4_8bit_mono
  3179 000017B1 E319                    	jecxz	lff11m_3
  3180                                  
  3181 000017B3 4D                      	dec	ebp
  3182 000017B4 74DA                    	jz	short lff11m_9
  3183                                  
  3184 000017B6 AC                      	lodsb
  3185 000017B7 B280                    	mov	dl, 80h
  3186 000017B9 49                      	dec	ecx
  3187 000017BA 7402                    	jz	short lff11m_2_4
  3188 000017BC 8A16                    	mov	dl, [esi]
  3189                                  lff11m_2_4:
  3190 000017BE E83F060000              	call	interpolating_4_8bit_mono
  3191 000017C3 E307                    	jecxz	lff11m_3
  3192 000017C5 EBCE                    	jmp	short lff11m_1
  3193                                  
  3194                                  lff11m_7:
  3195                                  lff11s_7:
  3196 000017C7 E97DF3FFFF              	jmp	lff11_5  ; error
  3197                                  
  3198                                  lff11m_3:
  3199                                  lff11s_3:
  3200 000017CC E957F3FFFF              	jmp	lff11_3	; padfill
  3201                                  		; (put zeros in the remain words of the buffer)
  3202                                  
  3203                                  load_11khz_stereo_8_bit:
  3204                                  	; 18/11/2023
  3205 000017D1 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3206                                  					; last of the file?
  3207 000017D8 7402                    	jz	short lff11s_0		; no
  3208 000017DA F9                      	stc
  3209 000017DB C3                      	retn
  3210                                  
  3211                                  lff11s_0:
  3212 000017DC BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3213                                          ;mov	edx, [loadsize]
  3214                                  
  3215                                  	; esi = buffer address
  3216                                  	;; edx = buffer size
  3217                                  
  3218                                  	; load file into memory
  3219                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000017E1 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000017E7 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000017E9 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000017EF B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000017F4 CD40                <1>  int 40h
  3220 000017F6 72CF                    	jc	short lff11s_7 ; error !
  3221                                  
  3222 000017F8 BF[00800000]            	mov	edi, audio_buffer
  3223                                  	
  3224 000017FD D1E8                    	shr	eax, 1
  3225 000017FF 7505                    	jnz	short lff11s_8
  3226 00001801 E93AF3FFFF              	jmp	lff11_eof
  3227                                  
  3228                                  lff11s_8:
  3229 00001806 89C1                    	mov	ecx, eax	; word count
  3230                                  lff11s_9:
  3231 00001808 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3232                                  lff11s_1:
  3233                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3234 0000180D 66AD                    	lodsw
  3235 0000180F 66BA8080                	mov	dx, 8080h
  3236 00001813 49                      	dec	ecx
  3237 00001814 7403                    	jz	short lff11s_2_1 
  3238 00001816 668B16                  	mov	dx, [esi]
  3239                                  lff11s_2_1:	
  3240                                  	; al = [previous_val_l]
  3241                                  	; ah = [previous_val_r]
  3242                                  	; dl = [next_val_l]
  3243                                  	; dh = [next_val_r]	
  3244 00001819 E837050000              	call	interpolating_5_8bit_stereo
  3245 0000181E E3AC                    	jecxz	lff11s_3
  3246                                  lff11s_2_2:
  3247 00001820 66AD                    	lodsw
  3248 00001822 66BA8080                	mov	dx, 8080h
  3249 00001826 49                      	dec	ecx
  3250 00001827 7403                    	jz	short lff11s_2_3
  3251 00001829 668B16                  	mov	dx, [esi]
  3252                                  lff11s_2_3:
  3253 0000182C E810060000               	call	interpolating_4_8bit_stereo
  3254 00001831 E399                    	jecxz	lff11s_3
  3255                                  	
  3256 00001833 4D                      	dec	ebp
  3257 00001834 74D2                    	jz	short lff11s_9
  3258                                  
  3259 00001836 66AD                    	lodsw
  3260 00001838 66BA8080                	mov	dx, 8080h
  3261 0000183C 49                      	dec	ecx
  3262 0000183D 7403                    	jz	short lff11s_2_4
  3263 0000183F 668B16                  	mov	dx, [esi]
  3264                                  lff11s_2_4:
  3265 00001842 E8FA050000              	call	interpolating_4_8bit_stereo
  3266 00001847 E383                    	jecxz	lff11s_3
  3267 00001849 EBC2                    	jmp	short lff11s_1
  3268                                  
  3269                                  load_11khz_mono_16_bit:
  3270                                  	; 18/11/2023
  3271 0000184B F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3272                                  					; last of the file?
  3273 00001852 7402                    	jz	short lff11m2_0		; no
  3274 00001854 F9                      	stc
  3275 00001855 C3                      	retn
  3276                                  
  3277                                  lff11m2_0:
  3278 00001856 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3279                                          ;mov	edx, [loadsize]
  3280                                  
  3281                                  	; esi = buffer address
  3282                                  	;; edx = buffer size
  3283                                  
  3284                                  	; load file into memory
  3285                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000185B 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001861 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001863 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001869 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000186E CD40                <1>  int 40h
  3286 00001870 724D                    	jc	short lff11m2_7 ; error !
  3287                                  
  3288 00001872 BF[00800000]            	mov	edi, audio_buffer
  3289                                  	
  3290 00001877 D1E8                    	shr	eax, 1
  3291 00001879 7505                    	jnz	short lff11m2_8
  3292 0000187B E9C0F2FFFF              	jmp	lff11_eof
  3293                                  
  3294                                  lff11m2_8:
  3295 00001880 89C1                    	mov	ecx, eax	; word count
  3296                                  lff11m2_9:
  3297 00001882 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3298                                  lff11m2_1:
  3299                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3300 00001887 66AD                    	lodsw
  3301 00001889 31D2                    	xor	edx, edx
  3302 0000188B 49                      	dec	ecx
  3303 0000188C 7403                    	jz	short lff11m2_2_1
  3304 0000188E 668B16                  	mov	dx, [esi]
  3305                                  lff11m2_2_1:	
  3306                                  	; ax = [previous_val]
  3307                                  	; dx = [next_val]
  3308 00001891 E818060000              	call	interpolating_5_16bit_mono
  3309 00001896 E362                    	jecxz	lff11m2_3
  3310                                  lff11m2_2_2:
  3311 00001898 66AD                    	lodsw
  3312 0000189A 31D2                    	xor	edx, edx
  3313 0000189C 49                      	dec	ecx
  3314 0000189D 7403                    	jz	short lff11m2_2_3
  3315 0000189F 668B16                  	mov	dx, [esi]
  3316                                  lff11m2_2_3:
  3317 000018A2 E831070000               	call	interpolating_4_16bit_mono
  3318 000018A7 E351                    	jecxz	lff11m2_3
  3319                                  
  3320 000018A9 4D                      	dec	ebp
  3321 000018AA 74D6                    	jz	short lff11m2_9
  3322                                  
  3323 000018AC 66AD                    	lodsw
  3324 000018AE 31D2                    	xor	edx, edx
  3325 000018B0 49                      	dec	ecx
  3326 000018B1 7403                    	jz	short lff11m2_2_4
  3327 000018B3 668B16                  	mov	dx, [esi]
  3328                                  lff11m2_2_4:
  3329 000018B6 E81D070000               	call	interpolating_4_16bit_mono
  3330 000018BB E33D                    	jecxz	lff11m2_3
  3331 000018BD EBC8                    	jmp	short lff11m2_1
  3332                                  
  3333                                  lff11m2_7:
  3334                                  lff11s2_7:
  3335 000018BF E985F2FFFF              	jmp	lff11_5  ; error
  3336                                  
  3337                                  load_11khz_stereo_16_bit:
  3338                                  	; 18/01/2025
  3339                                  	; 18/11/2023
  3340 000018C4 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3341                                  					; last of the file?
  3342 000018CB 7402                    	jz	short lff11s2_0		; no
  3343 000018CD F9                      	stc
  3344 000018CE C3                      	retn
  3345                                  
  3346                                  lff11s2_0:
  3347 000018CF BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3348                                          ;mov	edx, [loadsize]
  3349                                  
  3350                                  	; esi = buffer address
  3351                                  	;; edx = buffer size
  3352                                  
  3353                                  	; load file into memory
  3354                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000018D4 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000018DA 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000018DC 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000018E2 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000018E7 CD40                <1>  int 40h
  3355 000018E9 72D4                    	jc	short lff11s2_7 ; error !
  3356                                  
  3357 000018EB BF[00800000]            	mov	edi, audio_buffer
  3358                                  	
  3359 000018F0 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3360 000018F3 750A                    	jnz	short lff11s2_8
  3361 000018F5 E946F2FFFF              	jmp	lff11_eof
  3362                                  
  3363                                  lff11m2_3:
  3364                                  lff11s2_3:
  3365 000018FA E929F2FFFF              	jmp	lff11_3	; padfill
  3366                                  		; (put zeros in the remain words of the buffer)
  3367                                  
  3368                                  lff11s2_8:
  3369 000018FF 89C1                    	mov	ecx, eax	; dword count
  3370                                  lff11s2_9:
  3371 00001901 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3372                                  lff11s2_1:
  3373                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3374 00001906 66AD                    	lodsw
  3375 00001908 89C3                    	mov	ebx, eax
  3376 0000190A 66AD                    	lodsw
  3377 0000190C 8B16                    	mov	edx, [esi]
  3378                                  	; 18/01/2025
  3379                                  	;mov	[next_val_l], edx
  3380                                  	; 26/11/2023
  3381                                  	;shr	edx, 16
  3382                                  	;mov	[next_val_r], dx
  3383 0000190E 49                      	dec	ecx
  3384 0000190F 7502                    	jnz	short lff11s2_2_1
  3385 00001911 31D2                    	xor	edx, edx ; 0
  3386                                  	;mov	[next_val_l], dx
  3387                                  	;mov	[next_val_r], dx
  3388                                  lff11s2_2_1:
  3389                                  	; bx = [previous_val_l]
  3390                                  	; ax = [previous_val_r]
  3391                                  	; [next_val_l]
  3392                                  	; dx = [next_val_r]
  3393                                  	;;;
  3394                                  	; 18/01/2025 (BugFix)
  3395 00001913 8915[92200000]          	mov	[next_val_l], edx
  3396                                  	;;;
  3397 00001919 E8EB050000              	call	interpolating_5_16bit_stereo
  3398 0000191E E3DA                    	jecxz	lff11s2_3
  3399                                  lff11s2_2_2:
  3400 00001920 66AD                    	lodsw
  3401 00001922 89C3                    	mov	ebx, eax
  3402 00001924 66AD                    	lodsw
  3403 00001926 8B16                    	mov	edx, [esi]
  3404                                  	; 18/01/2025
  3405                                  	;mov	[next_val_l], dx
  3406                                  	; 26/11/2023
  3407                                  	;shr	edx, 16
  3408                                  	;mov	[next_val_r], dx
  3409 00001928 49                      	dec	ecx
  3410 00001929 7502                    	jnz	short lff11s2_2_3
  3411 0000192B 31D2                    	xor	edx, edx ; 0
  3412                                  	;mov	[next_val_l], dx
  3413                                  	;mov	[next_val_r], dx
  3414                                  lff11s2_2_3:
  3415                                  	;;;
  3416                                  	; 18/01/2025 (BugFix)
  3417 0000192D 8915[92200000]          	mov	[next_val_l], edx
  3418                                  	;;;
  3419 00001933 E8D9060000              	call	interpolating_4_16bit_stereo
  3420 00001938 E3C0                    	jecxz	lff11s2_3
  3421                                  	
  3422 0000193A 4D                      	dec	ebp
  3423 0000193B 74C4                    	jz	short lff11s2_9
  3424                                  
  3425 0000193D 66AD                    	lodsw
  3426 0000193F 89C3                    	mov	ebx, eax
  3427 00001941 66AD                    	lodsw
  3428 00001943 8B16                    	mov	edx, [esi]
  3429                                  	; 18/01/2025
  3430                                  	;mov	[next_val_l], dx
  3431                                  	; 26/11/2023
  3432                                  	;shr	edx, 16
  3433                                  	;mov	[next_val_r], dx
  3434 00001945 49                      	dec	ecx
  3435 00001946 7502                    	jnz	short lff11s2_2_4
  3436 00001948 31D2                    	xor	edx, edx ; 0
  3437                                  	;mov	[next_val_l], dx
  3438                                  	;mov	[next_val_r], dx
  3439                                  lff11s2_2_4:
  3440                                  	;;;
  3441                                  	; 18/01/2025 (BugFix)
  3442 0000194A 8915[92200000]          	mov	[next_val_l], edx
  3443                                  	;;;
  3444 00001950 E8BC060000               	call	interpolating_4_16bit_stereo
  3445 00001955 E3A3                    	jecxz	lff11s2_3
  3446 00001957 EBAD                    	jmp	short lff11s2_1
  3447                                  
  3448                                  ; .....................
  3449                                  
  3450                                  load_44khz_mono_8_bit:
  3451                                  	; 18/11/2023
  3452 00001959 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3453                                  					; last of the file?
  3454 00001960 7402                    	jz	short lff44m_0		; no
  3455 00001962 F9                      	stc
  3456 00001963 C3                      	retn
  3457                                  
  3458                                  lff44m_0:
  3459 00001964 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3460                                          ;mov	edx, [loadsize]
  3461                                  
  3462                                  	; esi = buffer address
  3463                                  	;; edx = buffer size
  3464                                  
  3465                                  	; load file into memory
  3466                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001969 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000196F 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001971 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001977 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000197C CD40                <1>  int 40h
  3467 0000197E 7250                    	jc	short lff44m_7 ; error !
  3468                                  
  3469 00001980 BF[00800000]            	mov	edi, audio_buffer
  3470                                  	
  3471 00001985 21C0                    	and	eax, eax
  3472 00001987 7505                    	jnz	short lff44m_8
  3473 00001989 E9B2F1FFFF              	jmp	lff44_eof
  3474                                  
  3475                                  lff44m_8:
  3476 0000198E 89C1                    	mov	ecx, eax	; byte count
  3477                                  lff44m_9:
  3478 00001990 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3479 00001995 C605[96200000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3480                                  lff44m_1:
  3481                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3482                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3483 0000199C AC                      	lodsb
  3484 0000199D B280                    	mov	dl, 80h
  3485 0000199F 49                      	dec	ecx
  3486 000019A0 7402                    	jz	short lff44m_2_1
  3487 000019A2 8A16                    	mov	dl, [esi]
  3488                                  lff44m_2_1:	
  3489                                  	; al = [previous_val]
  3490                                  	; dl = [next_val]
  3491 000019A4 E825020000              	call	interpolating_2_8bit_mono
  3492 000019A9 E320                    	jecxz	lff44m_3
  3493                                  lff44m_2_2:
  3494 000019AB AC                      	lodsb
  3495 000019AC 2C80                    	sub	al, 80h
  3496 000019AE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3497 000019B2 66AB                    	stosw		; (L)
  3498 000019B4 66AB                    	stosw		; (R)	
  3499                                  
  3500 000019B6 49                      	dec	ecx
  3501 000019B7 7412                    	jz	short lff44m_3	
  3502 000019B9 4D                      	dec	ebp
  3503 000019BA 75EF                    	jnz	short lff44m_2_2
  3504                                  	
  3505 000019BC FE0D[96200000]          	dec	byte [faz]
  3506 000019C2 74CC                    	jz	short lff44m_9 
  3507 000019C4 BD0B000000              	mov	ebp, 11
  3508 000019C9 EBD1                    	jmp	short lff44m_1
  3509                                  
  3510                                  lff44m_3:
  3511                                  lff44s_3:
  3512 000019CB E958F1FFFF              	jmp	lff44_3	; padfill
  3513                                  		; (put zeros in the remain words of the buffer)
  3514                                  lff44m_7:
  3515                                  lff44s_7:
  3516 000019D0 E974F1FFFF              	jmp	lff44_5  ; error
  3517                                  
  3518                                  load_44khz_stereo_8_bit:
  3519                                  	; 16/11/2023
  3520 000019D5 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3521                                  					; last of the file?
  3522 000019DC 7402                    	jz	short lff44s_0		; no
  3523 000019DE F9                      	stc
  3524 000019DF C3                      	retn
  3525                                  
  3526                                  lff44s_0:
  3527 000019E0 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3528                                          ;mov	edx, [loadsize]
  3529                                  
  3530                                  	; esi = buffer address
  3531                                  	;; edx = buffer size
  3532                                  
  3533                                  	; load file into memory
  3534                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000019E5 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000019EB 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000019ED 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000019F3 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000019F8 CD40                <1>  int 40h
  3535 000019FA 72D4                    	jc	short lff44s_7 ; error !
  3536                                  
  3537 000019FC BF[00800000]            	mov	edi, audio_buffer
  3538                                  	
  3539 00001A01 D1E8                    	shr	eax, 1
  3540 00001A03 7505                    	jnz	short lff44s_8
  3541 00001A05 E936F1FFFF              	jmp	lff44_eof
  3542                                  
  3543                                  lff44s_8:
  3544 00001A0A 89C1                    	mov	ecx, eax	; word count
  3545                                  lff44s_9:
  3546 00001A0C BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3547 00001A11 C605[96200000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3548                                  lff44s_1:
  3549                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3550                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3551 00001A18 66AD                    	lodsw
  3552 00001A1A 66BA8080                	mov	dx, 8080h
  3553 00001A1E 49                      	dec	ecx
  3554 00001A1F 7403                    	jz	short lff44s_2_1 
  3555 00001A21 668B16                  	mov	dx, [esi]
  3556                                  lff44s_2_1:	
  3557                                  	; al = [previous_val_l]
  3558                                  	; ah = [previous_val_r]
  3559                                  	; dl = [next_val_l]
  3560                                  	; dh = [next_val_r]	
  3561 00001A24 E8C2010000              	call	interpolating_2_8bit_stereo
  3562 00001A29 E3A0                    	jecxz	lff44s_3
  3563                                  lff44s_2_2:
  3564 00001A2B AC                      	lodsb
  3565 00001A2C 2C80                    	sub	al, 80h
  3566 00001A2E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3567 00001A32 66AB                    	stosw		; (L)
  3568 00001A34 AC                      	lodsb
  3569 00001A35 2C80                    	sub	al, 80h
  3570 00001A37 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3571 00001A3B 66AB                    	stosw		; (R)
  3572                                  
  3573 00001A3D 49                      	dec	ecx
  3574 00001A3E 748B                    	jz	short lff44s_3	
  3575 00001A40 4D                      	dec	ebp
  3576 00001A41 75E8                    	jnz	short lff44s_2_2
  3577                                  	
  3578 00001A43 FE0D[96200000]          	dec	byte [faz]
  3579 00001A49 74C1                    	jz	short lff44s_9 
  3580 00001A4B BD0B000000              	mov	ebp, 11
  3581 00001A50 EBC6                    	jmp	short lff44s_1
  3582                                  
  3583                                  load_44khz_mono_16_bit:
  3584                                  	; 18/11/2023
  3585 00001A52 F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3586                                  					; last of the file?
  3587 00001A59 7402                    	jz	short lff44m2_0		; no
  3588 00001A5B F9                      	stc
  3589 00001A5C C3                      	retn
  3590                                  
  3591                                  lff44m2_0:
  3592 00001A5D BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3593                                          ;mov	edx, [loadsize]
  3594                                  
  3595                                  	; esi = buffer address
  3596                                  	;; edx = buffer size
  3597                                  
  3598                                  	; load file into memory
  3599                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001A62 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001A68 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001A6A 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001A70 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001A75 CD40                <1>  int 40h
  3600 00001A77 724D                    	jc	short lff44m2_7 ; error !
  3601                                  
  3602 00001A79 BF[00800000]            	mov	edi, audio_buffer
  3603                                  	
  3604 00001A7E D1E8                    	shr	eax, 1
  3605 00001A80 7505                    	jnz	short lff44m2_8
  3606 00001A82 E9B9F0FFFF              	jmp	lff44_eof
  3607                                  
  3608                                  lff44m2_8:
  3609 00001A87 89C1                    	mov	ecx, eax	; word count
  3610                                  lff44m2_9:
  3611 00001A89 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3612 00001A8E C605[96200000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3613                                  lff44m2_1:
  3614                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3615                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3616 00001A95 66AD                    	lodsw
  3617 00001A97 31D2                    	xor	edx, edx
  3618 00001A99 49                      	dec	ecx
  3619 00001A9A 7403                    	jz	short lff44m2_2_1
  3620 00001A9C 668B16                  	mov	dx, [esi]
  3621                                  lff44m2_2_1:	
  3622                                  	; ax = [previous_val]
  3623                                  	; dx = [next_val]
  3624 00001A9F E80B020000              	call	interpolating_2_16bit_mono
  3625 00001AA4 E31B                    	jecxz	lff44m2_3
  3626                                  lff44m2_2_2:
  3627 00001AA6 66AD                    	lodsw
  3628 00001AA8 66AB                    	stosw		; (L)eft Channel
  3629 00001AAA 66AB                    	stosw		; (R)ight Channel
  3630                                  
  3631 00001AAC 49                      	dec	ecx
  3632 00001AAD 7412                    	jz	short lff44m2_3	
  3633 00001AAF 4D                      	dec	ebp
  3634 00001AB0 75F4                    	jnz	short lff44m2_2_2
  3635                                  	
  3636 00001AB2 FE0D[96200000]          	dec	byte [faz]
  3637 00001AB8 74CF                    	jz	short lff44m2_9 
  3638 00001ABA BD0B000000              	mov	ebp, 11
  3639 00001ABF EBD4                    	jmp	short lff44m2_1
  3640                                  
  3641                                  lff44m2_3:
  3642                                  lff44s2_3:
  3643 00001AC1 E962F0FFFF              	jmp	lff44_3	; padfill
  3644                                  		; (put zeros in the remain words of the buffer)
  3645                                  lff44m2_7:
  3646                                  lff44s2_7:
  3647 00001AC6 E97EF0FFFF              	jmp	lff44_5  ; error
  3648                                  
  3649                                  load_44khz_stereo_16_bit:
  3650                                  	; 18/11/2023
  3651 00001ACB F605[80680000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3652                                  					; last of the file?
  3653 00001AD2 7402                    	jz	short lff44s2_0		; no
  3654 00001AD4 F9                      	stc
  3655 00001AD5 C3                      	retn
  3656                                  
  3657                                  lff44s2_0:
  3658 00001AD6 BE[00000400]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3659                                          ;mov	edx, [loadsize]
  3660                                  
  3661                                  	; esi = buffer address
  3662                                  	;; edx = buffer size
  3663                                  
  3664                                  	; load file into memory
  3665                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001ADB 8B1D[53650000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001AE1 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001AE3 8B15[DD030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001AE9 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001AEE CD40                <1>  int 40h
  3666 00001AF0 72D4                    	jc	short lff44s2_7 ; error !
  3667                                  
  3668 00001AF2 BF[00800000]            	mov	edi, audio_buffer
  3669                                  	
  3670 00001AF7 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3671 00001AFA 7505                    	jnz	short lff44s2_8
  3672 00001AFC E93FF0FFFF              	jmp	lff44_eof
  3673                                  
  3674                                  lff44s2_8:
  3675 00001B01 89C1                    	mov	ecx, eax	; dword count
  3676                                  lff44s2_9:
  3677 00001B03 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3678 00001B08 C605[96200000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3679                                  lff44s2_1:
  3680                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3681                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3682 00001B0F 66AD                    	lodsw
  3683 00001B11 89C3                    	mov	ebx, eax
  3684 00001B13 66AD                    	lodsw
  3685                                  	;mov	dx, [esi]
  3686                                  	;mov	[next_val_l], dx
  3687                                  	;mov	dx, [esi+2]
  3688                                  	; 26/11/2023
  3689 00001B15 8B16                    	mov	edx, [esi]
  3690 00001B17 668915[92200000]        	mov	[next_val_l], dx
  3691 00001B1E C1EA10                  	shr	edx, 16
  3692 00001B21 49                      	dec	ecx
  3693 00001B22 7509                    	jnz	short lff44s2_2_1
  3694 00001B24 31D2                    	xor	edx, edx ; 0
  3695 00001B26 668915[92200000]        	mov	[next_val_l], dx
  3696                                  lff44s2_2_1:
  3697                                  	; bx = [previous_val_l]
  3698                                  	; ax = [previous_val_r]
  3699                                  	; [next_val_l]
  3700                                  	; dx = [next_val_r]
  3701 00001B2D E895010000              	call	interpolating_2_16bit_stereo
  3702 00001B32 E38D                    	jecxz	lff44s2_3
  3703                                  lff44s2_2_2:
  3704                                  	;movsw		; (L)eft Channel
  3705                                  	;movsw		; (R)ight Channel
  3706 00001B34 A5                      	movsd
  3707                                  
  3708 00001B35 49                      	dec	ecx
  3709 00001B36 7489                    	jz	short lff44s2_3	
  3710 00001B38 4D                      	dec	ebp
  3711 00001B39 75F9                    	jnz	short lff44s2_2_2
  3712                                  	
  3713 00001B3B FE0D[96200000]          	dec	byte [faz]
  3714 00001B41 74C0                    	jz	short lff44s2_9 
  3715 00001B43 BD0B000000              	mov	ebp, 11
  3716 00001B48 EBC5                    	jmp	short lff44s2_1
  3717                                  
  3718                                  ; .....................
  3719                                  
  3720                                  interpolating_3_8bit_mono:
  3721                                  	; 16/11/2023
  3722                                  	; al = [previous_val]
  3723                                  	; dl = [next_val]
  3724                                  	; original-interpolated-interpolated
  3725 00001B4A 88C3                    	mov	bl, al
  3726 00001B4C 2C80                    	sub	al, 80h
  3727 00001B4E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3728 00001B52 66AB                    	stosw		; original sample (L)
  3729 00001B54 66AB                    	stosw		; original sample (R)
  3730 00001B56 88D8                    	mov	al, bl
  3731 00001B58 00D0                    	add	al, dl	
  3732 00001B5A D0D8                    	rcr	al, 1
  3733 00001B5C 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3734 00001B5E 00D8                    	add	al, bl
  3735 00001B60 D0D8                    	rcr	al, 1
  3736 00001B62 2C80                    	sub	al, 80h
  3737 00001B64 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3738 00001B68 66AB                    	stosw		; interpolated sample 1 (L)
  3739 00001B6A 66AB                    	stosw		; interpolated sample 1 (R)
  3740 00001B6C 88F8                    	mov	al, bh
  3741 00001B6E 00D0                    	add	al, dl	; [next_val]
  3742 00001B70 D0D8                    	rcr	al, 1
  3743 00001B72 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3744 00001B76 66AB                    	stosw		; interpolated sample 2 (L)
  3745 00001B78 66AB                    	stosw		; interpolated sample 2 (R)
  3746 00001B7A C3                      	retn
  3747                                  
  3748                                  interpolating_3_8bit_stereo:
  3749                                  	; 16/11/2023
  3750                                  	; al = [previous_val_l]
  3751                                  	; ah = [previous_val_r]
  3752                                  	; dl = [next_val_l]
  3753                                  	; dh = [next_val_r]	
  3754                                  	; original-interpolated-interpolated
  3755 00001B7B 89C3                    	mov	ebx, eax
  3756 00001B7D 2C80                    	sub	al, 80h
  3757 00001B7F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3758 00001B83 66AB                    	stosw		; original sample (L)
  3759 00001B85 88F8                    	mov	al, bh
  3760 00001B87 2C80                    	sub	al, 80h
  3761 00001B89 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3762 00001B8D 66AB                    	stosw		; original sample (R)
  3763 00001B8F 88D8                    	mov	al, bl
  3764 00001B91 00D0                    	add	al, dl	; [next_val_l]	
  3765 00001B93 D0D8                    	rcr	al, 1
  3766 00001B95 50                      	push	eax ; *	; al = interpolated middle (L) (temporary)
  3767 00001B96 00D8                    	add	al, bl	; [previous_val_l]
  3768 00001B98 D0D8                    	rcr	al, 1
  3769 00001B9A 2C80                    	sub	al, 80h
  3770 00001B9C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3771 00001BA0 66AB                    	stosw		; interpolated sample 1 (L)
  3772 00001BA2 88F8                    	mov	al, bh
  3773 00001BA4 00F0                    	add	al, dh	; [next_val_r]
  3774 00001BA6 D0D8                    	rcr	al, 1
  3775 00001BA8 50                      	push	eax ; ** ; al = interpolated middle (R) (temporary)
  3776 00001BA9 00F8                    	add	al, bh	; [previous_val_r]
  3777 00001BAB D0D8                    	rcr	al, 1
  3778 00001BAD 2C80                    	sub	al, 80h
  3779 00001BAF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3780 00001BB3 66AB                    	stosw		; interpolated sample 1 (R)
  3781 00001BB5 5B                      	pop	ebx ; **
  3782 00001BB6 58                      	pop	eax ; *
  3783 00001BB7 00D0                    	add	al, dl	; [next_val_l]
  3784 00001BB9 D0D8                    	rcr	al, 1
  3785 00001BBB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3786 00001BBF 66AB                    	stosw		; interpolated sample 2 (L)
  3787 00001BC1 88D8                    	mov	al, bl
  3788 00001BC3 00F0                    	add	al, dh	; [next_val_r]
  3789 00001BC5 D0D8                    	rcr	al, 1
  3790 00001BC7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3791 00001BCB 66AB                    	stosw		; interpolated sample 2 (R)
  3792 00001BCD C3                      	retn
  3793                                  
  3794                                  interpolating_2_8bit_mono:
  3795                                  	; 16/11/2023
  3796                                  	; al = [previous_val]
  3797                                  	; dl = [next_val]
  3798                                  	; original-interpolated
  3799 00001BCE 88C3                    	mov	bl, al
  3800 00001BD0 2C80                    	sub	al, 80h
  3801 00001BD2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3802 00001BD6 66AB                    	stosw		; original sample (L)
  3803 00001BD8 66AB                    	stosw		; original sample (R)
  3804 00001BDA 88D8                    	mov	al, bl
  3805 00001BDC 00D0                    	add	al, dl	
  3806 00001BDE D0D8                    	rcr	al, 1
  3807 00001BE0 2C80                    	sub	al, 80h
  3808 00001BE2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3809 00001BE6 66AB                    	stosw		; interpolated sample (L)
  3810 00001BE8 66AB                    	stosw		; interpolated sample (R)
  3811 00001BEA C3                      	retn
  3812                                  
  3813                                  interpolating_2_8bit_stereo:
  3814                                  	; 16/11/2023
  3815                                  	; al = [previous_val_l]
  3816                                  	; ah = [previous_val_r]
  3817                                  	; dl = [next_val_l]
  3818                                  	; dh = [next_val_r]	
  3819                                  	; original-interpolated
  3820 00001BEB 89C3                    	mov	ebx, eax
  3821 00001BED 2C80                    	sub	al, 80h
  3822 00001BEF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3823 00001BF3 66AB                    	stosw		; original sample (L)
  3824 00001BF5 88F8                    	mov	al, bh
  3825 00001BF7 2C80                    	sub	al, 80h
  3826 00001BF9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3827 00001BFD 66AB                    	stosw		; original sample (R)
  3828 00001BFF 88D8                    	mov	al, bl	; [previous_val_l]
  3829 00001C01 00D0                    	add	al, dl	; [next_val_l]	
  3830 00001C03 D0D8                    	rcr	al, 1
  3831 00001C05 2C80                    	sub	al, 80h
  3832 00001C07 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3833 00001C0B 66AB                    	stosw		; interpolated sample (L)
  3834 00001C0D 88F8                    	mov	al, bh
  3835 00001C0F 00F0                    	add	al, dh	; [next_val_r]
  3836 00001C11 D0D8                    	rcr	al, 1
  3837 00001C13 2C80                    	sub	al, 80h
  3838 00001C15 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3839 00001C19 66AB                    	stosw		; interpolated sample (R)
  3840 00001C1B C3                      	retn
  3841                                  
  3842                                  interpolating_3_16bit_mono:
  3843                                  	; 16/11/2023
  3844                                  	; ax = [previous_val]
  3845                                  	; dx = [next_val]
  3846                                  	; original-interpolated-interpolated
  3847                                  
  3848 00001C1C 66AB                    	stosw		; original sample (L)
  3849 00001C1E 66AB                    	stosw		; original sample (R)
  3850 00001C20 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3851 00001C23 50                      	push	eax ; *	; [previous_val]
  3852 00001C24 80C680                  	add	dh, 80h
  3853 00001C27 6601D0                  	add	ax, dx
  3854 00001C2A 66D1D8                  	rcr	ax, 1
  3855 00001C2D 5B                      	pop	ebx ; *		
  3856 00001C2E 93                      	xchg	ebx, eax ; bx  = interpolated middle (temporary)
  3857 00001C2F 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  3858 00001C32 66D1D8                  	rcr	ax, 1
  3859 00001C35 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3860 00001C38 66AB                    	stosw 		; interpolated sample 1 (L)
  3861 00001C3A 66AB                    	stosw		; interpolated sample 1 (R)
  3862 00001C3C 89D8                    	mov	eax, ebx
  3863 00001C3E 6601D0                  	add	ax, dx	 ;interpolated middle + [next_val]
  3864 00001C41 66D1D8                  	rcr	ax, 1
  3865 00001C44 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3866 00001C47 66AB                    	stosw		; interpolated sample 2 (L)
  3867 00001C49 66AB                    	stosw		; interpolated sample 2 (R)
  3868 00001C4B C3                      	retn
  3869                                  
  3870                                  interpolating_3_16bit_stereo:
  3871                                  	; 16/11/2023
  3872                                  	; bx = [previous_val_l]
  3873                                  	; ax = [previous_val_r]
  3874                                  	; [next_val_l]
  3875                                  	; dx = [next_val_r]
  3876                                  	; original-interpolated-interpolated
  3877                                  
  3878 00001C4C 93                      	xchg	eax, ebx
  3879 00001C4D 66AB                    	stosw		; original sample (L)
  3880 00001C4F 93                      	xchg	eax, ebx
  3881 00001C50 66AB                    	stosw		; original sample (R)
  3882 00001C52 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3883 00001C55 50                      	push	eax ; *	; [previous_val_r]
  3884 00001C56 80C780                  	add	bh, 80h
  3885 00001C59 8005[93200000]80        	add	byte [next_val_l+1], 80h
  3886 00001C60 66A1[92200000]          	mov	ax, [next_val_l]
  3887 00001C66 6601D8                  	add	ax, bx	; [previous_val_l]
  3888 00001C69 66D1D8                  	rcr	ax, 1
  3889 00001C6C 93                      	xchg	eax, ebx ; ax = [previous_val_l]	
  3890 00001C6D 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  3891 00001C70 66D1D8                  	rcr	ax, 1
  3892 00001C73 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3893 00001C76 66AB                    	stosw 		; interpolated sample 1 (L)
  3894 00001C78 58                      	pop	eax  ; *
  3895 00001C79 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  3896 00001C7C 52                      	push	edx  ; * ; [next_val_r]
  3897 00001C7D 92                      	xchg	eax, edx
  3898 00001C7E 6601D0                  	add	ax, dx	; [next_val_r] + [previous_val_r]
  3899 00001C81 66D1D8                  	rcr	ax, 1	; / 2
  3900 00001C84 50                      	push	eax ; ** ; interpolated middle (R)
  3901 00001C85 6601D0                  	add	ax, dx	; + [previous_val_r]
  3902 00001C88 66D1D8                  	rcr	ax, 1
  3903 00001C8B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3904 00001C8E 66AB                    	stosw 		; interpolated sample 1 (R)
  3905 00001C90 66A1[92200000]          	mov	ax, [next_val_l]
  3906 00001C96 6601D8                  	add	ax, bx	; + interpolated middle (L)
  3907 00001C99 66D1D8                  	rcr	ax, 1
  3908 00001C9C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3909 00001C9F 66AB                    	stosw 		; interpolated sample 2 (L)
  3910 00001CA1 58                      	pop	eax ; **
  3911 00001CA2 5A                      	pop	edx ; *	
  3912 00001CA3 6601D0                  	add	ax, dx	; interpolated middle + [next_val_r]
  3913 00001CA6 66D1D8                  	rcr	ax, 1	; / 2
  3914 00001CA9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3915 00001CAC 66AB                    	stosw 		; interpolated sample 2 (L)
  3916 00001CAE C3                      	retn
  3917                                  
  3918                                  interpolating_2_16bit_mono:
  3919                                  	; 16/11/2023
  3920                                  	; ax = [previous_val]
  3921                                  	; dx = [next_val]
  3922                                  	; original-interpolated
  3923                                  
  3924 00001CAF 66AB                    	stosw		; original sample (L)
  3925 00001CB1 66AB                    	stosw		; original sample (R)
  3926 00001CB3 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3927 00001CB6 80C680                  	add	dh, 80h
  3928 00001CB9 6601D0                  	add	ax, dx
  3929 00001CBC 66D1D8                  	rcr	ax, 1
  3930 00001CBF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3931 00001CC2 66AB                    	stosw		; interpolated sample (L)
  3932 00001CC4 66AB                    	stosw		; interpolated sample (R)
  3933 00001CC6 C3                      	retn
  3934                                  
  3935                                  interpolating_2_16bit_stereo:
  3936                                  	; 18/01/2025
  3937                                  	; 16/11/2023
  3938                                  	; bx = [previous_val_l]
  3939                                  	; ax = [previous_val_r]
  3940                                  	; [next_val_l]
  3941                                  	; dx = [next_val_r]
  3942                                  	; original-interpolated
  3943                                  
  3944 00001CC7 93                      	xchg	eax, ebx
  3945 00001CC8 66AB                    	stosw		; original sample (L)
  3946 00001CCA 93                      	xchg	eax, ebx
  3947 00001CCB 66AB                    	stosw		; original sample (R)
  3948 00001CCD 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3949 00001CD0 80C680                  	add	dh, 80h
  3950 00001CD3 6601D0                  	add	ax, dx	; [previous_val_r] + [next_val_r]
  3951 00001CD6 66D1D8                  	rcr	ax, 1	; / 2
  3952                                  	; 18/01/2025
  3953 00001CD9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3954                                  	;push	eax ; *	; interpolated sample (R)
  3955                                  	; 18/01/2025
  3956 00001CDC C1E010                  	shl	eax, 16
  3957 00001CDF 66A1[92200000]          	mov	ax, [next_val_l]
  3958 00001CE5 80C480                  	add	ah, 80h
  3959 00001CE8 80C780                  	add	bh, 80h
  3960 00001CEB 6601D8                  	add	ax, bx	; [next_val_l] + [previous_val_l]
  3961 00001CEE 66D1D8                  	rcr	ax, 1	; / 2
  3962 00001CF1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3963                                  	; 18/01/2025
  3964                                  	;stosw 		; interpolated sample (L)
  3965                                  	;pop	eax ; *	
  3966                                  	;sub	ah, 80h	; -32768 to +32767 format again
  3967                                  	;stosw 		; interpolated sample (R)
  3968                                  	; 18/01/2025
  3969 00001CF4 AB                      	stosd
  3970 00001CF5 C3                      	retn
  3971                                  
  3972                                  interpolating_5_8bit_mono:
  3973                                  	; 17/11/2023
  3974                                  	; al = [previous_val]
  3975                                  	; dl = [next_val]
  3976                                  	; original-interpltd-interpltd-interpltd-interpltd
  3977 00001CF6 88C3                    	mov	bl, al
  3978 00001CF8 2C80                    	sub	al, 80h
  3979 00001CFA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3980 00001CFE 66AB                    	stosw		; original sample (L)
  3981 00001D00 66AB                    	stosw		; original sample (R)
  3982 00001D02 88D8                    	mov	al, bl
  3983 00001D04 00D0                    	add	al, dl	
  3984 00001D06 D0D8                    	rcr	al, 1
  3985 00001D08 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3986 00001D0A 00D8                    	add	al, bl  ; [previous_val]
  3987 00001D0C D0D8                    	rcr	al, 1 	
  3988 00001D0E 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  3989 00001D10 00D8                    	add	al, bl
  3990 00001D12 D0D8                    	rcr	al, 1
  3991 00001D14 2C80                    	sub	al, 80h
  3992 00001D16 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3993 00001D1A 66AB                    	stosw		; interpolated sample 1 (L)
  3994 00001D1C 66AB                    	stosw		; interpolated sample 1 (R)
  3995 00001D1E 88F8                    	mov	al, bh
  3996 00001D20 00F0                    	add	al, dh
  3997 00001D22 D0D8                    	rcr	al, 1
  3998 00001D24 2C80                    	sub	al, 80h
  3999 00001D26 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4000 00001D2A 66AB                    	stosw		; interpolated sample 2 (L)
  4001 00001D2C 66AB                    	stosw		; interpolated sample 2 (R)
  4002 00001D2E 88F8                    	mov	al, bh
  4003 00001D30 00D0                    	add	al, dl	; [next_val]
  4004 00001D32 D0D8                    	rcr	al, 1
  4005 00001D34 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  4006 00001D36 00F8                    	add	al, bh
  4007 00001D38 D0D8                    	rcr	al, 1
  4008 00001D3A 2C80                    	sub	al, 80h
  4009 00001D3C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4010 00001D40 66AB                    	stosw		; interpolated sample 3 (L)
  4011 00001D42 66AB                    	stosw		; interpolated sample 3 (R)
  4012 00001D44 88F0                    	mov	al, dh
  4013 00001D46 00D0                    	add	al, dl
  4014 00001D48 D0D8                    	rcr	al, 1
  4015 00001D4A 2C80                    	sub	al, 80h
  4016 00001D4C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4017 00001D50 66AB                    	stosw		; interpolated sample 4 (L)
  4018 00001D52 66AB                    	stosw		; interpolated sample 4 (R)
  4019 00001D54 C3                      	retn
  4020                                  
  4021                                  interpolating_5_8bit_stereo:
  4022                                  	; 17/11/2023
  4023                                  	; al = [previous_val_l]
  4024                                  	; ah = [previous_val_r]
  4025                                  	; dl = [next_val_l]
  4026                                  	; dh = [next_val_r]	
  4027                                  	; original-interpltd-interpltd-interpltd-interpltd
  4028 00001D55 89C3                    	mov	ebx, eax
  4029 00001D57 2C80                    	sub	al, 80h
  4030 00001D59 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4031 00001D5D 66AB                    	stosw		; original sample (L)
  4032 00001D5F 88F8                    	mov	al, bh
  4033 00001D61 2C80                    	sub	al, 80h
  4034 00001D63 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4035 00001D67 66AB                    	stosw		; original sample (R)
  4036 00001D69 52                      	push	edx ; *
  4037 00001D6A 88D8                    	mov	al, bl
  4038 00001D6C 00D0                    	add	al, dl	; [next_val_l]
  4039 00001D6E D0D8                    	rcr	al, 1
  4040 00001D70 50                      	push	eax ; **	; al = interpolated middle (L) (temporary)
  4041 00001D71 00D8                    	add	al, bl	; [previous_val_l]
  4042 00001D73 D0D8                    	rcr	al, 1
  4043 00001D75 86D8                    	xchg	al, bl	
  4044 00001D77 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  4045 00001D79 D0D8                    	rcr	al, 1
  4046 00001D7B 2C80                    	sub	al, 80h
  4047 00001D7D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4048 00001D81 66AB                    	stosw		; interpolated sample 1 (L)
  4049 00001D83 88F8                    	mov	al, bh
  4050 00001D85 00F0                    	add	al, dh	; [next_val_r]
  4051 00001D87 D0D8                    	rcr	al, 1
  4052 00001D89 50                      	push	eax ; *** ; al = interpolated middle (R) (temporary)
  4053 00001D8A 00F8                    	add	al, bh	; [previous_val_r]
  4054 00001D8C D0D8                    	rcr	al, 1
  4055 00001D8E 86F8                    	xchg	al, bh	
  4056 00001D90 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  4057 00001D92 D0D8                    	rcr	al, 1
  4058 00001D94 2C80                    	sub	al, 80h
  4059 00001D96 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4060 00001D9A 66AB                    	stosw		; interpolated sample 1 (R)
  4061 00001D9C 5A                      	pop	edx ; ***
  4062 00001D9D 58                      	pop	eax ; **	; al = interpolated middle (L) (temporary)
  4063 00001D9E 86D8                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  4064 00001DA0 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  4065 00001DA2 D0D8                    	rcr	al, 1
  4066 00001DA4 2C80                    	sub	al, 80h
  4067 00001DA6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4068 00001DAA 66AB                    	stosw		; interpolated sample 2 (L)	
  4069 00001DAC 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  4070 00001DAE 86F8                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  4071 00001DB0 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  4072 00001DB2 D0D8                    	rcr	al, 1
  4073 00001DB4 2C80                    	sub	al, 80h
  4074 00001DB6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4075 00001DBA 66AB                    	stosw		; interpolated sample 2 (R)
  4076 00001DBC 5A                      	pop	edx ; *
  4077 00001DBD 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  4078 00001DBF 00D0                    	add	al, dl	; [next_val_l]
  4079 00001DC1 D0D8                    	rcr	al, 1
  4080 00001DC3 86D8                    	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  4081 00001DC5 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  4082 00001DC7 D0D8                    	rcr	al, 1
  4083 00001DC9 2C80                    	sub	al, 80h
  4084 00001DCB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4085 00001DCF 66AB                    	stosw		; interpolated sample 3 (L)
  4086 00001DD1 88F8                    	mov	al, bh	
  4087 00001DD3 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  4088 00001DD5 D0D8                    	rcr	al, 1
  4089 00001DD7 86F8                    	xchg	al, bh	; al = interpolated middle (R)
  4090 00001DD9 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  4091 00001DDB D0D8                    	rcr	al, 1
  4092 00001DDD 2C80                    	sub	al, 80h
  4093 00001DDF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4094 00001DE3 66AB                    	stosw		; interpolated sample 3 (R)
  4095 00001DE5 88D8                    	mov	al, bl
  4096 00001DE7 00D0                    	add	al, dl	; [next_val_l]
  4097 00001DE9 D0D8                    	rcr	al, 1
  4098 00001DEB 2C80                    	sub	al, 80h
  4099 00001DED 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4100 00001DF1 66AB                    	stosw		; interpolated sample 4 (L)
  4101 00001DF3 88F8                    	mov	al, bh
  4102 00001DF5 00F0                    	add	al, dh	; [next_val_r]
  4103 00001DF7 D0D8                    	rcr	al, 1
  4104 00001DF9 2C80                    	sub	al, 80h
  4105 00001DFB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4106 00001DFF 66AB                    	stosw		; interpolated sample 4 (R)
  4107 00001E01 C3                      	retn
  4108                                  
  4109                                  interpolating_4_8bit_mono:
  4110                                  	; 17/11/2023
  4111                                  	; al = [previous_val]
  4112                                  	; dl = [next_val]
  4113                                  	; original-interpolated-interpolated-interpolated
  4114 00001E02 88C3                    	mov	bl, al
  4115 00001E04 2C80                    	sub	al, 80h
  4116 00001E06 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4117 00001E0A 66AB                    	stosw		; original sample (L)
  4118 00001E0C 66AB                    	stosw		; original sample (R)
  4119 00001E0E 88D8                    	mov	al, bl
  4120 00001E10 00D0                    	add	al, dl	
  4121 00001E12 D0D8                    	rcr	al, 1
  4122 00001E14 86D8                    	xchg	al, bl  ; al = [previous_val]
  4123 00001E16 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  4124 00001E18 D0D8                    	rcr	al, 1 	
  4125 00001E1A 2C80                    	sub	al, 80h
  4126 00001E1C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4127 00001E20 66AB                    	stosw		; interpolated sample 1 (L)
  4128 00001E22 66AB                    	stosw		; interpolated sample 1 (R)
  4129 00001E24 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  4130 00001E26 2C80                    	sub	al, 80h
  4131 00001E28 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4132 00001E2C 66AB                    	stosw		; interpolated sample 2 (L)
  4133 00001E2E 66AB                    	stosw		; interpolated sample 2 (R)
  4134 00001E30 88D8                    	mov	al, bl
  4135 00001E32 00D0                    	add	al, dl	; [next_val]
  4136 00001E34 D0D8                    	rcr	al, 1
  4137 00001E36 2C80                    	sub	al, 80h
  4138 00001E38 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4139 00001E3C 66AB                    	stosw		; interpolated sample 3 (L)
  4140 00001E3E 66AB                    	stosw		; interpolated sample 3 (R)
  4141 00001E40 C3                      	retn
  4142                                  
  4143                                  interpolating_4_8bit_stereo:
  4144                                  	; 17/11/2023
  4145                                  	; al = [previous_val_l]
  4146                                  	; ah = [previous_val_r]
  4147                                  	; dl = [next_val_l]
  4148                                  	; dh = [next_val_r]	
  4149                                  	; original-interpolated-interpolated-interpolated
  4150 00001E41 89C3                    	mov	ebx, eax
  4151 00001E43 2C80                    	sub	al, 80h
  4152 00001E45 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4153 00001E49 66AB                    	stosw		; original sample (L)
  4154 00001E4B 88F8                    	mov	al, bh
  4155 00001E4D 2C80                    	sub	al, 80h
  4156 00001E4F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4157 00001E53 66AB                    	stosw		; original sample (R)
  4158 00001E55 88D8                    	mov	al, bl
  4159 00001E57 00D0                    	add	al, dl	; [next_val_l]
  4160 00001E59 D0D8                    	rcr	al, 1
  4161 00001E5B 86D8                    	xchg	al, bl	; al = [previous_val_l]
  4162 00001E5D 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  4163 00001E5F D0D8                    	rcr	al, 1
  4164 00001E61 2C80                    	sub	al, 80h
  4165 00001E63 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4166 00001E67 66AB                    	stosw		; interpolated sample 1 (L)
  4167 00001E69 88F8                    	mov	al, bh
  4168 00001E6B 00F0                    	add	al, dh	; [next_val_r]
  4169 00001E6D D0D8                    	rcr	al, 1
  4170 00001E6F 86F8                    	xchg	al, bh	; al = [previous_val_h]
  4171 00001E71 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  4172 00001E73 D0D8                    	rcr	al, 1
  4173 00001E75 2C80                    	sub	al, 80h
  4174 00001E77 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4175 00001E7B 66AB                    	stosw		; interpolated sample 1 (R)
  4176 00001E7D 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  4177 00001E7F 2C80                    	sub	al, 80h
  4178 00001E81 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4179 00001E85 66AB                    	stosw		; interpolated sample 2 (L)
  4180 00001E87 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  4181 00001E89 2C80                    	sub	al, 80h
  4182 00001E8B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4183 00001E8F 66AB                    	stosw		; interpolated sample 2 (L)
  4184 00001E91 88D8                    	mov	al, bl
  4185 00001E93 00D0                    	add	al, dl	; [next_val_l]
  4186 00001E95 D0D8                    	rcr	al, 1
  4187 00001E97 2C80                    	sub	al, 80h
  4188 00001E99 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4189 00001E9D 66AB                    	stosw		; interpolated sample 3 (L)
  4190 00001E9F 88F8                    	mov	al, bh
  4191 00001EA1 00F0                    	add	al, dh	; [next_val_r]
  4192 00001EA3 D0D8                    	rcr	al, 1
  4193 00001EA5 2C80                    	sub	al, 80h
  4194 00001EA7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4195 00001EAB 66AB                    	stosw		; interpolated sample 3 (R)
  4196 00001EAD C3                      	retn
  4197                                  
  4198                                  interpolating_5_16bit_mono:
  4199                                  	; 18/11/2023
  4200                                  	; ax = [previous_val]
  4201                                  	; dx = [next_val]
  4202                                  	; original-interpltd-interpltd-interpltd-interpltd
  4203 00001EAE 66AB                    	stosw		; original sample (L)
  4204 00001EB0 66AB                    	stosw		; original sample (R)
  4205 00001EB2 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4206 00001EB5 89C3                    	mov	ebx, eax ; [previous_val]
  4207 00001EB7 80C680                  	add	dh, 80h
  4208 00001EBA 6601D0                  	add	ax, dx
  4209 00001EBD 66D1D8                  	rcr	ax, 1
  4210 00001EC0 50                      	push	eax ; *	; interpolated middle (temporary)
  4211 00001EC1 6601D8                  	add	ax, bx	; interpolated middle + [previous_val] 
  4212 00001EC4 66D1D8                  	rcr	ax, 1
  4213 00001EC7 50                      	push	eax ; **	; interpolated 1st quarter (temporary)
  4214 00001EC8 6601D8                  	add	ax, bx	; 1st quarter + [previous_val]
  4215 00001ECB 66D1D8                  	rcr	ax, 1	
  4216 00001ECE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4217 00001ED1 66AB                    	stosw 		; interpolated sample 1 (L)
  4218 00001ED3 66AB                    	stosw		; interpolated sample 1 (R)
  4219 00001ED5 58                      	pop	eax ; **	
  4220 00001ED6 5B                      	pop	ebx ; *
  4221 00001ED7 6601D8                  	add	ax, bx	; 1st quarter + middle
  4222 00001EDA 66D1D8                  	rcr	ax, 1	; / 2
  4223 00001EDD 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  4224 00001EE0 66AB                    	stosw		; interpolated sample 2 (L)
  4225 00001EE2 66AB                    	stosw		; interpolated sample 2 (R)		
  4226 00001EE4 89D8                    	mov	eax, ebx
  4227 00001EE6 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4228 00001EE9 66D1D8                  	rcr	ax, 1
  4229 00001EEC 50                      	push	eax ; *	; interpolated 3rd quarter (temporary)
  4230 00001EED 6601D8                  	add	ax, bx	; + interpolated middle
  4231 00001EF0 66D1D8                  	rcr	ax, 1
  4232 00001EF3 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4233 00001EF6 66AB                    	stosw		; interpolated sample 3 (L)
  4234 00001EF8 66AB                    	stosw		; interpolated sample 3 (R)
  4235 00001EFA 58                      	pop	eax ; *	
  4236 00001EFB 6601D0                  	add	ax, dx	; 3rd quarter + [next_val]
  4237 00001EFE 66D1D8                  	rcr	ax, 1	; / 2
  4238 00001F01 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4239 00001F04 66AB                    	stosw		; interpolated sample 4 (L)
  4240 00001F06 66AB                    	stosw		; interpolated sample 4 (R)
  4241 00001F08 C3                      	retn
  4242                                  
  4243                                  interpolating_5_16bit_stereo:
  4244                                  	; 18/11/2023
  4245                                  	; bx = [previous_val_l]
  4246                                  	; ax = [previous_val_r]
  4247                                  	; [next_val_l]
  4248                                  	; [next_val_r]
  4249                                  	; original-interpltd-interpltd-interpltd-interpltd
  4250 00001F09 51                      	push	ecx ; !
  4251 00001F0A 93                      	xchg	eax, ebx
  4252 00001F0B 66AB                    	stosw		; original sample (L)
  4253 00001F0D 93                      	xchg	eax, ebx
  4254 00001F0E 66AB                    	stosw		; original sample (R)
  4255 00001F10 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4256 00001F13 50                      	push	eax ; *	; [previous_val_r]
  4257 00001F14 80C780                  	add	bh, 80h
  4258 00001F17 8005[93200000]80        	add	byte [next_val_l+1], 80h
  4259 00001F1E 66A1[92200000]          	mov	ax, [next_val_l]
  4260 00001F24 6601D8                  	add	ax, bx	; [previous_val_l]
  4261 00001F27 66D1D8                  	rcr	ax, 1
  4262 00001F2A 89C1                    	mov	ecx, eax ; interpolated middle (L)
  4263 00001F2C 6601D8                  	add	ax, bx	
  4264 00001F2F 66D1D8                  	rcr	ax, 1
  4265 00001F32 89C2                    	mov	edx, eax ; interpolated 1st quarter (L)	
  4266 00001F34 6601D8                  	add	ax, bx	; [previous_val_l]
  4267 00001F37 66D1D8                  	rcr	ax, 1
  4268 00001F3A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4269 00001F3D 66AB                    	stosw 		; interpolated sample 1 (L)
  4270 00001F3F 89C8                    	mov	eax, ecx
  4271 00001F41 6601D0                  	add	ax, dx	; middle (L) + 1st quarter (L) 
  4272 00001F44 66D1D8                  	rcr	ax, 1	; / 2
  4273 00001F47 89C3                    	mov	ebx, eax  ; interpolated sample 2 (L)
  4274 00001F49 5A                      	pop	edx ; *	; [previous_val_r]
  4275 00001F4A 89D0                    	mov	eax, edx
  4276 00001F4C 8005[95200000]80        	add	byte [next_val_r+1], 80h
  4277 00001F53 660305[94200000]        	add	ax, [next_val_r]
  4278 00001F5A 66D1D8                  	rcr	ax, 1
  4279 00001F5D 50                      	push	eax ; *	; interpolated middle (R)
  4280 00001F5E 6601D0                  	add	ax, dx
  4281 00001F61 66D1D8                  	rcr	ax, 1
  4282 00001F64 50                      	push	eax ; ** ; interpolated 1st quarter (R)
  4283 00001F65 6601D0                  	add	ax, dx	; [previous_val_r]
  4284 00001F68 66D1D8                  	rcr	ax, 1
  4285 00001F6B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4286 00001F6E 66AB                    	stosw 		; interpolated sample 1 (R)
  4287 00001F70 89D8                    	mov	eax, ebx
  4288 00001F72 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4289 00001F75 66AB                    	stosw 		; interpolated sample 2 (L)
  4290 00001F77 58                      	pop	eax ; **
  4291 00001F78 5A                      	pop	edx ; *
  4292 00001F79 6601D0                  	add	ax, dx	; 1st quarter (R) + middle (R)
  4293 00001F7C 66D1D8                  	rcr	ax, 1	; / 2
  4294 00001F7F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4295 00001F82 66AB                    	stosw 		; interpolated sample 2 (R)
  4296 00001F84 89C8                    	mov	eax, ecx
  4297 00001F86 660305[92200000]        	add	ax, [next_val_l]
  4298 00001F8D 66D1D8                  	rcr	ax, 1
  4299 00001F90 50                      	push	eax ; * ; interpolated 3rd quarter (L)
  4300 00001F91 6601C8                  	add	ax, cx	; interpolated middle (L)
  4301 00001F94 66D1D8                  	rcr	ax, 1
  4302 00001F97 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4303 00001F9A 66AB                    	stosw 		; interpolated sample 3 (L)
  4304 00001F9C 89D0                    	mov	eax, edx
  4305 00001F9E 660305[94200000]        	add	ax, [next_val_r]
  4306 00001FA5 66D1D8                  	rcr	ax, 1
  4307 00001FA8 50                      	push	eax ; ** ; interpolated 3rd quarter (R)
  4308 00001FA9 6601D0                  	add	ax, dx	; interpolated middle (R)
  4309 00001FAC 66D1D8                  	rcr	ax, 1
  4310 00001FAF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4311 00001FB2 66AB                    	stosw 		; interpolated sample 3 (R)
  4312 00001FB4 5B                      	pop	ebx ; **
  4313 00001FB5 58                      	pop	eax ; *
  4314 00001FB6 660305[92200000]        	add	ax, [next_val_l]
  4315 00001FBD 66D1D8                  	rcr	ax, 1
  4316 00001FC0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4317 00001FC3 66AB                    	stosw 		; interpolated sample 4 (L)
  4318 00001FC5 89D8                    	mov	eax, ebx	
  4319 00001FC7 660305[94200000]        	add	ax, [next_val_r]
  4320 00001FCE 66D1D8                  	rcr	ax, 1
  4321 00001FD1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4322 00001FD4 66AB                    	stosw 		; interpolated sample 4 (R)
  4323 00001FD6 59                      	pop	ecx ; !
  4324 00001FD7 C3                      	retn
  4325                                  
  4326                                  interpolating_4_16bit_mono:
  4327                                  	; 18/11/2023
  4328                                  	; ax = [previous_val]
  4329                                  	; dx = [next_val]
  4330                                  	; original-interpolated
  4331                                  
  4332 00001FD8 66AB                    	stosw		; original sample (L)
  4333 00001FDA 66AB                    	stosw		; original sample (R)
  4334 00001FDC 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4335 00001FDF 89C3                    	mov	ebx, eax ; [previous_val]
  4336 00001FE1 80C680                  	add	dh, 80h
  4337 00001FE4 6601D0                  	add	ax, dx	; [previous_val] + [next_val]
  4338 00001FE7 66D1D8                  	rcr	ax, 1
  4339 00001FEA 93                      	xchg	eax, ebx	
  4340 00001FEB 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  4341 00001FEE 66D1D8                  	rcr	ax, 1
  4342 00001FF1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4343 00001FF4 66AB                    	stosw 		; interpolated sample 1 (L)
  4344 00001FF6 66AB                    	stosw		; interpolated sample 1 (R)
  4345 00001FF8 89D8                    	mov	eax, ebx ; interpolated middle
  4346 00001FFA 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4347 00001FFD 66AB                    	stosw 		; interpolated sample 2 (L)
  4348 00001FFF 66AB                    	stosw		; interpolated sample 2 (R)
  4349 00002001 89D8                    	mov	eax, ebx
  4350 00002003 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4351 00002006 66D1D8                  	rcr	ax, 1
  4352 00002009 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4353 0000200C 66AB                    	stosw		; interpolated sample 3 (L)
  4354 0000200E 66AB                    	stosw		; interpolated sample 3 (R)
  4355 00002010 C3                      	retn
  4356                                  
  4357                                  interpolating_4_16bit_stereo:
  4358                                  	; 18/11/2023
  4359                                  	; bx = [previous_val_l]
  4360                                  	; ax = [previous_val_r]
  4361                                  	; [next_val_l]
  4362                                  	; [next_val_r]
  4363                                  	; original-interpolated-interpolated-interpolated
  4364 00002011 93                      	xchg	eax, ebx
  4365 00002012 66AB                    	stosw		; original sample (L)
  4366 00002014 93                      	xchg	eax, ebx
  4367 00002015 66AB                    	stosw		; original sample (R)
  4368 00002017 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4369 0000201A 89C2                    	mov	edx, eax ; [previous_val_r]
  4370 0000201C 80C780                  	add	bh, 80h
  4371 0000201F 8005[93200000]80        	add	byte [next_val_l+1], 80h
  4372 00002026 66A1[92200000]          	mov	ax, [next_val_l]
  4373 0000202C 6601D8                  	add	ax, bx	; [previous_val_l]
  4374 0000202F 66D1D8                  	rcr	ax, 1
  4375 00002032 93                      	xchg	eax, ebx	
  4376 00002033 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  4377 00002036 66D1D8                  	rcr	ax, 1
  4378 00002039 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4379 0000203C 66AB                    	stosw 		; interpolated sample 1 (L)
  4380 0000203E 8005[95200000]80        	add	byte [next_val_r+1], 80h
  4381 00002045 89D0                    	mov	eax, edx ; [previous_val_r]
  4382 00002047 660305[94200000]        	add	ax, [next_val_r]
  4383 0000204E 66D1D8                  	rcr	ax, 1
  4384 00002051 92                      	xchg	eax, edx	
  4385 00002052 6601D0                  	add	ax, dx	; dx = interpolated middle (R)
  4386 00002055 66D1D8                  	rcr	ax, 1
  4387 00002058 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4388 0000205B 66AB                    	stosw 		; interpolated sample 1 (R)
  4389 0000205D 89D8                    	mov	eax, ebx
  4390 0000205F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4391 00002062 66AB                    	stosw 		; interpolated sample 2 (L)
  4392 00002064 89D0                    	mov	eax, edx
  4393 00002066 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4394 00002069 66AB                    	stosw 		; interpolated sample 2 (R)
  4395 0000206B 89D8                    	mov	eax, ebx
  4396 0000206D 660305[92200000]        	add	ax, [next_val_l]
  4397 00002074 66D1D8                  	rcr	ax, 1
  4398 00002077 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4399 0000207A 66AB                    	stosw 		; interpolated sample 3 (L)
  4400 0000207C 89D0                    	mov	eax, edx
  4401 0000207E 660305[94200000]        	add	ax, [next_val_r]
  4402 00002085 66D1D8                  	rcr	ax, 1
  4403 00002088 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4404 0000208B 66AB                    	stosw 		; interpolated sample 3 (R)
  4405 0000208D C3                      	retn
  4406                                  
  4407                                  ; 13/11/2023
  4408                                  previous_val:
  4409 0000208E 0000                    previous_val_l: dw 0
  4410 00002090 0000                    previous_val_r: dw 0
  4411                                  next_val:
  4412 00002092 0000                    next_val_l: dw 0
  4413 00002094 0000                    next_val_r: dw 0
  4414                                  
  4415                                  ; 16/11/2023
  4416 00002096 00                      faz:	db 0	
  4417                                  	
  4418                                  ;=============================================================================
  4419                                  ;	gfx.asm - draw scopes in VGA 640x480x16 mode      
  4420                                  ;=============================================================================
  4421                                  
  4422                                  ; EX1A.ASM (21/6/1994, Carlos Hasan; MSDOS, 'RUNME.EXE', 'TNYPL211')
  4423                                  
  4424                                  ;-----------------------------------------------------------------------------
  4425                                  ; setgraphmode - setup the VGA 640x480x16 graphics mode
  4426                                  ;-----------------------------------------------------------------------------
  4427                                  	; 22/10/2017
  4428                                  setgraphmode:
  4429                                  	;pushad
  4430 00002097 66B81200                	mov	ax,0012h
  4431                                  	;int	10h
  4432 0000209B CD31                    	int 	31h
  4433 0000209D 66BAC003                	mov	dx,3C0h
  4434 000020A1 30C0                    	xor	al,al
  4435                                  setgraphmodel0:
  4436                                  	;out	dx,al
  4437 000020A3 B401                    	mov	ah, 1 ; outb
  4438 000020A5 CD34                    	int	34h
  4439                                  	;out	dx, al
  4440                                  	;mov	ah, 1
  4441 000020A7 CD34                    	int	34h
  4442 000020A9 FEC0                    	inc	al
  4443 000020AB 3C10                    	cmp	al, 10h
  4444 000020AD 72F4                    	jb	short setgraphmodel0
  4445 000020AF B020                    	mov	al, 20h
  4446                                  	;out	dx, al
  4447                                  	;mov	ah, 1
  4448 000020B1 CD34                    	int	34h
  4449                                  	;popad
  4450 000020B3 C3                      	retn
  4451                                  
  4452                                  ;-----------------------------------------------------------------------------
  4453                                  ; settextmode - restore the VGA 80x25x16 text mode
  4454                                  ;-----------------------------------------------------------------------------
  4455                                  	; 22/10/2017
  4456                                  settextmode:
  4457                                  	;pushad
  4458 000020B4 66B80300                	mov	ax, 0003h
  4459                                  	;int	10h
  4460 000020B8 CD31                    	int	31h
  4461                                  	;popad
  4462 000020BA C3                      	retn
  4463                                  
  4464                                  ;-----------------------------------------------------------------------------
  4465                                  ; drawscopes - draw the track voices sample scopes
  4466                                  ; In:
  4467                                  ;  ESI = (current) sample buffer
  4468                                  ;-----------------------------------------------------------------------------
  4469                                  	; 27/12/2024
  4470                                  	; 29/10/2017
  4471                                  	; 28/10/2017
  4472                                  	; (ESI = Current DMA buffer offset)
  4473                                  	; 27/10/2017
  4474                                  	; 26/10/2017
  4475                                  	; 23/10/2017
  4476                                  drawscopes:
  4477                                  	;pushad
  4478                                    	;mov	esi, g_buff
  4479                                  	;mov	esi, edx
  4480 000020BB 31C9                    	xor     ecx, ecx	
  4481 000020BD 31D2                    	xor     edx, edx
  4482 000020BF 31FF                    	xor	edi, edi
  4483                                  drawscope0:
  4484 000020C1 66AD                    	lodsw
  4485 000020C3 80F480                  	xor	ah, 80h
  4486 000020C6 0FB6DC                  	movzx	ebx, ah  ; Left Channel
  4487                                  	;shl	bx, 1
  4488                                  	; 27/12/2024
  4489 000020C9 D1E3                    	shl	ebx, 1
  4490 000020CB 668B83[90680000]        	mov	ax, [RowOfs+ebx]
  4491 000020D2 668987[906A0000]        	mov	[NewScope_L+edi], ax
  4492 000020D9 30FF                    	xor	bh, bh
  4493 000020DB 66AD                    	lodsw
  4494 000020DD 80F480                  	xor	ah, 80h
  4495 000020E0 88E3                    	mov	bl, ah	; Right Channel
  4496                                  	;shl	bx, 1
  4497                                  	; 27/12/2024
  4498 000020E2 D1E3                    	shl	ebx, 1
  4499 000020E4 668B83[90680000]        	mov	ax, [RowOfs+ebx]
  4500 000020EB 668987[906C0000]        	mov	[NewScope_R+edi], ax
  4501 000020F2 6683C702                	add	di, 2
  4502 000020F6 FEC1                    	inc	cl
  4503 000020F8 75C7                    	jnz	short drawscope0	
  4504                                  
  4505 000020FA 66BAC403                        mov	dx, 3C4h
  4506                                          ;mov	ax, 0802h
  4507                                          ;out	dx, ax
  4508 000020FE 66BB0208                        mov	bx, 0802h
  4509 00002102 B403                    	mov	ah, 3 ; outw
  4510 00002104 CD34                    	int	34h
  4511                                  	;mov	dx, 3CEh
  4512                                  	; 27/12/2024 
  4513 00002106 B2CE                            mov	dl, 0CEh
  4514 00002108 B008                            mov	al, 08h
  4515                                         ;out	dx, al
  4516 0000210A B401                            mov	ah, 1 ; outb
  4517 0000210C CD34                    	int	34h
  4518                                  	;inc	dx
  4519                                  	; 27/12/2024
  4520 0000210E 42                      	inc	edx
  4521                                  
  4522                                  	; 26/10/2017
  4523 0000210F 31F6                            xor	esi, esi
  4524                                         ;xor	edi, edi
  4525 00002111 BB45060A00                      mov     ebx, 0A0645h
  4526                                  drawscopel4:
  4527 00002116 B080                            mov     al, 80h
  4528                                  drawscopel2:
  4529 00002118 50                              push    eax ; *
  4530 00002119 52                              push    edx ; **
  4531                                  	;out	dx, al
  4532 0000211A B401                    	mov	ah, 1 ; outb
  4533 0000211C CD34                    	int	34h
  4534                                  
  4535 0000211E B4FF                            mov	ah, 0FFh
  4536                                          ;mov	ecx, 32
  4537 00002120 B120                    	mov	cl, 32
  4538 00002122 28C0                    	sub     al, al
  4539                                  drawscopel3:
  4540                                  	; 23/10/2017
  4541 00002124 668B96[906E0000]                mov	dx, [OldScope_L+esi]
  4542 0000212B 663B96[906A0000]                cmp	dx, [NewScope_L+esi]
  4543 00002132 7414                            je	short drawscopef3
  4544 00002134 88041A                          mov	[edx+ebx], al ; L
  4545 00002137 668B96[906A0000]                mov     dx, [NewScope_L+esi]
  4546 0000213E 88241A                  	mov	[edx+ebx], ah ; L
  4547 00002141 668996[906E0000]                mov     [OldScope_L+esi], dx
  4548                                  drawscopef3:
  4549                                  	; 27/10/2017
  4550 00002148 668B96[90700000]                mov	dx, [OldScope_R+esi]
  4551 0000214F 663B96[906C0000]                cmp	dx, [NewScope_R+esi]
  4552 00002156 7416                            je	short drawscopef4
  4553 00002158 88441A26                	mov	[edx+ebx+38], al ; R
  4554 0000215C 668B96[906C0000]                mov     dx, [NewScope_R+esi]
  4555 00002163 88641A26                        mov	[edx+ebx+38], ah ; R
  4556 00002167 668996[90700000]                mov     [OldScope_R+esi], dx
  4557                                  drawscopef4:
  4558 0000216E 83C610                  	add	esi, 2*8
  4559 00002171 43                      	inc	ebx
  4560 00002172 E2B0                    	loop    drawscopel3
  4561                                  
  4562 00002174 5A                              pop     edx ; **
  4563 00002175 58                              pop     eax ; *
  4564 00002176 81EEFE010000            	sub	esi, 2*256-2
  4565 0000217C 83EB20                  	sub	ebx, 32
  4566 0000217F D0E8                            shr     al, 1
  4567 00002181 7595                            jnz	short drawscopel2
  4568                                  	;popad
  4569 00002183 C3                              retn
  4570                                  
  4571                                  ;=============================================================================
  4572                                  ;	Load IFF/ILBM files for VGA 640x480x16 graphics mode       
  4573                                  ;=============================================================================
  4574                                  
  4575                                  ; EX1B.ASM (21/6/1994, Carlos Hasan; MSDOS, 'RUNME.EXE', 'TNYPL211')
  4576                                  
  4577                                  ; 21/10/2017 (TRDOS 386, 'tmodplay.s', Erdogan Tan, NASM syntax)
  4578                                  
  4579                                  ;-----------------------------------------------------------------------------
  4580                                  ; EQUATES AND STRUCTURES
  4581                                  ;-----------------------------------------------------------------------------
  4582                                  
  4583                                  ID_FORM equ 4D524F46h		; IFF/ILBM chunk IDs
  4584                                  ID_ILBM equ 4D424C49h
  4585                                  ID_BMHD equ 44484D42h
  4586                                  ID_CMAP equ 50414D43h
  4587                                  ID_BODY equ 59444F42h
  4588                                  
  4589                                  struc Form			; IFF/ILBM header file format
  4590 00000000 ????????                  .ID:		resd 1
  4591 00000004 ????????                  .Length:	resd 1
  4592 00000008 ????????                  .Type:	resd 1
  4593                                    .size:
  4594                                  endstruc
  4595                                  
  4596                                  struc Chunk			; IFF/ILBM header chunk format
  4597 00000000 ????????                  .ID:		resd 1
  4598 00000004 ????????                  .Length:	resd 1
  4599                                    .size:	
  4600                                  endstruc
  4601                                  
  4602                                  struc BMHD			; IFF/ILBM BMHD chunk format
  4603 00000000 ????                      .Width: 	resw 1
  4604 00000002 ????                      .Height:	resw 1
  4605 00000004 ????                      .PosX:	resw 1
  4606 00000006 ????                      .PosY:	resw 1
  4607 00000008 ??                        .Planes:	resb 1
  4608 00000009 ??                        .Masking:	resb 1
  4609 0000000A ??                        .Compression:	resb 1
  4610 0000000B ??                        .Pad:		resb 1
  4611 0000000C ????                      .Transparent:	resw 1
  4612 0000000E ??                        .AspectX	resb 1
  4613 0000000F ??                        .AspectY:	resb 1
  4614 00000010 ????                      .PageWidth:	resw 1
  4615 00000012 ????                      .PageHeight:	resw 1
  4616                                    .size:	
  4617                                  endstruc
  4618                                  
  4619                                  struc CMAP			; IFF/ILBM CMAP chunk format
  4620 00000000 <res 300h>                .Colors:	resb 768
  4621                                    .size:	
  4622                                  endstruc
  4623                                  
  4624                                  ;LOGO_ADDRESS	equ 100000h	; virtual address at the end of the 1st 1MB
  4625                                  
  4626                                  ;------------------------------------------------------------------------------
  4627                                  ; bswap - macro to reverse the byte order of a 32-bit register, converting
  4628                                  ;         a value in little/big endian form to big/little endian form.
  4629                                  ;------------------------------------------------------------------------------
  4630                                  %macro	bswap   1
  4631                                          xchg    al, ah
  4632                                          rol     eax, 16
  4633                                          xchg    al, ah
  4634                                  %endmacro
  4635                                  
  4636                                  ;------------------------------------------------------------------------------
  4637                                  ; putlbm - draw the IFF/ILBM picture on VGA 640x480x16 graphics mode
  4638                                  ; In:
  4639                                  ;  ESI = IFF/ILBM image file address
  4640                                  ;------------------------------------------------------------------------------
  4641                                  putlbm:
  4642 00002184 60                              pushad
  4643                                  
  4644                                  ; check if this is a valid IFF/ILBM Deluxe Paint file
  4645                                  
  4646 00002185 813E464F524D                    cmp     dword [esi+Form.ID], ID_FORM
  4647 0000218B 7551                            jne     short putlbmd0
  4648 0000218D 817E08494C424D                  cmp     dword [esi+Form.Type], ID_ILBM
  4649 00002194 7548                            jne     short putlbmd0
  4650                                  
  4651                                  ; get the IFF/ILBM file length in bytes
  4652                                  
  4653 00002196 8B4604                          mov     eax, [esi+Form.Length]
  4654                                          bswap   eax
  4631 00002199 86E0                <1>  xchg al, ah
  4632 0000219B C1C010              <1>  rol eax, 16
  4633 0000219E 86E0                <1>  xchg al, ah
  4655 000021A0 89C1                            mov     ecx, eax
  4656                                  
  4657                                  ; decrease the file length and updates the file pointer
  4658                                  
  4659 000021A2 83E904                          sub     ecx, 4
  4660 000021A5 83C60C                          add     esi, Form.size
  4661                                  
  4662                                  ; IFF/ILBM main parser body loop
  4663                                  
  4664                                  putlbml0:
  4665 000021A8 85C9                            test    ecx, ecx
  4666 000021AA 7E64                            jle     short putlbmd1
  4667                                  
  4668                                  ; get the next chunk ID and length in bytes
  4669                                  
  4670 000021AC 8B1E                            mov     ebx, [esi+Chunk.ID]
  4671 000021AE 8B4604                          mov     eax, [esi+Chunk.Length]
  4672                                          bswap   eax
  4631 000021B1 86E0                <1>  xchg al, ah
  4632 000021B3 C1C010              <1>  rol eax, 16
  4633 000021B6 86E0                <1>  xchg al, ah
  4673 000021B8 93                              xchg    ebx, eax
  4674 000021B9 83C608                          add     esi, Chunk.size
  4675                                  
  4676                                  ; word align the chunk length and decrease the file length counter
  4677                                  
  4678 000021BC 43                              inc     ebx
  4679 000021BD 80E3FE                          and     bl, 0FEh ; ~1
  4680 000021C0 83E908                          sub     ecx, Chunk.size
  4681 000021C3 29D9                            sub     ecx, ebx
  4682                                  
  4683                                  ; check for the BMHD/CMAP/BODY chunk headers
  4684                                  
  4685 000021C5 3D424D4844                      cmp     eax, ID_BMHD
  4686 000021CA 7415                            je      short putlbmf0
  4687 000021CC 3D434D4150                      cmp     eax, ID_CMAP
  4688 000021D1 7440                            je      short putlbmf1
  4689 000021D3 3D424F4459                      cmp     eax, ID_BODY
  4690 000021D8 7454                            je      short putlbmf2
  4691                                  
  4692                                  ; advance to the next IFF/ILBM chunk structure
  4693                                  
  4694                                  putlbmc0:
  4695 000021DA 01DE                            add     esi, ebx
  4696 000021DC EBCA                            jmp     short putlbml0
  4697                                  
  4698                                  putlbmd0:
  4699 000021DE F9                              stc
  4700 000021DF 61                              popad
  4701 000021E0 C3                              retn
  4702                                  
  4703                                  ; process the BMHD bitmap header chunk
  4704                                  
  4705                                  putlbmf0:
  4706 000021E1 807E0804                        cmp     byte [esi+BMHD.Planes], 4
  4707 000021E5 75F7                            jne     short putlbmd0
  4708 000021E7 807E0A01                        cmp     byte [esi+BMHD.Compression], 1
  4709 000021EB 75F1                            jne     short putlbmd0
  4710 000021ED 807E0B00                        cmp     byte [esi+BMHD.Pad], 0
  4711 000021F1 75EB                            jne     short putlbmd0
  4712 000021F3 0FB706                          movzx   eax, word [esi+BMHD.Width]
  4713 000021F6 86E0                            xchg    al, ah
  4714 000021F8 83C007                          add     eax, 7
  4715 000021FB C1E803                          shr     eax, 3
  4716 000021FE A3[F4670000]                    mov     [picture.width], eax
  4717 00002203 0FB74602                        movzx   eax, word [esi+BMHD.Height]
  4718 00002207 86E0                            xchg    al, ah
  4719 00002209 A3[F8670000]                    mov     [picture.height], eax
  4720 0000220E EBCA                            jmp     short putlbmc0
  4721                                  
  4722                                  putlbmd1:
  4723 00002210 F8                              clc
  4724 00002211 61                              popad
  4725 00002212 C3                              retn
  4726                                  
  4727                                  ; process the CMAP colormap chunk
  4728                                  
  4729                                  putlbmf1:
  4730 00002213 66BAC803                        mov     dx, 3C8h
  4731 00002217 30C0                            xor     al, al
  4732                                          ;out	dx, al
  4733 00002219 B401                    	mov	ah, 1 ; outb
  4734 0000221B CD34                    	int	34h
  4735                                          ;inc	dx
  4736                                  	; 27/11/2023
  4737 0000221D 42                      	inc	edx
  4738                                  putlbml1:
  4739 0000221E 8A06                            mov     al, [esi]
  4740 00002220 C0E802                          shr     al, 2
  4741                                          ;out	dx, al
  4742                                  	;mov	ah, 1 ; outb
  4743 00002223 CD34                    	int	34h ; IOCTL interrupt (IN/OUT)
  4744 00002225 46                              inc     esi
  4745 00002226 4B                              dec     ebx
  4746 00002227 7FF5                            jg      short putlbml1
  4747 00002229 E97AFFFFFF                      jmp     putlbml0
  4748                                  
  4749                                  ; process the BODY bitmap body chunk
  4750                                  
  4751                                  putlbmf2:
  4752 0000222E 60                              pushad
  4753 0000222F BF00000A00                      mov     edi, 0A0000h
  4754                                          ;cld
  4755 00002234 66BACE03                        mov     dx, 3CEh
  4756                                          ;mov	ax, 0FF08h
  4757                                          ;out	dx, ax
  4758 00002238 66BB08FF                	mov	bx, 0FF08h
  4759 0000223C B403                    	mov	ah, 3 ; outw
  4760 0000223E CD34                    	int	34h ; IOCTL interrupt (IN/OUT)
  4761                                  	;mov	dx, 3C4h
  4762                                  	; 27/11/2023
  4763 00002240 B2C4                    	mov	dl, 0C4h
  4764 00002242 B002                            mov     al, 02h
  4765                                          ;out	dx, al
  4766 00002244 B401                    	mov	ah, 1 ; outb
  4767 00002246 CD34                    	int	34h ; IOCTL interrupt (IN/OUT)
  4768                                  	;inc	dx
  4769                                  	; 27/11/2023
  4770 00002248 42                      	inc	edx
  4771 00002249 8B0D[F8670000]                  mov     ecx, [picture.height]
  4772                                  putlbml2:
  4773 0000224F 51                              push    ecx
  4774 00002250 B011                            mov     al, 11h
  4775                                  putlbml3:
  4776 00002252 50                              push    eax
  4777 00002253 57                              push    edi
  4778                                          ;out	dx, al
  4779 00002254 B401                    	mov	ah, 1 ; outb
  4780 00002256 CD34                    	int	34h ; IOCTL interrupt (IN/OUT)
  4781 00002258 8B1D[F4670000]                  mov     ebx, [picture.width]
  4782                                  putlbml4:
  4783 0000225E AC                              lodsb
  4784 0000225F 84C0                            test    al, al
  4785 00002261 7C0A                            jl      short putlbmf3
  4786 00002263 0FB6C8                          movzx   ecx, al
  4787 00002266 41                              inc     ecx
  4788 00002267 29CB                            sub     ebx, ecx
  4789 00002269 F3A4                            rep     movsb
  4790 0000226B EB0B                            jmp     short putlbmc4
  4791                                  putlbmf3:
  4792 0000226D F6D8                            neg     al
  4793 0000226F 0FB6C8                          movzx   ecx, al
  4794 00002272 41                              inc     ecx
  4795 00002273 29CB                            sub     ebx, ecx
  4796 00002275 AC                              lodsb
  4797 00002276 F3AA                            rep     stosb
  4798                                  putlbmc4:
  4799 00002278 85DB                            test    ebx, ebx
  4800 0000227A 7FE2                            jg      short putlbml4
  4801 0000227C 5F                              pop     edi
  4802 0000227D 58                              pop     eax
  4803 0000227E 00C0                            add     al, al
  4804 00002280 73D0                            jnc     short putlbml3
  4805 00002282 83C750                          add     edi, 80
  4806 00002285 59                              pop     ecx
  4807 00002286 E2C7                            loop    putlbml2
  4808 00002288 61                      	popad
  4809 00002289 E94CFFFFFF                      jmp	putlbmc0
  4810                                  
  4811                                  ; EX1.C (Carlos Hasan, 21/06/1994)
  4812                                  ;------------------------------------------------------------------------------
  4813                                  ; loadlbm - load the IFF/ILBM image file ("LOGO.LBM") at memory
  4814                                  ;  ESI = IFF/ILBM image file address
  4815                                  ;------------------------------------------------------------------------------
  4816                                  
  4817                                  ;if ((Logo = loadlbm("LOGO.LBM")) == NULL) {
  4818                                  ;       printf("Error loading the IFF/ILBM logo picture\n");
  4819                                  ;       MODStopModule();
  4820                                  ;       MODFreeModule(Song);
  4821                                  ;       return;
  4822                                  ;   }
  4823                                  ;   setgraphmode();
  4824                                  ;   putlbm(Logo);
  4825                                  ;   while (!kbhit())
  4826                                  ;       drawscopes(Song->NumTracks);
  4827                                  ;   settextmode();
  4828                                  ;   free(Logo);
  4829                                  ;   MODStopModule();
  4830                                  ;   MODFreeModule(Song);
  4831                                  
  4832                                  ;loadlbm:
  4833                                  ;	; ebx = ASCIIZ file name address
  4834                                  ;	; ecx = open mode (0 = open for read)	
  4835                                  ;	sys	_open, LOGO_FILE_NAME, 0 ; open for reading
  4836                                  ;	jc	short loadlbm_retn
  4837                                  ;
  4838                                  ;	mov     [LBM_FileHandle], eax
  4839                                  ;
  4840                                  ;	; get file size by moving file pointer to the end of file
  4841                                  ;	; ebx = file handle/number
  4842                                  ;	; ecx : offset = 0
  4843                                  ;	; edx : switch = 2 (move fp to end of file + offset)
  4844                                  ;	sys	_seek, eax, 0, 2
  4845                                  ;	jc	short loadlbm_cf
  4846                                  ;
  4847                                  ;	mov	[LBM_FileSize], eax
  4848                                  ;
  4849                                  ;	; move file pointer to the beginning of the file
  4850                                  ;	; ecx = 0
  4851                                  ;	; edx = 0
  4852                                  ;	;xor	ecx, ecx
  4853                                  ; 	xor	dl, dl
  4854                                  ;	; ebx = [LBM_FileHandle]
  4855                                  ;	sys	_seek
  4856                                  ;	;jc	short loadlbm_cf
  4857                                  ;
  4858                                  ;	; ebx = File handle
  4859                                  ;	; ecx = Buffer address
  4860                                  ;	; edx = Byte count
  4861                                  ;	;sys	_read, [LBM_FileHandle], LOGO_ADDRESS, [LBM_FileSize]
  4862                                  ;	mov	ecx, LOGO_ADDRESS
  4863                                  ;	mov	edx, [LBM_FileSize]
  4864                                  ;	sys	_read
  4865                                  ;	jc	short loadlbm_cf
  4866                                  ;
  4867                                  ;	cmp	eax, edx  ; read count = file size ?
  4868                                  ;	;jb	short loadlbm_cf		 
  4869                                  ;loadlbm_cf:
  4870                                  ;	pushf
  4871                                  ;	sys	_close, [LBM_FileHandle]	
  4872                                  ;	popf
  4873                                  ;loadlbm_retn:
  4874                                  ;	retn	
  4875                                  ;
  4876                                  ;LOGO_FILE_NAME:
  4877                                  ;	db	"LOGO.LBM", 0
  4878                                  
  4879                                  LOGO_ERROR_MSG:
  4880 0000228E 4572726F72206C6F61-     	db	"Error loading the IFF/ILBM logo picture !", 0Dh, 0Ah, 0 
  4880 00002297 64696E672074686520-
  4880 000022A0 4946462F494C424D20-
  4880 000022A9 6C6F676F2070696374-
  4880 000022B2 75726520210D0A00   
  4881                                  
  4882                                  align 2
  4883                                  ; 22/10/2017
  4884                                  LOGO_ADDRESS:
  4885                                  ;incbin "LOGO.LBM"	  	 
  4886                                  ; 27/10/2017
  4887 000022BA <bin 4298h>             incbin "TINYPLAY.LBM"
  4888                                  
  4889                                  ;=============================================================================
  4890                                  ;               preinitialized data
  4891                                  ;=============================================================================
  4892                                  	
  4893 00006552 00                      	db	0
  4894                                  	; 23/08/2020
  4895                                  FileHandle:	
  4896 00006553 FFFFFFFF                	dd	-1
  4897 00006557 00                      	db	0
  4898                                  Credits:
  4899                                  msg_usage:
  4900                                  	; 09/12/2023
  4901 00006558 54696E792057415620-     	db	'Tiny WAV Player for TRDOS 386 by Erdogan Tan',10,13
  4901 00006561 506C6179657220666F-
  4901 0000656A 72205452444F532033-
  4901 00006573 383620627920457264-
  4901 0000657C 6F67616E2054616E0A-
  4901 00006585 0D                 
  4902 00006586 666F7220496E74656C-     	db 	'for Intel AC97 (ICH) Audio Controller.',10,13
  4902 0000658F 204143393720284943-
  4902 00006598 482920417564696F20-
  4902 000065A1 436F6E74726F6C6C65-
  4902 000065AA 722E0A0D           
  4903                                  	;;db	'December 2023.',10,13
  4904                                  	;db	'December 2024.',10,13
  4905 000065AE 4A616E756172792032-     	db	'January 2025.',10,13
  4905 000065B7 3032352E0A0D       
  4906                                  credits_zero:
  4907 000065BD 0A0D                    	db	10,13
  4908 000065BF 75736167653A207477-     	db	'usage: twavplay filename.wav',10,13,0
  4908 000065C8 6176706C6179206669-
  4908 000065D1 6C656E616D652E7761-
  4908 000065DA 760A0D00           
  4909 000065DE 32342F30382F323032-     	db	'24/08/2020',10,13,0
  4909 000065E7 300A0D00           
  4910 000065EB 30392F31322F323032-     	db	'09/12/2023',10,13,0
  4910 000065F4 330A0D00           
  4911                                  	;;;db	'08/12/2024',10,13,0
  4912                                  	;;db	'14/12/2024',10,13,0
  4913 000065F8 32372F31322F323032-     	db	'27/12/2024',10,13,0
  4913 00006601 340A0D00           
  4914 00006605 31382F30312F323032-     	db	'18/01/2025',10,13,0
  4914 0000660E 350A0D00           
  4915                                  
  4916                                  noDevMsg:
  4917                                  	; 09/12/2023
  4918 00006612 4572726F723A20556E-     	db	'Error: Unable to find AC97 audio device!'
  4918 0000661B 61626C6520746F2066-
  4918 00006624 696E64204143393720-
  4918 0000662D 617564696F20646576-
  4918 00006636 69636521           
  4919 0000663A 0A0D00                  	db	10,13,0
  4920                                  
  4921                                  noFileErrMsg:
  4922 0000663D 4572726F723A206669-     	db	'Error: file not found.',10,13,0
  4922 00006646 6C65206E6F7420666F-
  4922 0000664F 756E642E0A0D00     
  4923                                  
  4924                                  trdos386_err_msg:
  4925 00006656 5452444F5320333836-     	db	'TRDOS 386 System call error !',10,13,0
  4925 0000665F 2053797374656D2063-
  4925 00006668 616C6C206572726F72-
  4925 00006671 20210A0D00         
  4926                                  
  4927                                  ; 09/12/2023
  4928                                  msg_no_vra:
  4929 00006676 0A0D                    	db	10,13
  4930 00006678 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  4930 00006681 70706F72742021204F-
  4930 0000668A 6E6C79203438206B48-
  4930 00006693 5A2073616D706C6520-
  4930 0000669C 726174652073757070-
  4930 000066A5 6F727465642021     
  4931 000066AC 0A0D00                  	db	10,13,0
  4932                                  
  4933                                  ; 13/11/2016
  4934 000066AF 303132333435363738-     hex_chars:	db "0123456789ABCDEF", 0
  4934 000066B8 3941424344454600   
  4935                                  ;
  4936                                  msgAC97Info:	
  4937 000066C0 0D0A                    		db 0Dh, 0Ah
  4938 000066C2 414339372041756469-     		db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  4938 000066CB 6F20436F6E74726F6C-
  4938 000066D4 6C6572202620436F64-
  4938 000066DD 656320496E666F0D0A 
  4939 000066E6 56656E646F72204944-     		db "Vendor ID: "
  4939 000066EF 3A20               
  4940 000066F1 303030306820446576-     msgVendorId:	db "0000h Device ID: "
  4940 000066FA 6963652049443A20   
  4941 00006702 30303030680D0A          msgDevId:	db "0000h", 0Dh, 0Ah
  4942 00006709 4275733A20              		db "Bus: "
  4943 0000670E 303068204465766963-     msgBusNo	db "00h Device: "
  4943 00006717 653A20             
  4944 0000671A 3030682046756E6374-     msgDevNo	db "00h Function: "
  4944 00006723 696F6E3A20         
  4945 00006728 303068                  msgFncNo	db "00h"
  4946 0000672B 0D0A                    		db 0Dh, 0Ah
  4947                                  ; 09/12/2023
  4948 0000672D 4E414D4241523A20        		db "NAMBAR: "
  4949 00006735 30303030682020          msgNamBar	db "0000h  "
  4950 0000673C 4E41424D4241523A20      		db "NABMBAR: "
  4951 00006745 303030306820204952-     msgNabmBar	db "0000h  IRQ: "
  4951 0000674E 513A20             
  4952 00006751 3030                    msgIRQ		dw 3030h
  4953 00006753 0D0A00                  		db 0Dh, 0Ah, 0
  4954                                  
  4955 00006756 0D0A5741562046696C-     msgWavFileName:	db 0Dh, 0Ah, "WAV File Name: ",0
  4955 0000675F 65204E616D653A2000 
  4956 00006768 0D0A53616D706C6520-     msgSampleRate:	db 0Dh, 0Ah, "Sample Rate: "
  4956 00006771 526174653A20       
  4957 00006777 303030303020487A2C-     msgHertz:	db "00000 Hz, ", 0 
  4957 00006780 2000               
  4958 00006782 3820626974732C2000      msg8Bits:	db "8 bits, ", 0 
  4959 0000678B 4D6F6E6F0D0A00          msgMono:	db "Mono", 0Dh, 0Ah, 0
  4960 00006792 313620626974732C20-     msg16Bits:	db "16 bits, ", 0 
  4960 0000679B 00                 
  4961 0000679C 53746572656F            msgStereo:	db "Stereo"
  4962 000067A2 0D0A00                  nextline:	db 0Dh, 0Ah, 0
  4963                                  
  4964                                  ; 09/12/2023
  4965 000067A5 56524120737570706F-     msgVRAheader:	db "VRA support: "
  4965 000067AE 72743A20           
  4966 000067B2 00                      		db 0	
  4967 000067B3 5945530D0A00            msgVRAyes:	db "YES", 0Dh, 0Ah, 0
  4968 000067B9 4E4F200D0A              msgVRAno:	db "NO ", 0Dh, 0Ah
  4969 000067BE 28496E746572706F6C-     		db "(Interpolated sample rate playing method)"
  4969 000067C7 617465642073616D70-
  4969 000067D0 6C6520726174652070-
  4969 000067D9 6C6179696E67206D65-
  4969 000067E2 74686F6429         
  4970 000067E7 0D0A00                  		db 0Dh, 0Ah, 0
  4971                                  
  4972                                  ;=============================================================================
  4973                                  ;		uninitialized data
  4974                                  ;=============================================================================
  4975                                  
  4976                                  ; 23/08/2020
  4977                                  
  4978                                  ; BSS
  4979                                  
  4980                                  bss_start:
  4981                                  
  4982                                  ABSOLUTE bss_start
  4983                                  
  4984 000067EA ????                    alignb 4
  4985                                  
  4986                                  ;------------------------------------------------------------------------------
  4987                                  ; IFF/ILBM DATA
  4988                                  ;------------------------------------------------------------------------------
  4989                                  
  4990 000067EC ????????                LBM_FileHandle:	resd 1
  4991 000067F0 ????????                LBM_FileSize:	resd 1
  4992                                  ;
  4993 000067F4 ????????                picture.width:	resd 1 		; current picture width and height
  4994 000067F8 ????????                picture.height:	resd 1
  4995                                  
  4996                                  ;------------------------------------------------------------------------------
  4997                                  
  4998                                  ;alignb 4
  4999                                  
  5000 000067FC ??                      stmo:		resb 1 ; stereo or mono (1=stereo) 
  5001 000067FD ??                      bps:		resb 1 ; bits per sample (8,16)
  5002 000067FE ????                    sample_rate:	resw 1 ; Sample Frequency (Hz)
  5003                                  
  5004                                  ; 09/12/2023
  5005                                  ; 'playwav6.s' (27/11/2023)
  5006                                  ; .......
  5007                                  ; 25/11/2023
  5008 00006800 ????????                bufferSize:	resd 1
  5009                                  
  5010 00006804 <res 1Ch>               smpRBuff:	resw 14 
  5011                                  
  5012                                  wav_file_name:
  5013 00006820 <res 50h>               		resb 80 ; wave file, path name (<= 80 bytes)
  5014                                  ;alignb 4
  5015 00006870 ????                    		resw 1
  5016                                  
  5017 00006872 ??                      ac97_int_ln_reg: resb 1
  5018 00006873 ??                      fbs_shift:	resb 1 ; 26/11/2023
  5019                                  
  5020 00006874 ????????                dev_vendor:	resd 1
  5021 00006878 ????????                bus_dev_fn:	resd 1
  5022 0000687C ????                    ac97_NamBar:	resw 1
  5023 0000687E ????                    ac97_NabmBar:	resw 1
  5024                                  
  5025 00006880 ??                      flags:		resb 1
  5026                                  ;half_buff:	resb 1
  5027 00006881 ??                      srb:		resb 1
  5028                                  ; 27/12/2024
  5029                                  ; 23/08/2020
  5030                                  ;counter:	resb 1
  5031                                  ; 18/08/2020
  5032 00006882 ??                      volume_level:	resb 1
  5033                                  ; 25/11/2023
  5034 00006883 ??                      VRA:		resb 1	; Variable Rate Audio Support Status
  5035                                  ; 09/12/2023
  5036 00006884 ??                      pan_shift:	resb 1
  5037                                  ; .......
  5038                                  
  5039 00006885 <res Bh>                alignb 16
  5040                                  
  5041                                  ; PLAY.ASM
  5042                                  ;Scope:		resw 320
  5043 00006890 <res 200h>              RowOfs:		resw 256
  5044                                  
  5045                                  ; 23/10/2017
  5046 00006A90 <res 200h>              NewScope_L:	resw 256
  5047 00006C90 <res 200h>              NewScope_R:	resw 256
  5048 00006E90 <res 200h>              OldScope_L:	resw 256
  5049 00007090 <res 200h>              OldScope_R:	resw 256
  5050                                  
  5051                                  ; 20/10/2017 (modplay7.s, SB16)
  5052                                  ; 19/10/2017 (modplay6.s, AC97)
  5053                                  ;pan_shift:	resb 1
  5054                                  ;volume_level:	resb 1
  5055                                  
  5056                                  ; 27/12/2024
  5057 00007290 ????????                timerticks:	resd 1
  5058                                  
  5059                                  ; 09/12/2023
  5060 00007294 ????????                DMA_buffer_size: resd 1	
  5061                                  
  5062 00007298 <res D68h>              alignb 4096
  5063                                  
  5064                                  ;audio_buffer:	resb BUFFERSIZE ; DMA Buffer Size / 2  (32768)
  5065                                  ; 09/12/2023
  5066 00008000 <res 10000h>            audio_buffer:	resb 65536
  5067                                  
  5068 00018000 <res 8000h>             alignb 65536
  5069                                  
  5070                                  ;DMA_Buffer:	resb 2*BUFFERSIZE  ; 65536 ; 09/10/2017
  5071                                  ; 09/12/2023
  5072 00020000 <res 20000h>            DMA_Buffer:	resb 2*65536
  5073                                   
  5074                                  ; 13/06/2017
  5075                                  ;temp_buffer:	resb BUFFERSIZE
  5076                                  ; 26/11/2023
  5077 00040000 <res 10000h>            temp_buffer:	resb 65536
  5078                                  
  5079                                  EOF:
