     1                                  ; ****************************************************************************
     2                                  ; playwav8.s (for TRDOS 386)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYWAV8.PRG ! AC'97 (ICH) .WAV PLAYER program by Erdogan TAN
     5                                  ;
     6                                  ; 25/11/2023
     7                                  ;
     8                                  ; [ Last Modification: 17/01/2025 ]
     9                                  ;
    10                                  ; Modified from PLAYWAV5.PRG .wav player program by Erdogan Tan, 18/08/2020
    11                                  ;
    12                                  ; Assembler: NASM version 2.15
    13                                  ;	     nasm playwav8.s -l playwav8.txt -o PLAYWAV8.PRG	
    14                                  ; ----------------------------------------------------------------------------
    15                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002
    16                                  
    17                                  ; playwav6.s (04/06/2024)
    18                                  ; playwav3.s (17/06/2017)
    19                                  
    20                                  ; 04/06/2024 (non-VRA simuation)
    21                                  ; Interpolated sampling rate version (48 kHz - VRA disabled) - playwav8.s-
    22                                  
    23                                  ; CODE
    24                                  
    25                                  ; 14/07/2020
    26                                  ; 31/12/2017
    27                                  ; TRDOS 386 (v2.0) system calls
    28                                  _ver 	equ 0
    29                                  _exit 	equ 1
    30                                  _fork 	equ 2
    31                                  _read 	equ 3
    32                                  _write	equ 4
    33                                  _open	equ 5
    34                                  _close 	equ 6
    35                                  _wait 	equ 7
    36                                  _create	equ 8
    37                                  _rename	equ 9
    38                                  _delete	equ 10
    39                                  _exec	equ 11
    40                                  _chdir	equ 12
    41                                  _time 	equ 13
    42                                  _mkdir 	equ 14
    43                                  _chmod	equ 15
    44                                  _rmdir	equ 16
    45                                  _break	equ 17
    46                                  _drive	equ 18
    47                                  _seek	equ 19
    48                                  _tell 	equ 20
    49                                  _memory	equ 21
    50                                  _prompt	equ 22
    51                                  _path	equ 23
    52                                  _env	equ 24
    53                                  _stime	equ 25
    54                                  _quit	equ 26
    55                                  _intr	equ 27
    56                                  _dir	equ 28
    57                                  _emt 	equ 29
    58                                  _ldrvt 	equ 30
    59                                  _video 	equ 31
    60                                  _audio	equ 32
    61                                  _timer	equ 33
    62                                  _sleep	equ 34
    63                                  _msg    equ 35
    64                                  _geterr	equ 36
    65                                  _fpstat	equ 37
    66                                  _pri	equ 38
    67                                  _rele	equ 39
    68                                  _fff	equ 40
    69                                  _fnf	equ 41
    70                                  _alloc	equ 42
    71                                  _dalloc equ 43
    72                                  _calbac equ 44
    73                                  _dma	equ 45
    74                                  
    75                                  %macro sys 1-4
    76                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)	
    77                                      ; 03/09/2015	
    78                                      ; 13/04/2015
    79                                      ; Retro UNIX 386 v1 system call.	
    80                                      %if %0 >= 2   
    81                                          mov ebx, %2
    82                                          %if %0 >= 3    
    83                                              mov ecx, %3
    84                                              %if %0 = 4
    85                                                 mov edx, %4   
    86                                              %endif
    87                                          %endif
    88                                      %endif
    89                                      mov eax, %1
    90                                      ;int 30h
    91                                      int 40h ; TRDOS 386 (TRDOS v2.0)	   
    92                                  %endmacro
    93                                  
    94                                  ; TRDOS 386 (and Retro UNIX 386 v1) system call format:
    95                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
    96                                  
    97                                  BUFFERSIZE	equ	32768	; audio buffer size 
    98                                  ENDOFFILE       equ     1	; flag for knowing end of file
    99                                  
   100                                  [BITS 32]
   101                                  
   102                                  [ORG 0] 
   103                                  
   104                                  _STARTUP:
   105                                  	; Prints the Credits Text.
   106                                  	sys	_msg, Credits, 255, 0Bh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000000 BB[FE1F0000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000005 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000000A BA0B000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000000F B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000014 CD40                <1>  int 40h
   107                                  
   108                                  	; clear bss
   109 00000016 B9[6D230000]            	mov	ecx, bss_end
   110 0000001B BF[E2220000]            	mov	edi, bss_start
   111 00000020 29F9                    	sub	ecx, edi
   112 00000022 D1E9                    	shr	ecx, 1
   113 00000024 31C0                    	xor	eax, eax
   114 00000026 F366AB                  	rep	stosw
   115                                  
   116                                  	; Detect (& Enable) AC'97 Audio Device
   117 00000029 E87D040000              	call	DetectAC97
   118 0000002E 731B                    	jnc     short GetFileName
   119                                  
   120                                  _dev_not_ready:
   121                                  ; couldn't find the audio device!
   122                                  	sys	_msg, noDevMsg, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000030 BB[DF200000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000035 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000003A BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000003F B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000044 CD40                <1>  int 40h
   123 00000046 E93A040000                      jmp     Exit
   124                                  
   125                                  GetFileName:  
   126 0000004B 89E6                    	mov	esi, esp
   127 0000004D AD                      	lodsd
   128 0000004E 83F802                  	cmp	eax, 2 ; two arguments 
   129                                  	       ; (program file name & mod file name)
   130 00000051 0F823C040000            	jb	pmsg_usage ; nothing to do
   131                                  
   132 00000057 AD                      	lodsd ; program file name address 
   133 00000058 AD                      	lodsd ; mod file name address (file to be read)
   134 00000059 89C6                    	mov	esi, eax
   135 0000005B BF[0D230000]            	mov	edi, wav_file_name
   136                                  ScanName:       
   137 00000060 AC                      	lodsb
   138 00000061 84C0                    	test	al, al
   139 00000063 0F842A040000            	je	pmsg_usage
   140 00000069 3C20                    	cmp	al, 20h
   141 0000006B 74F3                    	je	short ScanName	; scan start of name.
   142 0000006D AA                      	stosb
   143 0000006E B4FF                    	mov	ah, 0FFh
   144                                  a_0:	
   145 00000070 FEC4                    	inc	ah
   146                                  a_1:
   147 00000072 AC                      	lodsb
   148 00000073 AA                      	stosb
   149 00000074 3C2E                    	cmp	al, '.'
   150 00000076 74F8                    	je	short a_0	
   151 00000078 20C0                    	and	al, al
   152 0000007A 75F6                    	jnz	short a_1
   153                                  
   154 0000007C 08E4                    	or	ah, ah		; if period NOT found,
   155 0000007E 750B                    	jnz	short _1 	; then add a .WAV extension.
   156                                  SetExt:
   157 00000080 4F                      	dec	edi
   158 00000081 C7072E574156            	mov	dword [edi], '.WAV'
   159 00000087 C6470400                	mov	byte [edi+4], 0
   160                                  
   161                                  _1:
   162                                  
   163                                  ; 26/11/2023
   164                                  %if 0
   165                                  	; Allocate Audio Buffer (for user)
   166                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   167                                  	; 26/11/2023
   168                                  	sys	_audio, 0200h, [buffersize], audio_buffer
   169                                  	jnc	short _2
   170                                  error_exit:
   171                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
   172                                  	jmp	Exit
   173                                  _2:
   174                                  	; DIRECT CGA (TEXT MODE) MEMORY ACCESS
   175                                  	; bl = 0, bh = 4
   176                                  	; Direct access/map to CGA (Text) memory (0B8000h)
   177                                  
   178                                  	sys	_video, 0400h
   179                                  	cmp	eax, 0B8000h
   180                                  	jne	short error_exit
   181                                  
   182                                  	; Initialize Audio Device (bh = 3)
   183                                  	sys	_audio, 0301h, 0, audio_int_handler 
   184                                  ;	jc	short error_exit
   185                                  _3:
   186                                  
   187                                  %endif
   188 0000008B E864060000              	call	write_audio_dev_info 
   189                                  
   190                                  ; open the file
   191                                          ; open existing file
   192 00000090 E823040000                      call    openFile ; no error? ok.
   193 00000095 731B                            jnc     short _gsr
   194                                  
   195                                  ; file not found!
   196                                  	sys	_msg, noFileErrMsg, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000097 BB[0A210000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000009C B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000000A1 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000A6 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000000AB CD40                <1>  int 40h
   197                                  _exit_:
   198 000000AD E9D3030000                      jmp     Exit
   199                                  
   200                                  _gsr:  
   201 000000B2 E83B040000                     	call    getSampleRate		; read the sample rate
   202                                                                          ; pass it onto codec.
   203                                  	;jc	Exit
   204                                  	; 25/11/2023
   205 000000B7 72F4                    	jc	short _exit_
   206                                  
   207 000000B9 66A3[E6220000]          	mov	[sample_rate], ax
   208 000000BF 880D[E4220000]          	mov	[stmo], cl
   209 000000C5 8815[E5220000]          	mov	[bps], dl
   210                                  
   211                                  	; 26/11/2023
   212 000000CB C605[60230000]00        	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   213 000000D2 FEC9                    	dec	cl
   214 000000D4 7506                    	jnz	short _gsr_1 ; stereo
   215 000000D6 FE05[60230000]          	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   216                                  _gsr_1:	
   217 000000DC 80FA08                  	cmp	dl, 8 
   218 000000DF 7706                    	ja	short _gsr_2 ; 16 bit samples
   219 000000E1 FE05[60230000]          	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   220                                  _gsr_2:	
   221                                  	; 06/06/2017
   222                                  	sys	_audio, 0E00h ; get audio controller info
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000000E7 BB000E0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000EC B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000000F1 CD40                <1>  int 40h
   223 000000F3 0F82E0020000            	jc	error_exit ; 25/11/2023
   224                                  
   225                                  	;cmp	ah, 2 ; ICH ? (Intel AC'97 Audio Controller)
   226                                  	;jne	_dev_not_ready	
   227                                  
   228                                  	; EAX = IRQ Number in AL
   229                                  	;	Audio Device Number in AH 
   230                                  	; EBX = DEV/VENDOR ID
   231                                  	;       (DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV)
   232                                  	; ECX = BUS/DEV/FN 
   233                                  	;       (00000000BBBBBBBBDDDDDFFF00000000)
   234                                  	; EDX = NABMBAR/NAMBAR (for AC97)
   235                                  	;      (Low word, DX = NAMBAR address)
   236                                  	; EDX = Base IO Addr (DX) for SB16 & VT8233
   237                                  
   238 000000F9 A2[5F230000]            	mov	[ac97_int_ln_reg], al
   239 000000FE 891D[61230000]          	mov	[dev_vendor], ebx
   240 00000104 890D[65230000]          	mov	[bus_dev_fn], ecx
   241                                  	;mov	[ac97_NamBar], dx
   242                                  	;shr	dx, 16
   243                                  	;mov	[ac97_NabmBar], dx
   244 0000010A 8915[69230000]          	mov	[ac97_NamBar], edx	
   245                                    
   246                                  	; 01/06/2024
   247                                  	; Reset Audio Device (bh = 8)
   248                                  	sys	_audio, 0800h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000110 BB00080000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000115 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000011A CD40                <1>  int 40h
   249                                  	;jc	error_exit	
   250 0000011C 7216                    	jc	short init_err
   251                                  
   252 0000011E E8B3060000              	call	write_ac97_pci_dev_info
   253                                  
   254                                  ; 04/06/2024
   255                                  %if 0
   256                                  	; 01/06/2024
   257                                  	; 25/11/2023
   258                                  	; Get AC'97 Codec info
   259                                  	; (Function 14, sub function 1)
   260                                  	sys	_audio, 0E01h
   261                                  	; Save Variable Rate Audio support bit
   262                                  	and	al, 1
   263                                  	mov	[VRA], al
   264                                  %endif
   265                                  
   266                                  	; 25/11/2023
   267 00000123 E875080000              	call	write_VRA_info
   268                                  
   269                                  	; 01/05/2017
   270 00000128 E8DE050000              	call	write_wav_file_info
   271                                  
   272                                  	; 25/11/2023
   273                                  	; ------------------------------------------
   274                                  
   275                                  ; 04/06/2024
   276                                  %if 0
   277                                  	cmp	byte [VRA], 1
   278                                  	jb	short chk_sample_rate
   279                                  %else
   280                                  	; 04/06/2024
   281                                  	; (non-VRA simulation)
   282 0000012D EB20                    	jmp	short chk_sample_rate
   283                                  %endif
   284                                  
   285                                  playwav_48_khz:	
   286                                  	;mov	dword [loadfromwavfile], loadFromFile
   287                                  	;mov	dword [buffersize], 65536
   288 0000012F E98C020000              	jmp	PlayNow
   289                                  
   290                                  	; 01/06/2024
   291                                  init_err:
   292                                  	sys	_msg, msg_init_err, 255, 0Eh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000134 BB[43210000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000139 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000013E BA0E000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000143 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000148 CD40                <1>  int 40h
   293 0000014A E936030000              	jmp	Exit
   294                                  
   295                                  chk_sample_rate:
   296                                  	; set conversion parameters
   297                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   298 0000014F 66A1[E6220000]          	mov	ax, [sample_rate]
   299 00000155 663D80BB                	cmp	ax, 48000
   300 00000159 74D4                    	je	short playwav_48_khz
   301                                  chk_22khz:
   302 0000015B 663D2256                	cmp	ax, 22050
   303 0000015F 7545                    	jne	short chk_11khz
   304 00000161 803D[E5220000]08        	cmp	byte [bps], 8
   305 00000168 7615                    	jna	short chk_22khz_1
   306 0000016A BB[0B160000]            	mov	ebx, load_22khz_stereo_16_bit
   307 0000016F 803D[E4220000]01        	cmp	byte [stmo], 1 
   308 00000176 751A                    	jne	short chk_22khz_2
   309 00000178 BB[7E150000]            	mov	ebx, load_22khz_mono_16_bit
   310 0000017D EB13                    	jmp	short chk_22khz_2
   311                                  chk_22khz_1:
   312 0000017F BB[F7140000]            	mov	ebx, load_22khz_stereo_8_bit
   313 00000184 803D[E4220000]01        	cmp	byte [stmo], 1 
   314 0000018B 7505                    	jne	short chk_22khz_2
   315 0000018D BB[6E140000]            	mov	ebx, load_22khz_mono_8_bit
   316                                  chk_22khz_2:
   317 00000192 B85A1D0000              	mov	eax, 7514  ; (442*17)
   318 00000197 BA25000000              	mov	edx, 37
   319 0000019C B911000000              	mov	ecx, 17 
   320 000001A1 E9BA010000              	jmp	set_sizes	
   321                                  chk_11khz:
   322 000001A6 663D112B                	cmp	ax, 11025
   323 000001AA 7545                    	jne	short chk_44khz
   324 000001AC 803D[E5220000]08        	cmp	byte [bps], 8
   325 000001B3 7615                    	jna	short chk_11khz_1
   326 000001B5 BB[27180000]            	mov	ebx, load_11khz_stereo_16_bit
   327 000001BA 803D[E4220000]01        	cmp	byte [stmo], 1 
   328 000001C1 751A                    	jne	short chk_11khz_2
   329 000001C3 BB[AE170000]            	mov	ebx, load_11khz_mono_16_bit
   330 000001C8 EB13                    	jmp	short chk_11khz_2
   331                                  chk_11khz_1:
   332 000001CA BB[34170000]            	mov	ebx, load_11khz_stereo_8_bit
   333 000001CF 803D[E4220000]01        	cmp	byte [stmo], 1 
   334 000001D6 7505                    	jne	short chk_11khz_2
   335 000001D8 BB[BC160000]            	mov	ebx, load_11khz_mono_8_bit
   336                                  chk_11khz_2:
   337 000001DD B8AD0E0000              	mov	eax, 3757  ; (221*17)
   338 000001E2 BA4A000000              	mov	edx, 74
   339 000001E7 B911000000              	mov	ecx, 17
   340 000001EC E96F010000              	jmp	set_sizes 
   341                                  chk_44khz:
   342 000001F1 663D44AC                	cmp	ax, 44100
   343 000001F5 7545                    	jne	short chk_16khz
   344 000001F7 803D[E5220000]08        	cmp	byte [bps], 8
   345 000001FE 7615                    	jna	short chk_44khz_1
   346 00000200 BB[2E1A0000]            	mov	ebx, load_44khz_stereo_16_bit
   347 00000205 803D[E4220000]01        	cmp	byte [stmo], 1 
   348 0000020C 751A                    	jne	short chk_44khz_2
   349 0000020E BB[B5190000]            	mov	ebx, load_44khz_mono_16_bit
   350 00000213 EB13                    	jmp	short chk_44khz_2
   351                                  chk_44khz_1:
   352 00000215 BB[38190000]            	mov	ebx, load_44khz_stereo_8_bit
   353 0000021A 803D[E4220000]01        	cmp	byte [stmo], 1 
   354 00000221 7505                    	jne	short chk_44khz_2
   355 00000223 BB[BC180000]            	mov	ebx, load_44khz_mono_8_bit
   356                                  chk_44khz_2:
   357 00000228 B8D93A0000              	mov	eax, 15065 ; (655*23)
   358 0000022D BA19000000              	mov	edx, 25
   359 00000232 B917000000              	mov	ecx, 23
   360 00000237 E924010000              	jmp	set_sizes 
   361                                  chk_16khz:
   362 0000023C 663D803E                	cmp	ax, 16000
   363 00000240 7545                    	jne	short chk_8khz
   364 00000242 803D[E5220000]08        	cmp	byte [bps], 8
   365 00000249 7615                    	jna	short chk_16khz_1
   366 0000024B BB[B30F0000]            	mov	ebx, load_16khz_stereo_16_bit
   367 00000250 803D[E4220000]01        	cmp	byte [stmo], 1 
   368 00000257 751A                    	jne	short chk_16khz_2
   369 00000259 BB[320F0000]            	mov	ebx, load_16khz_mono_16_bit
   370 0000025E EB13                    	jmp	short chk_16khz_2
   371                                  chk_16khz_1:
   372 00000260 BB[780E0000]            	mov	ebx, load_16khz_stereo_8_bit
   373 00000265 803D[E4220000]01        	cmp	byte [stmo], 1 
   374 0000026C 7505                    	jne	short chk_16khz_2
   375 0000026E BB[F90D0000]            	mov	ebx, load_16khz_mono_8_bit
   376                                  chk_16khz_2:
   377 00000273 B855150000              	mov	eax, 5461
   378 00000278 BA03000000              	mov	edx, 3
   379 0000027D B901000000              	mov	ecx, 1
   380 00000282 E9D9000000              	jmp	set_sizes 
   381                                  chk_8khz:
   382 00000287 663D401F                	cmp	ax, 8000
   383 0000028B 7545                    	jne	short chk_24khz
   384 0000028D 803D[E5220000]08        	cmp	byte [bps], 8
   385 00000294 7615                    	jna	short chk_8khz_1
   386 00000296 BB[AE0C0000]            	mov	ebx, load_8khz_stereo_16_bit
   387 0000029B 803D[E4220000]01        	cmp	byte [stmo], 1 
   388 000002A2 751A                    	jne	short chk_8khz_2
   389 000002A4 BB[DE0B0000]            	mov	ebx, load_8khz_mono_16_bit
   390 000002A9 EB13                    	jmp	short chk_8khz_2
   391                                  chk_8khz_1:
   392 000002AB BB[AE0A0000]            	mov	ebx, load_8khz_stereo_8_bit
   393 000002B0 803D[E4220000]01        	cmp	byte [stmo], 1 
   394 000002B7 7505                    	jne	short chk_8khz_2
   395 000002B9 BB[CA090000]            	mov	ebx, load_8khz_mono_8_bit
   396                                  chk_8khz_2:
   397 000002BE B8AA0A0000              	mov	eax, 2730
   398 000002C3 BA06000000              	mov	edx, 6
   399 000002C8 B901000000              	mov	ecx, 1
   400 000002CD E98E000000              	jmp	set_sizes 
   401                                  chk_24khz:
   402 000002D2 663DC05D                	cmp	ax, 24000
   403 000002D6 7542                    	jne	short chk_32khz
   404 000002D8 803D[E5220000]08        	cmp	byte [bps], 8
   405 000002DF 7615                    	jna	short chk_24khz_1
   406 000002E1 BB[DD110000]            	mov	ebx, load_24khz_stereo_16_bit
   407 000002E6 803D[E4220000]01        	cmp	byte [stmo], 1 
   408 000002ED 751A                    	jne	short chk_24khz_2
   409 000002EF BB[7A110000]            	mov	ebx, load_24khz_mono_16_bit
   410 000002F4 EB13                    	jmp	short chk_24khz_2
   411                                  chk_24khz_1:
   412 000002F6 BB[F0100000]            	mov	ebx, load_24khz_stereo_8_bit
   413 000002FB 803D[E4220000]01        	cmp	byte [stmo], 1 
   414 00000302 7505                    	jne	short chk_24khz_2
   415 00000304 BB[89100000]            	mov	ebx, load_24khz_mono_8_bit
   416                                  chk_24khz_2:
   417 00000309 B800200000              	mov	eax, 8192
   418 0000030E BA02000000              	mov	edx, 2
   419 00000313 B901000000              	mov	ecx, 1
   420 00000318 EB46                    	jmp	short set_sizes 
   421                                  chk_32khz:
   422 0000031A 663D007D                	cmp	ax, 32000
   423 0000031E 7579                    	jne	short vra_needed
   424 00000320 803D[E5220000]08        	cmp	byte [bps], 8
   425 00000327 7615                    	jna	short chk_32khz_1
   426 00000329 BB[DE130000]            	mov	ebx, load_32khz_stereo_16_bit
   427 0000032E 803D[E4220000]01        	cmp	byte [stmo], 1 
   428 00000335 751A                    	jne	short chk_32khz_2
   429 00000337 BB[74130000]            	mov	ebx, load_32khz_mono_16_bit
   430 0000033C EB13                    	jmp	short chk_32khz_2
   431                                  chk_32khz_1:
   432 0000033E BB[D7120000]            	mov	ebx, load_32khz_stereo_8_bit
   433 00000343 803D[E4220000]01        	cmp	byte [stmo], 1 
   434 0000034A 7505                    	jne	short chk_32khz_2
   435 0000034C BB[64120000]            	mov	ebx, load_32khz_mono_8_bit
   436                                  chk_32khz_2:
   437 00000351 B8AA2A0000              	mov	eax, 10922
   438 00000356 BA03000000              	mov	edx, 3
   439 0000035B B902000000              	mov	ecx, 2
   440                                  	;jmp	short set_sizes 
   441                                  set_sizes:
   442 00000360 803D[E4220000]01        	cmp	byte [stmo], 1
   443 00000367 7402                    	je	short ss_1
   444 00000369 D1E0                    	shl	eax, 1
   445                                  ss_1:
   446 0000036B 803D[E5220000]08        	cmp	byte [bps], 8
   447 00000372 7602                    	jna	short ss_2
   448                                  	; 16 bit samples
   449 00000374 D1E0                    	shl	eax, 1
   450                                  ss_2:
   451 00000376 A3[B8030000]            	mov	[loadsize], eax
   452 0000037B F7E2                    	mul	edx
   453                                  	;cmp	ecx, 1
   454                                  	;je	short ss_3
   455                                  ;ss_3:
   456 0000037D F7F1                    	div	ecx
   457 0000037F 8A0D[60230000]          	mov	cl, [fbs_shift]
   458 00000385 D3E0                    	shl	eax, cl
   459                                  	; 26/11/2023
   460                                  	;shr	eax, 1	; buffer size is 16 bit sample count
   461                                  
   462                                  	;;;
   463                                  	; 04/06/2024 (8 byte alignment for BDL)
   464 00000387 83C007                  	add	eax, 7
   465 0000038A 24F8                    	and	al, ~7
   466                                  	;;;
   467                                  
   468 0000038C A3[BC030000]            	mov	[buffersize], eax ; buffer size in bytes 
   469 00000391 891D[B4030000]          	mov	[loadfromwavfile], ebx
   470 00000397 EB27                    	jmp	short PlayNow
   471                                  
   472                                  vra_needed:
   473                                  	sys	_msg, msg_no_vra, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000399 BB[74210000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000039E B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000003A3 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000003A8 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000003AD CD40                <1>  int 40h
   474 000003AF E9D1000000              	jmp	Exit
   475                                  
   476                                  	; 26/11/2023
   477                                  	; 13/11/2023
   478                                  loadfromwavfile:
   479 000003B4 [64050000]              	dd	loadFromFile
   480                                  loadsize:	; read from wav file
   481 000003B8 00000000                	dd	0
   482                                  buffersize:	; write to DMA buffer
   483 000003BC 00000100                	dd	65536 ; bytes
   484                                  
   485                                  PlayNow: 
   486                                  
   487                                  ; 26/11/2023
   488                                  %if 1
   489                                  	; Allocate Audio Buffer (for user)
   490                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   491                                  	; 26/11/2023
   492                                  	sys	_audio, 0200h, [buffersize], audio_buffer
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000003C0 BB00020000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000003C5 8B0D[BC030000]      <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000003CB BA[00300000]        <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000003D0 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000003D5 CD40                <1>  int 40h
   493 000003D7 731B                    	jnc	short _2
   494                                  
   495                                  	; 26/11/2023 - temporary
   496                                  	;sys	_msg, test_1, 255, 0Ch
   497                                  
   498                                  error_exit:
   499                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000003D9 BB[23210000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000003DE B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000003E3 BA0E000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000003E8 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000003ED CD40                <1>  int 40h
   500 000003EF E991000000              	jmp	Exit
   501                                  _2:
   502                                  	; DIRECT CGA (TEXT MODE) MEMORY ACCESS
   503                                  	; bl = 0, bh = 4
   504                                  	; Direct access/map to CGA (Text) memory (0B8000h)
   505                                  
   506                                  	sys	_video, 0400h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000003F4 BB00040000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000003F9 B81F000000          <1>  mov eax, %1
    90                              <1> 
    91 000003FE CD40                <1>  int 40h
   507 00000400 3D00800B00              	cmp	eax, 0B8000h
   508 00000405 75D2                    	jne	short error_exit
   509                                  
   510                                  	; 01/06/2024
   511                                  	; Initialize Audio Device (bh = 3)
   512                                  	sys	_audio, 0301h, 0, audio_int_handler 
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000407 BB01030000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000040C B900000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000411 BA[50050000]        <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000416 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000041B CD40                <1>  int 40h
   513                                  	;jc	short error_exit
   514 0000041D 0F8211FDFFFF            	jc	init_err
   515                                  _3:
   516                                  
   517                                  %endif
   518                                  
   519                                  ;
   520                                  ; position file pointer to start in actual wav data
   521                                  ; MUCH improvement should really be done here to check if sample size is
   522                                  ; supported, make sure there are 2 channels, etc.  
   523                                  ;
   524                                          ;mov     ah, 42h
   525                                          ;mov     al, 0	; from start of file
   526                                          ;mov     bx, [FileHandle]
   527                                          ;xor     cx, cx
   528                                          ;mov     dx, 44	; jump past .wav/riff header
   529                                          ;int     21h
   530                                  
   531                                  	sys	_seek, [FileHandle], 44, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000423 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000429 B92C000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000042E BA00000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000433 B813000000          <1>  mov eax, %1
    90                              <1> 
    91 00000438 CD40                <1>  int 40h
   532                                  
   533                                  	sys	_msg, nextline, 255, 07h ; 01/05/2017
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000043A BB[F9210000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000043F B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000444 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000449 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 0000044E CD40                <1>  int 40h
   534                                  
   535                                  ; play the .wav file. Most of the good stuff is in here.
   536                                  
   537 00000450 E8C2010000                      call    PlayWav
   538                                  
   539                                  ; close the .wav file and exit.
   540                                  
   541                                  StopPlaying:
   542                                  	; Stop Playing
   543                                  	sys	_audio, 0700h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000455 BB00070000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000045A B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000045F CD40                <1>  int 40h
   544                                  	; Cancel callback service (for user)
   545                                  	sys	_audio, 0900h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000461 BB00090000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000466 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000046B CD40                <1>  int 40h
   546                                  	; Deallocate Audio Buffer (for user)
   547                                  	sys	_audio, 0A00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000046D BB000A0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000472 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000477 CD40                <1>  int 40h
   548                                  	; Disable Audio Device
   549                                  	sys	_audio, 0C00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000479 BB000C0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000047E B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000483 CD40                <1>  int 40h
   550                                  Exit:  
   551 00000485 E847000000                      call    closeFile
   552                                           
   553                                  	sys	_exit	; Bye!
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81                              <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000048A B801000000          <1>  mov eax, %1
    90                              <1> 
    91 0000048F CD40                <1>  int 40h
   554                                  here:
   555 00000491 EBFE                    	jmp	short here
   556                                  
   557                                  pmsg_usage:
   558                                  	sys	_msg, msg_usage, 255, 0Bh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000493 BB[C0200000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000498 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000049D BA0B000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004A2 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000004A7 CD40                <1>  int 40h
   559 000004A9 EBDA                    	jmp	short Exit
   560                                  
   561                                  	; 25/11/2023
   562                                  DetectAC97:
   563                                  	; Detect (BH=1) AC'97 (BL=2) Audio Device
   564                                          sys	_audio, 0102h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004AB BB02010000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004B0 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004B5 CD40                <1>  int 40h
   565                                  
   566                                  ; 01/06/2024
   567                                  %if 0
   568                                  	jc	short DetectAC97_retn
   569                                  
   570                                  	; 25/11/2023
   571                                  	; Get AC'97 Codec info
   572                                  	; (Function 14, sub function 1)
   573                                  	sys	_audio, 0E01h
   574                                  	; Save Variable Rate Audio support bit
   575                                  	and	al, 1
   576                                  	mov	[VRA], al
   577                                  %endif
   578                                  
   579                                  DetectAC97_retn:
   580 000004B7 C3                      	retn
   581                                  
   582                                  ;open or create file
   583                                  ;
   584                                  ;input: ds:dx-->filename (asciiz)
   585                                  ;       al=file Mode (create or open)
   586                                  ;output: none  cs:[FileHandle] filled
   587                                  ;
   588                                  openFile:
   589                                  	;mov	ah, 3Bh	; start with a mode
   590                                  	;add	ah, al	; add in create or open mode
   591                                  	;xor	ecx, ecx
   592                                  	;int	21h
   593                                  	;jc	short _of1
   594                                  	;;mov	[cs:FileHandle], ax
   595                                  
   596                                  	sys	_open, wav_file_name, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004B8 BB[0D230000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000004BD B900000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004C2 B805000000          <1>  mov eax, %1
    90                              <1> 
    91 000004C7 CD40                <1>  int 40h
   597 000004C9 7205                    	jc	short _of1
   598                                  
   599 000004CB A3[FA1F0000]            	mov	[FileHandle], eax
   600                                  _of1:
   601 000004D0 C3                      	retn
   602                                  
   603                                  ; close the currently open file
   604                                  ; input: none, uses cs:[FileHandle]
   605                                  closeFile:
   606 000004D1 833D[FA1F0000]FF        	cmp	dword [FileHandle], -1
   607 000004D8 7417                    	je	short _cf1
   608                                  	;mov    bx, [FileHandle]  
   609                                  	;mov    ax, 3E00h
   610                                          ;int    21h              ;close file
   611                                  
   612                                  	sys	_close, [FileHandle]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004DA 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004E0 B806000000          <1>  mov eax, %1
    90                              <1> 
    91 000004E5 CD40                <1>  int 40h
   613 000004E7 C705[FA1F0000]FFFF-     	mov 	dword [FileHandle], -1
   613 000004EF FFFF               
   614                                  _cf1:
   615 000004F1 C3                      	retn
   616                                  
   617                                  getSampleRate:
   618                                  	
   619                                  ; reads the sample rate from the .wav file.
   620                                  ; entry: none - assumes file is already open
   621                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   622                                  ;	cx = number of channels (mono=1, stereo=2)
   623                                  ;	dx = bits per sample (8, 16)
   624                                  
   625 000004F2 53                      	push    ebx
   626                                  
   627                                          ;mov	ah, 42h
   628                                          ;mov	al, 0	; from start of file
   629                                          ;mov	bx, [FileHandle]
   630                                          ;xor	ecx, ecx
   631                                          ;mov	dx, 08h	; "WAVE"
   632                                          ;int	21h
   633                                  	
   634                                  	sys	_seek, [FileHandle], 8, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004F3 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000004F9 B908000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000004FE BA00000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000503 B813000000          <1>  mov eax, %1
    90                              <1> 
    91 00000508 CD40                <1>  int 40h
   635                                  
   636                                          ;mov	dx, smpRBuff
   637                                          ;mov	cx, 28	; 28 bytes
   638                                  	;mov	ah, 3fh
   639                                          ;int	21h
   640                                  
   641                                  	sys	_read, [FileHandle], smpRBuff, 28
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000050A 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000510 B9[F1220000]        <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000515 BA1C000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000051A B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000051F CD40                <1>  int 40h
   642                                  
   643 00000521 813D[F1220000]5741-     	cmp	dword [smpRBuff], 'WAVE'
   643 00000529 5645               
   644 0000052B 7520                    	jne	short gsr_stc
   645                                  
   646 0000052D 66833D[FD220000]01      	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   647 00000535 7516                    	jne	short gsr_stc
   648                                  
   649 00000537 668B0D[FF220000]        	mov	cx, [smpRBuff+14]	; return num of channels in CX
   650 0000053E 66A1[01230000]                  mov     ax, [smpRBuff+16]	; return sample rate in AX
   651 00000544 668B15[0B230000]        	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   652                                  gsr_retn:
   653 0000054B 5B                              pop     ebx
   654 0000054C C3                              retn
   655                                  gsr_stc:
   656 0000054D F9                      	stc
   657 0000054E EBFB                    	jmp	short gsr_retn
   658                                  
   659                                  audio_int_handler:
   660                                  	; 13/12/2024
   661                                  	; 18/08/2020 (14/10/2020, 'wavplay2.s')
   662                                  
   663                                  	;mov	byte [srb], 1 ; interrupt (or signal response byte)
   664                                  	
   665                                  	;cmp	byte [cbs_busy], 1
   666                                  	;jnb	short _callback_bsy_retn
   667                                  	
   668                                  	;mov	byte [cbs_busy], 1
   669                                  
   670                                  	; 13/12/2024
   671                                  	;mov	al, [half_buff]
   672                                  	;
   673                                  	;cmp	al, 1
   674                                  	;jb	short _callback_retn
   675                                  
   676                                  	; 18/08/2020
   677                                  	;mov	byte [srb], 1
   678                                  	; 13/12/2024
   679 00000550 FE05[EE220000]          	inc	byte [srb]
   680                                  
   681                                  	; 13/12/2024
   682                                  	;xor	byte [half_buff], 3 ; 2->1, 1->2
   683                                  
   684                                  	; 13/12/2024
   685                                  	;add	al, '0'
   686                                  ;tL0:	; 26/11/2023
   687                                  	;mov	ah, 4Eh
   688                                  	;mov	ebx, 0B8000h ; video display page address
   689                                  	;mov	[ebx], ax ; show playing buffer (1, 2)
   690                                  ;_callback_retn:
   691                                  	;;mov	byte [cbs_busy], 0
   692                                  ;_callback_bsy_retn:
   693                                  	sys	_rele ; return from callback service 
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81                              <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000556 B827000000          <1>  mov eax, %1
    90                              <1> 
    91 0000055B CD40                <1>  int 40h
   694                                  	; we must not come here !
   695                                  	sys	_exit
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81                              <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000055D B801000000          <1>  mov eax, %1
    90                              <1> 
    91 00000562 CD40                <1>  int 40h
   696                                  	
   697                                  loadFromFile:
   698                                  	; 26/11/2023
   699 00000564 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
   700                                  					; last of the file?
   701 0000056B 7402                    	jz	short lff_0		; no
   702 0000056D F9                      	stc
   703 0000056E C3                      	retn
   704                                  lff_0:
   705                                  	; 13/06/2017
   706                                  	;mov	edx, BUFFERSIZE
   707                                  	; 26/11/2023
   708 0000056F BF[00300000]            	mov	edi, audio_buffer
   709 00000574 8B15[BC030000]          	mov	edx, [buffersize]	; bytes
   710 0000057A 8A0D[60230000]          	mov	cl, [fbs_shift]   
   711 00000580 20C9                    	and	cl, cl
   712 00000582 7409                    	jz	short lff_1 ; stereo, 16 bit
   713                                  
   714                                  	; fbs_shift =
   715                                  	;	2 for mono and 8 bit sample (multiplier = 4)
   716                                  	;	1 for mono or 8 bit sample (multiplier = 2)
   717 00000584 D3EA                    	shr	edx, cl
   718                                  	;inc	edx
   719                                  
   720 00000586 BE[00300100]            	mov     esi, temp_buffer
   721 0000058B EB02                    	jmp	short lff_2
   722                                  lff_1:
   723                                  	;mov	esi, audio_buffer
   724 0000058D 89FE                    	mov	esi, edi ; audio_buffer
   725                                  lff_2:
   726                                  	; 17/03/2017
   727                                  	; esi = buffer address
   728                                  	; edx = buffer size
   729                                   
   730                                  	; 26/11/2023
   731                                  	; load file into memory
   732                                  	sys 	_read, [FileHandle], esi
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000058F 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000595 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000597 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000059C CD40                <1>  int 40h
   733                                  	; 14/12/2024
   734 0000059E 8B0D[BC030000]          	mov	ecx, [buffersize]
   735                                  	;jc	short padfill ; error !
   736                                  	; 14/12/2024
   737 000005A4 7255                    	jc	short lff_10
   738                                  
   739 000005A6 21C0                    	and	eax, eax
   740 000005A8 7453                    	jz	short padfill
   741                                  lff_3:
   742                                  	; 26/11/2023
   743 000005AA 8A1D[60230000]          	mov	bl, [fbs_shift]
   744 000005B0 20DB                    	and	bl, bl
   745 000005B2 7456                    	jz	short lff_11
   746                                  
   747                                  	; 14/12/2024
   748                                  	;sub	ecx, eax
   749                                  	;mov	ebp, ecx
   750                                  	; 14/12/2024
   751 000005B4 29C2                    	sub	edx, eax
   752                                  
   753                                  	;mov	esi, temp_buffer
   754                                  	;mov	edi, audio_buffer
   755 000005B6 89C1                    	mov	ecx, eax   ; byte count
   756                                  
   757 000005B8 803D[E5220000]08        	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   758 000005BF 751E                    	jne	short lff_6 ; 16 bit samples
   759                                  	; 8 bit samples
   760 000005C1 FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
   761 000005C3 740E                    	jz	short lff_5 ; 8 bit, stereo
   762                                  lff_4:
   763                                  	; mono & 8 bit
   764 000005C5 AC                      	lodsb
   765 000005C6 2C80                    	sub	al, 80h ; 08/11/2023
   766 000005C8 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   767 000005CB 66AB                    	stosw	; left channel
   768 000005CD 66AB                    	stosw	; right channel
   769 000005CF E2F4                    	loop	lff_4
   770 000005D1 EB16                    	jmp	short lff_8
   771                                  lff_5:
   772                                  	; stereo & 8 bit
   773 000005D3 AC                      	lodsb
   774 000005D4 2C80                    	sub	al, 80h ; 08/11/2023
   775 000005D6 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   776 000005D9 66AB                    	stosw
   777 000005DB E2F6                    	loop	lff_5
   778 000005DD EB0A                    	jmp	short lff_8
   779                                  lff_6:
   780 000005DF D1E9                    	shr	ecx, 1 ; word count
   781                                  lff_7:
   782 000005E1 66AD                    	lodsw
   783 000005E3 66AB                    	stosw	; left channel
   784 000005E5 66AB                    	stosw	; right channel
   785 000005E7 E2F8                    	loop	lff_7
   786                                  lff_8:
   787                                  	; 27/11/2023
   788 000005E9 F8                      	clc
   789                                  	; 14/12/2024
   790                                  	;mov	ecx, ebp
   791                                  	;jecxz	endLFF_retn
   792 000005EA 09D2                    	or	edx, edx
   793 000005EC 741B                    	jz	short endLFF_retn
   794                                  	
   795                                  	; 14/12/2024
   796 000005EE B9[00300000]            	mov	ecx, audio_buffer
   797 000005F3 030D[BC030000]          	add	ecx, [buffersize]
   798 000005F9 29F9                    	sub	ecx, edi
   799                                  
   800                                  	; 14/12/2024
   801                                  lff_10:
   802 000005FB 31C0                    	xor	eax, eax ; silence
   803                                  padfill:
   804 000005FD D1E9                    	shr	ecx, 1
   805 000005FF F366AB                  	rep	stosw
   806                                  lff_9:
   807 00000602 800D[EC220000]01                or	byte [flags], ENDOFFILE	; end of file flag
   808                                  endLFF_retn:
   809 00000609 C3                              retn
   810                                  
   811                                  lff_11:
   812                                  	; 16 bit stereo
   813                                  	; ecx = buffer size
   814                                  	; eax = read count
   815 0000060A 29C1                    	sub	ecx, eax
   816 0000060C 76FB                    	jna	short endLFF_retn
   817 0000060E 01C7                    	add	edi, eax  ; audio_buffer + eax
   818 00000610 EBE9                    	jmp	short lff_10 ; padfill
   819                                  
   820                                  error_exit_2:
   821                                  	; 26/11/2023 - temporary
   822                                  	;sys	_msg, test_2, 255, 0Ch
   823                                  
   824 00000612 E9C2FDFFFF              	jmp	error_exit
   825                                  	
   826                                  	; 26/11/2023 - temporary
   827                                  ;test_1:
   828                                  ;	db 13, 10, 'Test 1', 13,10, 0
   829                                  ;test_2:
   830                                  ;	db 13, 10, 'Test 2', 13,10, 0
   831                                  	
   832                                  PlayWav:
   833                                  	; 26/11/2023
   834                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   835                                  	; 13/06/2017
   836                                  	; Convert 8 bit samples to 16 bit samples
   837                                  	; and convert mono samples to stereo samples
   838                                  
   839                                  	; 26/11/2023
   840                                  	; load 32768 bytes into audio buffer
   841                                  	;mov	edi, audio_buffer
   842                                  	;;mov	edx, BUFFERSIZE
   843                                  	; 26/11/2023
   844                                  	;mov	edx, [buffersize]
   845                                  	;call	loadFromFile
   846                                  	; 26/11/2023
   847 00000617 FF15[B4030000]          	call	dword [loadfromwavfile]
   848 0000061D 72F3                    	jc	short error_exit_2
   849 0000061F C605[ED220000]01        	mov	byte [half_buff], 1 ; (DMA) Buffer 1
   850                                  
   851                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   852 00000626 F605[EC220000]01        	test    byte [flags], ENDOFFILE  ; end of file
   853 0000062D 7512                    	jnz	short _6 ; yes
   854                                  			 ; bypass filling dma half buffer 2
   855                                  
   856                                  	; bh = 16 : update (current, first) dma half buffer
   857                                  	; bl = 0  : then switch to the next (second) half buffer
   858                                  	sys	_audio, 1000h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000062F BB00100000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000634 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000639 CD40                <1>  int 40h
   859                                  
   860                                  	; 18/08/2020
   861                                  	; [audio_flag] = 1 (in TRDOS 386 kernel)
   862                                  
   863                                  	; audio_buffer must be filled again after above system call 
   864                                  	; (Because audio interrupt will be generated by AC97 hardware
   865                                  	; at the end of the first half of dma buffer.. so, 
   866                                  	; the second half must be ready. 'sound_play' will use it.)
   867                                  
   868                                  	; 26/11/2023
   869                                  	;mov	edi, audio_buffer
   870                                  	;;mov	edx, BUFFERSIZE
   871                                  	; 26/11/2023
   872                                  	;mov	edx, [buffersize]
   873                                  	;call	loadFromFile
   874                                  	; 26/11/2023
   875 0000063B FF15[B4030000]          	call	dword [loadfromwavfile]
   876                                  	;jc	short p_return
   877                                  _6:
   878                                  	; Set Master Volume Level (BL=0 or 80h)
   879                                  	; 	for next playing (BL>=80h)
   880                                  	;sys	_audio, 0B80h, 1D1Dh
   881                                  	sys	_audio, 0B00h, 1D1Dh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000641 BB000B0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000646 B91D1D0000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000064B B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000650 CD40                <1>  int 40h
   882                                  
   883                                  	; 18/08/2020
   884                                  	;mov	byte [volume_level], 1Dh
   885 00000652 880D[EF220000]          	mov	[volume_level], cl
   886                                  
   887                                  	; Start	to play
   888                                  	;mov	al, [bps]
   889                                  	;shr	al, 4 ; 8 -> 0, 16 -> 1
   890                                  	;shl	al, 1 ; 16 -> 2, 8 -> 0
   891                                  	;mov	bl, [stmo]
   892                                  	;dec	bl
   893                                  	;or	bl, al
   894                                  	;mov	cx, [sample_rate]
   895                                  	; 04/06/2024
   896                                  	; (non-VRA simulation)
   897 00000658 66B980BB                 	mov	cx, 48000 ; 48 kHz
   898 0000065C B303                    	mov	bl, 3  ; 16 bit, stereo
   899                                  	
   900 0000065E B704                    	mov	bh, 4 ; start to play
   901                                  	sys	_audio
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81                              <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000660 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000665 CD40                <1>  int 40h
   902                                  
   903                                  	;mov	ebx, 0B8000h ; video display page address
   904                                  	;mov	ah, 4Eh
   905                                  	;mov	al, [half_buffer]
   906                                  	;mov	[ebx], ax ; show playing buffer (1, 2)
   907                                  
   908                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   909                                  	; Here..
   910                                  	; If byte [flags] <> ENDOFFILE ...
   911                                  	; user's audio_buffer has been copied to dma half buffer 2
   912                                  
   913                                  	; [audio_flag] = 0 (in TRDOS 386 kernel)
   914                                  
   915                                  	; audio_buffer must be filled again after above system call 
   916                                  	; (Because, audio interrupt will be generated by VT8237R
   917                                  	; at the end of the first half of dma buffer.. so, 
   918                                  	; the 2nd half of dma buffer is ready but the 1st half
   919                                  	; must be filled again.)
   920                                  
   921                                  ; 14/12/2024
   922                                  %if 0
   923                                  	; 18/08/2020
   924                                  	test    byte [flags], ENDOFFILE  ; end of file
   925                                  	jnz	short p_loop ; yes
   926                                  
   927                                  	; 18/08/2020
   928                                  	; load 32768 bytes into audio buffer
   929                                  	;; (for the second half of DMA buffer)
   930                                  	; 27/11/2023
   931                                  	; 20/05/2017
   932                                  	;mov	edi, audio_buffer
   933                                  	;mov	edx, BUFFERSIZE
   934                                  	; 26/11/2023
   935                                  	;mov	edx, [buffersize]
   936                                  	;call	loadFromFile
   937                                  	; 26/11/2023
   938                                  	call	dword [loadfromwavfile]
   939                                  	;jc	short p_return
   940                                  	;mov	byte [half_buff], 2 ; (DMA) Buffer 2
   941                                  %endif
   942                                  
   943                                  	; we need to wait for 'SRB' (audio interrupt)
   944                                  	; (we can not return from 'PlayWav' here 
   945                                  	;  even if we have got an error from file reading)
   946                                  	; ((!!current audio data must be played!!))
   947                                  
   948                                  	; 18/08/2020
   949                                  	;mov	byte [srb], 1
   950                                  
   951                                  p_loop:
   952                                  	;mov	ah, 1		; any key pressed?
   953                                  	;int	32h		; no, Loop.
   954                                  	;jz	short q_loop
   955                                  	;
   956                                  	;mov	ah, 0		; flush key buffer...
   957                                  	;int	32h
   958                                  
   959                                  	; 18/08/2020 (14/10/2017, 'wavplay2.s')
   960 00000667 803D[EE220000]00        	cmp	byte [srb], 0
   961 0000066E 7627                    	jna	short q_loop
   962 00000670 C605[EE220000]00        	mov	byte [srb], 0
   963                                  	; 13/12/2024
   964 00000677 8035[ED220000]03        	xor	byte [half_buff], 3 ; 2->1, 1->2
   965                                  
   966                                  	; 27/11/2023
   967                                  	;mov	edi, audio_buffer
   968                                  	;mov	edx, BUFFERSIZE
   969                                  	; 26/11/2023
   970                                  	;mov	edx, [buffersize]
   971                                  	;call	loadFromFile
   972                                  	; 26/11/2023
   973 0000067E FF15[B4030000]          	call	dword [loadfromwavfile]
   974 00000684 7223                    	jc	short p_return
   975                                  
   976                                  	; 14/12/2024
   977                                  	;;;
   978                                  	; bh = 16 : update (current, first) dma half buffer
   979                                  	; bl = 0  : then switch to the other half buffer
   980                                  	sys	_audio, 1000h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000686 BB00100000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000068B B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000690 CD40                <1>  int 40h
   981                                  	;;;
   982                                  
   983                                  	; 13/12/2024
   984 00000692 E819000000              	call	tL0
   985                                  q_loop:
   986 00000697 B401                    	mov     ah, 1		; any key pressed?
   987 00000699 CD32                    	int     32h		; no, Loop.
   988 0000069B 74CA                    	jz	short p_loop
   989                                  
   990 0000069D B400                    	mov     ah, 0		; flush key buffer...
   991 0000069F CD32                    	int     32h
   992                                  	
   993 000006A1 3C2B                    	cmp	al, '+' ; increase sound volume
   994 000006A3 741D                    	je	short inc_volume_level
   995 000006A5 3C2D                    	cmp	al, '-'
   996 000006A7 743C                    	je	short dec_volume_level
   997                                  
   998                                  p_return:
   999 000006A9 C605[ED220000]00        	mov	byte [half_buff], 0
  1000                                  	; 13/12/2024
  1001                                  	;call	tL0
  1002                                  	;retn
  1003                                  
  1004                                  	; 13/12/2024
  1005                                  tL0:
  1006 000006B0 A0[ED220000]            	mov	al, [half_buff]
  1007 000006B5 0430                    	add	al, '0'
  1008 000006B7 B44E                    	mov	ah, 4Eh
  1009 000006B9 BB00800B00              	mov	ebx, 0B8000h	; video display page address
  1010 000006BE 668903                  	mov	[ebx], ax	; show playing buffer (1, 2)
  1011 000006C1 C3                      	retn
  1012                                  
  1013                                  	; 18/08/2020 (14/10/2017, 'wavplay2.s')
  1014                                  inc_volume_level:
  1015 000006C2 8A0D[EF220000]          	mov	cl, [volume_level]
  1016 000006C8 80F91F                  	cmp	cl, 1Fh ; 31
  1017 000006CB 73CA                    	jnb	short q_loop
  1018 000006CD FEC1                    	inc	cl
  1019                                  change_volume_level:
  1020 000006CF 880D[EF220000]          	mov	[volume_level], cl
  1021 000006D5 88CD                    	mov	ch, cl
  1022                                  	; Set Master Volume Level
  1023                                  	sys	_audio, 0B00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000006D7 BB000B0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000006DC B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000006E1 CD40                <1>  int 40h
  1024 000006E3 EB82                    	jmp	short p_loop
  1025                                  dec_volume_level:
  1026 000006E5 8A0D[EF220000]          	mov	cl, [volume_level]
  1027 000006EB 80F901                  	cmp	cl, 1 ; 1
  1028                                  	;jna	short p_loop
  1029                                  	; 14/12/2024
  1030 000006EE 76A7                    	jna	short q_loop
  1031 000006F0 FEC9                    	dec	cl
  1032 000006F2 EBDB                    	jmp	short change_volume_level
  1033                                  
  1034                                  write_audio_dev_info:
  1035                                  	; EBX = Message address
  1036                                  	; ECX = Max. message length (or stop on ZERO character)
  1037                                  	;	(1 to 255)
  1038                                  	; DL  = Message color (07h = light gray, 0Fh = white) 
  1039                                       	sys 	_msg, msgAudioCardInfo, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000006F4 BB[97200000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000006F9 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000006FE BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000703 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000708 CD40                <1>  int 40h
  1040 0000070A C3                      	retn
  1041                                  
  1042                                  write_wav_file_info:
  1043                                  	; 01/05/2017
  1044                                  	sys	_msg, msgWavFileName, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000070B BB[AD210000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000710 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000715 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000071A B823000000          <1>  mov eax, %1
    90                              <1> 
    91 0000071F CD40                <1>  int 40h
  1045                                  	sys	_msg, wav_file_name, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000721 BB[0D230000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000726 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000072B BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000730 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000735 CD40                <1>  int 40h
  1046                                  
  1047                                  write_sample_rate:
  1048                                  	; 01/05/2017
  1049 00000737 66A1[E6220000]          	mov	ax, [sample_rate]
  1050                                  	; ax = sample rate (hertz)
  1051 0000073D 31D2                    	xor	edx, edx
  1052 0000073F 66B90A00                	mov	cx, 10
  1053 00000743 66F7F1                  	div	cx
  1054 00000746 0015[D2210000]          	add	[msgHertz+4], dl
  1055 0000074C 29D2                    	sub	edx, edx
  1056 0000074E 66F7F1                  	div	cx
  1057 00000751 0015[D1210000]          	add	[msgHertz+3], dl
  1058 00000757 29D2                    	sub	edx, edx
  1059 00000759 66F7F1                  	div	cx
  1060 0000075C 0015[D0210000]          	add	[msgHertz+2], dl
  1061 00000762 29D2                    	sub	edx, edx
  1062 00000764 66F7F1                  	div	cx
  1063 00000767 0015[CF210000]          	add	[msgHertz+1], dl
  1064 0000076D 0005[CE210000]          	add	[msgHertz], al
  1065                                  	
  1066                                  	sys	_msg, msgSampleRate, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000773 BB[BF210000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000778 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000077D BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000782 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000787 CD40                <1>  int 40h
  1067                                  
  1068 00000789 BE[E9210000]            	mov	esi, msg16Bits
  1069 0000078E 803D[E5220000]10        	cmp	byte [bps], 16
  1070 00000795 7405                    	je	short wsr_1
  1071 00000797 BE[D9210000]            	mov	esi, msg8Bits
  1072                                  wsr_1:
  1073                                  	sys	_msg, esi, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000079C 89F3                <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000079E B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000007A3 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000007A8 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000007AD CD40                <1>  int 40h
  1074                                  
  1075 000007AF BE[E2210000]            	mov	esi, msgMono
  1076 000007B4 803D[E4220000]01        	cmp	byte [stmo], 1
  1077 000007BB 7405                    	je	short wsr_2
  1078 000007BD BE[F3210000]            	mov	esi, msgStereo		
  1079                                  wsr_2:
  1080                                  	sys	_msg, esi, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000007C2 89F3                <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000007C4 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000007C9 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000007CE B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000007D3 CD40                <1>  int 40h
  1081 000007D5 C3                              retn
  1082                                  
  1083                                  write_ac97_pci_dev_info:
  1084                                  	; 06/06/2017
  1085                                  	; 03/06/2017
  1086                                  	; BUS/DEV/FN
  1087                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1088                                  	; DEV/VENDOR
  1089                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1090                                  
  1091 000007D6 8B35[61230000]          	mov	esi, [dev_vendor]
  1092 000007DC 89F0                    	mov	eax, esi
  1093 000007DE 0FB6D8                  	movzx	ebx, al
  1094 000007E1 88DA                    	mov	dl, bl
  1095 000007E3 80E30F                  	and	bl, 0Fh
  1096 000007E6 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1097 000007EC A2[41220000]            	mov	[msgVendorId+3], al
  1098 000007F1 88D3                    	mov	bl, dl
  1099 000007F3 C0EB04                  	shr	bl, 4
  1100 000007F6 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1101 000007FC A2[40220000]            	mov	[msgVendorId+2], al
  1102 00000801 88E3                    	mov	bl, ah
  1103 00000803 88DA                    	mov	dl, bl
  1104 00000805 80E30F                  	and	bl, 0Fh
  1105 00000808 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1106 0000080E A2[3F220000]            	mov	[msgVendorId+1], al
  1107 00000813 88D3                    	mov	bl, dl
  1108 00000815 C0EB04                  	shr	bl, 4
  1109 00000818 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1110 0000081E A2[3E220000]            	mov	[msgVendorId], al
  1111 00000823 C1E810                  	shr	eax, 16
  1112 00000826 88C3                    	mov	bl, al
  1113 00000828 88DA                    	mov	dl, bl
  1114 0000082A 80E30F                  	and	bl, 0Fh
  1115 0000082D 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1116 00000833 A2[52220000]            	mov	[msgDevId+3], al
  1117 00000838 88D3                    	mov	bl, dl
  1118 0000083A C0EB04                  	shr	bl, 4
  1119 0000083D 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1120 00000843 A2[51220000]            	mov	[msgDevId+2], al
  1121 00000848 88E3                    	mov	bl, ah
  1122 0000084A 88DA                    	mov	dl, bl
  1123 0000084C 80E30F                  	and	bl, 0Fh
  1124 0000084F 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1125 00000855 A2[50220000]            	mov	[msgDevId+1], al
  1126 0000085A 88D3                    	mov	bl, dl
  1127 0000085C C0EB04                  	shr	bl, 4
  1128 0000085F 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1129 00000865 A2[4F220000]            	mov	[msgDevId], al
  1130                                  
  1131 0000086A 8B35[65230000]          	mov	esi, [bus_dev_fn]
  1132 00000870 C1EE08                  	shr	esi, 8
  1133 00000873 6689F0                  	mov	ax, si
  1134 00000876 88C3                    	mov	bl, al
  1135 00000878 88DA                    	mov	dl, bl
  1136 0000087A 80E307                  	and	bl, 7 ; bit 0,1,2
  1137 0000087D 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1138 00000883 A2[76220000]            	mov	[msgFncNo+1], al
  1139 00000888 88D3                    	mov	bl, dl
  1140 0000088A C0EB03                  	shr	bl, 3
  1141 0000088D 88DA                    	mov	dl, bl
  1142 0000088F 80E30F                  	and	bl, 0Fh
  1143 00000892 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1144 00000898 A2[68220000]            	mov	[msgDevNo+1], al
  1145 0000089D 88D3                    	mov	bl, dl
  1146 0000089F C0EB04                  	shr	bl, 4
  1147 000008A2 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1148 000008A8 A2[67220000]            	mov	[msgDevNo], al
  1149 000008AD 88E3                    	mov	bl, ah
  1150 000008AF 88DA                    	mov	dl, bl
  1151 000008B1 80E30F                  	and	bl, 0Fh
  1152 000008B4 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1153 000008BA A2[5C220000]            	mov	[msgBusNo+1], al
  1154 000008BF 88D3                    	mov	bl, dl
  1155 000008C1 C0EB04                  	shr	bl, 4
  1156 000008C4 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1157 000008CA A2[5B220000]            	mov	[msgBusNo], al
  1158                                  
  1159 000008CF 66A1[69230000]          	mov	ax, [ac97_NamBar]
  1160 000008D5 88C3                    	mov	bl, al
  1161 000008D7 88DA                    	mov	dl, bl
  1162 000008D9 80E30F                  	and	bl, 0Fh
  1163 000008DC 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1164 000008E2 A2[85220000]            	mov	[msgNamBar+3], al
  1165 000008E7 88D3                    	mov	bl, dl
  1166 000008E9 C0EB04                  	shr	bl, 4
  1167 000008EC 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1168 000008F2 A2[84220000]            	mov	[msgNamBar+2], al
  1169 000008F7 88E3                    	mov	bl, ah
  1170 000008F9 88DA                    	mov	dl, bl
  1171 000008FB 80E30F                  	and	bl, 0Fh
  1172 000008FE 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1173 00000904 A2[83220000]            	mov	[msgNamBar+1], al
  1174 00000909 88D3                    	mov	bl, dl
  1175 0000090B C0EB04                  	shr	bl, 4
  1176 0000090E 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1177 00000914 A2[82220000]            	mov	[msgNamBar], al
  1178                                  
  1179 00000919 66A1[6B230000]          	mov	ax, [ac97_NabmBar]
  1180 0000091F 88C3                    	mov	bl, al
  1181 00000921 88DA                    	mov	dl, bl
  1182 00000923 80E30F                  	and	bl, 0Fh
  1183 00000926 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1184 0000092C A2[95220000]            	mov	[msgNabmBar+3], al
  1185 00000931 88D3                    	mov	bl, dl
  1186 00000933 C0EB04                  	shr	bl, 4
  1187 00000936 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1188 0000093C A2[94220000]            	mov	[msgNabmBar+2], al
  1189 00000941 88E3                    	mov	bl, ah
  1190 00000943 88DA                    	mov	dl, bl
  1191 00000945 80E30F                  	and	bl, 0Fh
  1192 00000948 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1193 0000094E A2[93220000]            	mov	[msgNabmBar+1], al
  1194 00000953 88D3                    	mov	bl, dl
  1195 00000955 C0EB04                  	shr	bl, 4
  1196 00000958 8A83[FC210000]          	mov	al, [ebx+hex_chars]
  1197 0000095E A2[92220000]            	mov	[msgNabmBar], al
  1198                                  
  1199 00000963 30E4                    	xor	ah, ah
  1200 00000965 A0[5F230000]            	mov	al, [ac97_int_ln_reg]
  1201 0000096A B10A                    	mov	cl, 10
  1202 0000096C F6F1                    	div	cl
  1203 0000096E 660105[9E220000]        	add	[msgIRQ], ax
  1204 00000975 20C0                    	and	al, al
  1205 00000977 750D                    	jnz	short _w_ac97imsg_
  1206 00000979 A0[9F220000]            	mov	al, [msgIRQ+1]
  1207 0000097E B420                    	mov	ah, ' '
  1208 00000980 66A3[9E220000]          	mov	[msgIRQ], ax
  1209                                  _w_ac97imsg_:
  1210                                  	sys	_msg, msgAC97Info, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000986 BB[0D220000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000098B B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000990 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000995 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 0000099A CD40                <1>  int 40h
  1211                                  
  1212 0000099C C3                              retn
  1213                                  
  1214                                  write_VRA_info:
  1215                                  	; 25/11/2023
  1216                                  	sys	_msg, msgVRAheader, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000099D BB[A3220000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000009A2 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000009A7 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000009AC B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000009B1 CD40                <1>  int 40h
  1217                                  ; 08/12/2024
  1218                                  %if 0
  1219                                  	cmp	byte [VRA], 0
  1220                                  	jna	short _w_VRAi_no
  1221                                  _w_VRAi_yes:
  1222                                  	sys	_msg, msgVRAyes, 255, 07h
  1223                                  	retn
  1224                                  %endif
  1225                                  _w_VRAi_no:
  1226                                  	sys	_msg, msgVRAno, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000009B3 BB[B1220000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000009B8 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000009BD BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000009C2 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000009C7 CD40                <1>  int 40h
  1227 000009C9 C3                      	retn
  1228                                  
  1229                                  ; 26/11/2023
  1230                                  ; 25/11/2023 - playwav6.s (32 bit registers, TRDOS 386 adaption)
  1231                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  1232                                  ; 14/11/2023
  1233                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1234                                  ; --------------------------------------------------------
  1235                                  
  1236                                  ;;Note:	At the end of every buffer load,
  1237                                  ;;	during buffer switch/swap, there will be discontinuity
  1238                                  ;;	between the last converted sample and the 1st sample
  1239                                  ;;	of the next buffer.
  1240                                  ;;	(like as a dot noises vaguely between normal sound samples)
  1241                                  ;;	-To avoid this defect, the 1st sample of
  1242                                  ;;	the next buffer may be read from the wav file but
  1243                                  ;;	the file pointer would need to be set to 1 sample back
  1244                                  ;;	again via seek system call. Time comsumption problem! -
  1245                                  ;;
  1246                                  ;;	Erdogan Tan - 15/11/2023
  1247                                  ;;
  1248                                  ;;	((If entire wav data would be loaded at once.. conversion
  1249                                  ;;	defect/noise would disappear.. but for DOS, to keep
  1250                                  ;;	64KB buffer limit is important also it is important
  1251                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1252                                  ;;	I have tested this program by using 2-30MB wav files.))
  1253                                  ;;
  1254                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1255                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1256                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1257                                  ;;			Realtek ALC850 codec.
  1258                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1259                                  
  1260                                  load_8khz_mono_8_bit:
  1261                                  	; 15/11/2023
  1262                                  	; 14/11/2023
  1263                                  	; 13/11/2023
  1264 000009CA F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1265                                  					; last of the file?
  1266 000009D1 7402                    	jz	short lff8m_0		; no
  1267 000009D3 F9                      	stc
  1268 000009D4 C3                      	retn
  1269                                  
  1270                                  lff8m_0:
  1271 000009D5 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1272                                          ;mov	edx, [loadsize]
  1273                                  
  1274                                  	; esi = buffer address
  1275                                  	;; edx = buffer size
  1276                                  
  1277                                  	; load file into memory
  1278                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000009DA 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000009E0 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000009E2 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000009E8 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000009ED CD40                <1>  int 40h
  1279 000009EF 7305                    	jnc	short lff8m_6
  1280 000009F1 E9AF000000              	jmp	lff8m_5  ; error !
  1281                                  
  1282                                  lff8m_6:
  1283 000009F6 BF[00300000]            	mov	edi, audio_buffer
  1284 000009FB 21C0                    	and	eax, eax
  1285 000009FD 0F8499000000            	jz	lff8_eof
  1286                                  
  1287 00000A03 89C1                    	mov	ecx, eax		; byte count
  1288                                  lff8m_1:
  1289 00000A05 AC                      	lodsb
  1290 00000A06 A2[F11F0000]            	mov	[previous_val], al
  1291 00000A0B 2C80                    	sub	al, 80h
  1292 00000A0D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1293 00000A11 66AB                    	stosw		; original sample (left channel)
  1294 00000A13 66AB                    	stosw		; original sample (right channel)
  1295                                  	;xor	eax, eax
  1296 00000A15 B080                    	mov	al, 80h
  1297 00000A17 49                      	dec	ecx
  1298 00000A18 7402                    	jz	short lff8m_2
  1299 00000A1A 8A06                    	mov	al, [esi]
  1300                                  lff8m_2:
  1301                                  	;mov	[next_val], ax
  1302 00000A1C 88C7                    	mov	bh, al	; [next_val]
  1303 00000A1E 8A25[F11F0000]          	mov	ah, [previous_val]
  1304 00000A24 00E0                    	add	al, ah	; [previous_val]
  1305 00000A26 D0D8                    	rcr	al, 1
  1306 00000A28 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  1307 00000A2A 00E0                    	add	al, ah	; [previous_val]
  1308 00000A2C D0D8                    	rcr	al, 1	
  1309 00000A2E 88C3                    	mov	bl, al 	; this is temporary interpolation value	
  1310 00000A30 00E0                    	add	al, ah	; [previous_val]
  1311 00000A32 D0D8                    	rcr	al, 1
  1312 00000A34 2C80                    	sub	al, 80h
  1313 00000A36 66C1E008                	shl	ax, 8	
  1314 00000A3A 66AB                    	stosw		; this is 1st interpolated sample (L)
  1315 00000A3C 66AB                    	stosw		; this is 1st interpolated sample (R)
  1316 00000A3E 88D8                    	mov	al, bl
  1317 00000A40 00D0                    	add	al, dl
  1318 00000A42 D0D8                    	rcr	al, 1
  1319 00000A44 2C80                    	sub	al, 80h
  1320 00000A46 66C1E008                	shl	ax, 8
  1321 00000A4A 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1322 00000A4C 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1323 00000A4E 88D0                    	mov	al, dl
  1324 00000A50 2C80                    	sub	al, 80h
  1325 00000A52 66C1E008                	shl	ax, 8
  1326 00000A56 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1327 00000A58 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1328                                  	;mov	al, [next_val]
  1329 00000A5A 88F8                    	mov	al, bh
  1330 00000A5C 00D0                    	add	al, dl
  1331 00000A5E D0D8                    	rcr	al, 1
  1332 00000A60 88C3                    	mov	bl, al	; this is temporary interpolation value
  1333 00000A62 00D0                    	add	al, dl
  1334 00000A64 D0D8                    	rcr	al, 1
  1335 00000A66 2C80                    	sub	al, 80h
  1336 00000A68 66C1E008                	shl	ax, 8
  1337 00000A6C 66AB                    	stosw		; this is 4th interpolated sample (L)
  1338 00000A6E 66AB                    	stosw		; this is 4th interpolated sample (R)
  1339                                  	;mov	al, [next_val]
  1340 00000A70 88F8                    	mov	al, bh
  1341 00000A72 00D8                    	add	al, bl
  1342 00000A74 D0D8                    	rcr	al, 1
  1343 00000A76 2C80                    	sub	al, 80h
  1344 00000A78 66C1E008                	shl	ax, 8
  1345 00000A7C 66AB                    	stosw		; this is 5th interpolated sample (L)
  1346 00000A7E 66AB                    	stosw		; this is 5th interpolated sample (R)
  1347                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1348 00000A80 09C9                    	or	ecx, ecx
  1349 00000A82 7581                    	jnz	short lff8m_1
  1350                                  
  1351                                  	; --------------
  1352                                  
  1353                                  lff8s_3:
  1354                                  lff8m_3:
  1355                                  lff8s2_3:
  1356                                  lff8m2_3:
  1357                                  lff16s_3:
  1358                                  lff16m_3:
  1359                                  lff16s2_3:
  1360                                  lff16m2_3:
  1361                                  lff24_3:
  1362                                  lff32_3:
  1363                                  lff44_3:
  1364                                  lff22_3:
  1365                                  lff11_3:
  1366                                  	; 08/12/2024 (BugFix)
  1367                                  	; 01/06/2024 (BugFix)
  1368 00000A84 8B0D[BC030000]          	mov	ecx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1369                                  	;shl	ecx, 1	; byte count ; Bug !
  1370                                  	; 08/12/2024
  1371 00000A8A 81C1[00300000]          	add	ecx, audio_buffer
  1372 00000A90 29F9                    	sub	ecx, edi
  1373 00000A92 7607                    	jna	short lff8m_4
  1374                                  	;inc	ecx
  1375 00000A94 C1E902                  	shr	ecx, 2
  1376 00000A97 31C0                    	xor	eax, eax ; fill (remain part of) buffer with zeros
  1377 00000A99 F3AB                    	rep	stosd
  1378                                  lff8m_4:
  1379                                  	; 01/06/2024 (BugFix)
  1380                                  	; cf=1 ; Bug !
  1381                                  	; 08/12/2024
  1382                                  	;clc
  1383 00000A9B C3                      	retn
  1384                                  
  1385                                  lff8_eof:
  1386                                  lff16_eof:
  1387                                  lff24_eof:
  1388                                  lff32_eof:
  1389                                  lff44_eof:
  1390                                  lff22_eof:
  1391                                  lff11_eof:
  1392                                  	; 15/11/2023
  1393 00000A9C C605[EC220000]01        	mov	byte [flags], ENDOFFILE
  1394 00000AA3 EBDF                    	jmp	short lff8m_3
  1395                                  
  1396                                  lff8s_5:
  1397                                  lff8m_5:
  1398                                  lff8s2_5:
  1399                                  lff8m2_5:
  1400                                  lff16s_5:
  1401                                  lff16m_5:
  1402                                  lff16s2_5:
  1403                                  lff16m2_5:
  1404                                  lff24_5:
  1405                                  lff32_5:
  1406                                  lff44_5:
  1407                                  lff22_5:
  1408                                  lff11_5:
  1409 00000AA5 B021                    	mov	al, '!'  ; error
  1410 00000AA7 E804FCFFFF              	call	tL0
  1411                                  	
  1412                                  	;jmp	short lff8m_3
  1413                                  	; 15/11/2023
  1414 00000AAC EBEE                    	jmp	lff8_eof
  1415                                  
  1416                                  	; --------------
  1417                                  
  1418                                  load_8khz_stereo_8_bit:
  1419                                  	; 15/11/2023
  1420                                  	; 14/11/2023
  1421                                  	; 13/11/2023
  1422 00000AAE F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1423                                  					; last of the file?
  1424 00000AB5 7402                    	jz	short lff8s_0		; no
  1425 00000AB7 F9                      	stc
  1426 00000AB8 C3                      	retn
  1427                                  
  1428                                  lff8s_0:
  1429 00000AB9 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1430                                          ;mov	edx, [loadsize]
  1431                                  
  1432                                  	; esi = buffer address
  1433                                  	;; edx = buffer size
  1434                                  
  1435                                  	; load file into memory
  1436                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000ABE 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000AC4 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000AC6 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000ACC B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000AD1 CD40                <1>  int 40h
  1437 00000AD3 72D0                    	jc	short lff8s_5 ; error !
  1438                                  
  1439 00000AD5 BF[00300000]            	mov	edi, audio_buffer
  1440                                  	
  1441 00000ADA D1E8                    	shr	eax, 1
  1442 00000ADC 74BE                    	jz	short lff8_eof
  1443                                  
  1444 00000ADE 89C1                    	mov	ecx, eax	; word count
  1445                                  lff8s_1:
  1446 00000AE0 AC                      	lodsb
  1447 00000AE1 A2[F11F0000]            	mov	[previous_val_l], al
  1448 00000AE6 2C80                    	sub	al, 80h
  1449 00000AE8 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1450 00000AEC 66AB                    	stosw		; original sample (L)
  1451 00000AEE AC                      	lodsb
  1452 00000AEF A2[F31F0000]            	mov	[previous_val_r], al
  1453 00000AF4 2C80                    	sub	al, 80h
  1454 00000AF6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1455 00000AFA 66AB                    	stosw		; original sample (R)
  1456                                  
  1457                                  	;xor	eax, eax
  1458 00000AFC 66B88080                	mov	ax, 8080h
  1459 00000B00 49                      	dec	ecx
  1460 00000B01 7403                    	jz	short lff8s_2
  1461                                  		; convert 8 bit sample to 16 bit sample
  1462 00000B03 668B06                  	mov	ax, [esi]
  1463                                  lff8s_2:
  1464 00000B06 A2[F51F0000]            	mov	[next_val_l], al
  1465 00000B0B 8825[F71F0000]          	mov	[next_val_r], ah
  1466 00000B11 8A25[F11F0000]          	mov	ah, [previous_val_l]
  1467 00000B17 00E0                    	add	al, ah
  1468 00000B19 D0D8                    	rcr	al, 1
  1469 00000B1B 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1470 00000B1D 00E0                    	add	al, ah
  1471 00000B1F D0D8                    	rcr	al, 1	
  1472 00000B21 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1473 00000B23 00E0                    	add	al, ah
  1474 00000B25 D0D8                    	rcr	al, 1
  1475 00000B27 2C80                    	sub	al, 80h
  1476 00000B29 66C1E008                	shl	ax, 8
  1477 00000B2D 66AB                    	stosw		; this is 1st interpolated sample (L)
  1478 00000B2F A0[F71F0000]            	mov	al, [next_val_r]
  1479 00000B34 8A25[F31F0000]          	mov	ah, [previous_val_r]
  1480 00000B3A 00E0                    	add	al, ah
  1481 00000B3C D0D8                    	rcr	al, 1
  1482 00000B3E 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1483 00000B40 00E0                    	add	al, ah
  1484 00000B42 D0D8                    	rcr	al, 1
  1485 00000B44 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1486 00000B46 00E0                    	add	al, ah
  1487 00000B48 D0D8                    	rcr	al, 1
  1488 00000B4A 2C80                    	sub	al, 80h
  1489 00000B4C 66C1E008                	shl	ax, 8
  1490 00000B50 66AB                    	stosw		; this is 1st interpolated sample (R)
  1491 00000B52 88D8                    	mov	al, bl
  1492 00000B54 00D0                    	add	al, dl
  1493 00000B56 D0D8                    	rcr	al, 1
  1494 00000B58 2C80                    	sub	al, 80h
  1495 00000B5A 66C1E008                	shl	ax, 8
  1496 00000B5E 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1497 00000B60 88F8                    	mov	al, bh
  1498 00000B62 00F0                    	add	al, dh
  1499 00000B64 D0D8                    	rcr	al, 1
  1500 00000B66 2C80                    	sub	al, 80h
  1501 00000B68 66C1E008                	shl	ax, 8
  1502 00000B6C 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1503 00000B6E 88D0                    	mov	al, dl
  1504 00000B70 2C80                    	sub	al, 80h
  1505 00000B72 66C1E008                	shl	ax, 8
  1506 00000B76 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1507 00000B78 88F0                    	mov	al, dh
  1508 00000B7A 2C80                    	sub	al, 80h
  1509 00000B7C 66C1E008                	shl	ax, 8
  1510 00000B80 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1511 00000B82 A0[F51F0000]            	mov	al, [next_val_l]
  1512 00000B87 00D0                    	add	al, dl
  1513 00000B89 D0D8                    	rcr	al, 1
  1514 00000B8B 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1515 00000B8D 00D0                    	add	al, dl
  1516 00000B8F D0D8                    	rcr	al, 1
  1517 00000B91 2C80                    	sub	al, 80h
  1518 00000B93 66C1E008                	shl	ax, 8
  1519 00000B97 66AB                    	stosw		; this is 4th interpolated sample (L)
  1520 00000B99 A0[F71F0000]            	mov	al, [next_val_r]
  1521 00000B9E 00F0                    	add	al, dh
  1522 00000BA0 D0D8                    	rcr	al, 1
  1523 00000BA2 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1524 00000BA4 00F0                    	add	al, dh
  1525 00000BA6 D0D8                    	rcr	al, 1
  1526 00000BA8 2C80                    	sub	al, 80h
  1527 00000BAA 66C1E008                	shl	ax, 8
  1528 00000BAE 66AB                    	stosw		; this is 4th interpolated sample (R)
  1529 00000BB0 A0[F51F0000]            	mov	al, [next_val_l]
  1530 00000BB5 00D8                    	add	al, bl
  1531 00000BB7 D0D8                    	rcr	al, 1
  1532 00000BB9 2C80                    	sub	al, 80h
  1533 00000BBB 66C1E008                	shl	ax, 8
  1534 00000BBF 66AB                    	stosw		; this is 5th interpolated sample (L)
  1535 00000BC1 A0[F71F0000]            	mov	al, [next_val_r]
  1536 00000BC6 00F8                    	add	al, bh
  1537 00000BC8 D0D8                    	rcr	al, 1
  1538 00000BCA 2C80                    	sub	al, 80h
  1539 00000BCC 66C1E008                	shl	ax, 8
  1540 00000BD0 66AB                    	stosw		; this is 5th interpolated sample (R)
  1541                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1542 00000BD2 E305                    	jecxz	lff8s_6
  1543 00000BD4 E907FFFFFF              	jmp	lff8s_1
  1544                                  lff8s_6:
  1545 00000BD9 E9A6FEFFFF              	jmp	lff8s_3
  1546                                  
  1547                                  load_8khz_mono_16_bit:
  1548                                  	; 13/11/2023
  1549 00000BDE F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1550                                  					; last of the file?
  1551 00000BE5 7402                    	jz	short lff8m2_0		; no
  1552 00000BE7 F9                      	stc
  1553 00000BE8 C3                      	retn
  1554                                  
  1555                                  lff8m2_0:
  1556 00000BE9 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1557                                          ;mov	edx, [loadsize]
  1558                                  
  1559                                  	; esi = buffer address
  1560                                  	;; edx = buffer size
  1561                                  
  1562                                  	; load file into memory
  1563                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000BEE 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000BF4 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000BF6 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000BFC B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000C01 CD40                <1>  int 40h
  1564 00000C03 0F82A0000000            	jc	lff8m2_7 ; error !
  1565                                  
  1566 00000C09 BF[00300000]            	mov	edi, audio_buffer
  1567                                  	
  1568 00000C0E D1E8                    	shr	eax, 1
  1569 00000C10 7505                    	jnz	short lff8m2_8
  1570 00000C12 E985FEFFFF              	jmp	lff8_eof
  1571                                  
  1572                                  lff8m2_8:
  1573 00000C17 89C1                    	mov	ecx, eax	; word count
  1574                                  lff8m2_1:
  1575 00000C19 66AD                    	lodsw
  1576 00000C1B 66AB                    	stosw		; original sample (left channel)
  1577 00000C1D 66AB                    	stosw		; original sample (right channel)
  1578 00000C1F 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1579 00000C22 66A3[F11F0000]          	mov	[previous_val], ax
  1580 00000C28 31C0                    	xor	eax, eax
  1581 00000C2A 49                      	dec	ecx
  1582 00000C2B 7403                    	jz	short lff8m2_2
  1583 00000C2D 668B06                  	mov	ax, [esi]
  1584                                  lff8m2_2:
  1585 00000C30 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  1586 00000C33 89C5                    	mov	ebp, eax	; [next_val]
  1587 00000C35 660305[F11F0000]        	add	ax, [previous_val]
  1588 00000C3C 66D1D8                  	rcr	ax, 1
  1589 00000C3F 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample
  1590 00000C41 660305[F11F0000]        	add	ax, [previous_val]
  1591 00000C48 66D1D8                  	rcr	ax, 1	; this is temporary interpolation value
  1592 00000C4B 89C3                    	mov	ebx, eax 		
  1593 00000C4D 660305[F11F0000]        	add	ax, [previous_val]
  1594 00000C54 66D1D8                  	rcr	ax, 1
  1595 00000C57 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1596 00000C5A 66AB                    	stosw		; this is 1st interpolated sample (L)
  1597 00000C5C 66AB                    	stosw		; this is 1st interpolated sample (R)
  1598 00000C5E 89D8                    	mov	eax, ebx
  1599 00000C60 6601D0                  	add	ax, dx
  1600 00000C63 66D1D8                  	rcr	ax, 1
  1601 00000C66 80EC80                  	sub	ah, 80h
  1602 00000C69 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1603 00000C6B 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1604 00000C6D 89D0                    	mov	eax, edx
  1605 00000C6F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1606 00000C72 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1607 00000C74 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1608 00000C76 89E8                    	mov	eax, ebp
  1609 00000C78 6601D0                  	add	ax, dx
  1610 00000C7B 66D1D8                  	rcr	ax, 1
  1611 00000C7E 89C3                    	mov	ebx, eax ; this is temporary interpolation value
  1612 00000C80 6601D0                  	add	ax, dx
  1613 00000C83 66D1D8                  	rcr	ax, 1
  1614 00000C86 80EC80                  	sub	ah, 80h
  1615 00000C89 66AB                    	stosw		; this is 4th interpolated sample (L)
  1616 00000C8B 66AB                    	stosw		; this is 4th interpolated sample (R)
  1617 00000C8D 89E8                    	mov	eax, ebp
  1618 00000C8F 6601D8                  	add	ax, bx
  1619 00000C92 66D1D8                  	rcr	ax, 1
  1620 00000C95 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1621 00000C98 66AB                    	stosw		; this is 5th interpolated sample (L)
  1622 00000C9A 66AB                    	stosw		; this is 5th interpolated sample (R)
  1623                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1624 00000C9C 09C9                    	or	ecx, ecx
  1625 00000C9E 0F8575FFFFFF            	jnz	lff8m2_1
  1626 00000CA4 E9DBFDFFFF              	jmp	lff8m2_3
  1627                                  
  1628                                  lff8m2_7:
  1629                                  lff8s2_7:
  1630 00000CA9 E9F7FDFFFF              	jmp	lff8m2_5  ; error
  1631                                  
  1632                                  load_8khz_stereo_16_bit:
  1633                                  	; 16/11/2023
  1634                                  	; 15/11/2023
  1635                                  	; 13/11/2023
  1636 00000CAE F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1637                                  					; last of the file?
  1638 00000CB5 7402                    	jz	short lff8s2_0		; no
  1639 00000CB7 F9                      	stc
  1640 00000CB8 C3                      	retn
  1641                                  
  1642                                  lff8s2_0:
  1643 00000CB9 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1644                                          ;mov	edx, [loadsize]
  1645                                  
  1646                                  	; esi = buffer address
  1647                                  	;; edx = buffer size
  1648                                  
  1649                                  	; load file into memory
  1650                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000CBE 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000CC4 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000CC6 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000CCC B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000CD1 CD40                <1>  int 40h
  1651 00000CD3 72D4                    	jc	short lff8s2_7 ; error !
  1652                                  
  1653 00000CD5 BF[00300000]            	mov	edi, audio_buffer
  1654                                  	
  1655 00000CDA C1E802                  	shr	eax, 2
  1656 00000CDD 7505                    	jnz	short lff8s2_8
  1657 00000CDF E9B8FDFFFF              	jmp	lff8_eof
  1658                                  
  1659                                  lff8s2_8:
  1660 00000CE4 89C1                    	mov	ecx, eax ; dword count
  1661                                  lff8s2_1:
  1662 00000CE6 66AD                    	lodsw
  1663 00000CE8 66AB                    	stosw		; original sample (L)
  1664                                  	; 15/11/2023
  1665 00000CEA 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1666 00000CED 66A3[F11F0000]          	mov	[previous_val_l], ax
  1667 00000CF3 66AD                    	lodsw
  1668 00000CF5 66AB                    	stosw		; original sample (R)
  1669 00000CF7 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1670 00000CFA 66A3[F31F0000]          	mov	[previous_val_r], ax
  1671 00000D00 31D2                    	xor	edx, edx
  1672 00000D02 31C0                    	xor	eax, eax
  1673                                  	; 16/11/2023
  1674 00000D04 49                      	dec	ecx
  1675 00000D05 7407                    	jz	short lff8s2_2
  1676 00000D07 668B06                  	mov	ax, [esi]
  1677 00000D0A 668B5602                	mov	dx, [esi+2]
  1678                                  lff8s2_2:
  1679 00000D0E 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1680 00000D11 66A3[F51F0000]          	mov	[next_val_l], ax
  1681 00000D17 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  1682 00000D1A 668915[F71F0000]        	mov	[next_val_r], dx
  1683 00000D21 660305[F11F0000]        	add	ax, [previous_val_l]
  1684 00000D28 66D1D8                  	rcr	ax, 1
  1685 00000D2B 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample (L)
  1686 00000D2D 660305[F11F0000]        	add	ax, [previous_val_l]
  1687 00000D34 66D1D8                  	rcr	ax, 1	
  1688 00000D37 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1689 00000D39 660305[F11F0000]        	add	ax, [previous_val_l]
  1690 00000D40 66D1D8                  	rcr	ax, 1
  1691 00000D43 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1692 00000D46 66AB                    	stosw		; this is 1st interpolated sample (L)
  1693 00000D48 66A1[F71F0000]          	mov	ax, [next_val_r]
  1694 00000D4E 660305[F31F0000]        	add	ax, [previous_val_r]
  1695 00000D55 66D1D8                  	rcr	ax, 1
  1696 00000D58 89C5                    	mov	ebp, eax ; this is interpolated middle (3th) sample (R)
  1697 00000D5A 660305[F31F0000]        	add	ax, [previous_val_r]
  1698 00000D61 66D1D8                  	rcr	ax, 1
  1699 00000D64 50                      	push	eax ; *	; this is temporary interpolation value (R)
  1700 00000D65 660305[F31F0000]        	add	ax, [previous_val_r]
  1701 00000D6C 66D1D8                  	rcr	ax, 1
  1702 00000D6F 80EC80                  	sub	ah, 80h
  1703 00000D72 66AB                    	stosw		; this is 1st interpolated sample (R)
  1704 00000D74 89D8                    	mov	eax, ebx
  1705 00000D76 6601D0                  	add	ax, dx
  1706 00000D79 66D1D8                  	rcr	ax, 1
  1707 00000D7C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1708 00000D7F 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1709 00000D81 58                      	pop	eax ; *
  1710 00000D82 6601E8                  	add	ax, bp
  1711 00000D85 66D1D8                  	rcr	ax, 1
  1712 00000D88 80EC80                  	sub	ah, 80h
  1713 00000D8B 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1714 00000D8D 89D0                    	mov	eax, edx
  1715 00000D8F 80EC80                  	sub	ah, 80h
  1716 00000D92 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1717 00000D94 89E8                    	mov	eax, ebp
  1718 00000D96 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1719 00000D99 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1720 00000D9B 66A1[F51F0000]          	mov	ax, [next_val_l]
  1721 00000DA1 6601D0                  	add	ax, dx
  1722 00000DA4 66D1D8                  	rcr	ax, 1
  1723 00000DA7 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1724 00000DA9 6601D0                  	add	ax, dx
  1725 00000DAC 66D1D8                  	rcr	ax, 1
  1726 00000DAF 80EC80                  	sub	ah, 80h
  1727 00000DB2 66AB                    	stosw		; this is 4th interpolated sample (L)
  1728 00000DB4 66A1[F71F0000]          	mov	ax, [next_val_r]
  1729 00000DBA 6601E8                  	add	ax, bp
  1730 00000DBD 66D1D8                  	rcr	ax, 1
  1731 00000DC0 50                      	push	eax ; ** ; this is temporary interpolation value (R)
  1732 00000DC1 6601E8                  	add	ax, bp
  1733 00000DC4 66D1D8                  	rcr	ax, 1
  1734 00000DC7 80EC80                  	sub	ah, 80h
  1735 00000DCA 66AB                    	stosw		; this is 4th interpolated sample (R)
  1736 00000DCC 66A1[F51F0000]          	mov	ax, [next_val_l]
  1737 00000DD2 6601D8                  	add	ax, bx
  1738 00000DD5 66D1D8                  	rcr	ax, 1
  1739 00000DD8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1740 00000DDB 66AB                    	stosw		; this is 5th interpolated sample (L)
  1741 00000DDD 58                      	pop	eax ; **
  1742 00000DDE 660305[F71F0000]        	add	ax, [next_val_r]
  1743 00000DE5 66D1D8                  	rcr	ax, 1
  1744 00000DE8 80EC80                  	sub	ah, 80h
  1745 00000DEB 66AB                    	stosw		; this is 5th interpolated sample (R)
  1746                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1747 00000DED E305                    	jecxz	lff8_s2_9
  1748 00000DEF E9F2FEFFFF              	jmp	lff8s2_1
  1749                                  lff8_s2_9:
  1750 00000DF4 E98BFCFFFF              	jmp	lff8s2_3
  1751                                  
  1752                                  ; .....................
  1753                                  
  1754                                  load_16khz_mono_8_bit:
  1755                                  	; 14/11/2023
  1756                                  	; 13/11/2023
  1757 00000DF9 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1758                                  					; last of the file?
  1759 00000E00 7402                    	jz	short lff16m_0		; no
  1760 00000E02 F9                      	stc
  1761 00000E03 C3                      	retn
  1762                                  
  1763                                  lff16m_0:
  1764 00000E04 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1765                                          ;mov	edx, [loadsize]
  1766                                  
  1767                                  	; esi = buffer address
  1768                                  	;; edx = buffer size
  1769                                  
  1770                                  	; load file into memory
  1771                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000E09 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000E0F 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000E11 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000E17 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000E1C CD40                <1>  int 40h
  1772 00000E1E 7253                    	jc	short lff16m_7 ; error !
  1773                                  
  1774 00000E20 BF[00300000]            	mov	edi, audio_buffer
  1775                                  	
  1776 00000E25 21C0                    	and	eax, eax
  1777 00000E27 7505                    	jnz	short lff16m_8
  1778 00000E29 E96EFCFFFF              	jmp	lff16_eof
  1779                                  
  1780                                  lff16m_8:
  1781 00000E2E 89C1                    	mov	ecx, eax		; byte count
  1782                                  lff16m_1:
  1783 00000E30 AC                      	lodsb
  1784                                  	;mov	[previous_val], al
  1785 00000E31 88C3                    	mov	bl, al
  1786 00000E33 2C80                    	sub	al, 80h
  1787 00000E35 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1788 00000E39 66AB                    	stosw		; original sample (left channel)
  1789 00000E3B 66AB                    	stosw		; original sample (right channel)
  1790                                  	;xor	ax, ax
  1791                                  	; 14/11/22023
  1792 00000E3D B080                    	mov	al, 80h
  1793 00000E3F 49                      	dec	ecx
  1794 00000E40 7402                    	jz	short lff16m_2
  1795 00000E42 8A06                    	mov	al, [esi]
  1796                                  lff16m_2:
  1797                                  	;mov	[next_val], al
  1798 00000E44 88C7                    	mov	bh, al
  1799                                  	;add	al, [previous_val]
  1800 00000E46 00D8                    	add	al, bl
  1801 00000E48 D0D8                    	rcr	al, 1
  1802 00000E4A 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  1803                                  	;add	al, [previous_val]
  1804 00000E4C 00D8                    	add	al, bl
  1805 00000E4E D0D8                    	rcr	al, 1
  1806 00000E50 2C80                    	sub	al, 80h
  1807 00000E52 66C1E008                	shl	ax, 8
  1808 00000E56 66AB                    	stosw		; this is 1st interpolated sample (L)
  1809 00000E58 66AB                    	stosw		; this is 1st interpolated sample (R)
  1810                                  	;mov	al, [next_val]
  1811 00000E5A 88F8                    	mov	al, bh
  1812 00000E5C 00D0                    	add	al, dl
  1813 00000E5E D0D8                    	rcr	al, 1
  1814 00000E60 2C80                    	sub	al, 80h
  1815 00000E62 66C1E008                	shl	ax, 8
  1816 00000E66 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1817 00000E68 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1818                                  	
  1819                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1820 00000E6A 09C9                    	or	ecx, ecx
  1821 00000E6C 75C2                    	jnz	short lff16m_1
  1822 00000E6E E911FCFFFF              	jmp	lff16m_3
  1823                                  
  1824                                  lff16m_7:
  1825                                  lff16s_7:
  1826 00000E73 E92DFCFFFF              	jmp	lff16m_5  ; error
  1827                                  
  1828                                  load_16khz_stereo_8_bit:
  1829                                  	; 14/11/2023
  1830                                  	; 13/11/2023
  1831 00000E78 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1832                                  					; last of the file?
  1833 00000E7F 7402                    	jz	short lff16s_0		; no
  1834 00000E81 F9                      	stc
  1835 00000E82 C3                      	retn
  1836                                  
  1837                                  lff16s_0:
  1838 00000E83 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1839                                          ;mov	edx, [loadsize]
  1840                                  
  1841                                  	; esi = buffer address
  1842                                  	;; edx = buffer size
  1843                                  
  1844                                  	; load file into memory
  1845                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000E88 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000E8E 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000E90 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000E96 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000E9B CD40                <1>  int 40h
  1846 00000E9D 72D4                    	jc	short lff16s_7 ; error !
  1847                                  
  1848 00000E9F BF[00300000]            	mov	edi, audio_buffer
  1849                                  	
  1850 00000EA4 D1E8                    	shr	eax, 1
  1851 00000EA6 7505                    	jnz	short lff16s_8
  1852 00000EA8 E9EFFBFFFF              	jmp	lff16_eof
  1853                                  
  1854                                  lff16s_8:
  1855 00000EAD 89C1                    	mov	ecx, eax	; word count
  1856                                  lff16s_1:
  1857 00000EAF AC                      	lodsb
  1858 00000EB0 A2[F11F0000]            	mov	[previous_val_l], al
  1859 00000EB5 2C80                    	sub	al, 80h
  1860 00000EB7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1861 00000EBB 66AB                    	stosw		; original sample (L)
  1862 00000EBD AC                      	lodsb
  1863 00000EBE A2[F31F0000]            	mov	[previous_val_r], al
  1864 00000EC3 2C80                    	sub	al, 80h
  1865 00000EC5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1866 00000EC9 66AB                    	stosw		; original sample (R)
  1867                                  
  1868                                  	;xor	eax, eax
  1869 00000ECB 66B88080                	mov	ax, 8080h
  1870 00000ECF 49                      	dec	ecx
  1871 00000ED0 7403                    	jz	short lff16s_2
  1872                                  		; convert 8 bit sample to 16 bit sample
  1873 00000ED2 668B06                  	mov	ax, [esi]
  1874                                  lff16s_2:
  1875                                  	;mov	[next_val_l], al
  1876                                  	;mov	[next_val_r], ah
  1877 00000ED5 89C3                    	mov	ebx, eax
  1878 00000ED7 0205[F11F0000]          	add	al, [previous_val_l]
  1879 00000EDD D0D8                    	rcr	al, 1
  1880 00000EDF 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  1881 00000EE1 0205[F11F0000]          	add	al, [previous_val_l]
  1882 00000EE7 D0D8                    	rcr	al, 1
  1883 00000EE9 2C80                    	sub	al, 80h
  1884 00000EEB 66C1E008                	shl	ax, 8
  1885 00000EEF 66AB                    	stosw		; this is 1st interpolated sample (L)
  1886 00000EF1 88F8                    	mov	al, bh	; [next_val_r]
  1887 00000EF3 0205[F31F0000]          	add	al, [previous_val_r]
  1888 00000EF9 D0D8                    	rcr	al, 1
  1889 00000EFB 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  1890 00000EFD 0205[F31F0000]          	add	al, [previous_val_r]
  1891 00000F03 D0D8                    	rcr	al, 1
  1892 00000F05 2C80                    	sub	al, 80h
  1893 00000F07 66C1E008                	shl	ax, 8
  1894 00000F0B 66AB                    	stosw		; this is 1st interpolated sample (R)
  1895 00000F0D 88D0                    	mov	al, dl
  1896 00000F0F 00D8                    	add	al, bl	; [next_val_l]
  1897 00000F11 D0D8                    	rcr	al, 1
  1898 00000F13 2C80                    	sub	al, 80h
  1899 00000F15 66C1E008                	shl	ax, 8
  1900 00000F19 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1901 00000F1B 88F0                    	mov	al, dh
  1902 00000F1D 00F8                    	add	al, bh	; [next_val_r]
  1903 00000F1F D0D8                    	rcr	al, 1
  1904 00000F21 2C80                    	sub	al, 80h
  1905 00000F23 66C1E008                	shl	ax, 8
  1906 00000F27 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1907                                  	
  1908                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1909 00000F29 09C9                    	or	ecx, ecx
  1910 00000F2B 7582                    	jnz	short lff16s_1
  1911 00000F2D E952FBFFFF              	jmp	lff16s_3
  1912                                  
  1913                                  load_16khz_mono_16_bit:
  1914                                  	; 15/11/2023
  1915                                  	; 13/11/2023
  1916 00000F32 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1917                                  					; last of the file?
  1918 00000F39 7402                    	jz	short lff16m2_0		; no
  1919 00000F3B F9                      	stc
  1920 00000F3C C3                      	retn
  1921                                  
  1922                                  lff16m2_0:
  1923 00000F3D BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1924                                          ;mov	edx, [loadsize]
  1925                                  
  1926                                  	; esi = buffer address
  1927                                  	;; edx = buffer size
  1928                                  
  1929                                  	; load file into memory
  1930                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000F42 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000F48 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000F4A 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000F50 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000F55 CD40                <1>  int 40h
  1931 00000F57 7255                    	jc	short lff16m2_7 ; error !
  1932                                  
  1933 00000F59 BF[00300000]            	mov	edi, audio_buffer
  1934                                  	
  1935 00000F5E D1E8                    	shr	eax, 1
  1936 00000F60 7505                    	jnz	short lff16m2_8
  1937 00000F62 E935FBFFFF              	jmp	lff16_eof
  1938                                  
  1939                                  lff16m2_8:
  1940 00000F67 89C1                    	mov	ecx, eax  ; word count
  1941                                  lff16m2_1:
  1942 00000F69 66AD                    	lodsw
  1943 00000F6B 66AB                    	stosw		; original sample (left channel)
  1944 00000F6D 66AB                    	stosw		; original sample (right channel)
  1945 00000F6F 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  1946                                  	;mov	[previous_val], ax
  1947 00000F72 89C3                    	mov	ebx, eax	
  1948 00000F74 31C0                    	xor	eax, eax
  1949 00000F76 49                      	dec	ecx
  1950 00000F77 7403                    	jz	short lff16m2_2
  1951 00000F79 668B06                  	mov	ax, [esi]
  1952                                  lff16m2_2:
  1953 00000F7C 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  1954 00000F7F 89C5                    	mov	ebp, eax	; [next_val]
  1955                                  	;add	ax, [previous_val]
  1956 00000F81 6601D8                  	add	ax, bx
  1957 00000F84 66D1D8                  	rcr	ax, 1
  1958 00000F87 89C2                    	mov	edx, eax ; this is temporary interpolation value
  1959                                  	;add	ax, [previous_val]
  1960 00000F89 6601D8                  	add	ax, bx
  1961 00000F8C 66D1D8                  	rcr	ax, 1
  1962 00000F8F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1963 00000F92 66AB                    	stosw		; this is 1st interpolated sample (L)
  1964 00000F94 66AB                    	stosw		; this is 1st interpolated sample (R)
  1965 00000F96 89E8                    	mov	eax, ebp 
  1966 00000F98 6601D0                  	add	ax, dx
  1967 00000F9B 66D1D8                  	rcr	ax, 1
  1968 00000F9E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1969 00000FA1 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1970 00000FA3 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1971                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1972 00000FA5 09C9                    	or	ecx, ecx
  1973 00000FA7 75C0                    	jnz	short lff16m2_1
  1974 00000FA9 E9D6FAFFFF              	jmp	lff16m2_3
  1975                                  
  1976                                  lff16m2_7:
  1977                                  lff16s2_7:
  1978 00000FAE E9F2FAFFFF              	jmp	lff16m2_5  ; error
  1979                                  
  1980                                  load_16khz_stereo_16_bit:
  1981                                  	; 16/11/2023
  1982                                  	; 15/11/2023
  1983                                  	; 13/11/2023
  1984 00000FB3 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1985                                  					; last of the file?
  1986 00000FBA 7402                    	jz	short lff16s2_0		; no
  1987 00000FBC F9                      	stc
  1988 00000FBD C3                      	retn
  1989                                  
  1990                                  lff16s2_0:
  1991 00000FBE BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1992                                          ;mov	edx, [loadsize]
  1993                                  
  1994                                  	; esi = buffer address
  1995                                  	;; edx = buffer size
  1996                                  
  1997                                  	; load file into memory
  1998                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000FC3 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000FC9 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000FCB 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000FD1 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000FD6 CD40                <1>  int 40h
  1999 00000FD8 72D4                    	jc	short lff16s2_7 ; error !
  2000                                  
  2001 00000FDA BF[00300000]            	mov	edi, audio_buffer
  2002                                  	
  2003 00000FDF C1E802                  	shr	eax, 2
  2004 00000FE2 7505                    	jnz	short lff16s2_8
  2005 00000FE4 E9B3FAFFFF              	jmp	lff16_eof
  2006                                  
  2007                                  lff16s2_8:
  2008 00000FE9 89C1                    	mov	ecx, eax  ; dword count
  2009                                  lff16s2_1:
  2010 00000FEB 66AD                    	lodsw
  2011 00000FED 66AB                    	stosw		; original sample (L)
  2012 00000FEF 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2013 00000FF2 66A3[F11F0000]          	mov	[previous_val_l], ax
  2014 00000FF8 66AD                    	lodsw
  2015 00000FFA 66AB                    	stosw		; original sample (R)
  2016 00000FFC 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2017 00000FFF 66A3[F31F0000]          	mov	[previous_val_r], ax
  2018 00001005 31D2                    	xor	edx, edx
  2019 00001007 31C0                    	xor	eax, eax
  2020                                  	; 16/11/2023
  2021 00001009 49                      	dec	ecx
  2022 0000100A 7407                    	jz	short lff16s2_2
  2023 0000100C 668B06                  	mov	ax, [esi]
  2024 0000100F 668B5602                	mov	dx, [esi+2]
  2025                                  lff16s2_2:
  2026 00001013 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2027                                  	;mov	[next_val_l], ax
  2028 00001016 89C5                    	mov	ebp, eax
  2029 00001018 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2030 0000101B 668915[F71F0000]        	mov	[next_val_r], dx
  2031 00001022 660305[F11F0000]        	add	ax, [previous_val_l]
  2032 00001029 66D1D8                  	rcr	ax, 1
  2033 0000102C 89C2                    	mov	edx, eax ; this is temporary interpolation value (L)
  2034 0000102E 660305[F11F0000]        	add	ax, [previous_val_l]
  2035 00001035 66D1D8                  	rcr	ax, 1
  2036 00001038 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2037 0000103B 66AB                    	stosw		; this is 1st interpolated sample (L)
  2038 0000103D 66A1[F71F0000]          	mov	ax, [next_val_r]
  2039 00001043 660305[F31F0000]        	add	ax, [previous_val_r]
  2040 0000104A 66D1D8                  	rcr	ax, 1
  2041 0000104D 89C3                    	mov	ebx, eax ; this is temporary interpolation value (R)
  2042 0000104F 660305[F31F0000]        	add	ax, [previous_val_r]
  2043 00001056 66D1D8                  	rcr	ax, 1
  2044 00001059 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2045 0000105C 66AB                    	stosw		; this is 1st interpolated sample (R)
  2046                                  	;mov	ax, [next_val_l]
  2047 0000105E 89E8                    	mov	eax, ebp
  2048 00001060 6601D0                  	add	ax, dx
  2049 00001063 66D1D8                  	rcr	ax, 1
  2050 00001066 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2051 00001069 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2052 0000106B 66A1[F71F0000]          	mov	ax, [next_val_r]
  2053 00001071 6601D8                  	add	ax, bx
  2054 00001074 66D1D8                  	rcr	ax, 1
  2055 00001077 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2056 0000107A 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  2057                                  	
  2058                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2059 0000107C 09C9                    	or	ecx, ecx
  2060 0000107E 0F8567FFFFFF            	jnz	lff16s2_1
  2061 00001084 E9FBF9FFFF              	jmp	lff16s2_3
  2062                                  
  2063                                  ; .....................
  2064                                  
  2065                                  load_24khz_mono_8_bit:
  2066                                  	; 15/11/2023
  2067 00001089 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2068                                  					; last of the file?
  2069 00001090 7402                    	jz	short lff24m_0		; no
  2070 00001092 F9                      	stc
  2071 00001093 C3                      	retn
  2072                                  
  2073                                  lff24m_0:
  2074 00001094 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2075                                          ;mov	edx, [loadsize]
  2076                                  
  2077                                  	; esi = buffer address
  2078                                  	;; edx = buffer size
  2079                                  
  2080                                  	; load file into memory
  2081                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001099 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000109F 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000010A1 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000010A7 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000010AC CD40                <1>  int 40h
  2082 000010AE 723B                    	jc	short lff24m_7 ; error !
  2083                                  
  2084 000010B0 BF[00300000]            	mov	edi, audio_buffer
  2085                                  	
  2086 000010B5 21C0                    	and	eax, eax
  2087 000010B7 7505                    	jnz	short lff24m_8
  2088 000010B9 E9DEF9FFFF              	jmp	lff24_eof
  2089                                  
  2090                                  lff24m_8:
  2091 000010BE 89C1                    	mov	ecx, eax	; byte count
  2092                                  lff24m_1:
  2093 000010C0 AC                      	lodsb
  2094                                  	;mov	[previous_val], al
  2095 000010C1 88C3                    	mov	bl, al
  2096 000010C3 2C80                    	sub	al, 80h
  2097 000010C5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2098 000010C9 66AB                    	stosw		; original sample (left channel)
  2099 000010CB 66AB                    	stosw		; original sample (right channel)
  2100                                  	;xor	eax, eax
  2101 000010CD B080                    	mov	al, 80h
  2102 000010CF 49                      	dec	ecx
  2103 000010D0 7402                    	jz	short lff24m_2
  2104 000010D2 8A06                    	mov	al, [esi]
  2105                                  lff24m_2:
  2106                                  	;;mov	[next_val], al
  2107                                  	;mov	bh, al
  2108                                  	;add	al, [previous_val]
  2109 000010D4 00D8                    	add	al, bl
  2110 000010D6 D0D8                    	rcr	al, 1
  2111 000010D8 2C80                    	sub	al, 80h
  2112 000010DA 66C1E008                	shl	ax, 8
  2113 000010DE 66AB                    	stosw		; this is interpolated sample (L)
  2114 000010E0 66AB                    	stosw		; this is interpolated sample (R)
  2115                                  	
  2116                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2117 000010E2 09C9                    	or	ecx, ecx
  2118 000010E4 75DA                    	jnz	short lff24m_1
  2119 000010E6 E999F9FFFF              	jmp	lff24_3
  2120                                  
  2121                                  lff24m_7:
  2122                                  lff24s_7:
  2123 000010EB E9B5F9FFFF              	jmp	lff24_5  ; error
  2124                                  
  2125                                  load_24khz_stereo_8_bit:
  2126                                  	; 15/11/2023
  2127 000010F0 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2128                                  					; last of the file?
  2129 000010F7 7402                    	jz	short lff24s_0		; no
  2130 000010F9 F9                      	stc
  2131 000010FA C3                      	retn
  2132                                  
  2133                                  lff24s_0:
  2134 000010FB BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2135                                          ;mov	edx, [loadsize]
  2136                                  
  2137                                  	; esi = buffer address
  2138                                  	;; edx = buffer size
  2139                                  
  2140                                  	; load file into memory
  2141                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001100 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001106 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001108 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000110E B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001113 CD40                <1>  int 40h
  2142 00001115 72D4                    	jc	short lff24s_7 ; error !
  2143                                  
  2144 00001117 BF[00300000]            	mov	edi, audio_buffer
  2145                                  	
  2146 0000111C D1E8                    	shr	eax, 1
  2147 0000111E 7505                    	jnz	short lff24s_8
  2148 00001120 E977F9FFFF              	jmp	lff24_eof
  2149                                  
  2150                                  lff24s_8:
  2151 00001125 89C1                    	mov	ecx, eax  ; word count
  2152                                  lff24s_1:
  2153 00001127 AC                      	lodsb
  2154 00001128 A2[F11F0000]            	mov	[previous_val_l], al
  2155 0000112D 2C80                    	sub	al, 80h
  2156 0000112F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2157 00001133 66AB                    	stosw		; original sample (L)
  2158 00001135 AC                      	lodsb
  2159 00001136 A2[F31F0000]            	mov	[previous_val_r], al
  2160 0000113B 2C80                    	sub	al, 80h
  2161 0000113D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2162 00001141 66AB                    	stosw		; original sample (R)
  2163                                  
  2164                                  	;xor	eax, eax
  2165 00001143 66B88080                	mov	ax, 8080h
  2166 00001147 49                      	dec	ecx
  2167 00001148 7403                    	jz	short lff24s_2
  2168                                  		; convert 8 bit sample to 16 bit sample
  2169 0000114A 668B06                  	mov	ax, [esi]
  2170                                  lff24s_2:
  2171                                  	;;mov	[next_val_l], al
  2172                                  	;;mov	[next_val_r], ah
  2173                                  	;mov	bx, ax
  2174 0000114D 88E7                    	mov	bh, ah
  2175 0000114F 0205[F11F0000]          	add	al, [previous_val_l]
  2176 00001155 D0D8                    	rcr	al, 1
  2177                                  	;mov	dl, al
  2178 00001157 2C80                    	sub	al, 80h
  2179 00001159 66C1E008                	shl	ax, 8
  2180 0000115D 66AB                    	stosw		; this is interpolated sample (L)
  2181 0000115F 88F8                    	mov	al, bh	; [next_val_r]
  2182 00001161 0205[F31F0000]          	add	al, [previous_val_r]
  2183 00001167 D0D8                    	rcr	al, 1
  2184                                  	;mov	dh, al
  2185 00001169 2C80                    	sub	al, 80h
  2186 0000116B 66C1E008                	shl	ax, 8
  2187 0000116F 66AB                    	stosw		; this is interpolated sample (R)
  2188                                  		
  2189                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2190 00001171 09C9                    	or	ecx, ecx
  2191 00001173 75B2                    	jnz	short lff24s_1
  2192 00001175 E90AF9FFFF              	jmp	lff24_3
  2193                                  
  2194                                  load_24khz_mono_16_bit:
  2195                                  	; 15/11/2023
  2196 0000117A F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2197                                  					; last of the file?
  2198 00001181 7402                    	jz	short lff24m2_0		; no
  2199 00001183 F9                      	stc
  2200 00001184 C3                      	retn
  2201                                  
  2202                                  lff24m2_0:
  2203 00001185 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2204                                          ;mov	edx, [loadsize]
  2205                                  
  2206                                  	; esi = buffer address
  2207                                  	;; edx = buffer size
  2208                                  
  2209                                  	; load file into memory
  2210                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000118A 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001190 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001192 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001198 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000119D CD40                <1>  int 40h
  2211 0000119F 7237                    	jc	short lff24m2_7 ; error !
  2212                                  
  2213 000011A1 BF[00300000]            	mov	edi, audio_buffer
  2214                                  	
  2215 000011A6 D1E8                    	shr	eax, 1
  2216 000011A8 7505                    	jnz	short lff24m2_8
  2217 000011AA E9EDF8FFFF              	jmp	lff24_eof
  2218                                  
  2219                                  lff24m2_8:
  2220 000011AF 89C1                    	mov	ecx, eax  ; word count
  2221                                  lff24m2_1:
  2222 000011B1 66AD                    	lodsw
  2223 000011B3 66AB                    	stosw		; original sample (left channel)
  2224 000011B5 66AB                    	stosw		; original sample (right channel)
  2225 000011B7 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2226                                  	;mov	[previous_val], ax
  2227                                  	;mov	ebx, eax	
  2228                                  	;xor	eax, eax
  2229 000011BA 31DB                    	xor	ebx, ebx
  2230 000011BC 49                      	dec	ecx
  2231 000011BD 7403                    	jz	short lff24m2_2
  2232                                  	;mov	ax, [esi]
  2233 000011BF 668B1E                  	mov	bx, [esi]
  2234                                  lff24m2_2:
  2235                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2236                                  	;mov	ebp, eax	; [next_val]
  2237                                  	;add	ax, [previous_val]
  2238                                  	; ax = [previous_val]
  2239                                  	; bx = [next_val]
  2240 000011C2 6601D8                  	add	ax, bx
  2241 000011C5 66D1D8                  	rcr	ax, 1
  2242 000011C8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2243 000011CB 66AB                    	stosw		; this is interpolated sample (L)
  2244 000011CD 66AB                    	stosw		; this is interpolated sample (R)
  2245                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2246 000011CF 09C9                    	or	ecx, ecx
  2247 000011D1 75DE                    	jnz	short lff24m2_1
  2248 000011D3 E9ACF8FFFF              	jmp	lff24_3
  2249                                  
  2250                                  lff24m2_7:
  2251                                  lff24s2_7:
  2252 000011D8 E9C8F8FFFF              	jmp	lff24_5  ; error
  2253                                  
  2254                                  load_24khz_stereo_16_bit:
  2255                                  	; 16/11/2023
  2256                                  	; 15/11/2023
  2257 000011DD F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2258                                  					; last of the file?
  2259 000011E4 7402                    	jz	short lff24s2_0		; no
  2260 000011E6 F9                      	stc
  2261 000011E7 C3                      	retn
  2262                                  
  2263                                  lff24s2_0:
  2264 000011E8 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2265                                          ;mov	edx, [loadsize]
  2266                                  
  2267                                  	; esi = buffer address
  2268                                  	;; edx = buffer size
  2269                                  
  2270                                  	; load file into memory
  2271                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000011ED 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000011F3 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000011F5 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000011FB B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001200 CD40                <1>  int 40h
  2272 00001202 72D4                    	jc	short lff24s2_7 ; error !
  2273                                  
  2274 00001204 BF[00300000]            	mov	edi, audio_buffer
  2275                                  	
  2276 00001209 C1E802                  	shr	eax, 2
  2277 0000120C 7505                    	jnz	short lff24s2_8
  2278 0000120E E989F8FFFF              	jmp	lff24_eof
  2279                                  
  2280                                  lff24s2_8:
  2281 00001213 89C1                    	mov	ecx, eax  ; dword count
  2282                                  lff24s2_1:
  2283 00001215 66AD                    	lodsw
  2284 00001217 66AB                    	stosw		; original sample (L)
  2285 00001219 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2286 0000121C 66A3[F11F0000]          	mov	[previous_val_l], ax
  2287 00001222 66AD                    	lodsw
  2288 00001224 66AB                    	stosw		; original sample (R)
  2289 00001226 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2290                                  	;mov	[previous_val_r], ax
  2291 00001229 89C3                    	mov	ebx, eax
  2292 0000122B 31D2                    	xor	edx, edx
  2293 0000122D 31C0                    	xor	eax, eax
  2294                                  	; 16/11/2023
  2295 0000122F 49                      	dec	ecx
  2296 00001230 7407                    	jz	short lff24s2_2
  2297 00001232 668B06                  	mov	ax, [esi]
  2298 00001235 668B5602                	mov	dx, [esi+2]
  2299                                  lff24s2_2:
  2300 00001239 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2301                                  	;;mov	[next_val_l], ax
  2302                                  	;mov	ebp, eax
  2303 0000123C 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2304                                  	;mov	[next_val_r], dx
  2305 0000123F 660305[F11F0000]        	add	ax, [previous_val_l]
  2306 00001246 66D1D8                  	rcr	ax, 1
  2307 00001249 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2308 0000124C 66AB                    	stosw		; this is interpolated sample (L)
  2309                                  	;mov	ax, [next_val_r]
  2310 0000124E 89D0                    	mov	eax, edx
  2311                                  	;add	ax, [previous_val_r]
  2312 00001250 6601D8                  	add	ax, bx
  2313 00001253 66D1D8                  	rcr	ax, 1
  2314 00001256 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2315 00001259 66AB                    	stosw		; this is interpolated sample (R)
  2316                                  	
  2317                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2318 0000125B 09C9                    	or	ecx, ecx
  2319 0000125D 75B6                    	jnz	short lff24s2_1
  2320 0000125F E920F8FFFF              	jmp	lff24_3
  2321                                  
  2322                                  ; .....................
  2323                                  
  2324                                  load_32khz_mono_8_bit:
  2325                                  	; 15/11/2023
  2326 00001264 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2327                                  					; last of the file?
  2328 0000126B 7402                    	jz	short lff32m_0		; no
  2329 0000126D F9                      	stc
  2330 0000126E C3                      	retn
  2331                                  
  2332                                  lff32m_0:
  2333 0000126F BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2334                                          ;mov	edx, [loadsize]
  2335                                  
  2336                                  	; esi = buffer address
  2337                                  	;; edx = buffer size
  2338                                  
  2339                                  	; load file into memory
  2340                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001274 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000127A 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000127C 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001282 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001287 CD40                <1>  int 40h
  2341 00001289 7247                    	jc	short lff32m_7 ; error !
  2342                                  
  2343 0000128B BF[00300000]            	mov	edi, audio_buffer
  2344                                  	
  2345 00001290 21C0                    	and	eax, eax
  2346 00001292 7505                    	jnz	short lff32m_8
  2347 00001294 E903F8FFFF              	jmp	lff32_eof
  2348                                  
  2349                                  lff32m_8:
  2350 00001299 89C1                    	mov	ecx, eax	; byte count
  2351                                  lff32m_1:
  2352 0000129B AC                      	lodsb
  2353                                  	;mov	[previous_val], al
  2354 0000129C 88C3                    	mov	bl, al
  2355 0000129E 2C80                    	sub	al, 80h
  2356 000012A0 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2357 000012A4 66AB                    	stosw		; original sample (left channel)
  2358 000012A6 66AB                    	stosw		; original sample (right channel)
  2359                                  	;xor	eax, eax
  2360 000012A8 B080                    	mov	al, 80h
  2361 000012AA 49                      	dec	ecx
  2362 000012AB 7402                    	jz	short lff32m_2
  2363 000012AD 8A06                    	mov	al, [esi]
  2364                                  lff32m_2:
  2365                                  	;;mov	[next_val], al
  2366                                  	;mov	bh, al
  2367                                  	;add	al, [previous_val]
  2368 000012AF 00D8                    	add	al, bl
  2369 000012B1 D0D8                    	rcr	al, 1
  2370 000012B3 2C80                    	sub	al, 80h
  2371 000012B5 66C1E008                	shl	ax, 8
  2372 000012B9 66AB                    	stosw		; this is interpolated sample (L)
  2373 000012BB 66AB                    	stosw		; this is interpolated sample (R)
  2374                                  	
  2375                                  	; different than 8-16-24 kHZ !
  2376                                  	; 'original-interpolated-original' trio samples 
  2377 000012BD E30E                    	jecxz	lff32m_3
  2378                                  
  2379 000012BF AC                      	lodsb
  2380 000012C0 2C80                    	sub	al, 80h
  2381 000012C2 66C1E008                	shl	ax, 8
  2382 000012C6 66AB                    	stosw		; original sample (left channel)
  2383 000012C8 66AB                    	stosw		; original sample (right channel)
  2384                                  
  2385                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2386 000012CA 49                      	dec	ecx
  2387 000012CB 75CE                    	jnz	short lff32m_1
  2388                                  lff32m_3:
  2389 000012CD E9B2F7FFFF              	jmp	lff32_3
  2390                                  
  2391                                  lff32m_7:
  2392                                  lff32s_7:
  2393 000012D2 E9CEF7FFFF              	jmp	lff32_5  ; error
  2394                                  
  2395                                  load_32khz_stereo_8_bit:
  2396                                  	; 15/11/2023
  2397 000012D7 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2398                                  					; last of the file?
  2399 000012DE 7402                    	jz	short lff32s_0		; no
  2400 000012E0 F9                      	stc
  2401 000012E1 C3                      	retn
  2402                                  
  2403                                  lff32s_0:
  2404 000012E2 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2405                                          ;mov	edx, [loadsize]
  2406                                  
  2407                                  	; esi = buffer address
  2408                                  	;; edx = buffer size
  2409                                  
  2410                                  	; load file into memory
  2411                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000012E7 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000012ED 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000012EF 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000012F5 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000012FA CD40                <1>  int 40h
  2412 000012FC 72D4                    	jc	short lff32s_7 ; error !
  2413                                  
  2414 000012FE BF[00300000]            	mov	edi, audio_buffer
  2415                                  	
  2416 00001303 D1E8                    	shr	eax, 1
  2417 00001305 7505                    	jnz	short lff32s_8
  2418 00001307 E990F7FFFF              	jmp	lff32_eof
  2419                                  
  2420                                  lff32s_8:
  2421 0000130C 89C1                    	mov	ecx, eax  ; word count
  2422                                  lff32s_1:
  2423 0000130E AC                      	lodsb
  2424 0000130F A2[F11F0000]            	mov	[previous_val_l], al
  2425 00001314 2C80                    	sub	al, 80h
  2426 00001316 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2427 0000131A 66AB                    	stosw		; original sample (L)
  2428 0000131C AC                      	lodsb
  2429 0000131D A2[F31F0000]            	mov	[previous_val_r], al
  2430 00001322 2C80                    	sub	al, 80h
  2431 00001324 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2432 00001328 66AB                    	stosw		; original sample (R)
  2433                                  
  2434                                  	;xor	eax, eax
  2435 0000132A 66B88080                	mov	ax, 8080h
  2436 0000132E 49                      	dec	ecx
  2437 0000132F 7403                    	jz	short lff32s_2
  2438                                  		; convert 8 bit sample to 16 bit sample
  2439 00001331 668B06                  	mov	ax, [esi]
  2440                                  lff32s_2:
  2441                                  	;;mov	[next_val_l], al
  2442                                  	;;mov	[next_val_r], ah
  2443                                  	;mov	bx, ax
  2444 00001334 88E7                    	mov	bh, ah
  2445 00001336 0205[F11F0000]          	add	al, [previous_val_l]
  2446 0000133C D0D8                    	rcr	al, 1
  2447                                  	;mov	dl, al
  2448 0000133E 2C80                    	sub	al, 80h
  2449 00001340 66C1E008                	shl	ax, 8
  2450 00001344 66AB                    	stosw		; this is interpolated sample (L)
  2451 00001346 88F8                    	mov	al, bh	; [next_val_r]
  2452 00001348 0205[F31F0000]          	add	al, [previous_val_r]
  2453 0000134E D0D8                    	rcr	al, 1
  2454                                  	;mov	dh, al
  2455 00001350 2C80                    	sub	al, 80h
  2456 00001352 66C1E008                	shl	ax, 8
  2457 00001356 66AB                    	stosw		; this is interpolated sample (R)
  2458                                  
  2459                                  	; different than 8-16-24 kHZ !
  2460                                  	; 'original-interpolated-original' trio samples 
  2461 00001358 E315                    	jecxz	lff32s_3
  2462                                  
  2463 0000135A AC                      	lodsb
  2464 0000135B 2C80                    	sub	al, 80h
  2465 0000135D 66C1E008                	shl	ax, 8
  2466 00001361 66AB                    	stosw		; original sample (left channel)
  2467                                  
  2468 00001363 AC                      	lodsb
  2469 00001364 2C80                    	sub	al, 80h
  2470 00001366 66C1E008                	shl	ax, 8
  2471 0000136A 66AB                    	stosw		; original sample (right channel)
  2472                                  		
  2473                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2474 0000136C 49                      	dec	ecx
  2475 0000136D 759F                    	jnz	short lff32s_1
  2476                                  lff32s_3:
  2477 0000136F E910F7FFFF              	jmp	lff32_3
  2478                                  
  2479                                  load_32khz_mono_16_bit:
  2480                                  	; 15/11/2023
  2481 00001374 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2482                                  					; last of the file?
  2483 0000137B 7402                    	jz	short lff32m2_0		; no
  2484 0000137D F9                      	stc
  2485 0000137E C3                      	retn
  2486                                  
  2487                                  lff32m2_0:
  2488 0000137F BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2489                                          ;mov	edx, [loadsize]
  2490                                  
  2491                                  	; esi = buffer address
  2492                                  	;; edx = buffer size
  2493                                  
  2494                                  	; load file into memory
  2495                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001384 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000138A 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000138C 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001392 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001397 CD40                <1>  int 40h
  2496 00001399 723E                    	jc	short lff32m2_7 ; error !
  2497                                  
  2498 0000139B BF[00300000]            	mov	edi, audio_buffer
  2499                                  	
  2500 000013A0 D1E8                    	shr	eax, 1
  2501 000013A2 7505                    	jnz	short lff32m2_8
  2502 000013A4 E9F3F6FFFF              	jmp	lff32_eof
  2503                                  
  2504                                  lff32m2_8:
  2505 000013A9 89C1                    	mov	ecx, eax  ; word count
  2506                                  lff32m2_1:
  2507 000013AB 66AD                    	lodsw
  2508 000013AD 66AB                    	stosw		; original sample (left channel)
  2509 000013AF 66AB                    	stosw		; original sample (right channel)
  2510 000013B1 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2511                                  	;mov	[previous_val], ax
  2512                                  	;mov	ebx, eax	
  2513                                  	;xor	eax, eax
  2514 000013B4 31DB                    	xor	ebx, ebx
  2515 000013B6 49                      	dec	ecx
  2516 000013B7 7403                    	jz	short lff32m2_2
  2517                                  	;mov	ax, [esi]
  2518 000013B9 668B1E                  	mov	bx, [esi]
  2519                                  lff32m2_2:
  2520                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2521                                  	;mov	ebp, eax	; [next_val]
  2522                                  	;add	ax, [previous_val]
  2523                                  	; ax = [previous_val]
  2524                                  	; bx = [next_val]
  2525 000013BC 6601D8                  	add	ax, bx
  2526 000013BF 66D1D8                  	rcr	ax, 1
  2527 000013C2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2528 000013C5 66AB                    	stosw		; this is interpolated sample (L)
  2529 000013C7 66AB                    	stosw		; this is interpolated sample (R)
  2530                                  
  2531                                  	; different than 8-16-24 kHZ !
  2532                                  	; 'original-interpolated-original' trio samples 
  2533 000013C9 E309                    	jecxz	lff32m2_3
  2534                                  
  2535 000013CB 66AD                    	lodsw
  2536 000013CD 66AB                    	stosw		; original sample (left channel)
  2537 000013CF 66AB                    	stosw		; original sample (right channel)
  2538                                  
  2539                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2540 000013D1 49                      	dec	ecx
  2541 000013D2 75D7                    	jnz	short lff32m2_1
  2542                                  lff32m2_3:
  2543 000013D4 E9ABF6FFFF              	jmp	lff32_3
  2544                                  
  2545                                  lff32m2_7:
  2546                                  lff32s2_7:
  2547 000013D9 E9C7F6FFFF              	jmp	lff32_5  ; error
  2548                                  
  2549                                  load_32khz_stereo_16_bit:
  2550                                  	; 16/11/2023
  2551                                  	; 15/11/2023
  2552 000013DE F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2553                                  					; last of the file?
  2554 000013E5 7402                    	jz	short lff32s2_0		; no
  2555 000013E7 F9                      	stc
  2556 000013E8 C3                      	retn
  2557                                  
  2558                                  lff32s2_0:
  2559 000013E9 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2560                                          ;mov	edx, [loadsize]
  2561                                  
  2562                                  	; esi = buffer address
  2563                                  	;; edx = buffer size
  2564                                  
  2565                                  	; load file into memory
  2566                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000013EE 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000013F4 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000013F6 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000013FC B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001401 CD40                <1>  int 40h
  2567 00001403 72D4                    	jc	short lff32s2_7 ; error !
  2568                                  
  2569 00001405 BF[00300000]            	mov	edi, audio_buffer
  2570                                  	
  2571 0000140A C1E802                  	shr	eax, 2
  2572 0000140D 7505                    	jnz	short lff32s2_8
  2573 0000140F E988F6FFFF              	jmp	lff32_eof
  2574                                  
  2575                                  lff32s2_8:
  2576 00001414 89C1                    	mov	ecx, eax ; dword count
  2577                                  lff32s2_1:
  2578 00001416 66AD                    	lodsw
  2579 00001418 66AB                    	stosw		; original sample (L)
  2580 0000141A 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2581 0000141D 66A3[F11F0000]          	mov	[previous_val_l], ax
  2582 00001423 66AD                    	lodsw
  2583 00001425 66AB                    	stosw		; original sample (R)
  2584 00001427 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2585                                  	;mov	[previous_val_r], ax
  2586 0000142A 89C3                    	mov	ebx, eax
  2587 0000142C 31D2                    	xor	edx, edx
  2588 0000142E 31C0                    	xor	eax, eax
  2589                                  	; 16/11/2023
  2590 00001430 49                      	dec	ecx
  2591 00001431 7407                    	jz	short lff32s2_2
  2592 00001433 668B06                  	mov	ax, [esi]
  2593 00001436 668B5602                	mov	dx, [esi+2]
  2594                                  lff32s2_2:
  2595 0000143A 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2596                                  	;;mov	[next_val_l], ax
  2597                                  	;mov	ebp, eax
  2598 0000143D 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2599                                  	;mov	[next_val_r], dx
  2600 00001440 660305[F11F0000]        	add	ax, [previous_val_l]
  2601 00001447 66D1D8                  	rcr	ax, 1
  2602 0000144A 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2603 0000144D 66AB                    	stosw		; this is interpolated sample (L)
  2604                                  	;mov	ax, [next_val_r]
  2605 0000144F 89D0                    	mov	eax, edx
  2606                                  	;add	ax, [previous_val_r]
  2607 00001451 6601D8                  	add	ax, bx
  2608 00001454 66D1D8                  	rcr	ax, 1
  2609 00001457 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2610 0000145A 66AB                    	stosw		; this is interpolated sample (R)
  2611                                  
  2612                                  	; different than 8-16-24 kHZ !
  2613                                  	; 'original-interpolated-original' trio samples 
  2614 0000145C E30B                    	jecxz	lff32s2_3
  2615                                  
  2616 0000145E 66AD                    	lodsw
  2617 00001460 66AB                    	stosw	; original sample (L)
  2618 00001462 66AD                    	lodsw
  2619 00001464 66AB                    	stosw	; original sample (R)
  2620                                  	
  2621                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2622 00001466 49                      	dec	ecx
  2623 00001467 75AD                    	jnz	short lff32s2_1
  2624                                  lff32s2_3:
  2625 00001469 E916F6FFFF              	jmp	lff32_3
  2626                                  
  2627                                  ; .....................
  2628                                  
  2629                                  load_22khz_mono_8_bit:
  2630                                  	; 16/11/2023
  2631 0000146E F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2632                                  					; last of the file?
  2633 00001475 7402                    	jz	short lff22m_0		; no
  2634 00001477 F9                      	stc
  2635 00001478 C3                      	retn
  2636                                  
  2637                                  lff22m_0:
  2638 00001479 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2639                                          ;mov	edx, [loadsize]
  2640                                  
  2641                                  	; esi = buffer address
  2642                                  	;; edx = buffer size
  2643                                  
  2644                                  	; load file into memory
  2645                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000147E 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001484 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001486 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000148C B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001491 CD40                <1>  int 40h
  2646 00001493 725D                    	jc	short lff22m_7 ; error !
  2647                                  
  2648 00001495 BF[00300000]            	mov	edi, audio_buffer
  2649                                  	
  2650 0000149A 21C0                    	and	eax, eax
  2651 0000149C 7505                    	jnz	short lff22m_8
  2652 0000149E E9F9F5FFFF              	jmp	lff22_eof
  2653                                  
  2654                                  lff22m_8:
  2655 000014A3 89C1                    	mov	ecx, eax	; byte count
  2656                                  lff22m_9:
  2657 000014A5 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2658 000014AA C605[F91F0000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2659                                  lff22m_1:
  2660                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2661 000014B1 AC                      	lodsb
  2662 000014B2 B280                    	mov	dl, 80h
  2663 000014B4 49                      	dec	ecx
  2664 000014B5 7402                    	jz	short lff22m_2_1
  2665 000014B7 8A16                    	mov	dl, [esi]
  2666                                  lff22m_2_1:	
  2667                                  	; al = [previous_val]
  2668                                  	; dl = [next_val]
  2669 000014B9 E8EF050000              	call	interpolating_3_8bit_mono ; 1 of 17
  2670 000014BE E32D                    	jecxz	lff22m_3
  2671                                  lff22m_2_2:
  2672 000014C0 AC                      	lodsb
  2673 000014C1 B280                    	mov	dl, 80h
  2674 000014C3 49                      	dec	ecx
  2675 000014C4 7402                    	jz	short lff22m_2_3
  2676 000014C6 8A16                    	mov	dl, [esi]
  2677                                  lff22m_2_3:
  2678 000014C8 E864060000               	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2679 000014CD E31E                    	jecxz	lff22m_3
  2680 000014CF 4D                      	dec	ebp
  2681 000014D0 75EE                    	jnz	short lff22m_2_2
  2682                                  
  2683 000014D2 A0[F91F0000]            	mov	al, [faz]
  2684 000014D7 FEC8                    	dec	al
  2685 000014D9 74CA                    	jz	short lff22m_9
  2686 000014DB FE0D[F91F0000]          	dec	byte [faz]
  2687 000014E1 BD04000000              	mov	ebp, 4
  2688 000014E6 FEC8                    	dec	al
  2689 000014E8 75C7                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2690 000014EA 45                      	inc	ebp ; 5
  2691 000014EB EBC4                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2692                                  
  2693                                  lff22m_3:
  2694                                  lff22s_3:
  2695 000014ED E992F5FFFF              	jmp	lff22_3	; padfill
  2696                                  		; (put zeros in the remain words of the buffer)
  2697                                  lff22m_7:
  2698                                  lff22s_7:
  2699 000014F2 E9AEF5FFFF              	jmp	lff22_5  ; error
  2700                                  
  2701                                  load_22khz_stereo_8_bit:
  2702                                  	; 16/11/2023
  2703 000014F7 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2704                                  					; last of the file?
  2705 000014FE 7402                    	jz	short lff22s_0		; no
  2706 00001500 F9                      	stc
  2707 00001501 C3                      	retn
  2708                                  
  2709                                  lff22s_0:
  2710 00001502 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2711                                          ;mov	edx, [loadsize]
  2712                                  
  2713                                  	; esi = buffer address
  2714                                  	;; edx = buffer size
  2715                                  
  2716                                  	; load file into memory
  2717                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001507 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000150D 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000150F 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001515 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000151A CD40                <1>  int 40h
  2718 0000151C 72D4                    	jc	short lff22s_7 ; error !
  2719                                  
  2720 0000151E BF[00300000]            	mov	edi, audio_buffer
  2721                                  	
  2722 00001523 D1E8                    	shr	eax, 1
  2723 00001525 7505                    	jnz	short lff22s_8
  2724 00001527 E970F5FFFF              	jmp	lff22_eof
  2725                                  
  2726                                  lff22s_8:
  2727 0000152C 89C1                    	mov	ecx, eax	; word count
  2728                                  lff22s_9:
  2729 0000152E BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2730 00001533 C605[F91F0000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2731                                  lff22s_1:
  2732                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2733 0000153A 66AD                    	lodsw
  2734 0000153C 66BA8080                	mov	dx, 8080h
  2735 00001540 49                      	dec	ecx
  2736 00001541 7403                    	jz	short lff22s_2_1 
  2737 00001543 668B16                  	mov	dx, [esi]
  2738                                  lff22s_2_1:	
  2739                                  	; al = [previous_val_l]
  2740                                  	; ah = [previous_val_r]
  2741                                  	; dl = [next_val_l]
  2742                                  	; dh = [next_val_r]	
  2743 00001546 E893050000              	call	interpolating_3_8bit_stereo ; 1 of 17 
  2744 0000154B E3A0                    	jecxz	lff22s_3
  2745                                  lff22s_2_2:
  2746 0000154D 66AD                    	lodsw
  2747 0000154F 66BA8080                	mov	dx, 8080h
  2748 00001553 49                      	dec	ecx
  2749 00001554 7403                    	jz	short lff22s_2_3
  2750 00001556 668B16                  	mov	dx, [esi]
  2751                                  lff22s_2_3:
  2752 00001559 E8F0050000               	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2753 0000155E E38D                    	jecxz	lff22s_3
  2754 00001560 4D                      	dec	ebp
  2755 00001561 75EA                    	jnz	short lff22s_2_2
  2756                                  
  2757 00001563 A0[F91F0000]            	mov	al, [faz]
  2758 00001568 FEC8                    	dec	al
  2759 0000156A 74C2                    	jz	short lff22s_9
  2760 0000156C FE0D[F91F0000]          	dec	byte [faz]
  2761 00001572 BD04000000              	mov	ebp, 4
  2762 00001577 FEC8                    	dec	al
  2763 00001579 75BF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2764 0000157B 45                      	inc	ebp ; 5
  2765 0000157C EBBC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2766                                  
  2767                                  load_22khz_mono_16_bit:
  2768                                  	; 16/11/2023
  2769 0000157E F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2770                                  					; last of the file?
  2771 00001585 7402                    	jz	short lff22m2_0		; no
  2772 00001587 F9                      	stc
  2773 00001588 C3                      	retn
  2774                                  
  2775                                  lff22m2_0:
  2776 00001589 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2777                                          ;mov	edx, [loadsize]
  2778                                  
  2779                                  	; esi = buffer address
  2780                                  	;; edx = buffer size
  2781                                  
  2782                                  	; load file into memory
  2783                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000158E 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001594 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001596 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000159C B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000015A1 CD40                <1>  int 40h
  2784 000015A3 7261                    	jc	short lff22m2_7 ; error !
  2785                                  
  2786 000015A5 BF[00300000]            	mov	edi, audio_buffer
  2787                                  	
  2788 000015AA D1E8                    	shr	eax, 1
  2789 000015AC 7505                    	jnz	short lff22m2_8
  2790 000015AE E9E9F4FFFF              	jmp	lff22_eof
  2791                                  
  2792                                  lff22m2_8:
  2793 000015B3 89C1                    	mov	ecx, eax	; word count
  2794                                  lff22m2_9:
  2795 000015B5 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2796 000015BA C605[F91F0000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2797                                  lff22m2_1:
  2798                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2799 000015C1 66AD                    	lodsw
  2800 000015C3 31D2                    	xor	edx, edx
  2801 000015C5 49                      	dec	ecx
  2802 000015C6 7403                    	jz	short lff22m2_2_1
  2803 000015C8 668B16                  	mov	dx, [esi]
  2804                                  lff22m2_2_1:	
  2805                                  	; ax = [previous_val]
  2806                                  	; dx = [next_val]
  2807 000015CB E8AF050000              	call	interpolating_3_16bit_mono ; 1 of 17
  2808 000015D0 E32F                    	jecxz	lff22m2_3
  2809                                  lff22m2_2_2:
  2810 000015D2 66AD                    	lodsw
  2811 000015D4 31D2                    	xor	edx, edx
  2812 000015D6 49                      	dec	ecx
  2813 000015D7 7403                    	jz	short lff22m2_2_3
  2814 000015D9 668B16                  	mov	dx, [esi]
  2815                                  lff22m2_2_3:
  2816 000015DC E831060000               	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2817 000015E1 E31E                    	jecxz	lff22m2_3
  2818 000015E3 4D                      	dec	ebp
  2819 000015E4 75EC                    	jnz	short lff22m2_2_2
  2820                                  
  2821 000015E6 A0[F91F0000]            	mov	al, [faz]
  2822 000015EB FEC8                    	dec	al
  2823 000015ED 74C6                    	jz	short lff22m2_9
  2824 000015EF FE0D[F91F0000]          	dec	byte [faz]
  2825 000015F5 BD04000000              	mov	ebp, 4
  2826 000015FA FEC8                    	dec	al
  2827 000015FC 75C3                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2828 000015FE 45                      	inc	ebp ; 5
  2829 000015FF EBC0                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2830                                  
  2831                                  lff22m2_3:
  2832                                  lff22s2_3:
  2833 00001601 E97EF4FFFF              	jmp	lff22_3	; padfill
  2834                                  		; (put zeros in the remain words of the buffer)
  2835                                  lff22m2_7:
  2836                                  lff22s2_7:
  2837 00001606 E99AF4FFFF              	jmp	lff22_5  ; error
  2838                                  
  2839                                  load_22khz_stereo_16_bit:
  2840                                  	; 16/11/2023
  2841 0000160B F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2842                                  					; last of the file?
  2843 00001612 7402                    	jz	short lff22s2_0		; no
  2844 00001614 F9                      	stc
  2845 00001615 C3                      	retn
  2846                                  
  2847                                  lff22s2_0:
  2848 00001616 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2849                                          ;mov	edx, [loadsize]
  2850                                  
  2851                                  	; esi = buffer address
  2852                                  	;; edx = buffer size
  2853                                  
  2854                                  	; load file into memory
  2855                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000161B 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001621 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001623 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001629 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000162E CD40                <1>  int 40h
  2856 00001630 72D4                    	jc	short lff22s2_7 ; error !
  2857                                  
  2858 00001632 BF[00300000]            	mov	edi, audio_buffer
  2859                                  	
  2860 00001637 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  2861 0000163A 7505                    	jnz	short lff22s2_8
  2862 0000163C E95BF4FFFF              	jmp	lff22_eof
  2863                                  
  2864                                  lff22s2_8:
  2865 00001641 89C1                    	mov	ecx, eax	; dword count
  2866                                  lff22s2_9:
  2867 00001643 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2868 00001648 C605[F91F0000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2869                                  lff22s2_1:
  2870                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2871 0000164F 66AD                    	lodsw
  2872 00001651 89C3                    	mov	ebx, eax
  2873 00001653 66AD                    	lodsw
  2874 00001655 8B16                    	mov	edx, [esi]
  2875 00001657 668915[F51F0000]        	mov	[next_val_l], dx
  2876                                  	; 26/11/2023
  2877 0000165E C1EA10                  	shr	edx, 16
  2878 00001661 49                      	dec	ecx
  2879 00001662 7509                    	jnz	short lff22s2_2_1
  2880 00001664 31D2                    	xor	edx, edx ; 0
  2881 00001666 668915[F51F0000]        	mov	[next_val_l], dx
  2882                                  lff22s2_2_1:
  2883                                  	; bx = [previous_val_l]
  2884                                  	; ax = [previous_val_r]
  2885                                  	; [next_val_l]
  2886                                  	; dx = [next_val_r]
  2887 0000166D E83D050000              	call	interpolating_3_16bit_stereo ; 1 of 17 
  2888 00001672 E38D                    	jecxz	lff22s2_3
  2889                                  lff22s2_2_2:
  2890 00001674 66AD                    	lodsw
  2891 00001676 89C3                    	mov	ebx, eax
  2892 00001678 66AD                    	lodsw
  2893 0000167A 8B16                    	mov	edx, [esi]
  2894 0000167C 668915[F51F0000]        	mov	[next_val_l], dx
  2895                                  	; 26/11/2023
  2896 00001683 C1EA10                  	shr	edx, 16
  2897 00001686 49                      	dec	ecx
  2898 00001687 7509                    	jnz	short lff22s2_2_3
  2899 00001689 31D2                    	xor	edx, edx ; 0
  2900 0000168B 668915[F51F0000]        	mov	[next_val_l], dx
  2901                                  lff22s2_2_3:
  2902 00001692 E893050000               	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  2903 00001697 E31E                    	jecxz	lff22s2_2_4
  2904                                  
  2905 00001699 4D                      	dec	ebp
  2906 0000169A 75D8                    	jnz	short lff22s2_2_2
  2907                                  
  2908 0000169C A0[F91F0000]            	mov	al, [faz]
  2909 000016A1 FEC8                    	dec	al
  2910 000016A3 749E                    	jz	short lff22s2_9
  2911 000016A5 FE0D[F91F0000]          	dec	byte [faz]
  2912 000016AB BD04000000              	mov	ebp, 4
  2913 000016B0 FEC8                    	dec	al
  2914 000016B2 759B                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2915 000016B4 45                      	inc	ebp ; 5
  2916 000016B5 EB98                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2917                                  
  2918                                  lff22s2_2_4:
  2919                                  	; 26/11/2023
  2920 000016B7 E9C8F3FFFF              	jmp	lff22_3	; padfill
  2921                                  
  2922                                  ; .....................
  2923                                  
  2924                                  load_11khz_mono_8_bit:
  2925                                  	; 18/11/2023
  2926 000016BC F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2927                                  					; last of the file?
  2928 000016C3 7402                    	jz	short lff11m_0		; no
  2929 000016C5 F9                      	stc
  2930 000016C6 C3                      	retn
  2931                                  
  2932                                  lff11m_0:
  2933 000016C7 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2934                                          ;mov	edx, [loadsize]
  2935                                  
  2936                                  	; esi = buffer address
  2937                                  	;; edx = buffer size
  2938                                  
  2939                                  	; load file into memory
  2940                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000016CC 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000016D2 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000016D4 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000016DA B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000016DF CD40                <1>  int 40h
  2941 000016E1 7247                    	jc	short lff11m_7 ; error !
  2942                                  
  2943 000016E3 BF[00300000]            	mov	edi, audio_buffer
  2944                                  	
  2945 000016E8 21C0                    	and	eax, eax
  2946 000016EA 7505                    	jnz	short lff11m_8
  2947 000016EC E9ABF3FFFF              	jmp	lff11_eof
  2948                                  
  2949                                  lff11m_8:
  2950 000016F1 89C1                    	mov	ecx, eax		; byte count
  2951                                  lff11m_9:
  2952 000016F3 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  2953                                  lff11m_1:
  2954                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2955 000016F8 AC                      	lodsb
  2956 000016F9 B280                    	mov	dl, 80h
  2957 000016FB 49                      	dec	ecx
  2958 000016FC 7402                    	jz	short lff11m_2_1
  2959 000016FE 8A16                    	mov	dl, [esi]
  2960                                  lff11m_2_1:	
  2961                                  	; al = [previous_val]
  2962                                  	; dl = [next_val]
  2963 00001700 E854050000              	call	interpolating_5_8bit_mono
  2964 00001705 E328                    	jecxz	lff11m_3
  2965                                  lff11m_2_2:
  2966 00001707 AC                      	lodsb
  2967 00001708 B280                    	mov	dl, 80h
  2968 0000170A 49                      	dec	ecx
  2969 0000170B 7402                    	jz	short lff11m_2_3
  2970 0000170D 8A16                    	mov	dl, [esi]
  2971                                  lff11m_2_3:
  2972 0000170F E851060000               	call	interpolating_4_8bit_mono
  2973 00001714 E319                    	jecxz	lff11m_3
  2974                                  
  2975 00001716 4D                      	dec	ebp
  2976 00001717 74DA                    	jz	short lff11m_9
  2977                                  
  2978 00001719 AC                      	lodsb
  2979 0000171A B280                    	mov	dl, 80h
  2980 0000171C 49                      	dec	ecx
  2981 0000171D 7402                    	jz	short lff11m_2_4
  2982 0000171F 8A16                    	mov	dl, [esi]
  2983                                  lff11m_2_4:
  2984 00001721 E83F060000              	call	interpolating_4_8bit_mono
  2985 00001726 E307                    	jecxz	lff11m_3
  2986 00001728 EBCE                    	jmp	short lff11m_1
  2987                                  
  2988                                  lff11m_7:
  2989                                  lff11s_7:
  2990 0000172A E976F3FFFF              	jmp	lff11_5  ; error
  2991                                  
  2992                                  lff11m_3:
  2993                                  lff11s_3:
  2994 0000172F E950F3FFFF              	jmp	lff11_3	; padfill
  2995                                  		; (put zeros in the remain words of the buffer)
  2996                                  
  2997                                  load_11khz_stereo_8_bit:
  2998                                  	; 18/11/2023
  2999 00001734 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3000                                  					; last of the file?
  3001 0000173B 7402                    	jz	short lff11s_0		; no
  3002 0000173D F9                      	stc
  3003 0000173E C3                      	retn
  3004                                  
  3005                                  lff11s_0:
  3006 0000173F BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3007                                          ;mov	edx, [loadsize]
  3008                                  
  3009                                  	; esi = buffer address
  3010                                  	;; edx = buffer size
  3011                                  
  3012                                  	; load file into memory
  3013                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001744 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000174A 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000174C 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001752 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001757 CD40                <1>  int 40h
  3014 00001759 72CF                    	jc	short lff11s_7 ; error !
  3015                                  
  3016 0000175B BF[00300000]            	mov	edi, audio_buffer
  3017                                  	
  3018 00001760 D1E8                    	shr	eax, 1
  3019 00001762 7505                    	jnz	short lff11s_8
  3020 00001764 E933F3FFFF              	jmp	lff11_eof
  3021                                  
  3022                                  lff11s_8:
  3023 00001769 89C1                    	mov	ecx, eax	; word count
  3024                                  lff11s_9:
  3025 0000176B BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3026                                  lff11s_1:
  3027                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3028 00001770 66AD                    	lodsw
  3029 00001772 66BA8080                	mov	dx, 8080h
  3030 00001776 49                      	dec	ecx
  3031 00001777 7403                    	jz	short lff11s_2_1 
  3032 00001779 668B16                  	mov	dx, [esi]
  3033                                  lff11s_2_1:	
  3034                                  	; al = [previous_val_l]
  3035                                  	; ah = [previous_val_r]
  3036                                  	; dl = [next_val_l]
  3037                                  	; dh = [next_val_r]	
  3038 0000177C E837050000              	call	interpolating_5_8bit_stereo
  3039 00001781 E3AC                    	jecxz	lff11s_3
  3040                                  lff11s_2_2:
  3041 00001783 66AD                    	lodsw
  3042 00001785 66BA8080                	mov	dx, 8080h
  3043 00001789 49                      	dec	ecx
  3044 0000178A 7403                    	jz	short lff11s_2_3
  3045 0000178C 668B16                  	mov	dx, [esi]
  3046                                  lff11s_2_3:
  3047 0000178F E810060000               	call	interpolating_4_8bit_stereo
  3048 00001794 E399                    	jecxz	lff11s_3
  3049                                  	
  3050 00001796 4D                      	dec	ebp
  3051 00001797 74D2                    	jz	short lff11s_9
  3052                                  
  3053 00001799 66AD                    	lodsw
  3054 0000179B 66BA8080                	mov	dx, 8080h
  3055 0000179F 49                      	dec	ecx
  3056 000017A0 7403                    	jz	short lff11s_2_4
  3057 000017A2 668B16                  	mov	dx, [esi]
  3058                                  lff11s_2_4:
  3059 000017A5 E8FA050000              	call	interpolating_4_8bit_stereo
  3060 000017AA E383                    	jecxz	lff11s_3
  3061 000017AC EBC2                    	jmp	short lff11s_1
  3062                                  
  3063                                  load_11khz_mono_16_bit:
  3064                                  	; 18/11/2023
  3065 000017AE F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3066                                  					; last of the file?
  3067 000017B5 7402                    	jz	short lff11m2_0		; no
  3068 000017B7 F9                      	stc
  3069 000017B8 C3                      	retn
  3070                                  
  3071                                  lff11m2_0:
  3072 000017B9 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3073                                          ;mov	edx, [loadsize]
  3074                                  
  3075                                  	; esi = buffer address
  3076                                  	;; edx = buffer size
  3077                                  
  3078                                  	; load file into memory
  3079                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000017BE 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000017C4 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000017C6 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000017CC B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000017D1 CD40                <1>  int 40h
  3080 000017D3 724D                    	jc	short lff11m2_7 ; error !
  3081                                  
  3082 000017D5 BF[00300000]            	mov	edi, audio_buffer
  3083                                  	
  3084 000017DA D1E8                    	shr	eax, 1
  3085 000017DC 7505                    	jnz	short lff11m2_8
  3086 000017DE E9B9F2FFFF              	jmp	lff11_eof
  3087                                  
  3088                                  lff11m2_8:
  3089 000017E3 89C1                    	mov	ecx, eax	; word count
  3090                                  lff11m2_9:
  3091 000017E5 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3092                                  lff11m2_1:
  3093                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3094 000017EA 66AD                    	lodsw
  3095 000017EC 31D2                    	xor	edx, edx
  3096 000017EE 49                      	dec	ecx
  3097 000017EF 7403                    	jz	short lff11m2_2_1
  3098 000017F1 668B16                  	mov	dx, [esi]
  3099                                  lff11m2_2_1:	
  3100                                  	; ax = [previous_val]
  3101                                  	; dx = [next_val]
  3102 000017F4 E818060000              	call	interpolating_5_16bit_mono
  3103 000017F9 E362                    	jecxz	lff11m2_3
  3104                                  lff11m2_2_2:
  3105 000017FB 66AD                    	lodsw
  3106 000017FD 31D2                    	xor	edx, edx
  3107 000017FF 49                      	dec	ecx
  3108 00001800 7403                    	jz	short lff11m2_2_3
  3109 00001802 668B16                  	mov	dx, [esi]
  3110                                  lff11m2_2_3:
  3111 00001805 E831070000               	call	interpolating_4_16bit_mono
  3112 0000180A E351                    	jecxz	lff11m2_3
  3113                                  
  3114 0000180C 4D                      	dec	ebp
  3115 0000180D 74D6                    	jz	short lff11m2_9
  3116                                  
  3117 0000180F 66AD                    	lodsw
  3118 00001811 31D2                    	xor	edx, edx
  3119 00001813 49                      	dec	ecx
  3120 00001814 7403                    	jz	short lff11m2_2_4
  3121 00001816 668B16                  	mov	dx, [esi]
  3122                                  lff11m2_2_4:
  3123 00001819 E81D070000               	call	interpolating_4_16bit_mono
  3124 0000181E E33D                    	jecxz	lff11m2_3
  3125 00001820 EBC8                    	jmp	short lff11m2_1
  3126                                  
  3127                                  lff11m2_7:
  3128                                  lff11s2_7:
  3129 00001822 E97EF2FFFF              	jmp	lff11_5  ; error
  3130                                  
  3131                                  load_11khz_stereo_16_bit:
  3132                                  	; 17/01/2025
  3133                                  	; 18/11/2023
  3134 00001827 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3135                                  					; last of the file?
  3136 0000182E 7402                    	jz	short lff11s2_0		; no
  3137 00001830 F9                      	stc
  3138 00001831 C3                      	retn
  3139                                  
  3140                                  lff11s2_0:
  3141 00001832 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3142                                          ;mov	edx, [loadsize]
  3143                                  
  3144                                  	; esi = buffer address
  3145                                  	;; edx = buffer size
  3146                                  
  3147                                  	; load file into memory
  3148                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001837 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000183D 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000183F 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001845 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000184A CD40                <1>  int 40h
  3149 0000184C 72D4                    	jc	short lff11s2_7 ; error !
  3150                                  
  3151 0000184E BF[00300000]            	mov	edi, audio_buffer
  3152                                  	
  3153 00001853 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3154 00001856 750A                    	jnz	short lff11s2_8
  3155 00001858 E93FF2FFFF              	jmp	lff11_eof
  3156                                  
  3157                                  lff11m2_3:
  3158                                  lff11s2_3:
  3159 0000185D E922F2FFFF              	jmp	lff11_3	; padfill
  3160                                  		; (put zeros in the remain words of the buffer)
  3161                                  
  3162                                  lff11s2_8:
  3163 00001862 89C1                    	mov	ecx, eax	; dword count
  3164                                  lff11s2_9:
  3165 00001864 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3166                                  lff11s2_1:
  3167                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3168 00001869 66AD                    	lodsw
  3169 0000186B 89C3                    	mov	ebx, eax
  3170 0000186D 66AD                    	lodsw
  3171 0000186F 8B16                    	mov	edx, [esi]
  3172                                  	; 17/01/2025
  3173                                  	;mov	[next_val_l], edx
  3174                                  	; 26/11/2023
  3175                                  	;shr	edx, 16
  3176                                  	;mov	[next_val_r], dx
  3177 00001871 49                      	dec	ecx
  3178 00001872 7502                    	jnz	short lff11s2_2_1
  3179 00001874 31D2                    	xor	edx, edx ; 0
  3180                                  	;mov	[next_val_l], dx
  3181                                  	;mov	[next_val_r], dx
  3182                                  lff11s2_2_1:
  3183                                  	; bx = [previous_val_l]
  3184                                  	; ax = [previous_val_r]
  3185                                  	; [next_val_l]
  3186                                  	; dx = [next_val_r]
  3187                                  	;;;
  3188                                  	; 17/01/2025 (BugFix)
  3189 00001876 8915[F51F0000]          	mov	[next_val_l], edx
  3190                                  	;;;
  3191 0000187C E8EB050000              	call	interpolating_5_16bit_stereo
  3192 00001881 E3DA                    	jecxz	lff11s2_3
  3193                                  lff11s2_2_2:
  3194 00001883 66AD                    	lodsw
  3195 00001885 89C3                    	mov	ebx, eax
  3196 00001887 66AD                    	lodsw
  3197 00001889 8B16                    	mov	edx, [esi]
  3198                                  	; 17/01/2025
  3199                                  	;mov	[next_val_l], dx
  3200                                  	; 26/11/2023
  3201                                  	;shr	edx, 16
  3202                                  	;mov	[next_val_r], dx
  3203 0000188B 49                      	dec	ecx
  3204 0000188C 7502                    	jnz	short lff11s2_2_3
  3205 0000188E 31D2                    	xor	edx, edx ; 0
  3206                                  	;mov	[next_val_l], dx
  3207                                  	;mov	[next_val_r], dx
  3208                                  lff11s2_2_3:
  3209                                  	;;;
  3210                                  	; 17/01/2025 (BugFix)
  3211 00001890 8915[F51F0000]          	mov	[next_val_l], edx
  3212                                  	;;;
  3213 00001896 E8D9060000              	call	interpolating_4_16bit_stereo
  3214 0000189B E3C0                    	jecxz	lff11s2_3
  3215                                  	
  3216 0000189D 4D                      	dec	ebp
  3217 0000189E 74C4                    	jz	short lff11s2_9
  3218                                  
  3219 000018A0 66AD                    	lodsw
  3220 000018A2 89C3                    	mov	ebx, eax
  3221 000018A4 66AD                    	lodsw
  3222 000018A6 8B16                    	mov	edx, [esi]
  3223                                  	; 17/01/2025
  3224                                  	;mov	[next_val_l], dx
  3225                                  	; 26/11/2023
  3226                                  	;shr	edx, 16
  3227                                  	;mov	[next_val_r], dx
  3228 000018A8 49                      	dec	ecx
  3229 000018A9 7502                    	jnz	short lff11s2_2_4
  3230 000018AB 31D2                    	xor	edx, edx ; 0
  3231                                  	;mov	[next_val_l], dx
  3232                                  	;mov	[next_val_r], dx
  3233                                  lff11s2_2_4:
  3234                                  	;;;
  3235                                  	; 17/01/2025 (BugFix)
  3236 000018AD 8915[F51F0000]          	mov	[next_val_l], edx
  3237                                  	;;;
  3238 000018B3 E8BC060000               	call	interpolating_4_16bit_stereo
  3239 000018B8 E3A3                    	jecxz	lff11s2_3
  3240 000018BA EBAD                    	jmp	short lff11s2_1
  3241                                  
  3242                                  ; .....................
  3243                                  
  3244                                  load_44khz_mono_8_bit:
  3245                                  	; 18/11/2023
  3246 000018BC F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3247                                  					; last of the file?
  3248 000018C3 7402                    	jz	short lff44m_0		; no
  3249 000018C5 F9                      	stc
  3250 000018C6 C3                      	retn
  3251                                  
  3252                                  lff44m_0:
  3253 000018C7 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3254                                          ;mov	edx, [loadsize]
  3255                                  
  3256                                  	; esi = buffer address
  3257                                  	;; edx = buffer size
  3258                                  
  3259                                  	; load file into memory
  3260                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000018CC 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000018D2 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000018D4 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000018DA B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000018DF CD40                <1>  int 40h
  3261 000018E1 7250                    	jc	short lff44m_7 ; error !
  3262                                  
  3263 000018E3 BF[00300000]            	mov	edi, audio_buffer
  3264                                  	
  3265 000018E8 21C0                    	and	eax, eax
  3266 000018EA 7505                    	jnz	short lff44m_8
  3267 000018EC E9ABF1FFFF              	jmp	lff44_eof
  3268                                  
  3269                                  lff44m_8:
  3270 000018F1 89C1                    	mov	ecx, eax	; byte count
  3271                                  lff44m_9:
  3272 000018F3 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3273 000018F8 C605[F91F0000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3274                                  lff44m_1:
  3275                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3276                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3277 000018FF AC                      	lodsb
  3278 00001900 B280                    	mov	dl, 80h
  3279 00001902 49                      	dec	ecx
  3280 00001903 7402                    	jz	short lff44m_2_1
  3281 00001905 8A16                    	mov	dl, [esi]
  3282                                  lff44m_2_1:	
  3283                                  	; al = [previous_val]
  3284                                  	; dl = [next_val]
  3285 00001907 E825020000              	call	interpolating_2_8bit_mono
  3286 0000190C E320                    	jecxz	lff44m_3
  3287                                  lff44m_2_2:
  3288 0000190E AC                      	lodsb
  3289 0000190F 2C80                    	sub	al, 80h
  3290 00001911 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3291 00001915 66AB                    	stosw		; (L)
  3292 00001917 66AB                    	stosw		; (R)	
  3293                                  
  3294 00001919 49                      	dec	ecx
  3295 0000191A 7412                    	jz	short lff44m_3	
  3296 0000191C 4D                      	dec	ebp
  3297 0000191D 75EF                    	jnz	short lff44m_2_2
  3298                                  	
  3299 0000191F FE0D[F91F0000]          	dec	byte [faz]
  3300 00001925 74CC                    	jz	short lff44m_9 
  3301 00001927 BD0B000000              	mov	ebp, 11
  3302 0000192C EBD1                    	jmp	short lff44m_1
  3303                                  
  3304                                  lff44m_3:
  3305                                  lff44s_3:
  3306 0000192E E951F1FFFF              	jmp	lff44_3	; padfill
  3307                                  		; (put zeros in the remain words of the buffer)
  3308                                  lff44m_7:
  3309                                  lff44s_7:
  3310 00001933 E96DF1FFFF              	jmp	lff44_5  ; error
  3311                                  
  3312                                  load_44khz_stereo_8_bit:
  3313                                  	; 16/11/2023
  3314 00001938 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3315                                  					; last of the file?
  3316 0000193F 7402                    	jz	short lff44s_0		; no
  3317 00001941 F9                      	stc
  3318 00001942 C3                      	retn
  3319                                  
  3320                                  lff44s_0:
  3321 00001943 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3322                                          ;mov	edx, [loadsize]
  3323                                  
  3324                                  	; esi = buffer address
  3325                                  	;; edx = buffer size
  3326                                  
  3327                                  	; load file into memory
  3328                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001948 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000194E 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001950 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001956 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000195B CD40                <1>  int 40h
  3329 0000195D 72D4                    	jc	short lff44s_7 ; error !
  3330                                  
  3331 0000195F BF[00300000]            	mov	edi, audio_buffer
  3332                                  	
  3333 00001964 D1E8                    	shr	eax, 1
  3334 00001966 7505                    	jnz	short lff44s_8
  3335 00001968 E92FF1FFFF              	jmp	lff44_eof
  3336                                  
  3337                                  lff44s_8:
  3338 0000196D 89C1                    	mov	ecx, eax	; word count
  3339                                  lff44s_9:
  3340 0000196F BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3341 00001974 C605[F91F0000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3342                                  lff44s_1:
  3343                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3344                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3345 0000197B 66AD                    	lodsw
  3346 0000197D 66BA8080                	mov	dx, 8080h
  3347 00001981 49                      	dec	ecx
  3348 00001982 7403                    	jz	short lff44s_2_1 
  3349 00001984 668B16                  	mov	dx, [esi]
  3350                                  lff44s_2_1:	
  3351                                  	; al = [previous_val_l]
  3352                                  	; ah = [previous_val_r]
  3353                                  	; dl = [next_val_l]
  3354                                  	; dh = [next_val_r]	
  3355 00001987 E8C2010000              	call	interpolating_2_8bit_stereo
  3356 0000198C E3A0                    	jecxz	lff44s_3
  3357                                  lff44s_2_2:
  3358 0000198E AC                      	lodsb
  3359 0000198F 2C80                    	sub	al, 80h
  3360 00001991 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3361 00001995 66AB                    	stosw		; (L)
  3362 00001997 AC                      	lodsb
  3363 00001998 2C80                    	sub	al, 80h
  3364 0000199A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3365 0000199E 66AB                    	stosw		; (R)
  3366                                  
  3367 000019A0 49                      	dec	ecx
  3368 000019A1 748B                    	jz	short lff44s_3	
  3369 000019A3 4D                      	dec	ebp
  3370 000019A4 75E8                    	jnz	short lff44s_2_2
  3371                                  	
  3372 000019A6 FE0D[F91F0000]          	dec	byte [faz]
  3373 000019AC 74C1                    	jz	short lff44s_9 
  3374 000019AE BD0B000000              	mov	ebp, 11
  3375 000019B3 EBC6                    	jmp	short lff44s_1
  3376                                  
  3377                                  load_44khz_mono_16_bit:
  3378                                  	; 18/11/2023
  3379 000019B5 F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3380                                  					; last of the file?
  3381 000019BC 7402                    	jz	short lff44m2_0		; no
  3382 000019BE F9                      	stc
  3383 000019BF C3                      	retn
  3384                                  
  3385                                  lff44m2_0:
  3386 000019C0 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3387                                          ;mov	edx, [loadsize]
  3388                                  
  3389                                  	; esi = buffer address
  3390                                  	;; edx = buffer size
  3391                                  
  3392                                  	; load file into memory
  3393                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000019C5 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000019CB 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000019CD 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000019D3 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000019D8 CD40                <1>  int 40h
  3394 000019DA 724D                    	jc	short lff44m2_7 ; error !
  3395                                  
  3396 000019DC BF[00300000]            	mov	edi, audio_buffer
  3397                                  	
  3398 000019E1 D1E8                    	shr	eax, 1
  3399 000019E3 7505                    	jnz	short lff44m2_8
  3400 000019E5 E9B2F0FFFF              	jmp	lff44_eof
  3401                                  
  3402                                  lff44m2_8:
  3403 000019EA 89C1                    	mov	ecx, eax	; word count
  3404                                  lff44m2_9:
  3405 000019EC BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3406 000019F1 C605[F91F0000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3407                                  lff44m2_1:
  3408                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3409                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3410 000019F8 66AD                    	lodsw
  3411 000019FA 31D2                    	xor	edx, edx
  3412 000019FC 49                      	dec	ecx
  3413 000019FD 7403                    	jz	short lff44m2_2_1
  3414 000019FF 668B16                  	mov	dx, [esi]
  3415                                  lff44m2_2_1:	
  3416                                  	; ax = [previous_val]
  3417                                  	; dx = [next_val]
  3418 00001A02 E80B020000              	call	interpolating_2_16bit_mono
  3419 00001A07 E31B                    	jecxz	lff44m2_3
  3420                                  lff44m2_2_2:
  3421 00001A09 66AD                    	lodsw
  3422 00001A0B 66AB                    	stosw		; (L)eft Channel
  3423 00001A0D 66AB                    	stosw		; (R)ight Channel
  3424                                  
  3425 00001A0F 49                      	dec	ecx
  3426 00001A10 7412                    	jz	short lff44m2_3	
  3427 00001A12 4D                      	dec	ebp
  3428 00001A13 75F4                    	jnz	short lff44m2_2_2
  3429                                  	
  3430 00001A15 FE0D[F91F0000]          	dec	byte [faz]
  3431 00001A1B 74CF                    	jz	short lff44m2_9 
  3432 00001A1D BD0B000000              	mov	ebp, 11
  3433 00001A22 EBD4                    	jmp	short lff44m2_1
  3434                                  
  3435                                  lff44m2_3:
  3436                                  lff44s2_3:
  3437 00001A24 E95BF0FFFF              	jmp	lff44_3	; padfill
  3438                                  		; (put zeros in the remain words of the buffer)
  3439                                  lff44m2_7:
  3440                                  lff44s2_7:
  3441 00001A29 E977F0FFFF              	jmp	lff44_5  ; error
  3442                                  
  3443                                  load_44khz_stereo_16_bit:
  3444                                  	; 18/11/2023
  3445 00001A2E F605[EC220000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3446                                  					; last of the file?
  3447 00001A35 7402                    	jz	short lff44s2_0		; no
  3448 00001A37 F9                      	stc
  3449 00001A38 C3                      	retn
  3450                                  
  3451                                  lff44s2_0:
  3452 00001A39 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3453                                          ;mov	edx, [loadsize]
  3454                                  
  3455                                  	; esi = buffer address
  3456                                  	;; edx = buffer size
  3457                                  
  3458                                  	; load file into memory
  3459                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001A3E 8B1D[FA1F0000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001A44 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001A46 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001A4C B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001A51 CD40                <1>  int 40h
  3460 00001A53 72D4                    	jc	short lff44s2_7 ; error !
  3461                                  
  3462 00001A55 BF[00300000]            	mov	edi, audio_buffer
  3463                                  	
  3464 00001A5A C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3465 00001A5D 7505                    	jnz	short lff44s2_8
  3466 00001A5F E938F0FFFF              	jmp	lff44_eof
  3467                                  
  3468                                  lff44s2_8:
  3469 00001A64 89C1                    	mov	ecx, eax	; dword count
  3470                                  lff44s2_9:
  3471 00001A66 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3472 00001A6B C605[F91F0000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3473                                  lff44s2_1:
  3474                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3475                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3476 00001A72 66AD                    	lodsw
  3477 00001A74 89C3                    	mov	ebx, eax
  3478 00001A76 66AD                    	lodsw
  3479                                  	;mov	dx, [esi]
  3480                                  	;mov	[next_val_l], dx
  3481                                  	;mov	dx, [esi+2]
  3482                                  	; 26/11/2023
  3483 00001A78 8B16                    	mov	edx, [esi]
  3484 00001A7A 668915[F51F0000]        	mov	[next_val_l], dx
  3485 00001A81 C1EA10                  	shr	edx, 16
  3486 00001A84 49                      	dec	ecx
  3487 00001A85 7509                    	jnz	short lff44s2_2_1
  3488 00001A87 31D2                    	xor	edx, edx ; 0
  3489 00001A89 668915[F51F0000]        	mov	[next_val_l], dx
  3490                                  lff44s2_2_1:
  3491                                  	; bx = [previous_val_l]
  3492                                  	; ax = [previous_val_r]
  3493                                  	; [next_val_l]
  3494                                  	; dx = [next_val_r]
  3495 00001A90 E895010000              	call	interpolating_2_16bit_stereo
  3496 00001A95 E38D                    	jecxz	lff44s2_3
  3497                                  lff44s2_2_2:
  3498                                  	;movsw		; (L)eft Channel
  3499                                  	;movsw		; (R)ight Channel
  3500 00001A97 A5                      	movsd
  3501                                  
  3502 00001A98 49                      	dec	ecx
  3503 00001A99 7489                    	jz	short lff44s2_3	
  3504 00001A9B 4D                      	dec	ebp
  3505 00001A9C 75F9                    	jnz	short lff44s2_2_2
  3506                                  	
  3507 00001A9E FE0D[F91F0000]          	dec	byte [faz]
  3508 00001AA4 74C0                    	jz	short lff44s2_9 
  3509 00001AA6 BD0B000000              	mov	ebp, 11
  3510 00001AAB EBC5                    	jmp	short lff44s2_1
  3511                                  
  3512                                  ; .....................
  3513                                  
  3514                                  interpolating_3_8bit_mono:
  3515                                  	; 16/11/2023
  3516                                  	; al = [previous_val]
  3517                                  	; dl = [next_val]
  3518                                  	; original-interpolated-interpolated
  3519 00001AAD 88C3                    	mov	bl, al
  3520 00001AAF 2C80                    	sub	al, 80h
  3521 00001AB1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3522 00001AB5 66AB                    	stosw		; original sample (L)
  3523 00001AB7 66AB                    	stosw		; original sample (R)
  3524 00001AB9 88D8                    	mov	al, bl
  3525 00001ABB 00D0                    	add	al, dl	
  3526 00001ABD D0D8                    	rcr	al, 1
  3527 00001ABF 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3528 00001AC1 00D8                    	add	al, bl
  3529 00001AC3 D0D8                    	rcr	al, 1
  3530 00001AC5 2C80                    	sub	al, 80h
  3531 00001AC7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3532 00001ACB 66AB                    	stosw		; interpolated sample 1 (L)
  3533 00001ACD 66AB                    	stosw		; interpolated sample 1 (R)
  3534 00001ACF 88F8                    	mov	al, bh
  3535 00001AD1 00D0                    	add	al, dl	; [next_val]
  3536 00001AD3 D0D8                    	rcr	al, 1
  3537 00001AD5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3538 00001AD9 66AB                    	stosw		; interpolated sample 2 (L)
  3539 00001ADB 66AB                    	stosw		; interpolated sample 2 (R)
  3540 00001ADD C3                      	retn
  3541                                  
  3542                                  interpolating_3_8bit_stereo:
  3543                                  	; 16/11/2023
  3544                                  	; al = [previous_val_l]
  3545                                  	; ah = [previous_val_r]
  3546                                  	; dl = [next_val_l]
  3547                                  	; dh = [next_val_r]	
  3548                                  	; original-interpolated-interpolated
  3549 00001ADE 89C3                    	mov	ebx, eax
  3550 00001AE0 2C80                    	sub	al, 80h
  3551 00001AE2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3552 00001AE6 66AB                    	stosw		; original sample (L)
  3553 00001AE8 88F8                    	mov	al, bh
  3554 00001AEA 2C80                    	sub	al, 80h
  3555 00001AEC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3556 00001AF0 66AB                    	stosw		; original sample (R)
  3557 00001AF2 88D8                    	mov	al, bl
  3558 00001AF4 00D0                    	add	al, dl	; [next_val_l]	
  3559 00001AF6 D0D8                    	rcr	al, 1
  3560 00001AF8 50                      	push	eax ; *	; al = interpolated middle (L) (temporary)
  3561 00001AF9 00D8                    	add	al, bl	; [previous_val_l]
  3562 00001AFB D0D8                    	rcr	al, 1
  3563 00001AFD 2C80                    	sub	al, 80h
  3564 00001AFF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3565 00001B03 66AB                    	stosw		; interpolated sample 1 (L)
  3566 00001B05 88F8                    	mov	al, bh
  3567 00001B07 00F0                    	add	al, dh	; [next_val_r]
  3568 00001B09 D0D8                    	rcr	al, 1
  3569 00001B0B 50                      	push	eax ; ** ; al = interpolated middle (R) (temporary)
  3570 00001B0C 00F8                    	add	al, bh	; [previous_val_r]
  3571 00001B0E D0D8                    	rcr	al, 1
  3572 00001B10 2C80                    	sub	al, 80h
  3573 00001B12 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3574 00001B16 66AB                    	stosw		; interpolated sample 1 (R)
  3575 00001B18 5B                      	pop	ebx ; **
  3576 00001B19 58                      	pop	eax ; *
  3577 00001B1A 00D0                    	add	al, dl	; [next_val_l]
  3578 00001B1C D0D8                    	rcr	al, 1
  3579 00001B1E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3580 00001B22 66AB                    	stosw		; interpolated sample 2 (L)
  3581 00001B24 88D8                    	mov	al, bl
  3582 00001B26 00F0                    	add	al, dh	; [next_val_r]
  3583 00001B28 D0D8                    	rcr	al, 1
  3584 00001B2A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3585 00001B2E 66AB                    	stosw		; interpolated sample 2 (R)
  3586 00001B30 C3                      	retn
  3587                                  
  3588                                  interpolating_2_8bit_mono:
  3589                                  	; 16/11/2023
  3590                                  	; al = [previous_val]
  3591                                  	; dl = [next_val]
  3592                                  	; original-interpolated
  3593 00001B31 88C3                    	mov	bl, al
  3594 00001B33 2C80                    	sub	al, 80h
  3595 00001B35 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3596 00001B39 66AB                    	stosw		; original sample (L)
  3597 00001B3B 66AB                    	stosw		; original sample (R)
  3598 00001B3D 88D8                    	mov	al, bl
  3599 00001B3F 00D0                    	add	al, dl	
  3600 00001B41 D0D8                    	rcr	al, 1
  3601 00001B43 2C80                    	sub	al, 80h
  3602 00001B45 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3603 00001B49 66AB                    	stosw		; interpolated sample (L)
  3604 00001B4B 66AB                    	stosw		; interpolated sample (R)
  3605 00001B4D C3                      	retn
  3606                                  
  3607                                  interpolating_2_8bit_stereo:
  3608                                  	; 16/11/2023
  3609                                  	; al = [previous_val_l]
  3610                                  	; ah = [previous_val_r]
  3611                                  	; dl = [next_val_l]
  3612                                  	; dh = [next_val_r]	
  3613                                  	; original-interpolated
  3614 00001B4E 89C3                    	mov	ebx, eax
  3615 00001B50 2C80                    	sub	al, 80h
  3616 00001B52 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3617 00001B56 66AB                    	stosw		; original sample (L)
  3618 00001B58 88F8                    	mov	al, bh
  3619 00001B5A 2C80                    	sub	al, 80h
  3620 00001B5C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3621 00001B60 66AB                    	stosw		; original sample (R)
  3622 00001B62 88D8                    	mov	al, bl	; [previous_val_l]
  3623 00001B64 00D0                    	add	al, dl	; [next_val_l]	
  3624 00001B66 D0D8                    	rcr	al, 1
  3625 00001B68 2C80                    	sub	al, 80h
  3626 00001B6A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3627 00001B6E 66AB                    	stosw		; interpolated sample (L)
  3628 00001B70 88F8                    	mov	al, bh
  3629 00001B72 00F0                    	add	al, dh	; [next_val_r]
  3630 00001B74 D0D8                    	rcr	al, 1
  3631 00001B76 2C80                    	sub	al, 80h
  3632 00001B78 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3633 00001B7C 66AB                    	stosw		; interpolated sample (R)
  3634 00001B7E C3                      	retn
  3635                                  
  3636                                  interpolating_3_16bit_mono:
  3637                                  	; 16/11/2023
  3638                                  	; ax = [previous_val]
  3639                                  	; dx = [next_val]
  3640                                  	; original-interpolated-interpolated
  3641                                  
  3642 00001B7F 66AB                    	stosw		; original sample (L)
  3643 00001B81 66AB                    	stosw		; original sample (R)
  3644 00001B83 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3645 00001B86 50                      	push	eax ; *	; [previous_val]
  3646 00001B87 80C680                  	add	dh, 80h
  3647 00001B8A 6601D0                  	add	ax, dx
  3648 00001B8D 66D1D8                  	rcr	ax, 1
  3649 00001B90 5B                      	pop	ebx ; *		
  3650 00001B91 93                      	xchg	ebx, eax ; bx  = interpolated middle (temporary)
  3651 00001B92 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  3652 00001B95 66D1D8                  	rcr	ax, 1
  3653 00001B98 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3654 00001B9B 66AB                    	stosw 		; interpolated sample 1 (L)
  3655 00001B9D 66AB                    	stosw		; interpolated sample 1 (R)
  3656 00001B9F 89D8                    	mov	eax, ebx
  3657 00001BA1 6601D0                  	add	ax, dx	 ;interpolated middle + [next_val]
  3658 00001BA4 66D1D8                  	rcr	ax, 1
  3659 00001BA7 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3660 00001BAA 66AB                    	stosw		; interpolated sample 2 (L)
  3661 00001BAC 66AB                    	stosw		; interpolated sample 2 (R)
  3662 00001BAE C3                      	retn
  3663                                  
  3664                                  interpolating_3_16bit_stereo:
  3665                                  	; 16/11/2023
  3666                                  	; bx = [previous_val_l]
  3667                                  	; ax = [previous_val_r]
  3668                                  	; [next_val_l]
  3669                                  	; dx = [next_val_r]
  3670                                  	; original-interpolated-interpolated
  3671                                  
  3672 00001BAF 93                      	xchg	eax, ebx
  3673 00001BB0 66AB                    	stosw		; original sample (L)
  3674 00001BB2 93                      	xchg	eax, ebx
  3675 00001BB3 66AB                    	stosw		; original sample (R)
  3676 00001BB5 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3677 00001BB8 50                      	push	eax ; *	; [previous_val_r]
  3678 00001BB9 80C780                  	add	bh, 80h
  3679 00001BBC 8005[F61F0000]80        	add	byte [next_val_l+1], 80h
  3680 00001BC3 66A1[F51F0000]          	mov	ax, [next_val_l]
  3681 00001BC9 6601D8                  	add	ax, bx	; [previous_val_l]
  3682 00001BCC 66D1D8                  	rcr	ax, 1
  3683 00001BCF 93                      	xchg	eax, ebx ; ax = [previous_val_l]
  3684 00001BD0 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  3685 00001BD3 66D1D8                  	rcr	ax, 1
  3686 00001BD6 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3687 00001BD9 66AB                    	stosw 		; interpolated sample 1 (L)
  3688 00001BDB 58                      	pop	eax  ; *
  3689 00001BDC 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  3690 00001BDF 52                      	push	edx  ; * ; [next_val_r]
  3691 00001BE0 92                      	xchg	eax, edx
  3692 00001BE1 6601D0                  	add	ax, dx	; [next_val_r] + [previous_val_r]
  3693 00001BE4 66D1D8                  	rcr	ax, 1	; / 2
  3694 00001BE7 50                      	push	eax ; ** ; interpolated middle (R)
  3695 00001BE8 6601D0                  	add	ax, dx	; + [previous_val_r]
  3696 00001BEB 66D1D8                  	rcr	ax, 1
  3697 00001BEE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3698 00001BF1 66AB                    	stosw 		; interpolated sample 1 (R)
  3699 00001BF3 66A1[F51F0000]          	mov	ax, [next_val_l]
  3700 00001BF9 6601D8                  	add	ax, bx	; + interpolated middle (L)
  3701 00001BFC 66D1D8                  	rcr	ax, 1
  3702 00001BFF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3703 00001C02 66AB                    	stosw 		; interpolated sample 2 (L)
  3704 00001C04 58                      	pop	eax ; **
  3705 00001C05 5A                      	pop	edx ; *	
  3706 00001C06 6601D0                  	add	ax, dx	; interpolated middle + [next_val_r]
  3707 00001C09 66D1D8                  	rcr	ax, 1	; / 2
  3708 00001C0C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3709 00001C0F 66AB                    	stosw 		; interpolated sample 2 (L)
  3710 00001C11 C3                      	retn
  3711                                  
  3712                                  interpolating_2_16bit_mono:
  3713                                  	; 16/11/2023
  3714                                  	; ax = [previous_val]
  3715                                  	; dx = [next_val]
  3716                                  	; original-interpolated
  3717                                  
  3718 00001C12 66AB                    	stosw		; original sample (L)
  3719 00001C14 66AB                    	stosw		; original sample (R)
  3720 00001C16 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3721 00001C19 80C680                  	add	dh, 80h
  3722 00001C1C 6601D0                  	add	ax, dx
  3723 00001C1F 66D1D8                  	rcr	ax, 1
  3724 00001C22 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3725 00001C25 66AB                    	stosw		; interpolated sample (L)
  3726 00001C27 66AB                    	stosw		; interpolated sample (R)
  3727 00001C29 C3                      	retn
  3728                                  
  3729                                  interpolating_2_16bit_stereo:
  3730                                  	; 17/01/2025
  3731                                  	; 16/11/2023
  3732                                  	; bx = [previous_val_l]
  3733                                  	; ax = [previous_val_r]
  3734                                  	; [next_val_l]
  3735                                  	; dx = [next_val_r]
  3736                                  	; original-interpolated
  3737                                  
  3738 00001C2A 93                      	xchg	eax, ebx
  3739 00001C2B 66AB                    	stosw		; original sample (L)
  3740 00001C2D 93                      	xchg	eax, ebx
  3741 00001C2E 66AB                    	stosw		; original sample (R)
  3742 00001C30 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3743 00001C33 80C680                  	add	dh, 80h
  3744 00001C36 6601D0                  	add	ax, dx	; [previous_val_r] + [next_val_r]
  3745 00001C39 66D1D8                  	rcr	ax, 1	; / 2
  3746                                  	; 17/01/2025
  3747 00001C3C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3748                                  	;push	eax ; *	; interpolated sample (R)
  3749                                  	; 17/01/2025
  3750 00001C3F C1E010                  	shl	eax, 16
  3751 00001C42 66A1[F51F0000]          	mov	ax, [next_val_l]
  3752 00001C48 80C480                  	add	ah, 80h
  3753 00001C4B 80C780                  	add	bh, 80h
  3754 00001C4E 6601D8                  	add	ax, bx	; [next_val_l] + [previous_val_l]
  3755 00001C51 66D1D8                  	rcr	ax, 1	; / 2
  3756 00001C54 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3757                                  	; 17/01/2025
  3758                                  	;stosw 		; interpolated sample (L)
  3759                                  	;pop	eax ; *
  3760                                  	;sub	ah, 80h	; -32768 to +32767 format again
  3761                                  	;stosw 		; interpolated sample (R)
  3762                                  	; 17/01/2025
  3763 00001C57 AB                      	stosd
  3764 00001C58 C3                      	retn
  3765                                  
  3766                                  interpolating_5_8bit_mono:
  3767                                  	; 17/11/2023
  3768                                  	; al = [previous_val]
  3769                                  	; dl = [next_val]
  3770                                  	; original-interpltd-interpltd-interpltd-interpltd
  3771 00001C59 88C3                    	mov	bl, al
  3772 00001C5B 2C80                    	sub	al, 80h
  3773 00001C5D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3774 00001C61 66AB                    	stosw		; original sample (L)
  3775 00001C63 66AB                    	stosw		; original sample (R)
  3776 00001C65 88D8                    	mov	al, bl
  3777 00001C67 00D0                    	add	al, dl	
  3778 00001C69 D0D8                    	rcr	al, 1
  3779 00001C6B 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3780 00001C6D 00D8                    	add	al, bl  ; [previous_val]
  3781 00001C6F D0D8                    	rcr	al, 1 	
  3782 00001C71 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  3783 00001C73 00D8                    	add	al, bl
  3784 00001C75 D0D8                    	rcr	al, 1
  3785 00001C77 2C80                    	sub	al, 80h
  3786 00001C79 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3787 00001C7D 66AB                    	stosw		; interpolated sample 1 (L)
  3788 00001C7F 66AB                    	stosw		; interpolated sample 1 (R)
  3789 00001C81 88F8                    	mov	al, bh
  3790 00001C83 00F0                    	add	al, dh
  3791 00001C85 D0D8                    	rcr	al, 1
  3792 00001C87 2C80                    	sub	al, 80h
  3793 00001C89 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3794 00001C8D 66AB                    	stosw		; interpolated sample 2 (L)
  3795 00001C8F 66AB                    	stosw		; interpolated sample 2 (R)
  3796 00001C91 88F8                    	mov	al, bh
  3797 00001C93 00D0                    	add	al, dl	; [next_val]
  3798 00001C95 D0D8                    	rcr	al, 1
  3799 00001C97 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  3800 00001C99 00F8                    	add	al, bh
  3801 00001C9B D0D8                    	rcr	al, 1
  3802 00001C9D 2C80                    	sub	al, 80h
  3803 00001C9F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3804 00001CA3 66AB                    	stosw		; interpolated sample 3 (L)
  3805 00001CA5 66AB                    	stosw		; interpolated sample 3 (R)
  3806 00001CA7 88F0                    	mov	al, dh
  3807 00001CA9 00D0                    	add	al, dl
  3808 00001CAB D0D8                    	rcr	al, 1
  3809 00001CAD 2C80                    	sub	al, 80h
  3810 00001CAF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3811 00001CB3 66AB                    	stosw		; interpolated sample 4 (L)
  3812 00001CB5 66AB                    	stosw		; interpolated sample 4 (R)
  3813 00001CB7 C3                      	retn
  3814                                  
  3815                                  interpolating_5_8bit_stereo:
  3816                                  	; 17/11/2023
  3817                                  	; al = [previous_val_l]
  3818                                  	; ah = [previous_val_r]
  3819                                  	; dl = [next_val_l]
  3820                                  	; dh = [next_val_r]	
  3821                                  	; original-interpltd-interpltd-interpltd-interpltd
  3822 00001CB8 89C3                    	mov	ebx, eax
  3823 00001CBA 2C80                    	sub	al, 80h
  3824 00001CBC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3825 00001CC0 66AB                    	stosw		; original sample (L)
  3826 00001CC2 88F8                    	mov	al, bh
  3827 00001CC4 2C80                    	sub	al, 80h
  3828 00001CC6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3829 00001CCA 66AB                    	stosw		; original sample (R)
  3830 00001CCC 52                      	push	edx ; *
  3831 00001CCD 88D8                    	mov	al, bl
  3832 00001CCF 00D0                    	add	al, dl	; [next_val_l]
  3833 00001CD1 D0D8                    	rcr	al, 1
  3834 00001CD3 50                      	push	eax ; **	; al = interpolated middle (L) (temporary)
  3835 00001CD4 00D8                    	add	al, bl	; [previous_val_l]
  3836 00001CD6 D0D8                    	rcr	al, 1
  3837 00001CD8 86D8                    	xchg	al, bl	
  3838 00001CDA 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3839 00001CDC D0D8                    	rcr	al, 1
  3840 00001CDE 2C80                    	sub	al, 80h
  3841 00001CE0 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3842 00001CE4 66AB                    	stosw		; interpolated sample 1 (L)
  3843 00001CE6 88F8                    	mov	al, bh
  3844 00001CE8 00F0                    	add	al, dh	; [next_val_r]
  3845 00001CEA D0D8                    	rcr	al, 1
  3846 00001CEC 50                      	push	eax ; *** ; al = interpolated middle (R) (temporary)
  3847 00001CED 00F8                    	add	al, bh	; [previous_val_r]
  3848 00001CEF D0D8                    	rcr	al, 1
  3849 00001CF1 86F8                    	xchg	al, bh	
  3850 00001CF3 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3851 00001CF5 D0D8                    	rcr	al, 1
  3852 00001CF7 2C80                    	sub	al, 80h
  3853 00001CF9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3854 00001CFD 66AB                    	stosw		; interpolated sample 1 (R)
  3855 00001CFF 5A                      	pop	edx ; ***
  3856 00001D00 58                      	pop	eax ; **	; al = interpolated middle (L) (temporary)
  3857 00001D01 86D8                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3858 00001D03 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  3859 00001D05 D0D8                    	rcr	al, 1
  3860 00001D07 2C80                    	sub	al, 80h
  3861 00001D09 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3862 00001D0D 66AB                    	stosw		; interpolated sample 2 (L)	
  3863 00001D0F 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  3864 00001D11 86F8                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  3865 00001D13 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  3866 00001D15 D0D8                    	rcr	al, 1
  3867 00001D17 2C80                    	sub	al, 80h
  3868 00001D19 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3869 00001D1D 66AB                    	stosw		; interpolated sample 2 (R)
  3870 00001D1F 5A                      	pop	edx ; *
  3871 00001D20 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  3872 00001D22 00D0                    	add	al, dl	; [next_val_l]
  3873 00001D24 D0D8                    	rcr	al, 1
  3874 00001D26 86D8                    	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  3875 00001D28 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  3876 00001D2A D0D8                    	rcr	al, 1
  3877 00001D2C 2C80                    	sub	al, 80h
  3878 00001D2E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3879 00001D32 66AB                    	stosw		; interpolated sample 3 (L)
  3880 00001D34 88F8                    	mov	al, bh	
  3881 00001D36 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  3882 00001D38 D0D8                    	rcr	al, 1
  3883 00001D3A 86F8                    	xchg	al, bh	; al = interpolated middle (R)
  3884 00001D3C 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  3885 00001D3E D0D8                    	rcr	al, 1
  3886 00001D40 2C80                    	sub	al, 80h
  3887 00001D42 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3888 00001D46 66AB                    	stosw		; interpolated sample 3 (R)
  3889 00001D48 88D8                    	mov	al, bl
  3890 00001D4A 00D0                    	add	al, dl	; [next_val_l]
  3891 00001D4C D0D8                    	rcr	al, 1
  3892 00001D4E 2C80                    	sub	al, 80h
  3893 00001D50 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3894 00001D54 66AB                    	stosw		; interpolated sample 4 (L)
  3895 00001D56 88F8                    	mov	al, bh
  3896 00001D58 00F0                    	add	al, dh	; [next_val_r]
  3897 00001D5A D0D8                    	rcr	al, 1
  3898 00001D5C 2C80                    	sub	al, 80h
  3899 00001D5E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3900 00001D62 66AB                    	stosw		; interpolated sample 4 (R)
  3901 00001D64 C3                      	retn
  3902                                  
  3903                                  interpolating_4_8bit_mono:
  3904                                  	; 17/11/2023
  3905                                  	; al = [previous_val]
  3906                                  	; dl = [next_val]
  3907                                  	; original-interpolated-interpolated-interpolated
  3908 00001D65 88C3                    	mov	bl, al
  3909 00001D67 2C80                    	sub	al, 80h
  3910 00001D69 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3911 00001D6D 66AB                    	stosw		; original sample (L)
  3912 00001D6F 66AB                    	stosw		; original sample (R)
  3913 00001D71 88D8                    	mov	al, bl
  3914 00001D73 00D0                    	add	al, dl	
  3915 00001D75 D0D8                    	rcr	al, 1
  3916 00001D77 86D8                    	xchg	al, bl  ; al = [previous_val]
  3917 00001D79 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  3918 00001D7B D0D8                    	rcr	al, 1 	
  3919 00001D7D 2C80                    	sub	al, 80h
  3920 00001D7F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3921 00001D83 66AB                    	stosw		; interpolated sample 1 (L)
  3922 00001D85 66AB                    	stosw		; interpolated sample 1 (R)
  3923 00001D87 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  3924 00001D89 2C80                    	sub	al, 80h
  3925 00001D8B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3926 00001D8F 66AB                    	stosw		; interpolated sample 2 (L)
  3927 00001D91 66AB                    	stosw		; interpolated sample 2 (R)
  3928 00001D93 88D8                    	mov	al, bl
  3929 00001D95 00D0                    	add	al, dl	; [next_val]
  3930 00001D97 D0D8                    	rcr	al, 1
  3931 00001D99 2C80                    	sub	al, 80h
  3932 00001D9B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3933 00001D9F 66AB                    	stosw		; interpolated sample 3 (L)
  3934 00001DA1 66AB                    	stosw		; interpolated sample 3 (R)
  3935 00001DA3 C3                      	retn
  3936                                  
  3937                                  interpolating_4_8bit_stereo:
  3938                                  	; 17/11/2023
  3939                                  	; al = [previous_val_l]
  3940                                  	; ah = [previous_val_r]
  3941                                  	; dl = [next_val_l]
  3942                                  	; dh = [next_val_r]	
  3943                                  	; original-interpolated-interpolated-interpolated
  3944 00001DA4 89C3                    	mov	ebx, eax
  3945 00001DA6 2C80                    	sub	al, 80h
  3946 00001DA8 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3947 00001DAC 66AB                    	stosw		; original sample (L)
  3948 00001DAE 88F8                    	mov	al, bh
  3949 00001DB0 2C80                    	sub	al, 80h
  3950 00001DB2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3951 00001DB6 66AB                    	stosw		; original sample (R)
  3952 00001DB8 88D8                    	mov	al, bl
  3953 00001DBA 00D0                    	add	al, dl	; [next_val_l]
  3954 00001DBC D0D8                    	rcr	al, 1
  3955 00001DBE 86D8                    	xchg	al, bl	; al = [previous_val_l]
  3956 00001DC0 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  3957 00001DC2 D0D8                    	rcr	al, 1
  3958 00001DC4 2C80                    	sub	al, 80h
  3959 00001DC6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3960 00001DCA 66AB                    	stosw		; interpolated sample 1 (L)
  3961 00001DCC 88F8                    	mov	al, bh
  3962 00001DCE 00F0                    	add	al, dh	; [next_val_r]
  3963 00001DD0 D0D8                    	rcr	al, 1
  3964 00001DD2 86F8                    	xchg	al, bh	; al = [previous_val_h]
  3965 00001DD4 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  3966 00001DD6 D0D8                    	rcr	al, 1
  3967 00001DD8 2C80                    	sub	al, 80h
  3968 00001DDA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3969 00001DDE 66AB                    	stosw		; interpolated sample 1 (R)
  3970 00001DE0 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  3971 00001DE2 2C80                    	sub	al, 80h
  3972 00001DE4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3973 00001DE8 66AB                    	stosw		; interpolated sample 2 (L)
  3974 00001DEA 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  3975 00001DEC 2C80                    	sub	al, 80h
  3976 00001DEE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3977 00001DF2 66AB                    	stosw		; interpolated sample 2 (L)
  3978 00001DF4 88D8                    	mov	al, bl
  3979 00001DF6 00D0                    	add	al, dl	; [next_val_l]
  3980 00001DF8 D0D8                    	rcr	al, 1
  3981 00001DFA 2C80                    	sub	al, 80h
  3982 00001DFC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3983 00001E00 66AB                    	stosw		; interpolated sample 3 (L)
  3984 00001E02 88F8                    	mov	al, bh
  3985 00001E04 00F0                    	add	al, dh	; [next_val_r]
  3986 00001E06 D0D8                    	rcr	al, 1
  3987 00001E08 2C80                    	sub	al, 80h
  3988 00001E0A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3989 00001E0E 66AB                    	stosw		; interpolated sample 3 (R)
  3990 00001E10 C3                      	retn
  3991                                  
  3992                                  interpolating_5_16bit_mono:
  3993                                  	; 18/11/2023
  3994                                  	; ax = [previous_val]
  3995                                  	; dx = [next_val]
  3996                                  	; original-interpltd-interpltd-interpltd-interpltd
  3997 00001E11 66AB                    	stosw		; original sample (L)
  3998 00001E13 66AB                    	stosw		; original sample (R)
  3999 00001E15 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4000 00001E18 89C3                    	mov	ebx, eax ; [previous_val]
  4001 00001E1A 80C680                  	add	dh, 80h
  4002 00001E1D 6601D0                  	add	ax, dx
  4003 00001E20 66D1D8                  	rcr	ax, 1
  4004 00001E23 50                      	push	eax ; *	; interpolated middle (temporary)
  4005 00001E24 6601D8                  	add	ax, bx	; interpolated middle + [previous_val] 
  4006 00001E27 66D1D8                  	rcr	ax, 1
  4007 00001E2A 50                      	push	eax ; **	; interpolated 1st quarter (temporary)
  4008 00001E2B 6601D8                  	add	ax, bx	; 1st quarter + [previous_val]
  4009 00001E2E 66D1D8                  	rcr	ax, 1	
  4010 00001E31 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4011 00001E34 66AB                    	stosw 		; interpolated sample 1 (L)
  4012 00001E36 66AB                    	stosw		; interpolated sample 1 (R)
  4013 00001E38 58                      	pop	eax ; **	
  4014 00001E39 5B                      	pop	ebx ; *
  4015 00001E3A 6601D8                  	add	ax, bx	; 1st quarter + middle
  4016 00001E3D 66D1D8                  	rcr	ax, 1	; / 2
  4017 00001E40 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  4018 00001E43 66AB                    	stosw		; interpolated sample 2 (L)
  4019 00001E45 66AB                    	stosw		; interpolated sample 2 (R)		
  4020 00001E47 89D8                    	mov	eax, ebx
  4021 00001E49 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4022 00001E4C 66D1D8                  	rcr	ax, 1
  4023 00001E4F 50                      	push	eax ; *	; interpolated 3rd quarter (temporary)
  4024 00001E50 6601D8                  	add	ax, bx	; + interpolated middle
  4025 00001E53 66D1D8                  	rcr	ax, 1
  4026 00001E56 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4027 00001E59 66AB                    	stosw		; interpolated sample 3 (L)
  4028 00001E5B 66AB                    	stosw		; interpolated sample 3 (R)
  4029 00001E5D 58                      	pop	eax ; *	
  4030 00001E5E 6601D0                  	add	ax, dx	; 3rd quarter + [next_val]
  4031 00001E61 66D1D8                  	rcr	ax, 1	; / 2
  4032 00001E64 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4033 00001E67 66AB                    	stosw		; interpolated sample 4 (L)
  4034 00001E69 66AB                    	stosw		; interpolated sample 4 (R)
  4035 00001E6B C3                      	retn
  4036                                  
  4037                                  interpolating_5_16bit_stereo:
  4038                                  	; 18/11/2023
  4039                                  	; bx = [previous_val_l]
  4040                                  	; ax = [previous_val_r]
  4041                                  	; [next_val_l]
  4042                                  	; [next_val_r]
  4043                                  	; original-interpltd-interpltd-interpltd-interpltd
  4044 00001E6C 51                      	push	ecx ; !
  4045 00001E6D 93                      	xchg	eax, ebx
  4046 00001E6E 66AB                    	stosw		; original sample (L)
  4047 00001E70 93                      	xchg	eax, ebx
  4048 00001E71 66AB                    	stosw		; original sample (R)
  4049 00001E73 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4050 00001E76 50                      	push	eax ; *	; [previous_val_r]
  4051 00001E77 80C780                  	add	bh, 80h
  4052 00001E7A 8005[F61F0000]80        	add	byte [next_val_l+1], 80h
  4053 00001E81 66A1[F51F0000]          	mov	ax, [next_val_l]
  4054 00001E87 6601D8                  	add	ax, bx	; [previous_val_l]
  4055 00001E8A 66D1D8                  	rcr	ax, 1
  4056 00001E8D 89C1                    	mov	ecx, eax ; interpolated middle (L)
  4057 00001E8F 6601D8                  	add	ax, bx	
  4058 00001E92 66D1D8                  	rcr	ax, 1
  4059 00001E95 89C2                    	mov	edx, eax ; interpolated 1st quarter (L)	
  4060 00001E97 6601D8                  	add	ax, bx	; [previous_val_l]
  4061 00001E9A 66D1D8                  	rcr	ax, 1
  4062 00001E9D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4063 00001EA0 66AB                    	stosw 		; interpolated sample 1 (L)
  4064 00001EA2 89C8                    	mov	eax, ecx
  4065 00001EA4 6601D0                  	add	ax, dx	; middle (L) + 1st quarter (L) 
  4066 00001EA7 66D1D8                  	rcr	ax, 1	; / 2
  4067 00001EAA 89C3                    	mov	ebx, eax  ; interpolated sample 2 (L)
  4068 00001EAC 5A                      	pop	edx ; *	; [previous_val_r]
  4069 00001EAD 89D0                    	mov	eax, edx
  4070 00001EAF 8005[F81F0000]80        	add	byte [next_val_r+1], 80h
  4071 00001EB6 660305[F71F0000]        	add	ax, [next_val_r]
  4072 00001EBD 66D1D8                  	rcr	ax, 1
  4073 00001EC0 50                      	push	eax ; *	; interpolated middle (R)
  4074 00001EC1 6601D0                  	add	ax, dx
  4075 00001EC4 66D1D8                  	rcr	ax, 1
  4076 00001EC7 50                      	push	eax ; ** ; interpolated 1st quarter (R)
  4077 00001EC8 6601D0                  	add	ax, dx	; [previous_val_r]
  4078 00001ECB 66D1D8                  	rcr	ax, 1
  4079 00001ECE 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4080 00001ED1 66AB                    	stosw 		; interpolated sample 1 (R)
  4081 00001ED3 89D8                    	mov	eax, ebx
  4082 00001ED5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4083 00001ED8 66AB                    	stosw 		; interpolated sample 2 (L)
  4084 00001EDA 58                      	pop	eax ; **
  4085 00001EDB 5A                      	pop	edx ; *
  4086 00001EDC 6601D0                  	add	ax, dx	; 1st quarter (R) + middle (R)
  4087 00001EDF 66D1D8                  	rcr	ax, 1	; / 2
  4088 00001EE2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4089 00001EE5 66AB                    	stosw 		; interpolated sample 2 (R)
  4090 00001EE7 89C8                    	mov	eax, ecx
  4091 00001EE9 660305[F51F0000]        	add	ax, [next_val_l]
  4092 00001EF0 66D1D8                  	rcr	ax, 1
  4093 00001EF3 50                      	push	eax ; * ; interpolated 3rd quarter (L)
  4094 00001EF4 6601C8                  	add	ax, cx	; interpolated middle (L)
  4095 00001EF7 66D1D8                  	rcr	ax, 1
  4096 00001EFA 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4097 00001EFD 66AB                    	stosw 		; interpolated sample 3 (L)
  4098 00001EFF 89D0                    	mov	eax, edx
  4099 00001F01 660305[F71F0000]        	add	ax, [next_val_r]
  4100 00001F08 66D1D8                  	rcr	ax, 1
  4101 00001F0B 50                      	push	eax ; ** ; interpolated 3rd quarter (R)
  4102 00001F0C 6601D0                  	add	ax, dx	; interpolated middle (R)
  4103 00001F0F 66D1D8                  	rcr	ax, 1
  4104 00001F12 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4105 00001F15 66AB                    	stosw 		; interpolated sample 3 (R)
  4106 00001F17 5B                      	pop	ebx ; **
  4107 00001F18 58                      	pop	eax ; *
  4108 00001F19 660305[F51F0000]        	add	ax, [next_val_l]
  4109 00001F20 66D1D8                  	rcr	ax, 1
  4110 00001F23 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4111 00001F26 66AB                    	stosw 		; interpolated sample 4 (L)
  4112 00001F28 89D8                    	mov	eax, ebx	
  4113 00001F2A 660305[F71F0000]        	add	ax, [next_val_r]
  4114 00001F31 66D1D8                  	rcr	ax, 1
  4115 00001F34 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4116 00001F37 66AB                    	stosw 		; interpolated sample 4 (R)
  4117 00001F39 59                      	pop	ecx ; !
  4118 00001F3A C3                      	retn
  4119                                  
  4120                                  interpolating_4_16bit_mono:
  4121                                  	; 18/11/2023
  4122                                  	; ax = [previous_val]
  4123                                  	; dx = [next_val]
  4124                                  	; original-interpolated
  4125                                  
  4126 00001F3B 66AB                    	stosw		; original sample (L)
  4127 00001F3D 66AB                    	stosw		; original sample (R)
  4128 00001F3F 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4129 00001F42 89C3                    	mov	ebx, eax ; [previous_val]
  4130 00001F44 80C680                  	add	dh, 80h
  4131 00001F47 6601D0                  	add	ax, dx	; [previous_val] + [next_val]
  4132 00001F4A 66D1D8                  	rcr	ax, 1
  4133 00001F4D 93                      	xchg	eax, ebx	
  4134 00001F4E 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  4135 00001F51 66D1D8                  	rcr	ax, 1
  4136 00001F54 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4137 00001F57 66AB                    	stosw 		; interpolated sample 1 (L)
  4138 00001F59 66AB                    	stosw		; interpolated sample 1 (R)
  4139 00001F5B 89D8                    	mov	eax, ebx ; interpolated middle
  4140 00001F5D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4141 00001F60 66AB                    	stosw 		; interpolated sample 2 (L)
  4142 00001F62 66AB                    	stosw		; interpolated sample 2 (R)
  4143 00001F64 89D8                    	mov	eax, ebx
  4144 00001F66 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4145 00001F69 66D1D8                  	rcr	ax, 1
  4146 00001F6C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4147 00001F6F 66AB                    	stosw		; interpolated sample 3 (L)
  4148 00001F71 66AB                    	stosw		; interpolated sample 3 (R)
  4149 00001F73 C3                      	retn
  4150                                  
  4151                                  interpolating_4_16bit_stereo:
  4152                                  	; 18/11/2023
  4153                                  	; bx = [previous_val_l]
  4154                                  	; ax = [previous_val_r]
  4155                                  	; [next_val_l]
  4156                                  	; [next_val_r]
  4157                                  	; original-interpolated-interpolated-interpolated
  4158 00001F74 93                      	xchg	eax, ebx
  4159 00001F75 66AB                    	stosw		; original sample (L)
  4160 00001F77 93                      	xchg	eax, ebx
  4161 00001F78 66AB                    	stosw		; original sample (R)
  4162 00001F7A 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4163 00001F7D 89C2                    	mov	edx, eax ; [previous_val_r]
  4164 00001F7F 80C780                  	add	bh, 80h
  4165 00001F82 8005[F61F0000]80        	add	byte [next_val_l+1], 80h
  4166 00001F89 66A1[F51F0000]          	mov	ax, [next_val_l]
  4167 00001F8F 6601D8                  	add	ax, bx	; [previous_val_l]
  4168 00001F92 66D1D8                  	rcr	ax, 1
  4169 00001F95 93                      	xchg	eax, ebx	
  4170 00001F96 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  4171 00001F99 66D1D8                  	rcr	ax, 1
  4172 00001F9C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4173 00001F9F 66AB                    	stosw 		; interpolated sample 1 (L)
  4174 00001FA1 8005[F81F0000]80        	add	byte [next_val_r+1], 80h
  4175 00001FA8 89D0                    	mov	eax, edx ; [previous_val_r]
  4176 00001FAA 660305[F71F0000]        	add	ax, [next_val_r]
  4177 00001FB1 66D1D8                  	rcr	ax, 1
  4178 00001FB4 92                      	xchg	eax, edx	
  4179 00001FB5 6601D0                  	add	ax, dx	; dx = interpolated middle (R)
  4180 00001FB8 66D1D8                  	rcr	ax, 1
  4181 00001FBB 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4182 00001FBE 66AB                    	stosw 		; interpolated sample 1 (R)
  4183 00001FC0 89D8                    	mov	eax, ebx
  4184 00001FC2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4185 00001FC5 66AB                    	stosw 		; interpolated sample 2 (L)
  4186 00001FC7 89D0                    	mov	eax, edx
  4187 00001FC9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4188 00001FCC 66AB                    	stosw 		; interpolated sample 2 (R)
  4189 00001FCE 89D8                    	mov	eax, ebx
  4190 00001FD0 660305[F51F0000]        	add	ax, [next_val_l]
  4191 00001FD7 66D1D8                  	rcr	ax, 1
  4192 00001FDA 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4193 00001FDD 66AB                    	stosw 		; interpolated sample 3 (L)
  4194 00001FDF 89D0                    	mov	eax, edx
  4195 00001FE1 660305[F71F0000]        	add	ax, [next_val_r]
  4196 00001FE8 66D1D8                  	rcr	ax, 1
  4197 00001FEB 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4198 00001FEE 66AB                    	stosw 		; interpolated sample 3 (R)
  4199 00001FF0 C3                      	retn
  4200                                  
  4201                                  ; 13/11/2023
  4202                                  previous_val:
  4203 00001FF1 0000                    previous_val_l: dw 0
  4204 00001FF3 0000                    previous_val_r: dw 0
  4205                                  next_val:
  4206 00001FF5 0000                    next_val_l: dw 0
  4207 00001FF7 0000                    next_val_r: dw 0
  4208                                  
  4209                                  ; 16/11/2023
  4210 00001FF9 00                      faz:	db 0	
  4211                                  	
  4212                                  ; --------------------------------------------------------
  4213                                  
  4214                                  ; DATA
  4215                                  
  4216                                  FileHandle:	
  4217 00001FFA FFFFFFFF                	dd	-1
  4218                                  
  4219                                  Credits:
  4220 00001FFE 54696E792057415620-     	db	'Tiny WAV Player for TRDOS 386 by Erdogan Tan. '
  4220 00002007 506C6179657220666F-
  4220 00002010 72205452444F532033-
  4220 00002019 383620627920457264-
  4220 00002022 6F67616E2054616E2E-
  4220 0000202B 20                 
  4221                                  	;;;;db	'August 2020.',10,13,0
  4222                                  	;;;db	'November 2023.',10,13,0
  4223                                  	;;db	'June 2024.', 10,13,0
  4224                                  	;db	'December 2024.', 10,13,0
  4225 0000202C 4A616E756172792032-     	db	'January 2025.', 10,13,0
  4225 00002035 3032352E0A0D00     
  4226 0000203C 31372F30362F323031-     	db	'17/06/2017', 10,13,0
  4226 00002045 370A0D00           
  4227 00002049 31382F30382F323032-     	db	'18/08/2020', 10,13,0
  4227 00002052 300A0D00           
  4228 00002056 32372F31312F323032-     	db	'27/11/2023', 10,13,0
  4228 0000205F 330A0D00           
  4229 00002063 30312F30362F323032-     	db	'01/06/2024', 10,13,0
  4229 0000206C 340A0D00           
  4230 00002070 30342F30362F323032-     	db	'04/06/2024', 10,13,0
  4230 00002079 340A0D00           
  4231 0000207D 31342F31322F323032-     	db	'14/12/2024', 10,13,0
  4231 00002086 340A0D00           
  4232 0000208A 31372F30312F323032-     	db	'17/01/2025', 10,13,0
  4232 00002093 350A0D00           
  4233                                  
  4234                                  msgAudioCardInfo:
  4235 00002097 666F7220496E74656C-     	db 	'for Intel AC97 (ICH) Audio Controller.', 10,13,0
  4235 000020A0 204143393720284943-
  4235 000020A9 482920417564696F20-
  4235 000020B2 436F6E74726F6C6C65-
  4235 000020BB 722E0A0D00         
  4236                                  
  4237                                  msg_usage:
  4238 000020C0 75736167653A20706C-     	db	'usage: playwav8 filename.wav',10,13,0
  4238 000020C9 617977617638206669-
  4238 000020D2 6C656E616D652E7761-
  4238 000020DB 760A0D00           
  4239                                  
  4240                                  noDevMsg:
  4241 000020DF 4572726F723A20556E-     	db	'Error: Unable to find AC97 audio device!'
  4241 000020E8 61626C6520746F2066-
  4241 000020F1 696E64204143393720-
  4241 000020FA 617564696F20646576-
  4241 00002103 69636521           
  4242 00002107 0A0D00                  	db	10,13,0
  4243                                  
  4244                                  noFileErrMsg:
  4245 0000210A 4572726F723A206669-     	db	'Error: file not found.',10,13,0
  4245 00002113 6C65206E6F7420666F-
  4245 0000211C 756E642E0A0D00     
  4246                                  
  4247                                  trdos386_err_msg:
  4248 00002123 5452444F5320333836-     	db	'TRDOS 386 System call error !',10,13,0
  4248 0000212C 2053797374656D2063-
  4248 00002135 616C6C206572726F72-
  4248 0000213E 20210A0D00         
  4249                                  
  4250                                  ; 01/06/2024
  4251                                  msg_init_err:
  4252 00002143 0A0D                    	db	10,13
  4253 00002145 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  4253 0000214E 726F6C6C65722F436F-
  4253 00002157 64656320696E697469-
  4253 00002160 616C697A6174696F6E-
  4253 00002169 206572726F722021   
  4254 00002171 0A0D00                  	db	10,13,0
  4255                                  
  4256                                  ; 25/11/2023
  4257                                  msg_no_vra:
  4258 00002174 0A0D                    	db	10,13
  4259 00002176 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  4259 0000217F 70706F72742021204F-
  4259 00002188 6E6C79203438206B48-
  4259 00002191 5A2073616D706C6520-
  4259 0000219A 726174652073757070-
  4259 000021A3 6F727465642021     
  4260 000021AA 0A0D00                  	db	10,13,0
  4261                                  
  4262 000021AD 0D0A5741562046696C-     msgWavFileName:	db 0Dh, 0Ah, "WAV File Name: ",0
  4262 000021B6 65204E616D653A2000 
  4263 000021BF 0D0A53616D706C6520-     msgSampleRate:	db 0Dh, 0Ah, "Sample Rate: "
  4263 000021C8 526174653A20       
  4264 000021CE 303030303020487A2C-     msgHertz:	db "00000 Hz, ", 0 
  4264 000021D7 2000               
  4265 000021D9 3820626974732C2000      msg8Bits:	db "8 bits, ", 0 
  4266 000021E2 4D6F6E6F0D0A00          msgMono:	db "Mono", 0Dh, 0Ah, 0
  4267 000021E9 313620626974732C20-     msg16Bits:	db "16 bits, ", 0 
  4267 000021F2 00                 
  4268 000021F3 53746572656F            msgStereo:	db "Stereo"
  4269 000021F9 0D0A00                  nextline:	db 0Dh, 0Ah, 0
  4270                                  
  4271                                  ; 03/06/2017
  4272 000021FC 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  4272 00002205 3941424344454600   
  4273 0000220D 0D0A                    msgAC97Info	db 0Dh, 0Ah
  4274 0000220F 414339372041756469-     		db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  4274 00002218 6F20436F6E74726F6C-
  4274 00002221 6C6572202620436F64-
  4274 0000222A 656320496E666F0D0A 
  4275 00002233 56656E646F72204944-     		db "Vendor ID: "
  4275 0000223C 3A20               
  4276 0000223E 303030306820446576-     msgVendorId	db "0000h Device ID: "
  4276 00002247 6963652049443A20   
  4277 0000224F 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  4278 00002256 4275733A20              		db "Bus: "
  4279 0000225B 303068204465766963-     msgBusNo	db "00h Device: "
  4279 00002264 653A20             
  4280 00002267 3030682046756E6374-     msgDevNo	db "00h Function: "
  4280 00002270 696F6E3A20         
  4281 00002275 303068                  msgFncNo	db "00h"
  4282 00002278 0D0A                    		db 0Dh, 0Ah
  4283 0000227A 4E414D4241523A20        		db "NAMBAR: "
  4284 00002282 30303030682020          msgNamBar	db "0000h  "
  4285 00002289 4E41424D4241523A20      		db "NABMBAR: "
  4286 00002292 303030306820204952-     msgNabmBar	db "0000h  IRQ: "
  4286 0000229B 513A20             
  4287 0000229E 3030                    msgIRQ		dw 3030h
  4288 000022A0 0D0A00                  		db 0Dh, 0Ah, 0
  4289                                  ; 25/11/2023
  4290 000022A3 56524120737570706F-     msgVRAheader:	db "VRA support: "
  4290 000022AC 72743A20           
  4291 000022B0 00                      		db 0
  4292                                  ; 08/12/2024
  4293                                  ;msgVRAyes:	db "YES", 0Dh, 0Ah, 0
  4294 000022B1 4E4F200D0A              msgVRAno:	db "NO ", 0Dh, 0Ah
  4295 000022B6 28496E746572706F6C-     		db "(Interpolated sample rate playing method)"
  4295 000022BF 617465642073616D70-
  4295 000022C8 6C6520726174652070-
  4295 000022D1 6C6179696E67206D65-
  4295 000022DA 74686F6429         
  4296 000022DF 0D0A00                  		db 0Dh, 0Ah, 0	
  4297                                  EOF:
  4298                                  
  4299                                  ; BSS
  4300                                  
  4301                                  bss_start:
  4302                                  
  4303                                  ABSOLUTE bss_start
  4304                                  
  4305 000022E2 ????                    alignb 4
  4306                                  
  4307 000022E4 ??                      stmo:		resb 1 ; stereo or mono (1=stereo)
  4308 000022E5 ??                      bps:		resb 1 ; bits per sample (8,16)
  4309 000022E6 ????                    sample_rate:	resw 1 ; Sample Frequency (Hz)
  4310                                  
  4311                                  ; 25/11/2023
  4312 000022E8 ????????                bufferSize:	resd 1
  4313                                  
  4314 000022EC ??                      flags:		resb 1
  4315                                  ;cbs_busy:	resb 1
  4316 000022ED ??                      half_buff:	resb 1
  4317 000022EE ??                      srb:		resb 1
  4318                                  ; 18/08/2020
  4319 000022EF ??                      volume_level:	resb 1
  4320                                  ; 25/11/2023
  4321 000022F0 ??                      VRA:		resb 1	; Variable Rate Audio Support Status
  4322                                  
  4323 000022F1 <res 1Ch>               smpRBuff:	resw 14
  4324                                  
  4325                                  wav_file_name:
  4326 0000230D <res 50h>               		resb 80 ; wave file, path name (<= 80 bytes)
  4327                                  
  4328 0000235D ????                    		resw 1
  4329 0000235F ??                      ac97_int_ln_reg: resb 1
  4330 00002360 ??                      fbs_shift:	resb 1 ; 26/11/2023
  4331 00002361 ????????                dev_vendor:	resd 1
  4332 00002365 ????????                bus_dev_fn:	resd 1
  4333 00002369 ????                    ac97_NamBar:	resw 1
  4334 0000236B ????                    ac97_NabmBar:	resw 1
  4335                                  
  4336                                  bss_end:
  4337 0000236D <res C93h>              alignb 4096
  4338                                  ;audio_buffer:	resb BUFFERSIZE ; DMA Buffer Size / 2 (32768)
  4339                                  ; 26/11/2023
  4340 00003000 <res 10000h>            audio_buffer:	resb 65536
  4341                                  ; 13/06/2017
  4342                                  ;temp_buffer:	resb BUFFERSIZE
  4343                                  ; 26/11/2023
  4344 00013000 <res 10000h>            temp_buffer:	resb 65536
