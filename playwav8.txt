     1                                  ; ****************************************************************************
     2                                  ; playwav8.s (for TRDOS 386)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYWAV8.PRG ! AC'97 (ICH) .WAV PLAYER program by Erdogan TAN
     5                                  ;
     6                                  ; 25/11/2023
     7                                  ;
     8                                  ; [ Last Modification: 08/12/2024 ]
     9                                  ;
    10                                  ; Modified from PLAYWAV5.PRG .wav player program by Erdogan Tan, 18/08/2020
    11                                  ;
    12                                  ; Assembler: NASM version 2.15
    13                                  ;	     nasm playwav8.s -l playwav8.txt -o PLAYWAV8.PRG	
    14                                  ; ----------------------------------------------------------------------------
    15                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002
    16                                  
    17                                  ; playwav6.s (04/06/2024)
    18                                  ; playwav3.s (17/06/2017)
    19                                  
    20                                  ; 04/06/2024 (non-VRA simuation)
    21                                  ; Interpolated sampling rate version (48 kHz - VRA disabled) - playwav8.s-
    22                                  
    23                                  ; CODE
    24                                  
    25                                  ; 14/07/2020
    26                                  ; 31/12/2017
    27                                  ; TRDOS 386 (v2.0) system calls
    28                                  _ver 	equ 0
    29                                  _exit 	equ 1
    30                                  _fork 	equ 2
    31                                  _read 	equ 3
    32                                  _write	equ 4
    33                                  _open	equ 5
    34                                  _close 	equ 6
    35                                  _wait 	equ 7
    36                                  _create	equ 8
    37                                  _rename	equ 9
    38                                  _delete	equ 10
    39                                  _exec	equ 11
    40                                  _chdir	equ 12
    41                                  _time 	equ 13
    42                                  _mkdir 	equ 14
    43                                  _chmod	equ 15
    44                                  _rmdir	equ 16
    45                                  _break	equ 17
    46                                  _drive	equ 18
    47                                  _seek	equ 19
    48                                  _tell 	equ 20
    49                                  _memory	equ 21
    50                                  _prompt	equ 22
    51                                  _path	equ 23
    52                                  _env	equ 24
    53                                  _stime	equ 25
    54                                  _quit	equ 26
    55                                  _intr	equ 27
    56                                  _dir	equ 28
    57                                  _emt 	equ 29
    58                                  _ldrvt 	equ 30
    59                                  _video 	equ 31
    60                                  _audio	equ 32
    61                                  _timer	equ 33
    62                                  _sleep	equ 34
    63                                  _msg    equ 35
    64                                  _geterr	equ 36
    65                                  _fpstat	equ 37
    66                                  _pri	equ 38
    67                                  _rele	equ 39
    68                                  _fff	equ 40
    69                                  _fnf	equ 41
    70                                  _alloc	equ 42
    71                                  _dalloc equ 43
    72                                  _calbac equ 44
    73                                  _dma	equ 45
    74                                  
    75                                  %macro sys 1-4
    76                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)	
    77                                      ; 03/09/2015	
    78                                      ; 13/04/2015
    79                                      ; Retro UNIX 386 v1 system call.	
    80                                      %if %0 >= 2   
    81                                          mov ebx, %2
    82                                          %if %0 >= 3    
    83                                              mov ecx, %3
    84                                              %if %0 = 4
    85                                                 mov edx, %4   
    86                                              %endif
    87                                          %endif
    88                                      %endif
    89                                      mov eax, %1
    90                                      ;int 30h
    91                                      int 40h ; TRDOS 386 (TRDOS v2.0)	   
    92                                  %endmacro
    93                                  
    94                                  ; TRDOS 386 (and Retro UNIX 386 v1) system call format:
    95                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
    96                                  
    97                                  BUFFERSIZE	equ	32768	; audio buffer size 
    98                                  ENDOFFILE       equ     1	; flag for knowing end of file
    99                                  
   100                                  [BITS 32]
   101                                  
   102                                  [ORG 0] 
   103                                  
   104                                  _STARTUP:
   105                                  	; Prints the Credits Text.
   106                                  	sys	_msg, Credits, 255, 0Bh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000000 BB[25200000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000005 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000000A BA0B000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000000F B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000014 CD40                <1>  int 40h
   107                                  
   108                                  	; clear bss
   109 00000016 B9[85230000]            	mov	ecx, bss_end
   110 0000001B BF[FC220000]            	mov	edi, bss_start
   111 00000020 29F9                    	sub	ecx, edi
   112 00000022 D1E9                    	shr	ecx, 1
   113 00000024 31C0                    	xor	eax, eax
   114 00000026 F366AB                  	rep	stosw
   115                                  
   116                                  	; Detect (& Enable) AC'97 Audio Device
   117 00000029 E87D040000              	call	DetectAC97
   118 0000002E 731B                    	jnc     short GetFileName
   119                                  
   120                                  _dev_not_ready:
   121                                  ; couldn't find the audio device!
   122                                  	sys	_msg, noDevMsg, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000030 BB[F9200000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000035 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000003A BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000003F B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000044 CD40                <1>  int 40h
   123 00000046 E93A040000                      jmp     Exit
   124                                  
   125                                  GetFileName:  
   126 0000004B 89E6                    	mov	esi, esp
   127 0000004D AD                      	lodsd
   128 0000004E 83F802                  	cmp	eax, 2 ; two arguments 
   129                                  	       ; (program file name & mod file name)
   130 00000051 0F823C040000            	jb	pmsg_usage ; nothing to do
   131                                  
   132 00000057 AD                      	lodsd ; program file name address 
   133 00000058 AD                      	lodsd ; mod file name address (file to be read)
   134 00000059 89C6                    	mov	esi, eax
   135 0000005B BF[25230000]            	mov	edi, wav_file_name
   136                                  ScanName:       
   137 00000060 AC                      	lodsb
   138 00000061 84C0                    	test	al, al
   139 00000063 0F842A040000            	je	pmsg_usage
   140 00000069 3C20                    	cmp	al, 20h
   141 0000006B 74F3                    	je	short ScanName	; scan start of name.
   142 0000006D AA                      	stosb
   143 0000006E B4FF                    	mov	ah, 0FFh
   144                                  a_0:	
   145 00000070 FEC4                    	inc	ah
   146                                  a_1:
   147 00000072 AC                      	lodsb
   148 00000073 AA                      	stosb
   149 00000074 3C2E                    	cmp	al, '.'
   150 00000076 74F8                    	je	short a_0	
   151 00000078 20C0                    	and	al, al
   152 0000007A 75F6                    	jnz	short a_1
   153                                  
   154 0000007C 08E4                    	or	ah, ah		; if period NOT found,
   155 0000007E 750B                    	jnz	short _1 	; then add a .WAV extension.
   156                                  SetExt:
   157 00000080 4F                      	dec	edi
   158 00000081 C7072E574156            	mov	dword [edi], '.WAV'
   159 00000087 C6470400                	mov	byte [edi+4], 0
   160                                  
   161                                  _1:
   162                                  
   163                                  ; 26/11/2023
   164                                  %if 0
   165                                  	; Allocate Audio Buffer (for user)
   166                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   167                                  	; 26/11/2023
   168                                  	sys	_audio, 0200h, [buffersize], audio_buffer
   169                                  	jnc	short _2
   170                                  error_exit:
   171                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
   172                                  	jmp	Exit
   173                                  _2:
   174                                  	; DIRECT CGA (TEXT MODE) MEMORY ACCESS
   175                                  	; bl = 0, bh = 4
   176                                  	; Direct access/map to CGA (Text) memory (0B8000h)
   177                                  
   178                                  	sys	_video, 0400h
   179                                  	cmp	eax, 0B8000h
   180                                  	jne	short error_exit
   181                                  
   182                                  	; Initialize Audio Device (bh = 3)
   183                                  	sys	_audio, 0301h, 0, audio_int_handler 
   184                                  ;	jc	short error_exit
   185                                  _3:
   186                                  
   187                                  %endif
   188 0000008B E869060000              	call	write_audio_dev_info 
   189                                  
   190                                  ; open the file
   191                                          ; open existing file
   192 00000090 E823040000                      call    openFile ; no error? ok.
   193 00000095 731B                            jnc     short _gsr
   194                                  
   195                                  ; file not found!
   196                                  	sys	_msg, noFileErrMsg, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000097 BB[24210000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000009C B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000000A1 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000A6 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000000AB CD40                <1>  int 40h
   197                                  _exit_:
   198 000000AD E9D3030000                      jmp     Exit
   199                                  
   200                                  _gsr:  
   201 000000B2 E83B040000                     	call    getSampleRate		; read the sample rate
   202                                                                          ; pass it onto codec.
   203                                  	;jc	Exit
   204                                  	; 25/11/2023
   205 000000B7 72F4                    	jc	short _exit_
   206                                  
   207 000000B9 66A3[FE220000]          	mov	[sample_rate], ax
   208 000000BF 880D[FC220000]          	mov	[stmo], cl
   209 000000C5 8815[FD220000]          	mov	[bps], dl
   210                                  
   211                                  	; 26/11/2023
   212 000000CB C605[78230000]00        	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   213 000000D2 FEC9                    	dec	cl
   214 000000D4 7506                    	jnz	short _gsr_1 ; stereo
   215 000000D6 FE05[78230000]          	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   216                                  _gsr_1:	
   217 000000DC 80FA08                  	cmp	dl, 8 
   218 000000DF 7706                    	ja	short _gsr_2 ; 16 bit samples
   219 000000E1 FE05[78230000]          	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   220                                  _gsr_2:	
   221                                  	; 06/06/2017
   222                                  	sys	_audio, 0E00h ; get audio controller info
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000000E7 BB000E0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000000EC B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000000F1 CD40                <1>  int 40h
   223 000000F3 0F82E0020000            	jc	error_exit ; 25/11/2023
   224                                  
   225                                  	;cmp	ah, 2 ; ICH ? (Intel AC'97 Audio Controller)
   226                                  	;jne	_dev_not_ready	
   227                                  
   228                                  	; EAX = IRQ Number in AL
   229                                  	;	Audio Device Number in AH 
   230                                  	; EBX = DEV/VENDOR ID
   231                                  	;       (DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV)
   232                                  	; ECX = BUS/DEV/FN 
   233                                  	;       (00000000BBBBBBBBDDDDDFFF00000000)
   234                                  	; EDX = NABMBAR/NAMBAR (for AC97)
   235                                  	;      (Low word, DX = NAMBAR address)
   236                                  	; EDX = Base IO Addr (DX) for SB16 & VT8233
   237                                  
   238 000000F9 A2[77230000]            	mov	[ac97_int_ln_reg], al
   239 000000FE 891D[79230000]          	mov	[dev_vendor], ebx
   240 00000104 890D[7D230000]          	mov	[bus_dev_fn], ecx
   241                                  	;mov	[ac97_NamBar], dx
   242                                  	;shr	dx, 16
   243                                  	;mov	[ac97_NabmBar], dx
   244 0000010A 8915[81230000]          	mov	[ac97_NamBar], edx	
   245                                    
   246                                  	; 01/06/2024
   247                                  	; Reset Audio Device (bh = 8)
   248                                  	sys	_audio, 0800h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000110 BB00080000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000115 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000011A CD40                <1>  int 40h
   249                                  	;jc	error_exit	
   250 0000011C 7216                    	jc	short init_err
   251                                  
   252 0000011E E8B8060000              	call	write_ac97_pci_dev_info
   253                                  
   254                                  ; 04/06/2024
   255                                  %if 0
   256                                  	; 01/06/2024
   257                                  	; 25/11/2023
   258                                  	; Get AC'97 Codec info
   259                                  	; (Function 14, sub function 1)
   260                                  	sys	_audio, 0E01h
   261                                  	; Save Variable Rate Audio support bit
   262                                  	and	al, 1
   263                                  	mov	[VRA], al
   264                                  %endif
   265                                  
   266                                  	; 25/11/2023
   267 00000123 E87A080000              	call	write_VRA_info
   268                                  
   269                                  	; 01/05/2017
   270 00000128 E8E3050000              	call	write_wav_file_info
   271                                  
   272                                  	; 25/11/2023
   273                                  	; ------------------------------------------
   274                                  
   275                                  ; 04/06/2024
   276                                  %if 0
   277                                  	cmp	byte [VRA], 1
   278                                  	jb	short chk_sample_rate
   279                                  %else
   280                                  	; 04/06/2024
   281                                  	; (non-VRA simulation)
   282 0000012D EB20                    	jmp	short chk_sample_rate
   283                                  %endif
   284                                  
   285                                  playwav_48_khz:	
   286                                  	;mov	dword [loadfromwavfile], loadFromFile
   287                                  	;mov	dword [buffersize], 65536
   288 0000012F E98C020000              	jmp	PlayNow
   289                                  
   290                                  	; 01/06/2024
   291                                  init_err:
   292                                  	sys	_msg, msg_init_err, 255, 0Eh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000134 BB[5D210000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000139 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000013E BA0E000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000143 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000148 CD40                <1>  int 40h
   293 0000014A E936030000              	jmp	Exit
   294                                  
   295                                  chk_sample_rate:
   296                                  	; set conversion parameters
   297                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   298 0000014F 66A1[FE220000]          	mov	ax, [sample_rate]
   299 00000155 663D80BB                	cmp	ax, 48000
   300 00000159 74D4                    	je	short playwav_48_khz
   301                                  chk_22khz:
   302 0000015B 663D2256                	cmp	ax, 22050
   303 0000015F 7545                    	jne	short chk_11khz
   304 00000161 803D[FD220000]08        	cmp	byte [bps], 8
   305 00000168 7615                    	jna	short chk_22khz_1
   306 0000016A BB[10160000]            	mov	ebx, load_22khz_stereo_16_bit
   307 0000016F 803D[FC220000]01        	cmp	byte [stmo], 1 
   308 00000176 751A                    	jne	short chk_22khz_2
   309 00000178 BB[83150000]            	mov	ebx, load_22khz_mono_16_bit
   310 0000017D EB13                    	jmp	short chk_22khz_2
   311                                  chk_22khz_1:
   312 0000017F BB[FC140000]            	mov	ebx, load_22khz_stereo_8_bit
   313 00000184 803D[FC220000]01        	cmp	byte [stmo], 1 
   314 0000018B 7505                    	jne	short chk_22khz_2
   315 0000018D BB[73140000]            	mov	ebx, load_22khz_mono_8_bit
   316                                  chk_22khz_2:
   317 00000192 B85A1D0000              	mov	eax, 7514  ; (442*17)
   318 00000197 BA25000000              	mov	edx, 37
   319 0000019C B911000000              	mov	ecx, 17 
   320 000001A1 E9BA010000              	jmp	set_sizes	
   321                                  chk_11khz:
   322 000001A6 663D112B                	cmp	ax, 11025
   323 000001AA 7545                    	jne	short chk_44khz
   324 000001AC 803D[FD220000]08        	cmp	byte [bps], 8
   325 000001B3 7615                    	jna	short chk_11khz_1
   326 000001B5 BB[2C180000]            	mov	ebx, load_11khz_stereo_16_bit
   327 000001BA 803D[FC220000]01        	cmp	byte [stmo], 1 
   328 000001C1 751A                    	jne	short chk_11khz_2
   329 000001C3 BB[B3170000]            	mov	ebx, load_11khz_mono_16_bit
   330 000001C8 EB13                    	jmp	short chk_11khz_2
   331                                  chk_11khz_1:
   332 000001CA BB[39170000]            	mov	ebx, load_11khz_stereo_8_bit
   333 000001CF 803D[FC220000]01        	cmp	byte [stmo], 1 
   334 000001D6 7505                    	jne	short chk_11khz_2
   335 000001D8 BB[C1160000]            	mov	ebx, load_11khz_mono_8_bit
   336                                  chk_11khz_2:
   337 000001DD B8AD0E0000              	mov	eax, 3757  ; (221*17)
   338 000001E2 BA4A000000              	mov	edx, 74
   339 000001E7 B911000000              	mov	ecx, 17
   340 000001EC E96F010000              	jmp	set_sizes 
   341                                  chk_44khz:
   342 000001F1 663D44AC                	cmp	ax, 44100
   343 000001F5 7545                    	jne	short chk_16khz
   344 000001F7 803D[FD220000]08        	cmp	byte [bps], 8
   345 000001FE 7615                    	jna	short chk_44khz_1
   346 00000200 BB[531A0000]            	mov	ebx, load_44khz_stereo_16_bit
   347 00000205 803D[FC220000]01        	cmp	byte [stmo], 1 
   348 0000020C 751A                    	jne	short chk_44khz_2
   349 0000020E BB[DA190000]            	mov	ebx, load_44khz_mono_16_bit
   350 00000213 EB13                    	jmp	short chk_44khz_2
   351                                  chk_44khz_1:
   352 00000215 BB[5D190000]            	mov	ebx, load_44khz_stereo_8_bit
   353 0000021A 803D[FC220000]01        	cmp	byte [stmo], 1 
   354 00000221 7505                    	jne	short chk_44khz_2
   355 00000223 BB[E1180000]            	mov	ebx, load_44khz_mono_8_bit
   356                                  chk_44khz_2:
   357 00000228 B8D93A0000              	mov	eax, 15065 ; (655*23)
   358 0000022D BA19000000              	mov	edx, 25
   359 00000232 B917000000              	mov	ecx, 23
   360 00000237 E924010000              	jmp	set_sizes 
   361                                  chk_16khz:
   362 0000023C 663D803E                	cmp	ax, 16000
   363 00000240 7545                    	jne	short chk_8khz
   364 00000242 803D[FD220000]08        	cmp	byte [bps], 8
   365 00000249 7615                    	jna	short chk_16khz_1
   366 0000024B BB[B80F0000]            	mov	ebx, load_16khz_stereo_16_bit
   367 00000250 803D[FC220000]01        	cmp	byte [stmo], 1 
   368 00000257 751A                    	jne	short chk_16khz_2
   369 00000259 BB[370F0000]            	mov	ebx, load_16khz_mono_16_bit
   370 0000025E EB13                    	jmp	short chk_16khz_2
   371                                  chk_16khz_1:
   372 00000260 BB[7D0E0000]            	mov	ebx, load_16khz_stereo_8_bit
   373 00000265 803D[FC220000]01        	cmp	byte [stmo], 1 
   374 0000026C 7505                    	jne	short chk_16khz_2
   375 0000026E BB[FE0D0000]            	mov	ebx, load_16khz_mono_8_bit
   376                                  chk_16khz_2:
   377 00000273 B855150000              	mov	eax, 5461
   378 00000278 BA03000000              	mov	edx, 3
   379 0000027D B901000000              	mov	ecx, 1
   380 00000282 E9D9000000              	jmp	set_sizes 
   381                                  chk_8khz:
   382 00000287 663D401F                	cmp	ax, 8000
   383 0000028B 7545                    	jne	short chk_24khz
   384 0000028D 803D[FD220000]08        	cmp	byte [bps], 8
   385 00000294 7615                    	jna	short chk_8khz_1
   386 00000296 BB[B30C0000]            	mov	ebx, load_8khz_stereo_16_bit
   387 0000029B 803D[FC220000]01        	cmp	byte [stmo], 1 
   388 000002A2 751A                    	jne	short chk_8khz_2
   389 000002A4 BB[E30B0000]            	mov	ebx, load_8khz_mono_16_bit
   390 000002A9 EB13                    	jmp	short chk_8khz_2
   391                                  chk_8khz_1:
   392 000002AB BB[B30A0000]            	mov	ebx, load_8khz_stereo_8_bit
   393 000002B0 803D[FC220000]01        	cmp	byte [stmo], 1 
   394 000002B7 7505                    	jne	short chk_8khz_2
   395 000002B9 BB[CF090000]            	mov	ebx, load_8khz_mono_8_bit
   396                                  chk_8khz_2:
   397 000002BE B8AA0A0000              	mov	eax, 2730
   398 000002C3 BA06000000              	mov	edx, 6
   399 000002C8 B901000000              	mov	ecx, 1
   400 000002CD E98E000000              	jmp	set_sizes 
   401                                  chk_24khz:
   402 000002D2 663DC05D                	cmp	ax, 24000
   403 000002D6 7542                    	jne	short chk_32khz
   404 000002D8 803D[FD220000]08        	cmp	byte [bps], 8
   405 000002DF 7615                    	jna	short chk_24khz_1
   406 000002E1 BB[E2110000]            	mov	ebx, load_24khz_stereo_16_bit
   407 000002E6 803D[FC220000]01        	cmp	byte [stmo], 1 
   408 000002ED 751A                    	jne	short chk_24khz_2
   409 000002EF BB[7F110000]            	mov	ebx, load_24khz_mono_16_bit
   410 000002F4 EB13                    	jmp	short chk_24khz_2
   411                                  chk_24khz_1:
   412 000002F6 BB[F5100000]            	mov	ebx, load_24khz_stereo_8_bit
   413 000002FB 803D[FC220000]01        	cmp	byte [stmo], 1 
   414 00000302 7505                    	jne	short chk_24khz_2
   415 00000304 BB[8E100000]            	mov	ebx, load_24khz_mono_8_bit
   416                                  chk_24khz_2:
   417 00000309 B800200000              	mov	eax, 8192
   418 0000030E BA02000000              	mov	edx, 2
   419 00000313 B901000000              	mov	ecx, 1
   420 00000318 EB46                    	jmp	short set_sizes 
   421                                  chk_32khz:
   422 0000031A 663D007D                	cmp	ax, 32000
   423 0000031E 7579                    	jne	short vra_needed
   424 00000320 803D[FD220000]08        	cmp	byte [bps], 8
   425 00000327 7615                    	jna	short chk_32khz_1
   426 00000329 BB[E3130000]            	mov	ebx, load_32khz_stereo_16_bit
   427 0000032E 803D[FC220000]01        	cmp	byte [stmo], 1 
   428 00000335 751A                    	jne	short chk_32khz_2
   429 00000337 BB[79130000]            	mov	ebx, load_32khz_mono_16_bit
   430 0000033C EB13                    	jmp	short chk_32khz_2
   431                                  chk_32khz_1:
   432 0000033E BB[DC120000]            	mov	ebx, load_32khz_stereo_8_bit
   433 00000343 803D[FC220000]01        	cmp	byte [stmo], 1 
   434 0000034A 7505                    	jne	short chk_32khz_2
   435 0000034C BB[69120000]            	mov	ebx, load_32khz_mono_8_bit
   436                                  chk_32khz_2:
   437 00000351 B8AA2A0000              	mov	eax, 10922
   438 00000356 BA03000000              	mov	edx, 3
   439 0000035B B902000000              	mov	ecx, 2
   440                                  	;jmp	short set_sizes 
   441                                  set_sizes:
   442 00000360 803D[FC220000]01        	cmp	byte [stmo], 1
   443 00000367 7402                    	je	short ss_1
   444 00000369 D1E0                    	shl	eax, 1
   445                                  ss_1:
   446 0000036B 803D[FD220000]08        	cmp	byte [bps], 8
   447 00000372 7602                    	jna	short ss_2
   448                                  	; 16 bit samples
   449 00000374 D1E0                    	shl	eax, 1
   450                                  ss_2:
   451 00000376 A3[B8030000]            	mov	[loadsize], eax
   452 0000037B F7E2                    	mul	edx
   453                                  	;cmp	ecx, 1
   454                                  	;je	short ss_3
   455                                  ;ss_3:
   456 0000037D F7F1                    	div	ecx
   457 0000037F 8A0D[78230000]          	mov	cl, [fbs_shift]
   458 00000385 D3E0                    	shl	eax, cl
   459                                  	; 26/11/2023
   460                                  	;shr	eax, 1	; buffer size is 16 bit sample count
   461                                  
   462                                  	;;;
   463                                  	; 04/06/2024 (8 byte alignment for BDL)
   464 00000387 83C007                  	add	eax, 7
   465 0000038A 24F8                    	and	al, ~7
   466                                  	;;;
   467                                  
   468 0000038C A3[BC030000]            	mov	[buffersize], eax ; buffer size in bytes 
   469 00000391 891D[B4030000]          	mov	[loadfromwavfile], ebx
   470 00000397 EB27                    	jmp	short PlayNow
   471                                  
   472                                  vra_needed:
   473                                  	sys	_msg, msg_no_vra, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000399 BB[8E210000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000039E B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000003A3 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000003A8 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000003AD CD40                <1>  int 40h
   474 000003AF E9D1000000              	jmp	Exit
   475                                  
   476                                  	; 26/11/2023
   477                                  	; 13/11/2023
   478                                  loadfromwavfile:
   479 000003B4 [81050000]              	dd	loadFromFile
   480                                  loadsize:	; read from wav file
   481 000003B8 00000000                	dd	0
   482                                  buffersize:	; write to DMA buffer
   483 000003BC 00000100                	dd	65536 ; bytes
   484                                  
   485                                  PlayNow: 
   486                                  
   487                                  ; 26/11/2023
   488                                  %if 1
   489                                  	; Allocate Audio Buffer (for user)
   490                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   491                                  	; 26/11/2023
   492                                  	sys	_audio, 0200h, [buffersize], audio_buffer
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000003C0 BB00020000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000003C5 8B0D[BC030000]      <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000003CB BA[00300000]        <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000003D0 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000003D5 CD40                <1>  int 40h
   493 000003D7 731B                    	jnc	short _2
   494                                  
   495                                  	; 26/11/2023 - temporary
   496                                  	;sys	_msg, test_1, 255, 0Ch
   497                                  
   498                                  error_exit:
   499                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000003D9 BB[3D210000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000003DE B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000003E3 BA0E000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000003E8 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000003ED CD40                <1>  int 40h
   500 000003EF E991000000              	jmp	Exit
   501                                  _2:
   502                                  	; DIRECT CGA (TEXT MODE) MEMORY ACCESS
   503                                  	; bl = 0, bh = 4
   504                                  	; Direct access/map to CGA (Text) memory (0B8000h)
   505                                  
   506                                  	sys	_video, 0400h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000003F4 BB00040000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000003F9 B81F000000          <1>  mov eax, %1
    90                              <1> 
    91 000003FE CD40                <1>  int 40h
   507 00000400 3D00800B00              	cmp	eax, 0B8000h
   508 00000405 75D2                    	jne	short error_exit
   509                                  
   510                                  	; 01/06/2024
   511                                  	; Initialize Audio Device (bh = 3)
   512                                  	sys	_audio, 0301h, 0, audio_int_handler 
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000407 BB01030000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000040C B900000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000411 BA[50050000]        <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000416 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000041B CD40                <1>  int 40h
   513                                  	;jc	short error_exit
   514 0000041D 0F8211FDFFFF            	jc	init_err
   515                                  _3:
   516                                  
   517                                  %endif
   518                                  
   519                                  ;
   520                                  ; position file pointer to start in actual wav data
   521                                  ; MUCH improvement should really be done here to check if sample size is
   522                                  ; supported, make sure there are 2 channels, etc.  
   523                                  ;
   524                                          ;mov     ah, 42h
   525                                          ;mov     al, 0	; from start of file
   526                                          ;mov     bx, [FileHandle]
   527                                          ;xor     cx, cx
   528                                          ;mov     dx, 44	; jump past .wav/riff header
   529                                          ;int     21h
   530                                  
   531                                  	sys	_seek, [FileHandle], 44, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000423 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000429 B92C000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000042E BA00000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000433 B813000000          <1>  mov eax, %1
    90                              <1> 
    91 00000438 CD40                <1>  int 40h
   532                                  
   533                                  	sys	_msg, nextline, 255, 07h ; 01/05/2017
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000043A BB[13220000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000043F B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000444 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000449 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 0000044E CD40                <1>  int 40h
   534                                  
   535                                  ; play the .wav file. Most of the good stuff is in here.
   536                                  
   537 00000450 E8E1010000                      call    PlayWav
   538                                  
   539                                  ; close the .wav file and exit.
   540                                  
   541                                  StopPlaying:
   542                                  	; Stop Playing
   543                                  	sys	_audio, 0700h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000455 BB00070000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000045A B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000045F CD40                <1>  int 40h
   544                                  	; Cancel callback service (for user)
   545                                  	sys	_audio, 0900h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000461 BB00090000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000466 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000046B CD40                <1>  int 40h
   546                                  	; Deallocate Audio Buffer (for user)
   547                                  	sys	_audio, 0A00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000046D BB000A0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000472 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000477 CD40                <1>  int 40h
   548                                  	; Disable Audio Device
   549                                  	sys	_audio, 0C00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000479 BB000C0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000047E B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000483 CD40                <1>  int 40h
   550                                  Exit:  
   551 00000485 E847000000                      call    closeFile
   552                                           
   553                                  	sys	_exit	; Bye!
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81                              <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000048A B801000000          <1>  mov eax, %1
    90                              <1> 
    91 0000048F CD40                <1>  int 40h
   554                                  here:
   555 00000491 EBFE                    	jmp	short here
   556                                  
   557                                  pmsg_usage:
   558                                  	sys	_msg, msg_usage, 255, 0Bh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000493 BB[DA200000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000498 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000049D BA0B000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004A2 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000004A7 CD40                <1>  int 40h
   559 000004A9 EBDA                    	jmp	short Exit
   560                                  
   561                                  	; 25/11/2023
   562                                  DetectAC97:
   563                                  	; Detect (BH=1) AC'97 (BL=2) Audio Device
   564                                          sys	_audio, 0102h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004AB BB02010000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004B0 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000004B5 CD40                <1>  int 40h
   565                                  
   566                                  ; 01/06/2024
   567                                  %if 0
   568                                  	jc	short DetectAC97_retn
   569                                  
   570                                  	; 25/11/2023
   571                                  	; Get AC'97 Codec info
   572                                  	; (Function 14, sub function 1)
   573                                  	sys	_audio, 0E01h
   574                                  	; Save Variable Rate Audio support bit
   575                                  	and	al, 1
   576                                  	mov	[VRA], al
   577                                  %endif
   578                                  
   579                                  DetectAC97_retn:
   580 000004B7 C3                      	retn
   581                                  
   582                                  ;open or create file
   583                                  ;
   584                                  ;input: ds:dx-->filename (asciiz)
   585                                  ;       al=file Mode (create or open)
   586                                  ;output: none  cs:[FileHandle] filled
   587                                  ;
   588                                  openFile:
   589                                  	;mov	ah, 3Bh	; start with a mode
   590                                  	;add	ah, al	; add in create or open mode
   591                                  	;xor	ecx, ecx
   592                                  	;int	21h
   593                                  	;jc	short _of1
   594                                  	;;mov	[cs:FileHandle], ax
   595                                  
   596                                  	sys	_open, wav_file_name, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004B8 BB[25230000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000004BD B900000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004C2 B805000000          <1>  mov eax, %1
    90                              <1> 
    91 000004C7 CD40                <1>  int 40h
   597 000004C9 7205                    	jc	short _of1
   598                                  
   599 000004CB A3[21200000]            	mov	[FileHandle], eax
   600                                  _of1:
   601 000004D0 C3                      	retn
   602                                  
   603                                  ; close the currently open file
   604                                  ; input: none, uses cs:[FileHandle]
   605                                  closeFile:
   606 000004D1 833D[21200000]FF        	cmp	dword [FileHandle], -1
   607 000004D8 7417                    	je	short _cf1
   608                                  	;mov    bx, [FileHandle]  
   609                                  	;mov    ax, 3E00h
   610                                          ;int    21h              ;close file
   611                                  
   612                                  	sys	_close, [FileHandle]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004DA 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000004E0 B806000000          <1>  mov eax, %1
    90                              <1> 
    91 000004E5 CD40                <1>  int 40h
   613 000004E7 C705[21200000]FFFF-     	mov 	dword [FileHandle], -1
   613 000004EF FFFF               
   614                                  _cf1:
   615 000004F1 C3                      	retn
   616                                  
   617                                  getSampleRate:
   618                                  	
   619                                  ; reads the sample rate from the .wav file.
   620                                  ; entry: none - assumes file is already open
   621                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   622                                  ;	cx = number of channels (mono=1, stereo=2)
   623                                  ;	dx = bits per sample (8, 16)
   624                                  
   625 000004F2 53                      	push    ebx
   626                                  
   627                                          ;mov	ah, 42h
   628                                          ;mov	al, 0	; from start of file
   629                                          ;mov	bx, [FileHandle]
   630                                          ;xor	ecx, ecx
   631                                          ;mov	dx, 08h	; "WAVE"
   632                                          ;int	21h
   633                                  	
   634                                  	sys	_seek, [FileHandle], 8, 0
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000004F3 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000004F9 B908000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000004FE BA00000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000503 B813000000          <1>  mov eax, %1
    90                              <1> 
    91 00000508 CD40                <1>  int 40h
   635                                  
   636                                          ;mov	dx, smpRBuff
   637                                          ;mov	cx, 28	; 28 bytes
   638                                  	;mov	ah, 3fh
   639                                          ;int	21h
   640                                  
   641                                  	sys	_read, [FileHandle], smpRBuff, 28
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000050A 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000510 B9[09230000]        <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000515 BA1C000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000051A B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000051F CD40                <1>  int 40h
   642                                  
   643 00000521 813D[09230000]5741-     	cmp	dword [smpRBuff], 'WAVE'
   643 00000529 5645               
   644 0000052B 7520                    	jne	short gsr_stc
   645                                  
   646 0000052D 66833D[15230000]01      	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   647 00000535 7516                    	jne	short gsr_stc
   648                                  
   649 00000537 668B0D[17230000]        	mov	cx, [smpRBuff+14]	; return num of channels in CX
   650 0000053E 66A1[19230000]                  mov     ax, [smpRBuff+16]	; return sample rate in AX
   651 00000544 668B15[23230000]        	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   652                                  gsr_retn:
   653 0000054B 5B                              pop     ebx
   654 0000054C C3                              retn
   655                                  gsr_stc:
   656 0000054D F9                      	stc
   657 0000054E EBFB                    	jmp	short gsr_retn
   658                                  
   659                                  audio_int_handler:
   660                                  	; 18/08/2020 (14/10/2020, 'wavplay2.s')
   661                                  
   662                                  	;mov	byte [srb], 1 ; interrupt (or signal response byte)
   663                                  	
   664                                  	;cmp	byte [cbs_busy], 1
   665                                  	;jnb	short _callback_bsy_retn
   666                                  	
   667                                  	;mov	byte [cbs_busy], 1
   668                                  
   669 00000550 A0[05230000]            	mov	al, [half_buff]
   670                                  
   671 00000555 3C01                    	cmp	al, 1
   672 00000557 721A                    	jb	short _callback_retn
   673                                  
   674                                  	; 18/08/2020
   675 00000559 C605[06230000]01        	mov	byte [srb], 1
   676                                  
   677 00000560 8035[05230000]03        	xor	byte [half_buff], 3 ; 2->1, 1->2
   678                                  
   679 00000567 0430                    	add	al, '0'
   680                                  tL0:	; 26/11/2023
   681 00000569 B44E                    	mov	ah, 4Eh
   682 0000056B BB00800B00              	mov	ebx, 0B8000h ; video display page address
   683 00000570 668903                  	mov	[ebx], ax ; show playing buffer (1, 2)
   684                                  _callback_retn:
   685                                  	;mov	byte [cbs_busy], 0
   686                                  _callback_bsy_retn:
   687                                  	sys	_rele ; return from callback service 
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81                              <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000573 B827000000          <1>  mov eax, %1
    90                              <1> 
    91 00000578 CD40                <1>  int 40h
   688                                  	; we must not come here !
   689                                  	sys	_exit
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81                              <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000057A B801000000          <1>  mov eax, %1
    90                              <1> 
    91 0000057F CD40                <1>  int 40h
   690                                  	
   691                                  loadFromFile:
   692                                  	; 26/11/2023
   693 00000581 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
   694                                  					; last of the file?
   695 00000588 7402                    	jz	short lff_0		; no
   696 0000058A F9                      	stc
   697 0000058B C3                      	retn
   698                                  lff_0:
   699                                  	; 13/06/2017
   700                                  	;mov	edx, BUFFERSIZE
   701                                  	; 26/11/2023
   702 0000058C BF[00300000]            	mov	edi, audio_buffer
   703 00000591 8B15[BC030000]          	mov	edx, [buffersize]	; bytes
   704 00000597 8A0D[78230000]          	mov	cl, [fbs_shift]   
   705 0000059D 20C9                    	and	cl, cl
   706 0000059F 7409                    	jz	short lff_1 ; stereo, 16 bit
   707                                  
   708                                  	; fbs_shift =
   709                                  	;	2 for mono and 8 bit sample (multiplier = 4)
   710                                  	;	1 for mono or 8 bit sample (multiplier = 2)
   711 000005A1 D3EA                    	shr	edx, cl
   712                                  	;inc	edx
   713                                  
   714 000005A3 BE[00300100]            	mov     esi, temp_buffer
   715 000005A8 EB02                    	jmp	short lff_2
   716                                  lff_1:
   717                                  	;mov	esi, audio_buffer
   718 000005AA 89FE                    	mov	esi, edi ; audio_buffer
   719                                  lff_2:
   720                                  	; 17/03/2017
   721                                  	; esi = buffer address
   722                                  	; edx = buffer size
   723                                   
   724                                  	; 26/11/2023
   725                                  	; load file into memory
   726                                  	sys 	_read, [FileHandle], esi
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000005AC 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000005B2 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000005B4 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000005B9 CD40                <1>  int 40h
   727 000005BB 89D1                    	mov	ecx, edx
   728 000005BD 724A                    	jc	short padfill ; error !
   729                                  
   730 000005BF 21C0                    	and	eax, eax
   731 000005C1 7446                    	jz	short padfill
   732                                  lff_3:
   733                                  	; 26/11/2023
   734 000005C3 8A1D[78230000]          	mov	bl, [fbs_shift]
   735 000005C9 20DB                    	and	bl, bl
   736 000005CB 745C                    	jz	short lff_11
   737                                  
   738 000005CD 29C1                    	sub	ecx, eax
   739 000005CF 89CD                    	mov	ebp, ecx
   740                                  
   741                                  	;mov	esi, temp_buffer
   742                                  	;mov	edi, audio_buffer
   743 000005D1 89C1                    	mov	ecx, eax   ; byte count
   744                                  
   745 000005D3 803D[FD220000]08        	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   746 000005DA 751E                    	jne	short lff_6 ; 16 bit samples
   747                                  	; 8 bit samples
   748 000005DC FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
   749 000005DE 740E                    	jz	short lff_5 ; 8 bit, stereo
   750                                  lff_4:
   751                                  	; mono & 8 bit
   752 000005E0 AC                      	lodsb
   753 000005E1 2C80                    	sub	al, 80h ; 08/11/2023
   754 000005E3 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   755 000005E6 66AB                    	stosw	; left channel
   756 000005E8 66AB                    	stosw	; right channel
   757 000005EA E2F4                    	loop	lff_4
   758 000005EC EB16                    	jmp	short lff_8
   759                                  lff_5:
   760                                  	; stereo & 8 bit
   761 000005EE AC                      	lodsb
   762 000005EF 2C80                    	sub	al, 80h ; 08/11/2023
   763 000005F1 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   764 000005F4 66AB                    	stosw
   765 000005F6 E2F6                    	loop	lff_5			
   766 000005F8 EB0A                    	jmp	short lff_8
   767                                  lff_6:
   768 000005FA D1E9                    	shr	ecx, 1 ; word count
   769                                  lff_7:
   770 000005FC 66AD                    	lodsw
   771 000005FE 66AB                    	stosw	; left channel
   772 00000600 66AB                    	stosw	; right channel
   773 00000602 E2F8                    	loop	lff_7
   774                                  lff_8:
   775                                  	; 27/11/2023
   776 00000604 F8                      	clc
   777 00000605 89E9                    	mov	ecx, ebp
   778 00000607 E314                    	jecxz	endLFF_retn
   779                                  	
   780                                  padfill:
   781 00000609 803D[FD220000]10        	cmp 	byte [bps], 16
   782 00000610 740C                    	je	short lff_10
   783                                  	; Minimum Value = 0
   784 00000612 30C0                            xor     al, al
   785 00000614 F3AA                    	rep	stosb
   786                                  lff_9:
   787 00000616 800D[04230000]01                or	byte [flags], ENDOFFILE	; end of file flag
   788                                  endLFF_retn:
   789 0000061D C3                              retn
   790                                  lff_10:
   791 0000061E 31C0                    	xor	eax, eax
   792                                  	; Minimum value = 8000h (-32768)
   793 00000620 D1E9                    	shr	ecx, 1 
   794 00000622 B480                    	mov	ah, 80h ; ax = -32768
   795 00000624 F366AB                  	rep	stosw
   796 00000627 EBED                    	jmp	short lff_9
   797                                  
   798                                  lff_11:
   799                                  	; 16 bit stereo
   800                                  	; ecx = buffer size
   801                                  	; eax = read count
   802 00000629 29C1                    	sub	ecx, eax
   803 0000062B 76F0                    	jna	short endLFF_retn
   804 0000062D 01C7                    	add	edi, eax  ; audio_buffer + eax
   805 0000062F EBED                    	jmp	short lff_10 ; padfill
   806                                  
   807                                  error_exit_2:
   808                                  	; 26/11/2023 - temporary
   809                                  	;sys	_msg, test_2, 255, 0Ch
   810                                  
   811 00000631 E9A3FDFFFF              	jmp	error_exit
   812                                  	
   813                                  	; 26/11/2023 - temporary
   814                                  ;test_1:
   815                                  ;	db 13, 10, 'Test 1', 13,10, 0
   816                                  ;test_2:
   817                                  ;	db 13, 10, 'Test 2', 13,10, 0
   818                                  	
   819                                  PlayWav:
   820                                  	; 26/11/2023
   821                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   822                                  	; 13/06/2017
   823                                  	; Convert 8 bit samples to 16 bit samples
   824                                  	; and convert mono samples to stereo samples
   825                                  
   826                                  	; 26/11/2023
   827                                  	; load 32768 bytes into audio buffer
   828                                  	;mov	edi, audio_buffer
   829                                  	;;mov	edx, BUFFERSIZE
   830                                  	; 26/11/2023
   831                                  	;mov	edx, [buffersize]
   832                                  	;call	loadFromFile
   833                                  	; 26/11/2023
   834 00000636 FF15[B4030000]          	call	dword [loadfromwavfile]
   835 0000063C 72F3                    	jc	short error_exit_2
   836 0000063E C605[05230000]01        	mov	byte [half_buff], 1 ; (DMA) Buffer 1
   837                                  
   838                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   839 00000645 F605[04230000]01        	test    byte [flags], ENDOFFILE  ; end of file
   840 0000064C 7512                    	jnz	short _6 ; yes
   841                                  			 ; bypass filling dma half buffer 2
   842                                  
   843                                  	; bh = 16 : update (current, first) dma half buffer
   844                                  	; bl = 0  : then switch to the next (second) half buffer
   845                                  	sys	_audio, 1000h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000064E BB00100000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000653 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000658 CD40                <1>  int 40h
   846                                  
   847                                  	; 18/08/2020
   848                                  	; [audio_flag] = 1 (in TRDOS 386 kernel)
   849                                  
   850                                  	; audio_buffer must be filled again after above system call 
   851                                  	; (Because audio interrupt will be generated by AC97 hardware
   852                                  	; at the end of the first half of dma buffer.. so, 
   853                                  	; the second half must be ready. 'sound_play' will use it.)
   854                                  
   855                                  	; 26/11/2023
   856                                  	;mov	edi, audio_buffer
   857                                  	;;mov	edx, BUFFERSIZE
   858                                  	; 26/11/2023
   859                                  	;mov	edx, [buffersize]
   860                                  	;call	loadFromFile
   861                                  	; 26/11/2023
   862 0000065A FF15[B4030000]          	call	dword [loadfromwavfile]
   863                                  	;jc	short p_return
   864                                  _6:
   865                                  	; Set Master Volume Level (BL=0 or 80h)
   866                                  	; 	for next playing (BL>=80h)
   867                                  	;sys	_audio, 0B80h, 1D1Dh
   868                                  	sys	_audio, 0B00h, 1D1Dh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000660 BB000B0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000665 B91D1D0000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000066A B820000000          <1>  mov eax, %1
    90                              <1> 
    91 0000066F CD40                <1>  int 40h
   869                                  
   870                                  	; 18/08/2020
   871                                  	;mov	byte [volume_level], 1Dh
   872 00000671 880D[07230000]          	mov	[volume_level], cl
   873                                  
   874                                  	; Start	to play
   875                                  	;mov	al, [bps]
   876                                  	;shr	al, 4 ; 8 -> 0, 16 -> 1
   877                                  	;shl	al, 1 ; 16 -> 2, 8 -> 0
   878                                  	;mov	bl, [stmo]
   879                                  	;dec	bl
   880                                  	;or	bl, al
   881                                  	;mov	cx, [sample_rate]
   882                                  	; 04/06/2024
   883                                  	; (non-VRA simulation)
   884 00000677 66B980BB                 	mov	cx, 48000 ; 48 kHz
   885 0000067B B303                    	mov	bl, 3  ; 16 bit, stereo
   886                                  	
   887 0000067D B704                    	mov	bh, 4 ; start to play
   888                                  	sys	_audio
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81                              <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000067F B820000000          <1>  mov eax, %1
    90                              <1> 
    91 00000684 CD40                <1>  int 40h
   889                                  
   890                                  	;mov	ebx, 0B8000h ; video display page address
   891                                  	;mov	ah, 4Eh
   892                                  	;mov	al, [half_buffer]
   893                                  	;mov	[ebx], ax ; show playing buffer (1, 2)
   894                                  
   895                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   896                                  	; Here..
   897                                  	; If byte [flags] <> ENDOFFILE ...
   898                                  	; user's audio_buffer has been copied to dma half buffer 2
   899                                  
   900                                  	; [audio_flag] = 0 (in TRDOS 386 kernel)
   901                                  
   902                                  	; audio_buffer must be filled again after above system call 
   903                                  	; (Because, audio interrupt will be generated by VT8237R
   904                                  	; at the end of the first half of dma buffer.. so, 
   905                                  	; the 2nd half of dma buffer is ready but the 1st half
   906                                  	; must be filled again.)
   907                                  
   908                                  	; 18/08/2020
   909 00000686 F605[04230000]01        	test    byte [flags], ENDOFFILE  ; end of file
   910 0000068D 7506                    	jnz	short p_loop ; yes
   911                                  
   912                                  	; 18/08/2020
   913                                  	; load 32768 bytes into audio buffer
   914                                  	;; (for the second half of DMA buffer)
   915                                  	; 27/11/2023
   916                                  	; 20/05/2017
   917                                  	;mov	edi, audio_buffer
   918                                  	;mov	edx, BUFFERSIZE
   919                                  	; 26/11/2023
   920                                  	;mov	edx, [buffersize]
   921                                  	;call	loadFromFile
   922                                  	; 26/11/2023
   923 0000068F FF15[B4030000]          	call	dword [loadfromwavfile]
   924                                  	;jc	short p_return
   925                                  	;mov	byte [half_buff], 2 ; (DMA) Buffer 2
   926                                  
   927                                  	; we need to wait for 'SRB' (audio interrupt)
   928                                  	; (we can not return from 'PlayWav' here 
   929                                  	;  even if we have got an error from file reading)
   930                                  	; ((!!current audio data must be played!!))
   931                                  
   932                                  	; 18/08/2020
   933                                  	;mov	byte [srb], 1
   934                                  
   935                                  p_loop:
   936                                  	;mov	ah, 1		; any key pressed?
   937                                  	;int	32h		; no, Loop.
   938                                  	;jz	short q_loop
   939                                  	;
   940                                  	;mov	ah, 0		; flush key buffer...
   941                                  	;int	32h
   942                                  
   943                                  	; 18/08/2020 (14/10/2017, 'wavplay2.s')
   944 00000695 803D[06230000]00        	cmp	byte [srb], 0
   945 0000069C 760F                    	jna	short q_loop
   946 0000069E C605[06230000]00        	mov	byte [srb], 0
   947                                  	; 27/11/2023
   948                                  	;mov	edi, audio_buffer
   949                                  	;mov	edx, BUFFERSIZE
   950                                  	; 26/11/2023
   951                                  	;mov	edx, [buffersize]
   952                                  	;call	loadFromFile
   953                                  	; 26/11/2023
   954 000006A5 FF15[B4030000]          	call	dword [loadfromwavfile]
   955 000006AB 7212                    	jc	short p_return
   956                                  q_loop:
   957 000006AD B401                    	mov     ah, 1		; any key pressed?
   958 000006AF CD32                    	int     32h		; no, Loop.
   959 000006B1 74E2                    	jz	short p_loop
   960                                  
   961 000006B3 B400                    	mov     ah, 0		; flush key buffer...
   962 000006B5 CD32                    	int     32h
   963                                  	
   964 000006B7 3C2B                    	cmp	al, '+' ; increase sound volume
   965 000006B9 740C                    	je	short inc_volume_level
   966 000006BB 3C2D                    	cmp	al, '-'
   967 000006BD 742B                    	je	short dec_volume_level
   968                                  
   969                                  p_return:
   970 000006BF C605[05230000]00        	mov	byte [half_buff], 0
   971 000006C6 C3                      	retn
   972                                  
   973                                  	; 18/08/2020 (14/10/2017, 'wavplay2.s')
   974                                  inc_volume_level:
   975 000006C7 8A0D[07230000]          	mov	cl, [volume_level]
   976 000006CD 80F91F                  	cmp	cl, 1Fh ; 31
   977 000006D0 73DB                    	jnb	short q_loop
   978 000006D2 FEC1                    	inc	cl
   979                                  change_volume_level:
   980 000006D4 880D[07230000]          	mov	[volume_level], cl
   981 000006DA 88CD                    	mov	ch, cl
   982                                  	; Set Master Volume Level
   983                                  	sys	_audio, 0B00h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000006DC BB000B0000          <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83                              <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85                              <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000006E1 B820000000          <1>  mov eax, %1
    90                              <1> 
    91 000006E6 CD40                <1>  int 40h
   984 000006E8 EBAB                    	jmp	short p_loop
   985                                  dec_volume_level:
   986 000006EA 8A0D[07230000]          	mov	cl, [volume_level]
   987 000006F0 80F901                  	cmp	cl, 1 ; 1
   988 000006F3 76A0                    	jna	short p_loop
   989 000006F5 FEC9                    	dec	cl
   990 000006F7 EBDB                    	jmp	short change_volume_level
   991                                  
   992                                  write_audio_dev_info:
   993                                  	; EBX = Message address
   994                                  	; ECX = Max. message length (or stop on ZERO character)
   995                                  	;	(1 to 255)
   996                                  	; DL  = Message color (07h = light gray, 0Fh = white) 
   997                                       	sys 	_msg, msgAudioCardInfo, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000006F9 BB[B1200000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000006FE B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000703 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000708 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 0000070D CD40                <1>  int 40h
   998 0000070F C3                      	retn
   999                                  
  1000                                  write_wav_file_info:
  1001                                  	; 01/05/2017
  1002                                  	sys	_msg, msgWavFileName, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000710 BB[C7210000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000715 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000071A BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000071F B823000000          <1>  mov eax, %1
    90                              <1> 
    91 00000724 CD40                <1>  int 40h
  1003                                  	sys	_msg, wav_file_name, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000726 BB[25230000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000072B B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000730 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000735 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 0000073A CD40                <1>  int 40h
  1004                                  
  1005                                  write_sample_rate:
  1006                                  	; 01/05/2017
  1007 0000073C 66A1[FE220000]          	mov	ax, [sample_rate]
  1008                                  	; ax = sample rate (hertz)
  1009 00000742 31D2                    	xor	edx, edx
  1010 00000744 66B90A00                	mov	cx, 10
  1011 00000748 66F7F1                  	div	cx
  1012 0000074B 0015[EC210000]          	add	[msgHertz+4], dl
  1013 00000751 29D2                    	sub	edx, edx
  1014 00000753 66F7F1                  	div	cx
  1015 00000756 0015[EB210000]          	add	[msgHertz+3], dl
  1016 0000075C 29D2                    	sub	edx, edx
  1017 0000075E 66F7F1                  	div	cx
  1018 00000761 0015[EA210000]          	add	[msgHertz+2], dl
  1019 00000767 29D2                    	sub	edx, edx
  1020 00000769 66F7F1                  	div	cx
  1021 0000076C 0015[E9210000]          	add	[msgHertz+1], dl
  1022 00000772 0005[E8210000]          	add	[msgHertz], al
  1023                                  	
  1024                                  	sys	_msg, msgSampleRate, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000778 BB[D9210000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000077D B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000782 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000787 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 0000078C CD40                <1>  int 40h
  1025                                  
  1026 0000078E BE[03220000]            	mov	esi, msg16Bits
  1027 00000793 803D[FD220000]10        	cmp	byte [bps], 16
  1028 0000079A 7405                    	je	short wsr_1
  1029 0000079C BE[F3210000]            	mov	esi, msg8Bits
  1030                                  wsr_1:
  1031                                  	sys	_msg, esi, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000007A1 89F3                <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000007A3 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000007A8 BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000007AD B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000007B2 CD40                <1>  int 40h
  1032                                  
  1033 000007B4 BE[FC210000]            	mov	esi, msgMono
  1034 000007B9 803D[FC220000]01        	cmp	byte [stmo], 1
  1035 000007C0 7405                    	je	short wsr_2
  1036 000007C2 BE[0D220000]            	mov	esi, msgStereo		
  1037                                  wsr_2:
  1038                                  	sys	_msg, esi, 255, 0Fh
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000007C7 89F3                <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000007C9 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000007CE BA0F000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000007D3 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000007D8 CD40                <1>  int 40h
  1039 000007DA C3                              retn
  1040                                  
  1041                                  write_ac97_pci_dev_info:
  1042                                  	; 06/06/2017
  1043                                  	; 03/06/2017
  1044                                  	; BUS/DEV/FN
  1045                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1046                                  	; DEV/VENDOR
  1047                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1048                                  
  1049 000007DB 8B35[79230000]          	mov	esi, [dev_vendor]
  1050 000007E1 89F0                    	mov	eax, esi
  1051 000007E3 0FB6D8                  	movzx	ebx, al
  1052 000007E6 88DA                    	mov	dl, bl
  1053 000007E8 80E30F                  	and	bl, 0Fh
  1054 000007EB 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1055 000007F1 A2[5B220000]            	mov	[msgVendorId+3], al
  1056 000007F6 88D3                    	mov	bl, dl
  1057 000007F8 C0EB04                  	shr	bl, 4
  1058 000007FB 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1059 00000801 A2[5A220000]            	mov	[msgVendorId+2], al
  1060 00000806 88E3                    	mov	bl, ah
  1061 00000808 88DA                    	mov	dl, bl
  1062 0000080A 80E30F                  	and	bl, 0Fh
  1063 0000080D 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1064 00000813 A2[59220000]            	mov	[msgVendorId+1], al
  1065 00000818 88D3                    	mov	bl, dl
  1066 0000081A C0EB04                  	shr	bl, 4
  1067 0000081D 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1068 00000823 A2[58220000]            	mov	[msgVendorId], al
  1069 00000828 C1E810                  	shr	eax, 16
  1070 0000082B 88C3                    	mov	bl, al
  1071 0000082D 88DA                    	mov	dl, bl
  1072 0000082F 80E30F                  	and	bl, 0Fh
  1073 00000832 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1074 00000838 A2[6C220000]            	mov	[msgDevId+3], al
  1075 0000083D 88D3                    	mov	bl, dl
  1076 0000083F C0EB04                  	shr	bl, 4
  1077 00000842 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1078 00000848 A2[6B220000]            	mov	[msgDevId+2], al
  1079 0000084D 88E3                    	mov	bl, ah
  1080 0000084F 88DA                    	mov	dl, bl
  1081 00000851 80E30F                  	and	bl, 0Fh
  1082 00000854 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1083 0000085A A2[6A220000]            	mov	[msgDevId+1], al
  1084 0000085F 88D3                    	mov	bl, dl
  1085 00000861 C0EB04                  	shr	bl, 4
  1086 00000864 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1087 0000086A A2[69220000]            	mov	[msgDevId], al
  1088                                  
  1089 0000086F 8B35[7D230000]          	mov	esi, [bus_dev_fn]
  1090 00000875 C1EE08                  	shr	esi, 8
  1091 00000878 6689F0                  	mov	ax, si
  1092 0000087B 88C3                    	mov	bl, al
  1093 0000087D 88DA                    	mov	dl, bl
  1094 0000087F 80E307                  	and	bl, 7 ; bit 0,1,2
  1095 00000882 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1096 00000888 A2[90220000]            	mov	[msgFncNo+1], al
  1097 0000088D 88D3                    	mov	bl, dl
  1098 0000088F C0EB03                  	shr	bl, 3
  1099 00000892 88DA                    	mov	dl, bl
  1100 00000894 80E30F                  	and	bl, 0Fh
  1101 00000897 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1102 0000089D A2[82220000]            	mov	[msgDevNo+1], al
  1103 000008A2 88D3                    	mov	bl, dl
  1104 000008A4 C0EB04                  	shr	bl, 4
  1105 000008A7 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1106 000008AD A2[81220000]            	mov	[msgDevNo], al
  1107 000008B2 88E3                    	mov	bl, ah
  1108 000008B4 88DA                    	mov	dl, bl
  1109 000008B6 80E30F                  	and	bl, 0Fh
  1110 000008B9 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1111 000008BF A2[76220000]            	mov	[msgBusNo+1], al
  1112 000008C4 88D3                    	mov	bl, dl
  1113 000008C6 C0EB04                  	shr	bl, 4
  1114 000008C9 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1115 000008CF A2[75220000]            	mov	[msgBusNo], al
  1116                                  
  1117 000008D4 66A1[81230000]          	mov	ax, [ac97_NamBar]
  1118 000008DA 88C3                    	mov	bl, al
  1119 000008DC 88DA                    	mov	dl, bl
  1120 000008DE 80E30F                  	and	bl, 0Fh
  1121 000008E1 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1122 000008E7 A2[9F220000]            	mov	[msgNamBar+3], al
  1123 000008EC 88D3                    	mov	bl, dl
  1124 000008EE C0EB04                  	shr	bl, 4
  1125 000008F1 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1126 000008F7 A2[9E220000]            	mov	[msgNamBar+2], al
  1127 000008FC 88E3                    	mov	bl, ah
  1128 000008FE 88DA                    	mov	dl, bl
  1129 00000900 80E30F                  	and	bl, 0Fh
  1130 00000903 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1131 00000909 A2[9D220000]            	mov	[msgNamBar+1], al
  1132 0000090E 88D3                    	mov	bl, dl
  1133 00000910 C0EB04                  	shr	bl, 4
  1134 00000913 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1135 00000919 A2[9C220000]            	mov	[msgNamBar], al
  1136                                  
  1137 0000091E 66A1[83230000]          	mov	ax, [ac97_NabmBar]
  1138 00000924 88C3                    	mov	bl, al
  1139 00000926 88DA                    	mov	dl, bl
  1140 00000928 80E30F                  	and	bl, 0Fh
  1141 0000092B 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1142 00000931 A2[AF220000]            	mov	[msgNabmBar+3], al
  1143 00000936 88D3                    	mov	bl, dl
  1144 00000938 C0EB04                  	shr	bl, 4
  1145 0000093B 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1146 00000941 A2[AE220000]            	mov	[msgNabmBar+2], al
  1147 00000946 88E3                    	mov	bl, ah
  1148 00000948 88DA                    	mov	dl, bl
  1149 0000094A 80E30F                  	and	bl, 0Fh
  1150 0000094D 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1151 00000953 A2[AD220000]            	mov	[msgNabmBar+1], al
  1152 00000958 88D3                    	mov	bl, dl
  1153 0000095A C0EB04                  	shr	bl, 4
  1154 0000095D 8A83[16220000]          	mov	al, [ebx+hex_chars]
  1155 00000963 A2[AC220000]            	mov	[msgNabmBar], al
  1156                                  
  1157 00000968 30E4                    	xor	ah, ah
  1158 0000096A A0[77230000]            	mov	al, [ac97_int_ln_reg]
  1159 0000096F B10A                    	mov	cl, 10
  1160 00000971 F6F1                    	div	cl
  1161 00000973 660105[B8220000]        	add	[msgIRQ], ax
  1162 0000097A 20C0                    	and	al, al
  1163 0000097C 750D                    	jnz	short _w_ac97imsg_
  1164 0000097E A0[B9220000]            	mov	al, [msgIRQ+1]
  1165 00000983 B420                    	mov	ah, ' '
  1166 00000985 66A3[B8220000]          	mov	[msgIRQ], ax
  1167                                  _w_ac97imsg_:
  1168                                  	sys	_msg, msgAC97Info, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000098B BB[27220000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000990 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000995 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000099A B823000000          <1>  mov eax, %1
    90                              <1> 
    91 0000099F CD40                <1>  int 40h
  1169                                  
  1170 000009A1 C3                              retn
  1171                                  
  1172                                  write_VRA_info:
  1173                                  	; 25/11/2023
  1174                                  	sys	_msg, msgVRAheader, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000009A2 BB[BD220000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000009A7 B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000009AC BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000009B1 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000009B6 CD40                <1>  int 40h
  1175                                  ; 08/12/2024
  1176                                  %if 0
  1177                                  	cmp	byte [VRA], 0
  1178                                  	jna	short _w_VRAi_no
  1179                                  _w_VRAi_yes:
  1180                                  	sys	_msg, msgVRAyes, 255, 07h
  1181                                  	retn
  1182                                  %endif
  1183                                  _w_VRAi_no:
  1184                                  	sys	_msg, msgVRAno, 255, 07h
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000009B8 BB[CB220000]        <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000009BD B9FF000000          <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000009C2 BA07000000          <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000009C7 B823000000          <1>  mov eax, %1
    90                              <1> 
    91 000009CC CD40                <1>  int 40h
  1185 000009CE C3                      	retn
  1186                                  
  1187                                  ; 26/11/2023
  1188                                  ; 25/11/2023 - playwav6.s (32 bit registers, TRDOS 386 adaption)
  1189                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  1190                                  ; 14/11/2023
  1191                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1192                                  ; --------------------------------------------------------
  1193                                  
  1194                                  ;;Note:	At the end of every buffer load,
  1195                                  ;;	during buffer switch/swap, there will be discontinuity
  1196                                  ;;	between the last converted sample and the 1st sample
  1197                                  ;;	of the next buffer.
  1198                                  ;;	(like as a dot noises vaguely between normal sound samples)
  1199                                  ;;	-To avoid this defect, the 1st sample of
  1200                                  ;;	the next buffer may be read from the wav file but
  1201                                  ;;	the file pointer would need to be set to 1 sample back
  1202                                  ;;	again via seek system call. Time comsumption problem! -
  1203                                  ;;
  1204                                  ;;	Erdogan Tan - 15/11/2023
  1205                                  ;;
  1206                                  ;;	((If entire wav data would be loaded at once.. conversion
  1207                                  ;;	defect/noise would disappear.. but for DOS, to keep
  1208                                  ;;	64KB buffer limit is important also it is important
  1209                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1210                                  ;;	I have tested this program by using 2-30MB wav files.))
  1211                                  ;;
  1212                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1213                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1214                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1215                                  ;;			Realtek ALC850 codec.
  1216                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1217                                  
  1218                                  load_8khz_mono_8_bit:
  1219                                  	; 15/11/2023
  1220                                  	; 14/11/2023
  1221                                  	; 13/11/2023
  1222 000009CF F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1223                                  					; last of the file?
  1224 000009D6 7402                    	jz	short lff8m_0		; no
  1225 000009D8 F9                      	stc
  1226 000009D9 C3                      	retn
  1227                                  
  1228                                  lff8m_0:
  1229 000009DA BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1230                                          ;mov	edx, [loadsize]
  1231                                  
  1232                                  	; esi = buffer address
  1233                                  	;; edx = buffer size
  1234                                  
  1235                                  	; load file into memory
  1236                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000009DF 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000009E5 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000009E7 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000009ED B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000009F2 CD40                <1>  int 40h
  1237 000009F4 7305                    	jnc	short lff8m_6
  1238 000009F6 E9AF000000              	jmp	lff8m_5  ; error !
  1239                                  
  1240                                  lff8m_6:
  1241 000009FB BF[00300000]            	mov	edi, audio_buffer
  1242 00000A00 21C0                    	and	eax, eax
  1243 00000A02 0F8499000000            	jz	lff8_eof
  1244                                  
  1245 00000A08 89C1                    	mov	ecx, eax		; byte count
  1246                                  lff8m_1:
  1247 00000A0A AC                      	lodsb
  1248 00000A0B A2[18200000]            	mov	[previous_val], al
  1249 00000A10 2C80                    	sub	al, 80h
  1250 00000A12 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1251 00000A16 66AB                    	stosw		; original sample (left channel)
  1252 00000A18 66AB                    	stosw		; original sample (right channel)
  1253                                  	;xor	eax, eax
  1254 00000A1A B080                    	mov	al, 80h
  1255 00000A1C 49                      	dec	ecx
  1256 00000A1D 7402                    	jz	short lff8m_2
  1257 00000A1F 8A06                    	mov	al, [esi]
  1258                                  lff8m_2:
  1259                                  	;mov	[next_val], ax
  1260 00000A21 88C7                    	mov	bh, al	; [next_val]
  1261 00000A23 8A25[18200000]          	mov	ah, [previous_val]
  1262 00000A29 00E0                    	add	al, ah	; [previous_val]
  1263 00000A2B D0D8                    	rcr	al, 1
  1264 00000A2D 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  1265 00000A2F 00E0                    	add	al, ah	; [previous_val]
  1266 00000A31 D0D8                    	rcr	al, 1	
  1267 00000A33 88C3                    	mov	bl, al 	; this is temporary interpolation value	
  1268 00000A35 00E0                    	add	al, ah	; [previous_val]
  1269 00000A37 D0D8                    	rcr	al, 1
  1270 00000A39 2C80                    	sub	al, 80h
  1271 00000A3B 66C1E008                	shl	ax, 8	
  1272 00000A3F 66AB                    	stosw		; this is 1st interpolated sample (L)
  1273 00000A41 66AB                    	stosw		; this is 1st interpolated sample (R)
  1274 00000A43 88D8                    	mov	al, bl
  1275 00000A45 00D0                    	add	al, dl
  1276 00000A47 D0D8                    	rcr	al, 1
  1277 00000A49 2C80                    	sub	al, 80h
  1278 00000A4B 66C1E008                	shl	ax, 8
  1279 00000A4F 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1280 00000A51 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1281 00000A53 88D0                    	mov	al, dl
  1282 00000A55 2C80                    	sub	al, 80h
  1283 00000A57 66C1E008                	shl	ax, 8
  1284 00000A5B 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1285 00000A5D 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1286                                  	;mov	al, [next_val]
  1287 00000A5F 88F8                    	mov	al, bh
  1288 00000A61 00D0                    	add	al, dl
  1289 00000A63 D0D8                    	rcr	al, 1
  1290 00000A65 88C3                    	mov	bl, al	; this is temporary interpolation value
  1291 00000A67 00D0                    	add	al, dl
  1292 00000A69 D0D8                    	rcr	al, 1
  1293 00000A6B 2C80                    	sub	al, 80h
  1294 00000A6D 66C1E008                	shl	ax, 8
  1295 00000A71 66AB                    	stosw		; this is 4th interpolated sample (L)
  1296 00000A73 66AB                    	stosw		; this is 4th interpolated sample (R)
  1297                                  	;mov	al, [next_val]
  1298 00000A75 88F8                    	mov	al, bh
  1299 00000A77 00D8                    	add	al, bl
  1300 00000A79 D0D8                    	rcr	al, 1
  1301 00000A7B 2C80                    	sub	al, 80h
  1302 00000A7D 66C1E008                	shl	ax, 8
  1303 00000A81 66AB                    	stosw		; this is 5th interpolated sample (L)
  1304 00000A83 66AB                    	stosw		; this is 5th interpolated sample (R)
  1305                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1306 00000A85 09C9                    	or	ecx, ecx
  1307 00000A87 7581                    	jnz	short lff8m_1
  1308                                  
  1309                                  	; --------------
  1310                                  
  1311                                  lff8s_3:
  1312                                  lff8m_3:
  1313                                  lff8s2_3:
  1314                                  lff8m2_3:
  1315                                  lff16s_3:
  1316                                  lff16m_3:
  1317                                  lff16s2_3:
  1318                                  lff16m2_3:
  1319                                  lff24_3:
  1320                                  lff32_3:
  1321                                  lff44_3:
  1322                                  lff22_3:
  1323                                  lff11_3:
  1324                                  	; 08/12/2024 (BugFix)
  1325                                  	; 01/06/2024 (BugFix)
  1326 00000A89 8B0D[BC030000]          	mov	ecx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1327                                  	;shl	ecx, 1	; byte count ; Bug !
  1328                                  	; 08/12/2024
  1329 00000A8F 81C1[00300000]          	add	ecx, audio_buffer
  1330 00000A95 29F9                    	sub	ecx, edi
  1331 00000A97 7607                    	jna	short lff8m_4
  1332                                  	;inc	ecx
  1333 00000A99 C1E902                  	shr	ecx, 2
  1334 00000A9C 31C0                    	xor	eax, eax ; fill (remain part of) buffer with zeros
  1335 00000A9E F3AB                    	rep	stosd
  1336                                  lff8m_4:
  1337                                  	; 01/06/2024 (BugFix)
  1338                                  	; cf=1 ; Bug !
  1339                                  	; 08/12/2024
  1340                                  	;clc
  1341 00000AA0 C3                      	retn
  1342                                  
  1343                                  lff8_eof:
  1344                                  lff16_eof:
  1345                                  lff24_eof:
  1346                                  lff32_eof:
  1347                                  lff44_eof:
  1348                                  lff22_eof:
  1349                                  lff11_eof:
  1350                                  	; 15/11/2023
  1351 00000AA1 C605[04230000]01        	mov	byte [flags], ENDOFFILE
  1352 00000AA8 EBDF                    	jmp	short lff8m_3
  1353                                  
  1354                                  lff8s_5:
  1355                                  lff8m_5:
  1356                                  lff8s2_5:
  1357                                  lff8m2_5:
  1358                                  lff16s_5:
  1359                                  lff16m_5:
  1360                                  lff16s2_5:
  1361                                  lff16m2_5:
  1362                                  lff24_5:
  1363                                  lff32_5:
  1364                                  lff44_5:
  1365                                  lff22_5:
  1366                                  lff11_5:
  1367 00000AAA B021                    	mov	al, '!'  ; error
  1368 00000AAC E8B8FAFFFF              	call	tL0
  1369                                  	
  1370                                  	;jmp	short lff8m_3
  1371                                  	; 15/11/2023
  1372 00000AB1 EBEE                    	jmp	lff8_eof
  1373                                  
  1374                                  	; --------------
  1375                                  
  1376                                  load_8khz_stereo_8_bit:
  1377                                  	; 15/11/2023
  1378                                  	; 14/11/2023
  1379                                  	; 13/11/2023
  1380 00000AB3 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1381                                  					; last of the file?
  1382 00000ABA 7402                    	jz	short lff8s_0		; no
  1383 00000ABC F9                      	stc
  1384 00000ABD C3                      	retn
  1385                                  
  1386                                  lff8s_0:
  1387 00000ABE BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1388                                          ;mov	edx, [loadsize]
  1389                                  
  1390                                  	; esi = buffer address
  1391                                  	;; edx = buffer size
  1392                                  
  1393                                  	; load file into memory
  1394                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000AC3 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000AC9 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000ACB 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000AD1 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000AD6 CD40                <1>  int 40h
  1395 00000AD8 72D0                    	jc	short lff8s_5 ; error !
  1396                                  
  1397 00000ADA BF[00300000]            	mov	edi, audio_buffer
  1398                                  	
  1399 00000ADF D1E8                    	shr	eax, 1
  1400 00000AE1 74BE                    	jz	short lff8_eof
  1401                                  
  1402 00000AE3 89C1                    	mov	ecx, eax	; word count
  1403                                  lff8s_1:
  1404 00000AE5 AC                      	lodsb
  1405 00000AE6 A2[18200000]            	mov	[previous_val_l], al
  1406 00000AEB 2C80                    	sub	al, 80h
  1407 00000AED 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1408 00000AF1 66AB                    	stosw		; original sample (L)
  1409 00000AF3 AC                      	lodsb
  1410 00000AF4 A2[1A200000]            	mov	[previous_val_r], al
  1411 00000AF9 2C80                    	sub	al, 80h
  1412 00000AFB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1413 00000AFF 66AB                    	stosw		; original sample (R)
  1414                                  
  1415                                  	;xor	eax, eax
  1416 00000B01 66B88080                	mov	ax, 8080h
  1417 00000B05 49                      	dec	ecx
  1418 00000B06 7403                    	jz	short lff8s_2
  1419                                  		; convert 8 bit sample to 16 bit sample
  1420 00000B08 668B06                  	mov	ax, [esi]
  1421                                  lff8s_2:
  1422 00000B0B A2[1C200000]            	mov	[next_val_l], al
  1423 00000B10 8825[1E200000]          	mov	[next_val_r], ah
  1424 00000B16 8A25[18200000]          	mov	ah, [previous_val_l]
  1425 00000B1C 00E0                    	add	al, ah
  1426 00000B1E D0D8                    	rcr	al, 1
  1427 00000B20 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1428 00000B22 00E0                    	add	al, ah
  1429 00000B24 D0D8                    	rcr	al, 1	
  1430 00000B26 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1431 00000B28 00E0                    	add	al, ah
  1432 00000B2A D0D8                    	rcr	al, 1
  1433 00000B2C 2C80                    	sub	al, 80h
  1434 00000B2E 66C1E008                	shl	ax, 8
  1435 00000B32 66AB                    	stosw		; this is 1st interpolated sample (L)
  1436 00000B34 A0[1E200000]            	mov	al, [next_val_r]
  1437 00000B39 8A25[1A200000]          	mov	ah, [previous_val_r]
  1438 00000B3F 00E0                    	add	al, ah
  1439 00000B41 D0D8                    	rcr	al, 1
  1440 00000B43 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1441 00000B45 00E0                    	add	al, ah
  1442 00000B47 D0D8                    	rcr	al, 1
  1443 00000B49 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1444 00000B4B 00E0                    	add	al, ah
  1445 00000B4D D0D8                    	rcr	al, 1
  1446 00000B4F 2C80                    	sub	al, 80h
  1447 00000B51 66C1E008                	shl	ax, 8
  1448 00000B55 66AB                    	stosw		; this is 1st interpolated sample (R)
  1449 00000B57 88D8                    	mov	al, bl
  1450 00000B59 00D0                    	add	al, dl
  1451 00000B5B D0D8                    	rcr	al, 1
  1452 00000B5D 2C80                    	sub	al, 80h
  1453 00000B5F 66C1E008                	shl	ax, 8
  1454 00000B63 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1455 00000B65 88F8                    	mov	al, bh
  1456 00000B67 00F0                    	add	al, dh
  1457 00000B69 D0D8                    	rcr	al, 1
  1458 00000B6B 2C80                    	sub	al, 80h
  1459 00000B6D 66C1E008                	shl	ax, 8
  1460 00000B71 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1461 00000B73 88D0                    	mov	al, dl
  1462 00000B75 2C80                    	sub	al, 80h
  1463 00000B77 66C1E008                	shl	ax, 8
  1464 00000B7B 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1465 00000B7D 88F0                    	mov	al, dh
  1466 00000B7F 2C80                    	sub	al, 80h
  1467 00000B81 66C1E008                	shl	ax, 8
  1468 00000B85 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1469 00000B87 A0[1C200000]            	mov	al, [next_val_l]
  1470 00000B8C 00D0                    	add	al, dl
  1471 00000B8E D0D8                    	rcr	al, 1
  1472 00000B90 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1473 00000B92 00D0                    	add	al, dl
  1474 00000B94 D0D8                    	rcr	al, 1
  1475 00000B96 2C80                    	sub	al, 80h
  1476 00000B98 66C1E008                	shl	ax, 8
  1477 00000B9C 66AB                    	stosw		; this is 4th interpolated sample (L)
  1478 00000B9E A0[1E200000]            	mov	al, [next_val_r]
  1479 00000BA3 00F0                    	add	al, dh
  1480 00000BA5 D0D8                    	rcr	al, 1
  1481 00000BA7 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1482 00000BA9 00F0                    	add	al, dh
  1483 00000BAB D0D8                    	rcr	al, 1
  1484 00000BAD 2C80                    	sub	al, 80h
  1485 00000BAF 66C1E008                	shl	ax, 8
  1486 00000BB3 66AB                    	stosw		; this is 4th interpolated sample (R)
  1487 00000BB5 A0[1C200000]            	mov	al, [next_val_l]
  1488 00000BBA 00D8                    	add	al, bl
  1489 00000BBC D0D8                    	rcr	al, 1
  1490 00000BBE 2C80                    	sub	al, 80h
  1491 00000BC0 66C1E008                	shl	ax, 8
  1492 00000BC4 66AB                    	stosw		; this is 5th interpolated sample (L)
  1493 00000BC6 A0[1E200000]            	mov	al, [next_val_r]
  1494 00000BCB 00F8                    	add	al, bh
  1495 00000BCD D0D8                    	rcr	al, 1
  1496 00000BCF 2C80                    	sub	al, 80h
  1497 00000BD1 66C1E008                	shl	ax, 8
  1498 00000BD5 66AB                    	stosw		; this is 5th interpolated sample (R)
  1499                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1500 00000BD7 E305                    	jecxz	lff8s_6
  1501 00000BD9 E907FFFFFF              	jmp	lff8s_1
  1502                                  lff8s_6:
  1503 00000BDE E9A6FEFFFF              	jmp	lff8s_3
  1504                                  
  1505                                  load_8khz_mono_16_bit:
  1506                                  	; 13/11/2023
  1507 00000BE3 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1508                                  					; last of the file?
  1509 00000BEA 7402                    	jz	short lff8m2_0		; no
  1510 00000BEC F9                      	stc
  1511 00000BED C3                      	retn
  1512                                  
  1513                                  lff8m2_0:
  1514 00000BEE BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1515                                          ;mov	edx, [loadsize]
  1516                                  
  1517                                  	; esi = buffer address
  1518                                  	;; edx = buffer size
  1519                                  
  1520                                  	; load file into memory
  1521                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000BF3 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000BF9 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000BFB 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000C01 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000C06 CD40                <1>  int 40h
  1522 00000C08 0F82A0000000            	jc	lff8m2_7 ; error !
  1523                                  
  1524 00000C0E BF[00300000]            	mov	edi, audio_buffer
  1525                                  	
  1526 00000C13 D1E8                    	shr	eax, 1
  1527 00000C15 7505                    	jnz	short lff8m2_8
  1528 00000C17 E985FEFFFF              	jmp	lff8_eof
  1529                                  
  1530                                  lff8m2_8:
  1531 00000C1C 89C1                    	mov	ecx, eax	; word count
  1532                                  lff8m2_1:
  1533 00000C1E 66AD                    	lodsw
  1534 00000C20 66AB                    	stosw		; original sample (left channel)
  1535 00000C22 66AB                    	stosw		; original sample (right channel)
  1536 00000C24 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1537 00000C27 66A3[18200000]          	mov	[previous_val], ax
  1538 00000C2D 31C0                    	xor	eax, eax
  1539 00000C2F 49                      	dec	ecx
  1540 00000C30 7403                    	jz	short lff8m2_2
  1541 00000C32 668B06                  	mov	ax, [esi]
  1542                                  lff8m2_2:
  1543 00000C35 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  1544 00000C38 89C5                    	mov	ebp, eax	; [next_val]
  1545 00000C3A 660305[18200000]        	add	ax, [previous_val]
  1546 00000C41 66D1D8                  	rcr	ax, 1
  1547 00000C44 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample
  1548 00000C46 660305[18200000]        	add	ax, [previous_val]
  1549 00000C4D 66D1D8                  	rcr	ax, 1	; this is temporary interpolation value
  1550 00000C50 89C3                    	mov	ebx, eax 		
  1551 00000C52 660305[18200000]        	add	ax, [previous_val]
  1552 00000C59 66D1D8                  	rcr	ax, 1
  1553 00000C5C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1554 00000C5F 66AB                    	stosw		; this is 1st interpolated sample (L)
  1555 00000C61 66AB                    	stosw		; this is 1st interpolated sample (R)
  1556 00000C63 89D8                    	mov	eax, ebx
  1557 00000C65 6601D0                  	add	ax, dx
  1558 00000C68 66D1D8                  	rcr	ax, 1
  1559 00000C6B 80EC80                  	sub	ah, 80h
  1560 00000C6E 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1561 00000C70 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1562 00000C72 89D0                    	mov	eax, edx
  1563 00000C74 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1564 00000C77 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1565 00000C79 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1566 00000C7B 89E8                    	mov	eax, ebp
  1567 00000C7D 6601D0                  	add	ax, dx
  1568 00000C80 66D1D8                  	rcr	ax, 1
  1569 00000C83 89C3                    	mov	ebx, eax ; this is temporary interpolation value
  1570 00000C85 6601D0                  	add	ax, dx
  1571 00000C88 66D1D8                  	rcr	ax, 1
  1572 00000C8B 80EC80                  	sub	ah, 80h
  1573 00000C8E 66AB                    	stosw		; this is 4th interpolated sample (L)
  1574 00000C90 66AB                    	stosw		; this is 4th interpolated sample (R)
  1575 00000C92 89E8                    	mov	eax, ebp
  1576 00000C94 6601D8                  	add	ax, bx
  1577 00000C97 66D1D8                  	rcr	ax, 1
  1578 00000C9A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1579 00000C9D 66AB                    	stosw		; this is 5th interpolated sample (L)
  1580 00000C9F 66AB                    	stosw		; this is 5th interpolated sample (R)
  1581                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1582 00000CA1 09C9                    	or	ecx, ecx
  1583 00000CA3 0F8575FFFFFF            	jnz	lff8m2_1
  1584 00000CA9 E9DBFDFFFF              	jmp	lff8m2_3
  1585                                  
  1586                                  lff8m2_7:
  1587                                  lff8s2_7:
  1588 00000CAE E9F7FDFFFF              	jmp	lff8m2_5  ; error
  1589                                  
  1590                                  load_8khz_stereo_16_bit:
  1591                                  	; 16/11/2023
  1592                                  	; 15/11/2023
  1593                                  	; 13/11/2023
  1594 00000CB3 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1595                                  					; last of the file?
  1596 00000CBA 7402                    	jz	short lff8s2_0		; no
  1597 00000CBC F9                      	stc
  1598 00000CBD C3                      	retn
  1599                                  
  1600                                  lff8s2_0:
  1601 00000CBE BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1602                                          ;mov	edx, [loadsize]
  1603                                  
  1604                                  	; esi = buffer address
  1605                                  	;; edx = buffer size
  1606                                  
  1607                                  	; load file into memory
  1608                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000CC3 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000CC9 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000CCB 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000CD1 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000CD6 CD40                <1>  int 40h
  1609 00000CD8 72D4                    	jc	short lff8s2_7 ; error !
  1610                                  
  1611 00000CDA BF[00300000]            	mov	edi, audio_buffer
  1612                                  	
  1613 00000CDF C1E802                  	shr	eax, 2
  1614 00000CE2 7505                    	jnz	short lff8s2_8
  1615 00000CE4 E9B8FDFFFF              	jmp	lff8_eof
  1616                                  
  1617                                  lff8s2_8:
  1618 00000CE9 89C1                    	mov	ecx, eax ; dword count
  1619                                  lff8s2_1:
  1620 00000CEB 66AD                    	lodsw
  1621 00000CED 66AB                    	stosw		; original sample (L)
  1622                                  	; 15/11/2023
  1623 00000CEF 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1624 00000CF2 66A3[18200000]          	mov	[previous_val_l], ax
  1625 00000CF8 66AD                    	lodsw
  1626 00000CFA 66AB                    	stosw		; original sample (R)
  1627 00000CFC 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1628 00000CFF 66A3[1A200000]          	mov	[previous_val_r], ax
  1629 00000D05 31D2                    	xor	edx, edx
  1630 00000D07 31C0                    	xor	eax, eax
  1631                                  	; 16/11/2023
  1632 00000D09 49                      	dec	ecx
  1633 00000D0A 7407                    	jz	short lff8s2_2
  1634 00000D0C 668B06                  	mov	ax, [esi]
  1635 00000D0F 668B5602                	mov	dx, [esi+2]
  1636                                  lff8s2_2:
  1637 00000D13 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1638 00000D16 66A3[1C200000]          	mov	[next_val_l], ax
  1639 00000D1C 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  1640 00000D1F 668915[1E200000]        	mov	[next_val_r], dx
  1641 00000D26 660305[18200000]        	add	ax, [previous_val_l]
  1642 00000D2D 66D1D8                  	rcr	ax, 1
  1643 00000D30 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample (L)
  1644 00000D32 660305[18200000]        	add	ax, [previous_val_l]
  1645 00000D39 66D1D8                  	rcr	ax, 1	
  1646 00000D3C 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1647 00000D3E 660305[18200000]        	add	ax, [previous_val_l]
  1648 00000D45 66D1D8                  	rcr	ax, 1
  1649 00000D48 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1650 00000D4B 66AB                    	stosw		; this is 1st interpolated sample (L)
  1651 00000D4D 66A1[1E200000]          	mov	ax, [next_val_r]
  1652 00000D53 660305[1A200000]        	add	ax, [previous_val_r]
  1653 00000D5A 66D1D8                  	rcr	ax, 1
  1654 00000D5D 89C5                    	mov	ebp, eax ; this is interpolated middle (3th) sample (R)
  1655 00000D5F 660305[1A200000]        	add	ax, [previous_val_r]
  1656 00000D66 66D1D8                  	rcr	ax, 1
  1657 00000D69 50                      	push	eax ; *	; this is temporary interpolation value (R)
  1658 00000D6A 660305[1A200000]        	add	ax, [previous_val_r]
  1659 00000D71 66D1D8                  	rcr	ax, 1
  1660 00000D74 80EC80                  	sub	ah, 80h
  1661 00000D77 66AB                    	stosw		; this is 1st interpolated sample (R)
  1662 00000D79 89D8                    	mov	eax, ebx
  1663 00000D7B 6601D0                  	add	ax, dx
  1664 00000D7E 66D1D8                  	rcr	ax, 1
  1665 00000D81 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1666 00000D84 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1667 00000D86 58                      	pop	eax ; *
  1668 00000D87 6601E8                  	add	ax, bp
  1669 00000D8A 66D1D8                  	rcr	ax, 1
  1670 00000D8D 80EC80                  	sub	ah, 80h
  1671 00000D90 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1672 00000D92 89D0                    	mov	eax, edx
  1673 00000D94 80EC80                  	sub	ah, 80h
  1674 00000D97 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1675 00000D99 89E8                    	mov	eax, ebp
  1676 00000D9B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1677 00000D9E 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1678 00000DA0 66A1[1C200000]          	mov	ax, [next_val_l]
  1679 00000DA6 6601D0                  	add	ax, dx
  1680 00000DA9 66D1D8                  	rcr	ax, 1
  1681 00000DAC 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1682 00000DAE 6601D0                  	add	ax, dx
  1683 00000DB1 66D1D8                  	rcr	ax, 1
  1684 00000DB4 80EC80                  	sub	ah, 80h
  1685 00000DB7 66AB                    	stosw		; this is 4th interpolated sample (L)
  1686 00000DB9 66A1[1E200000]          	mov	ax, [next_val_r]
  1687 00000DBF 6601E8                  	add	ax, bp
  1688 00000DC2 66D1D8                  	rcr	ax, 1
  1689 00000DC5 50                      	push	eax ; ** ; this is temporary interpolation value (R)
  1690 00000DC6 6601E8                  	add	ax, bp
  1691 00000DC9 66D1D8                  	rcr	ax, 1
  1692 00000DCC 80EC80                  	sub	ah, 80h
  1693 00000DCF 66AB                    	stosw		; this is 4th interpolated sample (R)
  1694 00000DD1 66A1[1C200000]          	mov	ax, [next_val_l]
  1695 00000DD7 6601D8                  	add	ax, bx
  1696 00000DDA 66D1D8                  	rcr	ax, 1
  1697 00000DDD 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1698 00000DE0 66AB                    	stosw		; this is 5th interpolated sample (L)
  1699 00000DE2 58                      	pop	eax ; **
  1700 00000DE3 660305[1E200000]        	add	ax, [next_val_r]
  1701 00000DEA 66D1D8                  	rcr	ax, 1
  1702 00000DED 80EC80                  	sub	ah, 80h
  1703 00000DF0 66AB                    	stosw		; this is 5th interpolated sample (R)
  1704                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1705 00000DF2 E305                    	jecxz	lff8_s2_9
  1706 00000DF4 E9F2FEFFFF              	jmp	lff8s2_1
  1707                                  lff8_s2_9:
  1708 00000DF9 E98BFCFFFF              	jmp	lff8s2_3
  1709                                  
  1710                                  ; .....................
  1711                                  
  1712                                  load_16khz_mono_8_bit:
  1713                                  	; 14/11/2023
  1714                                  	; 13/11/2023
  1715 00000DFE F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1716                                  					; last of the file?
  1717 00000E05 7402                    	jz	short lff16m_0		; no
  1718 00000E07 F9                      	stc
  1719 00000E08 C3                      	retn
  1720                                  
  1721                                  lff16m_0:
  1722 00000E09 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1723                                          ;mov	edx, [loadsize]
  1724                                  
  1725                                  	; esi = buffer address
  1726                                  	;; edx = buffer size
  1727                                  
  1728                                  	; load file into memory
  1729                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000E0E 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000E14 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000E16 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000E1C B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000E21 CD40                <1>  int 40h
  1730 00000E23 7253                    	jc	short lff16m_7 ; error !
  1731                                  
  1732 00000E25 BF[00300000]            	mov	edi, audio_buffer
  1733                                  	
  1734 00000E2A 21C0                    	and	eax, eax
  1735 00000E2C 7505                    	jnz	short lff16m_8
  1736 00000E2E E96EFCFFFF              	jmp	lff16_eof
  1737                                  
  1738                                  lff16m_8:
  1739 00000E33 89C1                    	mov	ecx, eax		; byte count
  1740                                  lff16m_1:
  1741 00000E35 AC                      	lodsb
  1742                                  	;mov	[previous_val], al
  1743 00000E36 88C3                    	mov	bl, al
  1744 00000E38 2C80                    	sub	al, 80h
  1745 00000E3A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1746 00000E3E 66AB                    	stosw		; original sample (left channel)
  1747 00000E40 66AB                    	stosw		; original sample (right channel)
  1748                                  	;xor	ax, ax
  1749                                  	; 14/11/22023
  1750 00000E42 B080                    	mov	al, 80h
  1751 00000E44 49                      	dec	ecx
  1752 00000E45 7402                    	jz	short lff16m_2
  1753 00000E47 8A06                    	mov	al, [esi]
  1754                                  lff16m_2:
  1755                                  	;mov	[next_val], al
  1756 00000E49 88C7                    	mov	bh, al
  1757                                  	;add	al, [previous_val]
  1758 00000E4B 00D8                    	add	al, bl
  1759 00000E4D D0D8                    	rcr	al, 1
  1760 00000E4F 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  1761                                  	;add	al, [previous_val]
  1762 00000E51 00D8                    	add	al, bl
  1763 00000E53 D0D8                    	rcr	al, 1
  1764 00000E55 2C80                    	sub	al, 80h
  1765 00000E57 66C1E008                	shl	ax, 8
  1766 00000E5B 66AB                    	stosw		; this is 1st interpolated sample (L)
  1767 00000E5D 66AB                    	stosw		; this is 1st interpolated sample (R)
  1768                                  	;mov	al, [next_val]
  1769 00000E5F 88F8                    	mov	al, bh
  1770 00000E61 00D0                    	add	al, dl
  1771 00000E63 D0D8                    	rcr	al, 1
  1772 00000E65 2C80                    	sub	al, 80h
  1773 00000E67 66C1E008                	shl	ax, 8
  1774 00000E6B 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1775 00000E6D 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1776                                  	
  1777                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1778 00000E6F 09C9                    	or	ecx, ecx
  1779 00000E71 75C2                    	jnz	short lff16m_1
  1780 00000E73 E911FCFFFF              	jmp	lff16m_3
  1781                                  
  1782                                  lff16m_7:
  1783                                  lff16s_7:
  1784 00000E78 E92DFCFFFF              	jmp	lff16m_5  ; error
  1785                                  
  1786                                  load_16khz_stereo_8_bit:
  1787                                  	; 14/11/2023
  1788                                  	; 13/11/2023
  1789 00000E7D F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1790                                  					; last of the file?
  1791 00000E84 7402                    	jz	short lff16s_0		; no
  1792 00000E86 F9                      	stc
  1793 00000E87 C3                      	retn
  1794                                  
  1795                                  lff16s_0:
  1796 00000E88 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1797                                          ;mov	edx, [loadsize]
  1798                                  
  1799                                  	; esi = buffer address
  1800                                  	;; edx = buffer size
  1801                                  
  1802                                  	; load file into memory
  1803                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000E8D 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000E93 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000E95 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000E9B B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000EA0 CD40                <1>  int 40h
  1804 00000EA2 72D4                    	jc	short lff16s_7 ; error !
  1805                                  
  1806 00000EA4 BF[00300000]            	mov	edi, audio_buffer
  1807                                  	
  1808 00000EA9 D1E8                    	shr	eax, 1
  1809 00000EAB 7505                    	jnz	short lff16s_8
  1810 00000EAD E9EFFBFFFF              	jmp	lff16_eof
  1811                                  
  1812                                  lff16s_8:
  1813 00000EB2 89C1                    	mov	ecx, eax	; word count
  1814                                  lff16s_1:
  1815 00000EB4 AC                      	lodsb
  1816 00000EB5 A2[18200000]            	mov	[previous_val_l], al
  1817 00000EBA 2C80                    	sub	al, 80h
  1818 00000EBC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1819 00000EC0 66AB                    	stosw		; original sample (L)
  1820 00000EC2 AC                      	lodsb
  1821 00000EC3 A2[1A200000]            	mov	[previous_val_r], al
  1822 00000EC8 2C80                    	sub	al, 80h
  1823 00000ECA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1824 00000ECE 66AB                    	stosw		; original sample (R)
  1825                                  
  1826                                  	;xor	eax, eax
  1827 00000ED0 66B88080                	mov	ax, 8080h
  1828 00000ED4 49                      	dec	ecx
  1829 00000ED5 7403                    	jz	short lff16s_2
  1830                                  		; convert 8 bit sample to 16 bit sample
  1831 00000ED7 668B06                  	mov	ax, [esi]
  1832                                  lff16s_2:
  1833                                  	;mov	[next_val_l], al
  1834                                  	;mov	[next_val_r], ah
  1835 00000EDA 89C3                    	mov	ebx, eax
  1836 00000EDC 0205[18200000]          	add	al, [previous_val_l]
  1837 00000EE2 D0D8                    	rcr	al, 1
  1838 00000EE4 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  1839 00000EE6 0205[18200000]          	add	al, [previous_val_l]
  1840 00000EEC D0D8                    	rcr	al, 1
  1841 00000EEE 2C80                    	sub	al, 80h
  1842 00000EF0 66C1E008                	shl	ax, 8
  1843 00000EF4 66AB                    	stosw		; this is 1st interpolated sample (L)
  1844 00000EF6 88F8                    	mov	al, bh	; [next_val_r]
  1845 00000EF8 0205[1A200000]          	add	al, [previous_val_r]
  1846 00000EFE D0D8                    	rcr	al, 1
  1847 00000F00 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  1848 00000F02 0205[1A200000]          	add	al, [previous_val_r]
  1849 00000F08 D0D8                    	rcr	al, 1
  1850 00000F0A 2C80                    	sub	al, 80h
  1851 00000F0C 66C1E008                	shl	ax, 8
  1852 00000F10 66AB                    	stosw		; this is 1st interpolated sample (R)
  1853 00000F12 88D0                    	mov	al, dl
  1854 00000F14 00D8                    	add	al, bl	; [next_val_l]
  1855 00000F16 D0D8                    	rcr	al, 1
  1856 00000F18 2C80                    	sub	al, 80h
  1857 00000F1A 66C1E008                	shl	ax, 8
  1858 00000F1E 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1859 00000F20 88F0                    	mov	al, dh
  1860 00000F22 00F8                    	add	al, bh	; [next_val_r]
  1861 00000F24 D0D8                    	rcr	al, 1
  1862 00000F26 2C80                    	sub	al, 80h
  1863 00000F28 66C1E008                	shl	ax, 8
  1864 00000F2C 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1865                                  	
  1866                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1867 00000F2E 09C9                    	or	ecx, ecx
  1868 00000F30 7582                    	jnz	short lff16s_1
  1869 00000F32 E952FBFFFF              	jmp	lff16s_3
  1870                                  
  1871                                  load_16khz_mono_16_bit:
  1872                                  	; 15/11/2023
  1873                                  	; 13/11/2023
  1874 00000F37 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1875                                  					; last of the file?
  1876 00000F3E 7402                    	jz	short lff16m2_0		; no
  1877 00000F40 F9                      	stc
  1878 00000F41 C3                      	retn
  1879                                  
  1880                                  lff16m2_0:
  1881 00000F42 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1882                                          ;mov	edx, [loadsize]
  1883                                  
  1884                                  	; esi = buffer address
  1885                                  	;; edx = buffer size
  1886                                  
  1887                                  	; load file into memory
  1888                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000F47 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000F4D 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000F4F 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000F55 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000F5A CD40                <1>  int 40h
  1889 00000F5C 7255                    	jc	short lff16m2_7 ; error !
  1890                                  
  1891 00000F5E BF[00300000]            	mov	edi, audio_buffer
  1892                                  	
  1893 00000F63 D1E8                    	shr	eax, 1
  1894 00000F65 7505                    	jnz	short lff16m2_8
  1895 00000F67 E935FBFFFF              	jmp	lff16_eof
  1896                                  
  1897                                  lff16m2_8:
  1898 00000F6C 89C1                    	mov	ecx, eax  ; word count
  1899                                  lff16m2_1:
  1900 00000F6E 66AD                    	lodsw
  1901 00000F70 66AB                    	stosw		; original sample (left channel)
  1902 00000F72 66AB                    	stosw		; original sample (right channel)
  1903 00000F74 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  1904                                  	;mov	[previous_val], ax
  1905 00000F77 89C3                    	mov	ebx, eax	
  1906 00000F79 31C0                    	xor	eax, eax
  1907 00000F7B 49                      	dec	ecx
  1908 00000F7C 7403                    	jz	short lff16m2_2
  1909 00000F7E 668B06                  	mov	ax, [esi]
  1910                                  lff16m2_2:
  1911 00000F81 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  1912 00000F84 89C5                    	mov	ebp, eax	; [next_val]
  1913                                  	;add	ax, [previous_val]
  1914 00000F86 6601D8                  	add	ax, bx
  1915 00000F89 66D1D8                  	rcr	ax, 1
  1916 00000F8C 89C2                    	mov	edx, eax ; this is temporary interpolation value
  1917                                  	;add	ax, [previous_val]
  1918 00000F8E 6601D8                  	add	ax, bx
  1919 00000F91 66D1D8                  	rcr	ax, 1
  1920 00000F94 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1921 00000F97 66AB                    	stosw		; this is 1st interpolated sample (L)
  1922 00000F99 66AB                    	stosw		; this is 1st interpolated sample (R)
  1923 00000F9B 89E8                    	mov	eax, ebp 
  1924 00000F9D 6601D0                  	add	ax, dx
  1925 00000FA0 66D1D8                  	rcr	ax, 1
  1926 00000FA3 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1927 00000FA6 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1928 00000FA8 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1929                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1930 00000FAA 09C9                    	or	ecx, ecx
  1931 00000FAC 75C0                    	jnz	short lff16m2_1
  1932 00000FAE E9D6FAFFFF              	jmp	lff16m2_3
  1933                                  
  1934                                  lff16m2_7:
  1935                                  lff16s2_7:
  1936 00000FB3 E9F2FAFFFF              	jmp	lff16m2_5  ; error
  1937                                  
  1938                                  load_16khz_stereo_16_bit:
  1939                                  	; 16/11/2023
  1940                                  	; 15/11/2023
  1941                                  	; 13/11/2023
  1942 00000FB8 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1943                                  					; last of the file?
  1944 00000FBF 7402                    	jz	short lff16s2_0		; no
  1945 00000FC1 F9                      	stc
  1946 00000FC2 C3                      	retn
  1947                                  
  1948                                  lff16s2_0:
  1949 00000FC3 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1950                                          ;mov	edx, [loadsize]
  1951                                  
  1952                                  	; esi = buffer address
  1953                                  	;; edx = buffer size
  1954                                  
  1955                                  	; load file into memory
  1956                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00000FC8 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00000FCE 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00000FD0 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00000FD6 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00000FDB CD40                <1>  int 40h
  1957 00000FDD 72D4                    	jc	short lff16s2_7 ; error !
  1958                                  
  1959 00000FDF BF[00300000]            	mov	edi, audio_buffer
  1960                                  	
  1961 00000FE4 C1E802                  	shr	eax, 2
  1962 00000FE7 7505                    	jnz	short lff16s2_8
  1963 00000FE9 E9B3FAFFFF              	jmp	lff16_eof
  1964                                  
  1965                                  lff16s2_8:
  1966 00000FEE 89C1                    	mov	ecx, eax  ; dword count
  1967                                  lff16s2_1:
  1968 00000FF0 66AD                    	lodsw
  1969 00000FF2 66AB                    	stosw		; original sample (L)
  1970 00000FF4 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  1971 00000FF7 66A3[18200000]          	mov	[previous_val_l], ax
  1972 00000FFD 66AD                    	lodsw
  1973 00000FFF 66AB                    	stosw		; original sample (R)
  1974 00001001 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  1975 00001004 66A3[1A200000]          	mov	[previous_val_r], ax
  1976 0000100A 31D2                    	xor	edx, edx
  1977 0000100C 31C0                    	xor	eax, eax
  1978                                  	; 16/11/2023
  1979 0000100E 49                      	dec	ecx
  1980 0000100F 7407                    	jz	short lff16s2_2
  1981 00001011 668B06                  	mov	ax, [esi]
  1982 00001014 668B5602                	mov	dx, [esi+2]
  1983                                  lff16s2_2:
  1984 00001018 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  1985                                  	;mov	[next_val_l], ax
  1986 0000101B 89C5                    	mov	ebp, eax
  1987 0000101D 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  1988 00001020 668915[1E200000]        	mov	[next_val_r], dx
  1989 00001027 660305[18200000]        	add	ax, [previous_val_l]
  1990 0000102E 66D1D8                  	rcr	ax, 1
  1991 00001031 89C2                    	mov	edx, eax ; this is temporary interpolation value (L)
  1992 00001033 660305[18200000]        	add	ax, [previous_val_l]
  1993 0000103A 66D1D8                  	rcr	ax, 1
  1994 0000103D 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  1995 00001040 66AB                    	stosw		; this is 1st interpolated sample (L)
  1996 00001042 66A1[1E200000]          	mov	ax, [next_val_r]
  1997 00001048 660305[1A200000]        	add	ax, [previous_val_r]
  1998 0000104F 66D1D8                  	rcr	ax, 1
  1999 00001052 89C3                    	mov	ebx, eax ; this is temporary interpolation value (R)
  2000 00001054 660305[1A200000]        	add	ax, [previous_val_r]
  2001 0000105B 66D1D8                  	rcr	ax, 1
  2002 0000105E 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2003 00001061 66AB                    	stosw		; this is 1st interpolated sample (R)
  2004                                  	;mov	ax, [next_val_l]
  2005 00001063 89E8                    	mov	eax, ebp
  2006 00001065 6601D0                  	add	ax, dx
  2007 00001068 66D1D8                  	rcr	ax, 1
  2008 0000106B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2009 0000106E 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2010 00001070 66A1[1E200000]          	mov	ax, [next_val_r]
  2011 00001076 6601D8                  	add	ax, bx
  2012 00001079 66D1D8                  	rcr	ax, 1
  2013 0000107C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2014 0000107F 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  2015                                  	
  2016                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2017 00001081 09C9                    	or	ecx, ecx
  2018 00001083 0F8567FFFFFF            	jnz	lff16s2_1
  2019 00001089 E9FBF9FFFF              	jmp	lff16s2_3
  2020                                  
  2021                                  ; .....................
  2022                                  
  2023                                  load_24khz_mono_8_bit:
  2024                                  	; 15/11/2023
  2025 0000108E F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2026                                  					; last of the file?
  2027 00001095 7402                    	jz	short lff24m_0		; no
  2028 00001097 F9                      	stc
  2029 00001098 C3                      	retn
  2030                                  
  2031                                  lff24m_0:
  2032 00001099 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2033                                          ;mov	edx, [loadsize]
  2034                                  
  2035                                  	; esi = buffer address
  2036                                  	;; edx = buffer size
  2037                                  
  2038                                  	; load file into memory
  2039                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000109E 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000010A4 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000010A6 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000010AC B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000010B1 CD40                <1>  int 40h
  2040 000010B3 723B                    	jc	short lff24m_7 ; error !
  2041                                  
  2042 000010B5 BF[00300000]            	mov	edi, audio_buffer
  2043                                  	
  2044 000010BA 21C0                    	and	eax, eax
  2045 000010BC 7505                    	jnz	short lff24m_8
  2046 000010BE E9DEF9FFFF              	jmp	lff24_eof
  2047                                  
  2048                                  lff24m_8:
  2049 000010C3 89C1                    	mov	ecx, eax	; byte count
  2050                                  lff24m_1:
  2051 000010C5 AC                      	lodsb
  2052                                  	;mov	[previous_val], al
  2053 000010C6 88C3                    	mov	bl, al
  2054 000010C8 2C80                    	sub	al, 80h
  2055 000010CA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2056 000010CE 66AB                    	stosw		; original sample (left channel)
  2057 000010D0 66AB                    	stosw		; original sample (right channel)
  2058                                  	;xor	eax, eax
  2059 000010D2 B080                    	mov	al, 80h
  2060 000010D4 49                      	dec	ecx
  2061 000010D5 7402                    	jz	short lff24m_2
  2062 000010D7 8A06                    	mov	al, [esi]
  2063                                  lff24m_2:
  2064                                  	;;mov	[next_val], al
  2065                                  	;mov	bh, al
  2066                                  	;add	al, [previous_val]
  2067 000010D9 00D8                    	add	al, bl
  2068 000010DB D0D8                    	rcr	al, 1
  2069 000010DD 2C80                    	sub	al, 80h
  2070 000010DF 66C1E008                	shl	ax, 8
  2071 000010E3 66AB                    	stosw		; this is interpolated sample (L)
  2072 000010E5 66AB                    	stosw		; this is interpolated sample (R)
  2073                                  	
  2074                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2075 000010E7 09C9                    	or	ecx, ecx
  2076 000010E9 75DA                    	jnz	short lff24m_1
  2077 000010EB E999F9FFFF              	jmp	lff24_3
  2078                                  
  2079                                  lff24m_7:
  2080                                  lff24s_7:
  2081 000010F0 E9B5F9FFFF              	jmp	lff24_5  ; error
  2082                                  
  2083                                  load_24khz_stereo_8_bit:
  2084                                  	; 15/11/2023
  2085 000010F5 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2086                                  					; last of the file?
  2087 000010FC 7402                    	jz	short lff24s_0		; no
  2088 000010FE F9                      	stc
  2089 000010FF C3                      	retn
  2090                                  
  2091                                  lff24s_0:
  2092 00001100 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2093                                          ;mov	edx, [loadsize]
  2094                                  
  2095                                  	; esi = buffer address
  2096                                  	;; edx = buffer size
  2097                                  
  2098                                  	; load file into memory
  2099                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001105 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000110B 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000110D 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001113 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001118 CD40                <1>  int 40h
  2100 0000111A 72D4                    	jc	short lff24s_7 ; error !
  2101                                  
  2102 0000111C BF[00300000]            	mov	edi, audio_buffer
  2103                                  	
  2104 00001121 D1E8                    	shr	eax, 1
  2105 00001123 7505                    	jnz	short lff24s_8
  2106 00001125 E977F9FFFF              	jmp	lff24_eof
  2107                                  
  2108                                  lff24s_8:
  2109 0000112A 89C1                    	mov	ecx, eax  ; word count
  2110                                  lff24s_1:
  2111 0000112C AC                      	lodsb
  2112 0000112D A2[18200000]            	mov	[previous_val_l], al
  2113 00001132 2C80                    	sub	al, 80h
  2114 00001134 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2115 00001138 66AB                    	stosw		; original sample (L)
  2116 0000113A AC                      	lodsb
  2117 0000113B A2[1A200000]            	mov	[previous_val_r], al
  2118 00001140 2C80                    	sub	al, 80h
  2119 00001142 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2120 00001146 66AB                    	stosw		; original sample (R)
  2121                                  
  2122                                  	;xor	eax, eax
  2123 00001148 66B88080                	mov	ax, 8080h
  2124 0000114C 49                      	dec	ecx
  2125 0000114D 7403                    	jz	short lff24s_2
  2126                                  		; convert 8 bit sample to 16 bit sample
  2127 0000114F 668B06                  	mov	ax, [esi]
  2128                                  lff24s_2:
  2129                                  	;;mov	[next_val_l], al
  2130                                  	;;mov	[next_val_r], ah
  2131                                  	;mov	bx, ax
  2132 00001152 88E7                    	mov	bh, ah
  2133 00001154 0205[18200000]          	add	al, [previous_val_l]
  2134 0000115A D0D8                    	rcr	al, 1
  2135                                  	;mov	dl, al
  2136 0000115C 2C80                    	sub	al, 80h
  2137 0000115E 66C1E008                	shl	ax, 8
  2138 00001162 66AB                    	stosw		; this is interpolated sample (L)
  2139 00001164 88F8                    	mov	al, bh	; [next_val_r]
  2140 00001166 0205[1A200000]          	add	al, [previous_val_r]
  2141 0000116C D0D8                    	rcr	al, 1
  2142                                  	;mov	dh, al
  2143 0000116E 2C80                    	sub	al, 80h
  2144 00001170 66C1E008                	shl	ax, 8
  2145 00001174 66AB                    	stosw		; this is interpolated sample (R)
  2146                                  		
  2147                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2148 00001176 09C9                    	or	ecx, ecx
  2149 00001178 75B2                    	jnz	short lff24s_1
  2150 0000117A E90AF9FFFF              	jmp	lff24_3
  2151                                  
  2152                                  load_24khz_mono_16_bit:
  2153                                  	; 15/11/2023
  2154 0000117F F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2155                                  					; last of the file?
  2156 00001186 7402                    	jz	short lff24m2_0		; no
  2157 00001188 F9                      	stc
  2158 00001189 C3                      	retn
  2159                                  
  2160                                  lff24m2_0:
  2161 0000118A BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2162                                          ;mov	edx, [loadsize]
  2163                                  
  2164                                  	; esi = buffer address
  2165                                  	;; edx = buffer size
  2166                                  
  2167                                  	; load file into memory
  2168                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000118F 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001195 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001197 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000119D B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000011A2 CD40                <1>  int 40h
  2169 000011A4 7237                    	jc	short lff24m2_7 ; error !
  2170                                  
  2171 000011A6 BF[00300000]            	mov	edi, audio_buffer
  2172                                  	
  2173 000011AB D1E8                    	shr	eax, 1
  2174 000011AD 7505                    	jnz	short lff24m2_8
  2175 000011AF E9EDF8FFFF              	jmp	lff24_eof
  2176                                  
  2177                                  lff24m2_8:
  2178 000011B4 89C1                    	mov	ecx, eax  ; word count
  2179                                  lff24m2_1:
  2180 000011B6 66AD                    	lodsw
  2181 000011B8 66AB                    	stosw		; original sample (left channel)
  2182 000011BA 66AB                    	stosw		; original sample (right channel)
  2183 000011BC 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2184                                  	;mov	[previous_val], ax
  2185                                  	;mov	ebx, eax	
  2186                                  	;xor	eax, eax
  2187 000011BF 31DB                    	xor	ebx, ebx
  2188 000011C1 49                      	dec	ecx
  2189 000011C2 7403                    	jz	short lff24m2_2
  2190                                  	;mov	ax, [esi]
  2191 000011C4 668B1E                  	mov	bx, [esi]
  2192                                  lff24m2_2:
  2193                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2194                                  	;mov	ebp, eax	; [next_val]
  2195                                  	;add	ax, [previous_val]
  2196                                  	; ax = [previous_val]
  2197                                  	; bx = [next_val]
  2198 000011C7 6601D8                  	add	ax, bx
  2199 000011CA 66D1D8                  	rcr	ax, 1
  2200 000011CD 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2201 000011D0 66AB                    	stosw		; this is interpolated sample (L)
  2202 000011D2 66AB                    	stosw		; this is interpolated sample (R)
  2203                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2204 000011D4 09C9                    	or	ecx, ecx
  2205 000011D6 75DE                    	jnz	short lff24m2_1
  2206 000011D8 E9ACF8FFFF              	jmp	lff24_3
  2207                                  
  2208                                  lff24m2_7:
  2209                                  lff24s2_7:
  2210 000011DD E9C8F8FFFF              	jmp	lff24_5  ; error
  2211                                  
  2212                                  load_24khz_stereo_16_bit:
  2213                                  	; 16/11/2023
  2214                                  	; 15/11/2023
  2215 000011E2 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2216                                  					; last of the file?
  2217 000011E9 7402                    	jz	short lff24s2_0		; no
  2218 000011EB F9                      	stc
  2219 000011EC C3                      	retn
  2220                                  
  2221                                  lff24s2_0:
  2222 000011ED BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2223                                          ;mov	edx, [loadsize]
  2224                                  
  2225                                  	; esi = buffer address
  2226                                  	;; edx = buffer size
  2227                                  
  2228                                  	; load file into memory
  2229                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000011F2 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000011F8 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000011FA 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001200 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001205 CD40                <1>  int 40h
  2230 00001207 72D4                    	jc	short lff24s2_7 ; error !
  2231                                  
  2232 00001209 BF[00300000]            	mov	edi, audio_buffer
  2233                                  	
  2234 0000120E C1E802                  	shr	eax, 2
  2235 00001211 7505                    	jnz	short lff24s2_8
  2236 00001213 E989F8FFFF              	jmp	lff24_eof
  2237                                  
  2238                                  lff24s2_8:
  2239 00001218 89C1                    	mov	ecx, eax  ; dword count
  2240                                  lff24s2_1:
  2241 0000121A 66AD                    	lodsw
  2242 0000121C 66AB                    	stosw		; original sample (L)
  2243 0000121E 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2244 00001221 66A3[18200000]          	mov	[previous_val_l], ax
  2245 00001227 66AD                    	lodsw
  2246 00001229 66AB                    	stosw		; original sample (R)
  2247 0000122B 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2248                                  	;mov	[previous_val_r], ax
  2249 0000122E 89C3                    	mov	ebx, eax
  2250 00001230 31D2                    	xor	edx, edx
  2251 00001232 31C0                    	xor	eax, eax
  2252                                  	; 16/11/2023
  2253 00001234 49                      	dec	ecx
  2254 00001235 7407                    	jz	short lff24s2_2
  2255 00001237 668B06                  	mov	ax, [esi]
  2256 0000123A 668B5602                	mov	dx, [esi+2]
  2257                                  lff24s2_2:
  2258 0000123E 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2259                                  	;;mov	[next_val_l], ax
  2260                                  	;mov	ebp, eax
  2261 00001241 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2262                                  	;mov	[next_val_r], dx
  2263 00001244 660305[18200000]        	add	ax, [previous_val_l]
  2264 0000124B 66D1D8                  	rcr	ax, 1
  2265 0000124E 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2266 00001251 66AB                    	stosw		; this is interpolated sample (L)
  2267                                  	;mov	ax, [next_val_r]
  2268 00001253 89D0                    	mov	eax, edx
  2269                                  	;add	ax, [previous_val_r]
  2270 00001255 6601D8                  	add	ax, bx
  2271 00001258 66D1D8                  	rcr	ax, 1
  2272 0000125B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2273 0000125E 66AB                    	stosw		; this is interpolated sample (R)
  2274                                  	
  2275                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2276 00001260 09C9                    	or	ecx, ecx
  2277 00001262 75B6                    	jnz	short lff24s2_1
  2278 00001264 E920F8FFFF              	jmp	lff24_3
  2279                                  
  2280                                  ; .....................
  2281                                  
  2282                                  load_32khz_mono_8_bit:
  2283                                  	; 15/11/2023
  2284 00001269 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2285                                  					; last of the file?
  2286 00001270 7402                    	jz	short lff32m_0		; no
  2287 00001272 F9                      	stc
  2288 00001273 C3                      	retn
  2289                                  
  2290                                  lff32m_0:
  2291 00001274 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2292                                          ;mov	edx, [loadsize]
  2293                                  
  2294                                  	; esi = buffer address
  2295                                  	;; edx = buffer size
  2296                                  
  2297                                  	; load file into memory
  2298                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001279 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000127F 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001281 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001287 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000128C CD40                <1>  int 40h
  2299 0000128E 7247                    	jc	short lff32m_7 ; error !
  2300                                  
  2301 00001290 BF[00300000]            	mov	edi, audio_buffer
  2302                                  	
  2303 00001295 21C0                    	and	eax, eax
  2304 00001297 7505                    	jnz	short lff32m_8
  2305 00001299 E903F8FFFF              	jmp	lff32_eof
  2306                                  
  2307                                  lff32m_8:
  2308 0000129E 89C1                    	mov	ecx, eax	; byte count
  2309                                  lff32m_1:
  2310 000012A0 AC                      	lodsb
  2311                                  	;mov	[previous_val], al
  2312 000012A1 88C3                    	mov	bl, al
  2313 000012A3 2C80                    	sub	al, 80h
  2314 000012A5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2315 000012A9 66AB                    	stosw		; original sample (left channel)
  2316 000012AB 66AB                    	stosw		; original sample (right channel)
  2317                                  	;xor	eax, eax
  2318 000012AD B080                    	mov	al, 80h
  2319 000012AF 49                      	dec	ecx
  2320 000012B0 7402                    	jz	short lff32m_2
  2321 000012B2 8A06                    	mov	al, [esi]
  2322                                  lff32m_2:
  2323                                  	;;mov	[next_val], al
  2324                                  	;mov	bh, al
  2325                                  	;add	al, [previous_val]
  2326 000012B4 00D8                    	add	al, bl
  2327 000012B6 D0D8                    	rcr	al, 1
  2328 000012B8 2C80                    	sub	al, 80h
  2329 000012BA 66C1E008                	shl	ax, 8
  2330 000012BE 66AB                    	stosw		; this is interpolated sample (L)
  2331 000012C0 66AB                    	stosw		; this is interpolated sample (R)
  2332                                  	
  2333                                  	; different than 8-16-24 kHZ !
  2334                                  	; 'original-interpolated-original' trio samples 
  2335 000012C2 E30E                    	jecxz	lff32m_3
  2336                                  
  2337 000012C4 AC                      	lodsb
  2338 000012C5 2C80                    	sub	al, 80h
  2339 000012C7 66C1E008                	shl	ax, 8
  2340 000012CB 66AB                    	stosw		; original sample (left channel)
  2341 000012CD 66AB                    	stosw		; original sample (right channel)
  2342                                  
  2343                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2344 000012CF 49                      	dec	ecx
  2345 000012D0 75CE                    	jnz	short lff32m_1
  2346                                  lff32m_3:
  2347 000012D2 E9B2F7FFFF              	jmp	lff32_3
  2348                                  
  2349                                  lff32m_7:
  2350                                  lff32s_7:
  2351 000012D7 E9CEF7FFFF              	jmp	lff32_5  ; error
  2352                                  
  2353                                  load_32khz_stereo_8_bit:
  2354                                  	; 15/11/2023
  2355 000012DC F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2356                                  					; last of the file?
  2357 000012E3 7402                    	jz	short lff32s_0		; no
  2358 000012E5 F9                      	stc
  2359 000012E6 C3                      	retn
  2360                                  
  2361                                  lff32s_0:
  2362 000012E7 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2363                                          ;mov	edx, [loadsize]
  2364                                  
  2365                                  	; esi = buffer address
  2366                                  	;; edx = buffer size
  2367                                  
  2368                                  	; load file into memory
  2369                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000012EC 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000012F2 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000012F4 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000012FA B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000012FF CD40                <1>  int 40h
  2370 00001301 72D4                    	jc	short lff32s_7 ; error !
  2371                                  
  2372 00001303 BF[00300000]            	mov	edi, audio_buffer
  2373                                  	
  2374 00001308 D1E8                    	shr	eax, 1
  2375 0000130A 7505                    	jnz	short lff32s_8
  2376 0000130C E990F7FFFF              	jmp	lff32_eof
  2377                                  
  2378                                  lff32s_8:
  2379 00001311 89C1                    	mov	ecx, eax  ; word count
  2380                                  lff32s_1:
  2381 00001313 AC                      	lodsb
  2382 00001314 A2[18200000]            	mov	[previous_val_l], al
  2383 00001319 2C80                    	sub	al, 80h
  2384 0000131B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2385 0000131F 66AB                    	stosw		; original sample (L)
  2386 00001321 AC                      	lodsb
  2387 00001322 A2[1A200000]            	mov	[previous_val_r], al
  2388 00001327 2C80                    	sub	al, 80h
  2389 00001329 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2390 0000132D 66AB                    	stosw		; original sample (R)
  2391                                  
  2392                                  	;xor	eax, eax
  2393 0000132F 66B88080                	mov	ax, 8080h
  2394 00001333 49                      	dec	ecx
  2395 00001334 7403                    	jz	short lff32s_2
  2396                                  		; convert 8 bit sample to 16 bit sample
  2397 00001336 668B06                  	mov	ax, [esi]
  2398                                  lff32s_2:
  2399                                  	;;mov	[next_val_l], al
  2400                                  	;;mov	[next_val_r], ah
  2401                                  	;mov	bx, ax
  2402 00001339 88E7                    	mov	bh, ah
  2403 0000133B 0205[18200000]          	add	al, [previous_val_l]
  2404 00001341 D0D8                    	rcr	al, 1
  2405                                  	;mov	dl, al
  2406 00001343 2C80                    	sub	al, 80h
  2407 00001345 66C1E008                	shl	ax, 8
  2408 00001349 66AB                    	stosw		; this is interpolated sample (L)
  2409 0000134B 88F8                    	mov	al, bh	; [next_val_r]
  2410 0000134D 0205[1A200000]          	add	al, [previous_val_r]
  2411 00001353 D0D8                    	rcr	al, 1
  2412                                  	;mov	dh, al
  2413 00001355 2C80                    	sub	al, 80h
  2414 00001357 66C1E008                	shl	ax, 8
  2415 0000135B 66AB                    	stosw		; this is interpolated sample (R)
  2416                                  
  2417                                  	; different than 8-16-24 kHZ !
  2418                                  	; 'original-interpolated-original' trio samples 
  2419 0000135D E315                    	jecxz	lff32s_3
  2420                                  
  2421 0000135F AC                      	lodsb
  2422 00001360 2C80                    	sub	al, 80h
  2423 00001362 66C1E008                	shl	ax, 8
  2424 00001366 66AB                    	stosw		; original sample (left channel)
  2425                                  
  2426 00001368 AC                      	lodsb
  2427 00001369 2C80                    	sub	al, 80h
  2428 0000136B 66C1E008                	shl	ax, 8
  2429 0000136F 66AB                    	stosw		; original sample (right channel)
  2430                                  		
  2431                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2432 00001371 49                      	dec	ecx
  2433 00001372 759F                    	jnz	short lff32s_1
  2434                                  lff32s_3:
  2435 00001374 E910F7FFFF              	jmp	lff32_3
  2436                                  
  2437                                  load_32khz_mono_16_bit:
  2438                                  	; 15/11/2023
  2439 00001379 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2440                                  					; last of the file?
  2441 00001380 7402                    	jz	short lff32m2_0		; no
  2442 00001382 F9                      	stc
  2443 00001383 C3                      	retn
  2444                                  
  2445                                  lff32m2_0:
  2446 00001384 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2447                                          ;mov	edx, [loadsize]
  2448                                  
  2449                                  	; esi = buffer address
  2450                                  	;; edx = buffer size
  2451                                  
  2452                                  	; load file into memory
  2453                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001389 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000138F 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001391 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001397 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000139C CD40                <1>  int 40h
  2454 0000139E 723E                    	jc	short lff32m2_7 ; error !
  2455                                  
  2456 000013A0 BF[00300000]            	mov	edi, audio_buffer
  2457                                  	
  2458 000013A5 D1E8                    	shr	eax, 1
  2459 000013A7 7505                    	jnz	short lff32m2_8
  2460 000013A9 E9F3F6FFFF              	jmp	lff32_eof
  2461                                  
  2462                                  lff32m2_8:
  2463 000013AE 89C1                    	mov	ecx, eax  ; word count
  2464                                  lff32m2_1:
  2465 000013B0 66AD                    	lodsw
  2466 000013B2 66AB                    	stosw		; original sample (left channel)
  2467 000013B4 66AB                    	stosw		; original sample (right channel)
  2468 000013B6 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2469                                  	;mov	[previous_val], ax
  2470                                  	;mov	ebx, eax	
  2471                                  	;xor	eax, eax
  2472 000013B9 31DB                    	xor	ebx, ebx
  2473 000013BB 49                      	dec	ecx
  2474 000013BC 7403                    	jz	short lff32m2_2
  2475                                  	;mov	ax, [esi]
  2476 000013BE 668B1E                  	mov	bx, [esi]
  2477                                  lff32m2_2:
  2478                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2479                                  	;mov	ebp, eax	; [next_val]
  2480                                  	;add	ax, [previous_val]
  2481                                  	; ax = [previous_val]
  2482                                  	; bx = [next_val]
  2483 000013C1 6601D8                  	add	ax, bx
  2484 000013C4 66D1D8                  	rcr	ax, 1
  2485 000013C7 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2486 000013CA 66AB                    	stosw		; this is interpolated sample (L)
  2487 000013CC 66AB                    	stosw		; this is interpolated sample (R)
  2488                                  
  2489                                  	; different than 8-16-24 kHZ !
  2490                                  	; 'original-interpolated-original' trio samples 
  2491 000013CE E309                    	jecxz	lff32m2_3
  2492                                  
  2493 000013D0 66AD                    	lodsw
  2494 000013D2 66AB                    	stosw		; original sample (left channel)
  2495 000013D4 66AB                    	stosw		; original sample (right channel)
  2496                                  
  2497                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2498 000013D6 49                      	dec	ecx
  2499 000013D7 75D7                    	jnz	short lff32m2_1
  2500                                  lff32m2_3:
  2501 000013D9 E9ABF6FFFF              	jmp	lff32_3
  2502                                  
  2503                                  lff32m2_7:
  2504                                  lff32s2_7:
  2505 000013DE E9C7F6FFFF              	jmp	lff32_5  ; error
  2506                                  
  2507                                  load_32khz_stereo_16_bit:
  2508                                  	; 16/11/2023
  2509                                  	; 15/11/2023
  2510 000013E3 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2511                                  					; last of the file?
  2512 000013EA 7402                    	jz	short lff32s2_0		; no
  2513 000013EC F9                      	stc
  2514 000013ED C3                      	retn
  2515                                  
  2516                                  lff32s2_0:
  2517 000013EE BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2518                                          ;mov	edx, [loadsize]
  2519                                  
  2520                                  	; esi = buffer address
  2521                                  	;; edx = buffer size
  2522                                  
  2523                                  	; load file into memory
  2524                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000013F3 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000013F9 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000013FB 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001401 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001406 CD40                <1>  int 40h
  2525 00001408 72D4                    	jc	short lff32s2_7 ; error !
  2526                                  
  2527 0000140A BF[00300000]            	mov	edi, audio_buffer
  2528                                  	
  2529 0000140F C1E802                  	shr	eax, 2
  2530 00001412 7505                    	jnz	short lff32s2_8
  2531 00001414 E988F6FFFF              	jmp	lff32_eof
  2532                                  
  2533                                  lff32s2_8:
  2534 00001419 89C1                    	mov	ecx, eax ; dword count
  2535                                  lff32s2_1:
  2536 0000141B 66AD                    	lodsw
  2537 0000141D 66AB                    	stosw		; original sample (L)
  2538 0000141F 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2539 00001422 66A3[18200000]          	mov	[previous_val_l], ax
  2540 00001428 66AD                    	lodsw
  2541 0000142A 66AB                    	stosw		; original sample (R)
  2542 0000142C 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2543                                  	;mov	[previous_val_r], ax
  2544 0000142F 89C3                    	mov	ebx, eax
  2545 00001431 31D2                    	xor	edx, edx
  2546 00001433 31C0                    	xor	eax, eax
  2547                                  	; 16/11/2023
  2548 00001435 49                      	dec	ecx
  2549 00001436 7407                    	jz	short lff32s2_2
  2550 00001438 668B06                  	mov	ax, [esi]
  2551 0000143B 668B5602                	mov	dx, [esi+2]
  2552                                  lff32s2_2:
  2553 0000143F 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2554                                  	;;mov	[next_val_l], ax
  2555                                  	;mov	ebp, eax
  2556 00001442 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2557                                  	;mov	[next_val_r], dx
  2558 00001445 660305[18200000]        	add	ax, [previous_val_l]
  2559 0000144C 66D1D8                  	rcr	ax, 1
  2560 0000144F 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2561 00001452 66AB                    	stosw		; this is interpolated sample (L)
  2562                                  	;mov	ax, [next_val_r]
  2563 00001454 89D0                    	mov	eax, edx
  2564                                  	;add	ax, [previous_val_r]
  2565 00001456 6601D8                  	add	ax, bx
  2566 00001459 66D1D8                  	rcr	ax, 1
  2567 0000145C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2568 0000145F 66AB                    	stosw		; this is interpolated sample (R)
  2569                                  
  2570                                  	; different than 8-16-24 kHZ !
  2571                                  	; 'original-interpolated-original' trio samples 
  2572 00001461 E30B                    	jecxz	lff32s2_3
  2573                                  
  2574 00001463 66AD                    	lodsw
  2575 00001465 66AB                    	stosw	; original sample (L)
  2576 00001467 66AD                    	lodsw
  2577 00001469 66AB                    	stosw	; original sample (R)
  2578                                  	
  2579                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2580 0000146B 49                      	dec	ecx
  2581 0000146C 75AD                    	jnz	short lff32s2_1
  2582                                  lff32s2_3:
  2583 0000146E E916F6FFFF              	jmp	lff32_3
  2584                                  
  2585                                  ; .....................
  2586                                  
  2587                                  load_22khz_mono_8_bit:
  2588                                  	; 16/11/2023
  2589 00001473 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2590                                  					; last of the file?
  2591 0000147A 7402                    	jz	short lff22m_0		; no
  2592 0000147C F9                      	stc
  2593 0000147D C3                      	retn
  2594                                  
  2595                                  lff22m_0:
  2596 0000147E BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2597                                          ;mov	edx, [loadsize]
  2598                                  
  2599                                  	; esi = buffer address
  2600                                  	;; edx = buffer size
  2601                                  
  2602                                  	; load file into memory
  2603                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001483 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001489 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000148B 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001491 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001496 CD40                <1>  int 40h
  2604 00001498 725D                    	jc	short lff22m_7 ; error !
  2605                                  
  2606 0000149A BF[00300000]            	mov	edi, audio_buffer
  2607                                  	
  2608 0000149F 21C0                    	and	eax, eax
  2609 000014A1 7505                    	jnz	short lff22m_8
  2610 000014A3 E9F9F5FFFF              	jmp	lff22_eof
  2611                                  
  2612                                  lff22m_8:
  2613 000014A8 89C1                    	mov	ecx, eax	; byte count
  2614                                  lff22m_9:
  2615 000014AA BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2616 000014AF C605[20200000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2617                                  lff22m_1:
  2618                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2619 000014B6 AC                      	lodsb
  2620 000014B7 B280                    	mov	dl, 80h
  2621 000014B9 49                      	dec	ecx
  2622 000014BA 7402                    	jz	short lff22m_2_1
  2623 000014BC 8A16                    	mov	dl, [esi]
  2624                                  lff22m_2_1:	
  2625                                  	; al = [previous_val]
  2626                                  	; dl = [next_val]
  2627 000014BE E80F060000              	call	interpolating_3_8bit_mono ; 1 of 17
  2628 000014C3 E32D                    	jecxz	lff22m_3
  2629                                  lff22m_2_2:
  2630 000014C5 AC                      	lodsb
  2631 000014C6 B280                    	mov	dl, 80h
  2632 000014C8 49                      	dec	ecx
  2633 000014C9 7402                    	jz	short lff22m_2_3
  2634 000014CB 8A16                    	mov	dl, [esi]
  2635                                  lff22m_2_3:
  2636 000014CD E884060000               	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2637 000014D2 E31E                    	jecxz	lff22m_3
  2638 000014D4 4D                      	dec	ebp
  2639 000014D5 75EE                    	jnz	short lff22m_2_2
  2640                                  
  2641 000014D7 A0[20200000]            	mov	al, [faz]
  2642 000014DC FEC8                    	dec	al
  2643 000014DE 74CA                    	jz	short lff22m_9
  2644 000014E0 FE0D[20200000]          	dec	byte [faz]
  2645 000014E6 BD04000000              	mov	ebp, 4
  2646 000014EB FEC8                    	dec	al
  2647 000014ED 75C7                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2648 000014EF 45                      	inc	ebp ; 5
  2649 000014F0 EBC4                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2650                                  
  2651                                  lff22m_3:
  2652                                  lff22s_3:
  2653 000014F2 E992F5FFFF              	jmp	lff22_3	; padfill
  2654                                  		; (put zeros in the remain words of the buffer)
  2655                                  lff22m_7:
  2656                                  lff22s_7:
  2657 000014F7 E9AEF5FFFF              	jmp	lff22_5  ; error
  2658                                  
  2659                                  load_22khz_stereo_8_bit:
  2660                                  	; 16/11/2023
  2661 000014FC F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2662                                  					; last of the file?
  2663 00001503 7402                    	jz	short lff22s_0		; no
  2664 00001505 F9                      	stc
  2665 00001506 C3                      	retn
  2666                                  
  2667                                  lff22s_0:
  2668 00001507 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2669                                          ;mov	edx, [loadsize]
  2670                                  
  2671                                  	; esi = buffer address
  2672                                  	;; edx = buffer size
  2673                                  
  2674                                  	; load file into memory
  2675                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000150C 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001512 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001514 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000151A B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000151F CD40                <1>  int 40h
  2676 00001521 72D4                    	jc	short lff22s_7 ; error !
  2677                                  
  2678 00001523 BF[00300000]            	mov	edi, audio_buffer
  2679                                  	
  2680 00001528 D1E8                    	shr	eax, 1
  2681 0000152A 7505                    	jnz	short lff22s_8
  2682 0000152C E970F5FFFF              	jmp	lff22_eof
  2683                                  
  2684                                  lff22s_8:
  2685 00001531 89C1                    	mov	ecx, eax	; word count
  2686                                  lff22s_9:
  2687 00001533 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2688 00001538 C605[20200000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2689                                  lff22s_1:
  2690                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2691 0000153F 66AD                    	lodsw
  2692 00001541 66BA8080                	mov	dx, 8080h
  2693 00001545 49                      	dec	ecx
  2694 00001546 7403                    	jz	short lff22s_2_1 
  2695 00001548 668B16                  	mov	dx, [esi]
  2696                                  lff22s_2_1:	
  2697                                  	; al = [previous_val_l]
  2698                                  	; ah = [previous_val_r]
  2699                                  	; dl = [next_val_l]
  2700                                  	; dh = [next_val_r]	
  2701 0000154B E8B3050000              	call	interpolating_3_8bit_stereo ; 1 of 17 
  2702 00001550 E3A0                    	jecxz	lff22s_3
  2703                                  lff22s_2_2:
  2704 00001552 66AD                    	lodsw
  2705 00001554 66BA8080                	mov	dx, 8080h
  2706 00001558 49                      	dec	ecx
  2707 00001559 7403                    	jz	short lff22s_2_3
  2708 0000155B 668B16                  	mov	dx, [esi]
  2709                                  lff22s_2_3:
  2710 0000155E E810060000               	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2711 00001563 E38D                    	jecxz	lff22s_3
  2712 00001565 4D                      	dec	ebp
  2713 00001566 75EA                    	jnz	short lff22s_2_2
  2714                                  
  2715 00001568 A0[20200000]            	mov	al, [faz]
  2716 0000156D FEC8                    	dec	al
  2717 0000156F 74C2                    	jz	short lff22s_9
  2718 00001571 FE0D[20200000]          	dec	byte [faz]
  2719 00001577 BD04000000              	mov	ebp, 4
  2720 0000157C FEC8                    	dec	al
  2721 0000157E 75BF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2722 00001580 45                      	inc	ebp ; 5
  2723 00001581 EBBC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2724                                  
  2725                                  load_22khz_mono_16_bit:
  2726                                  	; 16/11/2023
  2727 00001583 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2728                                  					; last of the file?
  2729 0000158A 7402                    	jz	short lff22m2_0		; no
  2730 0000158C F9                      	stc
  2731 0000158D C3                      	retn
  2732                                  
  2733                                  lff22m2_0:
  2734 0000158E BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2735                                          ;mov	edx, [loadsize]
  2736                                  
  2737                                  	; esi = buffer address
  2738                                  	;; edx = buffer size
  2739                                  
  2740                                  	; load file into memory
  2741                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001593 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001599 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 0000159B 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000015A1 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000015A6 CD40                <1>  int 40h
  2742 000015A8 7261                    	jc	short lff22m2_7 ; error !
  2743                                  
  2744 000015AA BF[00300000]            	mov	edi, audio_buffer
  2745                                  	
  2746 000015AF D1E8                    	shr	eax, 1
  2747 000015B1 7505                    	jnz	short lff22m2_8
  2748 000015B3 E9E9F4FFFF              	jmp	lff22_eof
  2749                                  
  2750                                  lff22m2_8:
  2751 000015B8 89C1                    	mov	ecx, eax	; word count
  2752                                  lff22m2_9:
  2753 000015BA BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2754 000015BF C605[20200000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2755                                  lff22m2_1:
  2756                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2757 000015C6 66AD                    	lodsw
  2758 000015C8 31D2                    	xor	edx, edx
  2759 000015CA 49                      	dec	ecx
  2760 000015CB 7403                    	jz	short lff22m2_2_1
  2761 000015CD 668B16                  	mov	dx, [esi]
  2762                                  lff22m2_2_1:	
  2763                                  	; ax = [previous_val]
  2764                                  	; dx = [next_val]
  2765 000015D0 E8CF050000              	call	interpolating_3_16bit_mono ; 1 of 17
  2766 000015D5 E32F                    	jecxz	lff22m2_3
  2767                                  lff22m2_2_2:
  2768 000015D7 66AD                    	lodsw
  2769 000015D9 31D2                    	xor	edx, edx
  2770 000015DB 49                      	dec	ecx
  2771 000015DC 7403                    	jz	short lff22m2_2_3
  2772 000015DE 668B16                  	mov	dx, [esi]
  2773                                  lff22m2_2_3:
  2774 000015E1 E851060000               	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2775 000015E6 E31E                    	jecxz	lff22m2_3
  2776 000015E8 4D                      	dec	ebp
  2777 000015E9 75EC                    	jnz	short lff22m2_2_2
  2778                                  
  2779 000015EB A0[20200000]            	mov	al, [faz]
  2780 000015F0 FEC8                    	dec	al
  2781 000015F2 74C6                    	jz	short lff22m2_9
  2782 000015F4 FE0D[20200000]          	dec	byte [faz]
  2783 000015FA BD04000000              	mov	ebp, 4
  2784 000015FF FEC8                    	dec	al
  2785 00001601 75C3                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2786 00001603 45                      	inc	ebp ; 5
  2787 00001604 EBC0                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2788                                  
  2789                                  lff22m2_3:
  2790                                  lff22s2_3:
  2791 00001606 E97EF4FFFF              	jmp	lff22_3	; padfill
  2792                                  		; (put zeros in the remain words of the buffer)
  2793                                  lff22m2_7:
  2794                                  lff22s2_7:
  2795 0000160B E99AF4FFFF              	jmp	lff22_5  ; error
  2796                                  
  2797                                  load_22khz_stereo_16_bit:
  2798                                  	; 16/11/2023
  2799 00001610 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2800                                  					; last of the file?
  2801 00001617 7402                    	jz	short lff22s2_0		; no
  2802 00001619 F9                      	stc
  2803 0000161A C3                      	retn
  2804                                  
  2805                                  lff22s2_0:
  2806 0000161B BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2807                                          ;mov	edx, [loadsize]
  2808                                  
  2809                                  	; esi = buffer address
  2810                                  	;; edx = buffer size
  2811                                  
  2812                                  	; load file into memory
  2813                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001620 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001626 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001628 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000162E B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001633 CD40                <1>  int 40h
  2814 00001635 72D4                    	jc	short lff22s2_7 ; error !
  2815                                  
  2816 00001637 BF[00300000]            	mov	edi, audio_buffer
  2817                                  	
  2818 0000163C C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  2819 0000163F 7505                    	jnz	short lff22s2_8
  2820 00001641 E95BF4FFFF              	jmp	lff22_eof
  2821                                  
  2822                                  lff22s2_8:
  2823 00001646 89C1                    	mov	ecx, eax	; dword count
  2824                                  lff22s2_9:
  2825 00001648 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2826 0000164D C605[20200000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2827                                  lff22s2_1:
  2828                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2829 00001654 66AD                    	lodsw
  2830 00001656 89C3                    	mov	ebx, eax
  2831 00001658 66AD                    	lodsw
  2832 0000165A 8B16                    	mov	edx, [esi]
  2833 0000165C 668915[1C200000]        	mov	[next_val_l], dx
  2834                                  	; 26/11/2023
  2835 00001663 C1EA10                  	shr	edx, 16
  2836 00001666 49                      	dec	ecx
  2837 00001667 7509                    	jnz	short lff22s2_2_1
  2838 00001669 31D2                    	xor	edx, edx ; 0
  2839 0000166B 668915[1C200000]        	mov	[next_val_l], dx
  2840                                  lff22s2_2_1:
  2841                                  	; bx = [previous_val_l]
  2842                                  	; ax = [previous_val_r]
  2843                                  	; [next_val_l]
  2844                                  	; dx = [next_val_r]
  2845 00001672 E85D050000              	call	interpolating_3_16bit_stereo ; 1 of 17 
  2846 00001677 E38D                    	jecxz	lff22s2_3
  2847                                  lff22s2_2_2:
  2848 00001679 66AD                    	lodsw
  2849 0000167B 89C3                    	mov	ebx, eax
  2850 0000167D 66AD                    	lodsw
  2851 0000167F 8B16                    	mov	edx, [esi]
  2852 00001681 668915[1C200000]        	mov	[next_val_l], dx
  2853                                  	; 26/11/2023
  2854 00001688 C1EA10                  	shr	edx, 16
  2855 0000168B 49                      	dec	ecx
  2856 0000168C 7509                    	jnz	short lff22s2_2_3
  2857 0000168E 31D2                    	xor	edx, edx ; 0
  2858 00001690 668915[1C200000]        	mov	[next_val_l], dx
  2859                                  lff22s2_2_3:
  2860 00001697 E8B3050000               	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  2861 0000169C E31E                    	jecxz	lff22s2_2_4
  2862                                  
  2863 0000169E 4D                      	dec	ebp
  2864 0000169F 75D8                    	jnz	short lff22s2_2_2
  2865                                  
  2866 000016A1 A0[20200000]            	mov	al, [faz]
  2867 000016A6 FEC8                    	dec	al
  2868 000016A8 749E                    	jz	short lff22s2_9
  2869 000016AA FE0D[20200000]          	dec	byte [faz]
  2870 000016B0 BD04000000              	mov	ebp, 4
  2871 000016B5 FEC8                    	dec	al
  2872 000016B7 759B                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2873 000016B9 45                      	inc	ebp ; 5
  2874 000016BA EB98                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2875                                  
  2876                                  lff22s2_2_4:
  2877                                  	; 26/11/2023
  2878 000016BC E9C8F3FFFF              	jmp	lff22_3	; padfill
  2879                                  
  2880                                  ; .....................
  2881                                  
  2882                                  load_11khz_mono_8_bit:
  2883                                  	; 18/11/2023
  2884 000016C1 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2885                                  					; last of the file?
  2886 000016C8 7402                    	jz	short lff11m_0		; no
  2887 000016CA F9                      	stc
  2888 000016CB C3                      	retn
  2889                                  
  2890                                  lff11m_0:
  2891 000016CC BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2892                                          ;mov	edx, [loadsize]
  2893                                  
  2894                                  	; esi = buffer address
  2895                                  	;; edx = buffer size
  2896                                  
  2897                                  	; load file into memory
  2898                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000016D1 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000016D7 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000016D9 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000016DF B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000016E4 CD40                <1>  int 40h
  2899 000016E6 7247                    	jc	short lff11m_7 ; error !
  2900                                  
  2901 000016E8 BF[00300000]            	mov	edi, audio_buffer
  2902                                  	
  2903 000016ED 21C0                    	and	eax, eax
  2904 000016EF 7505                    	jnz	short lff11m_8
  2905 000016F1 E9ABF3FFFF              	jmp	lff11_eof
  2906                                  
  2907                                  lff11m_8:
  2908 000016F6 89C1                    	mov	ecx, eax		; byte count
  2909                                  lff11m_9:
  2910 000016F8 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  2911                                  lff11m_1:
  2912                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2913 000016FD AC                      	lodsb
  2914 000016FE B280                    	mov	dl, 80h
  2915 00001700 49                      	dec	ecx
  2916 00001701 7402                    	jz	short lff11m_2_1
  2917 00001703 8A16                    	mov	dl, [esi]
  2918                                  lff11m_2_1:	
  2919                                  	; al = [previous_val]
  2920                                  	; dl = [next_val]
  2921 00001705 E876050000              	call	interpolating_5_8bit_mono
  2922 0000170A E328                    	jecxz	lff11m_3
  2923                                  lff11m_2_2:
  2924 0000170C AC                      	lodsb
  2925 0000170D B280                    	mov	dl, 80h
  2926 0000170F 49                      	dec	ecx
  2927 00001710 7402                    	jz	short lff11m_2_3
  2928 00001712 8A16                    	mov	dl, [esi]
  2929                                  lff11m_2_3:
  2930 00001714 E873060000               	call	interpolating_4_8bit_mono
  2931 00001719 E319                    	jecxz	lff11m_3
  2932                                  
  2933 0000171B 4D                      	dec	ebp
  2934 0000171C 74DA                    	jz	short lff11m_9
  2935                                  
  2936 0000171E AC                      	lodsb
  2937 0000171F B280                    	mov	dl, 80h
  2938 00001721 49                      	dec	ecx
  2939 00001722 7402                    	jz	short lff11m_2_4
  2940 00001724 8A16                    	mov	dl, [esi]
  2941                                  lff11m_2_4:
  2942 00001726 E861060000              	call	interpolating_4_8bit_mono
  2943 0000172B E307                    	jecxz	lff11m_3
  2944 0000172D EBCE                    	jmp	short lff11m_1
  2945                                  
  2946                                  lff11m_7:
  2947                                  lff11s_7:
  2948 0000172F E976F3FFFF              	jmp	lff11_5  ; error
  2949                                  
  2950                                  lff11m_3:
  2951                                  lff11s_3:
  2952 00001734 E950F3FFFF              	jmp	lff11_3	; padfill
  2953                                  		; (put zeros in the remain words of the buffer)
  2954                                  
  2955                                  load_11khz_stereo_8_bit:
  2956                                  	; 18/11/2023
  2957 00001739 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2958                                  					; last of the file?
  2959 00001740 7402                    	jz	short lff11s_0		; no
  2960 00001742 F9                      	stc
  2961 00001743 C3                      	retn
  2962                                  
  2963                                  lff11s_0:
  2964 00001744 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2965                                          ;mov	edx, [loadsize]
  2966                                  
  2967                                  	; esi = buffer address
  2968                                  	;; edx = buffer size
  2969                                  
  2970                                  	; load file into memory
  2971                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001749 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 0000174F 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001751 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001757 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000175C CD40                <1>  int 40h
  2972 0000175E 72CF                    	jc	short lff11s_7 ; error !
  2973                                  
  2974 00001760 BF[00300000]            	mov	edi, audio_buffer
  2975                                  	
  2976 00001765 D1E8                    	shr	eax, 1
  2977 00001767 7505                    	jnz	short lff11s_8
  2978 00001769 E933F3FFFF              	jmp	lff11_eof
  2979                                  
  2980                                  lff11s_8:
  2981 0000176E 89C1                    	mov	ecx, eax	; word count
  2982                                  lff11s_9:
  2983 00001770 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  2984                                  lff11s_1:
  2985                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2986 00001775 66AD                    	lodsw
  2987 00001777 66BA8080                	mov	dx, 8080h
  2988 0000177B 49                      	dec	ecx
  2989 0000177C 7403                    	jz	short lff11s_2_1 
  2990 0000177E 668B16                  	mov	dx, [esi]
  2991                                  lff11s_2_1:	
  2992                                  	; al = [previous_val_l]
  2993                                  	; ah = [previous_val_r]
  2994                                  	; dl = [next_val_l]
  2995                                  	; dh = [next_val_r]	
  2996 00001781 E859050000              	call	interpolating_5_8bit_stereo
  2997 00001786 E3AC                    	jecxz	lff11s_3
  2998                                  lff11s_2_2:
  2999 00001788 66AD                    	lodsw
  3000 0000178A 66BA8080                	mov	dx, 8080h
  3001 0000178E 49                      	dec	ecx
  3002 0000178F 7403                    	jz	short lff11s_2_3
  3003 00001791 668B16                  	mov	dx, [esi]
  3004                                  lff11s_2_3:
  3005 00001794 E832060000               	call	interpolating_4_8bit_stereo
  3006 00001799 E399                    	jecxz	lff11s_3
  3007                                  	
  3008 0000179B 4D                      	dec	ebp
  3009 0000179C 74D2                    	jz	short lff11s_9
  3010                                  
  3011 0000179E 66AD                    	lodsw
  3012 000017A0 66BA8080                	mov	dx, 8080h
  3013 000017A4 49                      	dec	ecx
  3014 000017A5 7403                    	jz	short lff11s_2_4
  3015 000017A7 668B16                  	mov	dx, [esi]
  3016                                  lff11s_2_4:
  3017 000017AA E81C060000              	call	interpolating_4_8bit_stereo
  3018 000017AF E383                    	jecxz	lff11s_3
  3019 000017B1 EBC2                    	jmp	short lff11s_1
  3020                                  
  3021                                  load_11khz_mono_16_bit:
  3022                                  	; 18/11/2023
  3023 000017B3 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3024                                  					; last of the file?
  3025 000017BA 7402                    	jz	short lff11m2_0		; no
  3026 000017BC F9                      	stc
  3027 000017BD C3                      	retn
  3028                                  
  3029                                  lff11m2_0:
  3030 000017BE BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3031                                          ;mov	edx, [loadsize]
  3032                                  
  3033                                  	; esi = buffer address
  3034                                  	;; edx = buffer size
  3035                                  
  3036                                  	; load file into memory
  3037                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000017C3 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000017C9 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000017CB 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000017D1 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000017D6 CD40                <1>  int 40h
  3038 000017D8 724D                    	jc	short lff11m2_7 ; error !
  3039                                  
  3040 000017DA BF[00300000]            	mov	edi, audio_buffer
  3041                                  	
  3042 000017DF D1E8                    	shr	eax, 1
  3043 000017E1 7505                    	jnz	short lff11m2_8
  3044 000017E3 E9B9F2FFFF              	jmp	lff11_eof
  3045                                  
  3046                                  lff11m2_8:
  3047 000017E8 89C1                    	mov	ecx, eax	; word count
  3048                                  lff11m2_9:
  3049 000017EA BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3050                                  lff11m2_1:
  3051                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3052 000017EF 66AD                    	lodsw
  3053 000017F1 31D2                    	xor	edx, edx
  3054 000017F3 49                      	dec	ecx
  3055 000017F4 7403                    	jz	short lff11m2_2_1
  3056 000017F6 668B16                  	mov	dx, [esi]
  3057                                  lff11m2_2_1:	
  3058                                  	; ax = [previous_val]
  3059                                  	; dx = [next_val]
  3060 000017F9 E83A060000              	call	interpolating_5_16bit_mono
  3061 000017FE E362                    	jecxz	lff11m2_3
  3062                                  lff11m2_2_2:
  3063 00001800 66AD                    	lodsw
  3064 00001802 31D2                    	xor	edx, edx
  3065 00001804 49                      	dec	ecx
  3066 00001805 7403                    	jz	short lff11m2_2_3
  3067 00001807 668B16                  	mov	dx, [esi]
  3068                                  lff11m2_2_3:
  3069 0000180A E853070000               	call	interpolating_4_16bit_mono
  3070 0000180F E351                    	jecxz	lff11m2_3
  3071                                  
  3072 00001811 4D                      	dec	ebp
  3073 00001812 74D6                    	jz	short lff11m2_9
  3074                                  
  3075 00001814 66AD                    	lodsw
  3076 00001816 31D2                    	xor	edx, edx
  3077 00001818 49                      	dec	ecx
  3078 00001819 7403                    	jz	short lff11m2_2_4
  3079 0000181B 668B16                  	mov	dx, [esi]
  3080                                  lff11m2_2_4:
  3081 0000181E E83F070000               	call	interpolating_4_16bit_mono
  3082 00001823 E33D                    	jecxz	lff11m2_3
  3083 00001825 EBC8                    	jmp	short lff11m2_1
  3084                                  
  3085                                  lff11m2_7:
  3086                                  lff11s2_7:
  3087 00001827 E97EF2FFFF              	jmp	lff11_5  ; error
  3088                                  
  3089                                  load_11khz_stereo_16_bit:
  3090                                  	; 18/11/2023
  3091 0000182C F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3092                                  					; last of the file?
  3093 00001833 7402                    	jz	short lff11s2_0		; no
  3094 00001835 F9                      	stc
  3095 00001836 C3                      	retn
  3096                                  
  3097                                  lff11s2_0:
  3098 00001837 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3099                                          ;mov	edx, [loadsize]
  3100                                  
  3101                                  	; esi = buffer address
  3102                                  	;; edx = buffer size
  3103                                  
  3104                                  	; load file into memory
  3105                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000183C 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001842 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001844 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000184A B803000000          <1>  mov eax, %1
    90                              <1> 
    91 0000184F CD40                <1>  int 40h
  3106 00001851 72D4                    	jc	short lff11s2_7 ; error !
  3107                                  
  3108 00001853 BF[00300000]            	mov	edi, audio_buffer
  3109                                  	
  3110 00001858 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3111 0000185B 750A                    	jnz	short lff11s2_8
  3112 0000185D E93FF2FFFF              	jmp	lff11_eof
  3113                                  
  3114                                  lff11m2_3:
  3115                                  lff11s2_3:
  3116 00001862 E922F2FFFF              	jmp	lff11_3	; padfill
  3117                                  		; (put zeros in the remain words of the buffer)
  3118                                  
  3119                                  lff11s2_8:
  3120 00001867 89C1                    	mov	ecx, eax	; dword count
  3121                                  lff11s2_9:
  3122 00001869 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3123                                  lff11s2_1:
  3124                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3125 0000186E 66AD                    	lodsw
  3126 00001870 89C3                    	mov	ebx, eax
  3127 00001872 66AD                    	lodsw
  3128 00001874 8B16                    	mov	edx, [esi]
  3129 00001876 8915[1C200000]          	mov	[next_val_l], edx
  3130                                  	; 26/11/2023
  3131 0000187C C1EA10                  	shr	edx, 16
  3132                                  	;mov	[next_val_r], dx
  3133 0000187F 49                      	dec	ecx
  3134 00001880 7509                    	jnz	short lff11s2_2_1
  3135 00001882 31D2                    	xor	edx, edx ; 0
  3136 00001884 668915[1C200000]        	mov	[next_val_l], dx
  3137                                  	;mov	[next_val_r], dx
  3138                                  lff11s2_2_1:
  3139                                  	; bx = [previous_val_l]
  3140                                  	; ax = [previous_val_r]
  3141                                  	; [next_val_l]
  3142                                  	; dx = [next_val_r]
  3143 0000188B E803060000              	call	interpolating_5_16bit_stereo
  3144 00001890 E3D0                    	jecxz	lff11s2_3
  3145                                  lff11s2_2_2:
  3146 00001892 66AD                    	lodsw
  3147 00001894 89C3                    	mov	ebx, eax
  3148 00001896 66AD                    	lodsw
  3149 00001898 8B16                    	mov	edx, [esi]
  3150 0000189A 668915[1C200000]        	mov	[next_val_l], dx
  3151                                  	; 26/11/2023
  3152 000018A1 C1EA10                  	shr	edx, 16
  3153                                  	;mov	[next_val_r], dx
  3154 000018A4 49                      	dec	ecx
  3155 000018A5 7509                    	jnz	short lff11s2_2_3
  3156 000018A7 31D2                    	xor	edx, edx ; 0
  3157 000018A9 668915[1C200000]        	mov	[next_val_l], dx
  3158                                  	;mov	[next_val_r], dx
  3159                                  lff11s2_2_3:
  3160 000018B0 E8E6060000               	call	interpolating_4_16bit_stereo
  3161 000018B5 E3AB                    	jecxz	lff11s2_3
  3162                                  	
  3163 000018B7 4D                      	dec	ebp
  3164 000018B8 74AF                    	jz	short lff11s2_9
  3165                                  
  3166 000018BA 66AD                    	lodsw
  3167 000018BC 89C3                    	mov	ebx, eax
  3168 000018BE 66AD                    	lodsw
  3169 000018C0 8B16                    	mov	edx, [esi]
  3170 000018C2 668915[1C200000]        	mov	[next_val_l], dx
  3171                                  	; 26/11/2023
  3172 000018C9 C1EA10                  	shr	edx, 16
  3173                                  	;mov	[next_val_r], dx
  3174 000018CC 49                      	dec	ecx
  3175 000018CD 7509                    	jnz	short lff11s2_2_4
  3176 000018CF 31D2                    	xor	edx, edx ; 0
  3177 000018D1 668915[1C200000]        	mov	[next_val_l], dx
  3178                                  	;mov	[next_val_r], dx
  3179                                  lff11s2_2_4:
  3180 000018D8 E8BE060000               	call	interpolating_4_16bit_stereo
  3181 000018DD E383                    	jecxz	lff11s2_3
  3182 000018DF EB8D                    	jmp	short lff11s2_1
  3183                                  
  3184                                  ; .....................
  3185                                  
  3186                                  load_44khz_mono_8_bit:
  3187                                  	; 18/11/2023
  3188 000018E1 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3189                                  					; last of the file?
  3190 000018E8 7402                    	jz	short lff44m_0		; no
  3191 000018EA F9                      	stc
  3192 000018EB C3                      	retn
  3193                                  
  3194                                  lff44m_0:
  3195 000018EC BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3196                                          ;mov	edx, [loadsize]
  3197                                  
  3198                                  	; esi = buffer address
  3199                                  	;; edx = buffer size
  3200                                  
  3201                                  	; load file into memory
  3202                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000018F1 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000018F7 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000018F9 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000018FF B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001904 CD40                <1>  int 40h
  3203 00001906 7250                    	jc	short lff44m_7 ; error !
  3204                                  
  3205 00001908 BF[00300000]            	mov	edi, audio_buffer
  3206                                  	
  3207 0000190D 21C0                    	and	eax, eax
  3208 0000190F 7505                    	jnz	short lff44m_8
  3209 00001911 E98BF1FFFF              	jmp	lff44_eof
  3210                                  
  3211                                  lff44m_8:
  3212 00001916 89C1                    	mov	ecx, eax	; byte count
  3213                                  lff44m_9:
  3214 00001918 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3215 0000191D C605[20200000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3216                                  lff44m_1:
  3217                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3218                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3219 00001924 AC                      	lodsb
  3220 00001925 B280                    	mov	dl, 80h
  3221 00001927 49                      	dec	ecx
  3222 00001928 7402                    	jz	short lff44m_2_1
  3223 0000192A 8A16                    	mov	dl, [esi]
  3224                                  lff44m_2_1:	
  3225                                  	; al = [previous_val]
  3226                                  	; dl = [next_val]
  3227 0000192C E825020000              	call	interpolating_2_8bit_mono
  3228 00001931 E320                    	jecxz	lff44m_3
  3229                                  lff44m_2_2:
  3230 00001933 AC                      	lodsb
  3231 00001934 2C80                    	sub	al, 80h
  3232 00001936 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3233 0000193A 66AB                    	stosw		; (L)
  3234 0000193C 66AB                    	stosw		; (R)	
  3235                                  
  3236 0000193E 49                      	dec	ecx
  3237 0000193F 7412                    	jz	short lff44m_3	
  3238 00001941 4D                      	dec	ebp
  3239 00001942 75EF                    	jnz	short lff44m_2_2
  3240                                  	
  3241 00001944 FE0D[20200000]          	dec	byte [faz]
  3242 0000194A 74CC                    	jz	short lff44m_9 
  3243 0000194C BD0B000000              	mov	ebp, 11
  3244 00001951 EBD1                    	jmp	short lff44m_1
  3245                                  
  3246                                  lff44m_3:
  3247                                  lff44s_3:
  3248 00001953 E931F1FFFF              	jmp	lff44_3	; padfill
  3249                                  		; (put zeros in the remain words of the buffer)
  3250                                  lff44m_7:
  3251                                  lff44s_7:
  3252 00001958 E94DF1FFFF              	jmp	lff44_5  ; error
  3253                                  
  3254                                  load_44khz_stereo_8_bit:
  3255                                  	; 16/11/2023
  3256 0000195D F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3257                                  					; last of the file?
  3258 00001964 7402                    	jz	short lff44s_0		; no
  3259 00001966 F9                      	stc
  3260 00001967 C3                      	retn
  3261                                  
  3262                                  lff44s_0:
  3263 00001968 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3264                                          ;mov	edx, [loadsize]
  3265                                  
  3266                                  	; esi = buffer address
  3267                                  	;; edx = buffer size
  3268                                  
  3269                                  	; load file into memory
  3270                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 0000196D 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001973 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001975 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 0000197B B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001980 CD40                <1>  int 40h
  3271 00001982 72D4                    	jc	short lff44s_7 ; error !
  3272                                  
  3273 00001984 BF[00300000]            	mov	edi, audio_buffer
  3274                                  	
  3275 00001989 D1E8                    	shr	eax, 1
  3276 0000198B 7505                    	jnz	short lff44s_8
  3277 0000198D E90FF1FFFF              	jmp	lff44_eof
  3278                                  
  3279                                  lff44s_8:
  3280 00001992 89C1                    	mov	ecx, eax	; word count
  3281                                  lff44s_9:
  3282 00001994 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3283 00001999 C605[20200000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3284                                  lff44s_1:
  3285                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3286                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3287 000019A0 66AD                    	lodsw
  3288 000019A2 66BA8080                	mov	dx, 8080h
  3289 000019A6 49                      	dec	ecx
  3290 000019A7 7403                    	jz	short lff44s_2_1 
  3291 000019A9 668B16                  	mov	dx, [esi]
  3292                                  lff44s_2_1:	
  3293                                  	; al = [previous_val_l]
  3294                                  	; ah = [previous_val_r]
  3295                                  	; dl = [next_val_l]
  3296                                  	; dh = [next_val_r]	
  3297 000019AC E8C2010000              	call	interpolating_2_8bit_stereo
  3298 000019B1 E3A0                    	jecxz	lff44s_3
  3299                                  lff44s_2_2:
  3300 000019B3 AC                      	lodsb
  3301 000019B4 2C80                    	sub	al, 80h
  3302 000019B6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3303 000019BA 66AB                    	stosw		; (L)
  3304 000019BC AC                      	lodsb
  3305 000019BD 2C80                    	sub	al, 80h
  3306 000019BF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3307 000019C3 66AB                    	stosw		; (R)
  3308                                  
  3309 000019C5 49                      	dec	ecx
  3310 000019C6 748B                    	jz	short lff44s_3	
  3311 000019C8 4D                      	dec	ebp
  3312 000019C9 75E8                    	jnz	short lff44s_2_2
  3313                                  	
  3314 000019CB FE0D[20200000]          	dec	byte [faz]
  3315 000019D1 74C1                    	jz	short lff44s_9 
  3316 000019D3 BD0B000000              	mov	ebp, 11
  3317 000019D8 EBC6                    	jmp	short lff44s_1
  3318                                  
  3319                                  load_44khz_mono_16_bit:
  3320                                  	; 18/11/2023
  3321 000019DA F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3322                                  					; last of the file?
  3323 000019E1 7402                    	jz	short lff44m2_0		; no
  3324 000019E3 F9                      	stc
  3325 000019E4 C3                      	retn
  3326                                  
  3327                                  lff44m2_0:
  3328 000019E5 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3329                                          ;mov	edx, [loadsize]
  3330                                  
  3331                                  	; esi = buffer address
  3332                                  	;; edx = buffer size
  3333                                  
  3334                                  	; load file into memory
  3335                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 000019EA 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 000019F0 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 000019F2 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 000019F8 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 000019FD CD40                <1>  int 40h
  3336 000019FF 724D                    	jc	short lff44m2_7 ; error !
  3337                                  
  3338 00001A01 BF[00300000]            	mov	edi, audio_buffer
  3339                                  	
  3340 00001A06 D1E8                    	shr	eax, 1
  3341 00001A08 7505                    	jnz	short lff44m2_8
  3342 00001A0A E992F0FFFF              	jmp	lff44_eof
  3343                                  
  3344                                  lff44m2_8:
  3345 00001A0F 89C1                    	mov	ecx, eax	; word count
  3346                                  lff44m2_9:
  3347 00001A11 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3348 00001A16 C605[20200000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3349                                  lff44m2_1:
  3350                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3351                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3352 00001A1D 66AD                    	lodsw
  3353 00001A1F 31D2                    	xor	edx, edx
  3354 00001A21 49                      	dec	ecx
  3355 00001A22 7403                    	jz	short lff44m2_2_1
  3356 00001A24 668B16                  	mov	dx, [esi]
  3357                                  lff44m2_2_1:	
  3358                                  	; ax = [previous_val]
  3359                                  	; dx = [next_val]
  3360 00001A27 E80B020000              	call	interpolating_2_16bit_mono
  3361 00001A2C E31B                    	jecxz	lff44m2_3
  3362                                  lff44m2_2_2:
  3363 00001A2E 66AD                    	lodsw
  3364 00001A30 66AB                    	stosw		; (L)eft Channel
  3365 00001A32 66AB                    	stosw		; (R)ight Channel
  3366                                  
  3367 00001A34 49                      	dec	ecx
  3368 00001A35 7412                    	jz	short lff44m2_3	
  3369 00001A37 4D                      	dec	ebp
  3370 00001A38 75F4                    	jnz	short lff44m2_2_2
  3371                                  	
  3372 00001A3A FE0D[20200000]          	dec	byte [faz]
  3373 00001A40 74CF                    	jz	short lff44m2_9 
  3374 00001A42 BD0B000000              	mov	ebp, 11
  3375 00001A47 EBD4                    	jmp	short lff44m2_1
  3376                                  
  3377                                  lff44m2_3:
  3378                                  lff44s2_3:
  3379 00001A49 E93BF0FFFF              	jmp	lff44_3	; padfill
  3380                                  		; (put zeros in the remain words of the buffer)
  3381                                  lff44m2_7:
  3382                                  lff44s2_7:
  3383 00001A4E E957F0FFFF              	jmp	lff44_5  ; error
  3384                                  
  3385                                  load_44khz_stereo_16_bit:
  3386                                  	; 18/11/2023
  3387 00001A53 F605[04230000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3388                                  					; last of the file?
  3389 00001A5A 7402                    	jz	short lff44s2_0		; no
  3390 00001A5C F9                      	stc
  3391 00001A5D C3                      	retn
  3392                                  
  3393                                  lff44s2_0:
  3394 00001A5E BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3395                                          ;mov	edx, [loadsize]
  3396                                  
  3397                                  	; esi = buffer address
  3398                                  	;; edx = buffer size
  3399                                  
  3400                                  	; load file into memory
  3401                                  	sys 	_read, [FileHandle], esi, [loadsize]
    76                              <1> 
    77                              <1> 
    78                              <1> 
    79                              <1> 
    80                              <1>  %if %0 >= 2
    81 00001A63 8B1D[21200000]      <1>  mov ebx, %2
    82                              <1>  %if %0 >= 3
    83 00001A69 89F1                <1>  mov ecx, %3
    84                              <1>  %if %0 = 4
    85 00001A6B 8B15[B8030000]      <1>  mov edx, %4
    86                              <1>  %endif
    87                              <1>  %endif
    88                              <1>  %endif
    89 00001A71 B803000000          <1>  mov eax, %1
    90                              <1> 
    91 00001A76 CD40                <1>  int 40h
  3402 00001A78 72D4                    	jc	short lff44s2_7 ; error !
  3403                                  
  3404 00001A7A BF[00300000]            	mov	edi, audio_buffer
  3405                                  	
  3406 00001A7F C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3407 00001A82 7505                    	jnz	short lff44s2_8
  3408 00001A84 E918F0FFFF              	jmp	lff44_eof
  3409                                  
  3410                                  lff44s2_8:
  3411 00001A89 89C1                    	mov	ecx, eax	; dword count
  3412                                  lff44s2_9:
  3413 00001A8B BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3414 00001A90 C605[20200000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3415                                  lff44s2_1:
  3416                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3417                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3418 00001A97 66AD                    	lodsw
  3419 00001A99 89C3                    	mov	ebx, eax
  3420 00001A9B 66AD                    	lodsw
  3421                                  	;mov	dx, [esi]
  3422                                  	;mov	[next_val_l], dx
  3423                                  	;mov	dx, [esi+2]
  3424                                  	; 26/11/2023
  3425 00001A9D 8B16                    	mov	edx, [esi]
  3426 00001A9F 668915[1C200000]        	mov	[next_val_l], dx
  3427 00001AA6 C1EA10                  	shr	edx, 16
  3428 00001AA9 49                      	dec	ecx
  3429 00001AAA 7509                    	jnz	short lff44s2_2_1
  3430 00001AAC 31D2                    	xor	edx, edx ; 0
  3431 00001AAE 668915[1C200000]        	mov	[next_val_l], dx
  3432                                  lff44s2_2_1:
  3433                                  	; bx = [previous_val_l]
  3434                                  	; ax = [previous_val_r]
  3435                                  	; [next_val_l]
  3436                                  	; dx = [next_val_r]
  3437 00001AB5 E895010000              	call	interpolating_2_16bit_stereo
  3438 00001ABA E38D                    	jecxz	lff44s2_3
  3439                                  lff44s2_2_2:
  3440                                  	;movsw		; (L)eft Channel
  3441                                  	;movsw		; (R)ight Channel
  3442 00001ABC A5                      	movsd
  3443                                  
  3444 00001ABD 49                      	dec	ecx
  3445 00001ABE 7489                    	jz	short lff44s2_3	
  3446 00001AC0 4D                      	dec	ebp
  3447 00001AC1 75F9                    	jnz	short lff44s2_2_2
  3448                                  	
  3449 00001AC3 FE0D[20200000]          	dec	byte [faz]
  3450 00001AC9 74C0                    	jz	short lff44s2_9 
  3451 00001ACB BD0B000000              	mov	ebp, 11
  3452 00001AD0 EBC5                    	jmp	short lff44s2_1
  3453                                  
  3454                                  ; .....................
  3455                                  
  3456                                  interpolating_3_8bit_mono:
  3457                                  	; 16/11/2023
  3458                                  	; al = [previous_val]
  3459                                  	; dl = [next_val]
  3460                                  	; original-interpolated-interpolated
  3461 00001AD2 88C3                    	mov	bl, al
  3462 00001AD4 2C80                    	sub	al, 80h
  3463 00001AD6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3464 00001ADA 66AB                    	stosw		; original sample (L)
  3465 00001ADC 66AB                    	stosw		; original sample (R)
  3466 00001ADE 88D8                    	mov	al, bl
  3467 00001AE0 00D0                    	add	al, dl	
  3468 00001AE2 D0D8                    	rcr	al, 1
  3469 00001AE4 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3470 00001AE6 00D8                    	add	al, bl
  3471 00001AE8 D0D8                    	rcr	al, 1
  3472 00001AEA 2C80                    	sub	al, 80h
  3473 00001AEC 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3474 00001AF0 66AB                    	stosw		; interpolated sample 1 (L)
  3475 00001AF2 66AB                    	stosw		; interpolated sample 1 (R)
  3476 00001AF4 88F8                    	mov	al, bh
  3477 00001AF6 00D0                    	add	al, dl	; [next_val]
  3478 00001AF8 D0D8                    	rcr	al, 1
  3479 00001AFA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3480 00001AFE 66AB                    	stosw		; interpolated sample 2 (L)
  3481 00001B00 66AB                    	stosw		; interpolated sample 2 (R)
  3482 00001B02 C3                      	retn
  3483                                  
  3484                                  interpolating_3_8bit_stereo:
  3485                                  	; 16/11/2023
  3486                                  	; al = [previous_val_l]
  3487                                  	; ah = [previous_val_r]
  3488                                  	; dl = [next_val_l]
  3489                                  	; dh = [next_val_r]	
  3490                                  	; original-interpolated-interpolated
  3491 00001B03 89C3                    	mov	ebx, eax
  3492 00001B05 2C80                    	sub	al, 80h
  3493 00001B07 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3494 00001B0B 66AB                    	stosw		; original sample (L)
  3495 00001B0D 88F8                    	mov	al, bh
  3496 00001B0F 2C80                    	sub	al, 80h
  3497 00001B11 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3498 00001B15 66AB                    	stosw		; original sample (R)
  3499 00001B17 88D8                    	mov	al, bl
  3500 00001B19 00D0                    	add	al, dl	; [next_val_l]	
  3501 00001B1B D0D8                    	rcr	al, 1
  3502 00001B1D 50                      	push	eax ; *	; al = interpolated middle (L) (temporary)
  3503 00001B1E 00D8                    	add	al, bl	; [previous_val_l]
  3504 00001B20 D0D8                    	rcr	al, 1
  3505 00001B22 2C80                    	sub	al, 80h
  3506 00001B24 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3507 00001B28 66AB                    	stosw		; interpolated sample 1 (L)
  3508 00001B2A 88F8                    	mov	al, bh
  3509 00001B2C 00F0                    	add	al, dh	; [next_val_r]
  3510 00001B2E D0D8                    	rcr	al, 1
  3511 00001B30 50                      	push	eax ; ** ; al = interpolated middle (R) (temporary)
  3512 00001B31 00F8                    	add	al, bh	; [previous_val_r]
  3513 00001B33 D0D8                    	rcr	al, 1
  3514 00001B35 2C80                    	sub	al, 80h
  3515 00001B37 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3516 00001B3B 66AB                    	stosw		; interpolated sample 1 (R)
  3517 00001B3D 5B                      	pop	ebx ; **
  3518 00001B3E 58                      	pop	eax ; *
  3519 00001B3F 00D0                    	add	al, dl	; [next_val_l]
  3520 00001B41 D0D8                    	rcr	al, 1
  3521 00001B43 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3522 00001B47 66AB                    	stosw		; interpolated sample 2 (L)
  3523 00001B49 88D8                    	mov	al, bl
  3524 00001B4B 00F0                    	add	al, dh	; [next_val_r]
  3525 00001B4D D0D8                    	rcr	al, 1
  3526 00001B4F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3527 00001B53 66AB                    	stosw		; interpolated sample 2 (R)
  3528 00001B55 C3                      	retn
  3529                                  
  3530                                  interpolating_2_8bit_mono:
  3531                                  	; 16/11/2023
  3532                                  	; al = [previous_val]
  3533                                  	; dl = [next_val]
  3534                                  	; original-interpolated
  3535 00001B56 88C3                    	mov	bl, al
  3536 00001B58 2C80                    	sub	al, 80h
  3537 00001B5A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3538 00001B5E 66AB                    	stosw		; original sample (L)
  3539 00001B60 66AB                    	stosw		; original sample (R)
  3540 00001B62 88D8                    	mov	al, bl
  3541 00001B64 00D0                    	add	al, dl	
  3542 00001B66 D0D8                    	rcr	al, 1
  3543 00001B68 2C80                    	sub	al, 80h
  3544 00001B6A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3545 00001B6E 66AB                    	stosw		; interpolated sample (L)
  3546 00001B70 66AB                    	stosw		; interpolated sample (R)
  3547 00001B72 C3                      	retn
  3548                                  
  3549                                  interpolating_2_8bit_stereo:
  3550                                  	; 16/11/2023
  3551                                  	; al = [previous_val_l]
  3552                                  	; ah = [previous_val_r]
  3553                                  	; dl = [next_val_l]
  3554                                  	; dh = [next_val_r]	
  3555                                  	; original-interpolated
  3556 00001B73 89C3                    	mov	ebx, eax
  3557 00001B75 2C80                    	sub	al, 80h
  3558 00001B77 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3559 00001B7B 66AB                    	stosw		; original sample (L)
  3560 00001B7D 88F8                    	mov	al, bh
  3561 00001B7F 2C80                    	sub	al, 80h
  3562 00001B81 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3563 00001B85 66AB                    	stosw		; original sample (R)
  3564 00001B87 88D8                    	mov	al, bl	; [previous_val_l]
  3565 00001B89 00D0                    	add	al, dl	; [next_val_l]	
  3566 00001B8B D0D8                    	rcr	al, 1
  3567 00001B8D 2C80                    	sub	al, 80h
  3568 00001B8F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3569 00001B93 66AB                    	stosw		; interpolated sample (L)
  3570 00001B95 88F8                    	mov	al, bh
  3571 00001B97 00F0                    	add	al, dh	; [next_val_r]
  3572 00001B99 D0D8                    	rcr	al, 1
  3573 00001B9B 2C80                    	sub	al, 80h
  3574 00001B9D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3575 00001BA1 66AB                    	stosw		; interpolated sample (R)
  3576 00001BA3 C3                      	retn
  3577                                  
  3578                                  interpolating_3_16bit_mono:
  3579                                  	; 16/11/2023
  3580                                  	; ax = [previous_val]
  3581                                  	; dx = [next_val]
  3582                                  	; original-interpolated-interpolated
  3583                                  
  3584 00001BA4 66AB                    	stosw		; original sample (L)
  3585 00001BA6 66AB                    	stosw		; original sample (R)
  3586 00001BA8 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3587 00001BAB 50                      	push	eax ; *	; [previous_val]
  3588 00001BAC 80C680                  	add	dh, 80h
  3589 00001BAF 6601D0                  	add	ax, dx
  3590 00001BB2 66D1D8                  	rcr	ax, 1
  3591 00001BB5 5B                      	pop	ebx ; *		
  3592 00001BB6 93                      	xchg	ebx, eax ; bx  = interpolated middle (temporary)
  3593 00001BB7 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  3594 00001BBA 66D1D8                  	rcr	ax, 1
  3595 00001BBD 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3596 00001BC0 66AB                    	stosw 		; interpolated sample 1 (L)
  3597 00001BC2 66AB                    	stosw		; interpolated sample 1 (R)
  3598 00001BC4 89D8                    	mov	eax, ebx
  3599 00001BC6 6601D0                  	add	ax, dx	 ;interpolated middle + [next_val]
  3600 00001BC9 66D1D8                  	rcr	ax, 1
  3601 00001BCC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3602 00001BCF 66AB                    	stosw		; interpolated sample 2 (L)
  3603 00001BD1 66AB                    	stosw		; interpolated sample 2 (R)
  3604 00001BD3 C3                      	retn
  3605                                  
  3606                                  interpolating_3_16bit_stereo:
  3607                                  	; 16/11/2023
  3608                                  	; bx = [previous_val_l]
  3609                                  	; ax = [previous_val_r]
  3610                                  	; [next_val_l]
  3611                                  	; dx = [next_val_r]
  3612                                  	; original-interpolated-interpolated
  3613                                  
  3614 00001BD4 93                      	xchg	eax, ebx
  3615 00001BD5 66AB                    	stosw		; original sample (L)
  3616 00001BD7 93                      	xchg	eax, ebx
  3617 00001BD8 66AB                    	stosw		; original sample (R)
  3618 00001BDA 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3619 00001BDD 50                      	push	eax ; *	; [previous_val_r]
  3620 00001BDE 80C780                  	add	bh, 80h
  3621 00001BE1 8005[1D200000]80        	add	byte [next_val_l+1], 80h
  3622 00001BE8 66A1[1C200000]          	mov	ax, [next_val_l]
  3623 00001BEE 6601D8                  	add	ax, bx	; [previous_val_l]
  3624 00001BF1 66D1D8                  	rcr	ax, 1
  3625 00001BF4 93                      	xchg	eax, ebx ; ax = [previous_val_l]
  3626 00001BF5 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  3627 00001BF8 66D1D8                  	rcr	ax, 1
  3628 00001BFB 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3629 00001BFE 66AB                    	stosw 		; interpolated sample 1 (L)
  3630 00001C00 58                      	pop	eax  ; *
  3631 00001C01 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  3632 00001C04 52                      	push	edx  ; * ; [next_val_r]
  3633 00001C05 92                      	xchg	eax, edx
  3634 00001C06 6601D0                  	add	ax, dx	; [next_val_r] + [previous_val_r]
  3635 00001C09 66D1D8                  	rcr	ax, 1	; / 2
  3636 00001C0C 50                      	push	eax ; ** ; interpolated middle (R)
  3637 00001C0D 6601D0                  	add	ax, dx	; + [previous_val_r]
  3638 00001C10 66D1D8                  	rcr	ax, 1
  3639 00001C13 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3640 00001C16 66AB                    	stosw 		; interpolated sample 1 (R)
  3641 00001C18 66A1[1C200000]          	mov	ax, [next_val_l]
  3642 00001C1E 6601D8                  	add	ax, bx	; + interpolated middle (L)
  3643 00001C21 66D1D8                  	rcr	ax, 1
  3644 00001C24 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3645 00001C27 66AB                    	stosw 		; interpolated sample 2 (L)
  3646 00001C29 58                      	pop	eax ; **
  3647 00001C2A 5A                      	pop	edx ; *	
  3648 00001C2B 6601D0                  	add	ax, dx	; interpolated middle + [next_val_r]
  3649 00001C2E 66D1D8                  	rcr	ax, 1	; / 2
  3650 00001C31 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3651 00001C34 66AB                    	stosw 		; interpolated sample 2 (L)
  3652 00001C36 C3                      	retn
  3653                                  
  3654                                  interpolating_2_16bit_mono:
  3655                                  	; 16/11/2023
  3656                                  	; ax = [previous_val]
  3657                                  	; dx = [next_val]
  3658                                  	; original-interpolated
  3659                                  
  3660 00001C37 66AB                    	stosw		; original sample (L)
  3661 00001C39 66AB                    	stosw		; original sample (R)
  3662 00001C3B 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3663 00001C3E 80C680                  	add	dh, 80h
  3664 00001C41 6601D0                  	add	ax, dx
  3665 00001C44 66D1D8                  	rcr	ax, 1
  3666 00001C47 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3667 00001C4A 66AB                    	stosw		; interpolated sample (L)
  3668 00001C4C 66AB                    	stosw		; interpolated sample (R)
  3669 00001C4E C3                      	retn
  3670                                  
  3671                                  interpolating_2_16bit_stereo:
  3672                                  	; 16/11/2023
  3673                                  	; bx = [previous_val_l]
  3674                                  	; ax = [previous_val_r]
  3675                                  	; [next_val_l]
  3676                                  	; dx = [next_val_r]
  3677                                  	; original-interpolated
  3678                                  
  3679 00001C4F 93                      	xchg	eax, ebx
  3680 00001C50 66AB                    	stosw		; original sample (L)
  3681 00001C52 93                      	xchg	eax, ebx
  3682 00001C53 66AB                    	stosw		; original sample (R)
  3683 00001C55 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3684 00001C58 80C680                  	add	dh, 80h
  3685 00001C5B 6601D0                  	add	ax, dx	; [previous_val_r] + [next_val_r]
  3686 00001C5E 66D1D8                  	rcr	ax, 1	; / 2
  3687 00001C61 50                      	push	eax ; *	; interpolated sample (R)
  3688 00001C62 66A1[1C200000]          	mov	ax, [next_val_l]
  3689 00001C68 80C480                  	add	ah, 80h
  3690 00001C6B 80C780                  	add	bh, 80h
  3691 00001C6E 6601D8                  	add	ax, bx	; [next_val_l] + [previous_val_l]
  3692 00001C71 66D1D8                  	rcr	ax, 1	; / 2		
  3693 00001C74 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3694 00001C77 66AB                    	stosw 		; interpolated sample (L)
  3695 00001C79 58                      	pop	eax ; *	
  3696 00001C7A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3697 00001C7D 66AB                    	stosw 		; interpolated sample (R)
  3698 00001C7F C3                      	retn
  3699                                  
  3700                                  interpolating_5_8bit_mono:
  3701                                  	; 17/11/2023
  3702                                  	; al = [previous_val]
  3703                                  	; dl = [next_val]
  3704                                  	; original-interpltd-interpltd-interpltd-interpltd
  3705 00001C80 88C3                    	mov	bl, al
  3706 00001C82 2C80                    	sub	al, 80h
  3707 00001C84 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3708 00001C88 66AB                    	stosw		; original sample (L)
  3709 00001C8A 66AB                    	stosw		; original sample (R)
  3710 00001C8C 88D8                    	mov	al, bl
  3711 00001C8E 00D0                    	add	al, dl	
  3712 00001C90 D0D8                    	rcr	al, 1
  3713 00001C92 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3714 00001C94 00D8                    	add	al, bl  ; [previous_val]
  3715 00001C96 D0D8                    	rcr	al, 1 	
  3716 00001C98 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  3717 00001C9A 00D8                    	add	al, bl
  3718 00001C9C D0D8                    	rcr	al, 1
  3719 00001C9E 2C80                    	sub	al, 80h
  3720 00001CA0 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3721 00001CA4 66AB                    	stosw		; interpolated sample 1 (L)
  3722 00001CA6 66AB                    	stosw		; interpolated sample 1 (R)
  3723 00001CA8 88F8                    	mov	al, bh
  3724 00001CAA 00F0                    	add	al, dh
  3725 00001CAC D0D8                    	rcr	al, 1
  3726 00001CAE 2C80                    	sub	al, 80h
  3727 00001CB0 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3728 00001CB4 66AB                    	stosw		; interpolated sample 2 (L)
  3729 00001CB6 66AB                    	stosw		; interpolated sample 2 (R)
  3730 00001CB8 88F8                    	mov	al, bh
  3731 00001CBA 00D0                    	add	al, dl	; [next_val]
  3732 00001CBC D0D8                    	rcr	al, 1
  3733 00001CBE 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  3734 00001CC0 00F8                    	add	al, bh
  3735 00001CC2 D0D8                    	rcr	al, 1
  3736 00001CC4 2C80                    	sub	al, 80h
  3737 00001CC6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3738 00001CCA 66AB                    	stosw		; interpolated sample 3 (L)
  3739 00001CCC 66AB                    	stosw		; interpolated sample 3 (R)
  3740 00001CCE 88F0                    	mov	al, dh
  3741 00001CD0 00D0                    	add	al, dl
  3742 00001CD2 D0D8                    	rcr	al, 1
  3743 00001CD4 2C80                    	sub	al, 80h
  3744 00001CD6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3745 00001CDA 66AB                    	stosw		; interpolated sample 4 (L)
  3746 00001CDC 66AB                    	stosw		; interpolated sample 4 (R)
  3747 00001CDE C3                      	retn
  3748                                  
  3749                                  interpolating_5_8bit_stereo:
  3750                                  	; 17/11/2023
  3751                                  	; al = [previous_val_l]
  3752                                  	; ah = [previous_val_r]
  3753                                  	; dl = [next_val_l]
  3754                                  	; dh = [next_val_r]	
  3755                                  	; original-interpltd-interpltd-interpltd-interpltd
  3756 00001CDF 89C3                    	mov	ebx, eax
  3757 00001CE1 2C80                    	sub	al, 80h
  3758 00001CE3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3759 00001CE7 66AB                    	stosw		; original sample (L)
  3760 00001CE9 88F8                    	mov	al, bh
  3761 00001CEB 2C80                    	sub	al, 80h
  3762 00001CED 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3763 00001CF1 66AB                    	stosw		; original sample (R)
  3764 00001CF3 52                      	push	edx ; *
  3765 00001CF4 88D8                    	mov	al, bl
  3766 00001CF6 00D0                    	add	al, dl	; [next_val_l]
  3767 00001CF8 D0D8                    	rcr	al, 1
  3768 00001CFA 50                      	push	eax ; **	; al = interpolated middle (L) (temporary)
  3769 00001CFB 00D8                    	add	al, bl	; [previous_val_l]
  3770 00001CFD D0D8                    	rcr	al, 1
  3771 00001CFF 86D8                    	xchg	al, bl	
  3772 00001D01 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3773 00001D03 D0D8                    	rcr	al, 1
  3774 00001D05 2C80                    	sub	al, 80h
  3775 00001D07 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3776 00001D0B 66AB                    	stosw		; interpolated sample 1 (L)
  3777 00001D0D 88F8                    	mov	al, bh
  3778 00001D0F 00F0                    	add	al, dh	; [next_val_r]
  3779 00001D11 D0D8                    	rcr	al, 1
  3780 00001D13 50                      	push	eax ; *** ; al = interpolated middle (R) (temporary)
  3781 00001D14 00F8                    	add	al, bh	; [previous_val_r]
  3782 00001D16 D0D8                    	rcr	al, 1
  3783 00001D18 86F8                    	xchg	al, bh	
  3784 00001D1A 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3785 00001D1C D0D8                    	rcr	al, 1
  3786 00001D1E 2C80                    	sub	al, 80h
  3787 00001D20 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3788 00001D24 66AB                    	stosw		; interpolated sample 1 (R)
  3789 00001D26 5A                      	pop	edx ; ***
  3790 00001D27 58                      	pop	eax ; **	; al = interpolated middle (L) (temporary)
  3791 00001D28 86D8                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3792 00001D2A 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  3793 00001D2C D0D8                    	rcr	al, 1
  3794 00001D2E 2C80                    	sub	al, 80h
  3795 00001D30 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3796 00001D34 66AB                    	stosw		; interpolated sample 2 (L)	
  3797 00001D36 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  3798 00001D38 86F8                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  3799 00001D3A 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  3800 00001D3C D0D8                    	rcr	al, 1
  3801 00001D3E 2C80                    	sub	al, 80h
  3802 00001D40 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3803 00001D44 66AB                    	stosw		; interpolated sample 2 (R)
  3804 00001D46 5A                      	pop	edx ; *
  3805 00001D47 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  3806 00001D49 00D0                    	add	al, dl	; [next_val_l]
  3807 00001D4B D0D8                    	rcr	al, 1
  3808 00001D4D 86D8                    	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  3809 00001D4F 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  3810 00001D51 D0D8                    	rcr	al, 1
  3811 00001D53 2C80                    	sub	al, 80h
  3812 00001D55 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3813 00001D59 66AB                    	stosw		; interpolated sample 3 (L)
  3814 00001D5B 88F8                    	mov	al, bh	
  3815 00001D5D 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  3816 00001D5F D0D8                    	rcr	al, 1
  3817 00001D61 86F8                    	xchg	al, bh	; al = interpolated middle (R)
  3818 00001D63 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  3819 00001D65 D0D8                    	rcr	al, 1
  3820 00001D67 2C80                    	sub	al, 80h
  3821 00001D69 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3822 00001D6D 66AB                    	stosw		; interpolated sample 3 (R)
  3823 00001D6F 88D8                    	mov	al, bl
  3824 00001D71 00D0                    	add	al, dl	; [next_val_l]
  3825 00001D73 D0D8                    	rcr	al, 1
  3826 00001D75 2C80                    	sub	al, 80h
  3827 00001D77 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3828 00001D7B 66AB                    	stosw		; interpolated sample 4 (L)
  3829 00001D7D 88F8                    	mov	al, bh
  3830 00001D7F 00F0                    	add	al, dh	; [next_val_r]
  3831 00001D81 D0D8                    	rcr	al, 1
  3832 00001D83 2C80                    	sub	al, 80h
  3833 00001D85 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3834 00001D89 66AB                    	stosw		; interpolated sample 4 (R)
  3835 00001D8B C3                      	retn
  3836                                  
  3837                                  interpolating_4_8bit_mono:
  3838                                  	; 17/11/2023
  3839                                  	; al = [previous_val]
  3840                                  	; dl = [next_val]
  3841                                  	; original-interpolated-interpolated-interpolated
  3842 00001D8C 88C3                    	mov	bl, al
  3843 00001D8E 2C80                    	sub	al, 80h
  3844 00001D90 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3845 00001D94 66AB                    	stosw		; original sample (L)
  3846 00001D96 66AB                    	stosw		; original sample (R)
  3847 00001D98 88D8                    	mov	al, bl
  3848 00001D9A 00D0                    	add	al, dl	
  3849 00001D9C D0D8                    	rcr	al, 1
  3850 00001D9E 86D8                    	xchg	al, bl  ; al = [previous_val]
  3851 00001DA0 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  3852 00001DA2 D0D8                    	rcr	al, 1 	
  3853 00001DA4 2C80                    	sub	al, 80h
  3854 00001DA6 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3855 00001DAA 66AB                    	stosw		; interpolated sample 1 (L)
  3856 00001DAC 66AB                    	stosw		; interpolated sample 1 (R)
  3857 00001DAE 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  3858 00001DB0 2C80                    	sub	al, 80h
  3859 00001DB2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3860 00001DB6 66AB                    	stosw		; interpolated sample 2 (L)
  3861 00001DB8 66AB                    	stosw		; interpolated sample 2 (R)
  3862 00001DBA 88D8                    	mov	al, bl
  3863 00001DBC 00D0                    	add	al, dl	; [next_val]
  3864 00001DBE D0D8                    	rcr	al, 1
  3865 00001DC0 2C80                    	sub	al, 80h
  3866 00001DC2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3867 00001DC6 66AB                    	stosw		; interpolated sample 3 (L)
  3868 00001DC8 66AB                    	stosw		; interpolated sample 3 (R)
  3869 00001DCA C3                      	retn
  3870                                  
  3871                                  interpolating_4_8bit_stereo:
  3872                                  	; 17/11/2023
  3873                                  	; al = [previous_val_l]
  3874                                  	; ah = [previous_val_r]
  3875                                  	; dl = [next_val_l]
  3876                                  	; dh = [next_val_r]	
  3877                                  	; original-interpolated-interpolated-interpolated
  3878 00001DCB 89C3                    	mov	ebx, eax
  3879 00001DCD 2C80                    	sub	al, 80h
  3880 00001DCF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3881 00001DD3 66AB                    	stosw		; original sample (L)
  3882 00001DD5 88F8                    	mov	al, bh
  3883 00001DD7 2C80                    	sub	al, 80h
  3884 00001DD9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3885 00001DDD 66AB                    	stosw		; original sample (R)
  3886 00001DDF 88D8                    	mov	al, bl
  3887 00001DE1 00D0                    	add	al, dl	; [next_val_l]
  3888 00001DE3 D0D8                    	rcr	al, 1
  3889 00001DE5 86D8                    	xchg	al, bl	; al = [previous_val_l]
  3890 00001DE7 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  3891 00001DE9 D0D8                    	rcr	al, 1
  3892 00001DEB 2C80                    	sub	al, 80h
  3893 00001DED 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3894 00001DF1 66AB                    	stosw		; interpolated sample 1 (L)
  3895 00001DF3 88F8                    	mov	al, bh
  3896 00001DF5 00F0                    	add	al, dh	; [next_val_r]
  3897 00001DF7 D0D8                    	rcr	al, 1
  3898 00001DF9 86F8                    	xchg	al, bh	; al = [previous_val_h]
  3899 00001DFB 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  3900 00001DFD D0D8                    	rcr	al, 1
  3901 00001DFF 2C80                    	sub	al, 80h
  3902 00001E01 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3903 00001E05 66AB                    	stosw		; interpolated sample 1 (R)
  3904 00001E07 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  3905 00001E09 2C80                    	sub	al, 80h
  3906 00001E0B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3907 00001E0F 66AB                    	stosw		; interpolated sample 2 (L)
  3908 00001E11 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  3909 00001E13 2C80                    	sub	al, 80h
  3910 00001E15 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3911 00001E19 66AB                    	stosw		; interpolated sample 2 (L)
  3912 00001E1B 88D8                    	mov	al, bl
  3913 00001E1D 00D0                    	add	al, dl	; [next_val_l]
  3914 00001E1F D0D8                    	rcr	al, 1
  3915 00001E21 2C80                    	sub	al, 80h
  3916 00001E23 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3917 00001E27 66AB                    	stosw		; interpolated sample 3 (L)
  3918 00001E29 88F8                    	mov	al, bh
  3919 00001E2B 00F0                    	add	al, dh	; [next_val_r]
  3920 00001E2D D0D8                    	rcr	al, 1
  3921 00001E2F 2C80                    	sub	al, 80h
  3922 00001E31 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3923 00001E35 66AB                    	stosw		; interpolated sample 3 (R)
  3924 00001E37 C3                      	retn
  3925                                  
  3926                                  interpolating_5_16bit_mono:
  3927                                  	; 18/11/2023
  3928                                  	; ax = [previous_val]
  3929                                  	; dx = [next_val]
  3930                                  	; original-interpltd-interpltd-interpltd-interpltd
  3931 00001E38 66AB                    	stosw		; original sample (L)
  3932 00001E3A 66AB                    	stosw		; original sample (R)
  3933 00001E3C 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3934 00001E3F 89C3                    	mov	ebx, eax ; [previous_val]
  3935 00001E41 80C680                  	add	dh, 80h
  3936 00001E44 6601D0                  	add	ax, dx
  3937 00001E47 66D1D8                  	rcr	ax, 1
  3938 00001E4A 50                      	push	eax ; *	; interpolated middle (temporary)
  3939 00001E4B 6601D8                  	add	ax, bx	; interpolated middle + [previous_val] 
  3940 00001E4E 66D1D8                  	rcr	ax, 1
  3941 00001E51 50                      	push	eax ; **	; interpolated 1st quarter (temporary)
  3942 00001E52 6601D8                  	add	ax, bx	; 1st quarter + [previous_val]
  3943 00001E55 66D1D8                  	rcr	ax, 1	
  3944 00001E58 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3945 00001E5B 66AB                    	stosw 		; interpolated sample 1 (L)
  3946 00001E5D 66AB                    	stosw		; interpolated sample 1 (R)
  3947 00001E5F 58                      	pop	eax ; **	
  3948 00001E60 5B                      	pop	ebx ; *
  3949 00001E61 6601D8                  	add	ax, bx	; 1st quarter + middle
  3950 00001E64 66D1D8                  	rcr	ax, 1	; / 2
  3951 00001E67 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  3952 00001E6A 66AB                    	stosw		; interpolated sample 2 (L)
  3953 00001E6C 66AB                    	stosw		; interpolated sample 2 (R)		
  3954 00001E6E 89D8                    	mov	eax, ebx
  3955 00001E70 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  3956 00001E73 66D1D8                  	rcr	ax, 1
  3957 00001E76 50                      	push	eax ; *	; interpolated 3rd quarter (temporary)
  3958 00001E77 6601D8                  	add	ax, bx	; + interpolated middle
  3959 00001E7A 66D1D8                  	rcr	ax, 1
  3960 00001E7D 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3961 00001E80 66AB                    	stosw		; interpolated sample 3 (L)
  3962 00001E82 66AB                    	stosw		; interpolated sample 3 (R)
  3963 00001E84 58                      	pop	eax ; *	
  3964 00001E85 6601D0                  	add	ax, dx	; 3rd quarter + [next_val]
  3965 00001E88 66D1D8                  	rcr	ax, 1	; / 2
  3966 00001E8B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3967 00001E8E 66AB                    	stosw		; interpolated sample 4 (L)
  3968 00001E90 66AB                    	stosw		; interpolated sample 4 (R)
  3969 00001E92 C3                      	retn
  3970                                  
  3971                                  interpolating_5_16bit_stereo:
  3972                                  	; 18/11/2023
  3973                                  	; bx = [previous_val_l]
  3974                                  	; ax = [previous_val_r]
  3975                                  	; [next_val_l]
  3976                                  	; [next_val_r]
  3977                                  	; original-interpltd-interpltd-interpltd-interpltd
  3978 00001E93 51                      	push	ecx ; !
  3979 00001E94 93                      	xchg	eax, ebx
  3980 00001E95 66AB                    	stosw		; original sample (L)
  3981 00001E97 93                      	xchg	eax, ebx
  3982 00001E98 66AB                    	stosw		; original sample (R)
  3983 00001E9A 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3984 00001E9D 50                      	push	eax ; *	; [previous_val_r]
  3985 00001E9E 80C780                  	add	bh, 80h
  3986 00001EA1 8005[1D200000]80        	add	byte [next_val_l+1], 80h
  3987 00001EA8 66A1[1C200000]          	mov	ax, [next_val_l]
  3988 00001EAE 6601D8                  	add	ax, bx	; [previous_val_l]
  3989 00001EB1 66D1D8                  	rcr	ax, 1
  3990 00001EB4 89C1                    	mov	ecx, eax ; interpolated middle (L)
  3991 00001EB6 6601D8                  	add	ax, bx	
  3992 00001EB9 66D1D8                  	rcr	ax, 1
  3993 00001EBC 89C2                    	mov	edx, eax ; interpolated 1st quarter (L)	
  3994 00001EBE 6601D8                  	add	ax, bx	; [previous_val_l]
  3995 00001EC1 66D1D8                  	rcr	ax, 1
  3996 00001EC4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3997 00001EC7 66AB                    	stosw 		; interpolated sample 1 (L)
  3998 00001EC9 89C8                    	mov	eax, ecx
  3999 00001ECB 6601D0                  	add	ax, dx	; middle (L) + 1st quarter (L) 
  4000 00001ECE 66D1D8                  	rcr	ax, 1	; / 2
  4001 00001ED1 89C3                    	mov	ebx, eax  ; interpolated sample 2 (L)
  4002 00001ED3 5A                      	pop	edx ; *	; [previous_val_r]
  4003 00001ED4 89D0                    	mov	eax, edx
  4004 00001ED6 8005[1F200000]80        	add	byte [next_val_r+1], 80h
  4005 00001EDD 660305[1E200000]        	add	ax, [next_val_r]
  4006 00001EE4 66D1D8                  	rcr	ax, 1
  4007 00001EE7 50                      	push	eax ; *	; interpolated middle (R)
  4008 00001EE8 6601D0                  	add	ax, dx
  4009 00001EEB 66D1D8                  	rcr	ax, 1
  4010 00001EEE 50                      	push	eax ; ** ; interpolated 1st quarter (R)
  4011 00001EEF 6601D0                  	add	ax, dx	; [previous_val_r]
  4012 00001EF2 66D1D8                  	rcr	ax, 1
  4013 00001EF5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4014 00001EF8 66AB                    	stosw 		; interpolated sample 1 (R)
  4015 00001EFA 89D8                    	mov	eax, ebx
  4016 00001EFC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4017 00001EFF 66AB                    	stosw 		; interpolated sample 2 (L)
  4018 00001F01 58                      	pop	eax ; **
  4019 00001F02 5A                      	pop	edx ; *
  4020 00001F03 6601D0                  	add	ax, dx	; 1st quarter (R) + middle (R)
  4021 00001F06 66D1D8                  	rcr	ax, 1	; / 2
  4022 00001F09 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4023 00001F0C 66AB                    	stosw 		; interpolated sample 2 (R)
  4024 00001F0E 89C8                    	mov	eax, ecx
  4025 00001F10 660305[1C200000]        	add	ax, [next_val_l]
  4026 00001F17 66D1D8                  	rcr	ax, 1
  4027 00001F1A 50                      	push	eax ; * ; interpolated 3rd quarter (L)
  4028 00001F1B 6601C8                  	add	ax, cx	; interpolated middle (L)
  4029 00001F1E 66D1D8                  	rcr	ax, 1
  4030 00001F21 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4031 00001F24 66AB                    	stosw 		; interpolated sample 3 (L)
  4032 00001F26 89D0                    	mov	eax, edx
  4033 00001F28 660305[1E200000]        	add	ax, [next_val_r]
  4034 00001F2F 66D1D8                  	rcr	ax, 1
  4035 00001F32 50                      	push	eax ; ** ; interpolated 3rd quarter (R)
  4036 00001F33 6601D0                  	add	ax, dx	; interpolated middle (R)
  4037 00001F36 66D1D8                  	rcr	ax, 1
  4038 00001F39 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4039 00001F3C 66AB                    	stosw 		; interpolated sample 3 (R)
  4040 00001F3E 5B                      	pop	ebx ; **
  4041 00001F3F 58                      	pop	eax ; *
  4042 00001F40 660305[1C200000]        	add	ax, [next_val_l]
  4043 00001F47 66D1D8                  	rcr	ax, 1
  4044 00001F4A 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4045 00001F4D 66AB                    	stosw 		; interpolated sample 4 (L)
  4046 00001F4F 89D8                    	mov	eax, ebx	
  4047 00001F51 660305[1E200000]        	add	ax, [next_val_r]
  4048 00001F58 66D1D8                  	rcr	ax, 1
  4049 00001F5B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4050 00001F5E 66AB                    	stosw 		; interpolated sample 4 (R)
  4051 00001F60 59                      	pop	ecx ; !
  4052 00001F61 C3                      	retn
  4053                                  
  4054                                  interpolating_4_16bit_mono:
  4055                                  	; 18/11/2023
  4056                                  	; ax = [previous_val]
  4057                                  	; dx = [next_val]
  4058                                  	; original-interpolated
  4059                                  
  4060 00001F62 66AB                    	stosw		; original sample (L)
  4061 00001F64 66AB                    	stosw		; original sample (R)
  4062 00001F66 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4063 00001F69 89C3                    	mov	ebx, eax ; [previous_val]
  4064 00001F6B 80C680                  	add	dh, 80h
  4065 00001F6E 6601D0                  	add	ax, dx	; [previous_val] + [next_val]
  4066 00001F71 66D1D8                  	rcr	ax, 1
  4067 00001F74 93                      	xchg	eax, ebx	
  4068 00001F75 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  4069 00001F78 66D1D8                  	rcr	ax, 1
  4070 00001F7B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4071 00001F7E 66AB                    	stosw 		; interpolated sample 1 (L)
  4072 00001F80 66AB                    	stosw		; interpolated sample 1 (R)
  4073 00001F82 89D8                    	mov	eax, ebx ; interpolated middle
  4074 00001F84 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4075 00001F87 66AB                    	stosw 		; interpolated sample 2 (L)
  4076 00001F89 66AB                    	stosw		; interpolated sample 2 (R)
  4077 00001F8B 89D8                    	mov	eax, ebx
  4078 00001F8D 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4079 00001F90 66D1D8                  	rcr	ax, 1
  4080 00001F93 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4081 00001F96 66AB                    	stosw		; interpolated sample 3 (L)
  4082 00001F98 66AB                    	stosw		; interpolated sample 3 (R)
  4083 00001F9A C3                      	retn
  4084                                  
  4085                                  interpolating_4_16bit_stereo:
  4086                                  	; 18/11/2023
  4087                                  	; bx = [previous_val_l]
  4088                                  	; ax = [previous_val_r]
  4089                                  	; [next_val_l]
  4090                                  	; [next_val_r]
  4091                                  	; original-interpolated-interpolated-interpolated
  4092 00001F9B 93                      	xchg	eax, ebx
  4093 00001F9C 66AB                    	stosw		; original sample (L)
  4094 00001F9E 93                      	xchg	eax, ebx
  4095 00001F9F 66AB                    	stosw		; original sample (R)
  4096 00001FA1 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4097 00001FA4 89C2                    	mov	edx, eax ; [previous_val_r]
  4098 00001FA6 80C780                  	add	bh, 80h
  4099 00001FA9 8005[1D200000]80        	add	byte [next_val_l+1], 80h
  4100 00001FB0 66A1[1C200000]          	mov	ax, [next_val_l]
  4101 00001FB6 6601D8                  	add	ax, bx	; [previous_val_l]
  4102 00001FB9 66D1D8                  	rcr	ax, 1
  4103 00001FBC 93                      	xchg	eax, ebx	
  4104 00001FBD 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  4105 00001FC0 66D1D8                  	rcr	ax, 1
  4106 00001FC3 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4107 00001FC6 66AB                    	stosw 		; interpolated sample 1 (L)
  4108 00001FC8 8005[1F200000]80        	add	byte [next_val_r+1], 80h
  4109 00001FCF 89D0                    	mov	eax, edx ; [previous_val_r]
  4110 00001FD1 660305[1E200000]        	add	ax, [next_val_r]
  4111 00001FD8 66D1D8                  	rcr	ax, 1
  4112 00001FDB 92                      	xchg	eax, edx	
  4113 00001FDC 6601D0                  	add	ax, dx	; dx = interpolated middle (R)
  4114 00001FDF 66D1D8                  	rcr	ax, 1
  4115 00001FE2 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4116 00001FE5 66AB                    	stosw 		; interpolated sample 1 (R)
  4117 00001FE7 89D8                    	mov	eax, ebx
  4118 00001FE9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4119 00001FEC 66AB                    	stosw 		; interpolated sample 2 (L)
  4120 00001FEE 89D0                    	mov	eax, edx
  4121 00001FF0 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4122 00001FF3 66AB                    	stosw 		; interpolated sample 2 (R)
  4123 00001FF5 89D8                    	mov	eax, ebx
  4124 00001FF7 660305[1C200000]        	add	ax, [next_val_l]
  4125 00001FFE 66D1D8                  	rcr	ax, 1
  4126 00002001 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4127 00002004 66AB                    	stosw 		; interpolated sample 3 (L)
  4128 00002006 89D0                    	mov	eax, edx
  4129 00002008 660305[1E200000]        	add	ax, [next_val_r]
  4130 0000200F 66D1D8                  	rcr	ax, 1
  4131 00002012 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4132 00002015 66AB                    	stosw 		; interpolated sample 3 (R)
  4133 00002017 C3                      	retn
  4134                                  
  4135                                  ; 13/11/2023
  4136                                  previous_val:
  4137 00002018 0000                    previous_val_l: dw 0
  4138 0000201A 0000                    previous_val_r: dw 0
  4139                                  next_val:
  4140 0000201C 0000                    next_val_l: dw 0
  4141 0000201E 0000                    next_val_r: dw 0
  4142                                  
  4143                                  ; 16/11/2023
  4144 00002020 00                      faz:	db 0	
  4145                                  	
  4146                                  ; --------------------------------------------------------
  4147                                  
  4148                                  ; DATA
  4149                                  
  4150                                  FileHandle:	
  4151 00002021 FFFFFFFF                	dd	-1
  4152                                  
  4153                                  Credits:
  4154 00002025 54696E792057415620-     	db	'Tiny WAV Player for TRDOS 386 by Erdogan Tan. '
  4154 0000202E 506C6179657220666F-
  4154 00002037 72205452444F532033-
  4154 00002040 383620627920457264-
  4154 00002049 6F67616E2054616E2E-
  4154 00002052 20                 
  4155                                  	;;;db	'August 2020.',10,13,0
  4156                                  	;;db	'November 2023.',10,13,0
  4157                                  	;db	'June 2024.', 10,13,0
  4158 00002053 446563656D62657220-     	db	'December 2024', 10,13,0
  4158 0000205C 323032340A0D00     
  4159 00002063 31372F30362F323031-     	db	'17/06/2017', 10,13,0
  4159 0000206C 370A0D00           
  4160 00002070 31382F30382F323032-     	db	'18/08/2020', 10,13,0
  4160 00002079 300A0D00           
  4161 0000207D 32372F31312F323032-     	db	'27/11/2023', 10,13,0
  4161 00002086 330A0D00           
  4162 0000208A 30312F30362F323032-     	db	'01/06/2024', 10,13,0
  4162 00002093 340A0D00           
  4163 00002097 30342F30362F323032-     	db	'04/06/2024', 10,13,0
  4163 000020A0 340A0D00           
  4164 000020A4 30382F31322F323032-     	db	'08/12/2024', 10,13,0
  4164 000020AD 340A0D00           
  4165                                  
  4166                                  msgAudioCardInfo:
  4167 000020B1 666F7220496E74656C-     	db 	'for Intel AC97 (ICH) Audio Controller.', 10,13,0
  4167 000020BA 204143393720284943-
  4167 000020C3 482920417564696F20-
  4167 000020CC 436F6E74726F6C6C65-
  4167 000020D5 722E0A0D00         
  4168                                  
  4169                                  msg_usage:
  4170 000020DA 75736167653A20706C-     	db	'usage: playwav8 filename.wav',10,13,0
  4170 000020E3 617977617638206669-
  4170 000020EC 6C656E616D652E7761-
  4170 000020F5 760A0D00           
  4171                                  
  4172                                  noDevMsg:
  4173 000020F9 4572726F723A20556E-     	db	'Error: Unable to find AC97 audio device!'
  4173 00002102 61626C6520746F2066-
  4173 0000210B 696E64204143393720-
  4173 00002114 617564696F20646576-
  4173 0000211D 69636521           
  4174 00002121 0A0D00                  	db	10,13,0
  4175                                  
  4176                                  noFileErrMsg:
  4177 00002124 4572726F723A206669-     	db	'Error: file not found.',10,13,0
  4177 0000212D 6C65206E6F7420666F-
  4177 00002136 756E642E0A0D00     
  4178                                  
  4179                                  trdos386_err_msg:
  4180 0000213D 5452444F5320333836-     	db	'TRDOS 386 System call error !',10,13,0
  4180 00002146 2053797374656D2063-
  4180 0000214F 616C6C206572726F72-
  4180 00002158 20210A0D00         
  4181                                  
  4182                                  ; 01/06/2024
  4183                                  msg_init_err:
  4184 0000215D 0A0D                    	db	10,13
  4185 0000215F 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  4185 00002168 726F6C6C65722F436F-
  4185 00002171 64656320696E697469-
  4185 0000217A 616C697A6174696F6E-
  4185 00002183 206572726F722021   
  4186 0000218B 0A0D00                  	db	10,13,0
  4187                                  
  4188                                  ; 25/11/2023
  4189                                  msg_no_vra:
  4190 0000218E 0A0D                    	db	10,13
  4191 00002190 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  4191 00002199 70706F72742021204F-
  4191 000021A2 6E6C79203438206B48-
  4191 000021AB 5A2073616D706C6520-
  4191 000021B4 726174652073757070-
  4191 000021BD 6F727465642021     
  4192 000021C4 0A0D00                  	db	10,13,0
  4193                                  
  4194 000021C7 0D0A5741562046696C-     msgWavFileName:	db 0Dh, 0Ah, "WAV File Name: ",0
  4194 000021D0 65204E616D653A2000 
  4195 000021D9 0D0A53616D706C6520-     msgSampleRate:	db 0Dh, 0Ah, "Sample Rate: "
  4195 000021E2 526174653A20       
  4196 000021E8 303030303020487A2C-     msgHertz:	db "00000 Hz, ", 0 
  4196 000021F1 2000               
  4197 000021F3 3820626974732C2000      msg8Bits:	db "8 bits, ", 0 
  4198 000021FC 4D6F6E6F0D0A00          msgMono:	db "Mono", 0Dh, 0Ah, 0
  4199 00002203 313620626974732C20-     msg16Bits:	db "16 bits, ", 0 
  4199 0000220C 00                 
  4200 0000220D 53746572656F            msgStereo:	db "Stereo"
  4201 00002213 0D0A00                  nextline:	db 0Dh, 0Ah, 0
  4202                                  
  4203                                  ; 03/06/2017
  4204 00002216 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  4204 0000221F 3941424344454600   
  4205 00002227 0D0A                    msgAC97Info	db 0Dh, 0Ah
  4206 00002229 414339372041756469-     		db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  4206 00002232 6F20436F6E74726F6C-
  4206 0000223B 6C6572202620436F64-
  4206 00002244 656320496E666F0D0A 
  4207 0000224D 56656E646F72204944-     		db "Vendor ID: "
  4207 00002256 3A20               
  4208 00002258 303030306820446576-     msgVendorId	db "0000h Device ID: "
  4208 00002261 6963652049443A20   
  4209 00002269 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  4210 00002270 4275733A20              		db "Bus: "
  4211 00002275 303068204465766963-     msgBusNo	db "00h Device: "
  4211 0000227E 653A20             
  4212 00002281 3030682046756E6374-     msgDevNo	db "00h Function: "
  4212 0000228A 696F6E3A20         
  4213 0000228F 303068                  msgFncNo	db "00h"
  4214 00002292 0D0A                    		db 0Dh, 0Ah
  4215 00002294 4E414D4241523A20        		db "NAMBAR: "
  4216 0000229C 30303030682020          msgNamBar	db "0000h  "
  4217 000022A3 4E41424D4241523A20      		db "NABMBAR: "
  4218 000022AC 303030306820204952-     msgNabmBar	db "0000h  IRQ: "
  4218 000022B5 513A20             
  4219 000022B8 3030                    msgIRQ		dw 3030h
  4220 000022BA 0D0A00                  		db 0Dh, 0Ah, 0
  4221                                  ; 25/11/2023
  4222 000022BD 56524120737570706F-     msgVRAheader:	db "VRA support: "
  4222 000022C6 72743A20           
  4223 000022CA 00                      		db 0	
  4224                                  ; 08/12/2024
  4225                                  ;msgVRAyes:	db "YES", 0Dh, 0Ah, 0
  4226 000022CB 4E4F200D0A              msgVRAno:	db "NO ", 0Dh, 0Ah
  4227 000022D0 28496E746572706F6C-     		db "(Interpolated sample rate playing method)"
  4227 000022D9 617465642073616D70-
  4227 000022E2 6C6520726174652070-
  4227 000022EB 6C6179696E67206D65-
  4227 000022F4 74686F6429         
  4228 000022F9 0D0A00                  		db 0Dh, 0Ah, 0	
  4229                                  EOF: 
  4230                                  
  4231                                  ; BSS
  4232                                  
  4233                                  bss_start:
  4234                                  
  4235                                  ABSOLUTE bss_start
  4236                                  
  4237                                  alignb 4
  4238                                  
  4239 000022FC ??                      stmo:		resb 1 ; stereo or mono (1=stereo) 
  4240 000022FD ??                      bps:		resb 1 ; bits per sample (8,16)
  4241 000022FE ????                    sample_rate:	resw 1 ; Sample Frequency (Hz)
  4242                                  
  4243                                  ; 25/11/2023
  4244 00002300 ????????                bufferSize:	resd 1
  4245                                  
  4246 00002304 ??                      flags:		resb 1
  4247                                  ;cbs_busy:	resb 1 
  4248 00002305 ??                      half_buff:	resb 1
  4249 00002306 ??                      srb:		resb 1
  4250                                  ; 18/08/2020
  4251 00002307 ??                      volume_level:	resb 1
  4252                                  ; 25/11/2023
  4253 00002308 ??                      VRA:		resb 1	; Variable Rate Audio Support Status
  4254                                  
  4255 00002309 <res 1Ch>               smpRBuff:	resw 14 
  4256                                  
  4257                                  wav_file_name:
  4258 00002325 <res 50h>               		resb 80 ; wave file, path name (<= 80 bytes)
  4259                                  
  4260 00002375 ????                    		resw 1
  4261 00002377 ??                      ac97_int_ln_reg: resb 1
  4262 00002378 ??                      fbs_shift:	resb 1 ; 26/11/2023
  4263 00002379 ????????                dev_vendor:	resd 1
  4264 0000237D ????????                bus_dev_fn:	resd 1
  4265 00002381 ????                    ac97_NamBar:	resw 1
  4266 00002383 ????                    ac97_NabmBar:	resw 1
  4267                                  
  4268                                  bss_end:
  4269 00002385 <res C7Bh>              alignb 4096
  4270                                  ;audio_buffer:	resb BUFFERSIZE ; DMA Buffer Size / 2 (32768)
  4271                                  ; 26/11/2023
  4272 00003000 <res 10000h>            audio_buffer:	resb 65536
  4273                                  ; 13/06/2017
  4274                                  ;temp_buffer:	resb BUFFERSIZE
  4275                                  ; 26/11/2023
  4276 00013000 <res 10000h>            temp_buffer:	resb 65536
